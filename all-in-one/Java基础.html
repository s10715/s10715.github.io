<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Java基础</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">html {scroll-behavior: smooth;}body {font-size: 1rem;line-height: 1.6;tab-size: 4;color: rgb(51, 51, 51);font-family: Microsoft YaHei,"Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;-webkit-font-smoothing: antialiased;position: relative;top: 0;left: 300px;width: calc(90% - 300px);padding: 2em 5%;}h1,h2,h3,h4,h5,h6 {position: relative;margin-top: 1rem;margin-bottom: 1rem;padding-bottom: 0;font-weight: bold;line-height: 1.4;cursor: text;}h1 {font-size: 2.25em;line-height: 1.2;border-bottom: 1px solid #eee;}h2 {font-size: 1.75em;line-height: 1.225;border-bottom: 1px solid #eee;}h3 {font-size: 1.5em;line-height: 1.43;}h4 {font-size: 1.25em;}h5 {font-size: 1em;}h6 {font-size: 1em;color: #777;}p,blockquote{ margin: 0.8em 0 !important; }ul,ol,dl,table{margin: 0.8em 0;}li>ol,li>ul {margin: 0 0;}a {color: #4183C4;text-decoration: none;}hr {height: 2px;padding: 0;margin: 16px 0;background-color: #e7e7e7;border: 0 none;overflow: hidden;box-sizing: content-box;}li p.first {display: inline-block;}ul,ol {padding-left: 20px;}ul:first-child,ol:first-child {margin-top: 0;}ul:last-child,ol:last-child {margin-bottom: 0;}blockquote {border-left: 4px solid #dfe2e5 !important;padding: 0 15px;color: #777777 !important;background-color: #ffffff !important;}blockquote blockquote {padding-right: 0;}table {padding: 0;word-break: initial;border-collapse: collapse;}table tr {border: 1px solid #dfe2e5;margin: 0;padding: 0;}table tr:nth-child(2n),thead {background-color: #f8f8f8;}table th {font-weight: normal;text-align: unset;border-bottom: 0;border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table td {border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table th:first-child,table td:first-child {margin-top: 0;}table th:last-child,table td:last-child {margin-bottom: 0;}tt {border: 1px solid #e7eaed;background-color: #f8f8f8;border-radius: 3px;padding: 2px 4px 0px 4px;font-size: 0.9em;}code {border: 1px solid #e7eaed;background-color: #f3f4f4;border-radius: 3px;padding: 0 2px 0 2px;font-size: 0.9em;}img {width: 50%;height: 50%;display: block;vertical-align: middle;image-orientation: from-image;margin: auto;}figcaption {text-align: center;}pre>code{counter-reset: linenumber;display: block;white-space: pre;overflow: auto !important;padding: 0.2em;border-radius: 7px;}pre>code>span {counter-increment: linenumber;display: inline-block;line-height: 1.25em !important;}pre>code>span::before {content: counter(linenumber);display: inline-block;font-size: 0.9em;color: #999;min-width: 1.8em;margin-right: 0.5em;padding-right: 0.25em;text-align: right;border-right: 1px solid #999;line-height: 1.9em;user-select: none;pointer-events: none;}#TOC {font-size: 0.8rem;position: fixed;top: 0;left: 0;width: 300px;height: 100%;padding: 32px 16px 48px 16px !important;box-shadow: 0 0 4px rgba(150,150,150,0.33);box-sizing: border-box;overflow: auto;}#TOC::-webkit-scrollbar{width: 1px;border-right: 1px solid #f5f5f5;}#TOC a{color: #333333;text-decoration: none;}#TOC a:hover{color: #333333 !important;text-decoration: underline !important;}#TOC ul { list-style: none; }#TOC li { margin-bottom: 0.25rem; }@media (max-width: 700px) {#TOC { display: none; }body { left: 0px; width: 90%; }}</style>
  <script type="text/javascript">
  window.onload = function(){
    document.querySelectorAll('a[href^="#"]').forEach(function(item,index,arr){
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const target =  document.getElementById(decodeURI((item.href.substring(item.href.indexOf('#')+1))));
            if(target == null) { return; }
            target.scrollIntoView({ behavior: 'smooth' });
        });
    })
    const toc_a = document.querySelectorAll('#TOC a');
    function updateTOC(){
      const scrollPosition = window.scrollY;
      let highlightTarget;
      for(let i=toc_a.length-1; i>=0; i--){
        const target = document.getElementById(decodeURI((toc_a[i].href.substring(toc_a[i].href.indexOf('#')+1))));
        if(target == null) { continue; }
        const ItemPosition = target.offsetTop;
        if (scrollPosition > ItemPosition && typeof(highlightTarget) == "undefined") {
          highlightTarget = toc_a[i];
        } else if(typeof(highlightTarget) == "undefined" && i == 0) {
          highlightTarget = toc_a[0];
        }
      }
      toc_a.forEach( item => {
        item.style.fontWeight = "";
      });
      if(typeof(highlightTarget) == "undefined") { return; }
      highlightTarget.style.fontWeight = "bold";
    }
    let timer = null;
    window.addEventListener('scroll', () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(() => { updateTOC() }, 200);
    });
  };
  </script>
  <base target="_blank">
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#变量名的组成" id="toc-变量名的组成">1.变量名的组成</a></li>
<li><a href="#原码反码补码的关系字符编码" id="toc-原码反码补码的关系字符编码">2.原码、反码、补码的关系，字符编码</a></li>
<li><a href="#的区别" id="toc-的区别">3.<code>&lt;&lt;</code>、<code>&gt;&gt;</code>、<code>&gt;&gt;&gt;</code>的区别</a></li>
<li><a href="#java中的自增与c中的自增的区别" id="toc-java中的自增与c中的自增的区别">4.JAVA中的自增（++）与C中的自增的区别</a></li>
<li><a href="#类型转换" id="toc-类型转换">5.类型转换</a></li>
<li><a href="#判断输出结果" id="toc-判断输出结果">6.判断(输出)结果</a>
<ul>
<li><a href="#取模运算" id="toc-取模运算">6.1 取模运算</a></li>
<li><a href="#整数除法与小数除法" id="toc-整数除法与小数除法">6.2
整数除法与小数除法</a></li>
<li><a href="#字符串拼接" id="toc-字符串拼接">6.3 字符串拼接</a></li>
<li><a href="#和-先和后" id="toc-和-先和后">6.4 &amp; 和
&amp;&amp;，先++和后++</a></li>
<li><a href="#字符串问题" id="toc-字符串问题">6.5 字符串问题</a></li>
<li><a href="#final问题" id="toc-final问题">6.6 final问题</a></li>
<li><a href="#装箱类缓存问题" id="toc-装箱类缓存问题">6.7
装箱类缓存问题</a></li>
<li><a href="#参数传递问题" id="toc-参数传递问题">6.8
参数传递问题</a></li>
<li><a href="#答案" id="toc-答案">答案</a></li>
</ul></li>
<li><a href="#int-aint-aint-a的区别" id="toc-int-aint-aint-a的区别">7.int[] a、int a[]、int[]
a[]的区别</a></li>
<li><a href="#重裁函数的规则" id="toc-重裁函数的规则">8.重裁函数的规则</a></li>
<li><a href="#可变长参数varargs" id="toc-可变长参数varargs">9.可变长参数(Varargs)</a></li>
<li><a href="#privatedefaultprotectpublic的区别" id="toc-privatedefaultprotectpublic的区别">10.private、default、protect、public的区别</a></li>
<li><a href="#重写函数的规则object的equals和string的equals的区别" id="toc-重写函数的规则object的equals和string的equals的区别">11.重写函数的规则，Object的equals()和String的equals()的区别</a></li>
<li><a href="#成员变量和局部变量有什么区别代码块和成员变量的执行顺序" id="toc-成员变量和局部变量有什么区别代码块和成员变量的执行顺序">12.成员变量和局部变量有什么区别，代码块和成员变量的执行顺序</a></li>
<li><a href="#多态" id="toc-多态">13.多态</a></li>
<li><a href="#用static和final分别修饰类属性方法的作用用static修饰的代码块" id="toc-用static和final分别修饰类属性方法的作用用static修饰的代码块">14.用static和final分别修饰类、属性、方法的作用，用static修饰的代码块</a></li>
<li><a href="#抽象类和接口" id="toc-抽象类和接口">15.抽象类和接口</a></li>
<li><a href="#构造函数的调用规则" id="toc-构造函数的调用规则">16.构造函数的调用规则</a></li>
<li><a href="#内部类的创建和使用规则static和非static" id="toc-内部类的创建和使用规则static和非static">17.内部类的创建和使用规则（static和非static）</a></li>
<li><a href="#集合中collection和map主要的实现类及其特点" id="toc-集合中collection和map主要的实现类及其特点">18.集合中Collection和Map主要的实现类及其特点</a>
<ul>
<li><a href="#hashcode" id="toc-hashcode">hashCode</a></li>
<li><a href="#equals" id="toc-equals">equals</a></li>
</ul></li>
<li><a href="#泛型泛型类泛型函数泛型擦除" id="toc-泛型泛型类泛型函数泛型擦除">19.泛型、泛型类、泛型函数，泛型擦除</a></li>
<li><a href="#枚举" id="toc-枚举">20.枚举</a></li>
<li><a href="#多线程同步代码块同步方法锁" id="toc-多线程同步代码块同步方法锁">21.多线程、同步代码块、同步方法，锁</a>
<ul>
<li><a href="#创建线程" id="toc-创建线程">创建线程</a></li>
<li><a href="#线程的状态" id="toc-线程的状态">线程的状态</a></li>
<li><a href="#创建进程" id="toc-创建进程">创建进程</a></li>
<li><a href="#同步代码块同步方法" id="toc-同步代码块同步方法">同步代码块、同步方法</a></li>
<li><a href="#locksupport" id="toc-locksupport">LockSupport</a></li>
<li><a href="#锁的几个概念" id="toc-锁的几个概念">锁的几个概念</a>
<ul>
<li><a href="#锁的性质" id="toc-锁的性质">锁的性质</a></li>
<li><a href="#内存可见性" id="toc-内存可见性">内存可见性</a></li>
<li><a href="#原子性" id="toc-原子性">原子性</a></li>
<li><a href="#原子类型cas" id="toc-原子类型cas">原子类型(CAS)</a></li>
<li><a href="#threadlocal" id="toc-threadlocal">ThreadLocal</a></li>
</ul></li>
<li><a href="#互斥锁与单例模式" id="toc-互斥锁与单例模式">互斥锁与单例模式</a></li>
<li><a href="#死锁" id="toc-死锁">死锁</a></li>
<li><a href="#可重入锁" id="toc-可重入锁">可重入锁</a></li>
<li><a href="#公平锁与非公平锁condition" id="toc-公平锁与非公平锁condition">公平锁与非公平锁(Condition)</a></li>
<li><a href="#重量级锁轻量级锁偏向锁" id="toc-重量级锁轻量级锁偏向锁">重量级锁、轻量级锁、偏向锁</a>
<ul>
<li><a href="#重量级锁" id="toc-重量级锁">重量级锁</a></li>
<li><a href="#轻量级锁" id="toc-轻量级锁">轻量级锁</a></li>
<li><a href="#偏向锁" id="toc-偏向锁">偏向锁</a></li>
<li><a href="#几种锁的区别" id="toc-几种锁的区别">几种锁的区别</a></li>
</ul></li>
<li><a href="#阻塞队列" id="toc-阻塞队列">阻塞队列</a></li>
<li><a href="#高性能队列" id="toc-高性能队列">高性能队列</a></li>
<li><a href="#copyonwrite" id="toc-copyonwrite">CopyOnWrite</a></li>
<li><a href="#abstractqueuedsynchronizer" id="toc-abstractqueuedsynchronizer">AbstractQueuedSynchronizer</a>
<ul>
<li><a href="#countdownlatch" id="toc-countdownlatch">CountDownLatch</a></li>
<li><a href="#cyclicbarrier" id="toc-cyclicbarrier">CyclicBarrier</a></li>
<li><a href="#semaphore" id="toc-semaphore">Semaphore</a></li>
<li><a href="#readwritelock" id="toc-readwritelock">ReadWriteLock</a></li>
</ul></li>
<li><a href="#forkjoinpool" id="toc-forkjoinpool">ForkJoinPool</a></li>
<li><a href="#executors" id="toc-executors">Executors</a></li>
<li><a href="#future模式" id="toc-future模式">Future模式</a></li>
<li><a href="#master-worker模式" id="toc-master-worker模式">Master-Worker模式</a></li>
</ul></li>
<li><a href="#bionioaio" id="toc-bionioaio">22.BIO、NIO、AIO</a>
<ul>
<li><a href="#bio" id="toc-bio">BIO</a></li>
<li><a href="#nio" id="toc-nio">NIO</a>
<ul>
<li><a href="#buffer" id="toc-buffer">Buffer</a></li>
<li><a href="#channel" id="toc-channel">Channel</a></li>
<li><a href="#selector" id="toc-selector">Selector</a></li>
</ul></li>
<li><a href="#aio" id="toc-aio">AIO</a></li>
</ul></li>
<li><a href="#反射和内省" id="toc-反射和内省">23.反射和内省</a>
<ul>
<li><a href="#classloader" id="toc-classloader">ClassLoader</a></li>
<li><a href="#反射" id="toc-反射">反射</a>
<ul>
<li><a href="#获取调用方法" id="toc-获取调用方法">获取、调用方法</a></li>
<li><a href="#获取使用构造器" id="toc-获取使用构造器">获取、使用构造器</a></li>
<li><a href="#获取设置成员变量" id="toc-获取设置成员变量">获取、设置成员变量</a></li>
<li><a href="#获取父类泛型" id="toc-获取父类泛型">获取父类泛型</a></li>
</ul></li>
<li><a href="#内省" id="toc-内省">内省</a></li>
<li><a href="#动态代理" id="toc-动态代理">动态代理</a></li>
</ul></li>
<li><a href="#注解" id="toc-注解">24.注解</a>
<ul>
<li><a href="#注解annotation" id="toc-注解annotation">注解(annotation)</a></li>
<li><a href="#元注解meta-annotation" id="toc-元注解meta-annotation">元注解(meta-annotation)</a></li>
<li><a href="#自定义注解" id="toc-自定义注解">自定义注解</a></li>
</ul></li>
<li><a href="#jdk789语法的新特性" id="toc-jdk789语法的新特性">25.JDK7、8、9语法的新特性：</a>
<ul>
<li><a href="#数字可加下划线jdk7" id="toc-数字可加下划线jdk7">数字可加下划线(JDK7)</a></li>
<li><a href="#switch强化jdk7" id="toc-switch强化jdk7">switch强化(JDK7)</a></li>
<li><a href="#泛型类型推断jdk7" id="toc-泛型类型推断jdk7">泛型类型推断(JDK7)</a></li>
<li><a href="#try-with-resourcesjdk7-jdk9" id="toc-try-with-resourcesjdk7-jdk9">try-with-resources(JDK7 &amp;
JDK9)</a></li>
<li><a href="#捕获多个exceptionjdk7" id="toc-捕获多个exceptionjdk7">捕获多个Exception(JDK7)</a></li>
<li><a href="#读写文件简化jdk8" id="toc-读写文件简化jdk8">读写文件简化(JDK8)</a></li>
<li><a href="#streamjdk8" id="toc-streamjdk8">Stream(JDK8)</a></li>
<li><a href="#null检查jdk8" id="toc-null检查jdk8">null检查(JDK8)</a></li>
<li><a href="#optional类jdk8" id="toc-optional类jdk8">Optional类(JDK8)</a></li>
<li><a href="#lambda-表达式jdk8" id="toc-lambda-表达式jdk8">Lambda
表达式(JDK8)</a></li>
<li><a href="#方法引用jdk8" id="toc-方法引用jdk8">方法引用(JDK8)</a></li>
<li><a href="#接口的默认方法jdk8私有方法jdk9" id="toc-接口的默认方法jdk8私有方法jdk9">接口的默认方法(JDK8)、私有方法(JDK9)</a></li>
<li><a href="#modulejdk9" id="toc-modulejdk9">Module(JDK9)</a></li>
<li><a href="#httpclientjdk9" id="toc-httpclientjdk9">HttpClient(JDK9)</a></li>
<li><a href="#varhandlejdk9" id="toc-varhandlejdk9">VarHandle(JDK9)</a></li>
<li><a href="#局部变量类型推断jdk10" id="toc-局部变量类型推断jdk10">局部变量类型推断(JDK10)</a></li>
</ul></li>
<li><a href="#gc" id="toc-gc">26.GC</a>
<ul>
<li><a href="#finalize函数" id="toc-finalize函数">finalize函数</a></li>
<li><a href="#内存模型jmm" id="toc-内存模型jmm">内存模型(JMM)</a></li>
<li><a href="#堆中的gc算法" id="toc-堆中的gc算法">堆中的GC算法</a></li>
<li><a href="#引用" id="toc-引用">引用</a></li>
<li><a href="#gc参数" id="toc-gc参数">GC参数</a></li>
</ul></li>
<li><a href="#编译openjdk" id="toc-编译openjdk">27.编译OpenJDK</a>
<ul>
<li><a href="#下载源码" id="toc-下载源码">下载源码</a></li>
<li><a href="#配置编译" id="toc-配置编译">配置、编译</a></li>
</ul></li>
</ul>
</nav>
<p>JAVA Level: <a href="https://docs.oracle.com/javase/8/docs/api/index.html">JDK8</a></p>
<h2 id="变量名的组成">1.变量名的组成</h2>
<p>变量名由数字、字母大小写、<code>$</code>、<code>_</code>组成，但是在JDK9以后，<code>_</code>不能单独作为变量名</p>
<h2 id="原码反码补码的关系字符编码">2.原码、反码、补码的关系，字符编码</h2>
<p>正数原码、反码、补码都是一样的，负数反码是原码除符号位外取反，负数补码是反码再加1</p>
<p><strong>各种类型的字节数</strong></p>
<p>byte（字节）: 8bit，即8个二进制位</p>
<p>boolean: 1byte</p>
<p>short: 2byte</p>
<p>char:
2byte，JAVA中所有字符在内存中都以Unicode编码存在（java源文件一般是UTF-8编码，编译后会转成Unicode）</p>
<p>int: 4byte</p>
<p>long: 8byte</p>
<p>float: 4byte</p>
<p>double: 8byte</p>
<p><strong>编码</strong></p>
<p>ASCII码占1个字节</p>
<p>GBK占1到2个字节（英文数字占1个字节，汉字占2个字节），GB2312是在GBK的基础上加入了对繁体的支持</p>
<p>Unicode（又叫UTF-16）占2个字节</p>
<p>UTF-8占1到3个字节（与ASCII重合部分占1个字节，汉字占3个字节）</p>
<h2 id="的区别">3.<code>&lt;&lt;</code>、<code>&gt;&gt;</code>、<code>&gt;&gt;&gt;</code>的区别</h2>
<p><code>&lt;&lt;</code>左移，<code>&gt;&gt;</code>带符号右移(符号位补上原符号位相同的值)，<code>&gt;&gt;&gt;</code>无符号右移(符号位补0)</p>
<h2 id="java中的自增与c中的自增的区别">4.JAVA中的自增（++）与C中的自增的区别</h2>
<p><code>int a = 1;</code>，JAVA中<code>a = a++;</code>后，a还是1，但如果是C中<code>a = a++;</code>后，a变成了2，这是因为JAVA中的变量运算是先将变量复制一份到高速缓存中，计算完成再赋值给实际变量的，后++是先把高速缓存中的变量赋值给实际变量，然后高速缓存中的值再加1，所以a还是1；但C中变量运算操作的就是实际变量，是a指向的内存地址中的值加1，无论最后有没有再赋值给a，a都是2</p>
<h2 id="类型转换">5.类型转换</h2>
<p>判断下面程序是否有错</p>
<blockquote>
<p>5.1</p>
</blockquote>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">byte</span> b1<span class="op">=</span><span class="dv">1</span><span class="op">,</span> b2<span class="op">=</span><span class="dv">2</span><span class="op">,</span> b<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> b1 <span class="op">+</span> b2<span class="op">;</span></span></code></pre></div>
<blockquote>
<p>5.2</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">byte</span> b1<span class="op">=</span><span class="dv">1</span><span class="op">,</span>b<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> b1 <span class="op">+</span> <span class="dv">3</span><span class="op">;</span></span></code></pre></div>
<blockquote>
<p>5.3</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">byte</span> b<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">4</span><span class="op">;</span></span></code></pre></div>
<blockquote>
<p>5.4</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">short</span> s <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> s <span class="op">+</span> <span class="dv">5</span><span class="op">;</span></span></code></pre></div>
<blockquote>
<p>5.5</p>
</blockquote>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">short</span> s <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>s<span class="op">+=</span><span class="dv">5</span><span class="op">;</span></span></code></pre></div>
<blockquote>
<p>5.1:
错，变量相加自动转型，因为是变量，无法确认其值，所以按int处理</p>
<p>5.2: 错，同5.1</p>
<p>5.3: 对，只要不超过byte的范围，都可以赋值</p>
<p>5.4: 错，同5.1</p>
<p>5.5: 对，+=等符号有自动类型转换</p>
</blockquote>
<h2 id="判断输出结果">6.判断(输出)结果</h2>
<h3 id="取模运算">6.1 取模运算</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">%</span> <span class="dv">2</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">%</span> <span class="op">-</span><span class="dv">2</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="dv">5</span> <span class="op">%</span> <span class="dv">2</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="op">-</span><span class="dv">5</span> <span class="op">%</span> <span class="op">-</span><span class="dv">2</span></span></code></pre></div>
<h3 id="整数除法与小数除法">6.2 整数除法与小数除法</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span> <span class="op">/</span> <span class="fl">2.0</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dv">3520</span> <span class="op">/</span> <span class="dv">1000</span> <span class="op">*</span> <span class="dv">1000</span></span></code></pre></div>
<h3 id="字符串拼接">6.3 字符串拼接</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;5+5=&quot;</span> <span class="op">+</span> <span class="dv">5</span> <span class="op">+</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;5+5=&quot;</span> <span class="op">+</span> <span class="op">(</span><span class="dv">5</span><span class="op">+</span><span class="dv">5</span><span class="op">));</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="ch">&#39;5&#39;</span> <span class="op">+</span> <span class="ch">&#39;+&#39;</span> <span class="op">+</span> <span class="ch">&#39;5&#39;</span><span class="op">);</span></span></code></pre></div>
<h3 id="和-先和后">6.4 &amp; 和 &amp;&amp;，先++和后++</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> a<span class="op">=</span><span class="dv">1</span><span class="op">,</span>b<span class="op">=</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(++</span>a<span class="op">==</span><span class="dv">2</span> <span class="op">&amp;</span> b<span class="op">++</span> <span class="op">==</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;a=&quot;</span> <span class="op">+</span> a <span class="op">+</span> <span class="st">&quot; b=&quot;</span> <span class="op">+</span> b<span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>a<span class="op">=</span><span class="dv">1</span><span class="op">,</span>b<span class="op">=</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(++</span>a<span class="op">==</span><span class="dv">2</span> <span class="op">&amp;&amp;</span> b<span class="op">++</span> <span class="op">==</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;a=&quot;</span> <span class="op">+</span> a <span class="op">+</span> <span class="st">&quot; b=&quot;</span> <span class="op">+</span> b<span class="op">);</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>a<span class="op">=</span><span class="dv">1</span><span class="op">,</span>b<span class="op">=</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>a<span class="op">++==</span><span class="dv">2</span> <span class="op">&amp;</span> b<span class="op">++</span> <span class="op">==</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;a=&quot;</span> <span class="op">+</span> a <span class="op">+</span> <span class="st">&quot; b=&quot;</span> <span class="op">+</span> b<span class="op">);</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>a<span class="op">=</span><span class="dv">1</span><span class="op">,</span>b<span class="op">=</span><span class="dv">2</span><span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>a<span class="op">++==</span><span class="dv">2</span> <span class="op">&amp;&amp;</span> b<span class="op">++</span> <span class="op">==</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;a=&quot;</span> <span class="op">+</span> a <span class="op">+</span> <span class="st">&quot; b=&quot;</span> <span class="op">+</span> b<span class="op">);</span></span></code></pre></div>
<h3 id="字符串问题">6.5 字符串问题</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str1 <span class="op">=</span> <span class="st">&quot;Hello&quot;</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str2 <span class="op">=</span> <span class="st">&quot;World&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str3 <span class="op">=</span> <span class="st">&quot;HelloWorld&quot;</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str4 <span class="op">=</span> <span class="st">&quot;Hello&quot;</span> <span class="op">+</span> <span class="st">&quot;World&quot;</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str5 <span class="op">=</span> str1 <span class="op">+</span> str2<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str6 <span class="op">=</span> str1 <span class="op">+</span> <span class="st">&quot;World&quot;</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str7 <span class="op">=</span> str4<span class="op">.</span><span class="fu">intern</span><span class="op">();</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str3 <span class="op">==</span> str4<span class="op">);</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str3 <span class="op">==</span> str5<span class="op">);</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str3 <span class="op">==</span> str6<span class="op">);</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str3 <span class="op">==</span> str7<span class="op">);</span></span></code></pre></div>
<h3 id="final问题">6.6 final问题</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> str1 <span class="op">=</span> <span class="st">&quot;helloworld&quot;</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> str2 <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="bu">String</span> str3 <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="bu">String</span> str4 <span class="op">=</span> <span class="fu">getHello</span><span class="op">();</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> str5 <span class="op">=</span> str2 <span class="op">+</span> <span class="st">&quot;world&quot;</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> str6 <span class="op">=</span> str3 <span class="op">+</span> <span class="st">&quot;world&quot;</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> str7 <span class="op">=</span> str4 <span class="op">+</span> <span class="st">&quot;world&quot;</span><span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">((</span>str1 <span class="op">==</span> str5<span class="op">));</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">((</span>str1 <span class="op">==</span> str6<span class="op">));</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">((</span>str1 <span class="op">==</span> str7<span class="op">));</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">getHello</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="装箱类缓存问题">6.7 装箱类缓存问题</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span> i1 <span class="op">=</span> <span class="dv">127</span><span class="op">;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span> i2 <span class="op">=</span> <span class="dv">127</span><span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span> i3 <span class="op">=</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span> i4 <span class="op">=</span> <span class="dv">128</span><span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>i1 <span class="op">==</span> i2<span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>i3 <span class="op">==</span> i4<span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Double</span> d1 <span class="op">=</span> <span class="fl">127.0</span><span class="op">;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="bu">Double</span> d2 <span class="op">=</span> <span class="fl">127.0</span><span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Double</span> d3 <span class="op">=</span> <span class="fl">128.0</span><span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Double</span> d4 <span class="op">=</span> <span class="fl">128.0</span><span class="op">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>d1 <span class="op">==</span> d2<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>d3 <span class="op">==</span> d4<span class="op">);</span></span></code></pre></div>
<h3 id="参数传递问题">6.8 参数传递问题</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> s1 <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> s2 <span class="op">=</span> <span class="st">&quot;world&quot;</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>s1 <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> s2<span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change</span><span class="op">(</span>s1<span class="op">,</span> s2<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>s1 <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> s2<span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">StringBuffer</span> sb1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuffer</span><span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">);</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">StringBuffer</span> sb2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuffer</span><span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">);</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>sb1 <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> sb2<span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">change</span><span class="op">(</span>sb1<span class="op">,</span> sb2<span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>sb1 <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> sb2<span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">change</span><span class="op">(</span><span class="bu">String</span> s1<span class="op">,</span><span class="bu">String</span> s2<span class="op">){</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    s1 <span class="op">=</span> s2<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    s2 <span class="op">=</span> s1 <span class="op">+</span> s2<span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">change</span><span class="op">(</span><span class="bu">StringBuffer</span> sb1<span class="op">,</span><span class="bu">StringBuffer</span> sb2<span class="op">){</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    sb1 <span class="op">=</span> sb2<span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    sb2<span class="op">.</span><span class="fu">append</span><span class="op">(</span>sb1<span class="op">);</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="答案">答案</h3>
<blockquote>
<p>6.1:分别为：1、1、-1、-1，取决于被模数</p>
<p>6.2:分别为：2、2.5、3000，含小数自动转成double，否则是整数</p>
<p>6.3:分别为：5+5=55、5+5=10、149，看左边是不是String，是的话加号就是连接字符串的意思</p>
<p>6.4:分别为：a=2 b=3、a=2 b=3、a=2 b=3、a=2
b=2，因为无论如何<code>&amp;</code>两边都执行，而<code>&amp;&amp;</code>如果前面为false，则后面不执行。补充：运算符优先顺序是（从高到低）
<code>()、[]</code> → <code>!、+(正)、-(负)、~、++、--</code> →
<code>*、/、%</code> → <code>+(加)、-(减)</code> →
<code>&lt;&lt;、&gt;&gt;、&gt;&gt;&gt;</code> →
<code>&lt;、&lt;=、&gt;、&gt;=、instanceof</code> → <code>==、!=</code>
→ <code>&amp;</code> → <code>^</code> → <code>|</code> →
<code>&amp;&amp;</code> → <code>||</code> → <code>? :(三目运算符)</code>
→ <code>=、+=、-=、*=等一系列赋值运算符</code></p>
<p>6.5:分别为true、false、false、true，纯字符串存在常量池里，而只要含字符串引用，都存在堆里；对于任意两个字符串s和t，当且仅当<code>s.equals(t)</code>为true时，<code>s.intern() == t.intern()</code>才为true。</p>
<p>6.6:分别为false、true、false，final修饰的基本数据类型以及String由于不可更改，在编译时就可以确定其值，所以编译器会优化成编译期常量，在用到该final变量的地方，会直接替换为它的值，相当于6.5中”str4”的情况；但如果final变量是通过函数返回的，则在编译时无法确定其值，不会进行优化</p>
<p>6.7
分别为true、false、false、false，这里用到了自动装箱，相当于调用了对应的valueOf方法(如<code>Integer.valueOf</code>)，而<code>Byte</code>、<code>Short</code>、<code>Integer</code>、<code>Long</code>、<code>Char</code>这几个装箱类的valueOf方法是以128位分界线做了缓存的，假如是[-128,127]区间的值是会取缓存里面的引用的，而<code>Float</code>、<code>Double</code>不会做缓存的原因也很简单，因为整数类型在某个范围内的整数个数是有限的，但是float、double这两个浮点数却不是</p>
<p>6.8:输出hello—world、hello—world和hello—world、hello—worldworld，String类型是值传递的；JAVA中执行方法前，会将要调用的函数的参数值或地址压人栈中，执行完方法后再将之前压入栈的引用数据类型的地址重新赋值给变量，因此JAVA中方法无法改变参数列表中的引用数据类型的指向（但可以改变其成员变量的指向）</p>
</blockquote>
<h2 id="int-aint-aint-a的区别">7.int[] a、int a[]、int[] a[]的区别</h2>
<p><code>int[] a</code>和<code>int a[]</code>是一样的，而<code>int[] a[]</code>是二维数组</p>
<h2 id="重裁函数的规则">8.重裁函数的规则</h2>
<p>只有参数列表不一样才构成重裁，而与权限修饰符、返回值类型等无关</p>
<h2 id="可变长参数varargs">9.可变长参数(Varargs)</h2>
<p>可变参数函数写法：<code>void func(int i, String... str){}</code>，str按数组类型处理</p>
<p>可变长度参数必须作为方法参数列表中的的最后一个参数且方法参数列表中只能有一个可变长度参数</p>
<h2 id="privatedefaultprotectpublic的区别">10.private、default、protect、public的区别</h2>
<p>它们都可以修饰函数、属性和类，private修饰的函数或属性只能在类内部调用，default能同一个包内可调用，protect在同一个包内及子类都可调用，public所有位置都可调用</p>
<p>一个java文件只能有一个用public修饰的类，且该类的名称必须和java文件名一致（但可以有多个非public修饰的类，类名可以和java文件名不一致）</p>
<h2 id="重写函数的规则object的equals和string的equals的区别">11.重写函数的规则，Object的equals()和String的equals()的区别</h2>
<p>被重写的函数的权限修饰符的范围不能小于父类，抛出的异常不能大于父类，且父类用final修饰的方法不能重写；如果父类构造函数中使用了被子类重写的方法，则父类构造函数调用的是子类的方法，而非父类中的方法，如</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Father<span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name <span class="op">=</span> <span class="st">&quot;father&quot;</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Father</span><span class="op">(){</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show</span><span class="op">();</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">show</span><span class="op">(){</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Child <span class="kw">extends</span> Father<span class="op">{</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name <span class="op">=</span> <span class="st">&quot;child&quot;</span><span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Child</span><span class="op">(){</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">//子类会自动调用父类的空构造函数</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">show</span><span class="op">();</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">show</span><span class="op">(){</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test<span class="op">{</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        Child c <span class="op">=</span> <span class="kw">new</span> <span class="fu">Child</span><span class="op">();</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        c<span class="op">.</span><span class="fu">show</span><span class="op">();</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出结果为</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">null</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>child</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>child</span></code></pre></div>
<p>创建子类对象时，自动调用父类的构造函数，此时父类调用的show是子类的show，但这时子类的name属性还没有完成初始化（调用完父类构造函数才开始初始化子类成员变量），所以输出null；调用完父类构造函数后，初始化子类成员变量，然后再调用show，输出child；new完Child对象，此时调show再次输出child</p>
<p>完整的子类初始化顺序是：父类静态变量-&gt;父类静态代码块-&gt;子类静态变量-&gt;子类静态代码块-&gt;父类非静态变量-&gt;父类非静态代码块-&gt;父类构造函数-&gt;子类非静态变量-&gt;子类非静态代码块-&gt;子类构造函数（简单的说就是：父类静态部分-&gt;子类静态部分-&gt;父类非静态部分+构造函数-&gt;子类非静态部分+构造函数）</p>
<p>Object的equals()实际上就是==，比较对象的时候比的是地址，而String的equals()重写了，比的是字符串是否一样</p>
<h2 id="成员变量和局部变量有什么区别代码块和成员变量的执行顺序">12.成员变量和局部变量有什么区别，代码块和成员变量的执行顺序</h2>
<p>作用范围不同，且成员变量有默认的初始值，而局部变量必须显示初始化</p>
<p>代码块和成员变量定义是按顺序执行的，且非static的代码块和成员变量在父类构造函数执行完才开始执行，如果在代码块里初始化成员变量，而该成员变量定义在代码块后面，且静态初始化了，则会覆盖代码块初始化的值</p>
<h2 id="多态">13.多态</h2>
<p>用父类类型接收子类的实例就构成多态，这时多态对象调的方法是子类的，但调的属性是父类的（因为方法可以重写，但属性不能）</p>
<h2 id="用static和final分别修饰类属性方法的作用用static修饰的代码块">14.用static和final分别修饰类、属性、方法的作用，用static修饰的代码块</h2>
<p>static修饰的内部类不会持有对外部类的隐式引用，静态内部类中的静态成员变量只有在用到的时候才会被加载；static修饰的变量在内存里只有一份，所有实例用的是同一个变量；static修饰的方法可以静态调用(类名.方法)，static修饰的代码块只会被执行一次</p>
<p>final修饰的类不可继承；final修饰的属性一旦赋值就不可更改(可以静态赋值，或在代码块、构造函数里赋值)，final修饰基本数据类型以及String时，可能会被编译优化，final修饰对象时，不能重新指向别的对象，但对象的属性仍可更改；final修饰的方法不可重写，但可以重裁</p>
<h2 id="抽象类和接口">15.抽象类和接口</h2>
<p>抽象类可以有抽象方法和非抽象方法，而接口全部都是抽象方法，且属性都是final
static的(interface即使不声明方法是abstract、属性是final
static的，也会默认是这些属性修饰的)。(在JDK8以后，interface内可以有方法的具体实现(需用default或static关键字修饰该方法)，而不再是全都是抽象方法)</p>
<h2 id="构造函数的调用规则">16.构造函数的调用规则</h2>
<p>调用本类的其他构造函数用this()，调用父类构造函数用super()，调用其它构造函数必须放在构造函数的第一行调，且只能调一个，如果不显式调其他构造函数，则默认调用父类参数为空的构造函数（super()），如果父类没有空的构造函数，则一定要显式调用</p>
<h2 id="内部类的创建和使用规则static和非static">17.内部类的创建和使用规则（static和非static）</h2>
<p>static修饰的内部类可以通过<code>Outter.Inner a = new Outter.Inner()</code>创建，没有static修饰的内部类要先创建外部类的实例<code>Outter out = new Outter()</code>，再通过<code>Outter.Inner a = new out.Inner()</code>创建（或者写成<code>Outter.Inner a = new Outter().new Inner()</code>）</p>
<p>如果内部类定义了静态成员，该内部类也必须是静态的，静态内部类使用外部类成员变量或方法时，要求该外部类的成员变量或方法也是静态的</p>
<p>非静态内部类会持有对外部类的隐式引用（内部类的构造器在编译成字节码后编译器会给构造函数再添加一个参数，该参数就是指向外部类对象的引用）</p>
<p>匿名内部类（局部内部类）使用局部变量时，要求局部变量是final的，因为当方法执行完后，局部内部类还没有被销毁，而局部内部类用到了局部变量，局部变量已经被销毁，无法使用，于是编译器通过复制局部变量的方式解决这一问题，而只有用final修饰的变量才能在编译期间进行复制（如果这个变量的值在编译期间可以确定，则编译器默认会在局部内部类的常量池中添加一个内容相等的字面量或直接将相应的字节码嵌入到执行字节码中；如果不能在编译期间确定（如通过函数返回的对象，参考5.6），会被当做构造函数参数传入内部类中），也就是说，局部内部类使用的局部变量实际上不是同一个对象，只是一份拷贝，所以在局部内部类中修改其值会出现问题，所以编译器就直接限制要访问局部变量，必须把局部变量声明为final</p>
<p>可以在方法里面定义内部类，但由于在方法外无法访问该内部类，一般不会这样写</p>
<h2 id="集合中collection和map主要的实现类及其特点">18.集合中Collection和Map主要的实现类及其特点</h2>
<p>集合是用来保持对象引用的</p>
<ul>
<li><code>Collection</code>分为<code>List</code>和<code>Set</code>两大类，<code>List</code>中元素是有序、可重复的，而<code>Set</code>中元素的无序、不可重复的；
<ul>
<li><p><code>List</code>常用的有<code>ArrayList</code>(底层是数组，查找快)、<code>LinkedList</code>(底层是链表，插入、删除快，迭代时要使用迭代器，如果使用for循环，每次都要从头节点开始访问，直到找到该元素，速度慢)、<del>Vector</del>(线程安全)，<code>List</code>要求存入的类型重写<code>equals</code>方法</p></li>
<li><p><code>Set</code>常用的有<code>HashSet</code>、<code>LinkedHashSet</code>、<code>TreeSet</code>，<code>Set</code>要求存入的类型重写<code>hashCode</code>和<code>equals</code>方法，因为<code>Set</code>是根据这两个方法判断存入的元素是否重复的，如果不重写，则默认根据地址值判断，这样相同属性的两个对象不会认为是重复的，而且<code>TreeSet</code>还要求存入的类型实现<code>Comparable</code>接口，或者在<code>TreeSet</code>的构造函数里传入实现<code>Comparetor</code>的实例，并以此确定排序方法</p></li>
</ul></li>
<li><code>Map</code>的key是用<code>Set</code>来存储的，value是用<code>Collection</code>来存储的，所以要求key不能重复，且key要重写<code>hashCode</code>和<code>equals</code>方法；Map中一对key-value称为<code>Entry</code>，遍历时可用<code>entrySet()</code>来得到<code>Set&lt;Map.Entry&lt;K,V&gt;&gt;</code>从而实现遍历，常用的有<code>HashMap</code>(线程不安全)、<code>LinkedHashMap</code>、<del>HashTable</del>(线程安全)、<code>Properties</code></li>
</ul>
<p><code>Collections</code>工具类里面有提供synchronizedXXX方法把<code>List</code>、<code>Set</code>、<code>Map</code>变为线程安全的（装饰者模式）</p>
<h3 id="hashcode">hashCode</h3>
<p>字符串hash的计算：</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> hash <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> value<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    hash <span class="op">=</span> <span class="dv">31</span> <span class="op">*</span> hash <span class="op">+</span> val<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这里使用31的好处是 - 31是素数</p>
<ul>
<li>可用位运算进行优化：31 * i = (i &lt;&lt; 5) - i</li>
</ul>
<p>但是对于可变的元素，如果每次都实时计算，和集合一起使用时会出现问题：</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">Time</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Time</span> time <span class="op">=</span> <span class="kw">new</span> <span class="bu">Time</span><span class="op">(</span><span class="dv">12</span><span class="op">,</span> <span class="dv">34</span><span class="op">,</span> <span class="dv">15</span><span class="op">);</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>time<span class="op">.</span><span class="fu">hashCode</span><span class="op">());</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>time<span class="op">,</span> <span class="st">&quot;11111&quot;</span><span class="op">);</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        time<span class="op">.</span><span class="fu">hour</span> <span class="op">=</span> <span class="dv">13</span><span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>time<span class="op">.</span><span class="fu">hashCode</span><span class="op">());</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>map<span class="op">.</span><span class="fu">get</span><span class="op">(</span>time<span class="op">));</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="bu">Time</span> <span class="op">{</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> hour<span class="op">,</span> minute<span class="op">,</span> second<span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Time</span><span class="op">(</span><span class="dt">int</span> hour<span class="op">,</span> <span class="dt">int</span> minute<span class="op">,</span> <span class="dt">int</span> second<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">hour</span> <span class="op">=</span> hour<span class="op">;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">minute</span> <span class="op">=</span> minute<span class="op">;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">second</span> <span class="op">=</span> second<span class="op">;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">hashCode</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> hash <span class="op">=</span> second <span class="op">+</span> minute <span class="op">*</span> <span class="dv">31</span> <span class="op">+</span> hour <span class="op">*</span> <span class="dv">31</span> <span class="op">*</span> <span class="dv">31</span><span class="op">;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> hash<span class="op">;</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">equals</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!(</span>obj <span class="kw">instanceof</span> <span class="bu">Time</span><span class="op">))</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">hour</span><span class="op">==</span>hour <span class="op">&amp;&amp;</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">minute</span><span class="op">==</span>minute <span class="op">&amp;&amp;</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">second</span><span class="op">==</span>second<span class="op">;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Time{hour=&quot;</span> <span class="op">+</span> hour <span class="op">+</span> <span class="st">&quot;, minute=&quot;</span> <span class="op">+</span> minute <span class="op">+</span> <span class="st">&quot;, second=&quot;</span> <span class="op">+</span> second <span class="op">+</span> <span class="ch">&#39;}&#39;</span><span class="op">;</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出：</p>
<pre><code>12601
13562
null</code></pre>
<p>因为set、map根据<code>hashCode</code>和<code>equals</code>判断是否为同一元素，当修改元素的内容时，<code>hashCode</code>如果发生变化，就被认为不是同一元素，所以一般的做法是</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> hash<span class="op">;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> <span class="fu">hashCode</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>hash <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        hash <span class="op">=</span> second <span class="op">+</span> minute <span class="op">*</span> <span class="dv">31</span> <span class="op">+</span> hour <span class="op">*</span> <span class="dv">31</span> <span class="op">*</span> <span class="dv">31</span><span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hash<span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="equals">equals</h3>
<p>从<code>hashCode</code>算法可知，<code>hashCode</code>并不可靠，可能会有两个不同的对象hash却相同的情况，所以还需要<code>equals</code>（<code>equals</code>为<code>true</code>时，<code>hashCode</code>也必须一致，但<code>hashCode</code>一样时，<code>equals</code>不一定为<code>true</code>）</p>
<p>通常我们认为两个对象的内容（而非地址值）一样时，它们就是相等的</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">equals</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//null或者其他类型返回false</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!(</span>obj <span class="kw">instanceof</span> <span class="bu">Time</span><span class="op">))</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">hour</span><span class="op">==</span>hour <span class="op">&amp;&amp;</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">minute</span><span class="op">==</span>minute <span class="op">&amp;&amp;</span> <span class="op">((</span><span class="bu">Time</span><span class="op">)</span> obj<span class="op">).</span><span class="fu">second</span><span class="op">==</span>second<span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是如果创建一个Time的子类，并拓展了其功能，像上面这样写就会有问题</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Time</span> time<span class="op">=</span> <span class="kw">new</span> <span class="bu">Time</span><span class="op">(</span><span class="dv">12</span><span class="op">,</span><span class="dv">34</span><span class="op">,</span><span class="dv">15</span><span class="op">);</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        DayTime dayTime <span class="op">=</span> <span class="kw">new</span> <span class="fu">DayTime</span><span class="op">(</span><span class="dv">25</span><span class="op">,</span><span class="dv">12</span><span class="op">,</span><span class="dv">34</span><span class="op">,</span><span class="dv">15</span><span class="op">);</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>time<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>dayTime<span class="op">));</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DayTime <span class="kw">extends</span> <span class="bu">Time</span><span class="op">{</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> day<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">DayTime</span><span class="op">(</span><span class="dt">int</span> day<span class="op">,</span><span class="dt">int</span> hour<span class="op">,</span> <span class="dt">int</span> minute<span class="op">,</span> <span class="dt">int</span> second<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span>hour<span class="op">,</span> minute<span class="op">,</span> second<span class="op">);</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">day</span> <span class="op">=</span> day<span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>所以非<code>final</code>类的<code>equals</code>是不可靠的，通常如果父类重写了<code>equals</code>的话，子类也必须重写<code>equals</code>（<code>hashCode</code>同理）</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">equals</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>obj <span class="kw">instanceof</span> DayTime<span class="op">)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">super</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>obj<span class="op">)</span> <span class="op">&amp;&amp;</span> day <span class="op">==</span> <span class="op">((</span>DayTime<span class="op">)</span> obj<span class="op">).</span><span class="fu">day</span><span class="op">;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是这样又会有<code>time.equals(daytime)</code>为<code>true</code>但<code>daytime.equals(time)</code>为<code>false</code>的问题，即<code>equals</code>没有传递性，所以我们会考虑复合而非继承</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DayTime <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Time</span> time<span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> day<span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">DayTime</span><span class="op">(</span><span class="dt">int</span> day<span class="op">,</span> <span class="dt">int</span> hour<span class="op">,</span> <span class="dt">int</span> minute<span class="op">,</span> <span class="dt">int</span> second<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">time</span> <span class="op">=</span> <span class="kw">new</span> <span class="bu">Time</span><span class="op">(</span>hour<span class="op">,</span> minute<span class="op">,</span> second<span class="op">);</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">day</span> <span class="op">=</span> day<span class="op">;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">equals</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>obj <span class="kw">instanceof</span> DayTime<span class="op">)</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> time<span class="op">.</span><span class="fu">equals</span><span class="op">(((</span>DayTime<span class="op">)</span> obj<span class="op">).</span><span class="fu">time</span><span class="op">)</span> <span class="op">&amp;&amp;</span> day <span class="op">==</span> <span class="op">((</span>DayTime<span class="op">)</span> obj<span class="op">).</span><span class="fu">day</span><span class="op">;</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="泛型泛型类泛型函数泛型擦除">19.泛型、泛型类、泛型函数，泛型擦除</h2>
<ul>
<li><p>像<code>ArrayList&lt;String&gt; array = new ArrayList&lt;String&gt;()</code>就是泛型</p></li>
<li><p>泛型类：<code>class MyClass&lt;T&gt;{  }</code></p></li>
<li><p>泛型函数：</p></li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass<span class="op">&lt;</span>T<span class="op">&gt;{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> T t<span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyClass</span><span class="op">(</span>T t<span class="op">){</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">t</span> <span class="op">=</span> t<span class="op">;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    public static List&lt;T&gt; creatTList(){//不能通过编译</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">        return new ArrayList&lt;T&gt;();</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">    }</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在静态函数使用泛型必须声明为泛型方法，而无论该泛型是否在类中定义过</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">creatList</span><span class="op">(){</span><span class="co">//可以通过编译</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span>T<span class="op">&gt;();</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">//E是该函数特有的泛型，而非类中确定的泛型，此时用&lt;E&gt;声明该函数是一个泛型为E的泛型函数</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>E<span class="op">&gt;</span> E <span class="fu">method1</span><span class="op">(</span>E e<span class="op">){</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> e<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//不但K在类中没有声明，而且调用的时候也没有参数指明K是什么，此时编译器会自动判断返回值</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="op">&lt;</span>K<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>K<span class="op">&gt;</span> <span class="fu">method2</span><span class="op">(){</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        renturn <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span>K<span class="op">&gt;();</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">//自动类型推断，右边的String可以省略不写(JDK7)</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">//在调用像method2这种函数时，可以像下面这样在调用时就指定K的类型(JDK8)</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Person<span class="op">&gt;</span> persons1 <span class="op">=</span> MyClass<span class="op">.&lt;</span>Person<span class="op">&gt;</span><span class="fu">method2</span><span class="op">();</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">//上面写法和下面等价，此时编译器自动推断泛型参数的类型</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Person<span class="op">&gt;</span> persons2 <span class="op">=</span> MyClass<span class="op">.</span><span class="fu">method2</span><span class="op">();</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person<span class="op">{</span>  <span class="op">}</span></span></code></pre></div>
<ul>
<li>同一个类但泛型不同不能构成多态，但可以通过通配符来实现对不同类型的基本操作，如：</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span> <span class="op">?</span> <span class="op">&gt;</span> a1 <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> a2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>a1<span class="op">=</span>a2<span class="op">;</span></span></code></pre></div>
<p>此时a1中元素的类型实际上是Object，可以遍历集合并调用object.toString()输出，但不能往a1中添加元素，因为不知道a1中具体是什么类型的（思考：如果把?改成Object会怎么样—-如果改成Object，则可以往a1中添加任何类型的数据，就不满足泛型的定义了），除此以外，还可以指定泛型是哪个类的父类或子类，如<code>&lt; ? super MyClass&gt;</code>、<code>&lt; ? extends MyClass&gt;</code>、<code>&lt;T extedns MyClass&gt;</code></p>
<ul>
<li>泛型擦除：java文件在编译成class后，泛型对JVM不可见，所以以下代码输出true</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> a1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;();</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> a2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;();</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>a1<span class="op">.</span><span class="fu">getClass</span><span class="op">()==</span>a2<span class="op">.</span><span class="fu">getClass</span><span class="op">());</span><span class="co">//true</span></span></code></pre></div>
<p>而以下代码也可以通过编译(提示<code>Note: xxx.java uses unchecked or unsafe operations.</code>)、运行，JVM并不能检测泛型有没有错误使用。（除此以外，使用反射也能往a1里面添加其他类型）</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> a1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;();</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>a1<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">);</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">ArrayList</span> a2 <span class="op">=</span> a1<span class="op">;</span><span class="co">//手动擦除泛型</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>a2<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="dv">123</span><span class="op">);</span><span class="co">//堆污染</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>a2<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>a2<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code></pre></div>
<p>当向一个有泛型的对象写入一个非此泛型的对象时，发生堆污染，所以要注意以下写法：</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ArrayList</span> a1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;();</span><span class="co">//手动泛型擦除</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>a1<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">);</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>a1<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="dv">123</span><span class="op">);</span></span></code></pre></div>
<p>以上代码看似使用了泛型，但实际上是可以编译通过的，因为泛型只对对象引用起限制作用，而与构造器无关，如果是ArrayList的引用，构造器用<code>ArrayList&lt;String&gt;()</code>也不能限制只能存入String</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span> set <span class="op">=</span> <span class="kw">new</span> <span class="bu">TreeSet</span><span class="op">();</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>        set<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">);</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">varagMethod</span><span class="op">(</span>set<span class="op">);</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Iterator</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> iter <span class="op">=</span> set<span class="op">.</span><span class="fu">iterator</span><span class="op">();</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>iter<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> str <span class="op">=</span> iter<span class="op">.</span><span class="fu">next</span><span class="op">();</span>   <span class="co">// ClassCastException</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str<span class="op">);</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">varagMethod</span><span class="op">(</span><span class="bu">Set</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> objects<span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        objects<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Integer</span><span class="op">(</span><span class="dv">10</span><span class="op">));</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>以上代码也能编译通过，但运行时报错(ClassCastException)；当一个可变泛型参数指向一个无泛型参数，或者一个方法既使用泛型的时候也使用可变参数（如Arrays.asList(T…
a)）时，堆污染(Heap Pollution)就有可能发生</p>
<h2 id="枚举">20.枚举</h2>
<ul>
<li>声明一个枚举：</li>
</ul>
<div class="sourceCode" id="cb30"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MyEnum<span class="op">{</span> A<span class="op">,</span>B<span class="op">,</span>C<span class="op">,</span>D<span class="op">;</span> <span class="op">}</span></span></code></pre></div>
<ul>
<li>声明一个有属性、方法的枚举：</li>
</ul>
<div class="sourceCode" id="cb31"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MyEnum<span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    A<span class="op">,</span>B<span class="op">,</span>C<span class="op">,</span>D<span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setId</span><span class="op">(</span><span class="dt">int</span> id<span class="op">){</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">id</span><span class="op">=</span>id<span class="op">;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getId</span><span class="op">(){</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">id</span><span class="op">;</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>给每个枚举添加特有的函数：</li>
</ul>
<div class="sourceCode" id="cb32"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MyEnum<span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    A<span class="op">{</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">show</span><span class="op">(){</span> <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;A&quot;</span><span class="op">);</span> <span class="op">}},</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    B<span class="op">{</span> <span class="kw">public</span> <span class="dt">void</span> <span class="fu">show</span><span class="op">(){</span> <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;B&quot;</span><span class="op">);</span> <span class="op">}};</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>给枚举添加构造函数：</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MyEnum<span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">A</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span><span class="st">&quot;A&quot;</span><span class="op">),</span><span class="fu">B</span><span class="op">(</span><span class="dv">1001</span><span class="op">,</span><span class="st">&quot;B&quot;</span><span class="op">),</span><span class="fu">C</span><span class="op">(</span><span class="dv">1002</span><span class="op">,</span><span class="st">&quot;C&quot;</span><span class="op">),</span><span class="fu">D</span><span class="op">(</span><span class="dv">1003</span><span class="op">,</span><span class="st">&quot;D&quot;</span><span class="op">);</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="fu">MyEnum</span><span class="op">(</span><span class="dt">int</span> i<span class="op">,</span><span class="bu">String</span> name<span class="op">){</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">id</span> <span class="op">=</span> id<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>根据枚举名获取枚举对象：</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>MyEnum A<span class="op">=</span>MyEnum<span class="op">.</span><span class="fu">valueof</span><span class="op">(</span><span class="st">&quot;A&quot;</span><span class="op">);</span></span></code></pre></div>
<p>要注意的是，枚举的声明要放在enum开始的地方，且枚举之间用<code>,</code>隔开，每个枚举都默认是public
static final修饰的，不用显式声明</p>
<h2 id="多线程同步代码块同步方法锁">21.多线程、同步代码块、同步方法，锁</h2>
<h3 id="创建线程">创建线程</h3>
<p>创建线程：</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyThread1 <span class="kw">extends</span> <span class="bu">Thread</span><span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//code</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyThread2 <span class="kw">implements</span> <span class="bu">Runnable</span><span class="op">{</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//code</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>以上两种方式创建的区别在于</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">//继承Thread的话如果要共享数据，则要声明数据为static</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>MyThread1 mt1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyThread1</span><span class="op">();</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>mt1<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">//实现Runnable的话如果要共享数据，则往Thread构造函数里传入同一个实例就可以了</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>MyThread mt2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyThread2</span><span class="op">();</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span>mt2<span class="op">);</span><span class="co">//t1、t2用同一个i</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span>mt2<span class="op">);</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>t1<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>t2<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co">//如果新建一个MyThread2的话，t3与t1、t2不共享一个i</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t3 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyThread2</span><span class="op">());</span></span></code></pre></div>
<p>如果需要得到线程的返回值，可以使用<code>Callable</code>创建线程</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Callable</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> callable <span class="op">=</span> <span class="kw">new</span> <span class="bu">Callable</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">call</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> result <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;=</span> <span class="dv">100</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>            result <span class="op">+=</span> i<span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="bu">FutureTask</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> result <span class="op">=</span> <span class="kw">new</span> <span class="bu">FutureTask</span><span class="op">&lt;&gt;(</span>callable<span class="op">);</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span>result<span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">//get方法会阻塞至线程执行完成，FutureTask实现了Future接口，实际上是用了Future模式</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span></code></pre></div>
<h3 id="线程的状态">线程的状态</h3>
<ol type="1">
<li>初始(NEW): 新创建了一个线程对象，但还没有调用start()方法</li>
<li>运行(RUNNABLE):
Java线程中将就绪（ready）和运行中（running）两种状态笼统的称为”运行”
线程对象创建后，其他线程(比如main线程）调用了该对象的start()方法。该状态的线程位于可运行线程池中，等待被线程调度选中，获取CPU的使用权，此时处于就绪状态（ready）。就绪状态的线程在获得CPU时间片后变为运行中状态（running）</li>
<li>阻塞(BLOCKED):
进入synchronized关键字修饰的方法或代码块(获取锁)时的状态</li>
<li>等待(WAITING):
进入该状态的线程需要等待其他线程做出一些特定动作（通知或中断），处于这种状态的线程不会被分配CPU执行时间，它们要等待被显式地唤醒，否则会处于无限期等待的状态</li>
<li>超时等待(TIMED_WAITING):
该状态不同于WAITING，它可以在指定的时间后自行返回</li>
<li>终止(TERMINATED): 表示该线程已经执行完毕</li>
</ol>
<h3 id="创建进程">创建进程</h3>
<p>调用cmd或者shell</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Process</span> process<span class="op">=</span><span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">exec</span><span class="op">(</span><span class="st">&quot;mkdir aaa&quot;</span><span class="op">);</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>process<span class="op">.</span><span class="fu">waitFor</span><span class="op">();</span></span></code></pre></div>
<p>JDK5以后可以使用<code>ProcessBuilder</code>创建，JDK9以后可以使用<code>ProcessHandle</code>来获取进程的信息</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> <span class="bu">ProcessBuilder</span> processBuilder <span class="op">=</span> <span class="kw">new</span> <span class="bu">ProcessBuilder</span><span class="op">(</span><span class="st">&quot;ls&quot;</span><span class="op">)</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">inheritIO</span><span class="op">();</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> ProcessHandle processHandle <span class="op">=</span> processBuilder<span class="op">.</span><span class="fu">start</span><span class="op">().</span><span class="fu">toHandle</span><span class="op">();</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>processHandle<span class="op">.</span><span class="fu">onExit</span><span class="op">().</span><span class="fu">whenCompleteAsync</span><span class="op">((</span>handle<span class="op">,</span> throwable<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>throwable <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>handle<span class="op">.</span><span class="fu">pid</span><span class="op">());</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        throwable<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co">//通过ProcessHandle.info()可以获得进程的启动时间、执行时间等信息</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>ZonedDateTime startTime <span class="op">=</span> processHandle<span class="op">.</span><span class="fu">info</span><span class="op">()</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startInstant</span><span class="op">()</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span>Instant<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">atZone</span><span class="op">(</span>ZoneId<span class="op">.</span><span class="fu">systemDefault</span><span class="op">());</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Duration</span> duration <span class="op">=</span> processHandle<span class="op">.</span><span class="fu">info</span><span class="op">()</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">totalCpuDuration</span><span class="op">()</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">);</span></span></code></pre></div>
<h3 id="同步代码块同步方法">同步代码块、同步方法</h3>
<p>同步代码块、同步方法是为了解决多线程中数据共享的问题</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        Test test <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">();</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">@Override</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>test<span class="op">.</span><span class="fu">count</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//暂停1毫秒，增加出现并发问题的几率</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                                <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                            <span class="op">}</span><span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>                                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>                            <span class="op">}</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>                            test<span class="op">.</span><span class="fu">count</span><span class="op">--;</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>            <span class="co">//主程序暂停3秒，以保证上面的程序执行完成</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;count=&quot;</span> <span class="op">+</span> test<span class="op">.</span><span class="fu">count</span><span class="op">);</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这时，输出了-1，多次运行甚至有时会输出-2，这是由于当count为1时，在<code>if (test.count &gt; 0)</code>后进行了耗时操作，而这时又刚好有另一个线程抢占了执行权，由于还没有执行<code>test.count--</code>，此时线程仍然可以进入导致多次执行<code>test.count--</code>导致的，这就要用同步代码块或同步方法解决了</p>
<p>同步代码块或同步方法限制使用同一个锁的代码块或方法在同一时间只有一个线程能调用对应的代码（可以是不同方法使用同一个锁，这时另一线程就要等前面获取锁了的线程把方法执行完、释放锁后，另一线程才能调用使用了该锁的其他方法，保证了方法之间不能并发执行，如读写数据时，要等写完才可以读，否则会出现读出来的数据不完整的情况，但实际情况下会使用读写分离(写时复制一份数据，写完再把指针指向写好的数据)来提高效率）</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">//obj1称为同步监视器（又叫监视器锁，monitor），任何对象都可以用作同步监视器</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> obj1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">method1</span><span class="op">(){</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">synchronized</span><span class="op">(</span>obj1<span class="op">){</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//code</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">//同步方法默认用this作同步监视器</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method</span><span class="op">(){</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//code</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当所有线程用同一个同步监视器时，<code>synchronized</code>才有效，implements
Runnable实现多线程时，锁一般声明为全局的，extends
Thread实现多线程时，锁一般声明为全局、static的，
更一般的，如果只有一个同步代码块或同步方法时，非静态方法用<code>this</code>做同步监视器，同步代码块可以指定自定义同步监视器，静态方法用<code>class</code>做同步监视器（如：<code>synchronized(MyThread2.class){}</code>）</p>
<p>使用同一个锁的同步方法互调是没问题的</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method1</span><span class="op">(){</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;method1&quot;</span><span class="op">);</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">method2</span><span class="op">();</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method2</span><span class="op">(){</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;method2&quot;</span><span class="op">);</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    Test t <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">();</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span><span class="fu">method1</span><span class="op">();</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>子类调父类的同步方法也是没问题的，此时父类和子类用的是同一个锁</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sup <span class="op">{</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method1</span><span class="op">()</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sub <span class="kw">extends</span> Sup <span class="op">{</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method2</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span><span class="fu">method1</span><span class="op">();</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        Sub sub <span class="op">=</span> <span class="kw">new</span> <span class="fu">Sub</span><span class="op">();</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        sub<span class="op">.</span><span class="fu">method2</span><span class="op">();</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>像出现异常等情况，用<code>synchronized</code>加的锁会自动释放，但<code>java.util.concurrent.locks</code>包下的锁要手动释放</p>
<p>使用对象做锁可以使用<code>notify</code>、<code>wait</code>等方法，但<code>notify</code>不会释放锁，而<code>wait</code>会释放锁并让线程阻塞</p>
<p>要注意的是，使用<code>notify</code>、<code>notifyAll</code>、<code>wait</code>等方法时，应尽量在while循环中使用，否则可能会导致<code>虚假唤醒</code>(Spurious
wakeup)</p>
<pre><code>while(条件不满足){
   obj.wait();
}
而不是:
If( 条件不满足 ){
   obj.wait();
}</code></pre>
<h3 id="locksupport">LockSupport</h3>
<p>像以往的<code>wait</code>、<code>notify</code>等方法必须写在synchronized中，而且必须先<code>wait</code>，再调用<code>notify</code>才能结束等待，但实际情况中，我们无法确定哪个线程先执行完成，比如下面的程序：</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> obj <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">//do something...</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Random</span><span class="op">().</span><span class="fu">nextInt</span><span class="op">(</span><span class="dv">500</span><span class="op">));</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">synchronized</span> <span class="op">(</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>                obj<span class="op">.</span><span class="fu">wait</span><span class="op">();</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">//do something...</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Random</span><span class="op">().</span><span class="fu">nextInt</span><span class="op">(</span><span class="dv">500</span><span class="op">));</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">synchronized</span> <span class="op">(</span>obj<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>                obj<span class="op">.</span><span class="fu">notify</span><span class="op">();</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>t1<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>t2<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>多运行几次上边的代码，有的时候线程能够正常退出，但有的时候线程却阻塞住了。原因就在于：t2线程调用完<code>notify</code>后，t1线程才进入<code>wait</code>方法，导致t1线程一直阻塞住。由于t1线程不是后台线程，所以整个程序无法退出</p>
<p>而<code>LockSupport</code>可以不在synchronized中执行，而且可以先<code>unpark</code>(相当于notify)再<code>park</code>(相当于wait)</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">100L</span><span class="op">);</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;t2 end sleep&quot;</span><span class="op">);</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//LockSupport.park(Object)</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">LockSupport</span><span class="op">.</span><span class="fu">park</span><span class="op">(</span><span class="kw">this</span><span class="op">);</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;I am alive&quot;</span><span class="op">);</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span> t1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">50L</span><span class="op">);</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">//LockSupport.unpark(Thread)</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">LockSupport</span><span class="op">.</span><span class="fu">unpark</span><span class="op">(</span>t2<span class="op">);</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;I am done&quot;</span><span class="op">);</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>t1<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>t2<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>要注意的是，<code>LockSupport</code>要求<code>unpark</code>的线程已经启动，如果<code>LockSupport.unpark(t2)</code>的时候t2线程还没有启动，那么<code>unpark</code>是无效的</p>
<p><code>wait</code>、<code>notify</code>和<code>LockSupport</code>相比，<code>wait</code>、<code>notify</code>不需要线程之间相互感知（能获取对方的引用），只需共享一个锁对象即可，而<code>LockSupport</code>需要获取另一线程的引用才能<code>unpark</code>，但是这样的好处在于<code>LockSupport</code>可以唤醒指定的线程。它们各有优势，两者间不能完全取代彼此</p>
<p><code>LockSupport</code>和<code>wait</code>、<code>notify</code>一样，存在<code>虚假唤醒</code>的情况，也应尽量在while循环中使用</p>
<h3 id="锁的几个概念">锁的几个概念</h3>
<h4 id="锁的性质">锁的性质</h4>
<ul>
<li>共享性与互斥性:
如果我们只对资源进行读操作，不更改其内容，我们不需要担心线程安全问题（共享锁，也叫做读锁），但对于要更改其内容的操作，我们就一定要保证其互斥性（排它锁，也叫做写锁）</li>
<li>原子性:
原子性就是指对数据的操作是一个独立的、不可分割的整体（如<code>synchronized</code>块、<code>synchronized</code>方法），换句话说，就是一次操作，是一个连续不可中断的过程，数据不会执行的一半的时候被其他线程所修改</li>
<li>内存可见性:
变量的内存可见性可以通过<code>volatile</code>关键字设置；JVM会为每个线程创建一个工作内存（TLAB，Thread
Local Allocation
Buffer，线程本地分配缓存区），对共享变量进行修改时，会先缓存到工作内存中再修改，最后再同步回主内存，但是同步的时机是不确定的，这就导致了如果线程1对某个变量进行了修改，线程2却有可能看不到线程1对共享变量所做的修改（脏读），此时使用<code>volatile</code>可以避免这种情况，<code>volatile</code>修饰的变量每次写数据时都会加锁（锁总线，后来采用效率更高的锁缓存替代），而且会让其他线程的缓存失效，线程每次读写时都会检测当前数据是否过期，如果过期了就从主内存中获取最新数据</li>
<li>有序性:
为了提高性能，编译器和处理器可能会对指令做重排序，这时在单线程正常运行的代码在并发的时候会出现不确定的结果，但我们可以通过加锁及<code>volatile</code>关键字防止重排后出现的不确定结果</li>
</ul>
<h4 id="内存可见性">内存可见性</h4>
<p>如果一个线程修改了一个变量，另一个线程有一定几率是不知道的：</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">method1</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>count <span class="op">&gt;</span> <span class="dv">5</span><span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">method2</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            count<span class="op">++;</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;count = &quot;</span> <span class="op">+</span> count<span class="op">);</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        Test t <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">();</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(()</span> <span class="op">-&gt;</span> t<span class="op">.</span><span class="fu">method1</span><span class="op">()).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(()</span> <span class="op">-&gt;</span> t<span class="op">.</span><span class="fu">method2</span><span class="op">()).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>一个线程用于修改count，count最后一定大于5，但另一个线程是有几率无法感知（内存不可见）的，这就导致了调用method2的线程有几率不会结束</p>
<p>要保证变量的内存可见性需要使用<code>volatile</code>关键字</p>
<p>如果count使用<code>volatile</code>修饰，则调用method2的线程一定能正常退出：</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="kw">volatile</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span></code></pre></div>
<h4 id="原子性">原子性</h4>
<p><code>volatile</code>能保证内存可见性，但它并不具有原子性：</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="kw">volatile</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span><span class="dv">10</span><span class="op">;</span>i<span class="op">++){</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i1 <span class="op">&lt;</span><span class="dv">100</span><span class="op">;</span> i1<span class="op">++)</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>                    Test<span class="op">.</span><span class="fu">count</span><span class="op">++;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>Test<span class="op">.</span><span class="fu">count</span><span class="op">);</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>多运行几次会得到不一样的结果</p>
<pre><code>100
200
300
400
501
593
793
693
893
993</code></pre>
<p>上面的中间的返回值不需要看（可能在输出前，其他线程抢到了优先级，先更改了count，导致输出不一定准确），关注最后的值，最后的值不是1000，这是因为<code>volatile</code>没有原子性，不能保证每次只有一个线程能更改count的值，当count在高速缓存中更改，但还没有同步进主内存时，另一个线程更改了它的值，导致自增多次但只有一次生效</p>
<h4 id="原子类型cas">原子类型(CAS)</h4>
<p>此时可以使用原子类型解决（基本数据类型都有对应的原子类型，其他的对象可以用<code>AtomicReference</code>）：</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="kw">volatile</span> <span class="bu">AtomicInteger</span> count <span class="op">=</span> <span class="kw">new</span> <span class="bu">AtomicInteger</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span></code></pre></div>
<p>原子类型就是一种乐观的锁，使用CAS（compare and
swap）实现，它假设当前线程操作变量时没有其他线程干扰，更改变量时先缓存变量，然后对缓存的变量进行操作，得到预期值，然后设置真实值之前和之后都校验一次以确保正确修改，如果校验失败说明有其他线程干预，会再次尝试修改，直至成功为止</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">//将value声明为volatile的，确保内存可见性</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="kw">volatile</span> <span class="dt">int</span> value<span class="op">;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co">//自增的实现原理</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="dt">int</span> <span class="fu">getAndIncrement</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 当前值</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> current <span class="op">=</span> <span class="fu">get</span><span class="op">();</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 预期值</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> next <span class="op">=</span> current <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="fu">compareAndSet</span><span class="op">(</span>current<span class="op">,</span> next<span class="op">))</span> <span class="op">{</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 如果加成功了, 则返回当前值，此时实际的value已经加1</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> current<span class="op">;</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="dt">boolean</span> <span class="fu">compareAndSet</span><span class="op">(</span><span class="dt">int</span> expect<span class="op">,</span> <span class="dt">int</span> update<span class="op">)</span> <span class="op">{</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 调用native方法修改变量的值，该方法是基于CPU的CAS指令来实现, 可以认为无阻塞.</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unsafe<span class="op">.</span><span class="fu">compareAndSwapInt</span><span class="op">(</span><span class="kw">this</span><span class="op">,</span> valueOffset<span class="op">,</span> expect<span class="op">,</span> update<span class="op">);</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是上面的设计会有ABA的问题：如果线程一准备用CAS将变量的值由A替换为B,
在此之前线程二将变量的值由A替换为C, 线程三又将C替换为A,
然后线程一执行CAS时发现变量的值仍然为A,
所以线程一CAS成功。这种情况下线程一是无法感知的</p>
<p><code>AtomicStampedReference</code>解决了ABA问题，其原理就是每次对变量进行修改时，都把stamp加1，也就是记录修改的次数，校验时除了校验value是否修改成功，还要校验stamp以确保没有其他线程修改过</p>
<p>补充:</p>
<p><code>volatile</code>也会在高速缓存中对变量进行操作：</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">volatile</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        Test t <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">();</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span><span class="fu">count</span> <span class="op">=</span> t<span class="op">.</span><span class="fu">count</span><span class="op">++;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>t<span class="op">.</span><span class="fu">count</span><span class="op">);</span><span class="co">//输出0</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="threadlocal">ThreadLocal</h4>
<p>如果希望每个线程都有变量的副本，对变量副本的操作不影响其他线程，可以用<code>ThreadLocal</code></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ThreadLocal</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> localStr <span class="op">=</span> <span class="kw">new</span> <span class="bu">ThreadLocal</span><span class="op">&lt;&gt;()</span> <span class="op">{</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">String</span> <span class="fu">initialValue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Hello&quot;</span><span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        localStr<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">);</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> localStr<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co">//确保Thread1运行时Thread0已修改localStr</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> localStr<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>输出</p>
<pre><code>Thread-0--world
Thread-1--Hello</code></pre>
<p>此时Thread-0对localStr的修改并不会影响Thread-1</p>
<p>注意<code>ThreadLocal</code>的remove方法，它可以清空<code>ThreadLocal</code>的值，但是如果之后还调了get方法，就会重新根据初始化方法进行初始化</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">ThreadLocal</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> num <span class="op">=</span> <span class="bu">ThreadLocal</span><span class="op">.</span><span class="fu">withInitial</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="dv">6</span><span class="op">);</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>num<span class="op">.</span><span class="fu">get</span><span class="op">());</span><span class="co">//6</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    num<span class="op">.</span><span class="fu">set</span><span class="op">(</span>num<span class="op">.</span><span class="fu">get</span><span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>num<span class="op">.</span><span class="fu">get</span><span class="op">());</span><span class="co">//7</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    num<span class="op">.</span><span class="fu">remove</span><span class="op">();</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>num<span class="op">.</span><span class="fu">get</span><span class="op">());</span><span class="co">//6</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>ThreadLocal的内存泄露问题</strong></p>
<p><code>ThreadLocal</code>底层是通过键值对<code>ThreadLocalMap.Entry&lt;ThreadLocal&lt;?&gt;, Object&gt;</code>的形式存储的(线程私有)，而键值对中的key是弱引用、value是强引用，所以key有可能在内存回收的时候被回收掉，但是value却不能被回收(只有当前线程结束后，没有对map的强引用时，才能回收)，导致了内存泄露</p>
<p>Java为了最小化减少内存泄露的可能性和影响，在使用<code>ThreadLocal</code>的get、set、remove的时候都会清除线程Map里所有key为null的value。但如果使用线程池，那么线程不会被销毁，而且get、set、remove也不会被使用时，又或者使用了static修饰<code>ThreadLocal</code>，延长了其生命周期，这期间就会发生真正的内存泄露</p>
<p>要避免产生内存泄露，我们需要在每次用完<code>ThreadLocal</code>后手动调用其remove方法，清除数据</p>
<p><strong>为什么使用弱引用</strong></p>
<p>考虑使用强引用的情况：</p>
<ol type="1">
<li>如果某个类的内部使用了<code>ThreadLocal</code>，由于<code>ThreadLocalMap</code>存放在线程中，而线程还没有被销毁，当该类的实例被回收时，由于<code>ThreadLocalMap</code>对其内部使用的<code>ThreadLocal</code>存在强引用，所以<code>ThreadLocal</code>无法被回收，就会造成内存泄露</li>
<li>如果错误使用<code>TreadLocal</code>，比如把<code>ThreadLocal</code>定义为局部变量，当方法执行完后，由于<code>ThreadLocalMap</code>仍持有其强引用，也会造成内存泄露</li>
</ol>
<p>使用弱引用就不存在上述问题</p>
<h3 id="互斥锁与单例模式">互斥锁与单例模式</h3>
<p><code>synchronized</code>效率比较低，如果要提高效率一般用互斥锁(双重判空)（以单例模式的懒汉式为例）：</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Singleton<span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//单例模式，私有化构造函数</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="fu">Singleton</span><span class="op">(){}</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">volatile</span> <span class="dt">static</span> Singleton singleton <span class="op">=</span> <span class="kw">null</span><span class="op">;</span><span class="co">//如果不声明为volatile ，会导致singleton分配了内存空间，但还没被初始化时（这时已经不为null），其他线程进入，获取了没有完成初始化的对象</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> Singleton <span class="fu">geInstance</span><span class="op">(){</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>singleton <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> singleton<span class="op">;</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">synchronized</span><span class="op">(</span>Singleton<span class="op">.</span><span class="fu">class</span><span class="op">){</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>singleton <span class="op">==</span> <span class="kw">null</span><span class="op">){</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>                singleton <span class="op">=</span> <span class="kw">new</span> <span class="fu">Singleton</span><span class="op">();</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">//code</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="op">{</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> singleton<span class="op">;</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>分析</strong>:
线程A进入，singleton为null进入锁内，线程B进入singleton为null，但线程A已获取锁，所以线程B阻塞，线程A在锁内，此时singleton仍为null，线程A初始化singleton，然后释放锁，线程B进入此时singleton已经不为null了，直接获取singleton然后返回</p>
<p><strong>lock</strong></p>
<p>如果不需要等待返回，可以使用<code>java.util.concurrent.locks</code>下的一些锁，作用和<code>synchronized</code>相同（wait、notify、notifyAll只能在<code>synchronized</code>下使用，如果用<code>concurrent</code>包下的锁，则要<code>lock.newCondition()</code>取得condition，再使用condition对应的await、signal、signalAll），但<code>concurrent</code>包下的锁引入了<code>condition</code>的概念，使得我们可以根据条件唤醒需要的线程，而不像<code>synchronized</code>那样，要么随机唤醒一个线程，要么唤醒全部线程</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass<span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">ReentrantLock</span> lock <span class="op">=</span> <span class="kw">new</span> <span class="bu">ReentrantLock</span><span class="op">();</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">method</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>lock<span class="op">.</span><span class="fu">tryLock</span><span class="op">())</span> <span class="op">{</span><span class="co">//如果获取锁失败，就做其他事情</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>               <span class="co">// code</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>               lock<span class="op">.</span><span class="fu">unlock</span><span class="op">()</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span><span class="cf">else</span><span class="op">{</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">//code</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>利用类的加载特性实现单例</strong></p>
<p>互斥锁能保证线程安全，但写起来比较复杂，我们一般使用静态内部类实现单例（外部类加载时并不需要立即加载内部类，静态内部类只有在第一次被使用的时候才会被加载，而类的加载是线程安全的）</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SingleTon <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 利用静态内部类特性实现外部类的单例</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="kw">class</span> SingleTonBuilder <span class="op">{</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span> <span class="dt">static</span> SingleTon singleTon <span class="op">=</span> <span class="kw">new</span> <span class="fu">SingleTon</span><span class="op">();</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 私有化构造函数</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="fu">SingleTon</span><span class="op">()</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> SingleTon <span class="fu">getInstance</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> SingleTonBuilder<span class="op">.</span><span class="fu">singleTon</span><span class="op">;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>更简单的写法是用枚举实现单例（枚举实例创建是线程安全的），但是不常用</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">enum</span> SingleTon<span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    INSTANCE<span class="op">;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">method</span><span class="op">(){</span>  <span class="op">}</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="死锁">死锁</h3>
<p>死锁一般出现在有多个锁且交叉使用的情况：</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> obj1 <span class="op">=</span> <span class="st">&quot;obj1&quot;</span><span class="op">;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> obj2 <span class="op">=</span> <span class="st">&quot;obj2&quot;</span><span class="op">;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">((</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span><span class="op">{</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 running&quot;</span><span class="op">);</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">synchronized</span><span class="op">(</span>obj1<span class="op">){</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 lock obj1&quot;</span><span class="op">);</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">synchronized</span><span class="op">(</span>obj2<span class="op">){</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 lock obj2&quot;</span><span class="op">);</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span><span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">((</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span><span class="op">{</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 running&quot;</span><span class="op">);</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">synchronized</span><span class="op">(</span>obj2<span class="op">){</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 lock obj1&quot;</span><span class="op">);</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">synchronized</span><span class="op">(</span>obj1<span class="op">){</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Lock1 lock obj2&quot;</span><span class="op">);</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span><span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>分析：当第一个线程运行到sleep的时候暂停3秒，此时obj1被锁定，由于第一个线程暂停，第二个线程有足够时间运行到sleep，此时obj2被锁定；当两个线程都暂停3秒后继续运行，此时线程1要obj2才能向下运行，从而释放obj1，但obj2被线程2锁定，而线程2又要obj1才能向下运行，从而释放obj2，这就造成了死锁</p>
<p>我们可以通过<code>JConsole</code>等工具对代码进行分析，及时发现死锁</p>
<h3 id="可重入锁">可重入锁</h3>
<p>在不可重入锁中，一个线程访问一个加锁方法会获取锁，而当这个线程再次访问该方法时（如递归调用），会再次尝试获取锁，这时会造成死锁</p>
<p>在可重入锁中，如果一个线程访问一个同步方法会获取锁，而且只要它没有释放锁，那么当它再次访问该方法时，是允许再次进入的（所以可以递归调用加锁的方法），<code>synchronized</code>是可重入锁，<code>java.util.concurrent.locks</code>包下也有很多可重入锁，如<code>ReentrantLock</code></p>
<p>下面是它的实现原理：</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> <span class="bu">Lock</span><span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> isLocked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span>  lockedBy <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当同一个线程再次访问时，允许线程进入，且lockedCount++，当lockedCount为0时代表当前线程释放锁，会notify其他线程</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> lockedCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">lock</span><span class="op">()</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throws</span> <span class="bu">InterruptedException</span><span class="op">{</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Thread</span> thread <span class="op">=</span> <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">();</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//这里使用自旋锁</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span>isLocked <span class="op">&amp;&amp;</span> lockedBy <span class="op">!=</span> thread<span class="op">){</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">wait</span><span class="op">();</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>        isLocked <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>        lockedCount<span class="op">++;</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        lockedBy <span class="op">=</span> thread<span class="op">;</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">unlock</span><span class="op">(){</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">()</span> <span class="op">==</span> <span class="kw">this</span><span class="op">.</span><span class="fu">lockedBy</span><span class="op">){</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>            lockedCount<span class="op">--;</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>lockedCount <span class="op">==</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>                isLocked <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>                lockedBy <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>                <span class="fu">notify</span><span class="op">();</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这里使用了<code>自旋锁</code>（采用让当前线程不停的在循环体内执行实现，当循环的条件被其它线程改变时才能进入临界区）</p>
<h3 id="公平锁与非公平锁condition">公平锁与非公平锁(Condition)</h3>
<p>像上面的例子中，由于线程的执行是抢占式的，调用<code>notify</code>后，各个线程会抢占锁，这样就是非公平的，而如果按照先后顺序，先运行的线程先获取锁，后面运行的线程在队列中等待，这样就是公平的</p>
<p><code>ReenTrantLock</code>可以指定是公平锁还是非公平锁，而<code>synchronized</code>只能是非公平锁，除此以外，<code>ReenTrantLock</code>提供了一个<code>Condition</code>（条件）类，用来实现分组唤醒需要唤醒的线程们，而不是像synchronized要么随机唤醒一个线程要么唤醒全部线程</p>
<p>下面是三条线程交替输出A、B、C的例子</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="kw">volatile</span> <span class="dt">int</span> condition <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="bu">Lock</span> lock <span class="op">=</span> <span class="kw">new</span> <span class="bu">ReentrantLock</span><span class="op">();</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="bu">Condition</span> lockCondition1 <span class="op">=</span> lock<span class="op">.</span><span class="fu">newCondition</span><span class="op">();</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="bu">Condition</span> lockCondition2 <span class="op">=</span> lock<span class="op">.</span><span class="fu">newCondition</span><span class="op">();</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="bu">Condition</span> lockCondition3 <span class="op">=</span> lock<span class="op">.</span><span class="fu">newCondition</span><span class="op">();</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">InterruptedException</span> <span class="op">{</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>                    lock<span class="op">.</span><span class="fu">lock</span><span class="op">();</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">while</span> <span class="op">(!(</span>condition <span class="op">==</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>                            lockCondition1<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>                        condition <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>                        lockCondition2<span class="op">.</span><span class="fu">signal</span><span class="op">();</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>                        lock<span class="op">.</span><span class="fu">unlock</span><span class="op">();</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> <span class="st">&quot;A&quot;</span><span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>                    lock<span class="op">.</span><span class="fu">lock</span><span class="op">();</span></span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">while</span> <span class="op">(!(</span>condition <span class="op">==</span> <span class="dv">2</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>                            lockCondition2<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>                        condition <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a>                        lockCondition3<span class="op">.</span><span class="fu">signal</span><span class="op">();</span></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a>                        lock<span class="op">.</span><span class="fu">unlock</span><span class="op">();</span></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb63-50"><a href="#cb63-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb63-51"><a href="#cb63-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> <span class="st">&quot;B&quot;</span><span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb63-52"><a href="#cb63-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-53"><a href="#cb63-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-54"><a href="#cb63-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb63-55"><a href="#cb63-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb63-56"><a href="#cb63-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-57"><a href="#cb63-57" aria-hidden="true" tabindex="-1"></a>                    lock<span class="op">.</span><span class="fu">lock</span><span class="op">();</span></span>
<span id="cb63-58"><a href="#cb63-58" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb63-59"><a href="#cb63-59" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">while</span> <span class="op">(!(</span>condition <span class="op">==</span> <span class="dv">3</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb63-60"><a href="#cb63-60" aria-hidden="true" tabindex="-1"></a>                            lockCondition3<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb63-61"><a href="#cb63-61" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb63-62"><a href="#cb63-62" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb63-63"><a href="#cb63-63" aria-hidden="true" tabindex="-1"></a>                        condition <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb63-64"><a href="#cb63-64" aria-hidden="true" tabindex="-1"></a>                        lockCondition1<span class="op">.</span><span class="fu">signal</span><span class="op">();</span></span>
<span id="cb63-65"><a href="#cb63-65" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb63-66"><a href="#cb63-66" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-67"><a href="#cb63-67" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">interrupt</span><span class="op">();</span></span>
<span id="cb63-68"><a href="#cb63-68" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb63-69"><a href="#cb63-69" aria-hidden="true" tabindex="-1"></a>                        lock<span class="op">.</span><span class="fu">unlock</span><span class="op">();</span></span>
<span id="cb63-70"><a href="#cb63-70" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb63-71"><a href="#cb63-71" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb63-72"><a href="#cb63-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb63-73"><a href="#cb63-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span> <span class="st">&quot;C&quot;</span><span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb63-74"><a href="#cb63-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb63-75"><a href="#cb63-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="重量级锁轻量级锁偏向锁">重量级锁、轻量级锁、偏向锁</h3>
<p>锁的状态总共有四种：无锁状态、偏向锁、轻量级锁和重量级锁，锁可以从偏向锁升级到轻量级锁，再升级到重量级锁（但是锁的升级是单向的，也就是说只能从低到高升级，不会出现锁的降级）</p>
<p>锁在内存中的标志位(32位JDK)</p>
<table>
<tr>
<th>
锁状态
</th>
<th colspan="2">
25bit
</th>
<th>
4bit
</th>
<th>
1bit
</th>
<th>
2bit
</th>
</tr>
<tr>
<td>
</td>
<td>
23bit
</td>
<td>
2bit
</td>
<td>
</td>
<td>
是否是偏向锁
</td>
<td>
锁标志位
</td>
</tr>
<tr>
<td>
轻量级锁
</td>
<td colspan="4">
指向栈中锁记录的指针
</td>
<td>
00
</td>
</tr>
<tr>
<td>
重量级锁
</td>
<td colspan="4">
指向互斥量（重量级锁）的指针
</td>
<td>
10
</td>
</tr>
<tr>
<td>
GC标记
</td>
<td colspan="4">
空
</td>
<td>
11
</td>
</tr>
<tr>
<td>
偏向锁
</td>
<td>
线程ID
</td>
<td>
Epoch
</td>
<td>
对象分代年龄
</td>
<td>
1
</td>
<td>
01
</td>
</tr>
<tr>
<td>
无锁
</td>
<td colspan="2">
对象的hashCode
</td>
<td>
对象分代年龄
</td>
<td>
0
</td>
<td>
01
</td>
</tr>
</table>
<h4 id="重量级锁">重量级锁</h4>
<div class="sourceCode" id="cb64"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SynchronizedDemo <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">method</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">synchronized</span> <span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Method 1 start&quot;</span><span class="op">);</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当我们使用<code>javap -c</code>来反编译上面代码时，得到的JAVA字节码如下</p>
<pre><code>class SynchronizedDemo {
  SynchronizedDemo();
    Code:
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
       4: return

  public void method();
    Code:
       0: aload_0
       1: dup
       2: astore_1
       3: monitorenter
       4: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
       7: ldc           #3                  // String Method 1 start
       9: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
      12: aload_1
      13: monitorexit
      14: goto          22
      17: astore_2
      18: aload_1
      19: monitorexit
      20: aload_2
      21: athrow
      22: return
    Exception table:
       from    to  target type
           4    14    17   any
          17    20    17   any
}</code></pre>
<p>注意到<code>monitorenter</code>和<code>monitorexit</code>两条指令，<code>Synchronized代码块</code>就是通过这两条指定实现的（执行<code>monitorexit</code>的线程必须是<code>objectref</code>所对应的<code>monitor</code>的所有者）</p>
<p>再看看同步方法</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SynchronizedMethod <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">method</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Hello World!&quot;</span><span class="op">);</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用<code>javap -v</code>反编译，可以看到常量池中的内容</p>
<pre><code> public synchronized void method();
    descriptor: ()V
    flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3                  // String Hello World!
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 3: 0
        line 4: 8</code></pre>
<p>可以看到，<code>synchronized方法</code>没有使用<code>monitor</code>(监视器锁)，而是在常量池中加入了<code>ACC_SYNCHRONIZED</code>字段，JVM就是根据该标示符来实现方法的同步的，但这其实只是交由JVM帮我们实现了对<code>monitor</code>的检测而已，内部也是通过<code>monitor</code>实现的</p>
<p>通过<code>monitor</code>(监视器锁)实现的锁称为重量级锁，因为监视器锁是依赖于底层的操作系统的<code>Mutex Lock</code>来实现的，而操作系统实现线程之间的切换这就需要从用户态转换到核心态，这个成本非常高，状态之间的转换需要相对比较长的时间，这就是为什么<code>synchronized</code>效率低的原因</p>
<h4 id="轻量级锁">轻量级锁</h4>
<p>JDK6以后，引入了轻量级锁和偏向锁以减少获得锁和释放锁的开销</p>
<p>加锁过程</p>
<ol type="1">
<li>在代码进入同步块的时候，如果同步对象锁状态为无锁状态（锁标志位为“01”状态，是否为偏向锁为“0”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录（Lock
Record）的空间，用于存储锁对象目前的Mark Word（Displaced Mark
Word）的拷贝</li>
<li>拷贝对象头中的Mark Word复制到锁记录中</li>
<li>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock
Record的指针，并将Lock record里的owner指针指向object mark word</li>
<li>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark
Word的锁标志位设置为“00”，即表示此对象处于轻量级锁定状态</li>
<li>如果这个更新操作失败了，虚拟机首先会检查对象的Mark
Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行。否则说明多个线程竞争锁，轻量级锁就要膨胀为重量级锁，锁标志的状态值变为“10”，Mark
Word中存储的就是指向重量级锁（互斥量）的指针，后面等待锁的线程也要进入阻塞状态。
而当前线程便尝试使用自旋来获取锁，自旋就是为了不让线程阻塞，而采用循环去获取锁的过程。</li>
</ol>
<h4 id="偏向锁">偏向锁</h4>
<p>大多数情况下，锁不存在多线程竞争，而是总是由同一线程多次获得时，为了使线程获得锁的代价更低而引入了偏向锁</p>
<p>加锁过程</p>
<ol type="1">
<li><p>如果为可偏向状态，测试对象头Mark
Word(默认存储对象的HashCode,分代年龄，锁标记位)里是否存储着指向当前线程的偏向锁</p></li>
<li><p>若测试失败，则测试Mark
Word中偏向锁标识是否设置成1(表示当前为偏向锁)</p></li>
<li><p>没有设置则使用CAS竞争，否则尝试使用CAS将对象头的偏向锁指向当前线程</p></li>
</ol>
<h4 id="几种锁的区别">几种锁的区别</h4>
<p>重量级锁</p>
<blockquote>
<p>优点：线程竞争不使用自旋，不会消耗CPU</p>
<p>缺点：线程阻塞，响应时间缓慢</p>
<p>适用场景：追求吞吐量。同步块执行速度较慢。</p>
</blockquote>
<p>轻量级锁</p>
<blockquote>
<p>优点：竞争的线程不会阻塞，提高了程序的响应速度</p>
<p>缺点：如果始终得不到锁竞争的线程使用自旋会消耗CPU</p>
<p>适用场景：追求响应时间。同步块执行速度非常快</p>
</blockquote>
<p>偏向锁</p>
<blockquote>
<p>优点：加锁和解锁不需要额外的消耗，和执行非同步方法比仅存在纳秒级的差距</p>
<p>缺点：如果线程间存在锁竞争，会带来额外的锁撤销的消耗</p>
<p>适用场景：适用于只有一个线程访问同步块场景</p>
</blockquote>
<h3 id="阻塞队列">阻塞队列</h3>
<p>和普通队列不同的是，取出/加入元素时如果达到数量下限(0)/数量上限(CAPACITY)时会阻塞并等待加入/取出，下面是其实现原理</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="bu">BlockingQueue</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//max size of this queue</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="dt">int</span> CAPACITY<span class="op">;</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">LinkedList</span><span class="op">&lt;</span>T<span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">LinkedList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span> lock <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">BlockingQueue</span><span class="op">(</span><span class="dt">int</span> capacity<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">CAPACITY</span> <span class="op">=</span> capacity<span class="op">;</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//队列中元素小于0时，阻塞并等待添加数据</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> T <span class="fu">take</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">synchronized</span> <span class="op">(</span>lock<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>list<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>                    lock<span class="op">.</span><span class="fu">wait</span><span class="op">();</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>            <span class="co">//取出后从队列中删除该元素</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>            T element <span class="op">=</span> list<span class="op">.</span><span class="fu">poll</span><span class="op">();</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;take &quot;</span><span class="op">+</span>element<span class="op">);</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>            lock<span class="op">.</span><span class="fu">notify</span><span class="op">();</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> element<span class="op">;</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">//队列元素大于CAPACITY时，阻塞并等待取出元素</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">put</span><span class="op">(</span>T element<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">synchronized</span> <span class="op">(</span>lock<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>list<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&gt;</span> CAPACITY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>                    lock<span class="op">.</span><span class="fu">wait</span><span class="op">();</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">offer</span><span class="op">(</span>element<span class="op">);</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;put &quot;</span><span class="op">+</span>element<span class="op">);</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>            lock<span class="op">.</span><span class="fu">notify</span><span class="op">();</span></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>JDK给我们提供了一些常用的阻塞队列</p>
<ul>
<li>ArrayBlockingQueue: 一个由数组结构组成的有数量上限的阻塞队列</li>
<li>LinkedBlockingQueue: 一个由链表结构组成的有数量上限阻塞队列</li>
<li>LinkedTransferQueue: 一个由链表结构组成的无界阻塞队列</li>
<li>LinkedBlockingDeque: 一个由链表结构组成的双向阻塞队列</li>
<li>SynchronousQueue:
CAPACITY为1的阻塞队列，适用于生产消费模型中产品一旦生产立即被消费（不存储元素）</li>
<li>PriorityBlockingQueue: 一个支持优先级排序的无界阻塞队列</li>
<li>DelayQueue:
一个可以指定元素有效时长的无界阻塞队列（元素会在有效时间过后删除）</li>
</ul>
<h3 id="高性能队列">高性能队列</h3>
<p>与阻塞队列相对应的，有高性能队列<code>ConcurrentLinkedQueue</code>、高性能哈希表<code>ConcurrentHashMap</code>，所谓高性能就是不加锁或局部加锁</p>
<p><code>ConcurrentLinkedQueue</code>是一个基于链接节点的无界线程安全队列，它不允许存入<code>null</code>元素。其内部通过使用<code>transient</code>、<code>volatile</code>关键字来提高效率并保证线程安全，而以前的<code>LinkedList</code>通过<code>Collections.synchronizedList</code>转成线程安全后，效率是会下降的，其原因在于<code>synchronizedList</code>函数是将<code>LinkedList</code>的每个方法加锁来保证线程安全的，而加锁会导致效率下降</p>
<p><code>ConcurrentHashMap</code>是将以往的<code>HashMap</code>分成16段(segment)，每次读写是只需锁定需要进行读写操作的那一个segment，其他segment仍然可以并行的读写，这样就提高了并发情况下的效率（JDK8以后，把每个segment改为<code>transient volatile HashEntry&lt;K,V&gt;[] table</code>，table底层使用了红黑树进行优化）</p>
<h3 id="copyonwrite">CopyOnWrite</h3>
<p><code>CopyOnWrite</code>（COW）即写时复制的容器，它实现了读写分离：当我们往一个容器添加元素的时候，不直接往当前容器添加，而是先将当前容器进行Copy，复制出一个新的容器，然后新的容器里添加元素，添加完元素之后，再将原容器的引用指向新的容器。这样的话，当我们需要对数据进行大量读取、少量写入时，<code>CopyOnWrite</code>就在可以并发读取的同时也能保证线程安全。但是当数据量很大又或者有大量写入操作时，<code>CopyOnWrite</code>的效率就会很低。</p>
<p>JAVA给我们提供了<code>CopyOnWrite</code>容器，如<code>CopyOnWriteArrayList</code>、<code>CopyOnWriteArraySet</code>等</p>
<h3 id="abstractqueuedsynchronizer">AbstractQueuedSynchronizer</h3>
<p><code>AbstractQueuedSynchronizer</code>(AQS)为<code>java.util.concurrent</code>包下的一些类提供了一套通用的方法，它维护了一个<code>volatile int state</code>（状态值），一个FIFO线程等待队列（多线程争用资源被阻塞时会进入此队列），并定义两种资源共享方式：Exclusive（独占，只有一个线程能执行，如<code>ReentrantLock</code>）和Share（共享，多个线程可同时执行，如<code>Semaphore</code>/<code>CountDownLatch</code>）。我们自定义同步类容器只需继承它并重写对应方法即可（线程竞争入队列等待的逻辑已经帮我们实现好，我们只需维护state和获取、释放资源即可），如<code>CountDownLatch</code>的源码中的内部类</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> Sync <span class="kw">extends</span> <span class="bu">AbstractQueuedSynchronizer</span> <span class="op">{</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID <span class="op">=</span> <span class="dv">4982264981922014374L</span><span class="op">;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sync</span><span class="op">(</span><span class="dt">int</span> count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setState</span><span class="op">(</span>count<span class="op">);</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="fu">getCount</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">getState</span><span class="op">();</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//以共享方式尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">int</span> <span class="fu">tryAcquireShared</span><span class="op">(</span><span class="dt">int</span> acquires<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span><span class="fu">getState</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//共享方式。尝试释放资源，成功则返回true，失败则返回false</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">tryReleaseShared</span><span class="op">(</span><span class="dt">int</span> releases<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> c <span class="op">=</span> <span class="fu">getState</span><span class="op">();</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>c <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> nextc <span class="op">=</span> c <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">//通过CAS来更新state</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="fu">compareAndSetState</span><span class="op">(</span>c<span class="op">,</span> nextc<span class="op">))</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> nextc <span class="op">==</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>共享方式访问需重写<code>tryAcquireShared</code>、<code>tryReleaseShared</code>即可</p>
<p>独占方式访问需重写</p>
<ul>
<li><code>tryAcquire</code>:
以独占方式尝试获取资源，成功则返回true，失败则返回false</li>
<li><code>tryRelease</code>:
以独占方式尝试释放资源，成功则返回true，失败则返回false</li>
</ul>
<p>如果需要使用到<code>Condition</code>，还需重写</p>
<ul>
<li><code>isHeldExclusively</code>: 该线程是否正在独占资源</li>
</ul>
<h4 id="countdownlatch">CountDownLatch</h4>
<p><code>CountDownLatch</code>又叫闭锁，它可以等待其他线程执行完（或执行到某个状态）再继续执行某一线程。它类似计数器，创建的时候指定总的线程数，线程执行完成后使用<code>countDown</code>函数使计数器减1，当计数器为0时，结束<code>await</code></p>
<p>比如计算所有线程的执行时间，需阻塞至所有线程执行完成</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">CountDownLatch</span> countDownLatch <span class="op">=</span> <span class="kw">new</span> <span class="bu">CountDownLatch</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>        MyRunnable runnable <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyRunnable</span><span class="op">(</span>countDownLatch<span class="op">);</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        Instant start <span class="op">=</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span>runnable<span class="op">).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//阻塞至所有线程执行完成</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        countDownLatch<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>        Instant end <span class="op">=</span> Instant<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Duration</span><span class="op">.</span><span class="fu">between</span><span class="op">(</span>start<span class="op">,</span> end<span class="op">).</span><span class="fu">toMillis</span><span class="op">());</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyRunnable <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">CountDownLatch</span> countDownLatch<span class="op">;</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MyRunnable</span><span class="op">(</span><span class="bu">CountDownLatch</span> countDownLatch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">countDownLatch</span> <span class="op">=</span> countDownLatch<span class="op">;</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>count <span class="op">&lt;=</span> <span class="dv">10000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>            count<span class="op">++;</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+=</span> count<span class="op">;</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>sum<span class="op">);</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>        countDownLatch<span class="op">.</span><span class="fu">countDown</span><span class="op">();</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="cyclicbarrier">CyclicBarrier</h4>
<p>与<code>CountDownLatch</code>相反，<code>CyclicBarrier</code>可以让一组线程等待至某个状态之后再全部同时执行</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">CyclicBarrier</span> cyclicBarrier <span class="op">=</span> <span class="kw">new</span> <span class="bu">CyclicBarrier</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyRunnable</span><span class="op">(</span>cyclicBarrier<span class="op">)).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyRunnable <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">CyclicBarrier</span> cyclicBarrier<span class="op">;</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MyRunnable</span><span class="op">(</span><span class="bu">CyclicBarrier</span> cyclicBarrier<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">cyclicBarrier</span> <span class="op">=</span> cyclicBarrier<span class="op">;</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;正在等待其他线程启动完成....&quot;</span><span class="op">);</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>            cyclicBarrier<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;所有线程均启动完成，开始执行任务&quot;</span><span class="op">);</span></span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">//...</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="semaphore">Semaphore</h4>
<p><code>Semaphore</code>，信号量，它可以控制同时访问的最大线程个数</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Semaphore</span> semaphore <span class="op">=</span> <span class="kw">new</span> <span class="bu">Semaphore</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span><span class="dv">8</span><span class="op">;</span>i<span class="op">++){</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyRunnable</span><span class="op">(</span>semaphore<span class="op">)).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyRunnable <span class="kw">implements</span> <span class="bu">Runnable</span> <span class="op">{</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Semaphore</span> semaphore<span class="op">;</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MyRunnable</span><span class="op">(</span><span class="bu">Semaphore</span> semaphore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">semaphore</span> <span class="op">=</span> semaphore<span class="op">;</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>            semaphore<span class="op">.</span><span class="fu">acquire</span><span class="op">();</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()+</span><span class="st">&quot;在使用&quot;</span><span class="op">);</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span><span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>            semaphore<span class="op">.</span><span class="fu">release</span><span class="op">();</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="readwritelock">ReadWriteLock</h4>
<p>多线程时，如果读取数据的同时如果还在写入，会导致脏读，因此读和写是互斥的；但如果是多个线程同时读取，没有写入操作，是完全没有问题的，读操作之间并不互斥，JAVA给我们提供了<code>ReetrantReadWriteLock</code>（基于AQS，<code>AbstractQueuedSynchronizer</code>）实现这种逻辑</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ReentrantReadWriteLock</span> lock <span class="op">=</span> <span class="kw">new</span> <span class="bu">ReentrantReadWriteLock</span><span class="op">();</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="kw">volatile</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">int</span> <span class="fu">getCount</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    lock<span class="op">.</span><span class="fu">readLock</span><span class="op">().</span><span class="fu">lock</span><span class="op">();</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> tmp<span class="op">;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>        tmp <span class="op">=</span> count<span class="op">;</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//锁的释放最好放在finally中</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        lock<span class="op">.</span><span class="fu">readLock</span><span class="op">().</span><span class="fu">unlock</span><span class="op">();</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tmp<span class="op">;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setCount</span><span class="op">(</span><span class="dt">int</span> count<span class="op">)</span> <span class="op">{</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    lock<span class="op">.</span><span class="fu">writeLock</span><span class="op">().</span><span class="fu">lock</span><span class="op">();</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">count</span> <span class="op">=</span> count<span class="op">;</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        lock<span class="op">.</span><span class="fu">writeLock</span><span class="op">().</span><span class="fu">unlock</span><span class="op">();</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="forkjoinpool">ForkJoinPool</h3>
<p>有时候我们希望把一个大任务拆分成许多的小任务，分别交由多个线程去执行，最后再把结果整合起来，这时就需要用到<code>ForkJoinPool</code></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>        CalculateTask task <span class="op">=</span> <span class="kw">new</span> <span class="fu">CalculateTask</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1000000000</span><span class="op">);</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        ForkJoinPool pool <span class="op">=</span> <span class="kw">new</span> <span class="fu">ForkJoinPool</span><span class="op">();</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> sum <span class="op">=</span> pool<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>task<span class="op">);</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>sum<span class="op">);</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        pool<span class="op">.</span><span class="fu">shutdown</span><span class="op">();</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="co">//RecursiveTask和RecursiveAction是一样的，只不过一个有返回值，一个没有返回值</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CalculateTask <span class="kw">extends</span> RecursiveTask<span class="op">&lt;</span><span class="bu">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="dt">long</span> THRESHOLD <span class="op">=</span> <span class="dv">10000</span><span class="op">;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> start<span class="op">;</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> end<span class="op">;</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">CalculateTask</span><span class="op">(</span><span class="dt">long</span> start<span class="op">,</span> <span class="dt">long</span> end<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">start</span> <span class="op">=</span> start<span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">end</span> <span class="op">=</span> end<span class="op">;</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//使用fork的时候，会自动调用compute函数</span></span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Long</span> <span class="fu">compute</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> block <span class="op">=</span> end <span class="op">-</span> start<span class="op">;</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>block <span class="op">&gt;</span> THRESHOLD<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果计算量大于阈值，则拆分成两个小任务</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">long</span> middle <span class="op">=</span> <span class="op">(</span>start <span class="op">+</span> end<span class="op">)</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>            CalculateTask left <span class="op">=</span> <span class="kw">new</span> <span class="fu">CalculateTask</span><span class="op">(</span>start<span class="op">,</span> middle<span class="op">);</span></span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>            CalculateTask right <span class="op">=</span> <span class="kw">new</span> <span class="fu">CalculateTask</span><span class="op">(</span>middle <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> end<span class="op">);</span></span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">//fork就是拆分的意思</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>            left<span class="op">.</span><span class="fu">fork</span><span class="op">();</span></span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>            right<span class="op">.</span><span class="fu">fork</span><span class="op">();</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>            <span class="co">//整合结果</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> left<span class="op">.</span><span class="fu">join</span><span class="op">()</span> <span class="op">+</span> right<span class="op">.</span><span class="fu">join</span><span class="op">();</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">long</span> i <span class="op">=</span> start<span class="op">;</span> i <span class="op">&lt;=</span> end<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>                sum <span class="op">+=</span> i<span class="op">;</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> sum<span class="op">;</span></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="executors">Executors</h3>
<p>JAVA给我们提供了<code>Executors</code>工厂类来创建一些常用的线程池，它有如下方法</p>
<ul>
<li><p>newCachedThreadPool:
创建一个可缓存线程池，根据需要创建线程，当线程空闲超过60秒时，会自动回收线程</p></li>
<li><p>newFixedThreadPool:
创建一个定长线程池，可控制线程最大并发数，超出的线程会在队列中等待</p></li>
<li><p>newScheduledThreadPool:
创建一个线程池，它可安排在给定延迟后运行命令或者定期地执行</p></li>
<li><p>newSingleThreadExecutor:
创建一个只有一个线程的线程池，它可以保证所有任务按照指定顺序(FIFO, LIFO,
优先级)执行</p></li>
</ul>
<p>如果上述线程池都无法满足需求，我们也可以通过指定<code>ThreadPoolExecutor</code>的参数来自定义线程池，其构造函数如下</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">ThreadPoolExecutor</span><span class="op">(</span><span class="dt">int</span> corePoolSize<span class="op">,</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">int</span> maximumPoolSize<span class="op">,</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">long</span> keepAliveTime<span class="op">,</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">TimeUnit</span> unit<span class="op">,</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">BlockingQueue</span><span class="op">&lt;</span><span class="bu">Runnable</span><span class="op">&gt;</span> workQueue<span class="op">,</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">ThreadFactory</span> threadFactory<span class="op">,</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>                          <span class="bu">RejectedExecutionHandler</span> handler<span class="op">);</span><span class="co">//后两个参数为可选参数</span></span></code></pre></div>
<p>参数说明</p>
<ul>
<li><p>corePoolSize:
核心线程数，如果运行的线程少于corePoolSize，则创建新线程来执行新任务，即使线程池中的其他线程是空闲的；当运行的线程数超过corePoolSize时，任务会加入到<code>BlockingQueue</code>中；设置<code>allowCoreThreadTimeout=true</code>（默认false）时，核心线程会超时关闭。该参数一般设置为<code>CUP数量-1</code></p></li>
<li><p>maximumPoolSize:
最大线程数，当<code>BlockingQueue</code>(是有界队列时)满了以后，如果线程数小于maximumPoolSize，则新加入的任务会创建线程并执行；如果线程数超过maximumPoolSize，则会执行拒绝策略<code>RejectedExecutionHandler</code>.该参数一般设置为<code>CUP数量*2+1</code></p></li>
<li><p>keepAliveTime:
线程空闲时的可存活时间，超过时间后会被回收</p></li>
<li><p>unit:
时间的单位，可以指定keepAliveTime的单位是时、分、秒、毫秒等</p></li>
<li><p>workQueue:
用于在线程数大于corePoolSize时保存任务的队列，如果是有界队列，当队列满了且线程数小于maximumPoolSize时会新建线程并执行任务；如果是无界队列，则可以一直添加任务，直至内存溢出，此时maximumPoolSize参数一般和corePoolSize保持一致，且此时拒绝策略无效。使用无界队列有可能导致服务器崩溃(OOM)，不建议使用</p></li>
<li><p>threadFactory:
使用ThreadFactory创建新线程，默认使用defaultThreadFactory创建线程，参数一般不设置，使用默认的即可</p></li>
<li><p>handler:
拒绝策略，当workQueue满了且线程数大于maximumPoolSize时，执行拒绝策略，默认的拒绝策略是抛<code>RejectExecutorException</code>异常，JAVA给我们提供了其他的拒绝策略，比如<code>DiscardPolicy</code>，抛弃任务；<code>DiscardOldestPolicy</code>，抛弃下一个将要执行的任务；<code>CallerRunsPolicy</code>，把任务交给调用execute方法的线程运行。这些都不是好的拒绝策略，会导致用户数据丢失或者阻塞线程，我们尽量自己实现拒绝策略，比如将任务分发给另一台服务器运行</p></li>
</ul>
<p><strong>参数调优</strong></p>
<p>定义如下参数</p>
<ul>
<li><p>tasks: 每秒的任务数</p></li>
<li><p>taskcost: 每个任务花费时间</p></li>
<li><p>responsetime: 统允许容忍的最大响应时间</p></li>
</ul>
<p>threadcount = tasks/(1/taskcost) = tasks*taskcost</p>
<p>假设每秒要执行500<sub>1000个任务，平均每个任务要执行0.1秒，那么threadcount为50</sub>100，所以corePoolSize要大于50，如果80%的情况下每秒任务数小于800，那么corePoolSize就设置为80</p>
<p>queueCapacity = (coreSizePool/taskcost)*responsetime</p>
<p>计算可得 queueCapacity = 80/0.1*1 =
80，意思是队列里的线程可以等待1s，超过了的需要新开线程来执行</p>
<p>maxPoolSize = (max(tasks) - queueCapacity)/(1/taskcost)</p>
<p>计算可得 maxPoolSize = (1000-80)/10 = 92</p>
<h3 id="future模式">Future模式</h3>
<p>当客户端请求数据时，先返回一个空的数据(wrapper)，这时服务器端新建一个线程去获取真正的数据，当数据获取完了之后填入wrapper中，这就要求wrapper和真实数据的类型都实现或继承相同的类或接口，且在用到数据的地方都要先判断真实数据是否为空，如果为空，则要阻塞线程，等待真实数据填入。</p>
<h3 id="master-worker模式">Master-Worker模式</h3>
<p>master负责接收客户端的请求并把任务分发给worker，worker负责真正的处理任务。它能将大任务分解成若干个小任务，并发执行，提高系统性能，并且实现了调用和执行的解耦</p>
<h2 id="bionioaio">22.BIO、NIO、AIO</h2>
<h3 id="bio">BIO</h3>
<p>传统的IO操作、socket都是基于BIO（Blocking IO）实现的</p>
<p>UDP</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">//服务器端</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">DatagramSocket</span> udpSocket <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>            udpSocket <span class="op">=</span> <span class="kw">new</span> <span class="bu">DatagramSocket</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="dv">8080</span><span class="op">));</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">DatagramPacket</span> receive <span class="op">=</span> <span class="kw">new</span> <span class="bu">DatagramPacket</span><span class="op">(</span><span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">1024</span><span class="op">],</span> <span class="dv">1024</span><span class="op">);</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">receive</span><span class="op">(</span>receive<span class="op">);</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Server: &quot;</span><span class="op">+</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>receive<span class="op">.</span><span class="fu">getData</span><span class="op">(),</span><span class="dv">0</span><span class="op">,</span>receive<span class="op">.</span><span class="fu">getLength</span><span class="op">()));</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> data <span class="op">=</span> <span class="st">&quot;Hello client&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">();</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">send</span><span class="op">(</span><span class="kw">new</span> <span class="bu">DatagramPacket</span><span class="op">(</span>data<span class="op">,</span> data<span class="op">.</span><span class="fu">length</span><span class="op">,</span>receive<span class="op">.</span><span class="fu">getAddress</span><span class="op">(),</span>receive<span class="op">.</span><span class="fu">getPort</span><span class="op">()));</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="co">//客户端</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">DatagramSocket</span> udpSocket <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>            udpSocket <span class="op">=</span> <span class="kw">new</span> <span class="bu">DatagramSocket</span><span class="op">();</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> data <span class="op">=</span> <span class="st">&quot;Hello server&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">();</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">send</span><span class="op">(</span><span class="kw">new</span> <span class="bu">DatagramPacket</span><span class="op">(</span>data<span class="op">,</span> data<span class="op">.</span><span class="fu">length</span><span class="op">,</span> <span class="bu">InetAddress</span><span class="op">.</span><span class="fu">getByName</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">),</span> <span class="dv">8080</span><span class="op">));</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>            <span class="bu">DatagramPacket</span> receive <span class="op">=</span> <span class="kw">new</span> <span class="bu">DatagramPacket</span><span class="op">(</span><span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">1024</span><span class="op">],</span> <span class="dv">1024</span><span class="op">);</span></span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">receive</span><span class="op">(</span>receive<span class="op">);</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Client: &quot;</span><span class="op">+</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>receive<span class="op">.</span><span class="fu">getData</span><span class="op">(),</span><span class="dv">0</span><span class="op">,</span>receive<span class="op">.</span><span class="fu">getLength</span><span class="op">()));</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a>            udpSocket<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb76-41"><a href="#cb76-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-42"><a href="#cb76-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-43"><a href="#cb76-43" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>TCP</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">//服务器端</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ServerSocket</span> serverSocket <span class="op">=</span> <span class="kw">null</span><span class="op">;</span><span class="co">//1024-65535的某个端口</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>            serverSocket <span class="op">=</span> <span class="kw">new</span> <span class="bu">ServerSocket</span><span class="op">(</span><span class="dv">8080</span><span class="op">);</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">exit</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Socket</span> socket <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">InputStream</span> is <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">InputStreamReader</span> isr <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BufferedReader</span> br <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">OutputStream</span> os <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>                socket <span class="op">=</span> serverSocket<span class="op">.</span><span class="fu">accept</span><span class="op">();</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>                <span class="co">//读取客户端信息</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>                is <span class="op">=</span> socket<span class="op">.</span><span class="fu">getInputStream</span><span class="op">();</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>                isr <span class="op">=</span> <span class="kw">new</span> <span class="bu">InputStreamReader</span><span class="op">(</span>is<span class="op">);</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>                br <span class="op">=</span> <span class="kw">new</span> <span class="bu">BufferedReader</span><span class="op">(</span>isr<span class="op">);</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> data<span class="op">;</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">((</span>data <span class="op">=</span> br<span class="op">.</span><span class="fu">readLine</span><span class="op">())</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;收到客户端请求：&quot;</span> <span class="op">+</span> data<span class="op">);</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>                socket<span class="op">.</span><span class="fu">shutdownInput</span><span class="op">();</span><span class="co">//关闭输入流</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>                <span class="co">//响应客户端</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>                os <span class="op">=</span> socket<span class="op">.</span><span class="fu">getOutputStream</span><span class="op">();</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>                os<span class="op">.</span><span class="fu">write</span><span class="op">(</span><span class="st">&quot;Hello client&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>                os<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>                socket<span class="op">.</span><span class="fu">shutdownOutput</span><span class="op">();</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>                    br<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>                    isr<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>                    is<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>                    os<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>                    socket<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a><span class="co">//客户端</span></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Socket</span> clientSocket <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">OutputStream</span> os <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>            <span class="bu">InputStream</span> is <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">InputStreamReader</span> isr <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BufferedReader</span> br <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>                clientSocket <span class="op">=</span> <span class="kw">new</span> <span class="bu">Socket</span><span class="op">(</span><span class="bu">InetAddress</span><span class="op">.</span><span class="fu">getByName</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">),</span> <span class="dv">8080</span><span class="op">);</span></span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>                <span class="co">//向服务器端发数据</span></span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>                os <span class="op">=</span> clientSocket<span class="op">.</span><span class="fu">getOutputStream</span><span class="op">();</span></span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>                os<span class="op">.</span><span class="fu">write</span><span class="op">(</span><span class="st">&quot;Hello Server&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>                os<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>                clientSocket<span class="op">.</span><span class="fu">shutdownOutput</span><span class="op">();</span></span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>                <span class="co">//读取服务器端信息</span></span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>                is <span class="op">=</span> clientSocket<span class="op">.</span><span class="fu">getInputStream</span><span class="op">();</span></span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a>                isr <span class="op">=</span> <span class="kw">new</span> <span class="bu">InputStreamReader</span><span class="op">(</span>is<span class="op">);</span></span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>                br <span class="op">=</span> <span class="kw">new</span> <span class="bu">BufferedReader</span><span class="op">(</span>isr<span class="op">);</span></span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> data<span class="op">;</span></span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">((</span>data <span class="op">=</span> br<span class="op">.</span><span class="fu">readLine</span><span class="op">())</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;收到服务器端响应：&quot;</span> <span class="op">+</span> data<span class="op">);</span></span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a>                clientSocket<span class="op">.</span><span class="fu">shutdownInput</span><span class="op">();</span></span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a>                    os<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>                    is<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a>                    isr<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>                    br<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a>                    clientSocket<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>这样每一次请求都会阻塞服务器，如果在客户端请求时服务器端在处理另一客户端的数据，就会导致连接失败，好一点的设计是为每个请求新开线程处理</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Socket</span> socket <span class="op">=</span> serverSocket<span class="op">.</span><span class="fu">accept</span><span class="op">();</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyRunnable</span><span class="op">(</span>socket<span class="op">)).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyRunnable <span class="kw">extends</span> <span class="bu">Runnable</span><span class="op">{</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Socket</span> socket<span class="op">;</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyRunnable</span><span class="op">(</span><span class="bu">Socket</span> socket<span class="op">){</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">socket</span> <span class="op">=</span> socket<span class="op">;</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">//处理socket</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这样做有如下缺点</p>
<ul>
<li>线程数是有上限的，超出一定数量后会内存溢出，导致服务器崩溃，但我们可以使用缓存池防止内存溢出，并使用拒绝策略把无法处理的请求分发给其他服务器</li>
<li>线程利用率较低，客户端不是一直都在给服务器写入数据（比如在读服务器返回的数据、准备发给服务器的数据等），而<code>getInputStream</code>等方法是阻塞式的，只有当客户端把所有数据都写完了服务器才能接收到</li>
</ul>
<p>NIO的<code>Selector</code>可以有效的解决线程利用率低的问题</p>
<h3 id="nio">NIO</h3>
<p>NIO全称为Non-Blocking IO，即(同步)非阻塞IO，它是基于Reactor模式的</p>
<p>以前的IO操作是由CPU直接负责的，这样的缺点是当有大量的IO操作时，CPU无法进行其他操作，性能损耗太大</p>
<p>后来改为使用<code>DMA</code>（<code>Direct Memory Access</code>）复制IO操作，当应用使用操作系统的IO接口的时候，由<code>DMA</code>向CPU申请权限，获得权限后，IO操作由<code>DMA</code>全权负责，但是如果有大量的IO请求，还是会造成<code>DMA</code>的走线过多，也会影响性能</p>
<p>再后来改为使用<code>Channel</code>，<code>Channel</code>为完全独立的单元，不需要向CPU申请权限，专门用于IO</p>
<h4 id="buffer">Buffer</h4>
<p><code>Channel</code>只是用于控制IO请求，无法直接操作文件，要操作文件，需要使用<code>Buffer</code></p>
<p>基本数据类型都有对应的<code>Buffer</code>，比如<code>ByteBuffer</code>,
<code>CharBuffer</code>, <code>DoubleBuffer</code>,
<code>FloatBuffer</code>, <code>IntBuffer</code>,
<code>LongBuffer</code>, <code>ShortBuffer</code></p>
<p>传统的IO操作是调用操作系统的IO接口，让操作系统获取数据，然后把数据复制到系统内存中，然后JVM把操作系统内存中的数据复制到JVM的内存中，这样做是出于安全的考虑，但是两次的复制会导致不必要的开销，于是在不需要考虑安全问题的情况下，我们可以使用<code>Buffer</code>直接在操作系统内存中创建空间（这时我们无法手动释放资源，这块内存空间必须由GC回收，而GC的时间是不确定的，可能会导致程序无法及时退出）</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">//在JVM内存中开辟空间（非直接缓冲区）</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer1 <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co">//在操作系统内存中开辟空间（直接缓冲区）</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer2 <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocateDirect</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span></code></pre></div>
<p><code>Buffer</code>的几个概念</p>
<ul>
<li>capacity:
最大容量，和数组一样，最大容量是固定的，一旦设置，无法更改</li>
<li>limit: 有效元素的个数，当调用<code>flip</code>函数后才有效</li>
<li>position:
指向当前存入元素的下一个位置，每次get或者put后，position会增加（指定index时get或put不会改变position的值）</li>
<li>mark:
使用<code>mark</code>函数时会记录当前的position，调用<code>reset</code>时通过mark恢复</li>
</ul>
<div class="sourceCode" id="cb80"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="bu">IntBuffer</span> buffer <span class="op">=</span> <span class="bu">IntBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">//把第0号元素改为4，此时不会影响position的值</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">//如果index所在的位置没有被不通过index的方式put过，put之后，该位置仍然被看作是无效的</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span><span class="dv">90</span><span class="op">);</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>buffer<span class="op">);</span><span class="co">//java.nio.HeapIntBuffer[pos=3 lim=10 cap=10]</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">mark</span><span class="op">();</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a><span class="co">//filp后，position归0，limit为有效元素的个数，capacity不变，mark重新置为-1</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>buffer<span class="op">);</span><span class="co">//java.nio.HeapIntBuffer[pos=0 lim=3 cap=10]</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="co">//get、set也可以直接操作数组，此时position也会增加对应长度</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span><span class="op">[]</span> tmp <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">[</span>buffer<span class="op">.</span><span class="fu">remaining</span><span class="op">()];</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">get</span><span class="op">(</span>tmp<span class="op">);</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>buffer<span class="op">);</span><span class="co">//java.nio.HeapIntBuffer[pos=3 lim=3 cap=10]</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a><span class="co">//清空Buffer</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>buffer<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span></code></pre></div>
<p>我们可以通过<code>Charset</code>将<code>ByteBuffer</code>和<code>CharBuffer</code>相互转换</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Charset</span> charset <span class="op">=</span> <span class="bu">Charset</span><span class="op">.</span><span class="fu">forName</span><span class="op">(</span><span class="st">&quot;UTF-8&quot;</span><span class="op">);</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="bu">CharBuffer</span> origin <span class="op">=</span> <span class="bu">CharBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>origin<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;Hello world&quot;</span><span class="op">);</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>origin<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">//CharBuffer -&gt; ByteBuffer</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> byteBuffer <span class="op">=</span> charset<span class="op">.</span><span class="fu">encode</span><span class="op">(</span>origin<span class="op">);</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> data <span class="op">=</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>byteBuffer<span class="op">.</span><span class="fu">array</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> byteBuffer<span class="op">.</span><span class="fu">limit</span><span class="op">(),</span> <span class="st">&quot;UTF-8&quot;</span><span class="op">);</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>data<span class="op">);</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co">//ByteBuffer -&gt; CharBuffer</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co">//可以用charset.decode，也可以用charset.newDecoder</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="bu">CharsetDecoder</span> decoder <span class="op">=</span> charset<span class="op">.</span><span class="fu">newDecoder</span><span class="op">();</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="bu">CharBuffer</span> charBuffer <span class="op">=</span> decoder<span class="op">.</span><span class="fu">decode</span><span class="op">(</span>byteBuffer<span class="op">);</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>charBuffer<span class="op">.</span><span class="fu">array</span><span class="op">());</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>data<span class="op">);</span></span></code></pre></div>
<h4 id="channel">Channel</h4>
<p>和IO一样，有用于操作本地文件的<code>Channel</code>、也有分别对应TCP、UDP的<code>Channel</code>：<code>FileChannel</code>、<code>SocketChannel</code>、<code>ServerSocketChannel</code>、<code>DatagramChannel</code></p>
<p>IO流一般都有<code>getChannel</code>方法来获取<code>Channel</code></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="bu">FileInputStream</span> fis <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileInputStream</span><span class="op">(</span><span class="st">&quot;1.txt&quot;</span><span class="op">);</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="bu">FileOutputStream</span> fos <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileOutputStream</span><span class="op">(</span><span class="st">&quot;2.txt&quot;</span><span class="op">);</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> inChannel <span class="op">=</span> fis<span class="op">.</span><span class="fu">getChannel</span><span class="op">();</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> outChannel <span class="op">=</span> fos<span class="op">.</span><span class="fu">getChannel</span><span class="op">();</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co">//我们不需要处理length，因为buffer内部有limit属性</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span>inChannel<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">)!=-</span><span class="dv">1</span><span class="op">){</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//buffer使用前一定要flip</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    outChannel<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用完buffer一定要clear，以备下次使用</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>fis<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>fos<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<p>除此以外，还可以</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取文件大小</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> size <span class="op">=</span> inChannel<span class="op">.</span><span class="fu">size</span><span class="op">();</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">//指定position</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> pos <span class="op">=</span> inChannel<span class="op">.</span><span class="fu">position</span><span class="op">();</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">position</span><span class="op">(</span>pos <span class="op">+</span><span class="dv">123</span><span class="op">);</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">//截取文件的前1024个字节，后面的内容会被删掉</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">truncate</span><span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">//出于性能方面的考虑，操作系统会将数据缓存在内存中，所以无法保证写入到FileChannel里的数据一定会即时写到磁盘上。要保证这一点，需要调用force()方法</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">force</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">//分散读取（Scatter）、聚集写入（Gather），即读到多个Buffer中，再从多个Buffer中写入</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer1 <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer2 <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">200</span><span class="op">);</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span><span class="op">[]</span> buffers <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteBuffer</span><span class="op">[]{</span>buffer1<span class="op">,</span> buffer2<span class="op">};</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffers<span class="op">);</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Buffer</span> buffer <span class="op">:</span> buffers<span class="op">)</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffers<span class="op">);</span></span></code></pre></div>
<p><code>Channel</code>也可以使用内存映射文件来提高效率，<code>MappedByteBuffer</code>和<code>allocateDirect</code>创建的<code>Buffer</code>是一样的，都是使用直接缓冲区</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">//通过FileChannel的静态方法获取Channel</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co">//第二个参数为打开的方式，是可变参数，可以有多个打开方式</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> inChannel <span class="op">=</span> <span class="bu">FileChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;1.txt&quot;</span><span class="op">),</span> StandardOpenOption<span class="op">.</span><span class="fu">READ</span><span class="op">);</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> outChannel <span class="op">=</span> <span class="bu">FileChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;2.txt&quot;</span><span class="op">),</span> StandardOpenOption<span class="op">.</span><span class="fu">READ</span><span class="op">,</span> StandardOpenOption<span class="op">.</span><span class="fu">WRITE</span><span class="op">,</span> StandardOpenOption<span class="op">.</span><span class="fu">CREATE</span><span class="op">);</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">//注意这里的MapMode要和上面的OpenOption对应</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="bu">MappedByteBuffer</span> inBuffer <span class="op">=</span> inChannel<span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="bu">FileChannel</span><span class="op">.</span><span class="fu">MapMode</span><span class="op">.</span><span class="fu">READ_ONLY</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> inChannel<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="bu">MappedByteBuffer</span> outBuffer <span class="op">=</span> outChannel<span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="bu">FileChannel</span><span class="op">.</span><span class="fu">MapMode</span><span class="op">.</span><span class="fu">READ_WRITE</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span>inChannel<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a><span class="dt">byte</span><span class="op">[]</span> tmp <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span>inBuffer<span class="op">.</span><span class="fu">remaining</span><span class="op">()];</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>inBuffer<span class="op">.</span><span class="fu">get</span><span class="op">(</span>tmp<span class="op">);</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>outBuffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span>tmp<span class="op">);</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<p>还有一个更快捷的方式，也是使用了直接缓冲区</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> inChannel <span class="op">=</span> <span class="bu">FileChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;1.txt&quot;</span><span class="op">),</span> StandardOpenOption<span class="op">.</span><span class="fu">READ</span><span class="op">);</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="bu">FileChannel</span> outChannel <span class="op">=</span> <span class="bu">FileChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;2.txt&quot;</span><span class="op">),</span> StandardOpenOption<span class="op">.</span><span class="fu">WRITE</span><span class="op">,</span> StandardOpenOption<span class="op">.</span><span class="fu">CREATE</span><span class="op">);</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">transferTo</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span>inChannel<span class="op">.</span><span class="fu">size</span><span class="op">(),</span>outChannel<span class="op">);</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>inChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>outChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<p>UDP的 <code>Channel</code></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//服务器端</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">DatagramChannel</span> channel <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                channel <span class="op">=</span> <span class="bu">DatagramChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">().</span><span class="fu">bind</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="dv">8080</span><span class="op">));</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>                <span class="bu">ByteBuffer</span> buf <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>                <span class="bu">SocketAddress</span> clientInfo <span class="op">=</span> channel<span class="op">.</span><span class="fu">receive</span><span class="op">(</span>buf<span class="op">);</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">printBuffer</span><span class="op">(</span><span class="st">&quot;receive from client: &quot;</span><span class="op">,</span>buf<span class="op">);</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;Hello client&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int</span> bytesSent <span class="op">=</span> channel<span class="op">.</span><span class="fu">send</span><span class="op">(</span>buf<span class="op">,</span> clientInfo<span class="op">);</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Server: send &quot;</span> <span class="op">+</span> bytesSent <span class="op">+</span> <span class="st">&quot; bytes&quot;</span><span class="op">);</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span><span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span>e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();}</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>                    channel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">//保证服务器先启动</span></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">//客户端</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>            <span class="bu">DatagramChannel</span> channel <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>                channel <span class="op">=</span> <span class="bu">DatagramChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a>                <span class="bu">ByteBuffer</span> buf <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>                <span class="co">//向服务器端发数据</span></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;Hello server&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>                <span class="dt">int</span> bytesSent <span class="op">=</span> channel<span class="op">.</span><span class="fu">send</span><span class="op">(</span>buf<span class="op">,</span> <span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span> <span class="dv">8080</span><span class="op">));</span></span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Client: send &quot;</span> <span class="op">+</span> bytesSent <span class="op">+</span> <span class="st">&quot; bytes&quot;</span><span class="op">);</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a>                <span class="co">//接收服务器的响应</span></span>
<span id="cb86-54"><a href="#cb86-54" aria-hidden="true" tabindex="-1"></a>                buf<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb86-55"><a href="#cb86-55" aria-hidden="true" tabindex="-1"></a>                channel<span class="op">.</span><span class="fu">receive</span><span class="op">(</span>buf<span class="op">);</span></span>
<span id="cb86-56"><a href="#cb86-56" aria-hidden="true" tabindex="-1"></a>                <span class="fu">printBuffer</span><span class="op">(</span><span class="st">&quot;receive from server: &quot;</span><span class="op">,</span>buf<span class="op">);</span></span>
<span id="cb86-57"><a href="#cb86-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span><span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span>e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();}</span></span>
<span id="cb86-58"><a href="#cb86-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb86-59"><a href="#cb86-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb86-60"><a href="#cb86-60" aria-hidden="true" tabindex="-1"></a>                    channel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb86-61"><a href="#cb86-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb86-62"><a href="#cb86-62" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb86-63"><a href="#cb86-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb86-64"><a href="#cb86-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb86-65"><a href="#cb86-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb86-66"><a href="#cb86-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb86-67"><a href="#cb86-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb86-68"><a href="#cb86-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-69"><a href="#cb86-69" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> <span class="fu">printBuffer</span><span class="op">(</span><span class="bu">String</span> tag<span class="op">,</span><span class="bu">ByteBuffer</span> buffer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb86-70"><a href="#cb86-70" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb86-71"><a href="#cb86-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">(</span>tag<span class="op">);</span></span>
<span id="cb86-72"><a href="#cb86-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>buffer<span class="op">.</span><span class="fu">hasRemaining</span><span class="op">())</span></span>
<span id="cb86-73"><a href="#cb86-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span> buffer<span class="op">.</span><span class="fu">get</span><span class="op">());</span></span>
<span id="cb86-74"><a href="#cb86-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb86-75"><a href="#cb86-75" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb86-76"><a href="#cb86-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>TCP的<code>Channel</code>和UDP差距不大（注意<code>shutdownOutput</code>、<code>shutdownInput</code>），这里不在赘述</p>
<p>除此以外，还有<code>Pipe</code>负责多线程的通信</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> <span class="bu">Pipe</span> pipe <span class="op">=</span> <span class="bu">Pipe</span><span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Pipe</span><span class="op">.</span><span class="fu">SinkChannel</span> sink <span class="op">=</span> pipe<span class="op">.</span><span class="fu">sink</span><span class="op">();</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">48</span><span class="op">);</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">().</span><span class="fu">toString</span><span class="op">().</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>        buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>            sink<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Pipe</span><span class="op">.</span><span class="fu">SourceChannel</span> source <span class="op">=</span> pipe<span class="op">.</span><span class="fu">source</span><span class="op">();</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">48</span><span class="op">);</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>            source<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>            buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>buffer<span class="op">.</span><span class="fu">array</span><span class="op">(),</span><span class="dv">0</span><span class="op">,</span>buffer<span class="op">.</span><span class="fu">limit</span><span class="op">()));</span></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>值得注意的一点是，<code>Channel</code>可以指定为阻塞式还是非阻塞式的，在非阻塞模式下，accept()
方法会立刻返回，如果还没有新进来的连接,返回的将是null，所以我们要判断返回的channel是否为<code>null</code>，一般非阻塞式都会和<code>Selector</code>配合使用</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ServerSocketChannel</span> serverSocketChannel <span class="op">=</span> <span class="bu">ServerSocketChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>serverSocketChannel<span class="op">.</span><span class="fu">socket</span><span class="op">().</span><span class="fu">bind</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="dv">8080</span><span class="op">));</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>serverSocketChannel<span class="op">.</span><span class="fu">configureBlocking</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">SocketChannel</span> socketChannel <span class="op">=</span> serverSocketChannel<span class="op">.</span><span class="fu">accept</span><span class="op">();</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>socketChannel <span class="op">!=</span> <span class="kw">null</span><span class="op">){</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//...</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="selector">Selector</h4>
<p>NIO把客户端、服务器端的连接放在通道(<code>Channel</code>)中，通过多路复用器(<code>Selector</code>)轮询每个注册了的<code>channel</code>，当<code>channel</code>准备就绪时，就进行相应的处理，这样就不需要等待所有数据都准备好之后才能开始处理，而且一个线程可以通过<code>selector</code>同时处理多个<code>channel</code>，大大地提升了每个线程的利用率</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">//服务器端</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">ServerSocketChannel</span> serverChannel <span class="op">=</span> <span class="bu">ServerSocketChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">().</span><span class="fu">bind</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="dv">8080</span><span class="op">));</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">//设置为非阻塞式</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>            serverChannel<span class="op">.</span><span class="fu">configureBlocking</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Selector</span> selector <span class="op">=</span> <span class="bu">Selector</span><span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">//把ServerSocketChannel注册到Selector上，并监听accept事件</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>            serverChannel<span class="op">.</span><span class="fu">register</span><span class="op">(</span>selector<span class="op">,</span> <span class="bu">SelectionKey</span><span class="op">.</span><span class="fu">OP_ACCEPT</span><span class="op">);</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">//轮询</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>                <span class="co">//selector.select(timeout)得到已注册并且准备就绪的Channel的个数，select函数是阻塞的</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>selector<span class="op">.</span><span class="fu">select</span><span class="op">(</span><span class="dv">500</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Iterator</span><span class="op">&lt;</span><span class="bu">SelectionKey</span><span class="op">&gt;</span> iterator <span class="op">=</span> selector<span class="op">.</span><span class="fu">selectedKeys</span><span class="op">().</span><span class="fu">iterator</span><span class="op">();</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span>iterator<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">SelectionKey</span> key <span class="op">=</span> iterator<span class="op">.</span><span class="fu">next</span><span class="op">();</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//处理完channel，channel需要再次准备才能就绪，需要把channel从就绪的列表中删除，由于是非阻塞式的，我们应该在一开始就remove</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>                    iterator<span class="op">.</span><span class="fu">remove</span><span class="op">();</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>key<span class="op">.</span><span class="fu">isAcceptable</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">ServerSocketChannel</span> server <span class="op">=</span> <span class="op">(</span><span class="bu">ServerSocketChannel</span><span class="op">)</span> key<span class="op">.</span><span class="fu">channel</span><span class="op">();</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//accept就绪，开始accept客户端</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">SocketChannel</span> clientChannel <span class="op">=</span> server<span class="op">.</span><span class="fu">accept</span><span class="op">();</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//非阻塞式时，accept有可能返回null</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>clientChannel <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//客户端也要设置为非阻塞式</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>                            clientChannel<span class="op">.</span><span class="fu">configureBlocking</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//把客户端注册到Selector上，并监听read事件</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>                            clientChannel<span class="op">.</span><span class="fu">register</span><span class="op">(</span>selector<span class="op">,</span> <span class="bu">SelectionKey</span><span class="op">.</span><span class="fu">OP_READ</span><span class="op">);</span></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//向客户端应答数据</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>                            <span class="dt">byte</span><span class="op">[]</span> data <span class="op">=</span> <span class="st">&quot;Hello client&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">();</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span>data<span class="op">.</span><span class="fu">length</span><span class="op">);</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>                            buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span>data<span class="op">);</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>                            buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>                            clientChannel<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>                            clientChannel<span class="op">.</span><span class="fu">shutdownOutput</span><span class="op">();</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>key<span class="op">.</span><span class="fu">isReadable</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//接收客户端发过来的数据</span></span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">SocketChannel</span> clientChannel <span class="op">=</span> <span class="op">(</span><span class="bu">SocketChannel</span><span class="op">)</span> key<span class="op">.</span><span class="fu">channel</span><span class="op">();</span></span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">while</span> <span class="op">(</span>clientChannel<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>                            buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Server: revecie from&quot;</span> <span class="op">+</span> clientChannel<span class="op">.</span><span class="fu">getLocalAddress</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;: &quot;</span> <span class="op">+</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>buffer<span class="op">.</span><span class="fu">array</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> buffer<span class="op">.</span><span class="fu">limit</span><span class="op">()));</span></span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>                            buffer<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>key<span class="op">.</span><span class="fu">isWritable</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//...</span></span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>key<span class="op">.</span><span class="fu">isConnectable</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//...</span></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a><span class="co">//确保服务器先启动</span></span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">//客户端</span></span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a>                <span class="bu">SocketChannel</span> socketChannel <span class="op">=</span> <span class="bu">SocketChannel</span><span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a>                socketChannel<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span> <span class="dv">8080</span><span class="op">));</span></span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a>                socketChannel<span class="op">.</span><span class="fu">configureBlocking</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a>                <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a>                buffer<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;Hello server&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a>                buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a>                socketChannel<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a>                <span class="co">//告知服务器我们已经写完</span></span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a>                socketChannel<span class="op">.</span><span class="fu">shutdownOutput</span><span class="op">();</span></span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a>                buffer<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span>socketChannel<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a>                    buffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//如果不是空数据</span></span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>buffer<span class="op">.</span><span class="fu">limit</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Client: revecie from&quot;</span> <span class="op">+</span> socketChannel<span class="op">.</span><span class="fu">getLocalAddress</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;: &quot;</span> <span class="op">+</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>buffer<span class="op">.</span><span class="fu">array</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> buffer<span class="op">.</span><span class="fu">limit</span><span class="op">()));</span></span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a>                    buffer<span class="op">.</span><span class="fu">clear</span><span class="op">();</span></span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a>                socketChannel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb89-98"><a href="#cb89-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-99"><a href="#cb89-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>NIO也有一些缺点</p>
<ul>
<li>需要我们自己实现<code>selector</code>，如果业务很复杂，写起来很麻烦</li>
<li>客户端和服务器端都要实现一次<code>channel</code>和<code>selector</code>，代码过于复杂</li>
<li>轮询操作需要遍历所有的<code>channel</code>，当<code>channel</code>数量过多时，程序效率低下</li>
</ul>
<p>虽然1、2条缺点可以通过使用NIO的框架来解决，但是我们仍希望可以通过回调的方式异步的实现非阻塞IO</p>
<h3 id="aio">AIO</h3>
<p>AIO全称为Asynchronous
IO，即异步(非阻塞)IO，它的读和写都是异步的，可以同时写多个数据，它是基于Proactor模式的</p>
<p>NIO使用了<code>select/poll</code>的方式，将<code>channel</code>注册到<code>selector</code>上，通过轮询<code>channel</code>是否就绪，将就绪的<code>channel</code>返回并进行处理，这样当<code>channel</code>数量过多时，轮询的效率会很低</p>
<p>AIO使用<code>epoll</code>的方式，将<code>channel</code>注册到<code>selector</code>上，基于回调的方式（类似监听者模式），告知<code>selector</code>哪些<code>channel</code>已经就绪，然后将就绪的<code>channel</code>返回，这样效率高，但需要操作系统层面的支持</p>
<p>下面是一个使用AIO，客户端往服务器端发数据、服务器端接收数据的例子</p>
<p>客户端：</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>AsynchronousSocketChannel channel <span class="op">=</span> AsynchronousSocketChannel<span class="op">.</span><span class="fu">open</span><span class="op">();</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>channel<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span><span class="dv">8888</span><span class="op">)).</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">wrap</span><span class="op">(</span><span class="st">&quot;中文,你好&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co">//这里使用了Future模式，返回的是一个空的数据(wrapper)</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="co">//这里也可以用回调的方式write(ByteBuffer,Object,CompletionHandler)</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Future</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> future <span class="op">=</span> channel<span class="op">.</span><span class="fu">write</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co">//操作数据前需使用get方法阻塞至获取完真实数据，这里get方法返回的是写出的字节数</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> count <span class="op">=</span> future<span class="op">.</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;send&quot;</span> <span class="op">+</span> count <span class="op">+</span> <span class="st">&quot;bytes&quot;</span><span class="op">);</span></span></code></pre></div>
<p>服务器端：</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> AsynchronousServerSocketChannel channel <span class="op">=</span> AsynchronousServerSocketChannel</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">open</span><span class="op">()</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">bind</span><span class="op">(</span><span class="kw">new</span> <span class="bu">InetSocketAddress</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span><span class="dv">8080</span><span class="op">));</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>channel<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span> <span class="kw">new</span> CompletionHandler<span class="op">&lt;</span>AsynchronousSocketChannel<span class="op">,</span> <span class="bu">Void</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">completed</span><span class="op">(</span><span class="dt">final</span> AsynchronousSocketChannel client<span class="op">,</span> <span class="bu">Void</span> attachment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">accept</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span> <span class="kw">this</span><span class="op">);</span><span class="co">//我们没有使用while循环不断的accept，而是当接收到一个请求后，再准备下一次accept，因为这里的accept是异步的，不会阻塞线程</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ByteBuffer</span> buffer <span class="op">=</span> <span class="bu">ByteBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        client<span class="op">.</span><span class="fu">read</span><span class="op">(</span>buffer<span class="op">,</span> buffer<span class="op">,</span> <span class="kw">new</span> CompletionHandler<span class="op">&lt;</span><span class="bu">Integer</span><span class="op">,</span> <span class="bu">ByteBuffer</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">completed</span><span class="op">(</span><span class="bu">Integer</span> result_num<span class="op">,</span> <span class="bu">ByteBuffer</span> attachment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">//attachment就是客户端发过来的数据</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>                <span class="co">//Buffer需要手动重置position</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>                attachment<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>                <span class="bu">CharBuffer</span> charBuffer <span class="op">=</span> <span class="bu">CharBuffer</span><span class="op">.</span><span class="fu">allocate</span><span class="op">(</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>                <span class="bu">CharsetDecoder</span> decoder <span class="op">=</span> <span class="bu">Charset</span><span class="op">.</span><span class="fu">defaultCharset</span><span class="op">().</span><span class="fu">newDecoder</span><span class="op">();</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>                decoder<span class="op">.</span><span class="fu">decode</span><span class="op">(</span>attachment<span class="op">,</span>charBuffer<span class="op">,</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>                charBuffer<span class="op">.</span><span class="fu">flip</span><span class="op">();</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> data <span class="op">=</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>charBuffer<span class="op">.</span><span class="fu">array</span><span class="op">(),</span><span class="dv">0</span><span class="op">,</span> charBuffer<span class="op">.</span><span class="fu">limit</span><span class="op">());</span></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;read data:&quot;</span> <span class="op">+</span> data<span class="op">);</span></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span><span class="op">{</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>                    client<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span><span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">){}</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">failed</span><span class="op">(</span><span class="bu">Throwable</span> exc<span class="op">,</span> <span class="bu">ByteBuffer</span> attachment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;read error&quot;</span><span class="op">);</span></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">failed</span><span class="op">(</span><span class="bu">Throwable</span> exc<span class="op">,</span> <span class="bu">Void</span> attachment<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;accept error&quot;</span><span class="op">);</span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="co">//accept不会阻塞线程，想要让服务器不关闭，必须一直阻塞进程</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="bu">Integer</span><span class="op">.</span><span class="fu">MAX_VALUE</span><span class="op">);</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这样<code>selector</code>就由系统帮我们完成，我们只需要处理客户端准备好了的数据即可</p>
<p>但是这样会有一个问题，当我们进行业务升级，需要暂停服务器，进行文件的替换，如果强制结束服务器进程，会导致有的业务没有处理完成，这时就需要使用<code>ShutdownHook</code>来平滑退出</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Runtime</span><span class="op">.</span><span class="fu">getRuntime</span><span class="op">().</span><span class="fu">addShutdownHook</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(){</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//暂停接收请求</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//阻塞至当前业务处理完成</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>使用<code>kill pid</code>、<code>System.exit()</code>、<code>Ctrl+C</code>、正常关机、程序正常退出都会调用<code>ShutdownHook</code>，但是如果使用<code>kill -9 pid</code>强制杀死进程不会调用<code>ShutdownHook</code></p>
<h2 id="反射和内省">23.反射和内省</h2>
<h3 id="classloader">ClassLoader</h3>
<p>Java中有三个类加载器</p>
<ul>
<li>Bootstrap ClassLoader:
最顶层的加载类，由C++编写，主要加载核心类库，如%JRE_HOME%.jar、resources.jar等。我们可以通过启动jvm时指定<code>-Xbootclasspath</code>和路径来改变<code>Bootstrap ClassLoader</code>的加载目录，被指定的文件追加到默认的bootstrap路径中</li>
<li>Extention ClassLoader:
扩展的类加载器，加载目录%JRE_HOME%。还可以加载<code>-D java.ext.dirs</code>选项指定的目录</li>
<li>Appclass Loader:
也称为<code>SystemAppClass</code>，负责加载当前应用的classpath的所有类</li>
</ul>
<p>每个类加载器都有一个父加载器，直至最顶层的类加载器：</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> classLoader1 <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getClassLoader</span><span class="op">();</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>classLoader1<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取父加载器</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> classLoader2 <span class="op">=</span> classLoader1<span class="op">.</span><span class="fu">getParent</span><span class="op">();</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>classLoader2<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">//返回null，最顶层的类加载器不可见，其实是Bootstrap ClassLoader</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ClassLoader</span> classLoader3 <span class="op">=</span> classLoader2<span class="op">.</span><span class="fu">getParent</span><span class="op">();</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//System.out.println(classLoader3.toString());//java.lang.NullPointerException</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>jdk.internal.loader.ClassLoaders$AppClassLoader@5a2e4553
jdk.internal.loader.ClassLoaders$PlatformClassLoader@224aed64</code></pre>
<p><strong>双亲委托</strong></p>
<p>一个类加载器查找class和resource时，是通过“委托模式”进行的，它首先判断这个class是不是已经加载成功，如果没有的话它并不是自己进行查找，而是先通过父加载器，然后递归下去，直到<code>Bootstrap ClassLoader</code>，如果<code>Bootstrap classloader</code>找到了，直接返回，如果没有找到，则一级一级返回，最后由自身去查找这些对象</p>
<p>自定义类加载器（继承<code>ClassLoader</code>，重写<code>findClass</code>获取class文件的字节码，然后使用<code>defineClass</code>根据字节码创建class）：</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> DiskClassLoader <span class="kw">extends</span> <span class="bu">ClassLoader</span> <span class="op">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> mLibPath<span class="op">;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">DiskClassLoader</span><span class="op">(</span><span class="bu">String</span> path<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        mLibPath <span class="op">=</span> path<span class="op">;</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">findClass</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="kw">throws</span> <span class="bu">ClassNotFoundException</span> <span class="op">{</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> fileName <span class="op">=</span> <span class="fu">getFileName</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>mLibPath<span class="op">,</span>fileName<span class="op">);</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">FileInputStream</span> is <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileInputStream</span><span class="op">(</span>file<span class="op">);</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">ByteArrayOutputStream</span> bos <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteArrayOutputStream</span><span class="op">();</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">((</span>len <span class="op">=</span> is<span class="op">.</span><span class="fu">read</span><span class="op">())</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>                    bos<span class="op">.</span><span class="fu">write</span><span class="op">(</span>len<span class="op">);</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> data <span class="op">=</span> bos<span class="op">.</span><span class="fu">toByteArray</span><span class="op">();</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>            is<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>            bos<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">defineClass</span><span class="op">(</span>name<span class="op">,</span>data<span class="op">,</span><span class="dv">0</span><span class="op">,</span>data<span class="op">.</span><span class="fu">length</span><span class="op">);</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">super</span><span class="op">.</span><span class="fu">findClass</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">//获取要加载的class文件名</span></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">getFileName</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> index <span class="op">=</span> name<span class="op">.</span><span class="fu">lastIndexOf</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">);</span></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>index <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">){</span> </span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> name<span class="op">+</span><span class="st">&quot;.class&quot;</span><span class="op">;</span></span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span><span class="cf">else</span><span class="op">{</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> name<span class="op">.</span><span class="fu">substring</span><span class="op">(</span>index<span class="op">+</span><span class="dv">1</span><span class="op">)+</span><span class="st">&quot;.class&quot;</span><span class="op">;</span></span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>通过自定义类加载器，可以把加密的class文件解析出来</p>
<h3 id="反射">反射</h3>
<p>先定义这样一个类</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="fu">Test</span><span class="op">(){</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Test</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name<span class="op">;</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setName</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">reset</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">showInfo</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;name = &quot;</span> <span class="op">+</span> name<span class="op">);</span></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">print</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;name = &quot;</span> <span class="op">+</span> name<span class="op">);</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Test{&quot;</span> <span class="op">+</span></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;name=&#39;&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="op">+</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>                <span class="ch">&#39;}&#39;</span><span class="op">;</span></span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="获取调用方法">获取、调用方法</h4>
<div class="sourceCode" id="cb97"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取所有public方法，包括父类的public方法</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span><span class="op">[]</span> methods1 <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getMethods</span><span class="op">();</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Method</span> m <span class="op">:</span> methods1<span class="op">)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>m<span class="op">);</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="co">//获取该类自己声明的方法，不受访问控制符影响，不包括父类的方法</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span><span class="op">[]</span> methods2 <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredMethods</span><span class="op">();</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Method</span> m <span class="op">:</span> methods2<span class="op">)</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>m<span class="op">);</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>Test testObj <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="co">//这里getMethod和getDeclaredMethod的区别和上面是一样的</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co">//根据名字获取并执行public方法</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span> showInfo <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredMethod</span><span class="op">(</span><span class="st">&quot;showInfo&quot;</span><span class="op">);</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>showInfo<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>testObj<span class="op">);</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">//根据名字获取private方法，执行前需设置访问权限</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span> reset <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredMethod</span><span class="op">(</span><span class="st">&quot;reset&quot;</span><span class="op">);</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>reset<span class="op">.</span><span class="fu">setAccessible</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>reset<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>testObj<span class="op">);</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>testObj<span class="op">);</span></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a><span class="co">//同样有int.class、double.class、Void.class等</span></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a><span class="co">//调用静态方法把obj设为null即可</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span> print <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getMethod</span><span class="op">(</span><span class="st">&quot;print&quot;</span><span class="op">,</span><span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>print<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span><span class="kw">null</span><span class="op">,</span><span class="st">&quot;小红&quot;</span><span class="op">);</span></span></code></pre></div>
<h4 id="获取使用构造器">获取、使用构造器</h4>
<div class="sourceCode" id="cb98"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取所有的public构造器</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Constructor</span><span class="op">&lt;?&gt;[]</span> constructors1 <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getConstructors</span><span class="op">();</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Constructor</span> c <span class="op">:</span> constructors1<span class="op">)</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>c<span class="op">);</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">//获取所有的构造器，不受访问控制符影响</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Constructor</span><span class="op">&lt;?&gt;[]</span> constructors2 <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredConstructors</span><span class="op">();</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Constructor</span> c <span class="op">:</span> constructors2<span class="op">)</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>c<span class="op">);</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">//使用非public的构造器newInstance时，必须设置访问权限</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="bu">Constructor</span><span class="op">&lt;</span>Test<span class="op">&gt;</span> constructor <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredConstructor</span><span class="op">();</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a>constructor<span class="op">.</span><span class="fu">setAccessible</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>constructor<span class="op">.</span><span class="fu">newInstance</span><span class="op">());</span></span></code></pre></div>
<h4 id="获取设置成员变量">获取、设置成员变量</h4>
<div class="sourceCode" id="cb99"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">//下面方法和之前的getMethod、getDeclaredMethod类似</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getFields</span><span class="op">();</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredFields</span><span class="op">();</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>Test testObj <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="co">//操作非public变量的时候也要使用setAccessible设置访问权限</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Field</span> field <span class="op">=</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getField</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>field<span class="op">.</span><span class="fu">get</span><span class="op">(</span>testObj<span class="op">));</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>field<span class="op">.</span><span class="fu">set</span><span class="op">(</span>testObj<span class="op">,</span><span class="st">&quot;小红&quot;</span><span class="op">);</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>testObj<span class="op">);</span></span></code></pre></div>
<h4 id="获取父类泛型">获取父类泛型</h4>
<div class="sourceCode" id="cb100"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Father<span class="op">&lt;</span>T<span class="op">&gt;{}</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Child <span class="kw">extends</span> Father<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;{}</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestReflact <span class="op">{</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>        Child child <span class="op">=</span> <span class="kw">new</span> <span class="fu">Child</span><span class="op">();</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ParameterizedType</span> type <span class="op">=</span> <span class="op">(</span><span class="bu">ParameterizedType</span><span class="op">)</span> child<span class="op">.</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">getGenericSuperclass</span><span class="op">();</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>type<span class="op">.</span><span class="fu">getActualTypeArguments</span><span class="op">()[</span><span class="dv">0</span><span class="op">].</span><span class="fu">getTypeName</span><span class="op">());</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时输出<code>java.lang.String</code></p>
<p>如果是</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Father<span class="op">&lt;</span>T<span class="op">&gt;{}</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Child<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="kw">extends</span> Father<span class="op">&lt;</span>T<span class="op">&gt;{}</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestReflact <span class="op">{</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>        Child<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> child <span class="op">=</span> <span class="kw">new</span> Child<span class="op">&lt;&gt;();</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ParameterizedType</span> type <span class="op">=</span> <span class="op">(</span><span class="bu">ParameterizedType</span><span class="op">)</span> child<span class="op">.</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">getGenericSuperclass</span><span class="op">();</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>type<span class="op">.</span><span class="fu">getActualTypeArguments</span><span class="op">()[</span><span class="dv">0</span><span class="op">].</span><span class="fu">getTypeName</span><span class="op">());</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>会输出<code>T</code>，因为运行时设置的泛型会被擦除，是无法获取的</p>
<h3 id="内省">内省</h3>
<p>内省是针对JavaBean的，只有类中有getXXX和setXXX，无论是否有XXX这个属性，都能获取/设置</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>Test test <span class="op">=</span> <span class="kw">new</span> <span class="fu">Test</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="co">//操作单个属性</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="bu">PropertyDescriptor</span> descriptor <span class="op">=</span> <span class="kw">new</span> <span class="bu">PropertyDescriptor</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> Test<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span> getName <span class="op">=</span> descriptor<span class="op">.</span><span class="fu">getReadMethod</span><span class="op">();</span><span class="co">//获取属性的getter方法</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> name <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> getName<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>test<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Method</span> setName <span class="op">=</span> descriptor<span class="op">.</span><span class="fu">getWriteMethod</span><span class="op">();</span><span class="co">//获取属性的setter方法</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>setName<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>test<span class="op">,</span> <span class="st">&quot;小红&quot;</span><span class="op">);</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>test<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="co">//操作所有属性</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="bu">BeanInfo</span> info <span class="op">=</span> <span class="bu">Introspector</span><span class="op">.</span><span class="fu">getBeanInfo</span><span class="op">(</span>Test<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="bu">PropertyDescriptor</span><span class="op">[]</span> pds <span class="op">=</span> info<span class="op">.</span><span class="fu">getPropertyDescriptors</span><span class="op">();</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">PropertyDescriptor</span> p <span class="op">:</span> pds<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>p<span class="op">.</span><span class="fu">getReadMethod</span><span class="op">().</span><span class="fu">invoke</span><span class="op">(</span>test<span class="op">,</span> <span class="kw">null</span><span class="op">));</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="动态代理">动态代理</h3>
<p>通过动态代理，可以实现对函数的Hook</p>
<p>JAVA通过的动态代理是基于接口的，要求要代理的类必须实现一个接口；我们也可以通过CGlib可以使用基于子类的动态代理</p>
<p>定义一个接口和一个实现该接口的类</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> MyInterface <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">doSomething</span><span class="op">();</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">somethingElse</span><span class="op">(</span><span class="bu">String</span> arg<span class="op">);</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass <span class="kw">implements</span> MyInterface <span class="op">{</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doSomething</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;doSomething&quot;</span><span class="op">);</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">somethingElse</span><span class="op">(</span><span class="bu">String</span> arg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;somethingElse&quot;</span><span class="op">);</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>定义一个实现了<code>InvocationHandler</code>接口的代理类</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDynamicProxyHandler <span class="kw">implements</span> <span class="bu">InvocationHandler</span> <span class="op">{</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> proxyed<span class="op">;</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyDynamicProxyHandler</span><span class="op">(</span><span class="bu">Object</span> proxyed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">proxyed</span> <span class="op">=</span> proxyed<span class="op">;</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">invoke</span><span class="op">(</span><span class="bu">Object</span> proxy<span class="op">,</span> <span class="bu">Method</span> method<span class="op">,</span> <span class="bu">Object</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IllegalAccessException</span><span class="op">,</span> <span class="bu">IllegalArgumentException</span><span class="op">,</span> <span class="bu">InvocationTargetException</span> <span class="op">{</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;代理工作了.&quot;</span><span class="op">);</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> method<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>proxyed<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>测试</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestReflact <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>        MyClass obj <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyClass</span><span class="op">();</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>        MyInterface proxy <span class="op">=</span> <span class="op">(</span>MyInterface<span class="op">)</span> <span class="bu">Proxy</span><span class="op">.</span><span class="fu">newProxyInstance</span><span class="op">(</span>MyInterface<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getClassLoader</span><span class="op">(),</span> <span class="kw">new</span> <span class="bu">Class</span><span class="op">[]{</span>MyInterface<span class="op">.</span><span class="fu">class</span><span class="op">},</span> <span class="kw">new</span> <span class="fu">MyDynamicProxyHandler</span><span class="op">(</span>obj<span class="op">));</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>        proxy<span class="op">.</span><span class="fu">doSomething</span><span class="op">();</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>        proxy<span class="op">.</span><span class="fu">somethingElse</span><span class="op">(</span><span class="st">&quot;aaa&quot;</span><span class="op">);</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>代理工作了.
doSomething
代理工作了.
somethingElse</code></pre>
<h2 id="注解">24.注解</h2>
<h3 id="注解annotation">注解(annotation)</h3>
<p>基本注解(annotation)有：</p>
<ul>
<li><code>@Override</code>:限定重写父类方法</li>
<li><code>@Deprecated</code>:示某个程序元素（类、方法等）已过时</li>
<li><code>@SuppressWarnings</code>:忽略编译器警告，且可以指定忽略的类型，常用的有<code>@SuppressWarnings({&quot;unchecked&quot;,&quot;unused&quot;})</code></li>
<li><code>@SafeVarargs</code>:忽略堆污染警告(JDK7)</li>
<li><code>@FunctionalIterface</code>:指定某个接口必须是函数式接口(JDK8)（如果接口中只有一个抽象方法（可以包含多个默认方法或多个static方法），该接口称为函数式接口）</li>
</ul>
<h3 id="元注解meta-annotation">元注解(meta-annotation)</h3>
<p>元注解(meta-annotation)是用来注释注解用的注解，有：</p>
<ul>
<li><code>@Retention</code>:指定注解可以保留多长时间（生命周期）</li>
<li><code>@Target</code>:指定该注解可用于修饰哪些程序元素</li>
<li><code>@Documented</code>:使用javadoc后保留对该注解的说明，需Retention为RetentionPolicy.RUNTIME</li>
<li><code>@Inherited</code>:指定注解具有继承性，使用该注解的类的子类默认有该注解</li>
<li><code>@Repeatable</code>(JDK8):允许把同一个类型的注解使用多次</li>
</ul>
<h3 id="自定义注解">自定义注解</h3>
<p>自定义注解使用<code>@interface</code>，它的用法和<code>class</code>、<code>enum</code>是一样的，它声明的是一个注解类型：</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Target</span><span class="op">(</span><span class="bu">ElementType</span><span class="op">.</span><span class="fu">TYPE</span><span class="op">)</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Retention</span><span class="op">(</span><span class="bu">RetentionPolicy</span><span class="op">.</span><span class="fu">RUNTIME</span><span class="op">)</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="at">@interface</span> <span class="bu">Reference</span><span class="op">{</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">next</span><span class="op">()</span> <span class="kw">default</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="at">@Target</span><span class="op">({</span><span class="bu">ElementType</span><span class="op">.</span><span class="fu">TYPE</span><span class="op">,</span><span class="bu">ElementType</span><span class="op">.</span><span class="fu">FIELD</span><span class="op">})</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="at">@Retention</span><span class="op">(</span><span class="bu">RetentionPolicy</span><span class="op">.</span><span class="fu">RUNTIME</span><span class="op">)</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="at">@interface</span> AnnotationElementDemo <span class="op">{</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//枚举类型</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> Status <span class="op">{</span>FIXED<span class="op">,</span>NORMAL<span class="op">};</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//声明枚举</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    Status <span class="fu">status</span><span class="op">()</span> <span class="kw">default</span> Status<span class="op">.</span><span class="fu">FIXED</span><span class="op">;</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">//布尔类型</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">showSupport</span><span class="op">()</span> <span class="kw">default</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//String类型</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> <span class="fu">name</span><span class="op">()</span> <span class="kw">default</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">//class类型</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Class</span><span class="op">&lt;?&gt;</span> <span class="fu">testCase</span><span class="op">()</span> <span class="kw">default</span> <span class="bu">Void</span><span class="op">.</span><span class="fu">class</span><span class="op">;</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">//注解嵌套</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Reference</span> <span class="fu">reference</span><span class="op">()</span> <span class="kw">default</span> <span class="at">@Reference</span><span class="op">(</span>next<span class="op">=</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">//long数组类型</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span><span class="op">[]</span> <span class="fu">value</span><span class="op">();</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>注解只能声明包含哪些变量及变量的可选值，但注解本身是没有作用的，如果想让注解实现特定功能，需要使用反射来解析注解</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AnnotationUtils<span class="op">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">parse</span><span class="op">(</span><span class="bu">Class</span><span class="op">&lt;?&gt;</span> clazz<span class="op">){</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Field</span><span class="op">[]</span> fields <span class="op">=</span> clazz<span class="op">.</span><span class="fu">getDeclaredFields</span><span class="op">();</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="bu">Field</span> field <span class="op">:</span>fields<span class="op">){</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>field<span class="op">.</span><span class="fu">isAnnotationPresent</span><span class="op">(</span>AnnotationElementDemo<span class="op">.</span><span class="fu">class</span><span class="op">)){</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>                AnnotationElementDemo demo <span class="op">=</span> field<span class="op">.</span><span class="fu">getAnnotation</span><span class="op">(</span>AnnotationElementDemo<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>demo<span class="op">.</span><span class="fu">status</span><span class="op">()+</span><span class="st">&quot;--&quot;</span><span class="op">+</span>demo<span class="op">.</span><span class="fu">name</span><span class="op">()+</span><span class="st">&quot;--&quot;</span><span class="op">+</span>demo<span class="op">.</span><span class="fu">reference</span><span class="op">());</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="dt">long</span> l <span class="op">:</span>demo<span class="op">.</span><span class="fu">value</span><span class="op">())</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>l<span class="op">);</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@AnnotationElementDemo</span><span class="op">(</span>status <span class="op">=</span> AnnotationElementDemo<span class="op">.</span><span class="fu">Status</span><span class="op">.</span><span class="fu">NORMAL</span><span class="op">,</span>name <span class="op">=</span> <span class="st">&quot;User1&quot;</span><span class="op">,</span> value <span class="op">=</span> <span class="op">{</span><span class="dv">1l</span><span class="op">,</span><span class="dv">2L</span><span class="op">})</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        AnnotationUtils<span class="op">.</span><span class="fu">parse</span><span class="op">(</span>MyClass<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>注解是不支持继承的，但注解在编译后，编译器会自动继承<code>java.lang.annotation.Annotation</code>接口</p>
<h2 id="jdk789语法的新特性">25.JDK7、8、9语法的新特性：</h2>
<h3 id="数字可加下划线jdk7">数字可加下划线(JDK7)</h3>
<p>当数字过长时，可以加下划线以提高阅读性，但只能在数字之间添加下划线</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> num1 <span class="op">=</span> <span class="dv">1_000_000_000</span><span class="op">;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> num2 <span class="op">=</span> <span class="bn">0x53_42</span>；<span class="co">//十六进制数</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> num3 <span class="op">=</span> <span class="fl">1.414_213</span><span class="op">;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> num4 <span class="op">=</span> <span class="dv">999_999_999L</span><span class="op">;</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> num5 <span class="op">=</span> <span class="bn">0b1001_1001</span><span class="op">;</span><span class="co">//二进制数</span></span></code></pre></div>
<h3 id="switch强化jdk7">switch强化(JDK7)</h3>
<p>在以前，switch只支持整形及其包装类型（或byte、short、char等可以隐式转换成int的类型）或枚举，JDK7以后switch中可以使用字串</p>
<h3 id="泛型类型推断jdk7">泛型类型推断(JDK7)</h3>
<p>在JDK7以前，创建一个带泛型的变量，两边的泛型都要写全</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> myMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;();</span></span></code></pre></div>
<p>JDK7以后，可以省略右边的泛型，但是如果是匿名内部类，则不能省略</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;&gt;</span> myMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co">//不能省略，因为是创建匿名内部类</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;(){};</span></span></code></pre></div>
<p>JDK9以后，匿名内部类也可以省略右边的泛型了</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(){};</span></span></code></pre></div>
<h3 id="try-with-resourcesjdk7-jdk9">try-with-resources(JDK7 &amp;
JDK9)</h3>
<p>只要使用的类实现了<code>AutoCloseable</code>接口就可以在<code>try</code>语句块退出的时候自动调用<code>close()</code>方法关闭流资源，而不用在<code>finally</code>里面调用<code>close()</code></p>
<div class="sourceCode" id="cb114"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Demo <span class="op">{</span>    </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//需要自动关闭的资源要在try后的括号中声明，多个资源用分号隔开</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span><span class="op">(</span><span class="bu">Resource</span> res <span class="op">=</span> <span class="kw">new</span> <span class="bu">Resource</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>            res<span class="op">.</span><span class="fu">doSome</span><span class="op">();</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>            ex<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//或者</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Resource</span> res <span class="op">=</span> <span class="kw">new</span> <span class="bu">Resource</span><span class="op">();</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span><span class="op">(</span><span class="bu">Resource</span> res1 <span class="op">=</span> res<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a>            res1<span class="op">.</span><span class="fu">doSome</span><span class="op">();</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>            ex<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">//多个需要自动关闭的资源</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span><span class="op">(</span><span class="bu">Resource</span> res1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Resource</span><span class="op">();</span> <span class="bu">Resource</span> res2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Resource</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>            res1<span class="op">.</span><span class="fu">doSome</span><span class="op">();</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>            res2<span class="op">.</span><span class="fu">doSome</span><span class="op">();</span></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>            ex<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="bu">Resource</span> <span class="kw">implements</span> AutoCloseable <span class="op">{</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">doSome</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;do something&quot;</span><span class="op">);</span></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;resource is closed&quot;</span><span class="op">);</span></span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在JDK9中，如果变量是final或等效于final
，可以不在try中声明，可以直接使用</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="bu">String</span> <span class="fu">readData</span><span class="op">(</span><span class="bu">String</span> message<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Reader</span> inputString <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringReader</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BufferedReader</span> br <span class="op">=</span> <span class="kw">new</span> <span class="bu">BufferedReader</span><span class="op">(</span>inputString<span class="op">);</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">(</span>br<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> br<span class="op">.</span><span class="fu">readLine</span><span class="op">();</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="捕获多个exceptionjdk7">捕获多个Exception(JDK7)</h3>
<p><code>catch (InterruptedException | IOException e)</code>，多个异常用<code>|</code>隔开即可，不用写多个catch，且此时e是final的</p>
<h3 id="读写文件简化jdk8">读写文件简化(JDK8)</h3>
<p>可以直接通过Files实现文件读写</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> lines <span class="op">=</span> Files<span class="op">.</span><span class="fu">readAllLines</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;a.txt&quot;</span><span class="op">));</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>Files<span class="op">.</span><span class="fu">write</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;b.txt&quot;</span><span class="op">),</span> <span class="st">&quot;Hello JDK7!&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span></code></pre></div>
<h3 id="streamjdk8">Stream(JDK8)</h3>
<h3 id="null检查jdk8">null检查(JDK8)</h3>
<p>Object添加了<code>nonNull</code>和<code>isNull</code>两个静态方法，一般配合<code>Stream</code>和方法引用使用</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取一个流的所有不为null的对象</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>Stream<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="st">&quot;d&quot;</span><span class="op">)</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>Objects<span class="op">::</span>nonNull<span class="op">)</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forEach</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">::</span>println<span class="op">);</span></span></code></pre></div>
<h3 id="optional类jdk8">Optional类(JDK8)</h3>
<div class="sourceCode" id="cb118"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name<span class="op">;</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserProxy<span class="op">{</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co">    public static String getUserName(User user){</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a><span class="co">        return user.getName();//这样写可能会有空指针异常</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="co">    }</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">getUserName</span><span class="op">(</span>User user<span class="op">){</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>user <span class="op">!=</span> <span class="kw">null</span><span class="op">){</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> user<span class="op">.</span><span class="fu">getName</span><span class="op">();</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">getUserNameByOptional</span><span class="op">(</span>User user<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">//和上面代码等价，Optional可以省去if else的判断</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>        Optional<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> userName <span class="op">=</span> Optional<span class="op">.</span><span class="fu">ofNullable</span><span class="op">(</span>user<span class="op">).</span><span class="fu">map</span><span class="op">(</span>User<span class="op">::</span>getName<span class="op">);</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userName<span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="lambda-表达式jdk8">Lambda 表达式(JDK8)</h3>
<p>允许把函数作为一个方法的参数（且该参数为函数式接口），如<code>Collections.sort(list, (s1, s2) -&gt; {return s1.compareTo(s2);})</code>，不用再实现Comparetor而可以直接用Lambda指定排序方式</p>
<ul>
<li>如果参数只有一个且省略参数类型时，小括号可以省略（没有参数或注明参数类型时需保留小括号）</li>
<li>如果函数只有一个语句时，大括号可以省略，且无需写return（如果不省略大括号，则也不能省略return）</li>
<li>参数的类型可以省略，此时编译器会根据上下文自动判断参数类型</li>
<li>如果主体只有一个表达式，return关键字可以省略，此时编译器会自动返回该表达式的值</li>
<li>变量作用域：不能在Lambda表达式内部修改定义在域外的局部变量，且只能引用标记了final的外层局部变量，如果外层局部变量没有声明为final，在Lambda表达式内部引用不会报错，但如果后面的代码修改了该变量的值，则会报错（相当于引用过的变量有隐式的final属性）；JAVA无法实现闭包，但可以使用全局变量（类的成员变量）来达到闭包的效果</li>
<li>在Lambda表达式当中不允许声明一个与局部变量同名的参数或者局部变量</li>
<li>Lambda表达式中的this指的是Lambda表达式所在的类，而非Lambda表达式所实现的函数式接口</li>
<li>如果一个接口是函数式接口，则可用Lambda表达式替代该接口的实现</li>
<li>如果Lambda表达式对应的函数式接口有声明抛出异常，则要么在Lambda表达式里try-catch，要么在调用包含该Lambda表达式的方法处try-catch</li>
</ul>
<h3 id="方法引用jdk8">方法引用(JDK8)</h3>
<p>方法引用是Lambda表达式的一种简化，当Lambda表达式的参数原封不动地传入Lambda表达式的方法体（只有一个语句时）中调用的函数时，可用方法引用替代，如</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span><span class="op">[]</span> in1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Integer</span><span class="op">[](){</span><span class="dv">2</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">5</span><span class="op">};</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Arrays</span><span class="op">.</span><span class="fu">sort</span><span class="op">(</span>in1<span class="op">,(</span>x<span class="op">,</span>y<span class="op">)-&gt;</span><span class="bu">Integer</span><span class="op">.</span><span class="fu">compare</span><span class="op">(</span>x<span class="op">,</span>y<span class="op">));</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">toString</span><span class="op">(</span>in1<span class="op">));</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co">//等价于</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Integer</span><span class="op">[]</span> in2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">Integer</span><span class="op">[](){</span><span class="dv">2</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">5</span><span class="op">};</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Arrays</span><span class="op">.</span><span class="fu">sort</span><span class="op">(</span>in2<span class="op">,</span><span class="bu">Integer</span><span class="op">::</span>compare<span class="op">);</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">toString</span><span class="op">(</span>in2<span class="op">));</span></span></code></pre></div>
<p>方法引用有：</p>
<ul>
<li>构造器引用：<code>Class&lt;T&gt;::new</code>；要求类有一个无参的构造器，且对应的函数式接口无参并且返回一个对象</li>
</ul>
<div class="sourceCode" id="cb120"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> MyInterface<span class="op">&lt;</span> T <span class="kw">extends</span> <span class="bu">List</span><span class="op">&lt;?&gt;</span> <span class="op">&gt;{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    T <span class="fu">getInstance</span><span class="op">();</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass<span class="op">{</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">getList</span><span class="op">(</span>MyInterface<span class="op">&lt;</span> <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="kw">interface</span><span class="op">,</span>T<span class="kw">...</span> array<span class="op">){</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">interface</span><span class="op">.</span><span class="fu">getInstance</span><span class="op">();</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span>T t <span class="op">:</span> array<span class="op">)</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span>t<span class="op">);</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> list<span class="op">;</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> list <span class="op">=</span> <span class="fu">getList</span><span class="op">(</span><span class="bu">LinkedList</span><span class="op">::</span><span class="kw">new</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">//LinkedList::new相当于()-&gt;{return new LinkedList();}</span></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>        list<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">::</span>println<span class="op">);</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li>类的静态方法引用：<code>Class::static_method</code>，如<code>list.forEach(System.out::println);</code></li>
<li>类的非静态方法引用:<code>Class::method</code>，如<code>list.forEach(l::toString);</code></li>
<li>对象的非静态方法引用：<code>instance::method</code>；方法引用中的this和Lambda表达式一样，表示的是所在类的对象，而非实现的函数式接口</li>
</ul>
<h3 id="接口的默认方法jdk8私有方法jdk9">接口的默认方法(JDK8)、私有方法(JDK9)</h3>
<p>接口里可以有实现了的方法，且该方法用default或static修饰</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> Person <span class="op">{</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">default</span> <span class="dt">void</span> <span class="fu">print</span><span class="op">(){</span><span class="co">//default默认方法</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>      <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;person&quot;</span><span class="op">);</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>   <span class="dt">static</span> <span class="dt">void</span> <span class="fu">work</span><span class="op">(){</span><span class="co">//静态方法</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;work&quot;</span><span class="op">);</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>   <span class="dt">void</span> <span class="fu">walk</span><span class="op">();</span><span class="co">//抽象函数，当接口只有一个抽象方法（除Object中已声明的方法外）时，该接口称为函数式接口</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>   <span class="dt">boolean</span> <span class="fu">equals</span><span class="op">(</span><span class="bu">Object</span> o<span class="op">);</span><span class="co">//如果有与Object中相同的方法，且为抽象方法，该接口仍是函数式接口，因为这样写没有意义，默认方法无法重写Object的方法</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li><p>如果子类继承的两个接口中有重名的默认方法，则子类必须实现冲突的方法(直接指定调用哪个父接口的方法：<code>接口名.super.方法名()</code>)</p></li>
<li><p>如果继承的父类的方法和接口的默认方法有重名，则调用父类的方法</p></li>
<li><p>接口的默认方法无法重写Object中的方法，因为所有类都继承自Object，所以调的也是Object中的方法，而非接口重写的Object的方法</p></li>
</ul>
<p>在JDK9中，接口中还可以有<code>private</code>方法，以解决接口中的代码复用问题</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> MyInterface<span class="op">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">encode</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//...</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">default</span> <span class="dt">byte</span><span class="op">[]</span> <span class="fu">decode</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> <span class="fu">encode</span><span class="op">(</span>data<span class="op">);</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>data<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>            data<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> data<span class="op">[</span>i<span class="op">]</span> <span class="op">^</span> <span class="ch">&#39;a&#39;</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">default</span> <span class="dt">boolean</span> <span class="fu">check</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span><span class="fu">decode</span><span class="op">(</span>data<span class="op">)==</span><span class="st">&quot;pwd&quot;</span><span class="op">)</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="modulejdk9">Module(JDK9)</h3>
<p>现在有如下目录结构</p>
<pre><code>|-module1
    |-src
        |-com.test1
            User.java
|-module2
    |-src
        |-com.test2
            Main.java</code></pre>
<p>如果module2想使用module1中的User类，在JDK9中可以通过在<code>module</code>的<code>src</code>目录中添加<code>module-info.java</code>来指定导出和导入的<code>module</code></p>
<pre><code>|-module1
    |-src
        |-com.test1
            User.java
        module-info.java
|-module2
    |-src
        |-com.test2
            Main.java
        module-info.java</code></pre>
<p>module1中的<code>module-info.java</code>：</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>module module1 <span class="op">{</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    exports com<span class="op">.</span><span class="fu">test1</span><span class="op">;</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>module2中的<code>module-info.java</code>：</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>module module2 <span class="op">{</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    requires module1<span class="op">;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="httpclientjdk9">HttpClient(JDK9)</h3>
<p><code>HttpClient</code>支持<code>HTTP1.1</code>及<code>HTTP/2</code>，在JDK9中，是以孵化器模块交付的</p>
<p>使用前需导入模块</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>module mymodule <span class="op">{</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    requires jdk<span class="op">.</span><span class="fu">incubator</span><span class="op">.</span><span class="fu">httpclient</span><span class="op">;</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>创建<code>HttpClient</code>：</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>HttpClient client <span class="op">=</span> HttpClient<span class="op">.</span><span class="fu">newHttpClient</span><span class="op">();</span></span></code></pre></div>
<p>或者使用HTTPS：</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Authenticator</span> authenticator <span class="op">=</span> <span class="kw">new</span> <span class="bu">Authenticator</span><span class="op">()</span> <span class="op">{</span>  <span class="op">};</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>HttpClient client <span class="op">=</span> HttpClient<span class="op">.</span><span class="fu">newBuilder</span><span class="op">()</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">authenticator</span><span class="op">(</span>authenticator<span class="op">)</span><span class="co">//配置authenticator</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">sslContext</span><span class="op">(</span><span class="bu">SSLContext</span><span class="op">.</span><span class="fu">getDefault</span><span class="op">())</span><span class="co">//配置 sslContext</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">sslParameters</span><span class="op">(</span><span class="kw">new</span> <span class="bu">SSLParameters</span><span class="op">())</span><span class="co">//配置 sslParameters</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">proxy</span><span class="op">(</span><span class="bu">ProxySelector</span><span class="op">.</span><span class="fu">getDefault</span><span class="op">())</span><span class="co">//配置 proxy</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">executor</span><span class="op">(</span><span class="bu">Executors</span><span class="op">.</span><span class="fu">newCachedThreadPool</span><span class="op">())</span><span class="co">//配置 executor</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">followRedirects</span><span class="op">(</span>HttpClient<span class="op">.</span><span class="fu">Redirect</span><span class="op">.</span><span class="fu">ALWAYS</span><span class="op">)</span><span class="co">//配置 followRedirects</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">cookieHandler</span><span class="op">(</span><span class="kw">new</span> <span class="bu">CookieManager</span><span class="op">())</span><span class="co">//配置 cookieHandler</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">version</span><span class="op">(</span>HttpClient<span class="op">.</span><span class="fu">Version</span><span class="op">.</span><span class="fu">HTTP_2</span><span class="op">)</span><span class="co">//配置 version</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<p>发送GET请求：</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>HttpResponse<span class="op">&lt;</span>Path<span class="op">&gt;</span> response <span class="op">=</span> client<span class="op">.</span><span class="fu">send</span><span class="op">(</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>        HttpRequest<span class="op">.</span><span class="fu">newBuilder</span><span class="op">(</span><span class="kw">new</span> <span class="bu">URI</span><span class="op">(</span><span class="st">&quot;https://www.baidu.com/img/bd_logo1.png&quot;</span><span class="op">))</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">headers</span><span class="op">(</span><span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;image/png&quot;</span><span class="op">,</span><span class="st">&quot;Accept-Ranges&quot;</span><span class="op">,</span><span class="st">&quot;bytes&quot;</span><span class="op">)</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">GET</span><span class="op">()</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">(),</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>        HttpResponse<span class="op">.</span><span class="fu">BodyHandler</span><span class="op">.</span><span class="fu">asFile</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;./logo.png&quot;</span><span class="op">))</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>response<span class="op">.</span><span class="fu">statusCode</span><span class="op">());</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>response<span class="op">.</span><span class="fu">headers</span><span class="op">());</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>response<span class="op">.</span><span class="fu">body</span><span class="op">());</span></span></code></pre></div>
<p>发送POST请求：</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>HttpResponse<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> response <span class="op">=</span> client<span class="op">.</span><span class="fu">send</span><span class="op">(</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>        HttpRequest<span class="op">.</span><span class="fu">newBuilder</span><span class="op">(</span><span class="kw">new</span> <span class="bu">URI</span><span class="op">(</span><span class="st">&quot;https://www.baidu.com/s&quot;</span><span class="op">))</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">headers</span><span class="op">(</span><span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;text/html&quot;</span><span class="op">,</span> <span class="st">&quot;Connection&quot;</span><span class="op">,</span> <span class="st">&quot;Keep-Alive&quot;</span><span class="op">)</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">POST</span><span class="op">(</span>HttpRequest<span class="op">.</span><span class="fu">BodyPublisher</span><span class="op">.</span><span class="fu">fromString</span><span class="op">(</span><span class="st">&quot;wd=aaa&quot;</span><span class="op">))</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">(),</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>        HttpResponse<span class="op">.</span><span class="fu">BodyHandler</span><span class="op">.</span><span class="fu">asString</span><span class="op">()</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<p>Response也可以使用Lambda表达式创建匿名内部类</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>HttpResponse<span class="op">&lt;</span>Path<span class="op">&gt;</span> response <span class="op">=</span> client<span class="op">.</span><span class="fu">send</span><span class="op">(</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>        HttpRequest<span class="op">.</span><span class="fu">newBuilder</span><span class="op">(</span><span class="kw">new</span> <span class="bu">URI</span><span class="op">(</span><span class="st">&quot;https://www.baidu.com/img/bd_logo1.png2&quot;</span><span class="op">))</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">headers</span><span class="op">(</span><span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;image/png&quot;</span><span class="op">,</span><span class="st">&quot;Accept-Ranges&quot;</span><span class="op">,</span><span class="st">&quot;bytes&quot;</span><span class="op">)</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">GET</span><span class="op">()</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">(),</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>status<span class="op">,</span> headers<span class="op">)</span> <span class="op">-&gt;</span> status <span class="op">==</span> <span class="dv">200</span> <span class="op">?</span> HttpResponse<span class="op">.</span><span class="fu">BodySubscriber</span><span class="op">.</span><span class="fu">asFile</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;./logo.png&quot;</span><span class="op">))</span> <span class="op">:</span> HttpResponse<span class="op">.</span><span class="fu">BodySubscriber</span><span class="op">.</span><span class="fu">discard</span><span class="op">(</span>Paths<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;/NULL&quot;</span><span class="op">))</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<h3 id="varhandlejdk9">VarHandle(JDK9)</h3>
<p>类似反射</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Demo <span class="op">{</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name <span class="op">=</span> <span class="st">&quot;aaa&quot;</span><span class="op">;</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span><span class="op">[]</span> array <span class="op">=</span> <span class="kw">new</span> <span class="dt">int</span><span class="op">[]{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">};</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> str <span class="op">=</span> <span class="st">&quot;Demo{ count=&quot;</span> <span class="op">+</span> count <span class="op">+</span> <span class="st">&quot;, name=&#39;&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;&#39;, array=[ &quot;</span><span class="op">;</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">:</span> array<span class="op">)</span> <span class="op">{</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>            str <span class="op">+=</span> i <span class="op">+</span> <span class="st">&quot; &quot;</span><span class="op">;</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>        str <span class="op">+=</span> <span class="st">&quot;] }&quot;</span><span class="op">;</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> str<span class="op">;</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a>        Demo instance <span class="op">=</span> <span class="kw">new</span> <span class="fu">Demo</span><span class="op">();</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>        VarHandle countHandle <span class="op">=</span> MethodHandles<span class="op">.</span><span class="fu">lookup</span><span class="op">()</span></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">in</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">findVarHandle</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="st">&quot;count&quot;</span><span class="op">,</span> <span class="dt">int</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>        countHandle<span class="op">.</span><span class="fu">set</span><span class="op">(</span>instance<span class="op">,</span> <span class="dv">99</span><span class="op">);</span></span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">//访问private属性</span></span>
<span id="cb133-26"><a href="#cb133-26" aria-hidden="true" tabindex="-1"></a>        VarHandle nameHandle <span class="op">=</span> MethodHandles<span class="op">.</span><span class="fu">privateLookupIn</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">,</span> MethodHandles<span class="op">.</span><span class="fu">lookup</span><span class="op">())</span></span>
<span id="cb133-27"><a href="#cb133-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">findVarHandle</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb133-28"><a href="#cb133-28" aria-hidden="true" tabindex="-1"></a>        nameHandle<span class="op">.</span><span class="fu">set</span><span class="op">(</span>instance<span class="op">,</span> <span class="st">&quot;bbb&quot;</span><span class="op">);</span></span>
<span id="cb133-29"><a href="#cb133-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-30"><a href="#cb133-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">//访问数组</span></span>
<span id="cb133-31"><a href="#cb133-31" aria-hidden="true" tabindex="-1"></a>        VarHandle arrayHandle <span class="op">=</span> MethodHandles<span class="op">.</span><span class="fu">arrayElementVarHandle</span><span class="op">(</span><span class="dt">int</span><span class="op">[].</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb133-32"><a href="#cb133-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">//如果instance.array[0]是1，则改为4</span></span>
<span id="cb133-33"><a href="#cb133-33" aria-hidden="true" tabindex="-1"></a>        arrayHandle<span class="op">.</span><span class="fu">compareAndExchange</span><span class="op">(</span>instance<span class="op">.</span><span class="fu">array</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">);</span></span>
<span id="cb133-34"><a href="#cb133-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb133-35"><a href="#cb133-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb133-36"><a href="#cb133-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-37"><a href="#cb133-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-38"><a href="#cb133-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>不同于反射的是，它可以指定访问变量的方式</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Demo <span class="op">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">int</span> count1 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">volatile</span> <span class="dt">int</span> count2 <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Demo{ count1=&quot;</span> <span class="op">+</span> count1 <span class="op">+</span> <span class="st">&quot;, count2=&quot;</span> <span class="op">+</span> count2 <span class="op">+</span> <span class="ch">&#39;}&#39;</span><span class="op">;</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>        Demo instance <span class="op">=</span> <span class="kw">new</span> <span class="fu">Demo</span><span class="op">();</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>        VarHandle count1Handle <span class="op">=</span> MethodHandles<span class="op">.</span><span class="fu">lookup</span><span class="op">()</span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">in</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">findVarHandle</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="st">&quot;count1&quot;</span><span class="op">,</span> <span class="dt">int</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">//确保在此访问之前不会重新排序后续加载和存储</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> previousValue <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> count1Handle<span class="op">.</span><span class="fu">getAndSetAcquire</span><span class="op">(</span>instance<span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>previousValue<span class="op">);</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">//确保在此访问后不会重新排序先前的加载和存储</span></span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>        previousValue <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> count1Handle<span class="op">.</span><span class="fu">getAndSetRelease</span><span class="op">(</span>instance<span class="op">,</span> <span class="dv">23</span><span class="op">);</span></span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>previousValue<span class="op">);</span></span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">//用于读取volatile修饰的变量</span></span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>        VarHandle count2Handle <span class="op">=</span> MethodHandles<span class="op">.</span><span class="fu">lookup</span><span class="op">()</span></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">in</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">findVarHandle</span><span class="op">(</span>Demo<span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="st">&quot;count2&quot;</span><span class="op">,</span> <span class="dt">int</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a>        count2Handle<span class="op">.</span><span class="fu">getVolatile</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a>        count2Handle<span class="op">.</span><span class="fu">setVolatile</span><span class="op">(</span>instance<span class="op">,</span> <span class="dv">21</span><span class="op">);</span></span>
<span id="cb134-32"><a href="#cb134-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb134-33"><a href="#cb134-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-34"><a href="#cb134-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">//按程序顺序访问，但不保证相对于其他线程的内存排序效果</span></span>
<span id="cb134-35"><a href="#cb134-35" aria-hidden="true" tabindex="-1"></a>        count1Handle<span class="op">.</span><span class="fu">getOpaque</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb134-36"><a href="#cb134-36" aria-hidden="true" tabindex="-1"></a>        count1Handle<span class="op">.</span><span class="fu">setOpaque</span><span class="op">(</span>instance<span class="op">,</span> <span class="dv">22</span><span class="op">);</span></span>
<span id="cb134-37"><a href="#cb134-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>instance<span class="op">);</span></span>
<span id="cb134-38"><a href="#cb134-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-39"><a href="#cb134-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>VarHandle</code>可以取代<code>java.util.concurrent.atomic</code>包和<code>sun.misc.Unsafe</code>包的功能</p>
<h3 id="局部变量类型推断jdk10">局部变量类型推断(JDK10)</h3>
<p>只能用于局部变量初始化、for循环局部变量</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;();</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="dt">var</span> steam <span class="op">=</span> <span class="fu">getStream</span><span class="op">();</span></span></code></pre></div>
<h2 id="gc">26.GC</h2>
<p>GC全称为Garbage
Collected，即垃圾回收，GC会每隔一段时间执行，GC执行时程序会被暂停以防止新的垃圾产生</p>
<h3 id="finalize函数">finalize函数</h3>
<p><code>finalize</code>是Object的protected方法，子类可以覆盖该方法以实现资源清理工作，GC在回收对象之前调用该方法。</p>
<p>当对象不可达（通过GC
Roots无法搜索到）时，如果重写了<code>finalize</code>函数，GC会把对象放入F-Queue队列，然后开启一低优先级线程执行该队列中对象的<code>finalize</code>方法，执行finalize方法完毕后，GC会再次判断该对象是否可达，若不可达，则进行回收，否则，对象“复活”</p>
<p><code>finalize</code>不同于C中的析构函数，它调用的时机不确定（你可以通过<code>System.gc()</code>建议系统执行gc，但仍不一定执行gc）；由于对象已不可达，如果在<code>finalize</code>出现异常，如果我们没有<code>try-catch</code>，向外抛的异常是不会有任何提示的；由于执行gc的线程比其他线程的优先级要低，如果在<code>finalize</code>中回收资源（如关闭流资源）如果主线程在不断地创建资源，<code>finalize</code>总是无法及时回收的</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>        TestFinalize testFinalize <span class="op">=</span> <span class="kw">new</span> <span class="fu">TestFinalize</span><span class="op">();</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>        testFinalize <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">gc</span><span class="op">();</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestFinalize <span class="op">{</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">FileInputStream</span><span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">();</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">TestFinalize</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>                        list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="bu">FileInputStream</span><span class="op">(</span><span class="kw">new</span> <span class="bu">File</span><span class="op">((</span><span class="st">&quot;in.txt&quot;</span><span class="op">))));</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">FileNotFoundException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>                        e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">finalize</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Throwable</span> <span class="op">{</span></span>
<span id="cb136-29"><a href="#cb136-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span><span class="fu">finalize</span><span class="op">();</span></span>
<span id="cb136-30"><a href="#cb136-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">//finalize无法及时回收资源，会导致内存溢出</span></span>
<span id="cb136-31"><a href="#cb136-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span>list<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb136-32"><a href="#cb136-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Iterator</span><span class="op">&lt;</span><span class="bu">FileInputStream</span><span class="op">&gt;</span> it <span class="op">=</span> list<span class="op">.</span><span class="fu">iterator</span><span class="op">();</span></span>
<span id="cb136-33"><a href="#cb136-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span>it<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb136-34"><a href="#cb136-34" aria-hidden="true" tabindex="-1"></a>                <span class="bu">FileInputStream</span> stream <span class="op">=</span> it<span class="op">.</span><span class="fu">next</span><span class="op">();</span></span>
<span id="cb136-35"><a href="#cb136-35" aria-hidden="true" tabindex="-1"></a>                stream<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb136-36"><a href="#cb136-36" aria-hidden="true" tabindex="-1"></a>                list<span class="op">.</span><span class="fu">remove</span><span class="op">(</span>stream<span class="op">);</span></span>
<span id="cb136-37"><a href="#cb136-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb136-38"><a href="#cb136-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb136-39"><a href="#cb136-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">//控制台不会打印错误信息</span></span>
<span id="cb136-40"><a href="#cb136-40" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> num <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb136-41"><a href="#cb136-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb136-42"><a href="#cb136-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>finalize</code>在JDK9中已经被弃用，改为用<code>AutoCloseable</code>接口实现资源的回收</p>
<h3 id="内存模型jmm">内存模型(JMM)</h3>
<p>主内存分为</p>
<ul>
<li>堆:
存放对象实例，堆是垃圾收集器管理的主要区域，线程共享的堆中可能划分出多个线程私有的分配缓冲区(TLAB)</li>
<li>栈: Java虚拟机栈，存放JAVA中的对象引用、局部变量等，线程私有</li>
<li>本地方法栈: <code>native</code>方法用的栈</li>
<li>方法区:
存放类加载信息、常量池（常量、字面量、字段引用、属性）、字段数据（类的版本、全路径名、接口、字段、修饰符、方法名、属性等信息）、方法数据（方法名、返回类型、参数类型、修饰符、属性）、方法代码（方法的字节码、操作数栈大小、局部变量大小、局部变量表、异常表、被捕获的异常类的常量池索引等），线程共享</li>
<li>程序计数器(PC，Program Counter): 记录当前线程运行的位置</li>
</ul>
<p>方法区和堆是线程共享的，虚拟机栈和本地方法栈和程序计数器是线程私有的</p>
<p>工作内存:</p>
<ul>
<li><p>JMM规定了所有的变量都存储在主内存（Main
Memory）中。每个线程还有自己的工作内存（Working
Memory）,线程的工作内存中保存了该线程使用到的变量的主内存的副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量（volatile变量仍然有工作内存的拷贝，但是由于它特殊的操作顺序性规定，所以看起来如同直接在主内存中读写访问一般）。不同的线程之间也无法直接访问对方工作内存中的变量，线程之间值的传递都需要通过主内存来完成。</p></li>
<li><p>工作内存中有一个叫TLAB（Thread Local Allocation
Buffer）的区域。在TLAB上分配对象时不需要加锁，因此JVM在给线程的对象分配内存时会尽量的在TLAB上分配。如果确定一个对象的作用域不会逃逸出方法之外，那可以将这个对象分配在TLAB上。TLAB仅作用于新生代的Eden区，因此在编写Java程序时，通常多个小的对象比大的对象分配起来更加高效</p></li>
</ul>
<p>除此以外，还有直接内存:
<code>NIO</code>通过调用Native方法直接分配堆外内存，这个堆外内存就是本机内存，<code>NIO</code>使用直接内存以提高效率。直接内存不属于JMM，它不存储在JAVA内存中，而是在计算机内存中</p>
<p><strong>溢出</strong></p>
<p>堆溢出<code>java.lang.OutOfMemoryError: Java heap space</code></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>    list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">5</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span><span class="op">]);</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;分配次数：&quot;</span> <span class="op">+</span> <span class="op">(++</span>i<span class="op">));</span></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>栈溢出<code>java.lang.StackOverflowError</code></p>
<div class="sourceCode" id="cb138"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> num <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">testStackOF</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    num<span class="op">++;</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">testStackOF</span><span class="op">();</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>栈空间不足<code>OutOfMemberError</code></p>
<div class="sourceCode" id="cb139"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">testOutOfMember</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">loop</span><span class="op">();</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">void</span> <span class="fu">loop</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">;</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>永久代溢出——常量池溢出<code>java.lang.OutOfMemoryError: Java heap space</code>（使用GC参数<code>-XX:PermSize=10m -XX:MaxPermSize=10m</code>）</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="bu">UUID</span><span class="op">.</span><span class="fu">randomUUID</span><span class="op">().</span><span class="fu">toString</span><span class="op">().</span><span class="fu">intern</span><span class="op">());</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    i<span class="op">++;</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>永久代溢出——方法区溢出（使用CGLib动态生成大量的代理类）</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>        Enhancer enhancer <span class="op">=</span> <span class="kw">new</span> <span class="fu">Enhancer</span><span class="op">();</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>        enhancer<span class="op">.</span><span class="fu">setSuperclass</span><span class="op">(</span>OOMObject<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>        enhancer<span class="op">.</span><span class="fu">setUseCache</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>        enhancer<span class="op">.</span><span class="fu">setCallback</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MethodInterceptor</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">intercept</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">,</span> <span class="bu">Method</span> method<span class="op">,</span> <span class="bu">Object</span><span class="op">[]</span> args<span class="op">,</span> MethodProxy proxy<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Throwable</span> <span class="op">{</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> proxy<span class="op">.</span><span class="fu">invokeSuper</span><span class="op">(</span>obj<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>        enhancer<span class="op">.</span><span class="fu">create</span><span class="op">();</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>        i<span class="op">++;</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">finally</span><span class="op">{</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;运行次数：&quot;</span><span class="op">+</span>i<span class="op">);</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>直接内存(DirectMemory)溢出（使用GC参数<code>-Xms20m -Xmx20m -XX:MaxDirectMemorySize=10m</code>）</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Field</span> field <span class="op">=</span> Unsafe<span class="op">.</span><span class="fu">class</span><span class="op">.</span><span class="fu">getDeclaredFields</span><span class="op">()[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    field<span class="op">.</span><span class="fu">setAccessible</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    Unsafe unsafe <span class="op">=</span> <span class="op">(</span>Unsafe<span class="op">)</span> field<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">){</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">//通过unsafe分配物理内存</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>        unsafe<span class="op">.</span><span class="fu">allocateMemory</span><span class="op">(</span><span class="dv">1024</span><span class="op">*</span><span class="dv">1024</span><span class="op">);</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>        i<span class="op">++;</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span><span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;分配次数：&quot;</span><span class="op">+</span>i<span class="op">);</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="堆中的gc算法">堆中的GC算法</h3>
<p>在分代垃圾回收方式中，非堆为持久代（持久代又叫永久代，从JAVA8开始，持久代被替换成了元空间，Metaspace，元空间作用和持久代一样，但元空间并不在虚拟机中，而是在本地内存中），堆又分为新生代和老年代，它们可以选择不同的回收算法（在新生代执行的gc叫<code>minor gc</code>，在老年代执行的gc叫<code>major gc</code>，清理整个堆空间（包括新生代和老年代）叫<code>full gc</code>）</p>
<table>
<tr>
<th colspan="3">
新生代
</th>
<th>
老年代
</th>
</tr>
<tr>
<td>
Eden
</td>
<td>
From/s0
</td>
<td>
To/s1
</td>
<td>
</td>
</tr>
</table>
<p>Eden:From:To默认是8:1:1（因为Eden区的对象大多很快就被销毁，大部分不会进入Survivor区），新生代:老年代默认是1:2。新创建的对象会放到新生代中的Eden中，经过一次GC后，如果对象还在被引用，会把它放在From或To（又叫Survivor区，分为s0和s1）中，From和To可以相互转换，其大小是一样的，而且只会使用其中一个，当执行<code>复制算法</code>时，会把被引用的对象复制到一边（比如From），然后把另一边清空（比如To）（因为如果仅删除没有被引用的对象对应的内存区域，有可能会清除不干净，会产生内存碎片，所以采用整块内存清除的策略，而新生代中的对象消亡较快，所以复制被引用的对象会快一些）</p>
<p>如果经过15次GC后对象仍然被引用着（或者对象超过一定的大小，可能会直接进入老年区，不会经过新生代，这个和GC机制和JVM参数有关），这时就会把该对象从新生代移动到老年代，在老年代中执行<code>标记-压缩算法</code>时，会移动所有存活的对象，且按照内存地址次序依次排列（即将所有的存活对象压缩到内存的一端），然后将末端内存地址以后的内存全部回收，这样就不会产生内存碎片了</p>
<p>不同的GC收集器对栈的划分不一样，使用的收集算法也不一样，上面只是其中的一种情况，至于具体使用哪种算法，根据参数配置及GC收集器决定</p>
<h3 id="引用">引用</h3>
<p>引用分为</p>
<ul>
<li>强引用:
就是平时用的对象引用，只要引用存在，垃圾回收器永远不会回收</li>
<li>软引用: 内存溢出之前进行回收</li>
</ul>
<div class="sourceCode" id="cb143"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> obj <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span><span class="co">//强引用</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="bu">SoftReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> sf <span class="op">=</span> <span class="kw">new</span> <span class="bu">SoftReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;(</span>obj<span class="op">);</span><span class="co">//软引用</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> <span class="kw">null</span><span class="op">;</span><span class="co">//删除强引用软引用才能生效</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>sf<span class="op">.</span><span class="fu">get</span><span class="op">();</span><span class="co">//可能会返回null</span></span></code></pre></div>
<ul>
<li>弱引用: 经过两次GC后会被回收，无论内存够不够用都会被回收</li>
</ul>
<div class="sourceCode" id="cb144"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> obj <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="bu">WeakReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> wf <span class="op">=</span> <span class="kw">new</span> <span class="bu">WeakReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;(</span>obj<span class="op">);</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>obj <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>wf<span class="op">.</span><span class="fu">get</span><span class="op">();</span><span class="co">//可能会返回null</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>wf<span class="op">.</span><span class="fu">isEnQueued</span><span class="op">();</span><span class="co">//返回是否被垃圾回收器标记为即将回收的垃圾</span></span></code></pre></div>
<ul>
<li>虚引用: GC时立即回收，主要用来跟踪对象被GC回收的活动</li>
</ul>
<div class="sourceCode" id="cb145"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> obj <span class="op">=</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">();</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="bu">PhantomReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> pf <span class="op">=</span> <span class="kw">new</span> <span class="bu">PhantomReference</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;(</span>obj<span class="op">);</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>obj<span class="op">=</span><span class="kw">null</span><span class="op">;</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>pf<span class="op">.</span><span class="fu">get</span><span class="op">();</span><span class="co">//永远返回null</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>pf<span class="op">.</span><span class="fu">isEnQueued</span><span class="op">();</span><span class="co">//返回是否从内存中已经删除</span></span></code></pre></div>
<h3 id="gc参数">GC参数</h3>
<p>可以在<code>javac</code>时指定GC的参数，（<code>+</code>代表启用，如果想禁用，把<code>+</code>改为<code>-</code>即可）</p>
<p>日志相关：</p>
<ul>
<li><code>-XX:+PrintGC</code>: 打印GC日志</li>
<li><code>-XX:+PrintGCDetails</code>: 打印GC详细日志</li>
<li><code>-XX:+PrintGCTimeStamps</code>:
以基准时间的形式打印GC的时间戳</li>
<li><code>-XX:+PrintGCDateStamps</code>: 以日期的形式打印GC的时间戳</li>
<li><code>-XX:+PrintHeapAtGC</code>: 在GC前后打印出堆的信息</li>
<li><code>-Xloggc:../logs/gc.log</code>: 日志文件的输出路径</li>
</ul>
<p>内存大小相关：</p>
<ul>
<li><code>-Xms</code>:
堆区内存初始内存分配的大小，通常为操作系统可用内存的1/64大小即可（如：-Xms1600m）</li>
<li><code>-Xmx</code>:
堆区内存可被分配的最大上限，通常为操作系统可用内存的1/4大小，但是开发过程中，通常会将<code>-Xms</code>与<code>-Xmx</code>两个参数的配置相同的值，其目的是为了能够在java垃圾回收机制清理完堆区后不需要重新分隔计算堆区的大小而浪费资源</li>
<li><code>-XX:newSize</code>: 新生代初始内存的大小</li>
<li><code>-XX:MaxnewSize</code>: 新生代可被分配的内存的最大上限</li>
<li><code>-Xmn</code>:
同时设置<code>-XX:newSize</code>和<code>-XX:MaxnewSize</code>并使它们的值相等</li>
<li><code>-XX:OldSize</code>: 老年代初始内存的大小（老年代的内存=堆内存
- 新生代内存，老年代的最大内存 = 堆内存 -
新生代最大内存，一般设置堆内存和新生代即可）</li>
<li><code>-XX:PermSize</code>: 非堆区初始内存分配大小(permanent
size，持久化内存)</li>
<li><code>-XX:MaxPermSize</code>: 非堆区分配的内存的最大上限</li>
<li><code>-XX:SurvivorRatio</code>:
设置新生代中Eden区和两个Survivor区的大小比值（比如-XX:SurvivorRatio=8，则表示Survivor:Eden=2:8）</li>
<li><code>-XX:NewRatio</code>:
指定老年代/新生代的堆内存比例（比如-XX:NewRatio=4，则表示年轻代与年老代所占比值为1:4），设置了-XX:MaxNewSize时，-XX:NewRatio的值会被忽略</li>
<li><code>-XX:PretenureSizeThreshold</code>:
设置对象超过多大时，创建的时候直接进入老年代，不经过新生代</li>
</ul>
<p>收集器相关：</p>
<p>GC有<code>serial</code>收集器、<code>serial old</code>收集器、<code>parnew</code>收集器、<code>parallel old</code>收集器、<code>parallel scavenge</code>收集器、<code>CMS</code>收集器(Concurrent
Mark-Sweep)、<code>G1</code>收集器(Garbage First)</p>
<ul>
<li><p><code>-XX:MaxGCPauseMills</code>:
设置GC时最大的停顿时间，单位为毫秒，但不一定有效</p></li>
<li><p><code>-XX:GCTimeRatio</code>:
垃圾回收时间占总运行时间的比值，公式为<code>1/（1+N）</code>，默认我99，即1%的时间用于垃圾回收</p></li>
<li><p><code>-XX:+UseAdaptiveSizePolicy</code>:
并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时，一直打开</p></li>
<li><p><code>-XX:+UseSerialGC</code>:
使用串行收集器，串行收集器最稳定，但可能会产生较长的停顿，因为它只使用一个线程去回收</p></li>
<li><p><code>-XX:+UseParNewGC</code>:
在新生代使用并行收集器，不影响老年代，可以通过<code>-XX:ParallelGCThreads</code>指定并行的线程数，可与CMS收集同时使用。在serial基础上实现的多线程收集器。更关注响应时间</p></li>
<li><p><code>-XX:+UseParallelGC</code>:
在新生代使用并行收集器，不影响老年代，可以同时并行多个垃圾收集线程，但此时用户线程必须停止。更关注吞吐量</p></li>
<li><p><code>-XX:+UseParallelOldGC</code>:
在老年代使用并行收集器，不影响新生代</p></li>
<li><p><code>-XX:+UseConcMarkSweepGC</code>: 使用CMS收集器</p></li>
<li><p><code>-XX:+ UseCMSCompactAtFullCollection</code>:
设置CMS收集器经过Full GC后，进行一次整理</p></li>
<li><p><code>-XX:+CMSFullGCsBeforeCompaction</code>:
设置CMS收集器经过几次Full GC后进行一次碎片整理</p></li>
<li><p><code>-XX:ParallelCMSThreads</code>: 设置CMS收集器线程数</p></li>
</ul>
<h2 id="编译openjdk">27.编译OpenJDK</h2>
<h3 id="下载源码">下载源码</h3>
<p><strong>下载压缩包</strong></p>
<p>地址</p>
<p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/5b86f66575b7">JDK8</a></p>
<p><a href="http://hg.openjdk.java.net/jdk10/master/file/be620a591379">JDK10</a></p>
<p>点击左侧zip下载压缩包</p>
<p><strong>在线下载源码</strong></p>
<p>地址(JDK8): https://download.java.net/openjdk/jdk8</p>
<p>向导(JDK8):
http://hg.openjdk.java.net/jdk8/jdk8/raw-file/tip/README-builds.html</p>
<p>在线下载JDK10</p>
<pre class="shell"><code>sudo apt install mercurial
hg clone http://hg.openjdk.java.net/jdk10/jdk10
cd jdk10
sudo chmod +x get_source.sh
./get_source.sh</code></pre>
<h3 id="配置编译">配置、编译</h3>
<p>依赖安装</p>
<pre class="shell"><code>sudo apt-get install systemtap-sdt-dev libx11-dev libxext-dev libxrender-dev libxtst-dev libxt-dev libcups2-dev libfreetype6-dev libasound2-dev</code></pre>
<p>安装<a href="https://ccache.samba.org/download.html">ccache</a></p>
<pre class="shell"><code>tar -zxvf ccache-3.5.tar.gz 
cd ccache-3.5/
./configure
make
sudo make install</code></pre>
<p>执行cofigure脚本（boot-jdk要求JDK版本为9或10，但10没有javah，所以只能使用<a href="http://jdk.java.net/java-se-ri/9">JDK9</a>）</p>
<pre class="shell"><code>bash configure --with-debug-level=slowdebug --enable-dtrace --with-jvm-variants=server --with-target-bits=64 --enable-ccache --with-num-cores=8 --with-memory-size=8000  --disable-warnings-as-errors --with-boot-jdk=/usr/lib/jvm/jdk-9/</code></pre>
<p>执行<code>make images</code>开始编译</p>
<p>编译完成显示</p>
<pre><code>Finished building target &#39;images&#39; in configuration &#39;linux-x86_64-normal-server-slowdebug&#39;</code></pre>
<p>此时编译的JDK目录在<code>build/linux-x86_64-normal-server-slowdebug</code>中</p>
</body>
</html>
