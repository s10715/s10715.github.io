<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>J2EE基础</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">html {scroll-behavior: smooth;}body {font-size: 1rem;line-height: 1.6;tab-size: 4;color: rgb(51, 51, 51);font-family: Microsoft YaHei,"Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;-webkit-font-smoothing: antialiased;position: relative;top: 0;left: 300px;width: calc(90% - 300px);padding: 2em 5%;}h1,h2,h3,h4,h5,h6 {position: relative;margin-top: 1rem;margin-bottom: 1rem;padding-bottom: 0;font-weight: bold;line-height: 1.4;cursor: text;}h1 {font-size: 2.25em;line-height: 1.2;border-bottom: 1px solid #eee;}h2 {font-size: 1.75em;line-height: 1.225;border-bottom: 1px solid #eee;}h3 {font-size: 1.5em;line-height: 1.43;}h4 {font-size: 1.25em;}h5 {font-size: 1em;}h6 {font-size: 1em;color: #777;}p,blockquote{ margin: 0.8em 0 !important; }ul,ol,dl,table{margin: 0.8em 0;}li>ol,li>ul {margin: 0 0;}a {color: #4183C4;text-decoration: none;}hr {height: 2px;padding: 0;margin: 16px 0;background-color: #e7e7e7;border: 0 none;overflow: hidden;box-sizing: content-box;}li p.first {display: inline-block;}ul,ol {padding-left: 20px;}ul:first-child,ol:first-child {margin-top: 0;}ul:last-child,ol:last-child {margin-bottom: 0;}blockquote {border-left: 4px solid #dfe2e5 !important;padding: 0 15px;color: #777777 !important;background-color: #ffffff !important;}blockquote blockquote {padding-right: 0;}table {padding: 0;word-break: initial;border-collapse: collapse;}table tr {border: 1px solid #dfe2e5;margin: 0;padding: 0;}table tr:nth-child(2n),thead {background-color: #f8f8f8;}table th {font-weight: normal;text-align: unset;border-bottom: 0;border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table td {border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table th:first-child,table td:first-child {margin-top: 0;}table th:last-child,table td:last-child {margin-bottom: 0;}tt {border: 1px solid #e7eaed;background-color: #f8f8f8;border-radius: 3px;padding: 2px 4px 0px 4px;font-size: 0.9em;}code {border: 1px solid #e7eaed;background-color: #f3f4f4;border-radius: 3px;padding: 0 2px 0 2px;font-size: 0.9em;}img {width: 50%;height: 50%;display: block;vertical-align: middle;image-orientation: from-image;margin: auto;}figcaption {text-align: center;}pre>code{counter-reset: linenumber;display: block;white-space: pre;overflow: auto !important;padding: 0.2em;border-radius: 7px;}pre>code>span {counter-increment: linenumber;display: inline-block;line-height: 1.25em !important;}pre>code>span::before {content: counter(linenumber);display: inline-block;font-size: 0.9em;color: #999;min-width: 1.8em;margin-right: 0.5em;padding-right: 0.25em;text-align: right;border-right: 1px solid #999;line-height: 1.9em;user-select: none;pointer-events: none;}#TOC {font-size: 0.8rem;position: fixed;top: 0;left: 0;width: 300px;height: 100%;padding: 32px 16px 48px 16px !important;box-shadow: 0 0 4px rgba(150,150,150,0.33);box-sizing: border-box;overflow: auto;}#TOC::-webkit-scrollbar{width: 1px;border-right: 1px solid #f5f5f5;}#TOC a{color: #333333;text-decoration: none;}#TOC a:hover{color: #333333 !important;text-decoration: underline !important;}#TOC ul { list-style: none; }#TOC li { margin-bottom: 0.25rem; }@media (max-width: 700px) {#TOC { display: none; }body { left: 0px; width: 90%; }}</style>
  <script type="text/javascript">
  window.onload = function(){
    document.querySelectorAll('a[href^="#"]').forEach(function(item,index,arr){
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const target =  document.getElementById(decodeURI((item.href.substring(item.href.indexOf('#')+1))));
            if(target == null) { return; }
            target.scrollIntoView({ behavior: 'smooth' });
        });
    })
    const toc_a = document.querySelectorAll('#TOC a');
    function updateTOC(){
      const scrollPosition = window.scrollY;
      let highlightTarget;
      for(let i=toc_a.length-1; i>=0; i--){
        const target = document.getElementById(decodeURI((toc_a[i].href.substring(toc_a[i].href.indexOf('#')+1))));
        if(target == null) { continue; }
        const ItemPosition = target.offsetTop;
        if (scrollPosition > ItemPosition && typeof(highlightTarget) == "undefined") {
          highlightTarget = toc_a[i];
        } else if(typeof(highlightTarget) == "undefined" && i == 0) {
          highlightTarget = toc_a[0];
        }
      }
      toc_a.forEach( item => {
        item.style.fontWeight = "";
      });
      if(typeof(highlightTarget) == "undefined") { return; }
      highlightTarget.style.fontWeight = "bold";
    }
    let timer = null;
    window.addEventListener('scroll', () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(() => { updateTOC() }, 200);
    });
  };
  </script>
  <base target="_blank">
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#sql" id="toc-sql">SQL</a>
<ul>
<li><a href="#基本操作" id="toc-基本操作">基本操作</a>
<ul>
<li><a href="#数据库操作" id="toc-数据库操作">数据库操作</a></li>
<li><a href="#表操作" id="toc-表操作">表操作</a></li>
<li><a href="#字段操作" id="toc-字段操作">字段操作</a></li>
<li><a href="#视图操作" id="toc-视图操作">视图操作</a></li>
<li><a href="#事务" id="toc-事务">事务</a></li>
<li><a href="#字符集校对集操作" id="toc-字符集校对集操作">字符集、校对集操作</a></li>
<li><a href="#备份还原" id="toc-备份还原">备份还原</a></li>
</ul></li>
<li><a href="#数据类型" id="toc-数据类型">数据类型</a>
<ul>
<li><a href="#字符串" id="toc-字符串">字符串</a></li>
<li><a href="#整型" id="toc-整型">整型</a></li>
<li><a href="#小数" id="toc-小数">小数</a></li>
<li><a href="#日期时间" id="toc-日期时间">日期时间</a></li>
</ul></li>
<li><a href="#列属性" id="toc-列属性">列属性</a></li>
<li><a href="#索引" id="toc-索引">索引</a></li>
<li><a href="#程序" id="toc-程序">程序</a>
<ul>
<li><a href="#变量" id="toc-变量">变量</a></li>
<li><a href="#程序结构" id="toc-程序结构">程序结构</a></li>
<li><a href="#触发器" id="toc-触发器">触发器</a></li>
<li><a href="#函数" id="toc-函数">函数</a></li>
<li><a href="#存储过程" id="toc-存储过程">存储过程</a></li>
</ul></li>
</ul></li>
<li><a href="#java-web" id="toc-java-web">JAVA WEB</a>
<ul>
<li><a href="#servlet" id="toc-servlet">Servlet</a>
<ul>
<li><a href="#servlet基本使用" id="toc-servlet基本使用">Servlet基本使用</a></li>
<li><a href="#cookie" id="toc-cookie">Cookie</a></li>
<li><a href="#session" id="toc-session">Session</a></li>
<li><a href="#路径问题" id="toc-路径问题">路径问题</a></li>
<li><a href="#转发和重定向" id="toc-转发和重定向">转发和重定向</a></li>
<li><a href="#filter" id="toc-filter">Filter</a></li>
<li><a href="#listener" id="toc-listener">Listener</a></li>
</ul></li>
<li><a href="#jsp" id="toc-jsp">JSP</a>
<ul>
<li><a href="#jsp基本使用" id="toc-jsp基本使用">JSP基本使用</a></li>
<li><a href="#乱码问题" id="toc-乱码问题">乱码问题</a></li>
<li><a href="#jsp标签" id="toc-jsp标签">JSP标签</a></li>
<li><a href="#el表达式" id="toc-el表达式">EL表达式</a></li>
<li><a href="#jstl标签" id="toc-jstl标签">JSTL标签</a></li>
<li><a href="#自定义标签" id="toc-自定义标签">自定义标签</a></li>
<li><a href="#自定义el函数" id="toc-自定义el函数">自定义EL函数</a></li>
</ul></li>
</ul></li>
<li><a href="#三层架构和mvc" id="toc-三层架构和mvc">三层架构和mvc</a></li>
<li><a href="#spring" id="toc-spring">Spring</a>
<ul>
<li><a href="#ioc" id="toc-ioc">IOC</a>
<ul>
<li><a href="#xml" id="toc-xml">xml</a>
<ul>
<li><a href="#直接注入" id="toc-直接注入">直接注入</a></li>
<li><a href="#工厂模式注入" id="toc-工厂模式注入">工厂模式注入</a></li>
<li><a href="#含参数的注入" id="toc-含参数的注入">含参数的注入</a></li>
<li><a href="#通过代码获取" id="toc-通过代码获取">通过代码获取</a></li>
</ul></li>
<li><a href="#注解" id="toc-注解">注解</a>
<ul>
<li><a href="#通过注解注入" id="toc-通过注解注入">通过注解注入</a></li>
<li><a href="#通过注解获取" id="toc-通过注解获取">通过注解获取</a></li>
</ul></li>
<li><a href="#循环依赖注入问题" id="toc-循环依赖注入问题">循环依赖注入问题</a></li>
</ul></li>
<li><a href="#aop" id="toc-aop">AOP</a>
<ul>
<li><a href="#xml-1" id="toc-xml-1">xml</a></li>
<li><a href="#注解-1" id="toc-注解-1">注解</a></li>
</ul></li>
<li><a href="#txmanager" id="toc-txmanager">txManager</a>
<ul>
<li><a href="#jdbctemplate" id="toc-jdbctemplate">JdbcTemplate</a></li>
<li><a href="#transactionmanager" id="toc-transactionmanager">transactionManager</a>
<ul>
<li><a href="#代码使用" id="toc-代码使用">代码使用</a></li>
<li><a href="#xml使用" id="toc-xml使用">xml使用</a></li>
<li><a href="#注解使用" id="toc-注解使用">注解使用</a></li>
</ul></li>
</ul></li>
<li><a href="#其他注解" id="toc-其他注解">其他注解</a>
<ul>
<li><a href="#import" id="toc-import"><span class="citation" data-cites="Import">@Import</span></a></li>
<li><a href="#bean" id="toc-bean"><span class="citation" data-cites="Bean">@Bean</span></a></li>
<li><a href="#configuration" id="toc-configuration"><span class="citation" data-cites="Configuration">@Configuration</span></a></li>
<li><a href="#propertysource" id="toc-propertysource"><span class="citation" data-cites="PropertySource">@PropertySource</span></a></li>
<li><a href="#conditional" id="toc-conditional"><span class="citation" data-cites="Conditional">@Conditional</span></a></li>
<li><a href="#profile" id="toc-profile"><span class="citation" data-cites="Profile">@Profile</span></a></li>
</ul></li>
<li><a href="#processor" id="toc-processor">Processor</a></li>
<li><a href="#aware" id="toc-aware">Aware</a></li>
<li><a href="#applicationlistener" id="toc-applicationlistener">ApplicationListener</a></li>
</ul></li>
<li><a href="#spring-mvc" id="toc-spring-mvc">Spring MVC</a>
<ul>
<li><a href="#pom.xml" id="toc-pom.xml">pom.xml</a></li>
<li><a href="#web.xml配置" id="toc-web.xml配置">web.xml配置</a></li>
<li><a href="#springmvc-servlet.xml配置" id="toc-springmvc-servlet.xml配置">springmvc-servlet.xml配置</a></li>
<li><a href="#request" id="toc-request">request</a>
<ul>
<li><a href="#基本数据类型" id="toc-基本数据类型">基本数据类型</a></li>
<li><a href="#arraylistmap" id="toc-arraylistmap">array、List、Map</a></li>
<li><a href="#vo" id="toc-vo">VO</a></li>
<li><a href="#json" id="toc-json">Json</a></li>
<li><a href="#mutipartfile" id="toc-mutipartfile">MutipartFile</a></li>
<li><a href="#其他类型convertor" id="toc-其他类型convertor">其他类型（Convertor）</a></li>
<li><a href="#initbinder" id="toc-initbinder"><span class="citation" data-cites="InitBinder">@InitBinder</span></a></li>
<li><a href="#controlleradvice" id="toc-controlleradvice"><span class="citation" data-cites="ControllerAdvice">@ControllerAdvice</span></a></li>
<li><a href="#rest风格url" id="toc-rest风格url">REST风格URL</a></li>
<li><a href="#校验validated" id="toc-校验validated">校验（<span class="citation" data-cites="Validated">@Validated</span>）</a></li>
</ul></li>
<li><a href="#response" id="toc-response">response</a>
<ul>
<li><a href="#redirect和forward" id="toc-redirect和forward">redirect和forward</a></li>
<li><a href="#数据回显" id="toc-数据回显">数据回显</a>
<ul>
<li><a href="#void" id="toc-void">void</a></li>
<li><a href="#vo-1" id="toc-vo-1">VO</a></li>
<li><a href="#map" id="toc-map">Map</a></li>
<li><a href="#model" id="toc-model">Model</a></li>
<li><a href="#modelmap" id="toc-modelmap">ModelMap</a></li>
<li><a href="#modelandview" id="toc-modelandview">ModelAndView</a></li>
<li><a href="#servlet-api" id="toc-servlet-api">servlet API</a></li>
<li><a href="#printwriter" id="toc-printwriter">PrintWriter</a></li>
<li><a href="#modelattribute" id="toc-modelattribute"><span class="citation" data-cites="ModelAttribute">@ModelAttribute</span></a></li>
</ul></li>
</ul></li>
<li><a href="#sessioncookie" id="toc-sessioncookie">Session、Cookie</a></li>
<li><a href="#exceptionresolver" id="toc-exceptionresolver">ExceptionResolver</a></li>
<li><a href="#interceptor" id="toc-interceptor">Interceptor</a></li>
<li><a href="#跨域问题" id="toc-跨域问题">跨域问题</a>
<ul>
<li><a href="#跨域请求" id="toc-跨域请求">跨域请求</a></li>
<li><a href="#解决方法" id="toc-解决方法">解决方法</a>
<ul>
<li><a href="#jsonp" id="toc-jsonp">JSONP</a></li>
<li><a href="#window.domain" id="toc-window.domain">window.domain</a></li>
<li><a href="#postmessage" id="toc-postmessage">postMessage</a></li>
<li><a href="#cors" id="toc-cors">CORS</a></li>
<li><a href="#服务器跨域" id="toc-服务器跨域">服务器跨域</a></li>
<li><a href="#附nginx常用配置" id="toc-附nginx常用配置">附:Nginx常用配置</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#mybatis" id="toc-mybatis">Mybatis</a>
<ul>
<li><a href="#全局配置文件" id="toc-全局配置文件">全局配置文件</a></li>
<li><a href="#mapper.java" id="toc-mapper.java">Mapper.java</a></li>
<li><a href="#mapper.xml" id="toc-mapper.xml">mapper.xml</a></li>
<li><a href="#使用" id="toc-使用">使用</a></li>
<li><a href="#其他" id="toc-其他">其他</a>
<ul>
<li><a href="#where" id="toc-where">where</a></li>
<li><a href="#selectkey" id="toc-selectkey">selectKey</a></li>
<li><a href="#懒加载" id="toc-懒加载">懒加载</a></li>
<li><a href="#缓存" id="toc-缓存">缓存</a></li>
<li><a href="#禁用预编译" id="toc-禁用预编译">禁用预编译</a></li>
</ul></li>
<li><a href="#注解开发" id="toc-注解开发">注解开发</a></li>
<li><a href="#spring整合" id="toc-spring整合">Spring整合</a></li>
</ul></li>
<li><a href="#spring-data-jpa" id="toc-spring-data-jpa">Spring Data
JPA</a>
<ul>
<li><a href="#初始化数据库" id="toc-初始化数据库">初始化数据库</a></li>
<li><a href="#pom.xml-1" id="toc-pom.xml-1">pom.xml</a></li>
<li><a href="#快速入门" id="toc-快速入门">快速入门</a>
<ul>
<li><a href="#实体类" id="toc-实体类">实体类</a></li>
<li><a href="#dao接口" id="toc-dao接口">DAO接口</a></li>
<li><a href="#service层" id="toc-service层">Service层</a></li>
<li><a href="#applicationcontext.xml" id="toc-applicationcontext.xml">applicationContext.xml</a></li>
<li><a href="#单元测试" id="toc-单元测试">单元测试</a></li>
</ul></li>
<li><a href="#dao接口函数命名规范" id="toc-dao接口函数命名规范">DAO接口函数命名规范</a></li>
<li><a href="#自定义sql" id="toc-自定义sql">自定义SQL</a></li>
<li><a href="#增删改" id="toc-增删改">增删改</a></li>
<li><a href="#其他repository接口" id="toc-其他repository接口">其他Repository接口</a>
<ul>
<li><a href="#crudrepository" id="toc-crudrepository">CrudRepository</a></li>
<li><a href="#pagingandsortingrepository" id="toc-pagingandsortingrepository">PagingAndSortingRepository</a></li>
<li><a href="#jparepository" id="toc-jparepository">JpaRepository</a></li>
</ul></li>
<li><a href="#jpaspecificationexecutor" id="toc-jpaspecificationexecutor">JpaSpecificationExecutor</a></li>
<li><a href="#扩展repository方法" id="toc-扩展repository方法">扩展Repository方法</a></li>
<li><a href="#数据关系" id="toc-数据关系">数据关系</a>
<ul>
<li><a href="#一对一" id="toc-一对一">一对一</a>
<ul>
<li><a href="#直接包含" id="toc-直接包含">直接包含</a></li>
<li><a href="#使用中间表" id="toc-使用中间表">使用中间表</a></li>
<li><a href="#参数说明" id="toc-参数说明">参数说明</a></li>
</ul></li>
<li><a href="#一对多和多对一" id="toc-一对多和多对一">一对多和多对一</a></li>
<li><a href="#多对多" id="toc-多对多">多对多</a></li>
</ul></li>
</ul></li>
<li><a href="#redis" id="toc-redis">Redis</a>
<ul>
<li><a href="#安装" id="toc-安装">安装</a></li>
<li><a href="#配置" id="toc-配置">配置</a></li>
<li><a href="#启动服务" id="toc-启动服务">启动服务</a></li>
<li><a href="#key" id="toc-key">key</a></li>
<li><a href="#五大数据类型" id="toc-五大数据类型">五大数据类型</a>
<ul>
<li><a href="#string" id="toc-string">String</a></li>
<li><a href="#list" id="toc-list">List</a></li>
<li><a href="#set" id="toc-set">Set</a></li>
<li><a href="#hash" id="toc-hash">Hash</a></li>
<li><a href="#zset" id="toc-zset">Zset</a></li>
</ul></li>
<li><a href="#事务-1" id="toc-事务-1">事务</a>
<ul>
<li><a href="#multi" id="toc-multi">MULTI</a></li>
<li><a href="#watch" id="toc-watch">WATCH</a></li>
</ul></li>
<li><a href="#持久化" id="toc-持久化">持久化</a>
<ul>
<li><a href="#rdb" id="toc-rdb">RDB</a></li>
<li><a href="#aof" id="toc-aof">AOF</a></li>
</ul></li>
<li><a href="#主从复制slaveof" id="toc-主从复制slaveof">主从复制（slaveof）</a></li>
<li><a href="#发布订阅" id="toc-发布订阅">发布订阅</a></li>
<li><a href="#jedis" id="toc-jedis">Jedis</a></li>
<li><a href="#分布式锁" id="toc-分布式锁">分布式锁</a></li>
<li><a href="#穿透雪崩热点key" id="toc-穿透雪崩热点key">穿透、雪崩、热点Key</a></li>
<li><a href="#集群搭建" id="toc-集群搭建">集群搭建</a></li>
<li><a href="#整合spring" id="toc-整合spring">整合Spring</a>
<ul>
<li><a href="#非集群版本" id="toc-非集群版本">非集群版本</a></li>
<li><a href="#集群版本" id="toc-集群版本">集群版本</a></li>
<li><a href="#使用redistemplate" id="toc-使用redistemplate">使用RedisTemplate</a></li>
<li><a href="#缓存注解使用" id="toc-缓存注解使用">缓存注解使用</a></li>
<li><a href="#key生成策略" id="toc-key生成策略">key生成策略</a></li>
</ul></li>
</ul></li>
<li><a href="#zookeeper" id="toc-zookeeper">ZooKeeper</a>
<ul>
<li><a href="#配置-1" id="toc-配置-1">配置</a></li>
<li><a href="#命令行" id="toc-命令行">命令行</a>
<ul>
<li><a href="#常用命令" id="toc-常用命令">常用命令</a></li>
<li><a href="#watch机制" id="toc-watch机制">Watch机制</a></li>
<li><a href="#acl" id="toc-acl">ACL</a></li>
</ul></li>
<li><a href="#四字命令" id="toc-四字命令">四字命令</a></li>
<li><a href="#集群搭建-1" id="toc-集群搭建-1">集群搭建</a></li>
<li><a href="#原生java客户端" id="toc-原生java客户端">原生JAVA客户端</a>
<ul>
<li><a href="#pom.xml-2" id="toc-pom.xml-2">pom.xml</a></li>
<li><a href="#增删改查" id="toc-增删改查">增删改查</a></li>
<li><a href="#acl-1" id="toc-acl-1">ACL</a></li>
</ul></li>
<li><a href="#curator客户端" id="toc-curator客户端">Curator客户端</a>
<ul>
<li><a href="#pom.xml-3" id="toc-pom.xml-3">pom.xml</a></li>
<li><a href="#增删改查-1" id="toc-增删改查-1">增删改查</a></li>
<li><a href="#acl-2" id="toc-acl-2">ACL</a></li>
<li><a href="#事务-2" id="toc-事务-2">事务</a></li>
<li><a href="#子节点监听" id="toc-子节点监听">子节点监听</a></li>
<li><a href="#leader选取" id="toc-leader选取">Leader选取</a>
<ul>
<li><a href="#leaderlatch" id="toc-leaderlatch">LeaderLatch</a></li>
<li><a href="#leaderelection" id="toc-leaderelection">LeaderElection</a></li>
</ul></li>
<li><a href="#分布式锁-1" id="toc-分布式锁-1">分布式锁</a></li>
</ul></li>
</ul></li>
<li><a href="#dubbo" id="toc-dubbo">Dubbo</a>
<ul>
<li><a href="#结合spring使用" id="toc-结合spring使用">结合Spring使用</a>
<ul>
<li><a href="#服务提供者" id="toc-服务提供者">服务提供者</a></li>
<li><a href="#服务消费者" id="toc-服务消费者">服务消费者</a></li>
<li><a href="#参数说明-1" id="toc-参数说明-1">参数说明</a>
<ul>
<li><a href="#cluster" id="toc-cluster">cluster</a></li>
<li><a href="#loadbalance" id="toc-loadbalance">loadbalance</a></li>
<li><a href="#check" id="toc-check">check</a></li>
</ul></li>
<li><a href="#设计原则-幂等性" id="toc-设计原则-幂等性">设计原则:
幂等性</a></li>
</ul></li>
<li><a href="#泛化调用" id="toc-泛化调用">泛化调用</a></li>
<li><a href="#后台管理页面" id="toc-后台管理页面">后台管理页面</a></li>
<li><a href="#dubbox" id="toc-dubbox">Dubbox</a></li>
</ul></li>
<li><a href="#activemq" id="toc-activemq">ActiveMQ</a></li>
<li><a href="#rabbitmq" id="toc-rabbitmq">RabbitMQ</a>
<ul>
<li><a href="#基本使用" id="toc-基本使用">基本使用</a></li>
<li><a href="#消息发送与接收" id="toc-消息发送与接收">消息发送与接收</a></li>
<li><a href="#消息投递方式" id="toc-消息投递方式">消息投递方式</a></li>
<li><a href="#可靠性投递" id="toc-可靠性投递">可靠性投递</a></li>
<li><a href="#消费端限流" id="toc-消费端限流">消费端限流</a></li>
<li><a href="#死信队列" id="toc-死信队列">死信队列</a></li>
<li><a href="#集群搭建-2" id="toc-集群搭建-2">集群搭建</a></li>
</ul></li>
<li><a href="#shiro" id="toc-shiro">Shiro</a>
<ul>
<li><a href="#环境搭建" id="toc-环境搭建">环境搭建</a></li>
<li><a href="#代码使用-1" id="toc-代码使用-1">代码使用</a></li>
<li><a href="#与spring-mvc整合" id="toc-与spring-mvc整合">与Spring
MVC整合</a>
<ul>
<li><a href="#pom.xml-4" id="toc-pom.xml-4">pom.xml</a></li>
<li><a href="#ehcache.xml" id="toc-ehcache.xml">ehcache.xml</a></li>
<li><a href="#log4j.properties" id="toc-log4j.properties">log4j.properties</a></li>
<li><a href="#web.xml" id="toc-web.xml">web.xml</a></li>
<li><a href="#applicationcontext.xml-1" id="toc-applicationcontext.xml-1">applicationContext.xml</a></li>
<li><a href="#jsp-1" id="toc-jsp-1">JSP</a></li>
<li><a href="#realm" id="toc-realm">Realm</a></li>
<li><a href="#controller" id="toc-controller">Controller</a></li>
</ul></li>
<li><a href="#注解-2" id="toc-注解-2">注解</a></li>
</ul></li>
<li><a href="#quartz" id="toc-quartz">Quartz</a>
<ul>
<li><a href="#pom.xml-5" id="toc-pom.xml-5">pom.xml</a></li>
<li><a href="#使用-1" id="toc-使用-1">使用</a></li>
<li><a href="#job" id="toc-job">Job</a>
<ul>
<li><a href="#disallowconcurrentexecution" id="toc-disallowconcurrentexecution"><span class="citation" data-cites="DisallowConcurrentExecution">@DisallowConcurrentExecution</span></a></li>
<li><a href="#persistjobdataafterexecution" id="toc-persistjobdataafterexecution"><span class="citation" data-cites="PersistJobDataAfterExecution">@PersistJobDataAfterExecution</span></a></li>
</ul></li>
<li><a href="#jobdetail" id="toc-jobdetail">JobDetail</a></li>
<li><a href="#trigger" id="toc-trigger">Trigger</a>
<ul>
<li><a href="#simpletrigger" id="toc-simpletrigger">SimpleTrigger</a></li>
<li><a href="#calendarintervaltrigger" id="toc-calendarintervaltrigger">CalendarIntervalTrigger</a></li>
<li><a href="#dailytimeintervaltrigger" id="toc-dailytimeintervaltrigger">DailyTimeIntervalTrigger</a></li>
<li><a href="#crontrigger" id="toc-crontrigger">CronTrigger</a></li>
<li><a href="#calendar" id="toc-calendar">Calendar</a></li>
<li><a href="#misfire错失策略" id="toc-misfire错失策略">Misfire(错失策略)</a></li>
</ul></li>
<li><a href="#scheduler" id="toc-scheduler">Scheduler</a></li>
<li><a href="#其他-1" id="toc-其他-1">其他</a>
<ul>
<li><a href="#自动设置" id="toc-自动设置">自动设置</a></li>
<li><a href="#joblistener" id="toc-joblistener">JobListener</a></li>
<li><a href="#triggerlistener" id="toc-triggerlistener">TriggerListener</a></li>
<li><a href="#schedulerlistener" id="toc-schedulerlistener">SchedulerListener</a></li>
</ul></li>
</ul></li>
<li><a href="#mycat" id="toc-mycat">MyCat</a>
<ul>
<li><a href="#安装-1" id="toc-安装-1">安装</a></li>
<li><a href="#配置-2" id="toc-配置-2">配置</a>
<ul>
<li><a href="#server.xml" id="toc-server.xml">server.xml</a>
<ul>
<li><a href="#user配置" id="toc-user配置">user配置</a></li>
<li><a href="#防火墙配置" id="toc-防火墙配置">防火墙配置</a></li>
<li><a href="#拦截器" id="toc-拦截器">拦截器</a></li>
<li><a href="#全局序列号" id="toc-全局序列号">全局序列号</a></li>
</ul></li>
<li><a href="#log4j2.xml" id="toc-log4j2.xml">log4j2.xml</a></li>
<li><a href="#rule.xml" id="toc-rule.xml">rule.xml</a></li>
<li><a href="#schema.xml" id="toc-schema.xml">schema.xml</a></li>
</ul></li>
<li><a href="#垂直分库案例" id="toc-垂直分库案例">垂直分库案例</a></li>
<li><a href="#mycatzookeeper" id="toc-mycatzookeeper">MyCat+ZooKeeper</a></li>
<li><a href="#haproxyxinetdkeepalived" id="toc-haproxyxinetdkeepalived">HAProxy+xinetd+KeepAlived</a>
<ul>
<li><a href="#haproxy" id="toc-haproxy">HAProxy</a></li>
<li><a href="#xinetd" id="toc-xinetd">xinetd</a></li>
<li><a href="#测试haproxyxinetd" id="toc-测试haproxyxinetd">测试HAProxy+xinetd</a></li>
<li><a href="#keepalived" id="toc-keepalived">KeepAlived</a></li>
<li><a href="#测试keepalived" id="toc-测试keepalived">测试KeepAlived</a></li>
</ul></li>
<li><a href="#mycat管理" id="toc-mycat管理">MyCat管理</a></li>
<li><a href="#mycat优化" id="toc-mycat优化">MyCat优化</a></li>
</ul></li>
<li><a href="#solr" id="toc-solr">Solr</a>
<ul>
<li><a href="#安装-2" id="toc-安装-2">安装</a></li>
<li><a href="#配置-3" id="toc-配置-3">配置</a>
<ul>
<li><a href="#field相关" id="toc-field相关">field相关</a></li>
<li><a href="#dhi" id="toc-dhi">DHI</a></li>
</ul></li>
<li><a href="#添加数据" id="toc-添加数据">添加数据</a></li>
<li><a href="#查询语法" id="toc-查询语法">查询语法</a></li>
<li><a href="#java客户端" id="toc-java客户端">JAVA客户端</a></li>
<li><a href="#集群搭建-3" id="toc-集群搭建-3">集群搭建</a></li>
</ul></li>
<li><a href="#rxjava" id="toc-rxjava">Rxjava</a>
<ul>
<li><a href="#无背压" id="toc-无背压">无背压</a></li>
<li><a href="#背压" id="toc-背压">背压</a></li>
</ul></li>
</ul>
</nav>
<p><a href="https://mvnrepository.com/">Maven Repository</a></p>
<h2 id="sql">SQL</h2>
<h3 id="基本操作">基本操作</h3>
<h4 id="数据库操作">数据库操作</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 单行注释：双中划线+空格 或 #号（mysql特有），多行注释：/*  */</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- 创建数据库，会在data目录生成同名文件夹，里面有一个db.opt文件，保存了库选项（比如字符集等信息）</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> my_database CHARSET utf8;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 含有关键字需要使用反引号，但不建议使用关键字作数据库名</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> `database` CHARSET utf8;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- 中文数据库需要先指定字符集</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> NAMES gbk;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">DATABASE</span> 中文 CHARSET utf8;</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看数据库</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>SHOW DATABASES;</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- 模糊查询中，_表示匹配单个字符，%表示匹配多个字符</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>SHOW DATABASES <span class="kw">LIKE</span> `my_%`;</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- 如果名字含有下划线则需要转义</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>SHOW DATABASES <span class="kw">LIKE</span> `my\_%`;</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看建表语句</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">DATABASE</span> my_database;</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- 数据库的名字不可更改</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 修改数据库的字符集</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">DATABASE</span> my_database CHARSET utf8;</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">DATABASE</span> my_database <span class="dt">CHARACTER</span> <span class="kw">SET</span> utf8;</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 可以使用空格，也可以使用等号</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">DATABASE</span> my_database CHARSET<span class="op">=</span>utf8;</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- COLLATE:校对集</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">DATABASE</span> my_database COLLATE utf8;</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除数据库</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">DATABASE</span> my_database;</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- 选择数据库</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">USE</span> my_database;</span></code></pre></div>
<h4 id="表操作">表操作</h4>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 建表，会在数据库对应的文件夹下创建frm格式的结构文件（和引擎有关）</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- 可以指定数据库名</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> my_database.mytable(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>name <span class="dt">varchar</span>(<span class="dv">10</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)CHARSET<span class="op">=</span>utf8 COLLATE<span class="op">=</span>utf8 ENGINE<span class="op">=</span>innodb;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- 创建临时表，临时表只在当前连接可见，当断开连接就会自动删除</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TEMPORARY</span> <span class="kw">TABLE</span> temptable(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">int</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>name <span class="dt">varchar</span>(<span class="dv">10</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLES</span>;</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLES</span> <span class="kw">LIKE</span> `my%`;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable;</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- \g 等价于分号</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable\g</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- \G 将查询的结果的显示格式改成纵向</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable\G</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- 复制已有表的表结构（不会复制数据），可以指定数据库名</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable2 <span class="kw">LIKE</span> my_database.mytable;</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 复制数据</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable2 <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- 压力测试时可以复制自身数据，实现指数级增长数据</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable2 <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable2;</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看表结构，一下三种方式是等价的</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="kw">DESC</span> <span class="kw">COLUMNS</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>DESCRIBE <span class="kw">COLUMNS</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">COLUMNS</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看表结构</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>DESCRIBE mytable;</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- 重命名表</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="kw">RENAME</span> <span class="kw">TABLE</span> mytable <span class="kw">TO</span> my_table;</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">-- 同样，可以使用空格或等号</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable CHARSET<span class="op">=</span>utf8;</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- 新增字段</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">COLUMN</span> addr <span class="dt">VARCHAR</span>(<span class="dv">20</span>);</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">-- COLUMN可以不写</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> addr <span class="dt">VARCHAR</span>(<span class="dv">20</span>);</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- 新增字段并指定位置</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">COLUMN</span> addr <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="fu">FIRST</span>;</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">COLUMN</span> addr <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">AFTER</span> <span class="kw">id</span>;</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="co">-- 修改字段，可以更改属性或位置</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">MODIFY</span> addr <span class="dt">VARCHAR</span>(<span class="dv">25</span>) <span class="kw">AFTER</span> name;</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="co">-- 重命名字段并修改属性和位置</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">CHANGE</span> addr address <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">AFTER</span> <span class="kw">id</span>;</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除字段</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">DROP</span> address;</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删表</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> mytable1, mytable2;</span></code></pre></div>
<h4 id="字段操作">字段操作</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 不指定插入的字段时需数据的顺序需和字段顺序一致，且非数值数据都要使用引号（建议是单引号）</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="fu">VALUE</span>(<span class="dv">1</span>,<span class="st">&#39;小明&#39;</span>);</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- VALUE只能插入单条，VALUES可以插入单条或多条</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable(<span class="kw">id</span>,name) <span class="kw">VALUES</span>(<span class="dv">1</span>,<span class="st">&#39;小明&#39;</span>), (<span class="dv">2</span>,<span class="st">&#39;小红&#39;</span>);</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主键没有冲突时直接插入数据；主键冲突时，更新对应记录</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="dv">1</span>,<span class="st">&#39;小红&#39;</span>) <span class="kw">ON</span> DUPLICATE <span class="kw">KEY</span> <span class="kw">UPDATE</span> name<span class="op">=</span><span class="st">&#39;小红&#39;</span>;</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主键没有冲突时直接插入数据；主键冲突时，先删除原记录，再插入新记录</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">REPLACE</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="dv">1</span>,<span class="st">&#39;小红&#39;</span>);</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主键没有冲突时直接插入数据；主键冲突时，保持原纪录，忽略新插入的记录</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> IGNORE <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="dv">1</span>,<span class="st">&#39;小红&#39;</span>);</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看数据</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">ALL</span> <span class="op">*</span> <span class="kw">FROM</span> mytable; <span class="co">-- 查询所有记录</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable; <span class="co">-- ALL可以省略</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable,mytable2; <span class="co">-- 多个数据源</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable; <span class="co">-- 去重</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>, <span class="kw">DISTINCT</span> name <span class="kw">FROM</span> mytable; <span class="co">-- 部分去重</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">AS</span> my_id,name <span class="kw">AS</span> my_name <span class="kw">FROM</span> mytable <span class="kw">AS</span> t; <span class="co">-- 别名</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> my_id,name my_name <span class="kw">FROM</span> mytable t; <span class="co">-- AS可以省略</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">GROUP</span> <span class="kw">BY</span> name; <span class="co">-- 分组</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sex, <span class="fu">count</span>(<span class="op">*</span>), <span class="fu">max</span>(age), <span class="fu">min</span>(age), <span class="fu">avg</span>(height), <span class="fu">sum</span>(age) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> sex; <span class="co">-- GROUP BY一般配合统计函数使用（sex、age、height都是我们的字段名，count、max、min、avg、sum是统计函数），GROUP BY会自动按照分组字段排序（默认ASC，升序）</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sex, <span class="fu">count</span>(<span class="op">*</span>), <span class="fu">max</span>(age), <span class="fu">min</span>(age) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> sex <span class="kw">DESC</span>; <span class="co">-- GROUP BY会对分组后合并的结果进行排序</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> city, sex, <span class="fu">count</span>(<span class="op">*</span>), group_concat(name) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> city, sex; <span class="co">-- 多字段分组，group_concat是聚合函数，它可以对分组中的指定字段进行字符串连接，把多行数据变成单行数据</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sex,<span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> sex <span class="kw">WITH</span> <span class="kw">ROLLUP</span>; <span class="co">-- 回溯统计</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> city,sex,<span class="fu">count</span>(<span class="op">*</span>),group_concat(name) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> city,sex <span class="kw">WITH</span> <span class="kw">ROLLUP</span>; <span class="co">-- 多字段分组+回溯统计</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">ORDER</span> <span class="kw">BY</span> name <span class="kw">DESC</span>; <span class="co">-- 排序（ASC、DESC）</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">ORDER</span> <span class="kw">BY</span> city,name <span class="kw">DESC</span>; <span class="co">-- 多字段排序，这里是city升序、name降序</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- WHERE是从磁盘读一条记录，判断是否满足，不满足直接丢弃，从而保证加载到内存中的都是有效数据</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">&lt;=</span><span class="dv">5</span>; <span class="co">-- 条件，可以使用&gt;、&lt;、=、&gt;=、&lt;=、、!=（不等于，旧标准）、&lt;&gt;（不等于，新标准）</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">BETWEEN</span> <span class="dv">10</span> <span class="kw">AND</span> <span class="dv">20</span>; <span class="co">-- BETWEEN TO 是闭区间，且左边的数要小于右边的</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;小%&#39;</span>;</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> name <span class="kw">IS</span> <span class="kw">NULL</span>;</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">IN</span> (<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>);</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">&lt;=</span><span class="dv">5</span> <span class="kw">AND</span> name <span class="kw">NOT</span> <span class="kw">LIKE</span> <span class="st">&#39;小%&#39;</span>; <span class="co">-- 使用NOT、AND、OR组合多种条件，优先级：NOT &gt; AND &gt; OR</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">IN</span> (<span class="kw">SELECT</span> mid <span class="kw">FROM</span> mytable2 <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;%小%&#39;</span>); <span class="co">-- 使用子查询</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="kw">SELECT</span> mid <span class="kw">FROM</span> mytable2 <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;%小%&#39;</span> <span class="kw">LIMIT</span> <span class="dv">1</span>;</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">&gt;</span> <span class="kw">ALL</span>(<span class="kw">SELECT</span> mid <span class="kw">FROM</span> mytable2); <span class="co">-- 使用IN（返回TRUE或FALSE，但如果含NULL，会返回UNKNOWN）、EXISTS（返回TRUE或FALSE，可以处理NULL）、ANY（满足任意一个，要和=或!=或&lt;&gt;一起使用，比如 xxxx=ANY(xxx)）、SOME（some是any的别名，用的比较少，也要和=或!=或&lt;&gt;一起使用）、ALL（ALL必须与比较操作符一起使用，&lt;&gt;ALL等同于NOT IN）</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> (age,height) <span class="op">=</span> (<span class="kw">SELECT</span> <span class="fu">max</span>(age),<span class="fu">max</span>(height) <span class="kw">FROM</span> mytable2); <span class="co">-- 返回单行时可以这样用</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> (age,height) <span class="kw">IN</span> (<span class="kw">SELECT</span> age,height <span class="kw">FROM</span> mytable2); <span class="co">-- 返回多行时可以这样用</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> (<span class="dv">1</span>,<span class="dv">2</span>) <span class="op">=</span> (<span class="kw">SELECT</span> mid,mname <span class="kw">FROM</span> mytable2 <span class="kw">WHERE</span> mid<span class="op">=</span><span class="dv">2</span>); <span class="co">-- (1,2)即第1、2列</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> (<span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable2) <span class="kw">AS</span> derived_table <span class="kw">WHERE</span> derived_table.<span class="kw">id</span> <span class="op">&gt;</span> <span class="dv">5</span>; <span class="co">-- 派生表，从返回的结果中再次执行查询</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">AS</span> my_id,name <span class="kw">FROM</span> mytable <span class="kw">HAVING</span> my_id<span class="op">&gt;</span><span class="dv">3</span>; <span class="co">-- HAVING可以使实现WHERE的所有功能</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> city,<span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> city <span class="kw">HAVING</span> <span class="fu">count</span>(<span class="op">*</span>)<span class="op">&gt;=</span><span class="dv">2</span>; <span class="co">-- 但WHERE不能实现HAVING的部分功能，比如：HAVING可以使用别名、统计函数，如果和GROUP BY一起使用，HAVING可以过滤分组的结果</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> city,<span class="fu">count</span>(<span class="op">*</span>) <span class="kw">AS</span> total <span class="kw">FROM</span> mytable1 <span class="kw">GROUP</span> <span class="kw">BY</span> city <span class="kw">HAVING</span> total<span class="op">&gt;=</span><span class="dv">2</span>; <span class="co">-- 优化：不需要重复查询两次count(*)，可以使用别名</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">LIMIT</span> <span class="dv">1</span>,<span class="dv">5</span>; <span class="co">-- 分页，第1页，每页5条，即第6~10条记录</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">LIMIT</span> <span class="dv">5</span>; <span class="co">-- 相当于LIMIT 0,5</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">LIMIT</span> <span class="dv">96</span>,<span class="op">-</span><span class="dv">1</span>; <span class="co">-- 检索96~last</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>,name <span class="kw">FROM</span> mytable <span class="kw">UNION</span> <span class="kw">SELECT</span> <span class="kw">id</span>,name <span class="kw">FROM</span> mytable2; <span class="co">-- 联合查询，把多条查询的得到的多个结果集合并成一个结果集，要求两个查询必须拥有相同数量的列，但列的数据类型不需要一致，且顺序必须相同</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">id</span>,name <span class="kw">FROM</span> mytable <span class="kw">UNION</span> <span class="kw">ALL</span> <span class="kw">SELECT</span> <span class="kw">id</span>,name <span class="kw">FROM</span> mytable2; <span class="co">-- UNION会自动去重，要想不去重，使用UNION ALL</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>(<span class="kw">SELECT</span> <span class="kw">id</span>,name,sex <span class="kw">FROM</span> mytable <span class="kw">ORDER</span> <span class="kw">BY</span> sex <span class="kw">DESC</span> <span class="kw">LIMIT</span> <span class="dv">999</span>) <span class="kw">UNION</span> (<span class="kw">SELECT</span> <span class="kw">id</span>,name,sex <span class="kw">FROM</span> mytable2 <span class="kw">ORDER</span> <span class="kw">BY</span> sex <span class="kw">ASC</span> <span class="kw">LIMIT</span> <span class="dv">999</span>); <span class="co">-- 联合查询使用ORDER BY需要用括号括起来，但这样ORDER BY并不会生效，要使ORDER BY生效，还有搭配LIMIT使用（可以LIMIT一个足够大的数来实现不限制记录数）</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t1.<span class="kw">id</span>,t1.name,t2.<span class="kw">id</span> id2,t2.name name2 <span class="kw">FROM</span> mytable t1 <span class="kw">JOIN</span> mytable2 t2 <span class="kw">ON</span> t1.<span class="kw">id</span><span class="op">=</span>t2.<span class="kw">id</span> <span class="kw">WHERE</span> name <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span>; <span class="co">-- 连接查询，JOIN分为CROSS JOIN（交叉连接）、JOIN（内连接）、LEFT JOIN（左外连接）、RIGHT JOIN（右外连接）</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t1.<span class="op">*</span>,t2.<span class="op">*</span> <span class="kw">FROM</span> mytable t1 <span class="kw">JOIN</span> mytable2 t2 <span class="kw">WHERE</span> t1.<span class="kw">id</span><span class="op">=</span>t2.<span class="kw">id</span>; <span class="co">-- ON可以用WHERE替代，但WHERE效率会低一点</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> t1.<span class="op">*</span>,t2.<span class="op">*</span> <span class="kw">FROM</span> mytable t1 <span class="kw">JOIN</span> mytable2 t2 <span class="kw">USING</span>(<span class="kw">id</span>); <span class="co">-- USING(id)相当于ON t1.id=t2.id</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">CROSS</span> <span class="kw">JOIN</span> mytable2; <span class="co">-- CROSS JOIN</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable,mytable2; <span class="co">-- CROSS JOIN也可以写成这样，其实就是前面提到的多数据源</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">NATURAL</span> <span class="kw">JOIN</span> mytable2; <span class="co">-- NATURAL JOIN 会自动根据相同的列名JOIN，并合并同名列，如果有多个同名列，会同时JOIN多个列</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="co">-- 更新数据</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> mytable <span class="kw">SET</span> name<span class="op">=</span><span class="st">&#39;小明&#39;</span>;</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> mytable <span class="kw">SET</span> name<span class="op">=</span><span class="st">&#39;小明&#39;</span> <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;小%&#39;</span> <span class="kw">LIMIT</span> <span class="dv">3</span>;</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除数据</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">2</span>;</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除表中所有数据（自增长不会重置）</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除表中所有数据并重置自增长</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="kw">TRUNCATE</span> mytable;</span></code></pre></div>
<h4 id="视图操作">视图操作</h4>
<p>视图就是虚拟表，它可以通过封装SQL语句，定义对外访问的字段，而隐藏关键的字段，也可以简化复杂的查询，视图不会真正存储数据，它只是定义了表结构，真正的数据仍然是存在于数据表中</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 创建视图</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> myview <span class="kw">AS</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable; <span class="co">-- 单表视图，其中AS不能省略</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> myview2 <span class="kw">AS</span> <span class="kw">SELECT</span> t1.<span class="op">*</span>,t2.name,t2.sex <span class="kw">FROM</span> mytable t1 <span class="kw">LEFT</span> <span class="kw">JOIN</span> mytable2 t2 <span class="kw">ON</span> t1.other_id <span class="op">=</span> t2.<span class="kw">id</span>; <span class="co">-- 多表视图。字段名不能重复，如果有重复，需使用别名</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 视图就是一个虚拟表（但是它不存储数据，只是定义了表结构），表的所有查看方式都能用于视图</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLES</span> myview;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TABLES</span> <span class="kw">LIKE</span> <span class="st">&#39;my%&#39;</span>;</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> myview;</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- 视图也有自己特有的查看方式</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">VIEW</span> myview;</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用视图主要是为了查询方便，可以自动执行定义时指定的SQL</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> myview;</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- 多表视图不能增和删里面的数据，只有单表视图才可以（要求视图包含的所有字段都允许为NULL或者有默认值），这时会往基表增或删数据而不是往视图中增或删，因为视图不存储数据</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> myview <span class="kw">VALUES</span>(<span class="kw">null</span>,<span class="dv">180</span>,<span class="dv">150</span>,<span class="dv">1</span>);</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span> myview <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- 无论单表还是多表视图，都可以修改里面的数据</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> myview2 <span class="kw">SET</span> other_id<span class="op">=</span><span class="dv">3</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 如果在创建视图时指定了WITH CHECK OPTION，修改视图数据时就要保证修改后数据仍然能被视图查出来（即修改不能影响总记录数）</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> myview3 <span class="kw">AS</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable2 <span class="kw">WHERE</span> age<span class="op">&gt;</span><span class="dv">20</span> <span class="kw">WITH</span> <span class="kw">CHECK</span> <span class="kw">OPTION</span>; <span class="co">-- 禁止视图将age设置为小于20</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- 如果修改数据使其变为视图的查询范围，不会提示ERROR，但是修改无效（即只能更新视图中可以查询到的数据）</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 找不到id=6的数据，WHERE没有任何匹配，所以没有UPDATE任何记录，但不会报错</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> myview3 <span class="kw">SET</span> age<span class="op">=</span><span class="dv">23</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">6</span>; <span class="co">-- 假设原来age&lt;=20，无法通过视图查询到</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 修改视图</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">VIEW</span> myview <span class="kw">AS</span> <span class="kw">SELECT</span> t1.height,t1.age,t2.name,t2.sex <span class="kw">FROM</span> mytable t1 <span class="kw">LEFT</span> <span class="kw">JOIN</span> mytable2 t2 <span class="kw">ON</span> t1.other_id <span class="op">=</span> t2.<span class="kw">id</span>;</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除视图，删除视图不会影响数据</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">VIEW</span> myview;</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- 视图的算法</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">视图的算法分为</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">UNDEFINED: 未定义（默认），系统自动选择下面的一种</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">TEMPTABLE: 临时表算法，系统先执行视图的SELECT，后执行外部的查询语句，当外部查询的子句比内部查询优先级低，需要使用该算法，比如内部使用了ORDER BY，而外部使用了GROUP BY，而GROUP BY会对分组后合并的结果进行排序，GROUP BY优先级比ORDER BY低，就要使用TEMPTABLE算法（其他情况默认即可）</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">MERGE: 合并算法，系统先把视图的SELECT和外部的查询语句进行合并，然后执行（效率高，因为只执行了一次）</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">-- 先ORDER BY然后GROUP BY</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> ALGORITHM<span class="op">=</span>TEMPTABLE <span class="kw">VIEW</span> myview <span class="kw">AS</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">ORDER</span> <span class="kw">BY</span> height <span class="kw">DESC</span>;</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> myview <span class="kw">GROUP</span> <span class="kw">BY</span> age; <span class="co">-- GROUP BY会选取不同age的第一条记录，这里就是选区不同年龄的最高身高</span></span></code></pre></div>
<h4 id="事务">事务</h4>
<p>事务的原理是把操作保存到事务日志里，只有当COMMIT的时候再写入数据库，当ROLLBACK就会清空事务日志，使操作失效。在事务中返回的结果都是经过事务日志加工的，所以在当前session中可以看到对数据的修改，但其他session不会读到未提交的记录</p>
<p>InnoDB引擎默认是行锁，但如果更改数据时没有用到索引（普通索引、主键索引、唯一索引、组合索引、全文索引）的字段，就会全文检索，升级为表锁，即另一session会阻塞至当前session提交或回滚后才能完成提交</p>
<p>事务隔离级别可以在<code>my.ini</code>通过<code>transaction-isolation</code>设置，有以下隔离级别</p>
<ul>
<li>READ-UNCOMMITTED</li>
<li>READ-COMMITTED</li>
<li>REPEATABLE-READ</li>
<li>SERIALIZABLE</li>
</ul>
<p>也可以通过命令行设置<code>SET [GLOBAL | SESSION] TRANSACTION ISOLATION LEVEL &lt;isolation-level&gt;</code>，isolation-level可以是<code>READ UNCOMMITTED</code>、<code>READ COMMITTED</code>、<code>REPEATABLE READ</code>、<code>SERIALIZABLE</code></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 设置隔离级别</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">TRANSACTION</span> <span class="kw">ISOLATION</span> <span class="kw">LEVEL</span> <span class="kw">READ</span> <span class="kw">COMMITTED</span>;</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- 手动事务</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 开启事务（两种方式都是等价的）</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span>;</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- 创建事务保存点，一个事务中可以有多个SAVEPOINT</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SAVEPOINT</span> <span class="kw">identifier</span>;</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除一个事务的保存点</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>RELEASE <span class="kw">SAVEPOINT</span> <span class="kw">identifier</span>;</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- 回滚到保存点</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span> <span class="kw">TO</span> <span class="kw">identifier</span>;</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- 提交事务（两种方式都是等价的）</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>;</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span> <span class="kw">WORK</span>;</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- 回滚（两种方式都是等价的）</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span>;</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="kw">ROLLBACK</span> <span class="kw">WORK</span>;</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 自动事务</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">-- 默认开启自动事务</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>SHOW VARIABLES <span class="kw">LIKE</span> <span class="st">&#39;autocommit&#39;</span>;</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 关闭自动事务（本次session有效）</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>这时每次修改数据都需要手动提交</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> mytable <span class="kw">SET</span> money<span class="op">=</span><span class="dv">1000</span> <span class="kw">WHERE</span> <span class="kw">id</span><span class="op">=</span><span class="dv">1</span>;</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="kw">COMMIT</span>; <span class="co">-- COMMIT或者ROLLBACK</span></span></code></pre></div>
<h4 id="字符集校对集操作">字符集、校对集操作</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看所有支持的字符集</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>SHOW <span class="dt">CHARACTER</span> <span class="kw">SET</span>;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看默认字符集</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>SHOW VARIABLES <span class="kw">LIKE</span> <span class="st">&#39;character_set%&#39;</span>;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- SET的更改只是当前会话有效，重新登陆命令行失效</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- 服务器端的编码是gbk，而数据库的编码是utf8，于是设置client的编码为gbk，接收到数据后会自动转成utf8</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- GBK两个字节一个汉字，UTF8三个字节一个汉字（英文和其他字符可能会优化成1~3个字节）</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> character_set_client<span class="op">=</span>gbk;</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- 设置返回的数据的编码为gbk</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> character_set_results<span class="op">=</span>gbk;</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 设置字符集的快捷方式，相当于设置了character_set_client、character_set_results、character_set_connection</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- character_set_connection是中间转码的字符集，配置能提高效率，但不配置也不影响使用</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> NAMES gbk;</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">校对集分为：</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">_bin: binary，二进制比较</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">_cs: case sensitive，大小写敏感</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">_ci: case insensitive，大小写不敏感</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看所有的校对集</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>SHOW COLLATION;</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 在建表的时候指定校对集</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>name <span class="dt">char</span>(<span class="dv">2</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8 COLLATE utf8_general_ci</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- 校对集在比较的时候生效，比如ORDER BY</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="st">&#39;a&#39;</span>),(<span class="st">&#39;A&#39;</span>),(<span class="st">&#39;B&#39;</span>),(<span class="st">&#39;b&#39;</span>);</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">ORDER</span> <span class="kw">BY</span> name;</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- 校对集只能在没有数据之前声明好，如果有了数据，那么修改对之前的数据无效</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable COLLATE<span class="op">=</span>utf8_bin;</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看警告</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>SHOW warnings;</span></code></pre></div>
<h4 id="备份还原">备份还原</h4>
<p>方式一：使用OUTFILE进行单表备份，这种备份只能备份数据，不能备份表结构，导入时需有相同的表结构才能导入</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 备份表</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">INTO</span> OUTFILE <span class="st">&#39;~/backup/mytable&#39;</span> <span class="kw">FROM</span> mytable; <span class="co">-- &quot;*&quot;也可以改成想备份的字段</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- 可以指定导出的数据格式</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">INTO</span> OUTFILE <span class="st">&#39;~/backup/mytable&#39;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dt">CHARACTER</span> <span class="kw">SET</span> utf8</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>FIELDS TERMINATED <span class="kw">BY</span> <span class="st">&#39;|&#39;</span> OPTIONALLY ENCLOSED <span class="kw">BY</span> <span class="st">&#39;&quot;&#39;</span> ESCAPED <span class="kw">BY</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span> <span class="co">-- 字段间用竖线分隔（默认为制表符&#39;\t&#39;），使用双引号包裹数据（默认不包裹），特殊符号用&#39;\\&#39;处理（默认是&#39;\\&#39;）</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>LINES STARTING <span class="kw">BY</span> <span class="st">&#39;START:&#39;</span> TERMINATED <span class="kw">BY</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="co">-- 每行以START:开始，以换行符结束</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> mytable;</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- 还原</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>LOAD <span class="kw">DATA</span> INFILE <span class="ot">&quot;~/backup/mytable&quot;</span> <span class="kw">INTO</span> <span class="kw">TABLE</span> mytable;</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 如果备份时指定了格式，还原时也要指定相同的格式</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>LOAD <span class="kw">DATA</span> INFILE <span class="ot">&quot;~/backup/mytable&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">INTO</span> <span class="kw">TABLE</span> mytable</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="dt">CHARACTER</span> <span class="kw">SET</span> utf8</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>FIELDS TERMINATED <span class="kw">BY</span> <span class="st">&#39;|&#39;</span> OPTIONALLY ENCLOSED <span class="kw">BY</span> <span class="st">&#39;&quot;&#39;</span> ESCAPED <span class="kw">BY</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>LINES STARTING <span class="kw">BY</span> <span class="st">&#39;START:&#39;</span> TERMINATED <span class="kw">BY</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span>;</span></code></pre></div>
<p>方法二：使用mysqldump工具，这种备份可以备份数据和表结构，该工具在mysql的bin目录下，用法如下</p>
<pre class="shell"><code>mysqldump -uroot -pPassword mydatabase1 &gt; backup_file

# 只备份表结构
mysqldump -uroot -pPassword --no-data --databases mydatabase1 mydatabase2 mydatabase3 &gt; backup_file

# 备份指定数据库中的所有表
mysqldump -uroot -pPassword --all-databases &gt; backup_file

# 跨主机备份，把host1的指定数据库备份到host2中
mysqldump -uroot -pPassword --host=host1 --opt sourceDb | mysql --host=host2 -C targetDb

# 恢复
mysql -uroot -pPassword mydatabase1 &lt; backup_file

# 通过mysql命令行的source命令恢复
mysql -uroot -pPassword
mysql&gt; SOURCE backup_file;</code></pre>
<h3 id="数据类型">数据类型</h3>
<h4 id="字符串">字符串</h4>
<p>字符串分为：</p>
<ul>
<li>CHAR(L):
定长字符串，长度不够会补空字符’’，L为最大字符数，最大不能超过255（字节数按编码确定，实际存储大小=字符数*一个字符所占字节数）</li>
<li>VARCHAR(L):
变长字符串，最大长度固定，如果没有达到最大长度，则按实际数据的长度存储；理论上最多可以存储65535个字符，但一般会预留1到2个字节来记录存储的实际长度（长度在255内用1个字节，255以上用2个字节），而且由于MYSQL规定一条记录的最大长度位65535个字节，所以<code>VARCHAR</code>不可能达到理论长度（<code>实际存储大小(最大为记录长度限制的65535个字节)=字符数*一个字符所占字节数(由编码决定)+预留长度</code>，UTF8下最大字符数为21844，GBK下为32766，这里<code>21844*3+2=65534</code>，要用完65535，可以在前面加一个<code>TINYINT</code>字段，但是如果有任意一个字段可以为NULL，系统会使用一个字节来保存NULL值，所以要用完65535就不能有可NULL字段）</li>
<li>TEXT:
文本，当字符串长度超过255，建议使用<code>TEXT</code>存储，它又分为<code>TINYTEXT</code>、<code>TEXT</code>、<code>MEDIUMTEXT</code>、<code>LONGTEXT</code>，TEXT只占10个字节，用于保存数据的地址和长度，真实数据不会存储在当前表中</li>
<li>BLOB:
当二进制数据长度超过255，建议使用<code>BLOB</code>存储，但是实际开发中更常用的是存储文件路径而不是直接把文件存入数据库</li>
<li>ENUM:
枚举，单选，最多不能超过65535个枚举选项量，可以规范数据格式和节省空间，因为枚举在内部存储的是数值而不是字符串本身（插入时可以插入枚举选项或者直接插入数字）</li>
<li>SET:
集合，和枚举不同的是，可以插入时同时使用多个集合选项，选项间用逗号分隔，而且可以不按顺序（最后会转成定义时的顺序），内部使用二进制数记录，被选中的位为1，否则为0，然后再把高低位倒过来（插入时可以插入集合选项或数字）</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>s1 <span class="dt">CHAR</span>(<span class="dv">20</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>s2 <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>s3 TEXT,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>s4 <span class="dt">BLOB</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>s5 ENUM(<span class="st">&#39;男&#39;</span>,<span class="st">&#39;女&#39;</span>,<span class="st">&#39;保密&#39;</span>)，</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>s6 <span class="kw">SET</span>(<span class="st">&#39;北京&#39;</span>,<span class="st">&#39;上海&#39;</span>,<span class="st">&#39;广州&#39;</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;男&#39;</span>,<span class="st">&#39;上海,北京&#39;</span>);</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- enum: 1对应&#39;男&#39;，set: 3对应二进制为011，倒过来是110，所以对应是插入&#39;北京,上海&#39;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="st">&#39;ABCD&#39;</span>,<span class="dv">1</span>,<span class="dv">3</span>);</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- VARCHAR的实际最大长度受MYSQL中规定的最大记录长度为65535限制</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>i1 TINYINT <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- 1</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>s2 <span class="dt">VARCHAR</span>(<span class="dv">21844</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- 21844*3+2=65534，UTF8一个字符最多占3个字节，分配空间是按最多的算的</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- ENUM实际存储的是数值而不是字符串本身</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 原理：</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">1</span> <span class="op">+</span> <span class="st">&#39;hello&#39;</span>; <span class="co">-- 得到1</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dv">1</span> <span class="op">+</span> <span class="st">&#39;1hello&#39;</span>; <span class="co">-- 得到2，和PHP的自动转换类似，不以数字开头的字符串会自动转成0</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 验证：如果s5是字符串，那么字符串+0结果还是0，如果是数值，那么结果会是其他数字；为了对比，我们也把原来的s5查出来</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> s5 <span class="op">+</span> <span class="dv">0</span>, s5 <span class="kw">FROM</span> mytable;</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- SET同理</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> s6 <span class="op">+</span> <span class="dv">0</span>, s6 <span class="kw">FROM</span> mytable;</span></code></pre></div>
<h4 id="整型">整型</h4>
<p>整型分为：</p>
<ul>
<li>TINYINT:
迷你整型，用一个字节存储，表示的状态最多为256种（有符号-128<sub>127，无符号0</sub>256）</li>
<li>SMALLINT: 小整型，用两个字节存储，表示的状态最多为65535种</li>
<li>MEDIUMINT: 中整型，用三个字节存储</li>
<li>INT/INTEGE: 标准整型，使用4个字节存储</li>
<li>BIGINT: 大整型，使用8个字节存储</li>
</ul>
<p>以上类型默认都是有符号的，要使用无符号类型，使用<code>UNSIGNED</code>声明</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>int_1 TINYINT,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>int_2 <span class="dt">SMALLINT</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>int_3 MEDIUMINT</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>int_4 <span class="dt">INT</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用无符号类型</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>int_5 <span class="dt">INT</span> UNSIGNED,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- 括号中的数字为显示宽度，比如TINYINT默认是4位，因为对于无符号的TINYINT，可以是-127，即包含了符号位</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- 显示宽度和存储的大小无关，更改显示宽度不会影响存储大小</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>int_6 <span class="dt">INT</span>(<span class="dv">11</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- 显示宽度一般配合ZEORFILL使用，ZEORFILL表示没有达到显示宽度的时候补零（达到或超过显示宽度正常显示），一旦使用了ZEORFILL，会自动把数据改为UNSIGNED</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>int_7 <span class="dt">INT</span>(<span class="dv">8</span>) ZEORFILL,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>int_8 BIGINT</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span></code></pre></div>
<h4 id="小数">小数</h4>
<p>小数类型分为：</p>
<ul>
<li>浮点型:
小数点浮动，精度有限，整数部分不能超出指定的长度（总长度-小数长度）（系统对小数四舍五入后超出指定长度是可以的，但人为插入时不能超过指定长度），小数部分如果超出指定小数的长度后会四舍五入，会丢失精度
<ul>
<li>FLOAT(M,D):
单精度，用四个字节存储，精度范围大概为7为左右，M为总长度，D为小数长度</li>
<li>DOUBLE(M,D): 双精度，用八个字节存储，精度范围大概为15为左右</li>
</ul></li>
<li>定点型:
小数点固定，精度固定，几乎不会丢失精度（一般不会用到那么高的精度），整数部分不能超出指定的长度（进位也不可以），小数部分如果超出指定小数的长度后会四舍五入
<ul>
<li>DECIMAL(M,D):
变长，大致是每9个数字用4个字节存储，整数和小数分开计算，M最多为65，D最多为30，默认是10,2</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- 不使用小数位</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>f1 <span class="dt">FLOAT</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- 需要指定总长度（包括整数部分和小数部分，不包括小数点）和小数精度</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>f2 <span class="dt">FLOAT</span>(<span class="dv">10</span>,<span class="dv">2</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>d1 <span class="dt">DECIMAL</span>(<span class="dv">10</span>,<span class="dv">2</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span></code></pre></div>
<h4 id="日期时间">日期时间</h4>
<p>日期时间类型分为：</p>
<table>
<colgroup>
<col style="width: 7%" />
<col style="width: 16%" />
<col style="width: 52%" />
<col style="width: 6%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr>
<th>类型</th>
<th>显示格式</th>
<th>取值</th>
<th>存储空间</th>
<th>零值</th>
</tr>
</thead>
<tbody>
<tr>
<td>DATETIME</td>
<td>yyyy-MM-dd HH:mm:ss</td>
<td>1000-01-01 00:00:00到9999-12-31 23:59:59</td>
<td>八个字节</td>
<td>0000-00-00 00:00:00</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>yyyy-MM-dd HH:mm:ss</td>
<td>1970-01-01 00:00:00到2038-01-19 03:14:07</td>
<td>四个字节</td>
<td>0000-00-00 00:00:00</td>
</tr>
<tr>
<td>DATE</td>
<td>yyyy-MM-dd</td>
<td>1000-01-01到9999-12-31</td>
<td>三个字节</td>
<td>0000-00-00</td>
</tr>
<tr>
<td>TIME</td>
<td>HH:mm:ss</td>
<td>-838:59:59到838:59:59</td>
<td>三个字节</td>
<td>00:00:00</td>
</tr>
<tr>
<td>YEAR</td>
<td>yyyyy</td>
<td>有两种形式：YEAR(2)表示从1970到2069年；YEAR(4)表示从1901到2155年，YEAR(4)为默认值</td>
<td>一个字节</td>
<td>0000</td>
</tr>
</tbody>
</table>
<p>比如</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>d1 DATETIME,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>d2 <span class="dt">TIMESTAMP</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>d3 <span class="dt">DATE</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>d4 <span class="dt">TIME</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>d5 <span class="dt">YEAR</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1900-01-02 01:02:03&#39;</span>,<span class="st">&#39;1970-01-02 01:02:03&#39;</span>,<span class="st">&#39;1900-01-02&#39;</span>,<span class="st">&#39;01:02:03&#39;</span>,<span class="dv">1901</span>);</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1900-01-02 01:02:03&#39;</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1970-01-02 01:02:03&#39;</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1900-01-02&#39;</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- -2表示过去两天，所以实际上是 -(48小时+01:02:03)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;-2 01:02:03&#39;</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用2位的YEAR，插入后变成2069</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="dv">69</span>);</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1900-01-02 01:02:03&#39;</span>,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1970-01-02 01:02:03&#39;</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;1900-01-02&#39;</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;01:02:03&#39;</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用2位的YEAR，插入后变成1970</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="dv">70</span>);</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- TIMESTAMP只要所在记录被更新，就会自动更新成当前的时间</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="kw">UPDATE</span> mytable <span class="kw">SET</span> d1<span class="op">=</span><span class="st">&#39;1900-00-00 00:00:00&#39;</span> <span class="kw">WHERE</span> d5<span class="op">=</span><span class="dv">1970</span>;</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看当前时间</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> unix_timestamp();</span></code></pre></div>
<h3 id="列属性">列属性</h3>
<p>列属性有：</p>
<ul>
<li>NULL/NOT NULL: 可空/非空约束</li>
<li>DEFAULT: 默认值</li>
<li>COMMENT: 注释，不同于其他注释，该注释会保存在建表语句中</li>
<li>PRIMARY KEY: 主键</li>
<li>AUTO_INCREMENT: 自增长，一个表只能有一个自增长的字段</li>
<li>UNIQUE KEY: 唯一约束</li>
<li>FOREIGN KEY: 外键</li>
</ul>
<p>用法</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- 参与业务的主键（如姓名等）称为业务主键/自然主键，不参与业务只用于唯一标识数据的主键称为逻辑主键</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- AUTO_INCREMENT只能有一个，一般配合PRIMARY KEY使用，类型一定是整型</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span> <span class="kw">COMMENT</span> <span class="st">&#39;姓名&#39;</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>gender <span class="dt">CHAR</span>(<span class="dv">6</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="st">&#39;male&#39;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">-- COMMENT可以这样查看</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable;</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 设置主键</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者追加主键，这时要求字段对应的数据不能重复</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">MODIFY</span> <span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>;</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 联合主键</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>,name)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>,name);</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- 主键无法更改，只能先删除再创建</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">DROP</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>;</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- 自增长的主键传null或DEFAULT或不传都会触发自动增长</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- 传入DEFAULT或不传该字段的值会使用默认值</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="kw">null</span>,<span class="st">&#39;小明&#39;</span>,<span class="kw">DEFAULT</span>);</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="kw">DEFAULT</span>,<span class="st">&#39;小明&#39;</span>,<span class="kw">DEFAULT</span>);</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable(name) <span class="kw">VALUES</span>(<span class="st">&#39;小明&#39;</span>);</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co">-- 自增长如果传入值则不会触发，下次会从最大值继续+1</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="dv">10</span>,<span class="st">&#39;小明&#39;</span>,<span class="kw">DEFAULT</span>);</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- 修改自增长的值，该值只能比当前自增长的值大，不能小（小了不会报错，但修改无效）</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable AUTO_INCREMENT<span class="op">=</span><span class="dv">10</span>;</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看自增长，可以修改起始值和步长，该修改是对整个数据库修改，通过SET修改是会话级的</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>SHOW VARIABLES <span class="kw">LIKE</span> <span class="st">&#39;auto_increment%&#39;</span>;</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> auto_increment_increment<span class="op">=</span><span class="dv">2</span>;</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除自增长就是MODIFY列的时候不写AUTO_INCREMENT</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="co">-- 有主键的时候不需要再声明主键，因为主键的声明不是在列后面的，而是通过PRIMARY KEY(id)在最后设置的（可以通过SHOW CREATE TABLE mytable查看）</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">MODIFY</span> <span class="kw">id</span> <span class="dt">INT</span>;</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">-- UNIQUE KEY和PRIMARY KEY类似</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- UNIQUE KEY允许为NULL，NULL不参与唯一性比较</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="kw">UNIQUE</span> <span class="kw">KEY</span>(<span class="kw">id</span>,name)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者追加唯一键</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">UNIQUE</span> <span class="kw">KEY</span>(<span class="kw">id</span>,name);</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除UNIQUE KEY约束</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a><span class="co">-- name实际上是索引名，唯一键的索引名默认是列名</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">DROP</span> <span class="kw">INDEX</span> name; <span class="co">-- 这里不是删除列，只是删除唯一性约束</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看索引</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="co">-- FOREIGN KEY和PRIMARY KEY类似，只能使用其他表的主键来作为外键</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span>,</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>other_id <span class="dt">INT</span>,</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a><span class="kw">FOREIGN</span> <span class="kw">KEY</span>(other_id) <span class="kw">REFERENCES</span> mytable2(<span class="kw">id</span>);</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者通过追加方式</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">FOREIGN</span> <span class="kw">KEY</span>(other_id) <span class="kw">REFERENCES</span> mytable2(<span class="kw">id</span>);</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a><span class="co">-- 追加外键的同时指定外键的名字为id_1，也可以使用IF NOT EXISTS，括号可以写在一起也可以分开</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> `mytable` <span class="kw">ADD</span> <span class="kw">CONSTRAINT</span> `id_1` <span class="kw">FOREIGN</span> <span class="kw">KEY</span> <span class="cf">IF</span> <span class="kw">NOT</span> <span class="kw">EXISTS</span> (`other_id`) <span class="kw">REFERENCES</span> `mytable2` (`id`);</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a><span class="co">-- 外键的约束模式</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a><span class="co">-- 严格模式（RESTRICT），默认；RESTRICT和NO ACTION作用是一样的，父表在删除和更新记录并涉及到主键时，检查字表是否有关联的外键记录，如果有则不允许删除或更新（子表就是含外键的表）</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span>,</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>other_id <span class="dt">INT</span>,</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a><span class="kw">FOREIGN</span> <span class="kw">KEY</span>(other_id) <span class="kw">REFERENCES</span> mytable2(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">NO</span> ACTION <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="kw">NO</span> ACTION;</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a><span class="co">-- 置空（SET NULL），当父表更新、删除并涉及到主键时，子表会把外键字段置为NULL，此时要求字段可NULL</span></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span>,</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>other_id <span class="dt">INT</span>,</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a><span class="kw">FOREIGN</span> <span class="kw">KEY</span>(other_id) <span class="kw">REFERENCES</span> mytable2(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">SET</span> <span class="kw">NULL</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="kw">SET</span> <span class="kw">NULL</span>;</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a><span class="co">-- 级联（CASCADE），当父表更新、删除并涉及到主键时，子表会同步更新和删除</span></span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span>,</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>) <span class="kw">UNIQUE</span> <span class="kw">KEY</span>,</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>other_id <span class="dt">INT</span>,</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a><span class="kw">FOREIGN</span> <span class="kw">KEY</span>(other_id) <span class="kw">REFERENCES</span> mytable2(<span class="kw">id</span>) <span class="kw">ON</span> <span class="kw">DELETE</span> <span class="kw">CASCADE</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="kw">CASCADE</span>;</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除外键，需使用外键的名字，即通过ADD CONSTRAINT指定的名字</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">DROP</span> <span class="kw">FOREIGN</span> <span class="kw">KEY</span> id_1;</span></code></pre></div>
<h3 id="索引">索引</h3>
<p>索引分类</p>
<ol type="1">
<li>普通索引index: 加速查找</li>
<li>唯一索引
<ul>
<li>主键索引(primary key): 加速查找+约束（不为空且唯一）</li>
<li>唯一索引(unique): 加速查找+唯一约束</li>
</ul></li>
<li>联合索引
<ul>
<li>primary key(id,name): 联合主键索引</li>
<li>unique(id,name): 联合唯一索引</li>
<li>index(id,name): 联合普通索引</li>
</ul></li>
<li>全文索引(fulltext):
用于搜索很长一篇文章的时候，效果最好，只能在CHAR、VARCHAR、TEXT类型列上创建（MYSQL只有MYISAM存储引擎支持全文索引）</li>
<li>空间索引(spatial):
空间索引是对空间数据类型（GEOMETRY、POINT、LINESTRING、POLYGON）的字段建立的索引，要求字段为NOT
NULL（MYSQL只有MYISAM存储引擎支持空间索引）</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">创建方法：</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#方法一：创建表时</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">CREATE TABLE 表名 (</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">字段名1  数据类型 [完整性约束条件…],</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">字段名2  数据类型 [完整性约束条件…],</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">[UNIQUE | FULLTEXT | SPATIAL ] INDEX/KEY [索引名] (字段名[(长度)] [ASC |DESC]) </span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">);</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#方法二：CREATE在已存在的表上创建索引</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">CREATE  [UNIQUE | FULLTEXT | SPATIAL ] INDEX 索引名 ON 表名 (字段名[(长度)] [ASC |DESC]);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#方法三：ALTER TABLE在已存在的表上创建索引</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">ALTER TABLE 表名 ADD [UNIQUE | FULLTEXT | SPATIAL] INDEX 索引名 (字段名[(长度)]  [ASC |DESC]) ;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="kw">INDEX</span> nameindex (name) <span class="co">-- 索引的名字也可以不指定</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> name <span class="kw">ON</span> mytable(name);</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">UNIQUE</span> <span class="kw">INDEX</span> id_name <span class="kw">ON</span> mytable(<span class="kw">id</span>,name); <span class="co">-- 联合索引</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">INDEX</span> name (name(<span class="dv">4</span>)); <span class="co">-- 前面的name是索引名字，括号的name是列名，可以指定索引的长度（如果是BLOB或TEXT则必须指定，CHAR或VARCHAR可以不指定）</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- 插入初始数据</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> mytable <span class="kw">VALUES</span>(<span class="dv">1</span>,<span class="st">&#39;小明&#39;</span>), (<span class="dv">2</span>,<span class="st">&#39;小红&#39;</span>);</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看索引</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">INDEX</span> <span class="kw">FROM</span> mytable;</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- 分析SQL用到的索引</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> name <span class="kw">LIKE</span> <span class="st">&#39;%小%&#39;</span>\G</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">/*输出</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co">           id: 1</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co">  select_type: SIMPLE   -- 表示查询中每个select子句的类型（简单 或 复杂）</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="co">        table: mytable</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co">   partitions: NULL</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co">         type: index    -- 表示MySQL在表中找到所需行的方式，又称“访问类型”</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co">possible_keys: NULL     -- 可能使用到的索引（不一定真的会使用）</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co">          key: nameindex    -- 实际使用的索引，若没有使用索引，显示为NULL</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">      key_len: 63       -- 索引中使用的字节数</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co">          ref: NULL     -- 表示上述表的连接匹配条件，即哪些列或常量被用于查找索引列上的值</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">         rows: 2        -- 表示MySQL根据表统计信息及索引选用情况，估算的找到所需的记录所需要读取的行数</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">     filtered: 50.00</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Extra: Using where; Using index     -- 包含不适合在其他列中显示但十分重要的额外信息 如using where，using index</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="co">-- 删除索引</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">INDEX</span> name <span class="kw">ON</span> mytable;</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="co">-- 除此以外，还可以指定索引的查询方式，常用的有BTREE（二叉树结构，最常用）和HASH（只支持=、IN、&lt;&gt;，不支持范围查询；对于对于组合索引，只有使用了所有索引键时才会生效，因为是对所有组合键做HASH，少了无法匹配到；对于大量重复HASH的情况，效率不一定比BTREE高），不常用的有FULLTEXT（中文支持不是很好，MyISAM才支持）、RTREE（仅支持geometry数据类型）</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> mytable(</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> AUTO_INCREMENT,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">20</span>),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="kw">INDEX</span> nameindex (name) <span class="kw">USING</span> BTREE <span class="co">-- 索引的名字也可以不指定</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>)CHARSET utf8;</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> name <span class="kw">ON</span> mytable(name) <span class="kw">USING</span> BTREE;</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a><span class="co">-- 或者</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">INDEX</span> name <span class="kw">USING</span> BTREE; </span></code></pre></div>
<p><strong>生效原则</strong></p>
<p>单列索引:
多个单列索引同时被用到时，会自动选择其中一个（自动选择低重复度的字段）</p>
<p>联合索引:</p>
<ul>
<li>从前往后都要使用（全部用上就行，和书写顺序无关），如果中间某个索引没有使用，那么断点前面的索引部分起作用，断点后面的索引没有起作用</li>
<li>如果联合索引的某个部分使用模糊查询<code>Like</code>，范围查询<code>&gt;</code>、<code>&lt;</code>、<code>between</code>等，那么这个部分可以使用到该索引，但是其后面的部分就不能使用到该索引了</li>
</ul>
<p>假设a、b、c、d是联合索引</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> mytable <span class="kw">ADD</span> <span class="kw">INDEX</span> abc (a,b,c,d);</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> b<span class="op">=</span><span class="dv">45</span> <span class="kw">AND</span> a<span class="op">=</span><span class="dv">3</span> <span class="kw">AND</span> c<span class="op">=</span><span class="dv">5</span> <span class="kw">AND</span> d<span class="op">=</span><span class="dv">4</span>; <span class="co">-- 全部生效</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> a<span class="op">=</span><span class="dv">3</span> <span class="kw">and</span> c<span class="op">=</span><span class="dv">5</span>; <span class="co">-- a生效，c无效</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> b<span class="op">=</span><span class="dv">45</span> <span class="kw">AND</span> c<span class="op">=</span><span class="dv">5</span>; <span class="co">-- 全部无效</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> b<span class="op">=</span><span class="dv">45</span> <span class="kw">AND</span> a<span class="op">=</span><span class="dv">3</span> <span class="kw">AND</span> c<span class="op">=</span><span class="dv">5</span> <span class="kw">AND</span> d<span class="op">&gt;</span><span class="dv">4</span>; <span class="co">-- 全部生效</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> a<span class="op">=</span><span class="dv">3</span> <span class="kw">AND</span> b<span class="op">=</span><span class="dv">45</span> <span class="kw">AND</span> d<span class="op">=</span><span class="dv">4</span> <span class="kw">ORDER</span> <span class="kw">BY</span> c; <span class="co">-- a、b、c生效（正常order by使用EXPLAIN会在Extra中显示Using filesort，而这里没有，说明使用了c索引）</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> a<span class="op">=</span><span class="dv">3</span> <span class="kw">AND</span> d<span class="op">=</span><span class="dv">4</span> <span class="kw">ORDER</span> <span class="kw">BY</span> c,b; <span class="co">-- 注意ORDER BY c,b和ORDER BY b,c不同，这里只有a生效（同样可以通过EXPLAIN查看是否使用了Using temporary和Using filesort，使用了索引不需要）</span></span></code></pre></div>
<h3 id="程序">程序</h3>
<h4 id="变量">变量</h4>
<p>变量分为系统变量和自定义变量</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看所有系统变量</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>SHOW VARIABLES;</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看某个变量</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @@version,@@autocommit;</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- 会话级别修改</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @@autocommit<span class="op">=</span><span class="dv">0</span>;</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- 全局级别修改（其他新登陆的session也可以看到修改，但如果已登陆，无法看到修改）</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> <span class="kw">GLOBAL</span> autocommit <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- 自定义变量，自定义的变量都是当前session有效（不区分数据库），退出后清空</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- 系统为了区分系统变量和自定义变量，自定义变量只能使用一个@</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @name <span class="op">=</span> <span class="st">&#39;张三&#39;</span>;</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @name;</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- 等号在MYSQL中大多表示比较，而非赋值，MYSQL为了区分比较和赋值，定义了一个新的赋值符号:=</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @age <span class="op">:=</span> <span class="dv">18</span>;</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">-- 变量的定义或更改需要使用SET，使用SET系统就知道是赋值，这时既可以用=，又可以用:=</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @age <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @name <span class="op">:=</span> name <span class="kw">FROM</span> mytable; <span class="co">-- 从字段中取值赋给变量，此时只能用:=，不能用=；如果记录有多条，取最后一条（MYSQL不支持数组）</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> name,age <span class="kw">FROM</span> mytable <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">2</span> <span class="kw">INTO</span> @name,@age; <span class="co">-- 这种方式要求查询的记录只有一条</span></span></code></pre></div>
<h4 id="程序结构">程序结构</h4>
<p>只有<code>IF</code>和<code>WHILE</code></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">分支结构</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">IF xxx THEN</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">ELSE</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="re">END</span><span class="co"> IF;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">WHILE xxx DO</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="re">END</span><span class="co"> WHILE;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- 可以用ITERATE实现跳过此次循环，用LEAVE实现跳出循环，但是要用到循环名字</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">循环名字:WHILE xxx DO</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -- ITERATE 循环名字;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -- 或者</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -- LEAVE 循环名字;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="re">END</span><span class="co"> WHILE;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h4 id="触发器">触发器</h4>
<div class="sourceCode" id="cb18"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">一般定义如下：</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">CREATE TRIGGER 触发器名字 触发时间(BEFORE、AFTER) 事件类型(INSERT、DELETE、UPDATE) ON 表名 FOR EACH ROW</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER 自定义分隔符 -- 临时修改结束符，因为系统以结束符分隔SQL语句，而触发器内部需要用到多条语句，要是输入分号直接结束了SQL语句，就无法完整地定义一个触发器</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="re">BEGIN</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -- 触发器内容，以系统原来的结束符――分号（&quot;;&quot;）――结束</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    -- 触发器内部的语句不要再次触发当前触发器监听的事件，否则会导致死循环</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    -- 可以通过 old.字段名 或 new.字段名 获取当前的数据以及即将更新的数据</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="re">END</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">自定义的那个分隔符 -- 表示定义完触发器了</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER 系统原来的分隔符 -- 把结束符修正过来</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">一张表中每种 触发时间+触发类型 只能有一个触发器，即一张表最多只能有6个触发器</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> mytrigger <span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">ON</span> mytable <span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>DELIMITER $$ </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> money <span class="kw">FROM</span> mytable2 <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="kw">new</span>.wallet_id <span class="kw">INTO</span> @money;</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">IF</span> @money <span class="op">&gt;</span> <span class="kw">new</span>.price <span class="cf">THEN</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        UPADTE mytable2 <span class="kw">SET</span> money <span class="op">=</span> money <span class="op">-</span> <span class="kw">new</span>.price <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="kw">new</span>.wallet_id;</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ELSE</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- 触发器不能禁止插入/修改/删除，只能通过报错的方式使得操作失败</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> xxx <span class="kw">VALUES</span>(XXX); <span class="co">-- 不存在该表，所以保存，使得事务回滚，插入失败</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看触发器</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TRIGGERS</span>;</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">TRIGGERS</span> <span class="kw">LIKE</span> <span class="st">&#39;%trigger%&#39;</span>;</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">TRIGGER</span> mytrigger;</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">-- 所有的触发器都会保存在information_schema.triggers中</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> information_schema.<span class="kw">triggers</span>\G</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">-- 触发器无法修改，只能先删除再创建</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TRIGGER</span> mytrigger;</span></code></pre></div>
<h4 id="函数">函数</h4>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">一般定义如下</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER $$</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">CREATE FUNCTION 函数名(形参列表) RETURNS 返回值数据类型</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="re">BEGIN</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    RETURN xxx;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="re">END</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">$$</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER ;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">-- 只有一行的函数可以不写</span><span class="re">BEGIN</span><span class="co">、</span><span class="re">END</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> display100() RETURNS <span class="dt">INT</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="kw">RETURN</span> <span class="dv">100</span>;</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- 从1加到指定数</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>DELIMITER $$</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> sumTo(num <span class="dt">INT</span>) RETURNS <span class="dt">INT</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @i <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @ret <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">WHILE</span> @i <span class="op">&lt;=</span> num DO</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SET</span> @ret <span class="op">=</span> @ret <span class="op">+</span> @i;</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @i <span class="op">=</span> @i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">WHILE</span>;</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> @ret;</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co">-- 调用</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> display100();</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> sumTo(<span class="dv">100</span>);</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看函数</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">FUNCTION</span> STATUS;</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">FUNCTION</span> STATUS <span class="kw">LIKE</span> <span class="st">&#39;%display%&#39;</span>;</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">FUNCTION</span> display100;</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- 函数无法修改，只能先删除再创建</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">FUNCTION</span> display100;</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="co">-- 带@的都是全局变量，要定义局部变量，使用DECLARE关键字声明，且没有@符号，局部变量只能在函数体开头声明</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="co">-- 从1加到指定数，5的倍数不加</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>DELIMITER $$</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> sumTo(num <span class="dt">INT</span>) RETURNS <span class="dt">INT</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> i <span class="dt">INT</span> <span class="kw">DEFAULT</span> <span class="dv">1</span>;</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> ret <span class="dt">INT</span> <span class="kw">DEFAULT</span> <span class="dv">0</span>;</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>    mywhile<span class="ch">:WHILE</span> i <span class="op">&lt;=</span> num DO</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">IF</span> i % <span class="dv">5</span> <span class="op">=</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="co">-- 这里=是比较符号</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SET</span> i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        ITERATE mywhile;</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SET</span> ret <span class="op">=</span> ret <span class="op">+</span> i;</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> i <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span>;</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">END</span> <span class="cf">WHILE</span>;</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> ret;</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<h4 id="存储过程">存储过程</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">存储过程可以理解为没有返回值的函数，一般定义如下</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">CREATE PROCEDURE 过程名字(参数列表)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER $$</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="re">BEGIN</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    xxx;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="re">END</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">$$</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">DELIMITER ;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">-- 只有一行可以不写</span><span class="re">BEGIN</span><span class="co">、</span><span class="re">END</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> procedure1()</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> mytable; <span class="co">-- 存储过程中使用SELECT可以显示数据</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- 查看存储过程</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">PROCEDURE</span> STATUS;</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">PROCEDURE</span> STATUS <span class="kw">LIKE</span> <span class="st">&#39;%procedure%&#39;</span>;</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>SHOW <span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> procedure1;</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- 调用存储过程（SELECT只能获取返回值，而存储过程没有返回值，所以不能通过SELECT调用）</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> procedure1();</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co">-- 存储过程无法修改，只能先删除再创建</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">PROCEDURE</span> procedure1;</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 存储过程有自己的类型限定</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co">三种类型：</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co">IN: 数据只能从外部传入，供内部使用（值传递，可以传值或变量）</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co">OUT: 引用传递，外部的变量会被先清空，才会进入到内部（只能传变量）</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a><span class="co">INOUT: 引用传递，既可以在内部修改然后给外部使用，也可以在内部使用外部的数据（只能传变量）</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> procedure2(<span class="kw">IN</span> num1 <span class="dt">INT</span>, <span class="kw">OUT</span> num2 <span class="dt">INT</span>, INOUT num3 <span class="dt">INT</span>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>DELIMITER $$</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> num1,num2,num3; <span class="co">-- num2的值一定为NULL</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num1 <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num2 <span class="op">=</span> <span class="dv">2</span>;</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num3 <span class="op">=</span> <span class="dv">3</span>;</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @num1,@num2,@num3; <span class="co">-- 显示1，2，3</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> procedure2(@num1,@num2,@num3); <span class="co">-- 显示1，NULL，3</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @num1,@num2,@num3; <span class="co">-- 显示1，NULL，3</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="co">-- 存储过程结束后修改才会同步到全部变量中</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">PROCEDURE</span> procedure3(<span class="kw">IN</span> num1 <span class="dt">INT</span>, <span class="kw">OUT</span> num2 <span class="dt">INT</span>, INOUT num3 <span class="dt">INT</span>)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>DELIMITER $$</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> num1,num2,num3; <span class="co">-- 显示1，NULL，3</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> num1 <span class="op">=</span> <span class="dv">10</span>;</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> num2 <span class="op">=</span> <span class="dv">100</span>;</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> num3 <span class="op">=</span> <span class="dv">1000</span>;</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> num1,num2,num3; <span class="co">-- 查看局部变量，显示10，100，1000</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> @num1,@num2,@num3; <span class="co">-- 查看全局变量，显示1，2，3</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @num1 <span class="op">=</span> <span class="dv">11</span>; <span class="co">-- 修改全局变量</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @num2 <span class="op">=</span> <span class="dv">111</span>;</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> @num3 <span class="op">=</span> <span class="dv">1111</span>;</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> @num1,@num2,@num3; <span class="co">-- 查看全局变量，显示11，111，1111</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- 存储过程结束，把OUT和INOUT类型赋值给全局变量</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a><span class="co">-- 使用</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num1 <span class="op">=</span> <span class="dv">1</span>;</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num2 <span class="op">=</span> <span class="dv">2</span>;</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a><span class="kw">SET</span> @num3 <span class="op">=</span> <span class="dv">3</span>;</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a><span class="kw">CALL</span> procedure2(@num1,@num2,@num3);</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> @num1,@num2,@num3; <span class="co">-- 显示11，100，1000</span></span></code></pre></div>
<h2 id="java-web">JAVA WEB</h2>
<h3 id="servlet">Servlet</h3>
<h4 id="servlet基本使用">Servlet基本使用</h4>
<p>Servlet规范要求应用在web应用程序的根目录（不是工程的根目录，可以是一层或多层文件夹）下有WEB-INF文件夹，该文件夹下必须要有一个web.xml文件，同时还可以有classes文件夹用于存放编译生成的class文件，以及lib文件夹用于存放web应用程序用到的jar包</p>
<pre><code>/myproject
├── src
│   └──jdbc.properties
│   └──webapp
│       └──servlets
│           └──HelloServlet.java
├── build
└── WebContent
    └── META-INF
    └── WEB-INF
    │   └── classes
    │   │   └──jdbc.properties
    │   │   └──webapp
    │   │       └──servlets
    │   │           └──HelloServlet.class
    │   └── lib
    │   └── web.xml
    └── hello.jsp</code></pre>
<p>上面的WebContent就是web应用程序的根目录，web应用程序要访问的资源必须在该目录内</p>
<p>像hello.jsp可以通过<code>http://localhost:8080/myproject/hello.jsp</code>访问，但是WEB-INF目录下的任何文件都不能直接通过URL请求访问（但仍可以通过转发的方式访问）</p>
<p>web.xml</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">web-app</span><span class="ot"> xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="ot"> xmlns=</span><span class="st">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ot">         xsi:schemaLocation=</span><span class="st">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span><span class="ot"> version=</span><span class="st">&quot;4.0&quot;</span> &gt;</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 配置当前web应用的初始化参数，可以通过ServletContext获取 --&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context-param</span>&gt;</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-name</span>&gt;configLocation1&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-value</span>&gt;WEB-INF/myconfig1.properties&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">context-param</span>&gt;</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context-param</span>&gt;</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-name</span>&gt;configLocation2&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-value</span>&gt;WEB-INF/myconfig2.properties&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">context-param</span>&gt;</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet</span>&gt;</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;HelloServlet&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-class</span>&gt;webapp.servlets.HelloServlet&lt;/<span class="kw">servlet-class</span>&gt;</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 配置Servlet的初始化参数，可以在init方法中通过ServletConfig获取 --&gt;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 和context-param不同的是，init-param只是当前servlet有效，而context-param是整个web应用有效 --&gt;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">init-param</span>&gt;</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-name</span>&gt;user&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-value</span>&gt;root&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">init-param</span>&gt;</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">init-param</span>&gt;</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-name</span>&gt;password&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-value</span>&gt;123456&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">init-param</span>&gt;</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 默认是在第一次请求该Servlet对应路径时创建Servlet实例，使用load-on-startup可以在Servlet容器初始化时就创建，该值为非负数，数值越小越先创建 --&gt;</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">load-on-startup</span>&gt;1&lt;/<span class="kw">load-on-startup</span>&gt;</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet</span>&gt;</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 一个servlet可以有多个servlet-mapping --&gt;</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;HelloServlet&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 要么指定后缀（/jsps/*.jsp）要么使用通配符（/jsps/*），通配符和后缀不能同时使用 --&gt;</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- /*表示拦截所有请求，比如http://localhost:8080/工程名字/xxx，就会调用该Servlet的service方法 --&gt;</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">welcome-file-list</span>&gt;</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">welcome-file</span>&gt;index.html&lt;/<span class="kw">welcome-file</span>&gt;</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">welcome-file</span>&gt;index.jsp&lt;/<span class="kw">welcome-file</span>&gt;</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">welcome-file-list</span>&gt;</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">error-page</span>&gt;</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">error-code</span>&gt;404&lt;/<span class="kw">error</span><span class="er">=code</span>&gt;</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">location</span>&gt;/index.jsp&lt;/<span class="kw">location</span>&gt;</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">error-page</span>&gt;</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">error-page</span>&gt;</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">exception-type</span>&gt;java.lang.ArithmeticException&lt;/<span class="kw">exception-type</span>&gt;</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">location</span>&gt;/WEB-INF/error.jsp&lt;/<span class="kw">location</span>&gt;</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">error-page</span>&gt;</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">web-app</span>&gt;</span></code></pre></div>
<p>HelloServlet.java</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HelloServlet <span class="kw">implements</span> Servlet <span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Servlet是单例的，默认在第一次请求的时候创建，如果在web.xml中使用了load-on-startup，则在容器初始化时就创建</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">HelloServlet</span><span class="op">(){</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;HelloServlet&#39;s constructor&quot;</span><span class="op">);</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在创建好实例后调用，只会被调用一次</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span><span class="op">(</span>ServletConfig servletConfig<span class="op">)</span> <span class="kw">throws</span> ServletException <span class="op">{</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;init&quot;</span><span class="op">);</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取servlet的init-param</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> user <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">);</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> password <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;password&quot;</span><span class="op">);</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//或者</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Enumeration</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> names1 <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getInitParameterNames</span><span class="op">();</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span>names<span class="op">.</span><span class="fu">hasMoreElements</span><span class="op">()){</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> name <span class="op">=</span> names1<span class="op">.</span><span class="fu">nextElement</span><span class="op">();</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> value <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>name <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> value<span class="op">);</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取context-param</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        ServletContext servletContext <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getServletContext</span><span class="op">();</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> configLocation1 <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;configLocation1&quot;</span><span class="op">);</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> configLocation2 <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;configLocation2&quot;</span><span class="op">);</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">//或者</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Enumeration</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> names2 <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getInitParameterNames</span><span class="op">();</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span>names2<span class="op">.</span><span class="fu">hasMoreElements</span><span class="op">()){</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> name <span class="op">=</span> names2<span class="op">.</span><span class="fu">nextElement</span><span class="op">();</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> value <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>name <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> value<span class="op">);</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取web应用程序根目录下文件的绝对路径</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> realPath <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getRealPath</span><span class="op">(</span><span class="st">&quot;/hello.jsp&quot;</span><span class="op">);</span><span class="co">//斜杠表示当前web应用的根路径</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>realPath<span class="op">);</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取web应用的根路径，即http://localhost:8080/web应用根路径/servlet-mapping的路径/xxx，通常web应用根路径为工程名字前面加斜杠(/)</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> contextPath <span class="op">=</span> servletContext<span class="op">.</span><span class="fu">getContextPath</span><span class="op">();</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>contextPath<span class="op">);</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">//读取文件</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span><span class="op">{</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">ClassLoader</span> classLoader <span class="op">=</span> <span class="fu">getClass</span><span class="op">().</span><span class="fu">getClassLoader</span><span class="op">();</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">InputStream</span> is1 <span class="op">=</span> classLoader<span class="op">.</span><span class="fu">getResourceAsStream</span><span class="op">(</span><span class="st">&quot;jdbc.properties&quot;</span><span class="op">);</span><span class="co">//读取src目录下的jdbc.properties文件</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">//这里的路径是web应用目录的路径，而不是src的路径</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">InputStream</span> is2 <span class="op">=</span> servletConfig<span class="op">.</span><span class="fu">getServletContext</span><span class="op">().</span><span class="fu">getResourceAsStream</span><span class="op">(</span><span class="st">&quot;/WEB-INF/classes/jdbc.properties&quot;</span><span class="op">);</span><span class="co">//读取web应用目录下的/WEB-INF/classes/jdbc.properties文件（编译后会被拷贝到/WEB-INF/classes/下）</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span><span class="cf">catch</span><span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span>  <span class="op">}</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ServletConfig <span class="fu">getServletConfig</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;getServletConfig&quot;</span><span class="op">);</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getServletInfo</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;getServletInfo&quot;</span><span class="op">);</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">//每次请求该Servlet都会被调用</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">service</span><span class="op">(</span>ServletRequest request<span class="op">,</span> ServletResponse response<span class="op">)</span> <span class="kw">throws</span> ServletException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;service&quot;</span><span class="op">);</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">//-------------ServletRequest-------------</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">//http://localhost:8080/myproject/xxx?user=root&amp;password=123456</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> user <span class="op">=</span> request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">);</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> password <span class="op">=</span> request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;password&quot;</span><span class="op">);</span></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>user <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> password<span class="op">);</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* 用于表单中的多选框</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="co">         &lt;input type=&quot;checkbox&quot; name=&quot;habit&quot; value=&quot;read&quot;&gt;看书</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="co">         &lt;input type=&quot;checkbox&quot; name=&quot;habit&quot; value=&quot;movie&quot;&gt;电影</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="co">         &lt;input type=&quot;checkbox&quot; name=&quot;habit&quot; value=&quot;game&quot;&gt;游戏</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span><span class="op">[]</span> habbit <span class="op">=</span> request<span class="op">.</span><span class="fu">getParameterValues</span><span class="op">(</span><span class="st">&quot;habbit&quot;</span><span class="op">);</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span>habbit<span class="op">));</span></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">//还有其他获取参数的方法</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Enumeration&lt;String&gt; names = request.getParameterNames();</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Map&lt;String, String[]&gt; map = request.getParameterMap();</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">//有些参数要其子类HttpServletRequest才能获取</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest httpRequest <span class="op">=</span> <span class="op">(</span>HttpServletRequest<span class="op">)</span>request<span class="op">;</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>        httpRequest<span class="op">.</span><span class="fu">setCharcterEncoding</span><span class="op">(</span><span class="st">&quot;utf-8&quot;</span><span class="op">);</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取 http://127.0.0.1:8080/web应用根路径/，web应用根路径一般就是工程名字前面加斜杠(/)</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> basePath <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getScheme</span><span class="op">()+</span><span class="st">&quot;://&quot;</span><span class="op">+</span>httpRequest<span class="op">.</span><span class="fu">getServerName</span><span class="op">()+</span><span class="st">&quot;:&quot;</span><span class="op">+</span>httpRequest<span class="op">.</span><span class="fu">getServerPort</span><span class="op">()+</span>httpRequest<span class="op">.</span><span class="fu">getContextPath</span><span class="op">()+</span><span class="st">&quot;/&quot;</span><span class="op">;</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取 /servlet-mapping的路径/xxx</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> servletPath <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getServletPath</span><span class="op">();</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取GET请求的参数（不包含?问号），如果是POST，获得的是null</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> queryString <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getQueryString</span><span class="op">();</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">//URI就是 /web应用根路径/servlet-mapping的路径/xxx ，即http://localhost:8080后面那一串（如果是GET请求，是不包含参数的，即不包含?及后面的内容）</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> requestURI <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getRequestURI</span><span class="op">();</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>        <span class="co">//完整的访问路径叫URL（不包含GET的参数）</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> requestURL <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getRequestURL</span><span class="op">();</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取请求方式</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> method <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getMethod</span><span class="op">();</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">//接收二进制数据，文件上传（form表单中method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;）</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>        <span class="co">//这时得到的数据包含请求头、分隔符、其他请求参数等与文件数据无关的信息，需要手动解析获取的数据</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">//所以一般使用Apache提供的工具包commons-fileupload.jar和commons-io.jar来实现文件上传</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">//httpRequest.getInputStream();</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>ServletFileUpload<span class="op">.</span><span class="fu">isMultipartContent</span><span class="op">(</span>httpRequest<span class="op">)){</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>            DiskFileItemFactory factory <span class="op">=</span> <span class="kw">new</span> <span class="fu">DiskFileItemFactory</span><span class="op">();</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>            factory<span class="op">.</span><span class="fu">setSizeThreshold</span><span class="op">(</span><span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>            factory<span class="op">.</span><span class="fu">setRepository</span><span class="op">(</span><span class="kw">new</span> <span class="bu">File</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">getProperty</span><span class="op">(</span><span class="st">&quot;java.io.tmpdir&quot;</span><span class="op">)));</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>            ServletFileUpload upload <span class="op">=</span> <span class="kw">new</span> <span class="fu">ServletFileUpload</span><span class="op">(</span>factory<span class="op">);</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>            upload<span class="op">.</span><span class="fu">setFileSizeMax</span><span class="op">(</span><span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">40</span><span class="op">);</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a>            upload<span class="op">.</span><span class="fu">setSizeMax</span><span class="op">(</span><span class="dv">1024</span> <span class="op">*</span> <span class="dv">1024</span> <span class="op">*</span> <span class="dv">50</span><span class="op">);</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a>            upload<span class="op">.</span><span class="fu">setHeaderEncoding</span><span class="op">(</span><span class="st">&quot;UTF-8&quot;</span><span class="op">);</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> uploadPath <span class="op">=</span> <span class="fu">getServletContext</span><span class="op">().</span><span class="fu">getRealPath</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">)</span> <span class="op">+</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separator</span> <span class="op">+</span> <span class="st">&quot;upload&quot;</span><span class="op">;</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>            <span class="bu">File</span> uploadDir <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>uploadPath<span class="op">);</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>uploadDir<span class="op">.</span><span class="fu">exists</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>                uploadDir<span class="op">.</span><span class="fu">mkdir</span><span class="op">();</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span>FileItem<span class="op">&gt;</span> formItems <span class="op">=</span> upload<span class="op">.</span><span class="fu">parseRequest</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>formItems <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> formItems<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 迭代表单数据</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span>FileItem item <span class="op">:</span> formItems<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(!</span>item<span class="op">.</span><span class="fu">isFormField</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">String</span> fileName <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>item<span class="op">.</span><span class="fu">getName</span><span class="op">()).</span><span class="fu">getName</span><span class="op">();</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">String</span> filePath <span class="op">=</span> uploadPath <span class="op">+</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separator</span> <span class="op">+</span> fileName<span class="op">;</span></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">File</span> storeFile <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>filePath<span class="op">);</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>                        item<span class="op">.</span><span class="fu">write</span><span class="op">(</span>storeFile<span class="op">);</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>                        httpRequest<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;message&quot;</span><span class="op">,</span> <span class="st">&quot;文件上传成功!&quot;</span><span class="op">);</span></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>        <span class="co">//转发请求</span></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> servletPath <span class="op">=</span> <span class="st">&quot;servlet2&quot;</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>        RequestDispatcher requestDispatcher <span class="op">=</span> httpRequest<span class="op">.</span><span class="fu">getRequestDispatcher</span><span class="op">(</span><span class="st">&quot;/&quot;</span> <span class="op">+</span> servletPath<span class="op">);</span><span class="co">//斜杠代表 域名+web应用的根路径</span></span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>        requestDispatcher<span class="op">.</span><span class="fu">forward</span><span class="op">(</span>request<span class="op">,</span> response<span class="op">);</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">//-------------ServletResponse-------------</span></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span><span class="st">&quot;text/html&quot;</span><span class="op">);</span></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setCharcterEncoding</span><span class="op">(</span><span class="st">&quot;utf-8&quot;</span><span class="op">);</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>        <span class="co">//发送文本数据</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">PrintWriter</span> writer <span class="op">=</span> response<span class="op">.</span><span class="fu">getWriter</span><span class="op">();</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>        <span class="co">//writer.println(&quot;&lt;!DOCTYPE html&gt;&quot;);</span></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;helloworld&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Hello World!&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="op">);</span></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>        <span class="co">//发送二进制数据，文件下载</span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a><span class="co">        //文件下载需要添加两个请求头</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a><span class="co">        response.setContentType(&quot;application/x-msdownload&quot;);</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="co">        //filename是服务器建议客户端浏览器保存的文件名，客户端可以更改实际保存的文件名</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a><span class="co">        response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot; + java.net.URLEncoder.encode(&quot;fileName&quot;, &quot;UTF-8&quot;));</span></span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a><span class="co">        response.getOutputStream();</span></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>        <span class="co">//重定向</span></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>        <span class="co">//response.sendRedirect(&quot;/&quot; + servletPath);//斜杠代表 当前域名</span></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在当前Servlet所在WEB应用被卸载时调用，只会被调用一次</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">destroy</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;destroy&quot;</span><span class="op">);</span></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>我们一般不会直接使用Servlet，而是使用其实现类GenericServlet或HttpServlet，HttpServlet根据不同的请求方式（get、post等）会调用不同的方法（doGet、doPost等）</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> HelloHttpServlet <span class="kw">extends</span> HttpServlet <span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doGet</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">)</span> <span class="kw">throws</span> ServletException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span><span class="st">&quot;text/html&quot;</span><span class="op">);</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">PrintWriter</span> writer <span class="op">=</span> response<span class="op">.</span><span class="fu">getWriter</span><span class="op">();</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;hello world!&quot;</span><span class="op">);</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doPost</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">)</span> <span class="kw">throws</span> ServletException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span><span class="st">&quot;text/html&quot;</span><span class="op">);</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">PrintWriter</span> writer <span class="op">=</span> response<span class="op">.</span><span class="fu">getWriter</span><span class="op">();</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;hello world!&quot;</span><span class="op">);</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>一般一个URL只能对应Servlet，要多个请求对应一个Servlet，可以配置servlet-mapping，然后在请求时带上请求哪个方法的参数，比如<code>http://localhost:8080/myproject/helloservlet?method=doGet</code></p>
<p>另一个思路是拦截所有请求，然后根据请求的路径去匹配指定的类及其方法，通过反射的方式调用，这就是其他框架在做的事情</p>
<h4 id="cookie">Cookie</h4>
<p>Cookie存储在客户端浏览器上，默认情况下，一个域名下的所有Cookie对应一个文件存储，所以Cookie不能跨域访问</p>
<p>不同浏览器对Cookie大小和数量的限制不一样，一般Cookie大小不能超过4K（大部分浏览器都限制为4095~4097个字节），数量应尽量保证不超过20个（IE6限制为20个，但部分浏览器可以存储更多，比如IE7+是50个，Chrome是53个）</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取所有Cookie（Cookie无法获取单个，只能获取全部，然后遍历出想要的Cookie）</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>Cookie<span class="op">[]</span> cookies <span class="op">=</span> request<span class="op">.</span><span class="fu">getCookies</span><span class="op">();</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>cookies <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> cookies<span class="op">.</span><span class="fu">length</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>Cookie cookie <span class="op">:</span> cookies<span class="op">){</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>cookie<span class="op">.</span><span class="fu">getName</span> <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> cookie<span class="op">.</span><span class="fu">getValue</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;---&quot;</span> <span class="op">+</span> cookie<span class="op">.</span><span class="fu">getMaxAge</span><span class="op">());</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co">//创建</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>Cookie cookie <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cookie</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">//默认cookie是会话级别的，它存储在浏览器内存中，当浏览器退出后会被删除；要让cookie存储在磁盘上，需设置maxAge（过期时间，单位为秒）</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span><span class="op">);</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">//会将cookie放在Set-Cookie的HTTP响应报头中，但这个操作不会修改之前的cookie，而是添加新的报头（一个HTTP报头可以有多个Set-Cookie），所以不叫setCookie，而是叫addCookie</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>response<span class="op">.</span><span class="fu">addCookie</span><span class="op">(</span>cookie<span class="op">);</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">//负数表示不在磁盘中存储该cookie，而是保存在浏览器内存中</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">//删除，将过期时间设置为0就是删除</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co">//是否仅通过加密连接（比如SSL）传输</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setSecure</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co">//当前jsp设置的cookie只能在本路径及子路径下的jsp获取，如果父路径的jsp需要获取子路径jsp设置的cookie，需要setPath为同一个</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">//cookie.setPath(&quot;/&quot;);//这里的&quot;/&quot;是指当前web应用的根路径</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">//cookie.setPath(request.getContextPath());//一个站点的cookie需要共享可以使用站点的根路径，也就是项目的名字</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setPath</span><span class="op">(</span><span class="st">&quot;/webapp_1&quot;</span><span class="op">);</span><span class="co">//手动指定path</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co">//解决跨域共享cookie的问题；setPath只能解决同一站点的web应用之间的cookie共享问题，但如果网站域名不同（包括子域不同），则需要setDomain为同一个</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>cookie<span class="op">.</span><span class="fu">setDomain</span><span class="op">(</span><span class="st">&quot;mywebsite.com&quot;</span><span class="op">);</span></span></code></pre></div>
<h4 id="session">Session</h4>
<p>Servlet的Session存储在服务器的内存中（其它比如PHP是存储在文件或数据库中的），每次传输通过Cookie中的<code>JSESSIONID</code>来记录当前客户端对应存储在服务器端的session</p>
<p>只有第一次调用<code>request.getSession()</code>才会在Cookie中加入<code>JSESSIONID</code></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">//获取session，如果有JSESSIONID，则获取之前创建的session，否则新建一个HttpSession对象</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>HttpSession session <span class="op">=</span> request<span class="op">.</span><span class="fu">getSession</span><span class="op">();</span> <span class="co">//相当于request.getSession(true);</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">//如果有JSESSIONID，则获取之前创建的session；如果没有，则不创建，返回null</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">//HttpSession session = request.getSession(false);</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Date</span> createTime <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span>session<span class="op">.</span><span class="fu">getCreationTime</span><span class="op">());</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">//获取上次访问这个站点的时间</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Date</span> lastAccessTime <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span>session<span class="op">.</span><span class="fu">getLastAccessedTime</span><span class="op">());</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>session<span class="op">.</span><span class="fu">isNew</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">&quot;Welcome to my website&quot;</span><span class="op">;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    session<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;游客&quot;</span><span class="op">);</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//设置过期时间，单位为秒（如果在指定的时间内没有访问则删除session，每次访问都重新计时）</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    session<span class="op">.</span><span class="fu">setMaxInactiveInterval</span><span class="op">(</span><span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span><span class="op">);</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> sessionId <span class="op">=</span> session<span class="op">.</span><span class="fu">getId</span><span class="op">();</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> name <span class="op">=</span> session<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> maxInactiveInterval <span class="op">=</span> session<span class="op">.</span><span class="fu">getMaxInactiveInterval</span><span class="op">();</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co">//删除一个指定的属性</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">removeAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co">//删除整个session</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">invalidate</span><span class="op">();</span></span></code></pre></div>
<p>由于sessionid通过Cookie存储，所以用户关闭浏览器时，Cookie被清空，下次打开浏览器时也无法访问原来的Session（但这时服务器端还没有删除Session），我们可以通过设置<code>JSESSIONID</code>的maxAge来持久化sessionid</p>
<p>Session只会在过期或者手动调用<code>invalidate</code>时才会被销毁，WEB应用关闭然后再重新启动时，关闭前会先把Session持久化到硬盘中（所以如果存入Session的是JavaBean，需要实现序列号接口Serializable），重启后再从硬盘中重新装载，然后再把持久化的文件删掉，所以WEB应用重启不会导致Session清空</p>
<p>Session的过期时间也可以在web.xml中统一指定</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">session-config</span>&gt;</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 单位为分钟 --&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">session-timeout</span>&gt;15&lt;/<span class="kw">session-timeout</span>&gt;</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">session-config</span>&gt;</span></code></pre></div>
<p>对于JSP页面，如果设置了<code>&lt;%@ page session=&quot;false&quot; %&gt;</code>，只是禁用了session的隐含对象，但我们仍可以显式地获取session</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java contextType=&quot;</span><span class="ot">text/html; charset</span>=<span class="st">UTF-8&quot; pageEncoding=&quot;</span><span class="ot">UTF-8&quot; </span><span class="bu">%&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> session</span>=<span class="st">&quot;false&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    &lt;head&gt;&lt;title&gt;JSP页面&lt;/title&gt;&lt;/head&gt;</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    &lt;body&gt;</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">//获取当前站点的其他页面创建过的session，如果之前没有创建过（比如第一次访问该站点），则返回null</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">//HttpSession session = request.getSession(false);</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果没有创建过session，则新建一个HttpSession</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            HttpSession session <span class="op">=</span> request<span class="op">.</span><span class="fu">getSession</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            out<span class="op">.</span><span class="fu">println</span><span class="op">(</span>session<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="pp">%&gt;</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    &lt;/body&gt;</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<p>如果客户端浏览器禁用了Cookie，那么自然也就无法通过上面的方式使用Session了，在这种情况下，我们可以把sessionid放在URL后面，作为GET参数传输到服务器，这种方式叫做URL重写</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;</span><span class="pp">&lt;%=</span>response<span class="op">.</span><span class="fu">encodeURL</span><span class="op">(</span><span class="st">&quot;index.jsp&quot;</span><span class="op">)</span> <span class="pp">%&gt;</span><span class="dt">&quot;</span><span class="ot"> </span>&gt;index&lt;/a&gt;</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;</span><span class="pp">&lt;%=</span>response<span class="op">.</span><span class="fu">encodeRedirectURL</span><span class="op">(</span><span class="st">&quot;index.jsp&quot;</span><span class="op">)</span> <span class="pp">%&gt;</span><span class="dt">&quot;</span><span class="ot"> </span>&gt;redirect to index&lt;/a&gt;</span></code></pre></div>
<h4 id="路径问题">路径问题</h4>
<p>关于根路径的说明：</p>
<blockquote>
<p>在代码中的请求转发（比如<code>request.getRequestDispatcher(&quot;/b.jsp&quot;)</code>，包括java代码和jsp代码）或web.xml或JSTL的重定向<code>&lt;c:redirect url=&quot;/b.jsp&quot;&gt;</code>中，斜杠<code>/</code>表示当前域名+WEB应用的根路径，即<code>http://localhost:8080/myproject/</code></p>
<p>在代码中的请求重定向（比如<code>response.sendRedirect(&quot;/b.jsp&quot;);</code>）或html页面中（比如<code>&lt;a href=&quot;/b.jsp&quot;&gt;</code>），斜杠<code>/</code>表示当前域名，即<code>http://localhost:8080/</code></p>
<p>简而言之，如果斜杠是交由Servlet处理的，则代表域名+WEB应用的根路径，如果斜杠是交由客户端浏览器处理的，斜杠代表当前域名</p>
</blockquote>
<p>关于绝对路径：</p>
<blockquote>
<p>实际开发中，一般要使用绝对路径（即前面带斜杠<code>/</code>），这样的好处是，如果jsp文件位置变化，代码也能正常运行</p>
<p>如果斜杠<code>/</code>仅代表当前域名，则在路径前面加上<code>request.getContextPath()</code>即可</p>
<p>比如<code>response.sendRedirect(request.getContextPath() + &quot;/b.jsp&quot;)</code></p>
</blockquote>
<h4 id="转发和重定向">转发和重定向</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">//转发</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>request<span class="op">.</span><span class="fu">getRequestDispatcher</span><span class="op">(</span><span class="st">&quot;/b.jsp&quot;</span><span class="op">).</span><span class="fu">forward</span><span class="op">(</span>request<span class="op">,</span> response<span class="op">);</span><span class="co">//斜杠代表 域名+web应用的根路径</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">//重定向</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>response<span class="op">.</span><span class="fu">sendRedirect</span><span class="op">(</span><span class="st">&quot;/b.jsp&quot;</span><span class="op">);</span><span class="co">//斜杠代表 当前域名</span></span></code></pre></div>
<p>转发和重定向的区别：</p>
<blockquote>
<p>转发只能转发到本站的地址，而且浏览器地址栏不会变化，显示的还是当前servlet的地址（如果这时用户点击刷新，会有重复提交的问题）</p>
<p>重定向可以重定向到站外，浏览器的地址栏会变成重定向的地址（如果用户点击返回，依然有重复提交的问题）</p>
<p>转发只发出了一次请求，而重定向发出了两次请求（浏览器接收到服务器返回的重定向状态码后，再次发起请求，跳转到新页面），所以转发两个servlet的request是同一个，而重定向两个servlet的request不是同一个</p>
</blockquote>
<p>解决重复提交的问题：</p>
<blockquote>
<p>方案一：使用AJAX提交（如果不配合token，仍然无法避免恶意重复提交）</p>
<p>方案二：在HTML表单的隐藏域中生成一个token（随机数，比如MD5(时间).toHex()），并把该token作为key存入session中，value表示是否受理过，如果token已经被使用过了，那么服务器就不受理（或者第一次受理后把token从session中删除）</p>
<p>一次性验证码的实现思路和方案二一样</p>
</blockquote>
<h4 id="filter">Filter</h4>
<p>Filter，拦截器</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyFilter <span class="kw">implements</span> <span class="bu">Filter</span>  <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在加载WEB应用时调用，只会被调用一次</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">init</span><span class="op">(</span>FilterConfig config<span class="op">)</span> <span class="kw">throws</span> ServletException <span class="op">{</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取init-param</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>config<span class="op">.</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;param&quot;</span><span class="op">));</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//每次拦截都会调用该方法</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doFilter</span><span class="op">(</span>ServletRequest request<span class="op">,</span> ServletResponse response<span class="op">,</span> FilterChain chain<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span><span class="op">,</span> ServletException <span class="op">{</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//拦截请求</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">//放行（执行后续的Filter，如果后面没有Filter，则执行Servlet对应方法）</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        chain<span class="op">.</span><span class="fu">doFilter</span><span class="op">(</span>request<span class="op">,</span>response<span class="op">);</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">//拦截响应</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在销毁前调用，只会被调用一次</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">destroy</span><span class="op">(){</span>  <span class="op">}</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在web.xml中配置</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter</span>&gt;</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;MyFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-class</span>&gt;webapp.filters.MyFilter&lt;/<span class="kw">filter-class</span>&gt;</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">init-param</span>&gt;</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-name</span>&gt;param&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-value</span>&gt;paramValue&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">init-param</span>&gt;</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter</span>&gt;</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 如果有多个过滤器，按照filter-mapping定义的先后顺序进行拦截 --&gt;</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter-mapping</span>&gt;</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;MyFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 可以指定通过何种方式访问时执行拦截</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">         可选值有REQUEST、FORWARD（包括Java或JSP代码的forward、jsp标签的forward、通过JSP的page指令配置的errorPage）、INCLUDE、ERROR（ERROR只有在web.xml中配置的error-page才会触发，而通过JSP的page指令配置的errorPage不会触发）</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">         默认只有REQUEST才拦截，可以配置多个dispatcher来拦截不同请求方式 --&gt;</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;REQUEST&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;FORWARD&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter-mapping</span>&gt;</span></code></pre></div>
<h4 id="listener">Listener</h4>
<p>Listener监听器，它可以监听ServletContext、HttpSession、ServletRequest等域对象的创建和销毁，以及这些域对象的属性更改事件</p>
<p>一共有ServletContextListener、ServletContextAttributeListener、HttpSessionListener、HttpSessionAttributeListener、ServletRequestListener、ServletRequestAttributeListener六种监听器</p>
<p>除此以外还有两个特殊的监听器，HttpSessionBindingListener（监听新增、替换、移除事件）、和HttpSessionActivationListener（监听被持久化到硬盘及从硬盘中重新载入的事件，又叫钝化和活化），JavaBean实现这些接口可以感知自己在Session域中的状态的改变，这两个Listener不需要在web.xml中注册</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyServletContextListener <span class="kw">implements</span> ServletContextListener<span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">contextInitialized</span><span class="op">(</span>ServletContextEvent sce<span class="op">){</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取context-param</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>sce<span class="op">.</span><span class="fu">getServletContext</span><span class="op">().</span><span class="fu">getInitParameter</span><span class="op">(</span><span class="st">&quot;contextParam&quot;</span><span class="op">));</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">contextDestroyed</span><span class="op">(</span>ServletContextEvent sce<span class="op">){</span>  <span class="op">}</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>web.xml配置</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">listener</span>&gt;</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">listener-class</span>&gt;webapp.listeners.MyServletContextListener&lt;/<span class="kw">listener-class</span>&gt;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">listener</span>&gt;</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">context-param</span>&gt;</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">param-name</span>&gt;contextParam&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">param-value</span>&gt;contextValue&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">context-param</span>&gt;</span></code></pre></div>
<h3 id="jsp">JSP</h3>
<p>用到的jar包可以从下面地址下载：</p>
<p>http://tomcat.apache.org/download-taglibs.cgi</p>
<p>JSTL相关的两个jar包</p>
<p>http://repo2.maven.org/maven2/javax/servlet/jstl/</p>
<p>http://repo2.maven.org/maven2/taglibs/standard/</p>
<h4 id="jsp基本使用">JSP基本使用</h4>
<p>JSP是在html页面中嵌入java代码来动态生成页面的一种方式</p>
<p>JSP本质上是一个Servlet，它在编译后会生成xxx.jsp.java文件，该java类是一个Servlet，里面把与JSP无关的html等代码用<code>writer.println(&quot;xxx&quot;)</code>的方式输出，把JSP标签内的java代码放在Servlet对应的方法中执行</p>
<p>JSP有9个隐含对象：</p>
<ul>
<li>application:
ServletContext的一个实例，开始于服务器启动，直到服务器关闭，作用域为当前web应用</li>
<li>config: ServletConfig的一个实例，主要作用是取得服务器的配置信息</li>
<li>session:
HttpSession的一个实例，是由服务器自动创建的与用户请求相关的对象，作用域为一次会话（浏览器打开直到关闭称为一次会话）</li>
<li>request:
HttpServletRequest的一个实例，代表了客户端的请求信息，主要用于接受通过HTTP协议传送到服务器的数据。（包括头信息、系统信息、请求方式以及请求参数等）作用域为一次请求</li>
<li>response:
HttpServletResponse的一个实例，代表是对客户端的响应，主要是将JSP容器处理过的对象传回到客户端</li>
<li>out: jspWriter的一个实例（用于浏览器输出数据）</li>
<li>pagecontext:
页面的上下文。可以获得任何范围的参数（其它8个隐含对象+其他页面信息），作用域为当前JSP页面</li>
<li>page:
page对象代表JSP本身，只有在JSP页面内才是合法的，但它是Object类型，只能用Object的方法，一般不用</li>
<li>exception:
显示异常信息，只有在JSP页面声明为<code>&lt;%@ page isErrorPage=true %&gt;</code>才能使用；如果没有出错，则exception为null（比如直接访问或通过代码直接转发到错误页面），所以一般通过在web.xml中配置error-page或在jsp的page中配置errorPage让服务器自动转发到错误页面（由于WEB-INF下的文件无法直接访问，所以一般会把error.jsp放在WEB-INF下）</li>
</ul>
<p>JSP四大域对象：application、session、request、pageContext</p>
<p>作用范围：context &gt; session &gt; request &gt; page</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- JSP指令有</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co">    page: 定义页面依赖属性，例如脚本语言，错误页面和缓冲的要求</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    include: 静态引入，将其他文件的内容合并到当前文件，这种合并是源码级别的合并，被引入的页面可以使用引入的页面定义的变量，引入的无论是何种后缀，最后都会按照JSP解析（相当于先把源码复制过来，再解析）</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    taglib: 引入标签库 --%&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java contextType=&quot;</span><span class="ot">text/html; charset</span>=<span class="st">UTF-8&quot; pageEncoding=&quot;</span><span class="ot">UTF-8&quot; import</span>=<span class="st">&quot;java.util.*&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 指定错误页面，出错会转发到指定页面 --%&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> errorPage</span>=<span class="st">&quot;/WEB-INF/error.jsp&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- JSP声明，可以用于声明变量或方法 --%&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 前面提到，JSP是一个Servlet，JSP解析器会把JSP脚本片段或JSP表达式放到service方法中，而如果想定义函数或全局变量，就要使用JSP声明 --%&gt;</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="pp">&lt;%!</span> <span class="dt">int</span> day <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> <span class="pp">%&gt;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    &lt;head&gt;&lt;title&gt;JSP页面&lt;/title&gt;&lt;/head&gt;</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    &lt;body&gt;</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 使用include指令导入网页头部的模板，静态引入header.jsp不会生成header.jsp.java --%&gt;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">&lt;%@ include</span><span class="ot"> file</span> = <span class="st">&quot;header.jsp&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 使用jsp标签进行动态引入，这时header.jsp会生成header.jsp.java，且header.jsp无法使用当前jsp定义的变量（相当于先解析，再放到这里输出） --%&gt;</span>&gt;</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">&lt;jsp:include</span><span class="ot"> page</span>=<span class="st">&quot;header.jsp&quot;</span><span class="bu">&gt;&lt;/jsp:include&gt;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- html注释 --&gt;</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- JSP注释，和html注释的不同之处在于JSP注释不会被输出到网页源码中，而且JSP脚本只能用JSP注释来注释 --%&gt;</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- JSP脚本 --%&gt;</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Date</span> date <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">();</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>            out<span class="op">.</span><span class="fu">println</span><span class="op">(</span>date<span class="op">);</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        <span class="pp">%&gt;</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        &lt;br<span class="ot"> </span>/&gt;</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- JSP表达式（不用写分号） --%&gt;</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        &lt;p&gt;今天是:<span class="pp">&lt;%=</span><span class="op">(</span><span class="kw">new</span> java<span class="op">.</span><span class="fu">util</span><span class="op">.</span><span class="fu">Date</span><span class="op">()).</span><span class="fu">toLocaleString</span><span class="op">()</span><span class="pp">%&gt;</span>&lt;/p&gt;</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        &lt;br<span class="ot"> </span>/&gt;</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- JSP混合HTML代码，使用if-else（同理，可以写switch-case、while、for） --%&gt;</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span> <span class="cf">if</span> <span class="op">(</span>day <span class="op">==</span> <span class="dv">1</span> <span class="op">|</span> day <span class="op">==</span> <span class="dv">7</span><span class="op">)</span> <span class="op">{</span> <span class="pp">%&gt;</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>              &lt;p&gt; Today is weekend&lt;/p&gt;</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span> <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span> <span class="pp">%&gt;</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>              &lt;p&gt; Today is not weekend&lt;/p&gt;</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span> <span class="op">}</span> <span class="pp">%&gt;</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        &lt;br<span class="ot"> </span>/&gt;</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 定义和使用方法（方法的定义要使用JSP声明，以&quot;&lt;%!&quot;开头） --%&gt;</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%!</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">mul</span><span class="op">(</span><span class="dt">int</span> a<span class="op">,</span> <span class="dt">int</span> b<span class="op">){</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> a <span class="op">*</span> b<span class="op">;</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        <span class="pp">%&gt;</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%=</span> <span class="fu">mul</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="pp">%&gt;</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>        &lt;br<span class="ot"> </span>/&gt;</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 使用Session和Cookie --%&gt;</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> name <span class="op">=</span> request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">//以下四个方法四大域对象都有</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span>name<span class="op">);</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">);</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span><span class="fu">removeAttribute</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">);</span></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Enumeration</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> names <span class="op">=</span> session<span class="op">.</span><span class="fu">getAttributeNames</span><span class="op">();</span></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        <span class="pp">%&gt;</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>        Cookie<span class="op">[]</span> cookies <span class="op">=</span> request<span class="op">.</span><span class="fu">getCookies</span><span class="op">();</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>cookies<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++){</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>            out<span class="op">.</span><span class="fu">println</span><span class="op">(</span>cookies<span class="op">[</span>i<span class="op">].</span><span class="fu">getValue</span><span class="op">());</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> name<span class="op">=</span>request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        Cookie cookie <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cookie</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span>name<span class="op">);</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addCookie</span><span class="op">(</span>cookie<span class="op">);</span></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">50</span> <span class="op">*</span> <span class="dv">50</span><span class="op">);</span><span class="co">//单位为秒（删除Cookie：cookie.setMaxAge(0)）</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>        <span class="pp">%&gt;</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 转发请求与重定向</span></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;%</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a><span class="co">        //request.getRequestDispatcher(&quot;/b.jsp&quot;).forward(request, response);</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a><span class="co">        response.sendRedirect(&quot;b.jsp&quot;);</span></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a><span class="co">        %&gt;</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a><span class="co">        --%&gt;</span></span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    &lt;/body&gt;</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<h4 id="乱码问题">乱码问题</h4>
<ol type="1">
<li>保证<code>contextType=&quot;text/html; charset=UTF-8&quot;</code>和<code>pageEncoding=&quot;UTF-8&quot;</code>一致，可以解决显示页面的乱码问题</li>
<li>在接收请求参数前使用<code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code>，指定接收参数的编码，可以解决POST乱码问题</li>
<li>对于GET请求，默认在传输时会转成iso-8859-1编码，要修改只能修改<code>tomcat目录/config/server.xml</code>，在Connector标签中添加<code>useBodyEncodingForURI=&quot;true&quot;</code>，来让GET参数使用页面的编码，此时在接收参数前仍然要使用<code>request.setCharacterEncoding(&quot;UTF-8&quot;)</code>指定编码，或者直接指定<code>URIEncoding</code>来修改默认的传输编码。如果不想修改tomcat配置文件，也可以在接收参数后使用<code>new String(param.getBytes(&quot;iso-8859-1&quot;), &quot;UTF-8&quot;)</code>进行转码</li>
</ol>
<h4 id="jsp标签">JSP标签</h4>
<p>JSP标签又叫JSP动作元素，与JSP脚本不同在于，JSP动作元素在请求处理阶段起作用</p>
<p>常用标签</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 动态引入（区别于`&lt;%@ include file=&quot;xxx&quot;%&gt;`） --%&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:include</span><span class="ot"> page</span>=<span class="st">&quot;/index.jsp&quot;</span><span class="bu">&gt;&lt;/jsp:include&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 转发请求，可以使用jsp:param传递参数，另一页面可以通过request.getParameter获取 --%&gt;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:forward</span><span class="ot"> page</span>=<span class="st">&quot;/index.jsp&quot;</span><span class="bu">&gt;</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">&lt;jsp:param</span><span class="ot"> name</span>=<span class="st">&quot;username&quot;</span><span class="ot"> value</span>=<span class="st">&quot;user&quot;</span><span class="bu"> /&gt;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;/jsp:forward&gt;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 使用JavaBean，并设置、获取属性，name是指JavaBean的id --%&gt;</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:useBean</span><span class="ot"> id</span>=<span class="st">&quot;user&quot;</span><span class="ot"> class</span>=<span class="st">&quot;webapp.pojo.User&quot;</span><span class="ot"> scope</span>=<span class="st">&quot;request&quot;</span><span class="bu"> /&gt;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:setProperty</span><span class="ot"> name</span>=<span class="st">&quot;user&quot;</span><span class="ot"> property</span>=<span class="st">&quot;username&quot;</span><span class="ot"> value</span>=<span class="st">&quot;小明&quot;</span><span class="bu"> /&gt;</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:getProperty</span><span class="ot"> name</span>=<span class="st">&quot;user&quot;</span><span class="ot"> property</span>=<span class="st">&quot;username&quot;</span><span class="bu"> /&gt;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 使用*可以自动为所有属性赋值为请求参数的值 --%&gt;</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- http://localhost:8080/myproject/a.jsp?id=1&amp;name=xiaoming&amp;age=14 --%&gt;</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;jsp:setProperty</span><span class="ot"> name</span>=<span class="st">&quot;user&quot;</span><span class="ot"> property</span>=<span class="st">&quot;*&quot;</span><span class="bu"> /&gt;</span></span></code></pre></div>
<h4 id="el表达式">EL表达式</h4>
<p>EL表达式（Expression
Language）可以简化JSP表达式的写法，它的语法是<code>${表达式}</code></p>
<p>EL表达式可以直接访问JavaBean的属性、数组、List、Map元素，进行数学运算、逻辑判断（数学、逻辑运算符支持java的&gt;、&gt;=、==、||、&amp;&amp;等，也可以使用gt、ge、eq、and、or替代），直接访问四大域（也可以通过隐含对象访问其他域）</p>
<p>EL表达式支持如下隐含对象：</p>
<ul>
<li>applicationScope: application作用域</li>
<li>initParam: 上下文初始化参数</li>
<li>sessionScope: session作用域</li>
<li>cookie: Cookie值</li>
<li>requestScope: request作用域</li>
<li>param: Request对象的参数，字符串</li>
<li>paramValues: Request对象的参数，字符串集合</li>
<li>header: HTTP 信息头，字符串</li>
<li>headerValues: HTTP信息头，字符串集合</li>
<li>pageScope: page作用域</li>
<li>pageContext: 当前页面的pageContext</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- JSP的写法，如果username为null，会输出&quot;null&quot;字符串，为了避免这种情况，需要手动处理 --%&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="pp">&lt;%=</span>request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">)</span> <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="st">&quot;&quot;</span><span class="op">:</span>request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">)</span> <span class="pp">%&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- EL的写法，如果username为null，则输出空字符串&quot;&quot; --%&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>param<span class="op">.</span><span class="fu">username</span><span class="pp">}</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 直接访问对象的属性 --%&gt;</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>sessionScope<span class="op">.</span><span class="fu">user</span><span class="op">.</span><span class="fu">name</span><span class="pp">}</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 或者 --%&gt;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>sessionScope<span class="op">.</span><span class="fu">user</span><span class="op">[</span><span class="st">&quot;name&quot;</span><span class="op">]</span><span class="pp">}</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 特殊情况需要用中括号 --%&gt;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="pp">&lt;%</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    User user <span class="op">=</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="dv">14</span><span class="op">);</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    session<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;webapp.pojo.user&quot;</span><span class="op">,</span> user<span class="op">);</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="pp">%&gt;</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>sessionScope<span class="op">[</span><span class="st">&quot;webapp.pojo.user&quot;</span><span class="op">].</span><span class="fu">name</span><span class="pp">}</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- 如果不指定scope，会自动按照作用范围从小到大寻找page、request、session、application中的内容 --%&gt;</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>user<span class="op">.</span><span class="fu">name</span><span class="pp">}</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- EL表达式可以自动类型转换 --%&gt;</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>param<span class="op">.</span><span class="fu">age</span> <span class="op">+</span> <span class="dv">10</span><span class="pp">}</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 复杂数据类型也可以自动转换 --&gt;</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="pp">&lt;%</span> application<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;time&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">());</span> <span class="pp">%&gt;</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>applicationScope<span class="op">.</span><span class="fu">time</span><span class="op">.</span><span class="fu">time</span><span class="pp">}</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- empty运算符 --%&gt;</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="pp">&lt;%</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> names <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;();</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;names&quot;</span><span class="op">,</span> names<span class="op">);</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="pp">%&gt;</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 输出true，属性不存在或内容为空都会输出true --&gt;</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span><span class="kw">empty</span> requestScope<span class="op">.</span><span class="fu">names</span><span class="pp">}</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;%-- EL表达式使用函数需要导入标签库 --%&gt;</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> uri</span>=<span class="st">&quot;http://java.sun.com/jsp/jstl/functions&quot;</span><span class="ot"> prefix</span>=<span class="st">&quot;fn&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>fn<span class="op">:</span><span class="fu">length</span><span class="op">(</span>param<span class="op">.</span><span class="fu">name</span><span class="op">)</span> <span class="pp">}</span></span></code></pre></div>
<h4 id="jstl标签">JSTL标签</h4>
<p>JSTL全称为JavaServer Pages Standard Tag Library，JSP标准标签库</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java contextType=&quot;</span><span class="ot">text/html; charset</span>=<span class="st">UTF-8&quot; pageEncoding=&quot;</span><span class="ot">UTF-8&quot; import</span>=<span class="st">&quot;java.util.*&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> uri</span>=<span class="st">&quot;http://java.sun.com/jsp/jstl/core&quot;</span><span class="ot"> prefix</span>=<span class="st">&quot;c&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> uri</span>=<span class="st">&quot;http://java.sun.com/jsp/jstl/sql&quot;</span><span class="ot"> prefix</span>=<span class="st">&quot;sql&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    &lt;head&gt;&lt;title&gt;JSP页面&lt;/title&gt;&lt;/head&gt;</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    &lt;body&gt;</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- scope可以指定为application、session、request、page --%&gt;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:set</span><span class="ot"> var</span>=<span class="dt">&quot;sesssionValue&quot;</span><span class="ot"> value</span>=<span class="dt">&quot;&lt;&lt;java&gt;&gt;&quot;</span><span class="ot"> scope</span>=<span class="dt">&quot;session&quot;</span><span class="ot"> </span><span class="kw">/&gt;</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 给JavaBean的属性赋值 --%&gt;</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span> User user <span class="op">=</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">();</span> <span class="pp">%&gt;</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:set</span><span class="ot"> target</span>=<span class="pp">${</span>requestScope<span class="op">.</span><span class="fu">user</span><span class="pp">}</span> property=<span class="dt">&quot;id&quot;</span><span class="ot"> value</span>=<span class="dt">&quot;1&quot;</span><span class="ot"> </span><span class="kw">/&gt;</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 如果sesssionValue含有特殊字符，可以自动转义（比如尖括号） --%&gt;</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:out</span><span class="ot"> value</span>=<span class="dt">&quot;</span><span class="pp">${</span>sesssionValue<span class="pp">}</span><span class="dt">&quot;</span><span class="ot"> default</span>=<span class="dt">&quot;null&quot;</span><span class="ot"> escapeXml</span>=<span class="dt">&quot;true&quot;</span><span class="ot"> </span><span class="kw">/&gt;</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:remove</span><span class="ot"> var</span>=<span class="dt">&quot;sesssionValue&quot;</span><span class="ot"> scope</span>=<span class="dt">&quot;session&quot;</span><span class="ot"> </span><span class="kw">/&gt;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 条件判断 --%&gt;</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:if</span><span class="ot"> test</span>=<span class="dt">&quot;</span><span class="pp">${</span>param<span class="op">.</span><span class="fu">age</span> <span class="op">&gt;</span> <span class="dv">18</span><span class="pp">}</span><span class="dt">&quot;</span><span class="ot"> var</span>=<span class="dt">&quot;isAdult&quot;</span><span class="ot"> scope</span>=<span class="dt">&quot;request&quot;</span><span class="kw">&gt;&lt;/c:if&gt;</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:out</span><span class="ot"> value</span>=<span class="dt">&quot;</span><span class="pp">${</span>requestScope<span class="op">.</span><span class="fu">isAdult</span><span class="pp">}</span><span class="dt">&quot;</span><span class="kw">&gt;&lt;/c:out&gt;</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:choose&gt;</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;c:when</span><span class="ot"> test</span>=<span class="dt">&quot;</span><span class="pp">${</span>param<span class="op">.</span><span class="fu">age</span> <span class="op">&gt;</span> <span class="dv">18</span><span class="pp">}</span><span class="dt">&quot;</span><span class="kw">&gt;</span>成年<span class="kw">&lt;/c:when&gt;</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;c:when</span><span class="ot"> test</span>=<span class="dt">&quot;</span><span class="pp">${</span>param<span class="op">.</span><span class="fu">age</span> <span class="op">&gt;=</span> <span class="dv">0</span><span class="pp">}</span><span class="dt">&quot;</span><span class="kw">&gt;</span>未成年<span class="kw">&lt;/c:when&gt;</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;c:otherwise&gt;</span>参数不合法<span class="kw">&lt;/c:otherwise&gt;</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/c:choose&gt;</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 循环 --%&gt;</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;c:forEach</span><span class="ot"> begin</span>=<span class="dt">&quot;0&quot;</span><span class="ot"> end</span>=<span class="dt">&quot;10&quot;</span><span class="ot"> step</span>=<span class="dt">&quot;2&quot;</span><span class="ot"> var</span>=<span class="dt">&quot;i&quot;</span><span class="kw">&gt;</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>            <span class="pp">${</span>i<span class="pp">}</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/c:forEach&gt;</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;%-- 遍历Collection或数组 --%&gt;</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        <span class="pp">&lt;%</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> users1 <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span>User<span class="op">&gt;();</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> 小明<span class="st">&quot;, 14));</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> 小红<span class="st">&quot;, 13));</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> 小王<span class="st">&quot;, 12));</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>            request<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;users1&quot;</span><span class="op">,</span> users1<span class="op">);</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">%&gt;</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>c<span class="op">:</span>forEach <span class="dt">var</span><span class="op">=</span><span class="st">&quot;user&quot;</span> items<span class="op">=</span><span class="st">&quot;${requestScope.users1}&quot;</span> varStatus<span class="op">=</span><span class="st">&quot;status&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>            $<span class="op">{</span>status<span class="op">.</span><span class="fu">index</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">id</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">name</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">age</span><span class="op">}</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>c<span class="op">:</span>forEach<span class="op">&gt;</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> 遍历Map <span class="op">--%&gt;</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> User<span class="op">&gt;</span> users2 <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> User<span class="op">&gt;();</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>            users2<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> 小明<span class="st">&quot;, 14));</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>            users2<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> 小红<span class="st">&quot;, 13));</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>            users2<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;c&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> 小王<span class="st">&quot;, 12));</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>            request<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;users2&quot;</span><span class="op">,</span> users2<span class="op">);</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">%&gt;</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>c<span class="op">:</span>forEach <span class="dt">var</span><span class="op">=</span><span class="st">&quot;user&quot;</span> items<span class="op">=</span><span class="st">&quot;${requestScope.users2}&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>            $<span class="op">{</span>user<span class="op">.</span><span class="fu">key</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">value</span><span class="op">.</span><span class="fu">id</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">value</span><span class="op">.</span><span class="fu">name</span><span class="op">}</span> <span class="op">--</span> $<span class="op">{</span>user<span class="op">.</span><span class="fu">value</span><span class="op">.</span><span class="fu">age</span><span class="op">}</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>c<span class="op">:</span>forEach<span class="op">&gt;</span></span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> JSTL或JSP标签中，无论转发还是重定向，斜杠都表示 当前域名<span class="op">+</span>WEB应用的根路径 <span class="op">--%&gt;</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> 重定向 <span class="op">&lt;</span>c<span class="op">:</span>redirect url<span class="op">=</span><span class="st">&quot;/b.jsp&quot;</span> <span class="op">/&gt;</span> <span class="op">--%&gt;</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> 转发可以使用 <span class="op">&lt;</span>jsp<span class="op">:</span>forward page<span class="op">=</span><span class="st">&quot;/b.jsp&quot;</span><span class="op">&gt;</span> <span class="op">--%&gt;</span></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> c<span class="op">:</span>url生成的URL会自动加上WEB应用的根路径，且会在URL后面加上JSESSIONID，自动进行URL重写，并对GET参数进行转码 <span class="op">--%&gt;</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> c<span class="op">:</span>url可以存储在指定的域中 <span class="op">--%&gt;</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>c<span class="op">:</span>url value<span class="op">=</span><span class="st">&quot;/b.jsp&quot;</span> <span class="dt">var</span><span class="op">=</span><span class="st">&quot;testurl&quot;</span> scope<span class="op">=</span><span class="st">&quot;page&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>c<span class="op">:</span>param name<span class="op">=</span><span class="st">&quot;username&quot;</span> value<span class="op">=</span><span class="st">&quot;小明&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>c<span class="op">:</span>url<span class="op">&gt;</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>        $<span class="op">{</span>testurl<span class="op">}</span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;%--</span> 使用mysql的jstl <span class="op">--%&gt;</span></span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>sql<span class="op">:</span>setDataSource <span class="dt">var</span><span class="op">=</span><span class="st">&quot;connection&quot;</span> driver<span class="op">=</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>            url<span class="op">=</span><span class="st">&quot;jdbc:mysql://localhost/test?useSSL=false&amp;characterEncoding=utf8&quot;</span> user<span class="op">=</span><span class="st">&quot;user&quot;</span> password<span class="op">=</span><span class="st">&quot;root&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>sql<span class="op">:</span>update dataSource<span class="op">=</span><span class="st">&quot;${connection}&quot;</span> <span class="dt">var</span><span class="op">=</span><span class="st">&quot;count&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>            INSERT INTO <span class="fu">user</span><span class="op">(</span>`id`<span class="op">,</span>`name`<span class="op">,</span>`age`<span class="op">)</span> <span class="fu">VALUES</span> <span class="op">(</span><span class="kw">null</span><span class="op">,</span><span class="er">&#39;</span>小明<span class="er">&#39;</span><span class="op">,</span> <span class="dv">14</span><span class="op">);</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>sql<span class="op">:</span>update<span class="op">&gt;</span></span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>c<span class="op">:</span>set <span class="dt">var</span> <span class="op">=</span> <span class="st">&quot;userId&quot;</span> value <span class="op">=</span> <span class="st">&quot;1&quot;</span><span class="op">/&gt;</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>sql<span class="op">:</span>update dataSource<span class="op">=</span><span class="st">&quot;${connection}&quot;</span> <span class="dt">var</span><span class="op">=</span><span class="st">&quot;count&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>            UPDATE user SET name<span class="op">=</span><span class="er">&#39;</span>小红<span class="er">&#39;</span> WHERE id<span class="op">=?</span></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>sql<span class="op">:</span>param value <span class="op">=</span> <span class="st">&quot;${userId}&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>sql<span class="op">:</span>update<span class="op">&gt;</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>sql<span class="op">:</span>update dataSource<span class="op">=</span><span class="st">&quot;${connection}&quot;</span> <span class="dt">var</span><span class="op">=</span><span class="st">&quot;count&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>            DELETE FROM user WHERE id<span class="op">=</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>sql<span class="op">:</span>update<span class="op">&gt;</span></span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>sql<span class="op">:</span>query dataSource<span class="op">=</span><span class="st">&quot;${connection}&quot;</span> <span class="dt">var</span><span class="op">=</span><span class="st">&quot;result&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>            SELECT <span class="op">*</span> FROM user<span class="op">;</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>sql<span class="op">:</span>query<span class="op">&gt;</span></span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;</span>table border<span class="op">=</span><span class="st">&quot;1&quot;</span> width<span class="op">=</span><span class="st">&quot;100%&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>tr<span class="op">&gt;</span></span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;</span>th<span class="op">&gt;</span>id<span class="op">&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;</span>th<span class="op">&gt;</span>name<span class="op">&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;</span>th<span class="op">&gt;</span>age<span class="op">&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>tr<span class="op">&gt;</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;</span>c<span class="op">:</span>forEach <span class="dt">var</span><span class="op">=</span><span class="st">&quot;row&quot;</span> items<span class="op">=</span><span class="st">&quot;${result.rows}&quot;</span><span class="op">&gt;</span></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;</span>tr<span class="op">&gt;</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&lt;</span>td<span class="op">&gt;&lt;</span>c<span class="op">:</span>out value<span class="op">=</span><span class="st">&quot;${row.id}&quot;</span> <span class="op">/&gt;&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&lt;</span>td<span class="op">&gt;&lt;</span>c<span class="op">:</span>out value<span class="op">=</span><span class="st">&quot;${row.name}&quot;</span> <span class="op">/&gt;&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&lt;</span>td<span class="op">&gt;&lt;</span>c<span class="op">:</span>out value<span class="op">=</span><span class="st">&quot;${row.age}&quot;</span> <span class="op">/&gt;&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>                <span class="op">&lt;/</span>tr<span class="op">&gt;</span></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;/</span>c<span class="op">:</span>forEach<span class="op">&gt;</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;/</span>table<span class="op">&gt;</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>body<span class="op">&gt;</span></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>html<span class="op">&gt;</span></span></code></pre></div>
<h4 id="自定义标签">自定义标签</h4>
<p>自定义标签需要创建一个继承自<code>SimpleTagSupport</code>的类，还要创建一个tld文件用于描述自定义的标签</p>
<p>各方法的调用顺序：setJspContext-&gt;setParent-&gt;setXXX-&gt;setJspBody-&gt;doTag</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">//简单标签</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyIPTag <span class="kw">extends</span> SimpleTagSupport <span class="op">{</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    PageContext pageContext<span class="op">;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doTag</span><span class="op">()</span> <span class="kw">throws</span> JspException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest request <span class="op">=</span> <span class="op">(</span>HttpServletRequest<span class="op">)</span>pageContext<span class="op">.</span><span class="fu">getRequest</span><span class="op">();</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        JspWriter out <span class="op">=</span> <span class="fu">getJspContext</span><span class="op">().</span><span class="fu">getOut</span><span class="op">();</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> ip <span class="op">=</span> request<span class="op">.</span><span class="fu">getRemoteAddr</span><span class="op">();</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        out<span class="op">.</span><span class="fu">write</span><span class="op">(</span>ip<span class="op">);</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setJspContext</span><span class="op">(</span>JspContext jspContext<span class="op">)</span> <span class="op">{</span>        </span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">pageContext</span> <span class="op">=</span> <span class="op">(</span>PageContext<span class="op">)</span>jspContext<span class="op">;</span>  </span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="co">//有标签体和标签属性的复杂标签</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyComplexTag <span class="kw">extends</span> SimpleTagSupport <span class="op">{</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> attr1<span class="op">;</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doTag</span><span class="op">()</span> <span class="kw">throws</span> JspException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取标签体（如果有EL表达式或JSP动作元素(即JSP命名空间下的标签)会自动执行），并输出</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>        JspFragment jspFragment <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">getJspBody</span><span class="op">();</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">//invoke(null)会直接输出到页面上</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">//jspFragment.invoke(null);</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">//要更改输出的内容可以invoke到指定的writer中</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">StringWriter</span> sw <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringWriter</span><span class="op">();</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>        jspFragment<span class="op">.</span><span class="fu">invoke</span><span class="op">(</span>sw<span class="op">);</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">getJspContext</span><span class="op">().</span><span class="fu">getOut</span><span class="op">().</span><span class="fu">println</span><span class="op">(</span>sw<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">toUpperCase</span><span class="op">());</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">//输出属性</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>attr1 <span class="op">!=</span> <span class="kw">null</span><span class="op">){</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getJspContext</span><span class="op">().</span><span class="fu">getOut</span><span class="op">().</span><span class="fu">println</span><span class="op">(</span>attr1<span class="op">);</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">//标签嵌套时获取父标签属性并输出</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">//父标签无法获取子标签，但子标签能获取父标签，因为如果没有掉invoke，子标签就不会被初始化，解析器在解析时无法得知是否需要加载子标签</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>        JspTag parent <span class="op">=</span> <span class="fu">getParent</span><span class="op">();</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>parent <span class="kw">instanceof</span> MyComplexTag<span class="op">){</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>            MyComplexTag parentTag <span class="op">=</span> <span class="op">(</span>MyComplexTag<span class="op">)</span>parent<span class="op">;</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>            <span class="fu">getJspContext</span><span class="op">().</span><span class="fu">getOut</span><span class="op">().</span><span class="fu">println</span><span class="op">(</span>parentTag<span class="op">.</span><span class="fu">attr1</span><span class="op">);</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">//标签的属性会自动通过set方法设置</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setAttr1</span><span class="op">(</span><span class="bu">String</span> attr1<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">attr1</span> <span class="op">=</span> attr1<span class="op">;</span></span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>WEB-INF/mytag.tld</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span> <span class="fu">?&gt;</span>  </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">taglib</span><span class="ot"> xmlns=</span><span class="st">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span><span class="ot"> xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    xsi:schemaLocation=</span><span class="st">&quot;http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-jsptaglibrary_2_0.xsd&quot;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    version=</span><span class="st">&quot;2.0&quot;</span>&gt;</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">display-name</span>&gt;My Tag&lt;/<span class="kw">display-name</span>&gt;</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">description</span>&gt;This is my Tag&lt;/<span class="kw">description</span>&gt;</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tlib-version</span>&gt;1.0&lt;/<span class="kw">tlib-version</span>&gt;</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">jsp-version</span>&gt;2.0&lt;/<span class="kw">jsp-version</span>&gt;</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 建议在jsp中使用的前缀（prefix） --&gt;</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">short-name</span>&gt;my&lt;/<span class="kw">short-name</span>&gt;</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 用于唯一标识当前的TLD文件，该地址不需要真实存在，多个TLD文件的uri不能重复 --&gt;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">uri</span>&gt;http://mywebsite.com/mytag/my&lt;/<span class="kw">uri</span>&gt;</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tag</span>&gt;</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 标签名字 --&gt;</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">name</span>&gt;ip&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 标签对应的class --&gt;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">tag-class</span>&gt;webapp.jstl.MyIPTag&lt;/<span class="kw">tag-class</span>&gt;</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 标签类型，empty就是没有标签体的简单标签 --&gt;</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">body-content</span>&gt;empty&lt;/<span class="kw">body-content</span>&gt;</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">tag</span>&gt;</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 有标签体及标签属性的标签 --&gt;</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tag</span>&gt;</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">name</span>&gt;complex&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">tag-class</span>&gt;webapp.jstl.MyComplexTag&lt;/<span class="kw">tag-class</span>&gt;</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- scriptless表示标签体可以包含EL表达式或JSP动作元素，但不能包含JSP脚本（包括JSP表达式）</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co">             除了empty、scriptless外，还可以指定为tagdependent，表示标签体交由我们自己解析，标签体中的所有内容会原封不动地交给我们的标签处理器 --&gt;</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">body-content</span>&gt;scriptless&lt;/<span class="kw">body-content</span>&gt;</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">attribute</span>&gt;</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">name</span>&gt;attr1&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 以下参数是可选的 --&gt;</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">required</span>&gt;false&lt;/<span class="kw">required</span>&gt;</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">type</span>&gt;java.lang.String&lt;/<span class="kw">type</span>&gt;</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 能否使用JSP脚本或EL表达式 --&gt;</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">rtexprvalue</span>&gt;true&lt;/<span class="kw">rtexprvalue</span>&gt;</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 是否将该属性视为JspFragment --&gt;</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">fragment</span>&gt;false&lt;/<span class="kw">fragment</span>&gt;</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">attribute</span>&gt;</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">tag</span>&gt;</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">taglib</span>&gt;</span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java contextType=&quot;</span><span class="ot">text/html; charset</span>=<span class="st">UTF-8&quot; pageEncoding=&quot;</span><span class="ot">UTF-8&quot; </span><span class="bu">%&gt;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> prefix</span>=<span class="st">&quot;my&quot;</span><span class="ot"> uri</span>=<span class="st">&quot;http://mywebsite.com/mytag/my&quot;</span><span class="bu">%&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    &lt;head&gt;&lt;title&gt;mytag&lt;/title&gt;&lt;/head&gt;</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    &lt;body&gt;</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        我的IP是：<span class="kw">&lt;my:ip/&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        &lt;br<span class="ot"> </span>/&gt;</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;my:complex</span><span class="ot"> attr1</span>=<span class="dt">&quot;属性&quot;</span><span class="ot"> </span><span class="kw">&gt;</span>标签体<span class="kw">&lt;/my:complex&gt;</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;my:complex</span><span class="ot"> attr1</span>=<span class="dt">&quot;parent&quot;</span><span class="ot"> </span><span class="kw">&gt;</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;my:complex</span><span class="ot"> attr1</span>=<span class="dt">&quot;child&quot;</span><span class="ot"> </span><span class="kw">&gt;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>                child content</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/my:complex&gt;</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/my:complex&gt;</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    &lt;/body&gt;</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<h4 id="自定义el函数">自定义EL函数</h4>
<p>每个EL函数对应Java类中的一个静态方法，要求该Java类是public的，静态方法也是public的，然后还要通过编写tld文件用于描述自定义的EL函数</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyELFunction<span class="op">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">String</span> <span class="fu">concat</span><span class="op">(</span><span class="bu">String</span> str1<span class="op">,</span> <span class="bu">String</span> str2<span class="op">){</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> str1 <span class="op">+</span> str2<span class="op">;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>WEB-INF/myfunction.tld</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span> <span class="fu">?&gt;</span>  </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">taglib</span><span class="ot"> xmlns=</span><span class="st">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span><span class="ot"> xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    xsi:schemaLocation=</span><span class="st">&quot;http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-jsptaglibrary_2_0.xsd&quot;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    version=</span><span class="st">&quot;2.0&quot;</span>&gt;</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">display-name</span>&gt;My EL Function&lt;/<span class="kw">display-name</span>&gt;</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">description</span>&gt;This is my EL Function&lt;/<span class="kw">description</span>&gt;</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tlib-version</span>&gt;1.0&lt;/<span class="kw">tlib-version</span>&gt;</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">jsp-version</span>&gt;2.0&lt;/<span class="kw">jsp-version</span>&gt;</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">short-name</span>&gt;myfunc&lt;/<span class="kw">short-name</span>&gt;</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">uri</span>&gt;http://mywebsite.com/mytag/myfunc&lt;/<span class="kw">uri</span>&gt;</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span>&gt;</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">name</span>&gt;concat&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">function-class</span>&gt;webapp.jstl.MyELFunction&lt;/<span class="kw">function-class</span>&gt;</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">function-signature</span>&gt;java.lang.String concat(java.lang.String, java.lang.String)&lt;/<span class="kw">function-signature</span>&gt;</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">taglib</span>&gt;</span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java contextType=&quot;</span><span class="ot">text/html; charset</span>=<span class="st">UTF-8&quot; pageEncoding=&quot;</span><span class="ot">UTF-8&quot; </span><span class="bu">%&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> prefix</span>=<span class="st">&quot;myfunc&quot;</span><span class="ot"> uri</span>=<span class="st">&quot;http://mywebsite.com/mytag/myfunc&quot;</span><span class="bu">%&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="pp">${</span>myfunc<span class="op">:</span><span class="fu">concat</span><span class="op">(</span>param<span class="op">.</span><span class="fu">name1</span><span class="op">,</span> param<span class="op">.</span><span class="fu">name2</span><span class="op">)</span><span class="pp">}</span></span></code></pre></div>
<h2 id="三层架构和mvc">三层架构和mvc</h2>
<p>三层架构将整个项目划分为：</p>
<ul>
<li>表现层(WebUI): 一般由servlet、jsp页面、controller代码组成</li>
<li>业务逻辑层(BLL，一般称为service层):
负责调用持久层并实现业务逻辑</li>
<li>数据访问层(DAL，又叫持久层):
又叫DAO，一般包括POJO和repository，一般来说，一个POJO对应一个数据库表，repository则负责调用jdbc或其他ORM框架来完成对数据库的操作</li>
</ul>
<p>实际开发中一般会定义一套service接口和controller接口，然后新建一个impl的子包来完成对接口的实现，这时其他层就可以通过接口和IOC框架获取对象，从而实现各层之间的解耦</p>
<p>一般目录结构如下：</p>
<pre><code>├── controller
│   └── UserController.java
├── dao
│   ├── pojo
│   │   └── User.java
│   └── repository
│       ├── impl
│       │   └── UserDaoImpl.java
│       └── IUserDao.java
└── service
    ├── impl
    │   └── UserServiceImpl.java
    └── IUserSerivce.java</code></pre>
<p>MVC为：</p>
<ul>
<li>Model(模型): 一般称为VO，放在表现层的POJO叫做VO</li>
<li>View(视图): 一般为jsp页面</li>
<li>Controller(控制): 负责处理url和调用service层</li>
</ul>
<p>MVC是三层架构中的表现层的一种架构</p>
<h2 id="spring">Spring</h2>
<p><a href="https://spring.io/projects/spring-framework">Spring
Framework</a></p>
<p><a href="http://spring.io/docs/reference">Spring Docs</a></p>
<p><a href="http://spring.cndocs.ml/">Spring中文文档</a></p>
<p>项目结构</p>
<pre><code>src
├── applicationContext.xml
├── jdbc.properties
├── config
│   └── SpringConfig.java
├── controller
│   └── UserController.java
├── dao
│   ├── pojo
│   │   └── User.java
│   └── repository
│       ├── impl
│       │   └── UserDaoImpl.java
│       └── IUserDao.java
├── service
│   ├── impl
│   │   └── UserServiceImpl.java
│   └── IUserService.java
├── test
│   └── Test.java
└── Utils
    ├── LogUtils.java
    └── UserFactory.java
</code></pre>
<h3 id="ioc">IOC</h3>
<h4 id="xml">xml</h4>
<p>原理：通过<code>Class.forName</code>的方式，获取接口实现类的实例，这样的话只要接口写好了，就能通过接口调用，各模块就可以同时开发。为了方便维护，一般会选择xml或者注解等非硬编码的方式把实现类的类名抽取出来，根据id获取对应实例（Bean默认是单例的）</p>
<h5 id="直接注入">直接注入</h5>
<p>使用xml的方式把bean注入到容器中：</p>
<p>在src下创建<code>applicationContext.xml</code>，内容如下</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>/&gt;</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p><strong>Bean的属性</strong></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span><span class="ot"> init-method=</span><span class="st">&quot;init&quot;</span><span class="ot"> destroy-method=</span><span class="st">&quot;destory&quot;</span><span class="ot"> lazy-init=</span><span class="st">&quot;true&quot;</span><span class="ot"> scope=</span><span class="st">&quot;prototype&quot;</span>/&gt;</span></code></pre></div>
<ul>
<li>init-method: 初始化时执行的函数</li>
<li>destroy-method: 销毁时执行的函数</li>
<li>lazy-init:
是否懒加载，默认ApplicationContext是立即加载，BeanFactory是懒加载</li>
<li>scope:
作用域，可以指定为：prototype(多例，每次getBean获取的是不同实例)、singleton(单例)、request、session、globalSession，后面这三个可选值是针对web应用</li>
</ul>
<h5 id="工厂模式注入">工厂模式注入</h5>
<p>如果是通过工厂模式创建的，可以：</p>
<ul>
<li>非静态工厂方法</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserFactory <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> UserDaoImpl <span class="fu">createUser</span><span class="op">(){</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserDaoImpl</span><span class="op">();</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对应xml</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 先创建工厂的bean，然后再使用其工厂方法 --&gt;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;Utils.UserFactory&quot;</span> /&gt;</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> factory-bean=</span><span class="st">&quot;userFactory&quot;</span><span class="ot"> factory-method=</span><span class="st">&quot;createUser&quot;</span> /&gt;</span></code></pre></div>
<ul>
<li>静态工厂方法</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserFactory <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">static</span> <span class="kw">public</span> UserDaoImpl <span class="fu">createUser</span><span class="op">(){</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserDaoImpl</span><span class="op">();</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对应xml</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 静态的工厂方法无需创建工厂的bean，直接使用工厂方法即可 --&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;Utils.UserFactory&quot;</span><span class="ot"> factory-method=</span><span class="st">&quot;createUser&quot;</span> /&gt;</span></code></pre></div>
<h5 id="含参数的注入">含参数的注入</h5>
<p>如果Bean的创建需要参数</p>
<ul>
<li>通过构造函数传入</li>
</ul>
<div class="sourceCode" id="cb53"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="fu">UserDaoImpl</span><span class="op">(</span><span class="bu">String</span> arg1<span class="op">,</span><span class="bu">List</span> arg2<span class="op">,</span><span class="bu">Map</span> arg3<span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对应xml</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>&gt;</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> index=</span><span class="st">&quot;0&quot;</span><span class="ot"> value=</span><span class="st">&quot;hello&quot;</span>/&gt;</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> index=</span><span class="st">&quot;1&quot;</span>&gt;</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- list和array可以不区分，只要数据结构相同，标签可以互换 --&gt;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">list</span>&gt;</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">value</span>&gt;1&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">value</span>&gt;2&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">list</span>&gt;</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> index=</span><span class="st">&quot;2&quot;</span>&gt;</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- map和prop也可以互换 --&gt;</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">map</span>&gt;</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">entry</span><span class="ot"> key=</span><span class="st">&quot;1&quot;</span><span class="ot"> value=</span><span class="st">&quot;hello&quot;</span>/&gt;</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">entry</span><span class="ot"> key=</span><span class="st">&quot;2&quot;</span><span class="ot"> value=</span><span class="st">&quot;world&quot;</span>/&gt;</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">map</span>&gt;</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span></code></pre></div>
<ul>
<li>通过get、set方法传入</li>
</ul>
<div class="sourceCode" id="cb55"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>User arg1<span class="op">;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setArg1</span><span class="op">(</span>User arg1<span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">arg1</span> <span class="op">=</span> arg1<span class="op">;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对应xml</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;user&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.pojo.User&quot;</span>/&gt;</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>&gt;</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 复杂数据类型使用ref --&gt;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;arg1&quot;</span><span class="ot"> ref=</span><span class="st">&quot;user&quot;</span>/&gt;</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span></code></pre></div>
<h5 id="通过代码获取">通过代码获取</h5>
<p>通过代码获取bean：</p>
<p>先在UserDaoImpl的构造函数中增加<code>System.out.println(&quot;UserDaoImpl init&quot;)</code>，以观察加载顺序</p>
<p><strong>使用<code>ApplicationContext</code> </strong></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">//classpath:就是指src目录下，可以省略</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>ApplicationContext ap <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;classpath:applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;applicationContext loaded&quot;</span><span class="op">);</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>IUserDao userDao1 <span class="op">=</span> <span class="op">(</span>IUserDao<span class="op">)</span> ap<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userDao&quot;</span><span class="op">);</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userDao1<span class="op">.</span><span class="fu">findUserById</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code></pre></div>
<p>输出</p>
<pre><code>UserDaoImpl init
applicationContext loaded
User{id=1, name=&#39;root&#39;, pwd=&#39;123456&#39;}</code></pre>
<p><strong>使用<code>BeanFactory</code> </strong></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>BeanFactory bf <span class="op">=</span> <span class="kw">new</span> <span class="fu">XmlBeanFactory</span><span class="op">(</span><span class="kw">new</span> <span class="fu">FileSystemResource</span><span class="op">(</span><span class="kw">new</span> <span class="bu">File</span><span class="op">(</span><span class="st">&quot;src/applicationContext.xml&quot;</span><span class="op">)));</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;beanFactory loaded&quot;</span><span class="op">);</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>IUserDao userDao2 <span class="op">=</span> <span class="op">(</span>IUserDao<span class="op">)</span> bf<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userDao&quot;</span><span class="op">);</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userDao2<span class="op">.</span><span class="fu">findUserById</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code></pre></div>
<p>输出</p>
<pre><code>beanFactory loaded
UserDaoImpl init
User{id=1, name=&#39;root&#39;, pwd=&#39;123456&#39;}</code></pre>
<p><code>ApplicationContext</code>和<code>BeanFactory</code>都可以获取bean，但<code>ApplicationContext</code>是立即加载，<code>BeanFactory</code>是懒加载</p>
<h4 id="注解">注解</h4>
<p>使用注解需要开启扫描</p>
<ul>
<li>通过xml开启（xml与注解共存；需要用到context命名空间）</li>
</ul>
<div class="sourceCode" id="cb61"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;dao&quot;</span>/&gt;</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;service&quot;</span>/&gt;</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<ul>
<li>通过注解开启（一般都是新建一个空的类用于使用注解配置Spring，使用纯注解开发就不需要applicationContext.xml了）</li>
</ul>
<div class="sourceCode" id="cb62"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="at">@ComponentScan</span><span class="op">({</span><span class="st">&quot;dao&quot;</span><span class="op">,</span><span class="st">&quot;service&quot;</span><span class="op">})</span><span class="co">//扫描IOC</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span><span class="co">//配置类需要使用该注解</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时需要使用该类创建ApplicationContext</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    ApplicationContext ap <span class="op">=</span> <span class="kw">new</span> <span class="fu">AnnotationConfigApplicationContext</span><span class="op">(</span>SpringConfig<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    IUserDao userDao1 <span class="op">=</span> <span class="op">(</span>IUserDao<span class="op">)</span> ap<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userDao&quot;</span><span class="op">);</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userDao1<span class="op">.</span><span class="fu">findUserById</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="通过注解注入">通过注解注入</h5>
<p>也可以通过注解把bean注入到容器中：</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span><span class="op">(</span><span class="st">&quot;userDao&quot;</span><span class="op">)</span><span class="co">//指定id为userDao，也可以不指定，默认id为类名（首字母小写）</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserDaoImpl <span class="kw">implements</span> IUserDao <span class="op">{</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span><span class="op">{</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">//模拟查询数据库操作</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="st">&quot;root&quot;</span><span class="op">,</span><span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;插入了用户&quot;</span> <span class="op">+</span> user<span class="op">);</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>@Component</code>、<code>@Controller</code>、<code>@Service</code>、<code>@Repository</code>的作用是一样的，一般为了代码的可读性会在不同的层使用不同的注解</p>
<h5 id="通过注解获取">通过注解获取</h5>
<p>通过注解获取</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Autowired</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co">//@Qualifier(&quot;userDao&quot;)</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">//@Resource(name=&quot;userDao&quot;)//name就是对应的id</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>IUserDao userDao<span class="op">;</span></span></code></pre></div>
<ul>
<li><code>@Autowired</code>: 根据类型匹配，有多个会报错</li>
<li><code>@Qualifier</code>:
先根据类型匹配，如果有多个，则按照变量名作为id匹配</li>
<li><code>@Resource</code>: 直接根据指定的id匹配</li>
</ul>
<p>如果通过注解把bean注入到容器中时，使用了<code>@Primary</code>，则表示在匹配时如果有多个，则使用该bean作为默认值，<code>@Autowired</code>和<code>@Qualifier</code>都支持使用默认值，但<code>@Resource</code>不支持</p>
<p>对于基本数据类型，可以使用<code>@Value</code>注入，一般配合<code>@PropertySource</code>使用</p>
<h4 id="循环依赖注入问题">循环依赖注入问题</h4>
<p>A依赖于B，B依赖于C，C又依赖于A，这样就形成了一个依赖环</p>
<p>解决循环依赖也很简单，因为对象的field或则属性是可以延后设置的，只要在构造函数中没有用到依赖的类，那么我们可以先初始化A、B、C三个类，然后在调用各自的set方法，把依赖传入（而非在创建Bean的时候就调用set传入）</p>
<p>Spring在创建Bean的时候使用三级缓存来解决这个问题</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> Cache of singleton objects<span class="co">:</span> bean name <span class="co">--&gt;</span> bean instance <span class="co">*/</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> singletonObjects <span class="op">=</span> <span class="kw">new</span> <span class="bu">ConcurrentHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;(</span><span class="dv">256</span><span class="op">);</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> Cache of singleton factories<span class="co">:</span> bean name <span class="co">--&gt;</span> ObjectFactory <span class="co">*/</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">ObjectFactory</span><span class="op">&lt;?&gt;&gt;</span> singletonFactories <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">ObjectFactory</span><span class="op">&lt;?&gt;&gt;(</span><span class="dv">16</span><span class="op">);</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span> Cache of early singleton objects<span class="co">:</span> bean name <span class="co">--&gt;</span> bean instance <span class="co">*/</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> earlySingletonObjects <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;(</span><span class="dv">16</span><span class="op">);</span></span></code></pre></div>
<p>创建Bean的代码：</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">protected</span> <span class="bu">Object</span> <span class="fu">getSingleton</span><span class="op">(</span><span class="bu">String</span> beanName<span class="op">,</span> <span class="dt">boolean</span> allowEarlyReference<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Object</span> singletonObject <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">singletonObjects</span><span class="op">.</span><span class="fu">get</span><span class="op">(</span>beanName<span class="op">);</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>singletonObject <span class="op">==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="fu">isSingletonCurrentlyInCreation</span><span class="op">(</span>beanName<span class="op">))</span> <span class="op">{</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">synchronized</span> <span class="op">(</span><span class="kw">this</span><span class="op">.</span><span class="fu">singletonObjects</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>            singletonObject <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">earlySingletonObjects</span><span class="op">.</span><span class="fu">get</span><span class="op">(</span>beanName<span class="op">);</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>singletonObject <span class="op">==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> allowEarlyReference<span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>                <span class="bu">ObjectFactory</span><span class="op">&lt;?&gt;</span> singletonFactory <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">singletonFactories</span><span class="op">.</span><span class="fu">get</span><span class="op">(</span>beanName<span class="op">);</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>singletonFactory <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>                    singletonObject <span class="op">=</span> singletonFactory<span class="op">.</span><span class="fu">getObject</span><span class="op">();</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">this</span><span class="op">.</span><span class="fu">earlySingletonObjects</span><span class="op">.</span><span class="fu">put</span><span class="op">(</span>beanName<span class="op">,</span> singletonObject<span class="op">);</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">this</span><span class="op">.</span><span class="fu">singletonFactories</span><span class="op">.</span><span class="fu">remove</span><span class="op">(</span>beanName<span class="op">);</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span>singletonObject <span class="op">!=</span> NULL_OBJECT <span class="op">?</span> singletonObject <span class="op">:</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Spring首先从一级缓存<code>singletonObjects</code>中获取。如果获取不到，并且对象正在创建中，就再从二级缓存<code>earlySingletonObjects</code>中获取。如果还是获取不到且允许<code>singletonFactories</code>通过getObject()获取，就从三级缓存<code>singletonFactory</code>获取，如果获取到了则从<code>singletonFactories</code>中移除，并放入<code>earlySingletonObjects</code>中，其实也就是从三级缓存移动到了二级缓存</p>
<p>从上述分析可知，Spring无法解决两种情况下的循环依赖</p>
<ol type="1">
<li>构造器参数循环依赖</li>
<li>prototype类型的Bean的依赖，因为prototype类型的Bean的生命周期不是由Spring进行管理的，所以Spring不会对prototype类的Bean进行缓存</li>
</ol>
<p>只有在Bean是singleton类型且构造器参数不需要传入依赖的Bean的时候，才能解决循环依赖的问题</p>
<h3 id="aop">AOP</h3>
<p>持久层和业务层通过IOC把数据库的操作解耦了，但数据库的事务、日志等仍然需要写在业务层，而且会有大量的重复代码，这时就需要使用AOP</p>
<p>AOP术语：</p>
<p><strong>1.通知（Advice）</strong></p>
<p>织入到目标类连接点上的一段程序代码，就是要实现的功能，比如记录日志、过滤等，一般是静态工具类来实现这些功能</p>
<p><strong>2.连接点（Joinpoint）</strong></p>
<p>使用通知的地方，Spring支持的有方法开头、方法中try结束位置、出现异常时catch处、函数返回前，我们也可以通过获取代理对象（ProceedingJoinPoint）指定在何处使用通知（joinpoint.proceed）</p>
<p><strong>3.切入点（Pointcut）</strong></p>
<p>要使用通知的方法，连接点确定了方法中使用通知的位置，而哪些方法使用则由切入点表达式确定</p>
<p><strong>4.切面（Aspect）</strong></p>
<p>切面定义通知和切入点，Spring
AOP就是负责实施切面的框架，它将切面所定义的横切逻辑织入到切面所指定的连接点中</p>
<p><strong>5.引入（Introduction）</strong></p>
<p>允许我们向被切入点选中的类中添加新方法属性，可以通过在通知类中定义属性来实现</p>
<p><strong>6.目标对象（Target）</strong></p>
<p>被切入点表达式选中的类，即要使用通知的类</p>
<p><strong>7.代理（Proxy）</strong></p>
<p>Spring AOP实现原理就是动态代理</p>
<p><strong>8.织入（Weaving）</strong></p>
<p>把切面应用到目标对象来创建新的代理对象的过程，织入有三种方式：编译期织入、类装载期织入、动态代理织入。Spring使用的是动态代理织入，而AspectJ采用编译期织入和类装载期织入</p>
<h4 id="xml-1">xml</h4>
<p>通过xml配置（需要用到aop命名空间）</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>/&gt;</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userService&quot;</span><span class="ot"> class=</span><span class="st">&quot;service.impl.UserServiceImpl&quot;</span>&gt;</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> ref=</span><span class="st">&quot;userDao&quot;</span>/&gt;</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;logUtils&quot;</span><span class="ot"> class=</span><span class="st">&quot;Utils.LogUtils&quot;</span>/&gt;</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">aop:config</span>&gt;</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- pointcut: 切入点表达式，表示切入service包及其子包下 方法名以get开头的所有方法（权限修饰符可以省略）</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">         全通配： *  *..*.*(..)--&gt;</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:pointcut</span><span class="ot"> id=</span><span class="st">&quot;pt1&quot;</span><span class="ot"> expression=</span><span class="st">&quot;execution(* service..*.get*(..))&quot;</span>/&gt;</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- logUtils: 通知类 --&gt;</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:aspect</span><span class="ot"> ref=</span><span class="st">&quot;logUtils&quot;</span>&gt;</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="co">         通知类型分为：</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co">         before:开始执行方法前调用 </span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="co">         after-returning: 执行完方法且没有异常时调用</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="co">         after-throwing: 出现异常时调用</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="co">         after: 方法执行完后调用</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">aop:before</span><span class="ot"> method=</span><span class="st">&quot;logBefore&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span>/&gt;</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">aop:after-returning</span><span class="ot"> method=</span><span class="st">&quot;logAfterReturning&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span>/&gt;</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">aop:after-throwing</span><span class="ot"> method=</span><span class="st">&quot;logAfterThrowing&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span>/&gt;</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">aop:after</span><span class="ot"> method=</span><span class="st">&quot;logAfter&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span>/&gt;</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">aop:aspect</span>&gt;</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">aop:config</span>&gt;</span></code></pre></div>
<p>LogUtils.java</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogUtils <span class="op">{</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logBefore</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;before&quot;</span><span class="op">);</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfterReturning</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after returning&quot;</span><span class="op">);</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfterThrowing</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after throwing&quot;</span><span class="op">);</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfter</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after&quot;</span><span class="op">);</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>UserServiceImpl.java</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceImpl <span class="kw">implements</span> IUserService <span class="op">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    IUserDao userDao<span class="op">;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUserDao</span><span class="op">(</span>IUserDao userDao<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userDao</span> <span class="op">=</span> userDao<span class="op">;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">getUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span><span class="op">{</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userDao<span class="op">.</span><span class="fu">findUserById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>        userDao<span class="op">.</span><span class="fu">insertUser</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>ApplicationContext ap <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;classpath:applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>IUserService userService <span class="op">=</span> <span class="op">(</span>IUserService<span class="op">)</span> ap<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userService&quot;</span><span class="op">);</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userService<span class="op">.</span><span class="fu">getUserById</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span></code></pre></div>
<p>输出</p>
<pre><code>before
after returning
after
User{id=1, name=&#39;root&#39;, pwd=&#39;123456&#39;}</code></pre>
<p><strong>环绕通知</strong></p>
<p>环绕通知可以替代上面的四个通知（before、after-returning、after-throwing、after）</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>/&gt;</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userService&quot;</span><span class="ot"> class=</span><span class="st">&quot;service.impl.UserServiceImpl&quot;</span>&gt;</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> ref=</span><span class="st">&quot;userDao&quot;</span>/&gt;</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;logUtils&quot;</span><span class="ot"> class=</span><span class="st">&quot;Utils.LogUtils&quot;</span>/&gt;</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">aop:config</span>&gt;</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:pointcut</span><span class="ot"> id=</span><span class="st">&quot;pt1&quot;</span><span class="ot"> expression=</span><span class="st">&quot;execution(* service..*.get*(..))&quot;</span>/&gt;</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:aspect</span><span class="ot"> ref=</span><span class="st">&quot;logUtils&quot;</span>&gt;</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">aop:around</span><span class="ot"> method=</span><span class="st">&quot;logAround&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span>/&gt;</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">aop:aspect</span>&gt;</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">aop:config</span>&gt;</span></code></pre></div>
<p>logUtils.java</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogUtils <span class="op">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//环绕通知需要加ProceedingJoinPoint的参数</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">logAround</span><span class="op">(</span>ProceedingJoinPoint joinpoint<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> result <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - before&quot;</span><span class="op">);</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> joinpoint<span class="op">.</span><span class="fu">proceed</span><span class="op">(</span>joinpoint<span class="op">.</span><span class="fu">getArgs</span><span class="op">());</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after returning&quot;</span><span class="op">);</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Throwable</span> throwable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>            throwable<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after throwing&quot;</span><span class="op">);</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after&quot;</span><span class="op">);</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="注解-1">注解</h4>
<p>使用注解AOP也需要开启扫描</p>
<p>xml方式</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">aop:aspectj-autoproxy</span> /&gt;</span></code></pre></div>
<p>注解方式（此时也需要使用AnnotationConfigApplicationContext来加载）</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableAspectJAutoProxy</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>通知类LogUtils.java</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span><span class="co">//通知类也需要加入容器</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Aspect</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogUtils <span class="op">{</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Pointcut</span><span class="op">(</span><span class="st">&quot;execution(* service..*.get*(..))&quot;</span><span class="op">)</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">pt1</span><span class="op">()</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Before</span><span class="op">(</span><span class="st">&quot;pt1()&quot;</span><span class="op">)</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logBefore</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;before&quot;</span><span class="op">);</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@AfterReturning</span><span class="op">(</span><span class="st">&quot;pt1()&quot;</span><span class="op">)</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfterReturning</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after returning&quot;</span><span class="op">);</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@AfterThrowing</span><span class="op">(</span><span class="st">&quot;pt1()&quot;</span><span class="op">)</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfterThrowing</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after throwing&quot;</span><span class="op">);</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@After</span><span class="op">(</span><span class="st">&quot;pt1()&quot;</span><span class="op">)</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">logAfter</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;after&quot;</span><span class="op">);</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Around</span><span class="op">(</span><span class="st">&quot;pt1()&quot;</span><span class="op">)</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">logAround</span><span class="op">(</span>ProceedingJoinPoint joinpoint<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> result <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - before&quot;</span><span class="op">);</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> joinpoint<span class="op">.</span><span class="fu">proceed</span><span class="op">(</span>joinpoint<span class="op">.</span><span class="fu">getArgs</span><span class="op">());</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after returning&quot;</span><span class="op">);</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Throwable</span> throwable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>            throwable<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after throwing&quot;</span><span class="op">);</span></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;around - after&quot;</span><span class="op">);</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="txmanager">txManager</h3>
<h4 id="jdbctemplate">JdbcTemplate</h4>
<div class="sourceCode" id="cb78"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>DriverManagerDataSource dataSource <span class="op">=</span> <span class="kw">new</span> <span class="fu">DriverManagerDataSource</span><span class="op">();</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>dataSource<span class="op">.</span><span class="fu">setDriverClassName</span><span class="op">(</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span><span class="op">);</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>dataSource<span class="op">.</span><span class="fu">setUrl</span><span class="op">(</span><span class="st">&quot;jdbc:mysql:///user?useUnicode=true&amp;characterEncoding=UTF-8&quot;</span><span class="op">);</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>dataSource<span class="op">.</span><span class="fu">setUsername</span><span class="op">(</span><span class="st">&quot;root&quot;</span><span class="op">);</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>dataSource<span class="op">.</span><span class="fu">setPassword</span><span class="op">(</span><span class="st">&quot;root&quot;</span><span class="op">);</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>JdbcTemplate template <span class="op">=</span> <span class="kw">new</span> <span class="fu">JdbcTemplate</span><span class="op">(</span>dataSource<span class="op">);</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>template<span class="op">.</span><span class="fu">execute</span><span class="op">(</span><span class="st">&quot;CREATE TABLE user(id INT PRIMARY KEY, name VARCHAR(32), pwd VARCHAR(32))default charset = utf8&quot;</span><span class="op">);</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>template<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="st">&quot;INSERT INTO user VALUES(?,?,?)&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">,</span> <span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> list <span class="op">=</span> template<span class="op">.</span><span class="fu">query</span><span class="op">(</span><span class="st">&quot;select * from user&quot;</span><span class="op">,</span> <span class="kw">new</span> BeanPropertyRowMapper<span class="op">&lt;</span>User<span class="op">&gt;(</span>User<span class="op">.</span><span class="fu">class</span><span class="op">));</span></span></code></pre></div>
<p>也可以手动实现rowMapper</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> list <span class="op">=</span> template<span class="op">.</span><span class="fu">query</span><span class="op">(</span><span class="st">&quot;select * from user&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">RowMapper</span><span class="op">&lt;</span>User<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">mapRow</span><span class="op">(</span><span class="bu">ResultSet</span> rs<span class="op">,</span> <span class="dt">int</span> rowNum<span class="op">)</span> <span class="kw">throws</span> <span class="bu">SQLException</span> <span class="op">{</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">();</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>        user<span class="op">.</span><span class="fu">setId</span><span class="op">(</span>rs<span class="op">.</span><span class="fu">getInt</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">));</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>        user<span class="op">.</span><span class="fu">setName</span><span class="op">(</span>rs<span class="op">.</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">));</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        user<span class="op">.</span><span class="fu">setPwd</span><span class="op">(</span>rs<span class="op">.</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;pwd&quot;</span><span class="op">));</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>也可以通过xml获取Template</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;driverClassName&quot;</span>&gt;&lt;<span class="kw">value</span>&gt;com.mysql.jdbc.Driver&lt;/<span class="kw">value</span>&gt;&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;url&quot;</span>&gt;&lt;<span class="kw">value</span>&gt;jdbc:mysql:///user?useUnicode=true<span class="er">&amp;</span>characterEncoding=UTF-8&lt;/<span class="kw">value</span>&gt;&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span>&gt;&lt;<span class="kw">value</span>&gt;root&lt;/<span class="kw">value</span>&gt;&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;&lt;<span class="kw">value</span>&gt;root&lt;/<span class="kw">value</span>&gt;&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;jdbcTemplate&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>/&gt;</span></code></pre></div>
<h4 id="transactionmanager">transactionManager</h4>
<p>数据的并发问题：</p>
<ul>
<li>脏读:
事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据</li>
<li>不可重复读: 事务 A 多次读取同一数据，事务 B
在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果
不一致</li>
<li>幻读:
系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读</li>
</ul>
<p>MySQL的事务隔离级别：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">隔离级别</th>
<th style="text-align: center;">脏读</th>
<th style="text-align: center;">不可重复读</th>
<th style="text-align: center;">幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">读未提交(read-uncommitted)</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
</tr>
<tr>
<td style="text-align: left;">不可重复读(read-committed)</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
</tr>
<tr>
<td style="text-align: left;">可重复读(repeatable-read)</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">是</td>
</tr>
<tr>
<td style="text-align: left;">串行化(serializable)</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">否</td>
</tr>
</tbody>
</table>
<p>Spring的事务传播机制：</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 70%" />
</colgroup>
<thead>
<tr>
<th>事务传播行为类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>PROPAGATION_REQUIRED</td>
<td>如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。这是最常见的选择。</td>
</tr>
<tr>
<td>PROPAGATION_SUPPORTS</td>
<td>支持当前事务，如果当前没有事务，就以非事务方式执行。</td>
</tr>
<tr>
<td>PROPAGATION_MANDATORY</td>
<td>使用当前的事务，如果当前没有事务，就抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRES_NEW</td>
<td>新建事务，如果当前存在事务，把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION_NOT_SUPPORTED</td>
<td>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</td>
</tr>
<tr>
<td>PROPAGATION_NEVER</td>
<td>以非事务方式执行，如果当前存在事务，则抛出异常。</td>
</tr>
<tr>
<td>PROPAGATION_NESTED</td>
<td>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作。</td>
</tr>
</tbody>
</table>
<h5 id="代码使用">代码使用</h5>
<p>要求<code>TransactionManager</code>和<code>JdbcTemplate</code>（或者其他ORM框架）使用的是同一个<code>DataSource</code></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>ApplicationContext ac <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="bu">DataSource</span> dataSource <span class="op">=</span> <span class="op">(</span><span class="bu">DataSource</span><span class="op">)</span> ac<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;dataSource&quot;</span><span class="op">);</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>IUserService userService <span class="op">=</span> <span class="op">(</span>IUserService<span class="op">)</span> ac<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userService&quot;</span><span class="op">);</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>DataSourceTransactionManager transactionManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">DataSourceTransactionManager</span><span class="op">(</span>dataSource<span class="op">);</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">//通过TransactionDefinition配置事务隔离级别、传播机制等</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>DefaultTransactionDefinition definition <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultTransactionDefinition</span><span class="op">();</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>definition<span class="op">.</span><span class="fu">setIsolationLevel</span><span class="op">(</span>TransactionDefinition<span class="op">.</span><span class="fu">ISOLATION_READ_COMMITTED</span><span class="op">);</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>definition<span class="op">.</span><span class="fu">setPropagationBehavior</span><span class="op">(</span>TransactionDefinition<span class="op">.</span><span class="fu">PROPAGATION_REQUIRED</span><span class="op">);</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>definition<span class="op">.</span><span class="fu">setTimeout</span><span class="op">(-</span><span class="dv">1</span><span class="op">);</span><span class="co">//永不超时</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co">//开启事务</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>TransactionStatus status <span class="op">=</span> transactionManager<span class="op">.</span><span class="fu">getTransaction</span><span class="op">(</span>definition<span class="op">);</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">{</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    userService<span class="op">.</span><span class="fu">insertUser</span><span class="op">(</span><span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="st">&quot;小红&quot;</span><span class="op">,</span> <span class="st">&quot;root&quot;</span><span class="op">));</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">//提交</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    transactionManager<span class="op">.</span><span class="fu">commit</span><span class="op">(</span>status<span class="op">);</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//回滚</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    transactionManager<span class="op">.</span><span class="fu">rollback</span><span class="op">(</span>status<span class="op">);</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>UserDaoImpl（这里的<code>DataSource</code>是通过容器管理的单例的<code>DataSource</code>，每次getBean获得的都是同一个实例）</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserDaoImpl <span class="kw">implements</span> IUserDao<span class="op">,</span> ApplicationContextAware <span class="op">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//方法1：通过实现ApplicationContextAware接口获取ApplicationContext，在通过ApplicationContext获取DataSource或者JdbcTemplate</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    ApplicationContext applicationContext<span class="op">;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//方法2：使用注解获取</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    JdbcTemplate template<span class="op">;</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//方法3：继承JdbcDaoSupport，里面其实就是自动设置了JdbcTemplate属性（略）</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> template<span class="op">.</span><span class="fu">queryForObject</span><span class="op">(</span><span class="st">&quot;select * from user where id=?&quot;</span><span class="op">,</span><span class="kw">new</span> <span class="bu">Object</span><span class="op">[]{</span>id<span class="op">},</span> <span class="kw">new</span> BeanPropertyRowMapper<span class="op">&lt;</span>User<span class="op">&gt;(</span>User<span class="op">.</span><span class="fu">class</span><span class="op">));</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> user<span class="op">;</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">DataSource</span> dataSource <span class="op">=</span> <span class="op">(</span><span class="bu">DataSource</span><span class="op">)</span> applicationContext<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;dataSource&quot;</span><span class="op">);</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>        JdbcTemplate template <span class="op">=</span> <span class="kw">new</span> <span class="fu">JdbcTemplate</span><span class="op">(</span>dataSource<span class="op">);</span></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>        template<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="st">&quot;insert into user value(?,?,?)&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> user<span class="op">.</span><span class="fu">getName</span><span class="op">(),</span> user<span class="op">.</span><span class="fu">getPwd</span><span class="op">());</span></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setApplicationContext</span><span class="op">(</span>ApplicationContext applicationContext<span class="op">)</span> <span class="kw">throws</span> BeansException <span class="op">{</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">applicationContext</span> <span class="op">=</span> applicationContext<span class="op">;</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h5 id="xml使用">xml使用</h5>
<p>AOP式事务（包括xml和注解）是通过检测函数是否抛出unchecked
exception（即Error、RunTimeException及其子类）来决定是否进行回滚的，如果在代码中使用try、catch截获了异常并且没有再抛出，则是不会回滚的；而且如果抛出的异常是checked
exception（即普通Exception，比如IOException、NullPointerException），也是不会回滚的，这时需要我们指定<code>rollback-for</code>参数对指定异常进行回滚</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> class=</span><span class="st">&quot;dao.repository.impl.UserDaoImpl&quot;</span>/&gt;</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;userService&quot;</span><span class="ot"> class=</span><span class="st">&quot;service.impl.UserServiceImpl&quot;</span>&gt;</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;userDao&quot;</span><span class="ot"> ref=</span><span class="st">&quot;userDao&quot;</span>/&gt;</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;driverClassName&quot;</span><span class="ot"> value=</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;url&quot;</span><span class="ot"> value=</span><span class="st">&quot;jdbc:mysql:///user?useUnicode=true</span><span class="dv">&amp;amp;</span><span class="st">characterEncoding=UTF-8&quot;</span>/&gt;</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span><span class="ot"> value=</span><span class="st">&quot;root&quot;</span>/&gt;</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span><span class="ot"> value=</span><span class="st">&quot;root&quot;</span>/&gt;</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;transactionManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> ref=</span><span class="st">&quot;dataSource&quot;</span>/&gt;</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 为insertUser方法添加事务，这里也可以使用通配符 --&gt;</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">tx:advice</span><span class="ot"> id=</span><span class="st">&quot;txadvice1&quot;</span><span class="ot"> transaction-manager=</span><span class="st">&quot;transactionManager&quot;</span>&gt;</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tx:attributes</span>&gt;</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">tx:method</span><span class="ot"> name=</span><span class="st">&quot;insertUser&quot;</span><span class="ot"> isolation=</span><span class="st">&quot;READ_COMMITTED&quot;</span><span class="ot"> propagation=</span><span class="st">&quot;REQUIRED&quot;</span><span class="ot"> read-only=</span><span class="st">&quot;false&quot;</span><span class="ot"> timeout=</span><span class="st">&quot;-1&quot;</span><span class="ot"> rollback-for=</span><span class="st">&quot;java.io.IOException&quot;</span>/&gt;</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">tx:attributes</span>&gt;</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">tx:advice</span>&gt;</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">aop:config</span>&gt;</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:pointcut</span><span class="ot"> id=</span><span class="st">&quot;pt1&quot;</span><span class="ot"> expression=</span><span class="st">&quot;execution(public * service..*.*(..))&quot;</span> /&gt;</span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">aop:advisor</span><span class="ot"> advice-ref=</span><span class="st">&quot;txadvice1&quot;</span><span class="ot"> pointcut-ref=</span><span class="st">&quot;pt1&quot;</span> /&gt;</span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">aop:config</span>&gt;</span></code></pre></div>
<p>测试是否回滚（这里不会回滚，因为这里的异常是java.lang.ArithmeticException，不是Error或RuntimeException）：</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Override</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    userDao<span class="op">.</span><span class="fu">insertUser</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="注解使用">注解使用</h5>
<p>使用注解事务也需要开启扫描（需要用到tx命名空间，同时通过<code>context:component-scan</code>指定要扫描的包）</p>
<p>xml方式</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">tx:annotation-driven</span><span class="ot"> transaction-manager=</span><span class="st">&quot;transactionManager&quot;</span> /&gt;</span></code></pre></div>
<p>注解方式</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableTransactionManagement</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>UserDaoImpl.java</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> rollbackFor <span class="op">=</span> <span class="op">{</span> <span class="bu">Exception</span><span class="op">.</span><span class="fu">class</span> <span class="op">})</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserDaoImpl <span class="kw">implements</span> IUserDao <span class="op">{</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="st">&quot;root&quot;</span><span class="op">,</span> <span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>propagation <span class="op">=</span> Propagation<span class="op">.</span><span class="fu">REQUIRED</span><span class="op">,</span> isolation <span class="op">=</span> Isolation<span class="op">.</span><span class="fu">READ_COMMITTED</span><span class="op">,</span> timeout <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">insertUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;插入了用户&quot;</span> <span class="op">+</span> user<span class="op">);</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="其他注解">其他注解</h3>
<h4 id="import"><span class="citation" data-cites="Import">@Import</span></h4>
<p><code>@Import</code>:
使用纯注解开发Spring时，用于注入第三方的bean</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Import</span><span class="op">({</span>OtherJavaClass1<span class="op">.</span><span class="fu">class</span><span class="op">,</span>OtherJavaClass2<span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="bean"><span class="citation" data-cites="Bean">@Bean</span></h4>
<p><code>@Bean</code>: 将方法返回值注入容器</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    IUserService <span class="fu">createUserService</span><span class="op">(){</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserServiceImpl</span><span class="op">();</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="configuration"><span class="citation" data-cites="Configuration">@Configuration</span></h4>
<p><code>@Configuration</code>: 配置类用的注解</p>
<h4 id="propertysource"><span class="citation" data-cites="PropertySource">@PropertySource</span></h4>
<p><code>@PropertySource</code>:
导入properties文件，此时可以通过在<code>@Value</code>使用<code>${propertyKey}</code>的方式获取properties文件内容</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="at">@PropertySource</span><span class="op">({</span><span class="st">&quot;classpath:jdbc.properties&quot;</span><span class="op">})</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jdbc,driverClass}&quot;</span><span class="op">)</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> jdbcDriverClassName<span class="op">;</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>或者</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="at">@PropertySource</span><span class="op">({</span><span class="st">&quot;classpath:jdbc.properties&quot;</span><span class="op">})</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SpringConfig <span class="op">{</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当方法需要参数时，如果是复杂类型，spring会在容器里面找匹配的类型（也可以使用@Qualifier指定id），但对于基本数据类型，需要手动注入</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">DataSource</span> <span class="fu">createDataSource</span><span class="op">(</span><span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jdbc,driverClass}&quot;</span><span class="op">)</span> <span class="bu">String</span> driverClassName<span class="op">,</span> <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jdbc.url}&quot;</span><span class="op">)</span> <span class="bu">String</span> url<span class="op">,</span> <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jdbc.username}&quot;</span><span class="op">)</span> <span class="bu">String</span> username<span class="op">,</span> <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${jdbc.password}&quot;</span><span class="op">)</span> <span class="bu">String</span> password<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        DriverManagerDataSource dataSource <span class="op">=</span> <span class="kw">new</span> <span class="fu">DriverManagerDataSource</span><span class="op">();</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        dataSource<span class="op">.</span><span class="fu">setDriverClassName</span><span class="op">(</span>driverClassName<span class="op">);</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        dataSource<span class="op">.</span><span class="fu">setUrl</span><span class="op">(</span>url<span class="op">);</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        dataSource<span class="op">.</span><span class="fu">setUsername</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        dataSource<span class="op">.</span><span class="fu">setPassword</span><span class="op">(</span>password<span class="op">);</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dataSource<span class="op">;</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>@PropertySource</code>也可以在applicationContext.xml中配置</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">context:property-placeholder</span><span class="ot"> location=</span><span class="st">&quot;classpath:jdbc.properties&quot;</span>/&gt;</span></code></pre></div>
<h4 id="conditional"><span class="citation" data-cites="Conditional">@Conditional</span></h4>
<p><code>@Conditional</code>: 指定当什么时候把bean注入到容器</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Conditional</span><span class="op">(</span>MyCondition<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogUtils <span class="op">{</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...   </span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>MyCondition.java</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyCondition <span class="kw">implements</span> <span class="bu">Condition</span> <span class="op">{</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">matches</span><span class="op">(</span>ConditionContext context<span class="op">,</span> AnnotatedTypeMetadata metadata<span class="op">)</span> <span class="op">{</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>context<span class="op">.</span><span class="fu">getEnvironment</span><span class="op">().</span><span class="fu">getActiveProfiles</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">))</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="profile"><span class="citation" data-cites="Profile">@Profile</span></h4>
<p><code>@Profile</code>:
指定当什么时候把bean注入到容器，和<code>@Conditional</code>不同的是，<code>@Profile</code>的条件是通过运行参数指定的</p>
<p>注解方式</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Profile</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogUtils <span class="op">{</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>xml方式：</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> profile=</span><span class="st">&quot;test&quot;</span>&gt;</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;logUtils&quot;</span><span class="ot"> class=</span><span class="st">&quot;Utils.LogUtils&quot;</span>/&gt;</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p>配置：</p>
<p>通过ApplicationContext配置</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>AnnotationConfigApplicationContext ap <span class="op">=</span> <span class="kw">new</span> <span class="fu">AnnotationConfigApplicationContext</span><span class="op">();</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">//在加载配置之前设置</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>ap<span class="op">.</span><span class="fu">getEnvironment</span><span class="op">().</span><span class="fu">setActiveProfiles</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">);</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>ap<span class="op">.</span><span class="fu">register</span><span class="op">(</span>SpringConfig<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span></code></pre></div>
<p>通过servlet参数配置</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">context-param</span>&gt;  </span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">param-name</span>&gt;spring.profiles.default&lt;/<span class="kw">param-name</span>&gt;  </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">param-value</span>&gt;test&lt;/<span class="kw">param-value</span>&gt;  </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">context-param</span>&gt;  </span></code></pre></div>
<p>单元测试时配置</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RunWith</span><span class="op">(</span>SpringJUnit4ClassRunner<span class="op">.</span><span class="fu">class</span><span class="op">)</span>  </span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="at">@ContextConfiguration</span><span class="op">(</span>locations <span class="op">=</span> <span class="st">&quot;applicationContext.xml&quot;</span><span class="op">)</span>  </span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="at">@ActiveProfiles</span><span class="op">(</span><span class="st">&quot;dev&quot;</span><span class="op">)</span>  </span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Test <span class="op">{</span>  </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>通过环境变量配置</p>
<pre><code>set JAVA_OPTS=&quot;-Dspring.profiles.active=test&quot;</code></pre>
<h3 id="processor">Processor</h3>
<p>Processor负责控制所有Bean的生命周期</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span><span class="co">//需要加入容器，Spring会自动识别Processor</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ProcessorTest <span class="kw">implements</span> BeanPostProcessor <span class="op">{</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">postProcessBeforeInitialization</span><span class="op">(</span><span class="bu">Object</span> bean<span class="op">,</span> <span class="bu">String</span> beanName<span class="op">)</span> <span class="kw">throws</span> BeansException <span class="op">{</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>beanName <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> bean<span class="op">);</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> bean<span class="op">;</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">postProcessAfterInitialization</span><span class="op">(</span><span class="bu">Object</span> bean<span class="op">,</span> <span class="bu">String</span> beanName<span class="op">)</span> <span class="kw">throws</span> BeansException <span class="op">{</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>beanName <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> bean<span class="op">);</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> bean<span class="op">;</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果要控制单个Bean的生命周期，可以实现<code>Lifecycle</code>接口</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LifecycleTest <span class="kw">implements</span> Lifecycle <span class="op">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> isRunning<span class="op">;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">start</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;start&quot;</span><span class="op">);</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>        isRunning <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">stop</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;stop&quot;</span><span class="op">);</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>        isRunning <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isRunning</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> isRunning<span class="op">;</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="aware">Aware</h3>
<p><code>Aware</code>通过回调的方式给我们传一些系统的资源，比如</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ResolverTest <span class="kw">implements</span> EmbeddedValueResolverAware <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setEmbeddedValueResolver</span><span class="op">(</span>StringValueResolver resolver<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//El表达式的处理器</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        resolver<span class="op">.</span><span class="fu">resolveStringValue</span><span class="op">(</span><span class="st">&quot;${jdbc.driverClass}&quot;</span><span class="op">);</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="applicationlistener">ApplicationListener</h3>
<p>事件监听器</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ApplicationListenerTest <span class="kw">implements</span> ApplicationListener <span class="op">{</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onApplicationEvent</span><span class="op">(</span>ApplicationEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>event<span class="op">);</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>发送Event</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    ClassPathXmlApplicationContext ap <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    ap<span class="op">.</span><span class="fu">publishEvent</span><span class="op">(</span><span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="st">&quot;123456&quot;</span><span class="op">));</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="spring-mvc">Spring MVC</h2>
<p>和Struts2不同Spring
MVC中Controller是单例的，所以不能定义全局变量，否则会有线程安全问题，如果一定要用全局变量，就要使用<code>ThreadLocal</code></p>
<h3 id="pom.xml">pom.xml</h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">project</span><span class="ot"> xmlns=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><span class="ot"> xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="ot">  xsi:schemaLocation=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">modelVersion</span>&gt;4.0.0&lt;/<span class="kw">modelVersion</span>&gt;</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">groupId</span>&gt;webapp&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">artifactId</span>&gt;springmvc&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">version</span>&gt;1.0-SNAPSHOT&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">packaging</span>&gt;war&lt;/<span class="kw">packaging</span>&gt;</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">properties</span>&gt;</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">project.build.sourceEncoding</span>&gt;UTF-8&lt;/<span class="kw">project.build.sourceEncoding</span>&gt;</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">maven.compiler.source</span>&gt;1.8&lt;/<span class="kw">maven.compiler.source</span>&gt;</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">maven.compiler.target</span>&gt;1.8&lt;/<span class="kw">maven.compiler.target</span>&gt;</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">spring-version</span>&gt;5.1.0.RELEASE&lt;/<span class="kw">spring-version</span>&gt;</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">properties</span>&gt;</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- log --&gt;</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;slf4j-log4j12&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- Spring --&gt;</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.springframework&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;spring-core&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${spring-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- CGLib for @Configuration --&gt;</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;cglib&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;cglib-nodep&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;3.2.9&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">scope</span>&gt;runtime&lt;/<span class="kw">scope</span>&gt;</span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- ORM --&gt;</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.springframework&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;spring-orm&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${spring-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- Spring MVC --&gt;</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.springframework&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;spring-webmvc&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${spring-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- json 解析 --&gt;</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;com.fasterxml.jackson.core&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;jackson-databind&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;2.9.5&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- 文件上传 --&gt;</span></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;commons-fileupload&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;commons-fileupload&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;1.3.3&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- Servlet --&gt;</span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;javax.servlet&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;servlet-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;2.5&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- jsp --&gt;</span></span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;javax.servlet.jsp&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;jsp-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;2.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">scope</span>&gt;provided&lt;/<span class="kw">scope</span>&gt;</span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a>      <span class="co">&lt;!-- junit --&gt;</span></span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.springframework&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;spring-test&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${spring-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">scope</span>&gt;test&lt;/<span class="kw">scope</span>&gt;</span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;junit&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;junit&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;4.11&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">scope</span>&gt;test&lt;/<span class="kw">scope</span>&gt;</span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependencies</span>&gt;</span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">build</span>&gt;</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">finalName</span>&gt;springmvctest&lt;/<span class="kw">finalName</span>&gt;</span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">pluginManagement</span>&gt;<span class="co">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">plugins</span>&gt;</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-clean-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;3.0.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span></span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-resources-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;3.0.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-compiler-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;3.7.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-surefire-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;2.20.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-war-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;3.2.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-install-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;2.5.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">artifactId</span>&gt;maven-deploy-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a>          &lt;<span class="kw">version</span>&gt;2.8.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">plugins</span>&gt;</span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">pluginManagement</span>&gt;</span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">build</span>&gt;</span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">project</span>&gt;</span></code></pre></div>
<p>log4j.properties</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.rootLogger</span><span class="ot">=</span><span class="st">INFO, stdout</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout</span><span class="ot">=</span><span class="st">org.apache.log4j.ConsoleAppender</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout.layout</span><span class="ot">=</span><span class="st">org.apache.log4j.PatternLayout</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout.layout.ConversionPattern</span><span class="ot">=</span><span class="st">%d %p [%c] - %m %n</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co"># General Apache libraries</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.apache</span><span class="ot">=</span><span class="st">WARN</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Spring</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.springframework</span><span class="ot">=</span><span class="st">WARN</span></span></code></pre></div>
<h3 id="web.xml配置">web.xml配置</h3>
<p>web.xml</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">web-app</span><span class="ot"> xmlns=</span><span class="st">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="ot">         xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="ot">         xsi:schemaLocation=</span><span class="st">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="ot">         version=</span><span class="st">&quot;4.0&quot;</span><span class="ot"> metadata-complete=</span><span class="st">&quot;false&quot;</span>&gt;<span class="co">&lt;!-- metadata-complete: 是否使用注解配置servlet --&gt;</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet</span>&gt;</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">display-name</span>&gt;DispatcherServlet&lt;/<span class="kw">display-name</span>&gt;</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;DispatcherServlet&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-class</span>&gt;org.springframework.web.servlet.DispatcherServlet&lt;/<span class="kw">servlet-class</span>&gt;</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 指定spring mvc配置文件路径，默认为servlet名称-servlet.xml（比如这里的就是DispatcherServlet-servlet.xml） --&gt;</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">init-param</span>&gt;</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-name</span>&gt;contextConfigLocation&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">param-value</span>&gt;WEB-INF/springmvc-servlet.xml&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">init-param</span>&gt;</span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">load-on-startup</span>&gt;1&lt;/<span class="kw">load-on-startup</span>&gt;</span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet</span>&gt;</span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- url-pattern: 配置成&#39;/&#39;即除了jsp文件外其他都拦截，&#39;/*&#39;即拦截所有，也可以设置成*.action、*.do等，表示指定后缀的页面不拦截；此时需要在Spring MVC的配置文件中设置静态资源不拦截 --&gt;</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;DispatcherServlet&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">url-pattern</span>&gt;/&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 解决post乱码（get乱码需要修改tomcat配置文件server.xml的Connector，添加属性useBodyEncodingForURI=&quot;true&quot;或URIEncoding=&quot;UTF-8&quot;(如果要使用AJAX异步请求，需使用URIEncoding)）</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a><span class="co">配置编码方式过滤器,注意一点:要配置在所有过滤器的前面（filter-mapping在其他的前面即可）</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a><span class="co">  &lt;filter&gt;</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt;</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;init-param&gt;</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a><span class="co">        针对request</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-name&gt;encoding&lt;/param-name&gt;</span></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-value&gt;utf-8&lt;/param-value&gt;</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/init-param&gt;</span></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;init-param&gt;</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a><span class="co">        针对response</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-name&gt;forceEncoding&lt;/param-name&gt;</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-value&gt;true&lt;/param-value&gt;</span></span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/init-param&gt;</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a><span class="co">  &lt;/filter&gt;</span></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a><span class="co">  &lt;filter-mapping&gt;</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;filter-name&gt;CharacterEncodingFilter&lt;/filter-name&gt;</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a><span class="co">  &lt;/filter-mapping</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">welcome-file-list</span>&gt;</span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">welcome-file</span>&gt;index.jsp&lt;/<span class="kw">welcome-file</span>&gt;</span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">welcome-file-list</span>&gt;</span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 加载Spring</span></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a><span class="co">Spring和Spring MVC的配置文件可以是同一个，也可以分开。如果是分开的话，要注意service和controller的包要分开扫描，因为Spring是父容器，Spring MVC是子容器，子容器可以访问父容器的内容，而父容器不能访问子容器的内容，如果service和controller统一在service层的Spring扫描，会导致controller无法获取三大组件(HandlerMapping、HandlerAdapter、ViewResolver)，页面就会404；用同一个配置文件就相当于只使用Spring MVC的容器，没有使用Spring的容器，也不影响使用</span></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a><span class="co">可以使用通配符，Spring的配置文件可以有多个（比如把DAO层的配置和Service层分开，可以在Service层使用include包含另一applicationContext，也可以在这里指定加载多个配置文件），用的还是同一个Spring容器 --&gt;</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;listener&gt;</span></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;listener-class&gt;</span></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a><span class="co">            org.springframework.web.context.ContextLoaderListener</span></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/listener-class&gt;</span></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/listener&gt;</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;context-param&gt;</span></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;param-value&gt;WEB-INF/applicationContext-*.xml&lt;/param-value&gt;</span></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/context-param&gt;</span></span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- session配置（timeout单位为分钟） --&gt;</span></span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">session-config</span>&gt;</span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">session-timeout</span>&gt;180&lt;/<span class="kw">session-timeout</span>&gt;</span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">session-config</span>&gt;</span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">web-app</span>&gt;</span></code></pre></div>
<h3 id="springmvc-servlet.xml配置">springmvc-servlet.xml配置</h3>
<p>springmvc-servlet.xml</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:mvc=</span><span class="st">&quot;http://www.springframework.org/schema/mvc&quot;</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/mvc</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;controller&quot;</span>/&gt;</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;service.impl&quot;</span>/&gt;</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;dao.repository.impl&quot;</span>/&gt;</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:annotation-driven</span> /&gt;</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- spring 3.1.x 以上可以这样解决中文乱码问题（指定返回页面的字符串流的编码）</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;mvc:annotation-driven&gt;</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;mvc:message-converters register-defaults=&quot;true&quot;&gt;</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;bean class=&quot;org.springframework.http.converter.json.MappingJacksonHttpMessageConverter&quot;/&gt;</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;bean class=&quot;org.springframework.http.converter.StringHttpMessageConverter&quot;&gt;</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;!</span><span class="er">--</span><span class="co"> &lt;property name=&quot;supportedMediaTypes&quot; value=&quot;text/html;charset=UTF-8&quot;/&gt; --&gt;</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;supportedMediaTypes&quot;</span>&gt;</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">list</span>&gt;</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>                    &lt;<span class="kw">value</span>&gt;text/plain;charset=utf-8&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>                    &lt;<span class="kw">value</span>&gt;text/html;charset=utf-8&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>                &lt;/<span class="kw">list</span>&gt;</span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">bean</span>&gt; </span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>    <span class="er">&lt;</span>/mvc:message-converters&gt; </span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;</span>/mvc:annotation-driven&gt;</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a>--&gt;</span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 视图解析器 --&gt;</span></span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 前缀 --&gt;</span></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;prefix&quot;</span><span class="ot"> value=</span><span class="st">&quot;/WEB-INF/jsp/&quot;</span> /&gt;</span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 后缀 --&gt;</span></span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;suffix&quot;</span><span class="ot"> value=</span><span class="st">&quot;.jsp&quot;</span> /&gt;</span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置静态资源不拦截（两种方式） --&gt;</span></span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 方法一：</span></span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a><span class="co">会在Spring MVC上下文中定义一个org.springframework.web.servlet.resource.DefaultServletHttpRequestHandler，对进入DispatcherServlet的URL进行筛查，如果发现是静态资源的请求，就将该请求转由Web应用服务器默认的Servlet处理，如果不是静态资源的请求，才由DispatcherServlet继续处理</span></span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;mvc:default-servlet-handler /&gt;</span></span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  方法二：</span></span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a><span class="co">配置DispatcherServlet不拦截静态资源，和mvc:default-servlet-handler不一样的是，mvc:resources允许静态资源放置在任何地方</span></span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a><span class="co">         location是指webapp目录下的文件夹，也可以使用classpath:指定类路径下的目录</span></span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a><span class="co">         mapping这里是指/css开头的请求都映射到指定的location中</span></span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a><span class="co">         ?匹配一个字符</span></span>
<span id="cb109-55"><a href="#cb109-55" aria-hidden="true" tabindex="-1"></a><span class="co">         *匹配零个或多个字符</span></span>
<span id="cb109-56"><a href="#cb109-56" aria-hidden="true" tabindex="-1"></a><span class="co">         **匹配多重路径</span></span>
<span id="cb109-57"><a href="#cb109-57" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb109-58"><a href="#cb109-58" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:resources</span><span class="ot"> location=</span><span class="st">&quot;/css/&quot;</span><span class="ot"> mapping=</span><span class="st">&quot;/css/**&quot;</span>/&gt;</span>
<span id="cb109-59"><a href="#cb109-59" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:resources</span><span class="ot"> location=</span><span class="st">&quot;/js/&quot;</span><span class="ot"> mapping=</span><span class="st">&quot;/js/**&quot;</span>/&gt;</span>
<span id="cb109-60"><a href="#cb109-60" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 可以指定多个location</span></span>
<span id="cb109-61"><a href="#cb109-61" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;mvc:resources location=&quot;/,classpath:/META-INF/publicResources/&quot; mapping=&quot;/resources/**&quot;/&gt;</span></span>
<span id="cb109-62"><a href="#cb109-62" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb109-63"><a href="#cb109-63" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;</span>/beans&gt;</span></code></pre></div>
<h3 id="request">request</h3>
<h4 id="基本数据类型">基本数据类型</h4>
<p>直接写即可（参数自动匹配）</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;findbyid&quot;</span><span class="op">)</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果url中参数名字和controller的参数名字不一样，可以使用<code>@RequestParam</code>，默认url中的参数要和controller中参数完全对应，这里也可以通过<code>required=false</code>指定该参数可以省略</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;findbyid&quot;</span><span class="op">,</span> produces <span class="op">=</span> <span class="st">&quot;text/html;charset=UTF-8&quot;</span><span class="op">)</span><span class="co">//可以指定返回字符串流的编码，比如返回json时可以指定为application/json;charset=utf-8</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="co">//findbyid?userid=1</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co">//RequestParam指定url中userid对应这里的id</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="at">@RequestParam</span><span class="op">(</span><span class="st">&quot;userid&quot;</span><span class="op">,</span> required <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>也可以获取header中的参数</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/headerInfo&quot;</span><span class="op">)</span>  </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">headerInfo</span><span class="op">(</span><span class="at">@RequestHeader</span><span class="op">(</span><span class="st">&quot;Accept-Encoding&quot;</span><span class="op">)</span> <span class="bu">String</span> encoding<span class="op">,</span> <span class="at">@RequestHeader</span><span class="op">(</span><span class="st">&quot;Keep-Alive&quot;</span><span class="op">)</span> <span class="dt">long</span> keepAlive<span class="op">)</span>  <span class="op">{</span>  </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>encoding<span class="op">);</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>keepAlive<span class="op">);</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> </span></code></pre></div>
<h4 id="arraylistmap">array、List、Map</h4>
<p>数组可以直接写（参数自动匹配）</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;findbyids&quot;</span><span class="op">)</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserByIds</span><span class="op">(</span><span class="dt">int</span> ids<span class="op">[])</span> <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> id <span class="op">:</span> ids<span class="op">)</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>list要求VO中有list成员变量</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">//list: findbyids?ids[0]=1&amp;ids[1]=2&amp;ids[2]=3</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co">//map: findbyids?map[key1]=value&amp;map[key2]=value2</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value<span class="op">=</span><span class="st">&quot;findbyids&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserByIds</span><span class="op">(</span>UserVo userVo<span class="op">)</span> <span class="op">{</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> id <span class="op">:</span> userVo<span class="op">.</span><span class="fu">getIds</span><span class="op">())</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>UserVo.java</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserVo <span class="op">{</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> pwd<span class="op">;</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> ids<span class="op">;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">UserVo</span><span class="op">()</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">UserVo</span><span class="op">(</span><span class="bu">Integer</span> id<span class="op">,</span> <span class="bu">String</span> name<span class="op">,</span> <span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">id</span> <span class="op">=</span> id<span class="op">;</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">pwd</span> <span class="op">=</span> pwd<span class="op">;</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">getId</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> id<span class="op">;</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setId</span><span class="op">(</span><span class="bu">Integer</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">id</span> <span class="op">=</span> id<span class="op">;</span></span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name<span class="op">;</span></span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setName</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getPwd</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pwd<span class="op">;</span></span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setPwd</span><span class="op">(</span><span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">pwd</span> <span class="op">=</span> pwd<span class="op">;</span></span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> <span class="fu">getIds</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ids<span class="op">;</span></span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setIds</span><span class="op">(</span><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> ids<span class="op">)</span> <span class="op">{</span></span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">ids</span> <span class="op">=</span> ids<span class="op">;</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="vo">VO</h4>
<p>对于url中参数，如果每个标签的name对应了VO类的每个属性时可以自动装箱</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co">//adduser?id=1&amp;username=xiaoming&amp;pwd=123456</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;adduser&quot;</span><span class="op">)</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">addUser</span><span class="op">(</span>UserVo userVo<span class="op">){</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userVo<span class="op">);</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时相当于（当VO中有无参数的构造函数或者是setter方法时，<code>@ModelAttribute</code>可以省略不写）</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;adduser&quot;</span><span class="op">)</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">addUser</span><span class="op">(</span><span class="at">@ModelAttribute</span> UserVo userVo<span class="op">){</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userVo<span class="op">);</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>jsp页面</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>&lt;form<span class="ot"> action</span> =<span class="dt">&quot;</span><span class="pp">&lt;%=</span>request<span class="op">.</span><span class="fu">getContextPath</span><span class="op">()</span><span class="pp">%&gt;</span><span class="dt">/demo/addUser5&quot;</span><span class="ot"> method</span>=<span class="dt">&quot;post&quot;</span>&gt;</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>     用户名:&lt;input<span class="ot"> type</span>=<span class="dt">&quot;text&quot;</span><span class="ot"> name</span>=<span class="dt">&quot;username&quot;</span>/&gt;&lt;br/&gt;</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>     密码:&lt;input<span class="ot"> type</span>=<span class="dt">&quot;password&quot;</span><span class="ot"> name</span>=<span class="dt">&quot;password&quot;</span>/&gt;&lt;br/&gt;</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>     &lt;input<span class="ot"> type</span>=<span class="dt">&quot;submit&quot;</span><span class="ot"> value</span>=<span class="dt">&quot;提交&quot;</span>/&gt;</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>&lt;/form&gt;</span></code></pre></div>
<h4 id="json">Json</h4>
<p>把json转成VO参数以及把VO转成json返回需要导包</p>
<ul>
<li>jackson-annotations.jar</li>
<li>jackson-core.jar</li>
<li>jackson-databind.jar</li>
</ul>
<p><code>&lt;mvc:annotation-driven /&gt;</code>以及帮我们配置好，所以不需要配置json解析器，只需导包即可</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">//此时前端传过来的是json串，会被解析成VO，返回时会把VO转成json返回</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value<span class="op">=</span><span class="st">&quot;checkuser&quot;</span><span class="op">,</span>method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">,</span> produces <span class="op">=</span><span class="st">&quot;application/json;charset=utf-8&quot;</span><span class="op">)</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="at">@ResponseBody</span> UserVo <span class="fu">checkUser</span><span class="op">(</span><span class="at">@RequestBody</span> UserVo userVo<span class="op">){</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> userVo<span class="op">;</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用自定义的返回值转换器时</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--配置返回值转换器--&gt;</span>  </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;contentNegotiationManagerFactoryBean&quot;</span>  </span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="ot">      class=</span><span class="st">&quot;org.springframework.web.accept.ContentNegotiationManagerFactoryBean&quot;</span>&gt;  </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;favorPathExtension&quot;</span><span class="ot"> value=</span><span class="st">&quot;false&quot;</span>/&gt;  </span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;favorParameter&quot;</span><span class="ot"> value=</span><span class="st">&quot;false&quot;</span>/&gt;  </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;ignoreAcceptHeader&quot;</span><span class="ot"> value=</span><span class="st">&quot;false&quot;</span>/&gt;  </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mediaTypes&quot;</span>&gt;  </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">map</span>&gt;  </span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">entry</span><span class="ot"> key=</span><span class="st">&quot;json&quot;</span><span class="ot"> value=</span><span class="st">&quot;application/json&quot;</span>/&gt;  </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">map</span>&gt;  </span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt;  </span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a> &lt;<span class="kw">mvc:annotation-driven</span><span class="ot"> content-negotiation-manager=</span><span class="st">&quot;contentNegotiationManagerFactoryBean&quot;</span>/&gt;  </span></code></pre></div>
<h4 id="mutipartfile">MutipartFile</h4>
<p>文件上传需要导包</p>
<ul>
<li>commons-io.jar</li>
<li>commons-fileupload.jar</li>
</ul>
<p>在springmvc-servlet.xml中配置文件解析器</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 这里multipartResolver的名字是固定的，不能改 --&gt;</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;multipartResolver&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 这里的编码要和jsp页面编码保持一致 --&gt;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultEncoding&quot;</span><span class="ot"> value=</span><span class="st">&quot;UTF-8&quot;</span>/&gt;</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxUploadSize&quot;</span><span class="ot"> value=</span><span class="st">&quot;5400000&quot;</span>/&gt;</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxInMemorySize&quot;</span><span class="ot"> value=</span><span class="st">&quot;4096&quot;</span> /&gt;</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;resolveLazily&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span> /&gt;</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;uploadTempDir&quot;</span><span class="ot"> value=</span><span class="st">&quot;/WEB-INF/upload&quot;</span>/&gt;</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span></code></pre></div>
<p>使用MultipartFile（多文件上传只需改成<code>@RequestParam MultipartFile[] multipartFile</code>即可）</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;upload&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">upload</span><span class="op">(</span>MultipartFile multipartFile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>multipartFile<span class="op">.</span><span class="fu">isEmpty</span><span class="op">()</span> <span class="op">&amp;&amp;</span> multipartFile<span class="op">.</span><span class="fu">getSize</span><span class="op">()&gt;</span><span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> fileName <span class="op">=</span> <span class="bu">UUID</span><span class="op">.</span><span class="fu">randomUUID</span><span class="op">()</span> <span class="op">+</span> <span class="bu">String</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span><span class="bu">Calendar</span><span class="op">.</span><span class="fu">getInstance</span><span class="op">().</span><span class="fu">getTimeInMillis</span><span class="op">());</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>        fileName <span class="op">+=</span> multipartFile<span class="op">.</span><span class="fu">getOriginalFilename</span><span class="op">();</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>            multipartFile<span class="op">.</span><span class="fu">transferTo</span><span class="op">(</span><span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>fileName<span class="op">));</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>或者使用原生Servlet API</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/upload&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">upload</span><span class="op">(</span>HttpServletRequest req<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span><span class="op">{</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    MultipartHttpServletRequest mreq <span class="op">=</span> <span class="op">(</span>MultipartHttpServletRequest<span class="op">)</span>req<span class="op">;</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    MultipartFile file <span class="op">=</span> mreq<span class="op">.</span><span class="fu">getFile</span><span class="op">(</span><span class="st">&quot;file&quot;</span><span class="op">);</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> fileName <span class="op">=</span> file<span class="op">.</span><span class="fu">getOriginalFilename</span><span class="op">();</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">SimpleDateFormat</span> sdf <span class="op">=</span> <span class="kw">new</span> <span class="bu">SimpleDateFormat</span><span class="op">(</span><span class="st">&quot;yyyyMMddHHmmss&quot;</span><span class="op">);</span>        </span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">FileOutputStream</span> fos <span class="op">=</span> <span class="kw">new</span> <span class="bu">FileOutputStream</span><span class="op">(</span>req<span class="op">.</span><span class="fu">getSession</span><span class="op">().</span><span class="fu">getServletContext</span><span class="op">().</span><span class="fu">getRealPath</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">)+</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&quot;upload/&quot;</span><span class="op">+</span>sdf<span class="op">.</span><span class="fu">format</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">())</span> <span class="op">+</span> fileName<span class="op">.</span><span class="fu">substring</span><span class="op">(</span>fileName<span class="op">.</span><span class="fu">lastIndexOf</span><span class="op">(</span><span class="ch">&#39;.&#39;</span><span class="op">)));</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    fos<span class="op">.</span><span class="fu">write</span><span class="op">(</span>file<span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    fos<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    fos<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>文件下载</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value<span class="op">=</span><span class="st">&quot;/download&quot;</span><span class="op">)</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ResponseEntity<span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]&gt;</span> <span class="fu">download</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> <span class="at">@RequestParam</span><span class="op">(</span><span class="st">&quot;filename&quot;</span><span class="op">)</span> <span class="bu">String</span> filename<span class="op">,</span> Model model<span class="op">)</span><span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//下载文件路径</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> path <span class="op">=</span> request<span class="op">.</span><span class="fu">getServletContext</span><span class="op">().</span><span class="fu">getRealPath</span><span class="op">(</span><span class="st">&quot;/images/&quot;</span><span class="op">);</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>path <span class="op">+</span> <span class="bu">File</span><span class="op">.</span><span class="fu">separator</span> <span class="op">+</span> filename<span class="op">);</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    HttpHeaders headers <span class="op">=</span> <span class="kw">new</span> <span class="fu">HttpHeaders</span><span class="op">();</span>  </span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//下载显示的文件名，解决中文名称乱码问题  </span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> downloadFielName <span class="op">=</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>filename<span class="op">.</span><span class="fu">getBytes</span><span class="op">(</span><span class="st">&quot;UTF-8&quot;</span><span class="op">),</span><span class="st">&quot;iso-8859-1&quot;</span><span class="op">);</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//通知浏览器以attachment（下载方式）打开图片</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">.</span><span class="fu">setContentDispositionFormData</span><span class="op">(</span><span class="st">&quot;attachment&quot;</span><span class="op">,</span> downloadFielName<span class="op">);</span> </span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//application/octet-stream ： 二进制流数据（最常见的文件下载）。</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_OCTET_STREAM</span><span class="op">);</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> ResponseEntity<span class="op">&lt;</span><span class="dt">byte</span><span class="op">[]&gt;(</span>FileUtils<span class="op">.</span><span class="fu">readFileToByteArray</span><span class="op">(</span>file<span class="op">),</span> headers<span class="op">,</span> HttpStatus<span class="op">.</span><span class="fu">CREATED</span><span class="op">);</span>  </span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="其他类型convertor">其他类型（Convertor）</h4>
<p>除了以上自动类型转换，我们还可以自定义类型转换器</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserConverter <span class="kw">implements</span> Converter<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> UserVo<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//将user-xxx-xxx-xxx转换成UserVo</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> UserVo <span class="fu">convert</span><span class="op">(</span><span class="bu">String</span> source<span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>source <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> source<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span><span class="op">[]</span> values <span class="op">=</span> source<span class="op">.</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot;-&quot;</span><span class="op">);</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>values <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> values<span class="op">.</span><span class="fu">length</span> <span class="op">==</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>                UserVo userVo <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserVo</span><span class="op">();</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>                userVo<span class="op">.</span><span class="fu">setId</span><span class="op">(</span><span class="bu">Integer</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>values<span class="op">[</span><span class="dv">1</span><span class="op">]));</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>                userVo<span class="op">.</span><span class="fu">setName</span><span class="op">(</span>values<span class="op">[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>                userVo<span class="op">.</span><span class="fu">setPwd</span><span class="op">(</span>values<span class="op">[</span><span class="dv">3</span><span class="op">]);</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> userVo<span class="op">;</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在springmvc-servlet.xml中配置</p>
<pre class="xaml"><code>&lt;!--配置自定义的解析器，这里的id是固定的，不能改  --&gt;
&lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;&gt;
    &lt;property name=&quot;converters&quot;&gt;
        &lt;set&gt;
            &lt;ref bean=&quot;userConverter&quot;/&gt;
        &lt;/set&gt;
    &lt;/property&gt;
&lt;/bean&gt;

&lt;!-- 注册解析器 --&gt;
&lt;mvc:annotation-driven conversion-service=&quot;conversionService&quot;/&gt;</code></pre>
<h4 id="initbinder"><span class="citation" data-cites="InitBinder">@InitBinder</span></h4>
<p><code>@InitBinder</code>属性编辑器，可以指定允许/不允许哪些字段作为url参数，或者像Convertor那样对参数进行预处理，它的作用范围是当前Controller</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserController<span class="op">{</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@InitBinder方法不能有返回值,它必须声明为void</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@InitBinder方法的参数通常是是 WebDataBinder</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@InitBinder</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">initUserData</span><span class="op">(</span>WebDataBinder binder<span class="op">){</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//不允许出现name字段的参数，如果出现了，会把该字段置为空</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>        binder<span class="op">.</span><span class="fu">setDisallowedFields</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">//StringTrimmerEditor是Spring MVC内置的PropertyEditor（如果要自定义，继承PropertyEditorSupport），这里配合@InitBinder使用，把参数中所有的String都先执行trim再传入Controller中对应的方法</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>        binder<span class="op">.</span><span class="fu">registerCustomEditor</span><span class="op">(</span><span class="bu">String</span><span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">StringTrimmerEditor</span><span class="op">(</span><span class="kw">true</span><span class="op">));</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//CustomDateEditor也是Spring MVC提供的，把日期先格式化再传入Controller中对应的方法</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>        binder<span class="op">.</span><span class="fu">registerCustomEditor</span><span class="op">(</span><span class="bu">Date</span><span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">CustomDateEditor</span><span class="op">(</span><span class="kw">new</span> <span class="bu">SimpleDateFormat</span><span class="op">(</span><span class="st">&quot;yyyy-MM-dd&quot;</span><span class="op">),</span> <span class="kw">false</span><span class="op">));</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果form中要传入两个不同POJO中的字段，这时如果直接使用两个POJO作为参数是接收不到的（无法自动装箱），这时需要使用<code>@InitBinder</code></p>
<div class="sourceCode" id="cb128"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">//绑定变量名字和属性，参数封装进类  </span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="at">@InitBinder</span><span class="op">(</span><span class="st">&quot;User&quot;</span><span class="op">)</span>  </span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">initBinderUser</span><span class="op">(</span>WebDataBinder binder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    binder<span class="op">.</span><span class="fu">setFieldDefaultPrefix</span><span class="op">(</span><span class="st">&quot;user.&quot;</span><span class="op">);</span>  </span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  </span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co">//绑定变量名字和属性，参数封装进类  </span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="at">@InitBinder</span><span class="op">(</span><span class="st">&quot;Student&quot;</span><span class="op">)</span>  </span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">initBinderAddr</span><span class="op">(</span>WebDataBinder binder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    binder<span class="op">.</span><span class="fu">setFieldDefaultPrefix</span><span class="op">(</span><span class="st">&quot;student.&quot;</span><span class="op">);</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="co">//对应的Controller方法</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;updateUserAndStudent&quot;</span><span class="op">)</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">updateUserAndStudent</span><span class="op">(</span>User user<span class="op">,</span> Student student<span class="op">){</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>user <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> student<span class="op">);</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span>  </span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="controlleradvice"><span class="citation" data-cites="ControllerAdvice">@ControllerAdvice</span></h4>
<p><code>@InitBinder</code>作用范围是当前Controller，如果想让它作用于全部Controller（使用了<code>@RequestMapping</code>的控制器内的方法），可以在Controller（或者其他任意类）上加<code>@ControllerAdvice</code></p>
<div class="sourceCode" id="cb129"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="at">@ControllerAdvice</span><span class="co">//通常会把对于控制器的全局配置放置在同一个位置</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> GlobalControllerAdvice <span class="op">{</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@InitBinder</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">initData</span><span class="op">(</span>WebDataBinder binder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//...</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果不使用注解，使用<code>RequestMappingHandlerAdapter</code>也可以达到相同的效果</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Bean</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> RequestMappingHandlerAdapter <span class="fu">webBindingInitializer</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    RequestMappingHandlerAdapter adapter <span class="op">=</span> <span class="kw">new</span> <span class="fu">RequestMappingHandlerAdapter</span><span class="op">();</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    adapter<span class="op">.</span><span class="fu">setWebBindingInitializer</span><span class="op">(</span><span class="kw">new</span> <span class="fu">WebBindingInitializer</span><span class="op">(){</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">initBinder</span><span class="op">(</span>WebDataBinder binder<span class="op">,</span> WebRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>            binder<span class="op">.</span><span class="fu">registerCustomEditor</span><span class="op">(</span><span class="bu">Date</span><span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">CustomDateEditor</span><span class="op">(</span><span class="kw">new</span> <span class="bu">SimpleDateFormat</span><span class="op">(</span><span class="st">&quot;yyyy-MM-dd&quot;</span><span class="op">),</span> <span class="kw">false</span><span class="op">));</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> adapter<span class="op">;</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>除了扩展<code>@InitBinder</code>的作用范围，<code>@ControllerAdvice</code>也可以扩展<code>@ExceptionHandler</code>和<code>@ModelAttribute</code>的范围</p>
<h4 id="rest风格url">REST风格URL</h4>
<div class="sourceCode" id="cb131"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">//GET: 获取</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="co">//可以使用正则，比如这里id只允许数字类型</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/user/{id:</span><span class="sc">\\</span><span class="st">d+}/{name}/{pwd}&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">GET</span><span class="op">)</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">addUser</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="dt">int</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> name<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//userService.addUser(new User(id, name, pwd));</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="co">//POST: 创建</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/user/{id}/{name}/{pwd}&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">insertUser</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="dt">int</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> name<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//userService.insertUser(new User(id, name, pwd));</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a><span class="co">//PUT: 更新</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/user/{id}/{name}/{pwd}&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">PUT</span><span class="op">)</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">updateUser</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="dt">int</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> name<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//userService.updateUser(new User(id, name, pwd));</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a><span class="co">//DELETE: 删除</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/user/{id}&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">DELETE</span><span class="op">)</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">deleteUser</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="dt">int</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> name<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">String</span> pwd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">//userService.deleteUserById(id);</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>浏览器form表单只支持GET与POST请求（如果使用AJAX，可以不用配置），而DELETE、PUT等method并不支持，spring3添加了一个过滤器，可以将这些请求转换为标准的http方法，使得支持GET、POST、PUT与DELETE请求</p>
<p>在web.xml中开启PUT和DELETE请求支持（要在DispatcherServlet之前设置才能生效）：</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- configure the HiddenHttpMethodFilter,convert the post method to put or delete --&gt;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter</span>&gt;</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;HiddenHttpMethodFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-class</span>&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/<span class="kw">filter-class</span>&gt;</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter</span>&gt;</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter-mapping</span>&gt;</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;HiddenHttpMethodFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter-mapping</span>&gt;</span></code></pre></div>
<p>此时对应的form表单（该Filter只对method为post的表单进行过滤，所以要使用POST）</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;...&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;post&quot;</span><span class="dt">&gt;</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;_method&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;put&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>        ......</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span></code></pre></div>
<h4 id="校验validated">校验（<span class="citation" data-cites="Validated">@Validated</span>）</h4>
<p>Spring MVC本身没有数据校验的功能，数据校验需要以下第三方jar包</p>
<ul>
<li>hibernate-validator.jar</li>
<li>jboss-logging.jar</li>
<li>validation-api.jar</li>
</ul>
<p>在spring配置文件中配置校验器</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置校验器 --&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;validator&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.validation.beanvalidation.LocalValidatorFactoryBean&quot;</span>&gt;</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 校验器，使用hibernate校验器 --&gt;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;providerClass&quot;</span><span class="ot"> value=</span><span class="st">&quot;org.hibernate.validator.HibernateValidator&quot;</span>/&gt;</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 指定校验使用的资源文件，在文件中配置校验错误信息，用于国际化，如果不指定则默认使用classpath下面的ValidationMessages.properties文件 --&gt;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;validationMessageSource&quot;</span><span class="ot"> ref=</span><span class="st">&quot;messageSource&quot;</span>/&gt;</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 校验错误信息配置文件 --&gt;</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;messageSource&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.context.support.ReloadableResourceBundleMessageSource&quot;</span>&gt;</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 资源文件名 --&gt;</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;basenames&quot;</span>&gt;</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">list</span>&gt;</span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">value</span>&gt;classpath:CustomValidationMessage&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">list</span>&gt;</span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 资源文件编码格式 --&gt;</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;fileEncodings&quot;</span><span class="ot"> value=</span><span class="st">&quot;utf-8&quot;</span>/&gt;</span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 对资源文件内容缓存时间，单位秒 --&gt;</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;cacheSeconds&quot;</span><span class="ot"> value=</span><span class="st">&quot;120&quot;</span>/&gt;</span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mvc:annotation-driven</span><span class="ot"> conversion-service=</span><span class="st">&quot;conversionService&quot;</span><span class="ot"> validator=</span><span class="st">&quot;validator&quot;</span> /&gt;</span></code></pre></div>
<p>CustomValidationMessage.properties</p>
<pre class="properties"><code>user.name.notnull=名字不能为空
user.pwd.size=密码长度应为6-20位</code></pre>
<p>在VO中定义规则，同时支持给规则分组（可以使用JSR303中定义的所有验证规则）</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserVo <span class="op">{</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//这里的message可以通过读取properties文件的方式获取，也可以直接写</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;{user.name.notnull}&quot;</span><span class="op">,</span>groups<span class="op">=</span> <span class="op">{</span>ValidateGroup1<span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Size</span><span class="op">(</span>min <span class="op">=</span> <span class="dv">6</span><span class="op">,</span> max <span class="op">=</span> <span class="dv">20</span><span class="op">,</span> message <span class="op">=</span> <span class="st">&quot;{user.pwd.size}&quot;</span><span class="op">,</span> groups<span class="op">=</span> <span class="op">{</span>ValidateGroup1<span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> pwd<span class="op">;</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//以下省略get、set方法</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>常用的规则有</p>
<pre><code>JSR提供的校验注解：         
@Null   被注释的元素必须为 null    
@NotNull    被注释的元素必须不为 null    
@AssertTrue     被注释的元素必须为 true    
@AssertFalse    被注释的元素必须为 false    
@Min(value)     被注释的元素必须是一个数字，其值必须大于等于指定的最小值    
@Max(value)     被注释的元素必须是一个数字，其值必须小于等于指定的最大值    
@DecimalMin(value)  被注释的元素必须是一个数字，其值必须大于等于指定的最小值    
@DecimalMax(value)  被注释的元素必须是一个数字，其值必须小于等于指定的最大值    
@Size(max=, min=)   被注释的元素的大小必须在指定的范围内    
@Digits (integer, fraction)     被注释的元素必须是一个数字，其值必须在可接受的范围内    
@Past   被注释的元素必须是一个过去的日期    
@Future     被注释的元素必须是一个将来的日期    
@Pattern(regex=,flag=)  被注释的元素必须符合指定的正则表达式    


Hibernate Validator提供的校验注解：  
@NotBlank(message =)   验证字符串非null，且长度必须大于0    
@Email  被注释的元素必须是电子邮箱地址    
@Length(min=,max=)  被注释的字符串的大小必须在指定的范围内    
@NotEmpty   被注释的字符串的必须非空    
@Range(min=,max=,message=)  被注释的元素必须在合适的范围内</code></pre>
<p>在Controller中通过<code>@Validated</code>注解使用规则，且<code>@Validated</code>的参数后面加一个bindingResult，用于获取验证的错误信息（<code>@Validated</code>和bindingResult是成对出现的）</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/adduser&quot;</span><span class="op">)</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">addUser</span><span class="op">(</span><span class="at">@Validated</span><span class="op">(</span>ValidateGroup1<span class="op">.</span><span class="fu">class</span><span class="op">)</span> UserVo userVo<span class="op">,</span> BindingResult bindingResult<span class="op">,</span>Model model<span class="op">)</span> <span class="op">{</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userVo<span class="op">);</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>bindingResult<span class="op">.</span><span class="fu">hasErrors</span><span class="op">()){</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>ObjectError error <span class="op">:</span> bindingResult<span class="op">.</span><span class="fu">getAllErrors</span><span class="op">()){</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>error<span class="op">.</span><span class="fu">getDefaultMessage</span><span class="op">());</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>        model<span class="op">.</span><span class="fu">addAttribute</span><span class="op">(</span><span class="st">&quot;errors&quot;</span><span class="op">,</span> bindingResult<span class="op">.</span><span class="fu">getAllErrors</span><span class="op">());</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;error&quot;</span><span class="op">;</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>ValidateGroup1是一个空的接口/类，只是用于标识不同分组</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> ValidateGroup1 <span class="op">{</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="response">response</h3>
<h4 id="redirect和forward">redirect和forward</h4>
<p>Spring
mvc返回的字符串默认是forward，也可以指定为forward或redirect</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="at">@RequestParam</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//return &quot;forward:success&quot;;</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;redirect:success&quot;</span><span class="op">;</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="数据回显">数据回显</h4>
<h5 id="void">void</h5>
<p>如果返回void则转发到方法名.jsp</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">//转发到findUserById.jsp</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="vo-1">VO</h5>
<div class="sourceCode" id="cb142"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co">//jsp中使用${id}、${name}、${pwd}获取</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> UserVo <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="fu">UserVo</span><span class="op">(</span>id<span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">,</span> <span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="map">Map</h5>
<p>使用Map参数</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">//jsp中使用${requestScope.names }可获取我们设置的names</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span><span class="bu">Object</span><span class="op">&gt;</span> map<span class="op">)</span> <span class="op">{</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;names&quot;</span><span class="op">,</span> <span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span><span class="st">&quot;aaa&quot;</span><span class="op">,</span><span class="st">&quot;bbb&quot;</span><span class="op">,</span><span class="st">&quot;ccc&quot;</span><span class="op">));</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="model">Model</h5>
<p>使用Model参数（每个请求都有一个隐含的Model参数）</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">,</span>Model model<span class="op">)</span> <span class="op">{</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    UserVo userVo <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserVo</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">.</span><span class="fu">addAttribute</span><span class="op">(</span>userVo<span class="op">);</span><span class="co">//jsp中直接使用&quot;${id}&quot;即可获取vo中的属性</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">.</span><span class="fu">addAttribute</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">,</span>userVo<span class="op">);</span><span class="co">//jsp中使用&quot;${user.id}&quot;获取vo中的属性</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="modelmap">ModelMap</h5>
<p>使用ModelMap（也是隐含参数）</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span>ModelMap modelMap<span class="op">)</span> <span class="op">{</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    modelMap<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;1&quot;</span><span class="op">);</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>    modelMap<span class="op">.</span><span class="fu">addAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;aaa&quot;</span><span class="op">);</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="modelandview">ModelAndView</h5>
<p>使用ModelAndView（需要我们new）</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> ModelAndView <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    UserVo userVo <span class="op">=</span> <span class="kw">new</span> <span class="fu">UserVo</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="st">&quot;123456&quot;</span><span class="op">);</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    ModelAndView modelAndView <span class="op">=</span> <span class="kw">new</span> <span class="fu">ModelAndView</span><span class="op">();</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    modelAndView<span class="op">.</span><span class="fu">setViewName</span><span class="op">(</span><span class="st">&quot;forward:success&quot;</span><span class="op">);</span><span class="co">//success.jsp</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    modelAndView<span class="op">.</span><span class="fu">addObject</span><span class="op">(</span>userVo<span class="op">);</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelAndView<span class="op">;</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="servlet-api">servlet API</h5>
<p>也可以使用原生的servlet API（也是隐含参数）</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">,</span> HttpSession session<span class="op">)</span> <span class="op">{</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">));</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//request.getRequestDispatcher(&quot;index.html&quot;).forward(request, response);</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//response.sendRedirect(&quot;http://www.baidu.com&quot;);</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="printwriter">PrintWriter</h5>
<p>使用PrintWriter时，Spring
MVC的跳转不会生效，使用一般用于在JS中使用AJAX异步请求返回JSON数据给页面</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/TestJSONObject&quot;</span><span class="op">)</span>  </span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span>  <span class="fu">testReturrnJSONWithoutBean</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span><span class="op">{</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>    response<span class="op">.</span><span class="fu">setContentType</span><span class="op">(</span><span class="st">&quot;application/json&quot;</span><span class="op">);</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    response<span class="op">.</span><span class="fu">setCharacterEncoding</span><span class="op">(</span><span class="st">&quot;UTF-8&quot;</span><span class="op">);</span><span class="co">//防止出现乱码</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">PrintWriter</span> writer <span class="op">=</span> response<span class="op">.</span><span class="fu">getWriter</span><span class="op">();</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    JsonObject jsonObject <span class="op">=</span> <span class="kw">new</span> <span class="fu">JsonObject</span><span class="op">();</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>    jsonObject<span class="op">.</span><span class="fu">addProperty</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>    writer<span class="op">.</span><span class="fu">println</span><span class="op">(</span>jsonObject<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>    writer<span class="op">.</span><span class="fu">flush</span><span class="op">();</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>    writer<span class="op">.</span><span class="fu">close</span><span class="op">();</span><span class="co">//用完关不关都可以，最好还是close</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>PrintWriter也可以直接作为参数</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">queryScoreForStudent</span><span class="op">(</span><span class="bu">PrintWriter</span> printWriter<span class="op">,</span> HttpSession sesion<span class="op">){</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="modelattribute"><span class="citation" data-cites="ModelAttribute">@ModelAttribute</span></h5>
<p><code>@ModelAttribute</code>的作用范围是当前的Controller，也可以使用<code>@InitBinder</code>来让它作用于全部使用了<code>@RequestMapping</code>的Controller内的方法</p>
<ul>
<li>在方法名上：此时访问<code>findbyid?id=1&amp;abc=aaa</code>时，会先执行<code>populateModel</code>，并把<code>populateModel</code>中回显的数据带到<code>findUserById</code>。除了Model外，也可以是其他数据回显的形式，比如ModelAndView等，如果是其他类型，key是返回值变量名首字母小写，value就是返回值本身（也可以通过<code>@ModelAttribute(vaule=&quot;keyName&quot;)</code>来指定返回值的key或从哪个key中找）</li>
</ul>
<div class="sourceCode" id="cb150"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="at">@ModelAttribute</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">populateModel</span><span class="op">(</span><span class="at">@RequestParam</span><span class="op">(</span>required<span class="op">=</span><span class="kw">false</span><span class="op">)</span> <span class="bu">String</span> abc<span class="op">,</span> Model model<span class="op">)</span> <span class="op">{</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">.</span><span class="fu">addAttribute</span><span class="op">(</span><span class="st">&quot;attributeName&quot;</span><span class="op">,</span> abc<span class="op">);</span> </span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="co">//先执行所有带@ModelAttribute注解的方法，再执行@RequestMapping的方法</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a><span class="co">//以上两个方法相当于</span></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a><span class="co">@RequestMapping(value = &quot;/findbyid&quot;)</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a><span class="co">public String findUserById(int id, @RequestParam(required=false) String abc, Model model) {</span></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a><span class="co">    model.addAttribute(&quot;attributeName&quot;, abc);</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a><span class="co">    return &quot;success&quot;;</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a><span class="co">@ModelAttribute(&quot;m_abc&quot;)</span></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a><span class="co">public String populateModel(@RequestParam(required=false) String abc, Model model) {</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a><span class="co">   return abc; </span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a><span class="co">@RequestMapping(value = &quot;/findbyid&quot;)</span></span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a><span class="co">public String findUserById(int id, @ModelAttribute(&quot;m_abc&quot;) String abc) {</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a><span class="co">    return &quot;success&quot;;</span></span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<ul>
<li>写在参数上：此时会把id放到隐含的Model中返回</li>
</ul>
<div class="sourceCode" id="cb151"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co">//相当于return new Model.addAttribute(&quot;id&quot;, id)并返回到success页面</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="at">@ModelAttribute</span> <span class="dt">int</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="sessioncookie">Session、Cookie</h3>
<p>使用<code>@SessionAttribute</code>指定从session、cookie中取值</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;findbyid&quot;</span><span class="op">)</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span><span class="at">@SessionAttribute</span> <span class="dt">int</span> id<span class="op">,</span> <span class="at">@CookieValue</span><span class="op">(</span>value<span class="op">=</span><span class="st">&quot;name&quot;</span><span class="op">,</span> required<span class="op">=</span><span class="kw">false</span><span class="op">)</span> <span class="bu">String</span> username<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>id <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> username<span class="op">);</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当类中所有方法都需要同一个session时，可以把<code>@SessionAttribute</code>放在Controller上</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="co">//@SessionAttributes(names=&quot;id&quot;)</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="at">@SessionAttributes</span><span class="op">(</span>value<span class="op">={</span><span class="st">&quot;id&quot;</span><span class="op">},</span> types<span class="op">={</span><span class="bu">Integer</span><span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserController<span class="op">{</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;findbyid&quot;</span><span class="op">)</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span>Model model<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//因为前面已经声明过id是session中的值，所以这里是往session中设置id，而非放到request域中</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>        model<span class="op">.</span><span class="fu">setAttritute</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>model<span class="op">.</span><span class="fu">getAttritute</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">));</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>session操作也可以使用原生的servlet API</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/find1&quot;</span><span class="op">)</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">find1</span><span class="op">(</span>HttpSession session<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>    session<span class="op">.</span><span class="fu">setAttritute</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>session<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">));</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;success&quot;</span><span class="op">;</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>cookie也可以使用原生的servlet API</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/findbyid&quot;</span><span class="op">)</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">findUserById</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">){</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    Cookie<span class="op">[]</span> cookies <span class="op">=</span> request<span class="op">.</span><span class="fu">getCookies</span><span class="op">();</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">null</span> <span class="op">==</span> cookies<span class="op">)</span> <span class="op">{</span><span class="co">//如果没有cookie数组</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;没有cookie&quot;</span><span class="op">);</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span>Cookie cookie <span class="op">:</span> cookies<span class="op">){</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;cookieName:&quot;</span><span class="op">+</span>cookie<span class="op">.</span><span class="fu">getName</span><span class="op">()+</span><span class="st">&quot;,cookieValue:&quot;</span><span class="op">+</span> cookie<span class="op">.</span><span class="fu">getValue</span><span class="op">());</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>    Cookie cookie <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cookie</span><span class="op">(</span><span class="st">&quot;name_test&quot;</span><span class="op">,</span><span class="st">&quot;value_test&quot;</span><span class="op">);</span><span class="co">//创建新cookie</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>    cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">5</span> <span class="op">*</span> <span class="dv">60</span><span class="op">);</span><span class="co">// 设置存在时间为5分钟</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>    cookie<span class="op">.</span><span class="fu">setPath</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span><span class="co">//设置作用域</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a>    response<span class="op">.</span><span class="fu">addCookie</span><span class="op">(</span>cookie<span class="op">);</span><span class="co">//将cookie添加到response的cookie数组中返回给客户端</span></span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="exceptionresolver">ExceptionResolver</h3>
<p>ExceptionResolver只能有一个，它用于处理全局的异常</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span><span class="co">//加入容器即可，Spring可以自动识别</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyExceptionHandler <span class="kw">implements</span> HandlerExceptionResolver<span class="op">{</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ModelAndView <span class="fu">resolveException</span><span class="op">(</span>HttpServletRequest httpServletRequest<span class="op">,</span> HttpServletResponse httpServletResponse<span class="op">,</span> <span class="bu">Object</span> o<span class="op">,</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>        ModelAndView modelAndView <span class="op">=</span> <span class="kw">new</span> <span class="fu">ModelAndView</span><span class="op">();</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>        modelAndView<span class="op">.</span><span class="fu">setViewName</span><span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">);</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> modelAndView<span class="op">;</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果希望只处理当前Controller的异常，可以使用<code>@ExceptionHandler</code>（也可以配合<code>@ControllerAdvice</code>使用，变为处理全局异常）</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co">//可以指定该@ExceptionHandler处理的异常类型</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="at">@ExceptionHandler</span><span class="op">({</span><span class="bu">RuntimeException</span><span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">myExceptionHandle1</span><span class="op">(</span><span class="bu">Exception</span> exception<span class="op">){</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;myExceptionHandle1&quot;</span><span class="op">);</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;异常： &quot;</span> <span class="op">+</span> exception<span class="op">);</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;error&quot;</span><span class="op">;</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="co">//如果我们自定义异常类继承自RuntimeException，而且同时有两个@ExceptionHandler分别处理RuntimeException和MyRunTimeException，则会调用我们的MyRunTimeException</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a><span class="at">@ExceptionHandler</span><span class="op">({</span>MyRuntimeException<span class="op">.</span><span class="fu">class</span><span class="op">})</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">myExceptionHandle2</span><span class="op">(</span><span class="bu">Exception</span> exception<span class="op">){</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;myExceptionHandle2&quot;</span><span class="op">);</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;异常： &quot;</span> <span class="op">+</span> exception<span class="op">);</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;error&quot;</span><span class="op">;</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>还可以使用<code>SimpleMappingExceptionResolver</code>处理全局异常</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot;</span>&gt;</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 定义默认的异常处理页面 --&gt;</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultErrorView&quot;</span><span class="ot"> value=</span><span class="st">&quot;error&quot;</span>/&gt;</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 定义异常处理页面用来获取异常信息的变量名，如果不添加exceptionAttribute属性，则默认为exception --&gt;</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;exceptionAttribute&quot;</span><span class="ot"> value=</span><span class="st">&quot;exception&quot;</span>/&gt;</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 定义需要特殊处理的异常，用类名或完全路径名作为key，异常页面名作为值 --&gt;</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;exceptionMappings&quot;</span>&gt;</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">props</span>&gt;</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;java.lang.RuntimeException&quot;</span>&gt;error&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">props</span>&gt;</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span></code></pre></div>
<h3 id="interceptor">Interceptor</h3>
<div class="sourceCode" id="cb159"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyInterceptor <span class="kw">implements</span> HandlerInterceptor <span class="op">{</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">preHandle</span><span class="op">(</span>HttpServletRequest httpServletRequest<span class="op">,</span> HttpServletResponse httpServletResponse<span class="op">,</span> <span class="bu">Object</span> o<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;preHandle&quot;</span><span class="op">);</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">postHandle</span><span class="op">(</span>HttpServletRequest httpServletRequest<span class="op">,</span> HttpServletResponse httpServletResponse<span class="op">,</span> <span class="bu">Object</span> o<span class="op">,</span> ModelAndView modelAndView<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;postHandle&quot;</span><span class="op">);</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterCompletion</span><span class="op">(</span>HttpServletRequest httpServletRequest<span class="op">,</span> HttpServletResponse httpServletResponse<span class="op">,</span> <span class="bu">Object</span> o<span class="op">,</span> <span class="bu">Exception</span> e<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;afterCompletion&quot;</span><span class="op">);</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>配置</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mvc:interceptors</span>&gt;</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:interceptor</span>&gt;</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">mvc:mapping</span><span class="ot"> path=</span><span class="st">&quot;/**&quot;</span> /&gt;</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">mvc:exclude-mapping</span><span class="ot"> path=</span><span class="st">&quot;/css/**&quot;</span> /&gt;</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">mvc:exclude-mapping</span><span class="ot"> path=</span><span class="st">&quot;/js/**&quot;</span> /&gt;</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;controller.interceptors.MyInterceptor&quot;</span> /&gt;</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">mvc:interceptor</span>&gt;</span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mvc:interceptors</span>&gt;</span></code></pre></div>
<p>如果有多个拦截器，则按加入的顺序执行，而且只要前面的拦截器拦截了，后面的拦截器都不会执行</p>
<h3 id="跨域问题">跨域问题</h3>
<h4 id="跨域请求">跨域请求</h4>
<p>浏览器默认禁止js跨域请求，跨域是指通过js在不同的域之间进行数据传输或通信</p>
<p>这里的跨域是狭义的，是由浏览器同源策略限制的一类请求场景</p>
<p>不同域包括：</p>
<ul>
<li>不同url（包括：<code>a.mywebsite.com</code>和<code>b.mywebsite.com</code>(子域不同)，<code>a.com</code>和<code>b.com</code>(主域不同)，<code>mywebsite.com</code>和<code>192.168.1.1</code>(一个是域名、一个是ip地址)）</li>
<li>不同端口</li>
<li>不同协议（如http和https）</li>
<li>不同iframe</li>
</ul>
<p>同源策略/SOP（Same origin
policy）限制了不能访问不同域的Cookie、LocalStorage、IndexDB、DOM、json对象，AJAX请求不能发送</p>
<p>而广义的跨域包括：</p>
<ul>
<li>资源跳转: A链接、重定向、表单提交</li>
<li>资源嵌入:
<code>&lt;link&gt;</code>、<code>&lt;script&gt;</code>、<code>&lt;img&gt;</code>、<code>&lt;frame&gt;</code>等标签，还有样式中<code>background:url()</code>、<code>@font-face()</code>等文件外链</li>
<li>脚本请求: js发起的ajax请求、dom和js对象的跨域操作等</li>
</ul>
<p>这里不讨论广义的跨域</p>
<h4 id="解决方法">解决方法</h4>
<p>解决跨域问题有如下方法</p>
<h5 id="jsonp">JSONP</h5>
<p>JSONP的跨域原理：json不能跨域请求数据（json对象），但可以跨域请求json脚本，得到脚本中会立即执行</p>
<p>我们可以把数据封装成js语句，调用我们定义好的方法，比如</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dosomething</span>(jsondata){</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//处理返回的数据</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;https://mywebsite.com/callback/dosomething&quot;</span><span class="dt">&gt;</span></span></code></pre></div>
<p>对应返回的脚本</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/callback/{callback}&quot;</span><span class="op">)</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">String</span> <span class="fu">callback</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">String</span> callback<span class="op">){</span></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//获取数据</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> data <span class="op">=</span> <span class="st">&quot;&#39;user&#39;:{&#39;id&#39;:1,&#39;name&#39;:&#39;小明&#39;}&quot;</span><span class="op">;</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> callback <span class="op">+</span> <span class="st">&quot;(&quot;</span> <span class="op">+</span> data <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="co">//或者使用Spring MVC的MappingJacksonValue</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/id/{id}/callback/{callback}&quot;</span><span class="op">)</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a><span class="at">@ResponseBody</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="bu">Object</span> <span class="fu">findById</span><span class="op">(</span><span class="at">@PathVariable</span> id<span class="op">,</span> <span class="bu">String</span> callback<span class="op">){</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    User user <span class="op">=</span> UserDao<span class="op">.</span><span class="fu">findById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>    MappingJacksonValue mappingJacksonValue <span class="op">=</span> <span class="kw">new</span> <span class="fu">MappingJacksonValue</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>    mappingJacksonValue<span class="op">.</span><span class="fu">setJsonpFunction</span><span class="op">(</span>callback<span class="op">);</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>    retrun mappingJacksonValue<span class="op">;</span></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>JSONP帮我们把上面的逻辑封装好了：</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>$<span class="op">.</span><span class="fu">getJSONP</span>(<span class="st">&#39;https://mywebsite.com/callback/?&#39;</span><span class="op">,</span><span class="kw">function</span>(jsondata){</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//处理返回的数据</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="co">//或者</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>$<span class="op">.</span><span class="fu">ajax</span>({</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a> <span class="dt">url</span><span class="op">:</span> <span class="st">&#39;https://mywebsite.com/callback/?&#39;</span><span class="op">,</span> <span class="co">//不指定回调名，可省略callback参数，会由jQuery自动生成</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a> <span class="dt">dataType</span><span class="op">:</span> <span class="st">&#39;jsonp&#39;</span><span class="op">,</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a> <span class="dt">jsonpCallback</span><span class="op">:</span> <span class="st">&#39;demo&#39;</span><span class="op">,</span> <span class="co">//可省略</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a> <span class="dt">success</span><span class="op">:</span> <span class="kw">function</span>(jsondata) {</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>   <span class="co">//处理返回的数据</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a> }</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>JSONP的局限在于它只支持GET请求，而且也没有错误处理机制</p>
<h5 id="window.domain">window.domain</h5>
<p>对于两个iframe分别使用<code>a.mywebsite.com</code>和<code>b.mywebsite.com</code>作为src的情况下，两个iframe无法获取对方的属性或对象</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">onLoad</span>(){</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> iframe2 <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;iframe2&#39;</span>)<span class="op">;</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> win2 <span class="op">=</span> iframe2<span class="op">.</span><span class="at">contentWindow</span><span class="op">;</span> <span class="co">//可以获取到window对象，但无法访问里面的属性和方法</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> doc <span class="op">=</span> win2<span class="op">.</span><span class="at">document</span><span class="op">;</span> <span class="co">//获取不到</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> name <span class="op">=</span> win2<span class="op">.</span><span class="at">name</span><span class="op">;</span> <span class="co">//获取不到</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>对于这种基础域名相同的情况（同时端口、协议也必须相同），可以通过设置<code>document.domain</code>来进行跨域请求</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">domain</span> <span class="op">=</span> <span class="st">&#39;mywebsite.com&#39;</span><span class="op">;</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p>这样即使是两个iframe，只要<code>document.domain</code>相同，都可以通过js获取另一iframe中的各种属性和对象</p>
<h5 id="postmessage">postMessage</h5>
<p>postMessage是HTML5 XMLHttpRequest Level
2中的API，且是为数不多可以跨域操作的window属性之一</p>
<p><code>a.mywebsite.com/a.html</code>：</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">iframe</span><span class="ot"> id</span><span class="op">=</span><span class="st">&quot;iframe2&quot;</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;http://b.mywebsite.com/b.html&quot;</span><span class="ot"> style</span><span class="op">=</span><span class="st">&quot;display:none;&quot;</span><span class="dt">&gt;&lt;/</span><span class="kw">iframe</span><span class="dt">&gt;</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- a页面 --&gt;</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>       </span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> iframe2 <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;iframe2&#39;</span>)<span class="op">;</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>    iframe2<span class="op">.</span><span class="at">onload</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> data <span class="op">=</span> {</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;myname&#39;</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>        }<span class="op">;</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//向b页面传送跨域数据</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>        iframe2<span class="op">.</span><span class="at">contentWindow</span><span class="op">.</span><span class="fu">postMessage</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)<span class="op">,</span> <span class="st">&#39;http://b.mywebsite.com&#39;</span>)<span class="op">;</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">;</span></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//接收b.mywebsite.com返回数据</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="kw">function</span>(msg) {</span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(<span class="st">&#39;data from b ---&gt; &#39;</span> <span class="op">+</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<p><code>b.mywebsite.com/b.html</code>：</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//接收a.mywebsite.com的数据</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">window</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;message&#39;</span><span class="op">,</span> <span class="kw">function</span>(msg) {</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(<span class="st">&#39;data from a ---&gt; &#39;</span> <span class="op">+</span> msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(msg<span class="op">.</span><span class="at">data</span>)<span class="op">;</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (data) {</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>            data<span class="op">.</span><span class="at">number</span> <span class="op">=</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">//处理后返回给a</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">window</span><span class="op">.</span><span class="at">parent</span><span class="op">.</span><span class="fu">postMessage</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(data)<span class="op">,</span> <span class="st">&#39;http://a.mywebsite.com&#39;</span>)<span class="op">;</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h5 id="cors">CORS</h5>
<p>CORS（Cross-origin resource
sharing，跨域资源共享）是一个用于解决跨域问题的标准，它通过添加几个HTTP头来允许部分的跨域通信</p>
<p>对于非简单请求（比如请求方法是PUT或DELETE，或者Content-Type字段的类型是<code>application/json</code>），会在正式通信之前，增加一次HTTP查询请求，称为”预检”请求（preflight），预检的请求类型为OPTIONS</p>
<p>浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段（自动在header增加Origin、Access-Control-Request-Method、Access-Control-Request-Headers等信息用于匹配）。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错</p>
<p>方法一：使用Servlet的Filter自动添加用于支持跨域的header</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CORSFilter <span class="kw">implements</span> <span class="bu">Filter</span><span class="op">{</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">doFilterInternal</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span> HttpServletResponse response<span class="op">,</span> FilterChain filterChain<span class="op">)</span> <span class="kw">throws</span> ServletException<span class="op">,</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Access-Control-Allow-Origin只能配置一个url；也可以用*，表示允许所有请求来源；要限定指定url列表可以跨域访问当前站点，可以提供代码动态判断，如果在url列表中，则把对应url加到Access-Control-Allow-Origin中</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Origin&quot;</span><span class="op">,</span> <span class="st">&quot;http://mywebsite.com&quot;</span><span class="op">);</span> <span class="co">//指定授权访问的域（即允许来自http://mywebsite.com的请求跨域访问当前站点）</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Methods&quot;</span><span class="op">,</span> <span class="st">&quot;GET, POST, PUT, DELETE&quot;</span><span class="op">);</span> <span class="co">//授权请求的方法，多个用逗号分隔</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Headers&quot;</span><span class="op">,</span> <span class="st">&quot;Content-Type, X-PINGOTHER&quot;</span><span class="op">);</span> <span class="co">//允许请求中携带Content-Type和X-PINGOTHER字段，多个用逗号分隔</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>    response<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Credentials&quot;</span><span class="op">,</span> <span class="st">&quot;true&quot;</span><span class="op">);</span> <span class="co">//是否支持跨域Cookie，为true时Access-Control-Allow-Origin不能为*</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Max-Age&quot;</span><span class="op">,</span> <span class="st">&quot;1800&quot;</span><span class="op">);</span><span class="co">//该响应的有效时间为1800秒</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>        filterChain<span class="op">.</span><span class="fu">doFilter</span><span class="op">(</span>request<span class="op">,</span> response<span class="op">);</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在web.xml中配置Filter</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter</span>&gt;</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;cors&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-class</span>&gt;com.myapp.filter.CORSFilter&lt;/<span class="kw">filter-class</span>&gt;</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter</span>&gt;</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter-mapping</span>&gt;</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;cors&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter-mapping</span>&gt;</span></code></pre></div>
<p>方法二：使用Spring MVC的Adapter配置</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableWebMvc</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebConfig <span class="kw">extends</span> WebMvcConfigurerAdapter <span class="op">{</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">addCorsMappings</span><span class="op">(</span>CorsRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addMapping</span><span class="op">(</span><span class="st">&quot;/api/**&quot;</span><span class="op">)</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">allowedOrigins</span><span class="op">(</span><span class="st">&quot;http://mywebsite.com&quot;</span><span class="op">)</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">allowedMethods</span><span class="op">(</span><span class="st">&quot;GET&quot;</span><span class="op">,</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="st">&quot;PUT&quot;</span><span class="op">,</span> <span class="st">&quot;DELETE&quot;</span><span class="op">)</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">allowedHeaders</span><span class="op">(</span><span class="st">&quot;Content-Type&quot;</span><span class="op">,</span> <span class="st">&quot;X-PINGOTHER&quot;</span><span class="op">)</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">exposedHeaders</span><span class="op">(</span><span class="st">&quot;header1&quot;</span><span class="op">,</span> <span class="st">&quot;header2&quot;</span><span class="op">)</span> <span class="co">//可选，CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">allowCredentials</span><span class="op">(</span><span class="kw">false</span><span class="op">)</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">maxAge</span><span class="op">(</span><span class="dv">1800</span><span class="op">);</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>方法三：使用Spring MVC封装的CORS</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mvc:cors</span>&gt;</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:mapping</span><span class="ot"> path=</span><span class="st">&quot;/**&quot;</span> /&gt;</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mvc:cors</span>&gt;</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 或者 --&gt;</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mvc:cors</span>&gt;</span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:mapping</span><span class="ot"> path=</span><span class="st">&quot;/api/**&quot;</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a>        <span class="er">&lt;!--</span><span class="ot"> 这里支持多个origin</span> <span class="er">--&gt;</span></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>        <span class="er">allowed-origins</span><span class="ot">=</span><span class="st">&quot;http://a.mywebsite1.com, http://b.mywebsite2.com&quot;</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a><span class="ot">        allowed-methods=</span><span class="st">&quot;GET, POST, PUT, DELETE&quot;</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a><span class="ot">        allowed-headers=</span><span class="st">&quot;Content-Type, X-PINGOTHER&quot;</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a><span class="ot">        exposed-headers=</span><span class="st">&quot;header1, header2&quot;</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a><span class="ot">        allow-credentials=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a><span class="ot">        max-age=</span><span class="st">&quot;1800&quot;</span> /&gt;</span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:mapping</span><span class="ot"> path=</span><span class="st">&quot;/resources/**&quot;</span></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a><span class="ot">        allowed-origins=</span><span class="st">&quot;http://mywebsite.com&quot;</span> /&gt;</span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mvc:cors</span>&gt;</span></code></pre></div>
<p>方法四：<code>@CrossOrigin</code></p>
<p>上面的配置都是全局的，使用<code>@CrossOrigin</code>可以针对单个Controller或里面的方法配置</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="at">@CrossOrigin</span><span class="op">(</span>origins <span class="op">=</span> <span class="st">&quot;http://mywebsite.com&quot;</span><span class="op">,</span> maxAge <span class="op">=</span> <span class="dv">1800</span><span class="op">)</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserController <span class="op">{</span></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span>method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">GET</span><span class="op">,</span> path <span class="op">=</span> <span class="st">&quot;/id/{id}&quot;</span><span class="op">)</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseBody</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">findById</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果使用了Nginx，还需在Nginx中配置跨域支持</p>
<pre class="nginx"><code>server {
    listen 80;
    server_name mywebsite.com;
    root /var/www/;

    location / {
        # 预检请求类型是OPTIONS
        if ($request_method = &#39;OPTIONS&#39;) {
            add_header &#39;Access-Control-Allow-Origin&#39; &#39;*&#39;;
            add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, PUT, DELETE, OPTIONS&#39;;
            add_header &#39;Access-Control-Allow-Headers&#39; &#39;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#39;;
            add_header &#39;Access-Control-Max-Age&#39; 1800;
            add_header &#39;Content-Type&#39; &#39;text/plain charset=UTF-8&#39;;
            add_header &#39;Content-Length&#39; 0;
            return 204;
        }
        if ($request_method = &#39;POST&#39;) {
            add_header &#39;Access-Control-Allow-Origin&#39; &#39;*&#39;;
            add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, PUT, DELETE, OPTIONS&#39;;
            add_header &#39;Access-Control-Allow-Headers&#39; &#39;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type&#39;;
        }
    }
}</code></pre>
<p>js</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="co">//原生AJAX</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> url <span class="op">=</span> <span class="st">&#39;http://mywebsite.com/user/id/1&#39;</span><span class="op">;</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> xhr <span class="op">=</span> <span class="kw">new</span> <span class="bu">XMLHttpRequest</span>()<span class="op">;</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>xhr<span class="op">.</span><span class="at">withCredentials</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span> <span class="co">//不带cookie</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>xhr<span class="op">.</span><span class="fu">open</span>(<span class="st">&#39;GET&#39;</span><span class="op">,</span> url<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>xhr<span class="op">.</span><span class="fu">setRequestHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;application/json&#39;</span>)<span class="op">;</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>xhr<span class="op">.</span><span class="fu">send</span>()<span class="op">;</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>xhr<span class="op">.</span><span class="at">onreadystatechange</span> <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (xhr<span class="op">.</span><span class="at">readyState</span> <span class="op">==</span> <span class="dv">4</span> <span class="op">&amp;&amp;</span> xhr<span class="op">.</span><span class="at">status</span> <span class="op">==</span> <span class="dv">200</span>) {</span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">alert</span>(xhr<span class="op">.</span><span class="at">responseText</span>)<span class="op">;</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a><span class="co">//jQuery</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a><span class="fu">$</span>(<span class="bu">document</span>)<span class="op">.</span><span class="fu">ready</span>(<span class="kw">function</span>() {</span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>    $<span class="op">.</span><span class="fu">ajax</span>({</span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">url</span><span class="op">:</span> <span class="st">&quot;http://mywebsite.com/user/id/1&quot;</span><span class="op">,</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">method</span><span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">contentType</span><span class="op">:</span> <span class="st">&quot;application/json; charset=utf-8&quot;</span><span class="op">,</span></span>
<span id="cb174-21"><a href="#cb174-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">xhrFields</span><span class="op">:</span> {</span>
<span id="cb174-22"><a href="#cb174-22" aria-hidden="true" tabindex="-1"></a>            <span class="dt">withCredentials</span><span class="op">:</span> <span class="kw">false</span> <span class="co">//不带cookie</span></span>
<span id="cb174-23"><a href="#cb174-23" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb174-24"><a href="#cb174-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">crossDomain</span><span class="op">:</span> <span class="kw">true</span> <span class="co">//让请求头中包含跨域的额外信息，但不会含cookie</span></span>
<span id="cb174-25"><a href="#cb174-25" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>(data<span class="op">,</span> status<span class="op">,</span> jqxhr) {</span>
<span id="cb174-26"><a href="#cb174-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">alert</span>(data)</span>
<span id="cb174-27"><a href="#cb174-27" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb174-28"><a href="#cb174-28" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb174-29"><a href="#cb174-29" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code></pre></div>
<h5 id="服务器跨域">服务器跨域</h5>
<p>让服务器来完成跨域资源的请求</p>
<p>通过nginx配置一个代理服务器（域名与domain1相同，端口不同）做跳板机，反向代理访问domain2接口，并且可以顺便修改cookie中domain信息，方便当前域cookie写入，实现跨域登录</p>
<pre class="nginx"><code>server {
    listen 81;
    server_name  www.domain1.com;

    location / {
        proxy_pass http://loginservers; #反向代理
        proxy_cookie_domain www.domain2.com www.domain1.com; #修改cookie domain
        index index.html index.htm;

        # 当用webpack-dev-server等中间件代理接口访问nignx时，此时无浏览器参与，故没有同源限制，下面的跨域配置可不启用
        add_header Access-Control-Allow-Origin http://www.domain1.com; #当前端只跨域不带cookie时，可为*
        add_header Access-Control-Allow-Credentials true;
    }
}

# 使用ip_hash方式的负载均衡
upstream loginservers {
    server www.domain2.com:8080;
    server www.domain3.com:8080;
    ip_hash;
}</code></pre>
<h5 id="附nginx常用配置">附:Nginx常用配置</h5>
<p><strong>nginx使用</strong></p>
<pre class="nginx"><code># 启动
nginx -c /etc/nginx/nginx.conf
# 停止
nginx -s stop -c /etc/nginx/nginx.conf
# 重启
nginx -s reload -c /etc/nginx/nginx.conf</code></pre>
<p><strong>匹配规则</strong></p>
<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr>
<th>字符</th>
<th>匹配规则</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>精确匹配，不可以使用正则</td>
</tr>
<tr>
<td><code>~</code></td>
<td>区分大小写的正则匹配</td>
</tr>
<tr>
<td><code>~*</code></td>
<td>不区分大小写的正则匹配</td>
</tr>
<tr>
<td><code>!~</code></td>
<td>以<code>!</code>开头表示不匹配，比如<code>!~</code>区分大小写不匹配，<code>!~*</code>不区分大小写不匹配</td>
</tr>
<tr>
<td><code>^~</code></td>
<td>uri以某个常规字符串开头，不可以使用正则</td>
</tr>
<tr>
<td><code>/</code></td>
<td>通用匹配, 如果没有其它匹配,任何请求都会匹配到</td>
</tr>
<tr>
<td>空匹配符</td>
<td>不写任何匹配规则则匹配以后面的路径开头的地址</td>
</tr>
</tbody>
</table>
<p>匹配规则是：最大前缀匹配（与顺序无关）</p>
<p>对于正则location的匹配规则是：按编辑顺序逐个匹配（与顺序有关）</p>
<p><strong>文件目录匹配</strong></p>
<table>
<thead>
<tr>
<th>字符</th>
<th>匹配内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-f</code>、<code>!-f</code></td>
<td>文件是否存在</td>
</tr>
<tr>
<td><code>-d</code>、<code>!-d</code></td>
<td>目录是否存在</td>
</tr>
<tr>
<td><code>-e</code>、<code>!-e</code></td>
<td>文件或目录是否存在</td>
</tr>
<tr>
<td><code>-x</code>、<code>!-x</code></td>
<td>文件是否存在且可执行</td>
</tr>
</tbody>
</table>
<p>常用在if中，比如</p>
<pre class="nginx"><code>if (!-f $request_filename) {
    return 404
}</code></pre>
<p><strong>常用正则</strong></p>
<table>
<thead>
<tr>
<th>字符</th>
<th>匹配内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.</code></td>
<td>匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td><code>?</code></td>
<td>重复0次或1次</td>
</tr>
<tr>
<td><code>+</code></td>
<td>重复1次或更多次</td>
</tr>
<tr>
<td><code>*</code></td>
<td>重复0次或更多次</td>
</tr>
<tr>
<td><code>\d</code></td>
<td>匹配数字</td>
</tr>
<tr>
<td><code>^</code></td>
<td>匹配字符串的开始</td>
</tr>
<tr>
<td><code>$</code></td>
<td>匹配字符串的结尾</td>
</tr>
<tr>
<td><code>{n}</code></td>
<td>重复n次</td>
</tr>
<tr>
<td><code>{n,}</code></td>
<td>重复n次或更多次</td>
</tr>
<tr>
<td><code>[c]</code></td>
<td>匹配单个字符c</td>
</tr>
<tr>
<td><code>[a-z]</code></td>
<td>匹配a-z小写字母的任意一个</td>
</tr>
<tr>
<td><code>(xxx)</code></td>
<td>分组，后面可以通过<code>$1</code>、<code>$2</code>…引用分组的内容</td>
</tr>
</tbody>
</table>
<p><strong>内置变量</strong></p>
<pre class="nginx"><code>$args                    #请求中的参数值
$query_string            #同 $args
$arg_NAME                #GET请求中NAME的值
$is_args                 #如果请求中有参数，值为&quot;?&quot;，否则为空字符串
$uri                     #请求中的当前URI(不带请求参数，参数位于$args)，可以不同于浏览器传递的$request_uri的值，它可以通过内部重定向，或者使用index指令进行修改，$uri不包含主机名，如&quot;/foo/bar.html&quot;。
$document_uri            #同 $uri
$document_root           #当前请求的文档根目录或别名
$host                    #优先级：HTTP请求行的主机名&gt;&quot;HOST&quot;请求头字段&gt;符合请求的服务器名
$hostname                #主机名
$https                   #如果开启了SSL安全模式，值为&quot;on&quot;，否则为空字符串。
$binary_remote_addr      #客户端地址的二进制形式，固定长度为4个字节
$body_bytes_sent         #传输给客户端的字节数，响应头不计算在内；这个变量和Apache的mod_log_config模块中的&quot;%B&quot;参数保持兼容
$bytes_sent              #传输给客户端的字节数
$connection              #TCP连接的序列号
$connection_requests     #TCP连接当前的请求数量
$content_length          #&quot;Content-Length&quot; 请求头字段
$content_type            #&quot;Content-Type&quot; 请求头字段
$cookie_name             #cookie名称
$limit_rate              #用于设置响应的速度限制
$msec                    #当前的Unix时间戳
$nginx_version           #nginx版本
$pid                     #工作进程的PID
$pipe                    #如果请求来自管道通信，值为&quot;p&quot;，否则为&quot;.&quot;
$proxy_protocol_addr     #获取代理访问服务器的客户端地址，如果是直接访问，该值为空字符串
$realpath_root           #当前请求的文档根目录或别名的真实路径，会将所有符号连接转换为真实路径
$remote_addr             #客户端地址
$remote_port             #客户端端口
$remote_user             #用于HTTP基础认证服务的用户名
$request                 #代表客户端的请求地址
$request_body            #客户端的请求主体：此变量可在location中使用，将请求主体通过proxy_pass，fastcgi_pass，uwsgi_pass和scgi_pass传递给下一级的代理服务器
$request_body_file       #将客户端请求主体保存在临时文件中。文件处理结束后，此文件需删除。如果需要之一开启此功能，需要设置client_body_in_file_only。如果将次文件传递给后端的代理服务器，需要禁用request body，即设置proxy_pass_request_body off，fastcgi_pass_request_body off，uwsgi_pass_request_body off，or scgi_pass_request_body off
$request_completion      #如果请求成功，值为&quot;OK&quot;，如果请求未完成或者请求不是一个范围请求的最后一部分，则为空
$request_filename        #当前连接请求的文件路径，由root或alias指令与URI请求生成
$request_length          #请求的长度 (包括请求的地址，http请求头和请求主体)
$request_method          #HTTP请求方法，通常为&quot;GET&quot;或&quot;POST&quot;
$request_time            #处理客户端请求使用的时间; 从读取客户端的第一个字节开始计时
$request_uri             #这个变量等于包含一些客户端请求参数的原始URI，它无法修改，请查看$uri更改或重写URI，不包含主机名，例如：&quot;/cnphp/test.php?arg=freemouse&quot;
$scheme                  #请求使用的Web协议，&quot;http&quot; 或 &quot;https&quot;
$server_addr             #服务器端地址，需要注意的是：为了避免访问linux系统内核，应将ip地址提前设置在配置文件中
$server_name             #服务器名
$server_port             #服务器端口
$server_protocol         #服务器的HTTP版本，通常为 &quot;HTTP/1.0&quot; 或 &quot;HTTP/1.1&quot;
$status                  #HTTP响应代码
$time_iso8601            #服务器时间的ISO 8610格式
$time_local              #服务器时间（LOG Format 格式）
$cookie_NAME             #客户端请求Header头中的cookie变量，前缀&quot;$cookie_&quot;加上cookie名称的变量，该变量的值即为cookie名称的值
$http_NAME               #匹配任意请求头字段；变量名中的后半部分NAME可以替换成任意请求头字段，如在配置文件中需要获取http请求头：&quot;Accept-Language&quot;，$http_accept_language即可
$http_cookie
$http_post
$http_referer
$http_user_agent
$http_x_forwarded_for
$sent_http_NAME          #可以设置任意http响应头字段；变量名中的后半部分NAME可以替换成任意响应头字段，如需要设置响应头Content-length，$sent_http_content_length即可
$sent_http_cache_control
$sent_http_connection
$sent_http_content_type
$sent_http_keep_alive
$sent_http_last_modified
$sent_http_location
$sent_http_transfer_encoding</code></pre>
<p>配置示例：</p>
<pre class="nginx"><code>server {
    listen 80;
    server_name domain1.com domain2.com # 多个用空格隔开

    sendfile on;
    #charset koi8-r;
    access_log /var/log/nginx/log/static_access.log main;   # 访客记录
    error_log  /var/log/nginx/log/error.log;   # 错误记录

    error_page  500 502 503 504  /50x.html;

    # 图片服务器
    location ~ .*\.(jpg|gif|png)$ {

        # 缓存（添加Expires、Cache-Control、ETag等头）
        # expires 24h;

        # 使用gzip压缩
        gzip on;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;

        # 防盗链
        valid_referers none blocked server_names
                        *.domain1.com
                        *.domain2.com;
        if ($invalid_referer) {
            return 403;
        }

        # 路由重写
        if ($http_user_agent ~ MSIE) {
            # last(执行路由重写时不通过nginx解析，如果需要使用if语句的路由会无法访问)、break(执行路由重写时通过nginx解析)、redirect(302临时重定向)、permanent(301永久重定向，清浏览器缓存可以恢复)
            # header中有MSIE则重写到msie目录
            rewrite ^(.*)$ /msie/$1 break;
        }

        root /var/www/images;
    }

    # 提高文件传输效率（需开启sendfile模块，且只在长连接时有效）
    location ~ ^/download {
        tcp_nopush on;      # 在Linux上使用TCP_CORK套接字选项（数据包不会马上传送出去，等到数据包最大时，一次性的传输出去，这样有助于解决网络堵塞）
        #tcp_nodelay on;    # 功能和tcp_nopush on相反，收到数据包后马上传送出去，不等待；两个选项是互斥的
    }

    # CORS跨域
    location ~ .*\.(htm|html)$ {
        add_header Access-Control-Allow-Origin http://domain1.com;
        add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS;
        root /var/www/html;
    }

    # 正向代理
    resolver 8.8.8.8;   # 配置DNS解析IP地址（必需）
    resolver_timeout 5s;
    location ^~ /site1/ {
        proxy_pass $scheme://$host$request_uri;
        proxy_set_header Host $http_host;

        proxy_buffers 256 4k;       # 缓存大小
        proxy_max_temp_file_size 0; # 关闭磁盘缓存读写减少I/O
        proxy_connect_timeout 30;   # 连接超时时间
 
        # 配置代理服务器Http状态缓存时间
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 301 1h;
        proxy_cache_valid any 1m;
    }

    # 反向代理
    upstream backend {
        #ip_hash;    # 负载均衡算法有轮询、加权轮询、ip_hash、least_conn、hash
        hash $request_uri;
        hash_method  crc32;
        server 172.18.103.1:8001 weight=5;  # 带权重
        server 172.18.103.2:8001 max_fails=3 fail_timeout=5s;  # 失败重试3次
        server 172.18.103.3:8001 backup;    # 备用服务器
        server 172.18.103.4:8001 down;      # 模拟服务器下线
    }
    location ^~ /site2/ {
        proxy_pass http://backend;
    }

    # 分片存储
    location ^~ /upload/ {
        slice             1m;
        proxy_cache       cache;
        proxy_cache_key   $uri$is_args$args$slice_range;
        proxy_set_header  Range $slice_range;
        proxy_cache_valid 200 206 1h;
        proxy_pass        http://localhost:8000;
    }
}</code></pre>
<p>使用SSL</p>
<pre class="nginx"><code>server {
    listen 443;
    server_name domain3.com;

    # HTTPS优化：延长keepalive超时时间
    keepalive_timeout 100;

    ssl on;

    # HTTPS优化：使用SSL session缓存
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    ssl_certificate xxx.crt;
    ssl_certificate_key xxx.key;

    index index.html index.htm;
    location / {
        root /var/www/html;
    }
}</code></pre>
<h2 id="mybatis">Mybatis</h2>
<p>项目结构</p>
<pre><code>src/main
├── java
│   ├── dao
│   │   ├── pojo
│   │   │   ├── Student.java
│   │   │   └── Teacher.java
│   │   └── repository
│   │       └── StudentMapper.java
│   └── test
│       └── Test.java
└── resources
    ├── jdbc.properties
    ├── mapper
    │   └── StudentMapper.xml
    └── mybatis-config.xml</code></pre>
<p>注意，一般xxxMapper.xml在编译后不会生成到target文件夹，一种办法是把xxxMapper.xml放到resources文件夹（即和xxxMapper.java分开放，配置扫描的时候扫描xml，会根据namespace和id找到对应的java文件），另一种做法是在maven的pom.xml中配置xml路径，然后把xxxMapper.xml和xxxMapper.java放到同一个包下，扫描的时候可以使用包扫描</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">build</span>&gt;</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">resources</span>&gt;</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 默认就是不过滤resources文件夹 --&gt;</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">resource</span>&gt;</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">directory</span>&gt;src/main/resources&lt;/<span class="kw">directory</span>&gt;</span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">includes</span>&gt;</span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">include</span>&gt;**/*.properties&lt;/<span class="kw">include</span>&gt;</span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">include</span>&gt;**/*.xml&lt;/<span class="kw">include</span>&gt;</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">includes</span>&gt;</span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">filtering</span>&gt;false&lt;/<span class="kw">filtering</span>&gt;</span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">resource</span>&gt;</span>
<span id="cb182-12"><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 配置不过滤xml，**表示匹配多重路径 --&gt;</span></span>
<span id="cb182-13"><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">resource</span>&gt;</span>
<span id="cb182-14"><a href="#cb182-14" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">directory</span>&gt;src/main/java&lt;/<span class="kw">directory</span>&gt;</span>
<span id="cb182-15"><a href="#cb182-15" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">includes</span>&gt;</span>
<span id="cb182-16"><a href="#cb182-16" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">include</span>&gt;**/*.xml&lt;/<span class="kw">include</span>&gt;</span>
<span id="cb182-17"><a href="#cb182-17" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">includes</span>&gt;</span>
<span id="cb182-18"><a href="#cb182-18" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">filtering</span>&gt;false&lt;/<span class="kw">filtering</span>&gt;</span>
<span id="cb182-19"><a href="#cb182-19" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">resource</span>&gt;</span>
<span id="cb182-20"><a href="#cb182-20" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">resources</span>&gt;</span>
<span id="cb182-21"><a href="#cb182-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">build</span>&gt;</span></code></pre></div>
<p>如果是用gradle，则是配置</p>
<pre class="properties"><code>sourceSets.main.resources.srcDirs = [&quot;src/main/java&quot;,&quot;src/main/resources&quot;]</code></pre>
<p>建表</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> student(</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">32</span>),</span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>teacher_id <span class="dt">INT</span>,</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>class_name <span class="dt">VARCHAR</span>(<span class="dv">32</span>)</span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>)<span class="kw">default</span> charset <span class="op">=</span> utf8;</span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> teacher(</span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">32</span>),</span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>class_name <span class="dt">VARCHAR</span>(<span class="dv">32</span>)</span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>)<span class="kw">default</span> charset <span class="op">=</span> utf8;</span></code></pre></div>
<p>插入测试数据</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> student(<span class="kw">id</span>,name,teacher_id,class_name) <span class="fu">VALUE</span>(<span class="dv">1</span>,<span class="st">&#39;小明&#39;</span>,<span class="dv">1</span>,<span class="st">&#39;语文&#39;</span>);</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> student(<span class="kw">id</span>,name,teacher_id,class_name) <span class="fu">VALUE</span>(<span class="dv">2</span>,<span class="st">&#39;小王&#39;</span>,<span class="dv">1</span>,<span class="st">&#39;语文&#39;</span>);</span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> student(<span class="kw">id</span>,name,teacher_id,class_name) <span class="fu">VALUE</span>(<span class="dv">3</span>,<span class="st">&#39;小红&#39;</span>,<span class="dv">2</span>,<span class="st">&#39;数学&#39;</span>);</span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> teacher(<span class="kw">id</span>,name,class_name) <span class="fu">VALUE</span>(<span class="dv">1</span>,<span class="st">&#39;张老师&#39;</span>,<span class="st">&#39;语文&#39;</span>);</span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> teacher(<span class="kw">id</span>,name,class_name) <span class="fu">VALUE</span>(<span class="dv">2</span>,<span class="st">&#39;李老师&#39;</span>,<span class="st">&#39;数学&#39;</span>);</span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> teacher(<span class="kw">id</span>,name,class_name) <span class="fu">VALUE</span>(<span class="dv">3</span>,<span class="st">&#39;王老师&#39;</span>,<span class="st">&#39;英语&#39;</span>);</span></code></pre></div>
<h3 id="全局配置文件">全局配置文件</h3>
<p>mybatis-config.xml</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">configuration</span> PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">configuration</span>&gt;</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 加载jdbc配置文件 --&gt;</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">properties</span><span class="ot"> resource=</span><span class="st">&quot;jdbc.properties&quot;</span>/&gt;</span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 打印执行的SQL，调试时开启 --&gt;</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">settings</span>&gt;</span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">setting</span><span class="ot"> name=</span><span class="st">&quot;logImpl&quot;</span><span class="ot"> value=</span><span class="st">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">settings</span>&gt;</span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 配置别名 --&gt;</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">typeAliases</span>&gt;</span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 一个个配置</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;typeAlias type=&quot;dao.pojo.Student&quot; alias=&quot;student&quot; /&gt;</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 整个包扫描 --&gt;</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">package</span><span class="ot"> name=</span><span class="st">&quot;dao.pojo&quot;</span>/&gt;</span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">typeAliases</span>&gt;</span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">environments</span><span class="ot"> default=</span><span class="st">&quot;development&quot;</span>&gt;</span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">environment</span><span class="ot"> id=</span><span class="st">&quot;development&quot;</span>&gt;</span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 事务管理：</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a><span class="co">                   JDBC: jdbc事务管理器，对应JdbcTransactionFactory.class</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a><span class="co">                   MANAGED: 使用第三方的事务管理器，对应ManagedTransactionFactory.class，如果没有配置第三方事务管理器，则增删改查都不会生效</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a><span class="co">            --&gt;</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">transactionManager</span><span class="ot"> type=</span><span class="st">&quot;JDBC&quot;</span>/&gt;</span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 数据源：</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a><span class="co">                   UNPOOLED: 不适用连接池 即 每次请求都会为其创建一个DB连接，适用完毕后，会马上将连接关闭</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a><span class="co">                   POOLED: 数据库连接池来维护连接</span></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a><span class="co">                   JNDI: 数据源可以定义到应用的外部，通过JDNI容器来获取数据库连接</span></span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a><span class="co">            --&gt;</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">dataSource</span><span class="ot"> type=</span><span class="st">&quot;POOLED&quot;</span>&gt;</span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>                <span class="co">&lt;!-- 配置数据库连接信息（通过${}或#{}读取配置文件） --&gt;</span></span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;driver&quot;</span><span class="ot"> value=</span><span class="st">&quot;${jdbc.driver}&quot;</span>/&gt;</span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;url&quot;</span><span class="ot"> value=</span><span class="st">&quot;${jdbc.url}&quot;</span>/&gt;</span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span><span class="ot"> value=</span><span class="st">&quot;${jdbc.name}&quot;</span>/&gt;</span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span><span class="ot"> value=</span><span class="st">&quot;${jdbc.password}&quot;</span>/&gt;</span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">dataSource</span>&gt;</span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">environment</span>&gt;</span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">environments</span>&gt;</span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 导入mapper --&gt;</span></span>
<span id="cb186-44"><a href="#cb186-44" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mappers</span>&gt;</span>
<span id="cb186-45"><a href="#cb186-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 扫描包下所有的xml</span></span>
<span id="cb186-46"><a href="#cb186-46" aria-hidden="true" tabindex="-1"></a><span class="co">        命名规范：要求xml文件名和java文件名一致，一般以Mapper结尾，namespace为对应XXXMapper.java的全类名，CURD的id和XXXMapper.java的方法完全一致</span></span>
<span id="cb186-47"><a href="#cb186-47" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;package name=&quot;dao.repository&quot;/&gt;</span></span>
<span id="cb186-48"><a href="#cb186-48" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb186-49"><a href="#cb186-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 把与类对应的xml加载进来，也需要满足命名规范</span></span>
<span id="cb186-50"><a href="#cb186-50" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;mapper class=&quot;dao.repository.UserMapper&quot;/&gt;</span></span>
<span id="cb186-51"><a href="#cb186-51" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb186-52"><a href="#cb186-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 加载单个，无需满足命名规范</span></span>
<span id="cb186-53"><a href="#cb186-53" aria-hidden="true" tabindex="-1"></a><span class="co">         --&gt;</span></span>
<span id="cb186-54"><a href="#cb186-54" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">mapper</span><span class="ot"> resource=</span><span class="st">&quot;mapper/StudentMapper.xml&quot;</span>/&gt;</span>
<span id="cb186-55"><a href="#cb186-55" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">mappers</span>&gt;</span>
<span id="cb186-56"><a href="#cb186-56" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">configuration</span>&gt;</span></code></pre></div>
<p>jdbc.properties</p>
<pre class="properties"><code>jdbc.driver=com.mysql.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/mybatis?useUnicode=true&amp;characterEncoding=UTF-8
jdbc.name=root
jdbc.password=root</code></pre>
<h3 id="mapper.java">Mapper.java</h3>
<p>StudentMapper.java</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StudentMapper <span class="op">{</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//插入</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">insertStudent</span><span class="op">(</span>Student student<span class="op">);</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//删除</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteStudentById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">);</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//更新</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">updateStudent</span><span class="op">(</span>Student student<span class="op">);</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对一：根据id查学生</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    Student <span class="fu">findStudentById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">);</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对多：查询所有学生</span></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">();</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//模糊查询</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findStudentLikeName</span><span class="op">(</span><span class="bu">String</span> studentName<span class="op">);</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对多：查找所有老师和学生的对应关系</span></span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Teacher<span class="op">&gt;</span> <span class="fu">findAllTeacherAndStudent</span><span class="op">();</span></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//多对一：根据指定的学生id查找老师并放在student的teacher属性中</span></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findTeacherByStudentIds</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> studentId<span class="op">);</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Student.java</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Student <span class="op">{</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//每门课对应一个老师</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> teacherId<span class="op">;</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> className<span class="op">;</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Teacher teacher<span class="op">;</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//以下省略get、set和无参构造器</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Teacher.java</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Teacher <span class="op">{</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一个老师教一门课</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> className<span class="op">;</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一个老师可以同时教多个学生</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> students<span class="op">;</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//以下省略get、set和无参构造器</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="mapper.xml">mapper.xml</h3>
<p>StudentMapper.xml</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span> <span class="fu">?&gt;</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mapper</span> PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mapper</span><span class="ot"> namespace=</span><span class="st">&quot;dao.repository.StudentMapper&quot;</span>&gt;</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 这里使用了全类名，由于设置了typeAliases，也可以使用student代替dao.pojo.Student --&gt;</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 这里使用OGNL表达式获取POJO的属性，比如成员变量为基本数据类型：#{teacherId}，成员变量为POJO类型：#{teacher.id} --&gt;</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">insert</span><span class="ot"> id=</span><span class="st">&quot;insertStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;dao.pojo.Student&quot;</span>&gt;</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>        INSERT INTO student(id,name,teacher_id,class_name) VALUE(#{id}, #{name}, #{teacherId}, #{className})</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">insert</span>&gt;</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 对于基本数据类型，#{}中可以使用任何变量名来指代参数，一般用value；而${}中只能用value --&gt;</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">delete</span><span class="ot"> id=</span><span class="st">&quot;deleteStudentById&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span>&gt;</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>        DELETE FROM student WHERE id=#{value}</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">delete</span>&gt;</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 可以使用if、where、foreach等标签动态生成sql --&gt;</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">update</span><span class="ot"> id=</span><span class="st">&quot;updateStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">if</span><span class="ot"> test=</span><span class="st">&quot;id!=null and id!=&#39;&#39;&quot;</span>&gt;</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>            UPDATE student set name=#{name},teacher_id=#{teacherId},class_name=#{className} WHERE id=#{id}</span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">if</span>&gt;</span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">update</span>&gt;</span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 返回值会自动封装到POJO中对应的属性，如果列不对应，需要给列起别名 --&gt;</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findStudentById&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>        SELECT id,name,teacher_id AS teacherId,class_name AS className FROM student WHERE id=#{value}</span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 别名可以封装成sql片段，然后通过include引入 --&gt;</span></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">sql</span><span class="ot"> id=</span><span class="st">&quot;student_info&quot;</span>&gt;</span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>        id,name,teacher_id AS teacherId,class_name AS className</span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">sql</span>&gt;</span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 返回list和返回POJO的resultType是一样的，只是接口处的定义不同 --&gt;</span></span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findAll&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a>        SELECT</span>
<span id="cb191-36"><a href="#cb191-36" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">include</span><span class="ot"> refid=</span><span class="st">&quot;student_info&quot;</span>/&gt;</span>
<span id="cb191-37"><a href="#cb191-37" aria-hidden="true" tabindex="-1"></a>        FROM student</span>
<span id="cb191-38"><a href="#cb191-38" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-39"><a href="#cb191-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-40"><a href="#cb191-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- ${}有注入问题，但#{}两边又不能加任何非空字符，这时就要用bind，_parameter是内置的变量，指传过来的的参数（类似的内置变量还有_databaseId，指通过全局配置文件中配置的databaseIdProvider） --&gt;</span></span>
<span id="cb191-41"><a href="#cb191-41" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findStudentLikeName&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;String&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-42"><a href="#cb191-42" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">bind</span><span class="ot"> name=</span><span class="st">&quot;m_name&quot;</span><span class="ot"> value=</span><span class="st">&quot;&#39;%&#39; + _parameter + &#39;%&#39;&quot;</span>/&gt;</span>
<span id="cb191-43"><a href="#cb191-43" aria-hidden="true" tabindex="-1"></a>        SELECT</span>
<span id="cb191-44"><a href="#cb191-44" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">include</span><span class="ot"> refid=</span><span class="st">&quot;student_info&quot;</span>/&gt;</span>
<span id="cb191-45"><a href="#cb191-45" aria-hidden="true" tabindex="-1"></a>        FROM student WHERE name LIKE #{m_name}</span>
<span id="cb191-46"><a href="#cb191-46" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-47"><a href="#cb191-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-48"><a href="#cb191-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-49"><a href="#cb191-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- collection表示映射到一个集合属性的成员变量中，这里的ofType是指集合的泛型，而非集合的类型 --&gt;</span></span>
<span id="cb191-50"><a href="#cb191-50" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">resultMap</span><span class="ot"> id=</span><span class="st">&quot;teachermap&quot;</span><span class="ot"> type=</span><span class="st">&quot;teacher&quot;</span>&gt;</span>
<span id="cb191-51"><a href="#cb191-51" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">id</span><span class="ot"> property=</span><span class="st">&quot;id&quot;</span><span class="ot"> column=</span><span class="st">&quot;id&quot;</span>/&gt;</span>
<span id="cb191-52"><a href="#cb191-52" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;name&quot;</span><span class="ot"> column=</span><span class="st">&quot;name&quot;</span>/&gt;</span>
<span id="cb191-53"><a href="#cb191-53" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;className&quot;</span><span class="ot"> column=</span><span class="st">&quot;class_name&quot;</span>/&gt;</span>
<span id="cb191-54"><a href="#cb191-54" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">collection</span><span class="ot"> property=</span><span class="st">&quot;students&quot;</span><span class="ot"> ofType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-55"><a href="#cb191-55" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">id</span><span class="ot"> property=</span><span class="st">&quot;id&quot;</span><span class="ot"> column=</span><span class="st">&quot;s_id&quot;</span>/&gt;</span>
<span id="cb191-56"><a href="#cb191-56" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;name&quot;</span><span class="ot"> column=</span><span class="st">&quot;s_name&quot;</span>/&gt;</span>
<span id="cb191-57"><a href="#cb191-57" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;teacherId&quot;</span><span class="ot"> column=</span><span class="st">&quot;s_tid&quot;</span>/&gt;</span>
<span id="cb191-58"><a href="#cb191-58" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;className&quot;</span><span class="ot"> column=</span><span class="st">&quot;s_classname&quot;</span>/&gt;</span>
<span id="cb191-59"><a href="#cb191-59" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">collection</span>&gt;</span>
<span id="cb191-60"><a href="#cb191-60" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">resultMap</span>&gt;</span>
<span id="cb191-61"><a href="#cb191-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-62"><a href="#cb191-62" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findAllTeacherAndStudent&quot;</span><span class="ot"> resultMap=</span><span class="st">&quot;teachermap&quot;</span>&gt;</span>
<span id="cb191-63"><a href="#cb191-63" aria-hidden="true" tabindex="-1"></a>        SELECT t.id,t.name,t.class_name,s.id as s_id,s.name as s_name,s.teacher_id as s_tid,s.class_name as s_classname FROM teacher t LEFT JOIN student s ON t.id=s.teacher_id</span>
<span id="cb191-64"><a href="#cb191-64" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-65"><a href="#cb191-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-66"><a href="#cb191-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-67"><a href="#cb191-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 根据teacherid查找teacher --&gt;</span></span>
<span id="cb191-68"><a href="#cb191-68" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findTeacherById&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;teacher&quot;</span>&gt;</span>
<span id="cb191-69"><a href="#cb191-69" aria-hidden="true" tabindex="-1"></a>        SELECT id,name,class_name AS className FROM teacher WHERE id=#{value}</span>
<span id="cb191-70"><a href="#cb191-70" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-71"><a href="#cb191-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-72"><a href="#cb191-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 这里的association指映射到属性为POJO类型的成员变量中，这里的javaType就是POJO的类型 --&gt;</span></span>
<span id="cb191-73"><a href="#cb191-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 通过association的select根据指定column执行子查询（如果不在当前命名空间中，需通过命名可见.id调用），然后把子查询的结果放到POJO的teacher属性中 --&gt;</span></span>
<span id="cb191-74"><a href="#cb191-74" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">resultMap</span><span class="ot"> id=</span><span class="st">&quot;studentMap&quot;</span><span class="ot"> type=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb191-75"><a href="#cb191-75" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">id</span><span class="ot"> property=</span><span class="st">&quot;id&quot;</span><span class="ot"> column=</span><span class="st">&quot;id&quot;</span>/&gt;</span>
<span id="cb191-76"><a href="#cb191-76" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;name&quot;</span><span class="ot"> column=</span><span class="st">&quot;name&quot;</span>/&gt;</span>
<span id="cb191-77"><a href="#cb191-77" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;teacherId&quot;</span><span class="ot"> column=</span><span class="st">&quot;teacher_id&quot;</span>/&gt;</span>
<span id="cb191-78"><a href="#cb191-78" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;className&quot;</span><span class="ot"> column=</span><span class="st">&quot;class_name&quot;</span>/&gt;</span>
<span id="cb191-79"><a href="#cb191-79" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">association</span><span class="ot"> property=</span><span class="st">&quot;teacher&quot;</span><span class="ot"> javaType=</span><span class="st">&quot;teacher&quot;</span><span class="ot"> select=</span><span class="st">&quot;findTeacherById&quot;</span><span class="ot"> column=</span><span class="st">&quot;teacher_id&quot;</span>/&gt;</span>
<span id="cb191-80"><a href="#cb191-80" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">resultMap</span>&gt;</span>
<span id="cb191-81"><a href="#cb191-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-82"><a href="#cb191-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- SELECT id,name,teacher_id,class_name from student where id in (1,2,4,6) --&gt;</span></span>
<span id="cb191-83"><a href="#cb191-83" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findTeacherByStudentIds&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span><span class="ot"> resultMap=</span><span class="st">&quot;studentMap&quot;</span>&gt;</span>
<span id="cb191-84"><a href="#cb191-84" aria-hidden="true" tabindex="-1"></a>        SELECT * FROM student WHERE id IN</span>
<span id="cb191-85"><a href="#cb191-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- collection的类型可以是array、list、map，，如果入参是一个集合，那么collection可以              等于任意名字，如果User有属性List ids，入参是User对象，那么这个collection = &quot;ids&quot;。如果User有属性Ids ids;其中Ids是个对象，Ids有个属性List id;入参是User对象，那么collection = &quot;ids.id&quot;</span></span>
<span id="cb191-86"><a href="#cb191-86" aria-hidden="true" tabindex="-1"></a><span class="co">可以通过index属性获取下标（如果是map，则获取的是key），用法和item属性类似 --&gt;</span></span>
<span id="cb191-87"><a href="#cb191-87" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">foreach</span><span class="ot"> collection=</span><span class="st">&quot;array&quot;</span><span class="ot"> open=</span><span class="st">&quot;(&quot;</span><span class="ot"> separator=</span><span class="st">&quot;,&quot;</span><span class="ot"> close=</span><span class="st">&quot;)&quot;</span><span class="ot"> item=</span><span class="st">&quot;id&quot;</span>&gt;</span>
<span id="cb191-88"><a href="#cb191-88" aria-hidden="true" tabindex="-1"></a>            #{id}</span>
<span id="cb191-89"><a href="#cb191-89" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">foreach</span>&gt;</span>
<span id="cb191-90"><a href="#cb191-90" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">select</span>&gt;</span>
<span id="cb191-91"><a href="#cb191-91" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mapper</span>&gt;</span></code></pre></div>
<h3 id="使用">使用</h3>
<div class="sourceCode" id="cb192"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="bu">InputStream</span> inputStream <span class="op">=</span> <span class="bu">Resources</span><span class="op">.</span><span class="fu">getResourceAsStream</span><span class="op">(</span><span class="st">&quot;mybatis-config.xml&quot;</span><span class="op">);</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>SqlSessionFactory factory <span class="op">=</span> <span class="kw">new</span> <span class="fu">SqlSessionFactoryBuilder</span><span class="op">().</span><span class="fu">build</span><span class="op">(</span>inputStream<span class="op">);</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>SqlSession session <span class="op">=</span> factory<span class="op">.</span><span class="fu">openSession</span><span class="op">();</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a><span class="co">//编写DAO时，通过session的方法调用xml中写好的sql，第一个参数为xml的命名空间+sql的id</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="co">//Student student = session.selectOne(&quot;dao.repository.StudentMapper.findStudentById&quot;, 1);</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a><span class="co">//也可以直接通过接口生成代理对象</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>StudentMapper studentMapper <span class="op">=</span> session<span class="op">.</span><span class="fu">getMapper</span><span class="op">(</span>StudentMapper<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>studentMapper<span class="op">.</span><span class="fu">insertStudent</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Student</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="st">&quot;小花&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;语文&quot;</span><span class="op">));</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">commit</span><span class="op">();</span><span class="co">//Mybatis默认关闭了自动提交，需要手动提交</span></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>studentMapper<span class="op">.</span><span class="fu">deleteStudentById</span><span class="op">(</span><span class="dv">4</span><span class="op">);</span></span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>studentMapper<span class="op">.</span><span class="fu">updateStudent</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Student</span><span class="op">(</span><span class="dv">3</span><span class="op">,</span> <span class="st">&quot;小红&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&quot;英语&quot;</span><span class="op">));</span></span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>studentMapper<span class="op">.</span><span class="fu">findStudentById</span><span class="op">(</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;------------------&quot;</span><span class="op">);</span></span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>Student student <span class="op">:</span> studentMapper<span class="op">.</span><span class="fu">findAll</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>student<span class="op">);</span></span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;------------------&quot;</span><span class="op">);</span></span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>Student student <span class="op">:</span> studentMapper<span class="op">.</span><span class="fu">findStudentLikeName</span><span class="op">(</span><span class="st">&quot;小&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>student<span class="op">);</span></span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;------------------&quot;</span><span class="op">);</span></span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>Teacher teacher <span class="op">:</span>studentMapper<span class="op">.</span><span class="fu">findAllTeacherAndStudent</span><span class="op">()){</span></span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>teacher<span class="op">);</span></span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>Student student <span class="op">:</span> teacher<span class="op">.</span><span class="fu">getStudents</span><span class="op">()){</span></span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span> <span class="op">+</span> student<span class="op">);</span></span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-39"><a href="#cb192-39" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;------------------&quot;</span><span class="op">);</span></span>
<span id="cb192-40"><a href="#cb192-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-41"><a href="#cb192-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>Student student <span class="op">:</span> studentMapper<span class="op">.</span><span class="fu">findTeacherByStudentIds</span><span class="op">(</span><span class="kw">new</span> <span class="dt">int</span><span class="op">[]{</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">6</span><span class="op">})){</span></span>
<span id="cb192-42"><a href="#cb192-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>student<span class="op">);</span></span>
<span id="cb192-43"><a href="#cb192-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span> <span class="op">+</span> student<span class="op">.</span><span class="fu">getTeacher</span><span class="op">());</span></span>
<span id="cb192-44"><a href="#cb192-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-45"><a href="#cb192-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-46"><a href="#cb192-46" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h3 id="其他">其他</h3>
<h4 id="where">where</h4>
<p>where和if配合使用可以自动删去不需要的AND</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">delete</span><span class="ot"> id=</span><span class="st">&quot;deleteStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    DELETE FROM student</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">where</span>&gt;</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">if</span><span class="ot"> test=</span><span class="st">&quot;_parameter.id!=null and _parameter.id!=&#39;&#39;&quot;</span>&gt;</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>            AND id=#{id}</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">if</span>&gt;</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">if</span><span class="ot"> test=</span><span class="st">&quot;_parameter.name!=null and _parameter.name!=&#39;&#39;&quot;</span>&gt;</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>            AND name=#{name}</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">if</span>&gt;</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">if</span><span class="ot"> test=</span><span class="st">&quot;_parameter.teacherId!=null and _parameter.teacherId!=&#39;&#39;&quot;</span>&gt;</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>            AND teacher_id=#{teacherId}</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">if</span>&gt;</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">if</span><span class="ot"> test=</span><span class="st">&quot;_parameter.className!=null and _parameter.className!=&#39;&#39;&quot;</span>&gt;</span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a>            AND class_name=#{className}</span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">if</span>&gt;</span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">where</span>&gt;</span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">delete</span>&gt;</span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>Student student <span class="op">=</span> <span class="kw">new</span> <span class="fu">Student</span><span class="op">();</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>student<span class="op">.</span><span class="fu">setName</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>student<span class="op">.</span><span class="fu">setClassName</span><span class="op">(</span><span class="st">&quot;英语&quot;</span><span class="op">);</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">delete</span><span class="op">(</span><span class="st">&quot;dao.repository.StudentMapper.deleteStudent&quot;</span><span class="op">,</span>student<span class="op">);</span></span></code></pre></div>
<p>生成的SQL</p>
<pre><code>==&gt;  Preparing: DELETE FROM student WHERE name=? AND class_name=? 
==&gt; Parameters: 小明(String), 英语(String)
&lt;==    Updates: 0</code></pre>
<h4 id="selectkey">selectKey</h4>
<p>有时在插入的时候希望获取插入数据的主键，又或者使用SQL的函数生成主键，这时可以使用<code>selectKey</code></p>
<p>主键返回</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">insert</span><span class="ot"> id=</span><span class="st">&quot;insertStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;dao.pojo.Student&quot;</span>&gt;</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 使用selectKey把主键返回，此时要求主键是 auto increment的 --&gt;</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">selectKey</span><span class="ot"> keyProperty=</span><span class="st">&quot;id&quot;</span><span class="ot"> order=</span><span class="st">&quot;AFTER&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;int&quot;</span>&gt;</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>        SELECT LAST_INSERT_ID()</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">selectKey</span>&gt;</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>    INSERT INTO student(name,teacher_id,class_name) VALUE(#{name}, #{teacherId}, #{className});</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">insert</span>&gt;</span></code></pre></div>
<p>UUID</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">insert</span><span class="ot"> id=</span><span class="st">&quot;insertStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;dao.pojo.Student&quot;</span>&gt;</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 使用selectKey通过SQL中的uuid函数生成主键，并放到student.id中（此时student.id应为String类型） --&gt;</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">selectKey</span><span class="ot"> keyProperty=</span><span class="st">&quot;id&quot;</span><span class="ot"> order=</span><span class="st">&quot;BEFORE&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;String&quot;</span>&gt;</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>        SELECT uuid()</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">selectKey</span>&gt;</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    INSERT INTO student(id,name,teacher_id,class_name) VALUE(#{id}, #{name}, #{teacherId}, #{className});</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">insert</span>&gt;</span></code></pre></div>
<h4 id="懒加载">懒加载</h4>
<p>子查询可以使用懒加载</p>
<p>在全局配置文件中开启</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 开启懒加载配置 --&gt;</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">settings</span>&gt;</span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 全局性设置懒加载。如果设为‘false&#39;，则所有相关联的都会被初始化加载。 --&gt;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">setting</span><span class="ot"> name=</span><span class="st">&quot;lazyLoadingEnabled&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 当设置为‘true&#39;的时候，懒加载的对象可能被任何懒属性全部加载。否则，每个属性都按需加载。 --&gt;</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">setting</span><span class="ot"> name=</span><span class="st">&quot;aggressiveLazyLoading&quot;</span><span class="ot"> value=</span><span class="st">&quot;false&quot;</span>/&gt;</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">settings</span>&gt;</span></code></pre></div>
<p>在<code>resultMap</code>的<code>association</code>或<code>collection</code>中使用select执行子查询（就是上面多对一的例子，代码没有变）时就可以实现懒加载</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 根据teacherid查找teacher --&gt;</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findTeacherById&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;teacher&quot;</span>&gt;</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>    SELECT id,name,class_name AS className FROM teacher WHERE id=#{value}</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">select</span>&gt;</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 通过association的select根据指定column执行子查询，然后把子查询的结果放到POJO的teacher属性中 --&gt;</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">resultMap</span><span class="ot"> id=</span><span class="st">&quot;studentMap&quot;</span><span class="ot"> type=</span><span class="st">&quot;student&quot;</span>&gt;</span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">id</span><span class="ot"> property=</span><span class="st">&quot;id&quot;</span><span class="ot"> column=</span><span class="st">&quot;id&quot;</span>/&gt;</span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;name&quot;</span><span class="ot"> column=</span><span class="st">&quot;name&quot;</span>/&gt;</span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;teacherId&quot;</span><span class="ot"> column=</span><span class="st">&quot;teacher_id&quot;</span>/&gt;</span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">result</span><span class="ot"> property=</span><span class="st">&quot;className&quot;</span><span class="ot"> column=</span><span class="st">&quot;class_name&quot;</span>/&gt;</span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">association</span><span class="ot"> property=</span><span class="st">&quot;teacher&quot;</span><span class="ot"> javaType=</span><span class="st">&quot;teacher&quot;</span><span class="ot"> select=</span><span class="st">&quot;findTeacherById&quot;</span><span class="ot"> column=</span><span class="st">&quot;teacher_id&quot;</span>/&gt;</span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">resultMap</span>&gt;</span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- SELECT id,name,teacher_id,class_name from student where id in (1,2,4,6) --&gt;</span></span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">select</span><span class="ot"> id=</span><span class="st">&quot;findTeacherByStudentIds&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;int&quot;</span><span class="ot"> resultMap=</span><span class="st">&quot;studentMap&quot;</span>&gt;</span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>    SELECT * FROM student WHERE id IN</span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">foreach</span><span class="ot"> collection=</span><span class="st">&quot;array&quot;</span><span class="ot"> open=</span><span class="st">&quot;(&quot;</span><span class="ot"> separator=</span><span class="st">&quot;,&quot;</span><span class="ot"> close=</span><span class="st">&quot;)&quot;</span><span class="ot"> item=</span><span class="st">&quot;id&quot;</span>&gt;</span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>        #{id}</span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">foreach</span>&gt;</span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">select</span>&gt;</span></code></pre></div>
<h4 id="缓存">缓存</h4>
<p>一级缓存默认是开启的，一级缓存就是每个sqlSession的缓存，使用同一个sqlSession多次查询，第一次会查询数据库，以后如果没有执行过任何修改数据库的操作（DML操作:
insert、update、delete），就会从缓存中取，不会再查询数据库</p>
<p>二级缓存是sqlSession之间共享的缓存，一个namespace共用一个缓存，二级缓存默认没有开启，需要手动开启</p>
<p>全局配置文件：</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">settings</span>&gt;</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 默认是false的，表示关闭二级缓存 --&gt;</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">setting</span><span class="ot"> name=</span><span class="st">&quot;cacheEnabled&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">settings</span>&gt;</span></code></pre></div>
<p>Mapper.xml</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 为当前Mapper开启二级缓存：</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="co">使用LRU缓存，并每隔60秒刷新，最大存储512个对象，而却返回的对象是只读的 --&gt;</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">cache</span><span class="ot"> eviction=</span><span class="st">&quot;LRU&quot;</span><span class="ot"> flushInterval=</span><span class="st">&quot;60000&quot;</span><span class="ot"> size=</span><span class="st">&quot;512&quot;</span><span class="ot"> readOnly=</span><span class="st">&quot;true&quot;</span>/&gt;</span></code></pre></div>
<p>如果单个语句需要禁用缓存，使用<code>useCache=&quot;false&quot;</code></p>
<div class="sourceCode" id="cb202"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">insert</span><span class="ot"> id=</span><span class="st">&quot;insertStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;dao.pojo.Student&quot;</span><span class="ot"> useCache=</span><span class="st">&quot;false&quot;</span>&gt;</span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>    INSERT INTO student(id,name,teacher_id,class_name) VALUE(#{id}, #{name}, #{teacherId}, #{className});</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">insert</span>&gt;</span></code></pre></div>
<p>一级和二级缓存同时开启时，先从一级缓存中找，如果没有再从二级缓存中找</p>
<h4 id="禁用预编译">禁用预编译</h4>
<p>使用<code>statementType=&quot;STATEMENT&quot;</code>禁用预编译，此时只能使用<code>${}</code>，不能再使用<code>#{}</code>（<code>statementType</code>默认为<code>PREPARED</code>，即使用预编译）</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">insert</span><span class="ot"> id=</span><span class="st">&quot;insertStudent&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;dao.pojo.Student&quot;</span><span class="ot"> statementType=</span><span class="st">&quot;STATEMENT&quot;</span>&gt;</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>    INSERT INTO student(id,name,teacher_id,class_name) VALUE(${id}, ${name}, ${teacherId}, ${className});</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">insert</span>&gt;</span></code></pre></div>
<h3 id="注解开发">注解开发</h3>
<p>不需要在为mapper.java写mapper.xml了，这时mapper.xml可以去掉；如果和spring整合，全局配置文件也可以去掉</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StudentMapper <span class="op">{</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//插入</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Insert</span><span class="op">(</span><span class="st">&quot;INSERT INTO student(id,name,teacher_id,class_name) VALUE(#{id}, #{name}, #{teacherId}, #{className})&quot;</span><span class="op">)</span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">insertStudent</span><span class="op">(</span>Student student<span class="op">);</span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//删除</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Delete</span><span class="op">(</span><span class="st">&quot;DELETE FROM student WHERE id=#{value}&quot;</span><span class="op">)</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteStudentById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">);</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//更新</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Update</span><span class="op">(</span><span class="st">&quot;UPDATE student set name=#{name},teacher_id=#{teacherId},class_name=#{className} WHERE id=#{id}&quot;</span><span class="op">)</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">updateStudent</span><span class="op">(</span>Student student<span class="op">);</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对一：根据id查学生</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot; SELECT * FROM student WHERE id=#{value}&quot;</span><span class="op">)</span></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Results</span><span class="op">(</span>id <span class="op">=</span> <span class="st">&quot;studentmap&quot;</span><span class="op">,</span> value <span class="op">=</span> <span class="op">{</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">),</span></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">),</span></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;teacherId&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;teacher_id&quot;</span><span class="op">),</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;className&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;class_name&quot;</span><span class="op">)</span></span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a>    Student <span class="fu">findStudentById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">);</span></span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对多：查询所有学生</span></span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;SELECT id,name,teacher_id AS teacherId,class_name AS className FROM student&quot;</span><span class="op">)</span></span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">();</span></span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">//模糊查询，这里要使用SQL的拼接函数进行拼接</span></span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;SELECT * FROM student WHERE name LIKE CONCAT(CONCAT(&#39;%&#39;, #{_parameter} ),&#39;%&#39;)&quot;</span><span class="op">)</span></span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResultMap</span><span class="op">(</span><span class="st">&quot;studentmap&quot;</span><span class="op">)</span></span>
<span id="cb204-32"><a href="#cb204-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findStudentLikeName</span><span class="op">(</span><span class="bu">String</span> studentName<span class="op">);</span></span>
<span id="cb204-33"><a href="#cb204-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-34"><a href="#cb204-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-35"><a href="#cb204-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一对多：查找所有老师和学生的对应关系</span></span>
<span id="cb204-36"><a href="#cb204-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">//many相当于xml中的collection，fetchType指定是否懒加载</span></span>
<span id="cb204-37"><a href="#cb204-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;SELECT id,name,class_name FROM teacher&quot;</span><span class="op">)</span></span>
<span id="cb204-38"><a href="#cb204-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Results</span><span class="op">({</span></span>
<span id="cb204-39"><a href="#cb204-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> id <span class="op">=</span> <span class="kw">true</span><span class="op">),</span></span>
<span id="cb204-40"><a href="#cb204-40" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">),</span></span>
<span id="cb204-41"><a href="#cb204-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;className&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;class_name&quot;</span><span class="op">),</span></span>
<span id="cb204-42"><a href="#cb204-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;students&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> many <span class="op">=</span> <span class="at">@Many</span><span class="op">(</span>select <span class="op">=</span> <span class="st">&quot;dao.repository.StudentMapper.findStudentByTeacherId&quot;</span><span class="op">,</span> fetchType <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">))</span></span>
<span id="cb204-43"><a href="#cb204-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb204-44"><a href="#cb204-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Teacher<span class="op">&gt;</span> <span class="fu">findAllTeacherAndStudent</span><span class="op">();</span></span>
<span id="cb204-45"><a href="#cb204-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-46"><a href="#cb204-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">//根据老师id找学生</span></span>
<span id="cb204-47"><a href="#cb204-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;SELECT id,name,teacher_id AS teacherId,class_name AS className FROM student WHERE teacher_id=#{value}&quot;</span><span class="op">)</span></span>
<span id="cb204-48"><a href="#cb204-48" aria-hidden="true" tabindex="-1"></a>    Student <span class="fu">findStudentByTeacherId</span><span class="op">(</span><span class="dt">int</span> teacherId<span class="op">);</span></span>
<span id="cb204-49"><a href="#cb204-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-50"><a href="#cb204-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-51"><a href="#cb204-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">//多对一：根据指定的学生id查找老师并放在student的teacher属性中</span></span>
<span id="cb204-52"><a href="#cb204-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">//one相当于xml中的association</span></span>
<span id="cb204-53"><a href="#cb204-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;&lt;script&gt;&quot;</span></span>
<span id="cb204-54"><a href="#cb204-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> <span class="st">&quot;SELECT * FROM student WHERE id IN&quot;</span> <span class="op">+</span></span>
<span id="cb204-55"><a href="#cb204-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;&lt;foreach collection=&#39;array&#39; open=&#39;(&#39; separator=&#39;,&#39; close=&#39;)&#39; item=&#39;id&#39;&gt;&quot;</span> <span class="op">+</span></span>
<span id="cb204-56"><a href="#cb204-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;#{id}&quot;</span> <span class="op">+</span></span>
<span id="cb204-57"><a href="#cb204-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;&lt;/foreach&gt;&quot;</span></span>
<span id="cb204-58"><a href="#cb204-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span> <span class="st">&quot;&lt;/script&gt;&quot;</span><span class="op">)</span></span>
<span id="cb204-59"><a href="#cb204-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Results</span><span class="op">(</span>value <span class="op">=</span> <span class="op">{</span></span>
<span id="cb204-60"><a href="#cb204-60" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">),</span></span>
<span id="cb204-61"><a href="#cb204-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">),</span></span>
<span id="cb204-62"><a href="#cb204-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;teacherId&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;teacher_id&quot;</span><span class="op">),</span></span>
<span id="cb204-63"><a href="#cb204-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;className&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;class_name&quot;</span><span class="op">),</span></span>
<span id="cb204-64"><a href="#cb204-64" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Result</span><span class="op">(</span>property <span class="op">=</span> <span class="st">&quot;teacher&quot;</span><span class="op">,</span> column <span class="op">=</span> <span class="st">&quot;teacher_id&quot;</span><span class="op">,</span> one <span class="op">=</span> <span class="at">@One</span><span class="op">(</span>select <span class="op">=</span> <span class="st">&quot;dao.repository.StudentMapper.findTeacherById&quot;</span><span class="op">,</span> fetchType <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">EAGER</span><span class="op">))</span></span>
<span id="cb204-65"><a href="#cb204-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb204-66"><a href="#cb204-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Student<span class="op">&gt;</span> <span class="fu">findTeacherByStudentIds</span><span class="op">(</span><span class="dt">int</span><span class="op">[]</span> studentId<span class="op">);</span></span>
<span id="cb204-67"><a href="#cb204-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-68"><a href="#cb204-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Select</span><span class="op">(</span><span class="st">&quot;SELECT id,name,class_name AS className FROM teacher WHERE id=#{value}&quot;</span><span class="op">)</span></span>
<span id="cb204-69"><a href="#cb204-69" aria-hidden="true" tabindex="-1"></a>    Teacher <span class="fu">findTeacherById</span><span class="op">(</span><span class="dt">int</span> teacherId<span class="op">);</span></span>
<span id="cb204-70"><a href="#cb204-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这时全局配置文件通过class属性加载mapper</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>mappers<span class="op">&gt;</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>mapper <span class="kw">class</span><span class="op">=</span><span class="st">&quot;dao.repository.StudentMapper&quot;</span><span class="op">/&gt;</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>mappers<span class="op">&gt;</span></span></code></pre></div>
<p>用法和以前是一样的</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="bu">InputStream</span> inputStream <span class="op">=</span> <span class="bu">Resources</span><span class="op">.</span><span class="fu">getResourceAsStream</span><span class="op">(</span><span class="st">&quot;mybatis-config.xml&quot;</span><span class="op">);</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>SqlSessionFactory factory <span class="op">=</span> <span class="kw">new</span> <span class="fu">SqlSessionFactoryBuilder</span><span class="op">().</span><span class="fu">build</span><span class="op">(</span>inputStream<span class="op">);</span></span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>SqlSession session <span class="op">=</span> factory<span class="op">.</span><span class="fu">openSession</span><span class="op">();</span></span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>StudentMapper studentMapper <span class="op">=</span> session<span class="op">.</span><span class="fu">getMapper</span><span class="op">(</span>StudentMapper<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>studentMapper<span class="op">.</span><span class="fu">insertStudent</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Student</span><span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="st">&quot;小花&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&quot;语文&quot;</span><span class="op">));</span></span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>session<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h3 id="spring整合">Spring整合</h3>
<p>maven依赖</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.mybatis&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;mybatis&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;3.4.6&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.mybatis&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;mybatis-spring&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.3.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<p>配置applicationContext.xml：</p>
<p><strong>使用Mybatis全局配置文件</strong></p>
<div class="sourceCode" id="cb208"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;sqlSessionFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 数据库连接池 --&gt;</span></span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> ref=</span><span class="st">&quot;dataSource&quot;</span> /&gt;</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 加载mybatis的全局配置文件 --&gt;</span></span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;configLocation&quot;</span><span class="ot"> value=</span><span class="st">&quot;classpath:mybatis/mybatis-config.xml&quot;</span> /&gt;</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span></code></pre></div>
<p><strong>去掉Mybatis全局配置文件</strong></p>
<div class="sourceCode" id="cb209"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;sqlSessionFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- dataSource --&gt;</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> ref=</span><span class="st">&quot;datasource&quot;</span> /&gt;</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 别名，单个包用value属性，多个注入array数组 --&gt;</span></span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;typeAliasesPackage&quot;</span><span class="ot"> value=</span><span class="st">&quot;dao.pojo&quot;</span> /&gt;</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- XXXMapper.xml --&gt;</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 如果xxxMapper.java和xxxMapper.xml在同一包下可以不配置，但此时需要配置maven不过滤xml文件</span></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath*:dao/mappers/*Mapper.xml&quot; /&gt; --&gt;</span></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span>
<span id="cb209-12"><a href="#cb209-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--指定会话工厂，如果当前上下文中只定义了一个则该属性可省去 --&gt;</span></span>
<span id="cb209-13"><a href="#cb209-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sqlSessionFactoryBeanName&quot;</span><span class="ot"> value=</span><span class="st">&quot;sqlSessionFactory&quot;</span> /&gt;</span>
<span id="cb209-14"><a href="#cb209-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- XXXMapper.java --&gt;</span></span>
<span id="cb209-15"><a href="#cb209-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;basePackage&quot;</span><span class="ot"> value=</span><span class="st">&quot;dao.mappers&quot;</span> /&gt;</span>
<span id="cb209-16"><a href="#cb209-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- &lt;property name=&quot;mapperInterface&quot; value=&quot;dao.mappers.UserMapper&quot; /&gt; --&gt;</span></span>
<span id="cb209-17"><a href="#cb209-17" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb209-18"><a href="#cb209-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-19"><a href="#cb209-19" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 不使用扫描的方式</span></span>
<span id="cb209-20"><a href="#cb209-20" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;bean id=&quot;userMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</span></span>
<span id="cb209-21"><a href="#cb209-21" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;property name=&quot;mapperInterface&quot; value=&quot;dao.mappers.UserMapper&quot; /&gt;</span></span>
<span id="cb209-22"><a href="#cb209-22" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot; /&gt;</span></span>
<span id="cb209-23"><a href="#cb209-23" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;/bean&gt;</span></span>
<span id="cb209-24"><a href="#cb209-24" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span></code></pre></div>
<h2 id="spring-data-jpa">Spring Data JPA</h2>
<p><a href="https://docs.spring.io/spring-data/jpa/docs/2.1.1.RELEASE/reference/html/">文档</a></p>
<p>项目结构</p>
<pre><code>├── main
│   ├── java
│   │   └── com
│   │       └── myapp
│   │           ├── config
│   │           │   └── MySQL8InnoDBUTF8Dialect.java
│   │           ├── controller
│   │           ├── dao
│   │           │   ├── model
│   │           │   │   └── User.java
│   │           │   └── UserDao.java
│   │           └── service
│   │               └── UserService.java
│   └── resources
│       └── applicationContext.xml
└── test
    └── java
        └── UserTest.java</code></pre>
<h3 id="初始化数据库">初始化数据库</h3>
<p>建表</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> <span class="fu">User</span>(</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="kw">id</span> <span class="dt">INT</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">NOT</span> <span class="kw">NULL</span> AUTO_INCREMENT,</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>name <span class="dt">VARCHAR</span>(<span class="dv">32</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="kw">role</span> <span class="dt">VARCHAR</span>(<span class="dv">6</span>)</span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>)<span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8;</span></code></pre></div>
<p>插入测试数据</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> <span class="fu">User</span> <span class="kw">VALUES</span></span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span>, <span class="st">&#39;小明&#39;</span>, <span class="st">&#39;normal&#39;</span>),</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>(<span class="dv">2</span>, <span class="st">&#39;小红&#39;</span>, <span class="st">&#39;normal&#39;</span>),</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>(<span class="dv">3</span>, <span class="st">&#39;小王&#39;</span>, <span class="st">&#39;admin&#39;</span>);</span></code></pre></div>
<h3 id="pom.xml-1">pom.xml</h3>
<div class="sourceCode" id="cb213"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">project</span><span class="ot"> xmlns=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a><span class="ot">         xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a><span class="ot">         xsi:schemaLocation=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">modelVersion</span>&gt;4.0.0&lt;/<span class="kw">modelVersion</span>&gt;</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;myapp&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;springdatajpatest&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.0-SNAPSHOT&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- spring-data-jpa --&gt;</span></span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.springframework.data&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;spring-data-jpa&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-16"><a href="#cb213-16" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;2.1.1.RELEASE&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-17"><a href="#cb213-17" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb213-18"><a href="#cb213-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-19"><a href="#cb213-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 配置hibernate的实体管理依赖--&gt;</span></span>
<span id="cb213-20"><a href="#cb213-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb213-21"><a href="#cb213-21" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.hibernate&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-22"><a href="#cb213-22" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;hibernate-entitymanager&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-23"><a href="#cb213-23" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;5.3.7.Final&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-24"><a href="#cb213-24" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb213-25"><a href="#cb213-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 在JAVA9以上版本使用hibernate需要导入jaxb依赖 --&gt;</span></span>
<span id="cb213-26"><a href="#cb213-26" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb213-27"><a href="#cb213-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;javax.xml.bind&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-28"><a href="#cb213-28" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;jaxb-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-29"><a href="#cb213-29" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;2.3.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-30"><a href="#cb213-30" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb213-31"><a href="#cb213-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- jdbc连接驱动 --&gt;</span></span>
<span id="cb213-32"><a href="#cb213-32" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb213-33"><a href="#cb213-33" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;mysql&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-34"><a href="#cb213-34" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;mysql-connector-java&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-35"><a href="#cb213-35" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;8.0.13&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-36"><a href="#cb213-36" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb213-37"><a href="#cb213-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- junit --&gt;</span></span>
<span id="cb213-38"><a href="#cb213-38" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb213-39"><a href="#cb213-39" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;junit&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb213-40"><a href="#cb213-40" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;junit&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb213-41"><a href="#cb213-41" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;4.12&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb213-42"><a href="#cb213-42" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">scope</span>&gt;test&lt;/<span class="kw">scope</span>&gt;</span>
<span id="cb213-43"><a href="#cb213-43" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb213-44"><a href="#cb213-44" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependencies</span>&gt;</span>
<span id="cb213-45"><a href="#cb213-45" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">project</span>&gt;</span></code></pre></div>
<h3 id="快速入门">快速入门</h3>
<h4 id="实体类">实体类</h4>
<div class="sourceCode" id="cb214"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Table</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;User&quot;</span><span class="op">)</span><span class="co">//可以指定表名，默认表名就是实体类的类名</span></span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//需要使用Integer而不是int</span></span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//除了id以外，所有的column都会按照字母顺序创建，而不是按定义的顺序</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>length <span class="op">=</span> <span class="dv">32</span><span class="op">,</span> nullable <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;role&quot;</span><span class="op">,</span> length <span class="op">=</span> <span class="dv">6</span><span class="op">)</span><span class="co">//指定列名，默认为字段名</span></span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> role<span class="op">;</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">//省略空构造器及get、set、toString（注意toString不要输出集合类型，否则在双向包含的情况下或出现递归）</span></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="dao接口">DAO接口</h4>
<p>接口编写有两种方式，要么用<code>@RepositoryDefinition</code>注解，要么用继承自<code>Repository</code>，使用这两种方式编写的接口Spring
data JPA才会动态代理生成实现类的字节码</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="co">//@RepositoryDefinition(domainClass = User.class ,idClass = Integer.class)</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="co">//两个泛型分别是要操作的实体Bean和主键类型</span></span>
<span id="cb215-3"><a href="#cb215-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserDao <span class="kw">extends</span> Repository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb215-4"><a href="#cb215-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-5"><a href="#cb215-5" aria-hidden="true" tabindex="-1"></a>    User <span class="fu">findByName</span><span class="op">(</span><span class="bu">String</span> name<span class="op">);</span></span>
<span id="cb215-6"><a href="#cb215-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-7"><a href="#cb215-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findByRoleLike</span><span class="op">(</span><span class="bu">String</span> role<span class="op">);</span></span>
<span id="cb215-8"><a href="#cb215-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="service层">Service层</h4>
<p>Spring Data JPA会自动生成接口的实现类，我们只需直接调用即可</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserService <span class="op">{</span></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>    UserDao userDao<span class="op">;</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">getUserByName</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userDao<span class="op">.</span><span class="fu">findByName</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">getUserByRoleLike</span><span class="op">(</span><span class="bu">String</span> role<span class="op">){</span></span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userDao<span class="op">.</span><span class="fu">findByRoleLike</span><span class="op">(</span>role<span class="op">);</span></span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb216-13"><a href="#cb216-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="applicationcontext.xml">applicationContext.xml</h4>
<div class="sourceCode" id="cb217"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span> <span class="fu">?&gt;</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:jpa=</span><span class="st">&quot;http://www.springframework.org/schema/data/jpa&quot;</span></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:tx=</span><span class="st">&quot;http://www.springframework.org/schema/tx&quot;</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans</span></span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/data/jpa</span></span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/data/jpa/spring-jpa.xsd</span></span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/tx</span></span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/tx/spring-tx.xsd</span></span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/context</span></span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a><span class="st">           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置数据源--&gt;</span></span>
<span id="cb217-17"><a href="#cb217-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span>
<span id="cb217-18"><a href="#cb217-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;url&quot;</span><span class="ot"> value=</span><span class="st">&quot;jdbc:mysql:///webapp?useUnicode=true</span><span class="dv">&amp;amp;</span><span class="st">characterEncoding=UTF-8&quot;</span>/&gt;</span>
<span id="cb217-19"><a href="#cb217-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;username&quot;</span><span class="ot"> value=</span><span class="st">&quot;root&quot;</span>/&gt;</span>
<span id="cb217-20"><a href="#cb217-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span><span class="ot"> value=</span><span class="st">&quot;123456&quot;</span>/&gt;</span>
<span id="cb217-21"><a href="#cb217-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;driverClassName&quot;</span><span class="ot"> value=</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span>
<span id="cb217-22"><a href="#cb217-22" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb217-23"><a href="#cb217-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置entityManagerFactory 用于管理实体的一些配置--&gt;</span></span>
<span id="cb217-24"><a href="#cb217-24" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;entityManagerFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span>&gt;</span>
<span id="cb217-25"><a href="#cb217-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dataSource&quot;</span><span class="ot"> ref=</span><span class="st">&quot;dataSource&quot;</span>/&gt;</span>
<span id="cb217-26"><a href="#cb217-26" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;jpaVendorAdapter&quot;</span>&gt;</span>
<span id="cb217-27"><a href="#cb217-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span>/&gt;</span>
<span id="cb217-28"><a href="#cb217-28" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb217-29"><a href="#cb217-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- dao包，如果写实体类所在的包，会报错 --&gt;</span></span>
<span id="cb217-30"><a href="#cb217-30" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;packagesToScan&quot;</span><span class="ot"> value=</span><span class="st">&quot;com.myapp.dao&quot;</span>/&gt;</span>
<span id="cb217-31"><a href="#cb217-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;jpaProperties&quot;</span>&gt;</span>
<span id="cb217-32"><a href="#cb217-32" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">props</span>&gt;</span>
<span id="cb217-33"><a href="#cb217-33" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;hibernate.ejb.naming_strategy&quot;</span>&gt;org.hibernate.cfg.ImprovedNamingStrategy&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb217-34"><a href="#cb217-34" aria-hidden="true" tabindex="-1"></a>                <span class="co">&lt;!-- 指定方言为MySQL</span></span>
<span id="cb217-35"><a href="#cb217-35" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;prop key=&quot;hibernate.dialect&quot;&gt;org.hibernate.dialect.MySQL8Dialect&lt;/prop&gt; --&gt;</span></span>
<span id="cb217-36"><a href="#cb217-36" aria-hidden="true" tabindex="-1"></a>                <span class="co">&lt;!-- 由于我们要使用UTF8编码，所以要使用自定义的Dialect --&gt;</span></span>
<span id="cb217-37"><a href="#cb217-37" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;hibernate.dialect&quot;</span>&gt;com.myapp.config.MySQL8InnoDBUTF8Dialect&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb217-38"><a href="#cb217-38" aria-hidden="true" tabindex="-1"></a>                <span class="co">&lt;!-- 显示生成的SQL --&gt;</span></span>
<span id="cb217-39"><a href="#cb217-39" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;hibernate.show_sql&quot;</span>&gt;true&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb217-40"><a href="#cb217-40" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;hibernate.format_sql&quot;</span>&gt;true&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb217-41"><a href="#cb217-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">&lt;!--配置是否实体自动生成数据表--&gt;</span></span>
<span id="cb217-42"><a href="#cb217-42" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">prop</span><span class="ot"> key=</span><span class="st">&quot;hibernate.hbm2ddl.auto&quot;</span>&gt;update&lt;/<span class="kw">prop</span>&gt;</span>
<span id="cb217-43"><a href="#cb217-43" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">props</span>&gt;</span>
<span id="cb217-44"><a href="#cb217-44" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb217-45"><a href="#cb217-45" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb217-46"><a href="#cb217-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置事务管理器--&gt;</span></span>
<span id="cb217-47"><a href="#cb217-47" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;transactionManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>&gt;</span>
<span id="cb217-48"><a href="#cb217-48" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;entityManagerFactory&quot;</span><span class="ot"> ref=</span><span class="st">&quot;entityManagerFactory&quot;</span>/&gt;</span>
<span id="cb217-49"><a href="#cb217-49" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb217-50"><a href="#cb217-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置支持事务注解--&gt;</span></span>
<span id="cb217-51"><a href="#cb217-51" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tx:annotation-driven</span><span class="ot"> transaction-manager=</span><span class="st">&quot;transactionManager&quot;</span>/&gt;</span>
<span id="cb217-52"><a href="#cb217-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置spring data--&gt;</span></span>
<span id="cb217-53"><a href="#cb217-53" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">jpa:repositories</span><span class="ot"> base-package=</span><span class="st">&quot;com.myapp.dao&quot;</span><span class="ot"> entity-manager-factory-ref=</span><span class="st">&quot;entityManagerFactory&quot;</span>/&gt;</span>
<span id="cb217-54"><a href="#cb217-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--配置spring的扫描包--&gt;</span></span>
<span id="cb217-55"><a href="#cb217-55" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;com.myapp&quot;</span>/&gt;</span>
<span id="cb217-56"><a href="#cb217-56" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p>自定义方言类MySQL8InnoDBUTF8Dialect.java</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MySQL8InnoDBUTF8Dialect <span class="kw">extends</span> MySQL8Dialect <span class="op">{</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//使用InnoDB引擎以及UTF8编码</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getTableTypeString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot; ENGINE=InnoDB DEFAULT CHARSET=utf8&quot;</span><span class="op">;</span></span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="单元测试">单元测试</h4>
<div class="sourceCode" id="cb219"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserTest <span class="op">{</span></span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ApplicationContext context <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserService userService<span class="op">;</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Before</span></span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">getContext</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a>        userService <span class="op">=</span> context<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span>UserService<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-11"><a href="#cb219-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb219-12"><a href="#cb219-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testUser</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb219-13"><a href="#cb219-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userService<span class="op">.</span><span class="fu">getUserByName</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">));</span></span>
<span id="cb219-14"><a href="#cb219-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//这里仍然要写百分号，否则无法模糊查询</span></span>
<span id="cb219-15"><a href="#cb219-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>userService<span class="op">.</span><span class="fu">getUserByRoleLike</span><span class="op">(</span><span class="st">&quot;%nor%&quot;</span><span class="op">));</span></span>
<span id="cb219-16"><a href="#cb219-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb219-17"><a href="#cb219-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="dao接口函数命名规范">DAO接口函数命名规范</h3>
<p>DAO接口的函数是有命名规范的，Spring Data
JPA按照这些命名规则生成对应的SQL，执行我们想要执行的操作</p>
<table style="width:100%;">
<colgroup>
<col style="width: 23%" />
<col style="width: 41%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>函数命名关键字</th>
<th>示例</th>
<th>对应的 where条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>And</td>
<td>findByNameAndPwd</td>
<td>where name= ? and pwd =?</td>
</tr>
<tr>
<td>Or</td>
<td>findByNameOrSex</td>
<td>where name= ? or sex=?</td>
</tr>
<tr>
<td>Is,Equals</td>
<td>findById,findByIdEquals</td>
<td>where id= ?</td>
</tr>
<tr>
<td>Between</td>
<td>findByIdBetween</td>
<td>where id between ? and ?</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByIdLessThan</td>
<td>where id &lt; ?</td>
</tr>
<tr>
<td>LessThanEquals</td>
<td>findByIdLessThanEquals</td>
<td>where id &lt;= ?</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByIdGreaterThan</td>
<td>where id &gt; ?</td>
</tr>
<tr>
<td>GreaterThanEquals</td>
<td>findByIdGreaterThanEquals</td>
<td>where id &gt; = ?</td>
</tr>
<tr>
<td>After</td>
<td>findByIdAfter</td>
<td>where id &gt; ?</td>
</tr>
<tr>
<td>Before</td>
<td>findByIdBefore</td>
<td>where id &lt; ?</td>
</tr>
<tr>
<td>IsNull</td>
<td>findByNameIsNull</td>
<td>where name is null</td>
</tr>
<tr>
<td>isNotNull,NotNull</td>
<td>findByNameNotNull</td>
<td>where name is not null</td>
</tr>
<tr>
<td>Like</td>
<td>findByNameLike</td>
<td>where name like ?</td>
</tr>
<tr>
<td>NotLike</td>
<td>findByNameNotLike</td>
<td>where name not like ?</td>
</tr>
<tr>
<td>StartingWith</td>
<td>findByNameStartingWith</td>
<td>where name like ‘?%’</td>
</tr>
<tr>
<td>EndingWith</td>
<td>findByNameEndingWith</td>
<td>where name like ‘%?’</td>
</tr>
<tr>
<td>Containing</td>
<td>findByNameContaining</td>
<td>where name like ‘%?%’</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByIdOrderByXDesc</td>
<td>where id=? order by x desc</td>
</tr>
<tr>
<td>Not</td>
<td>findByNameNot</td>
<td>where name &lt;&gt; ?</td>
</tr>
<tr>
<td>In</td>
<td>findByIdIn(Collection&lt;?&gt; c)</td>
<td>where id in (?)</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByIdNotIn(Collection&lt;?&gt; c)</td>
<td>where id not in (?)</td>
</tr>
<tr>
<td>True</td>
<td>findByAaaTue</td>
<td>where aaa = true</td>
</tr>
<tr>
<td>False</td>
<td>findByAaaFalse</td>
<td>where aaa = false</td>
</tr>
<tr>
<td>IgnoreCase</td>
<td>findByNameIgnoreCase</td>
<td>where UPPER(name)=UPPER(?)</td>
</tr>
</tbody>
</table>
<h3 id="自定义sql">自定义SQL</h3>
<p>上面那么多的命名规范很难记住，所以Spring Data
JPA允许我们不按照规范命名，而是我们自己指定要执行的SQL，注意默认<code>@Query</code>写的是JPQL（使用实体类的类名代替表名，实体类的属性名代替列名，和HQL差不多）而不是SQL，不过可以通过<code>nativeQuery=true</code>指定执行SQL</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co">//&quot;?1&quot;表示函数的第一个参数，&quot;?2&quot;表示函数的第二个参数，以此类推</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span><span class="st">&quot;select u from User u where u.name like %?1%&quot;</span><span class="op">)</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findUserLike1</span><span class="op">(</span><span class="bu">String</span> name<span class="op">);</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a><span class="co">//支持hibernate中给参数起名字的语法</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span><span class="st">&quot;select u from User u where u.name like %:name%&quot;</span><span class="op">)</span></span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">findUserLike2</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">)</span> <span class="bu">String</span> name<span class="op">);</span></span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a><span class="co">//使用原生的SQL语句进行操作（注意select这时用的是表的列名而不是实体的属性名，from这时用的是数据库的表名而不是实体类名）</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span>nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> value <span class="op">=</span> <span class="st">&quot;select count(*) from User&quot;</span><span class="op">)</span></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Long</span> <span class="fu">userCount</span><span class="op">();</span></span></code></pre></div>
<h3 id="增删改">增删改</h3>
<p>对数据库进行修改的操作要使用<code>@Modifying</code>注解，对于update或者delete操作（insert最好也添加事务），还必须在使用该方法的地方（一般是service层）使用事务</p>
<p>DAO层</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Modifying</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Query</span><span class="op">(</span><span class="st">&quot;update User set name = ?1 where id = ?2&quot;</span><span class="op">)</span></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="fu">updateUserById</span><span class="op">(</span><span class="bu">String</span> name<span class="op">,</span> <span class="bu">Integer</span> id<span class="op">);</span></span></code></pre></div>
<p>service层</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span></span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">updateUserById</span><span class="op">(</span><span class="bu">String</span> name<span class="op">,</span> <span class="bu">Integer</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    userDao<span class="op">.</span><span class="fu">updateUserById</span><span class="op">(</span>name<span class="op">,</span> id<span class="op">);</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="其他repository接口">其他Repository接口</h3>
<h4 id="crudrepository">CrudRepository</h4>
<p><code>CrudRepository</code>接口继承自<code>Repository</code>，并提前为我们写好了增删改查等方法，动态代理会自动生成这些方法的实现</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserDao <span class="kw">extends</span> CrudRepository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;</span> <span class="op">{</span>  <span class="op">}</span></span></code></pre></div>
<p>CrudRepository的方法</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="at">@NoRepositoryBean</span></span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> CrudRepository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;</span> <span class="kw">extends</span> Repository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> S <span class="fu">save</span><span class="op">(</span>S var1<span class="op">);</span></span>
<span id="cb224-4"><a href="#cb224-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> <span class="bu">Iterable</span><span class="op">&lt;</span>S<span class="op">&gt;</span> <span class="fu">saveAll</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>S<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb224-5"><a href="#cb224-5" aria-hidden="true" tabindex="-1"></a>    Optional<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findById</span><span class="op">(</span>ID var1<span class="op">);</span></span>
<span id="cb224-6"><a href="#cb224-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">existsById</span><span class="op">(</span>ID var1<span class="op">);</span></span>
<span id="cb224-7"><a href="#cb224-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">();</span></span>
<span id="cb224-8"><a href="#cb224-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAllById</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>ID<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb224-9"><a href="#cb224-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="fu">count</span><span class="op">();</span></span>
<span id="cb224-10"><a href="#cb224-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteById</span><span class="op">(</span>ID var1<span class="op">);</span></span>
<span id="cb224-11"><a href="#cb224-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">delete</span><span class="op">(</span>T var1<span class="op">);</span></span>
<span id="cb224-12"><a href="#cb224-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteAll</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;?</span> <span class="kw">extends</span> T<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb224-13"><a href="#cb224-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteAll</span><span class="op">();</span></span>
<span id="cb224-14"><a href="#cb224-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="pagingandsortingrepository">PagingAndSortingRepository</h4>
<p><code>PagingAndSortingRepository</code>继承自<code>CrudRepository</code>，并且实现了分页相关的功能</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="at">@NoRepositoryBean</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> PagingAndSortingRepository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;</span> <span class="kw">extends</span> CrudRepository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span>Sort var1<span class="op">);</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>    Page<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span><span class="bu">Pageable</span> var1<span class="op">);</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>DAO</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserDao <span class="kw">extends</span> PagingAndSortingRepository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;</span> <span class="op">{</span>  <span class="op">}</span></span></code></pre></div>
<p>用法</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co">//相当于MySQL中&quot;limit 0, 5&quot;</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="co">//PageRequest pageRequest = PageRequest.of(0, 5);</span></span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="co">//使用排序</span></span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a>Sort<span class="op">.</span><span class="fu">Order</span> sortOrder <span class="op">=</span> <span class="kw">new</span> Sort<span class="op">.</span><span class="fu">Order</span><span class="op">(</span>Sort<span class="op">.</span><span class="fu">Direction</span><span class="op">.</span><span class="fu">DESC</span><span class="op">,</span> <span class="st">&quot;id&quot;</span><span class="op">);</span></span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a>Sort sort <span class="op">=</span> Sort<span class="op">.</span><span class="fu">by</span><span class="op">(</span>sortOrder<span class="op">);</span></span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>PageRequest pageRequest <span class="op">=</span> PageRequest<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> sort<span class="op">);</span></span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-9"><a href="#cb227-9" aria-hidden="true" tabindex="-1"></a>Page page <span class="op">=</span> userDao<span class="op">.</span><span class="fu">findAll</span><span class="op">(</span>pageRequest<span class="op">);</span></span>
<span id="cb227-10"><a href="#cb227-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-11"><a href="#cb227-11" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的总页数：&quot;</span> <span class="op">+</span> page<span class="op">.</span><span class="fu">getTotalPages</span><span class="op">());</span></span>
<span id="cb227-12"><a href="#cb227-12" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的总数据条数：&quot;</span> <span class="op">+</span> page<span class="op">.</span><span class="fu">getTotalElements</span><span class="op">());</span></span>
<span id="cb227-13"><a href="#cb227-13" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的当前页数：&quot;</span> <span class="op">+</span> <span class="op">(</span>page<span class="op">.</span><span class="fu">getNumber</span><span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb227-14"><a href="#cb227-14" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的数据的内容：&quot;</span> <span class="op">+</span> page<span class="op">.</span><span class="fu">getContent</span><span class="op">());</span></span>
<span id="cb227-15"><a href="#cb227-15" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的当前页的数据条数：&quot;</span> <span class="op">+</span> page<span class="op">.</span><span class="fu">getNumberOfElements</span><span class="op">());</span></span></code></pre></div>
<h4 id="jparepository">JpaRepository</h4>
<p><code>JpaRepository</code>继承自<code>PagingAndSortingRepository</code>，并拓展了一些功能</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="at">@NoRepositoryBean</span></span>
<span id="cb228-2"><a href="#cb228-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> JpaRepository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;</span> <span class="kw">extends</span> PagingAndSortingRepository<span class="op">&lt;</span>T<span class="op">,</span> ID<span class="op">&gt;,</span> QueryByExampleExecutor<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb228-3"><a href="#cb228-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">();</span></span>
<span id="cb228-4"><a href="#cb228-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span>Sort var1<span class="op">);</span></span>
<span id="cb228-5"><a href="#cb228-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAllById</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>ID<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb228-6"><a href="#cb228-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>S<span class="op">&gt;</span> <span class="fu">saveAll</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>S<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb228-7"><a href="#cb228-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">flush</span><span class="op">();</span></span>
<span id="cb228-8"><a href="#cb228-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> S <span class="fu">saveAndFlush</span><span class="op">(</span>S var1<span class="op">);</span></span>
<span id="cb228-9"><a href="#cb228-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteInBatch</span><span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb228-10"><a href="#cb228-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">deleteAllInBatch</span><span class="op">();</span></span>
<span id="cb228-11"><a href="#cb228-11" aria-hidden="true" tabindex="-1"></a>    T <span class="fu">getOne</span><span class="op">(</span>ID var1<span class="op">);</span></span>
<span id="cb228-12"><a href="#cb228-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>S<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span>Example<span class="op">&lt;</span>S<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb228-13"><a href="#cb228-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>S <span class="kw">extends</span> T<span class="op">&gt;</span> <span class="bu">List</span><span class="op">&lt;</span>S<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span>Example<span class="op">&lt;</span>S<span class="op">&gt;</span> var1<span class="op">,</span> Sort var2<span class="op">);</span></span>
<span id="cb228-14"><a href="#cb228-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="jpaspecificationexecutor">JpaSpecificationExecutor</h3>
<p>通过创建方法名来做查询，只能做简单的查询，如果我们要做复杂一些的查询，就要使用<code>JpaSpecificationExecutor</code>（它不属于Repository）</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> JpaSpecificationExecutor<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>    Optional<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findOne</span><span class="op">(</span><span class="at">@Nullable</span> Specification<span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span><span class="at">@Nullable</span> Specification<span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>    Page<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span><span class="at">@Nullable</span> Specification<span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">,</span> <span class="bu">Pageable</span> var2<span class="op">);</span></span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="fu">findAll</span><span class="op">(</span><span class="at">@Nullable</span> Specification<span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">,</span> Sort var2<span class="op">);</span></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="fu">count</span><span class="op">(</span><span class="at">@Nullable</span> Specification<span class="op">&lt;</span>T<span class="op">&gt;</span> var1<span class="op">);</span></span>
<span id="cb229-7"><a href="#cb229-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>DAO</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserDao <span class="kw">extends</span> CrudRepository<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;,</span> JpaSpecificationExecutor<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="op">{</span>  <span class="op">}</span></span></code></pre></div>
<p>用法</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co">//分页的过滤条件</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>Specification specification <span class="op">=</span> <span class="kw">new</span> Specification<span class="op">&lt;</span>User<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Predicate</span> <span class="fu">toPredicate</span><span class="op">(</span>Root<span class="op">&lt;</span>User<span class="op">&gt;</span> root<span class="op">,</span> CriteriaQuery<span class="op">&lt;?&gt;</span> criteriaQuery<span class="op">,</span> CriteriaBuilder criteriaBuilder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb231-4"><a href="#cb231-4" aria-hidden="true" tabindex="-1"></a>        Path<span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span> idPath <span class="op">=</span> root<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">);</span></span>
<span id="cb231-5"><a href="#cb231-5" aria-hidden="true" tabindex="-1"></a>        Path<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> namePath <span class="op">=</span> root<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb231-6"><a href="#cb231-6" aria-hidden="true" tabindex="-1"></a>        Path<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> rolePath <span class="op">=</span> root<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">);</span></span>
<span id="cb231-7"><a href="#cb231-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">//设置过滤条件为id小于等于10</span></span>
<span id="cb231-8"><a href="#cb231-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> idPredicate <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">le</span><span class="op">(</span>idPath<span class="op">,</span> <span class="dv">10</span><span class="op">);</span></span>
<span id="cb231-9"><a href="#cb231-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//名字包含&quot;小&quot;</span></span>
<span id="cb231-10"><a href="#cb231-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> namePredicate <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">like</span><span class="op">(</span>namePath<span class="op">,</span> <span class="st">&quot;%小%&quot;</span><span class="op">);</span></span>
<span id="cb231-11"><a href="#cb231-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//权限为admin</span></span>
<span id="cb231-12"><a href="#cb231-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> rolePredicate <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">equal</span><span class="op">(</span>rolePath<span class="op">,</span> <span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb231-13"><a href="#cb231-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-14"><a href="#cb231-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//多个条件组合</span></span>
<span id="cb231-15"><a href="#cb231-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> predicate1 <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">and</span><span class="op">(</span>idPredicate<span class="op">,</span> namePredicate<span class="op">);</span></span>
<span id="cb231-16"><a href="#cb231-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> predicate2 <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">or</span><span class="op">(</span>predicate1<span class="op">,</span> rolePredicate<span class="op">);</span></span>
<span id="cb231-17"><a href="#cb231-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-18"><a href="#cb231-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*join查询</span></span>
<span id="cb231-19"><a href="#cb231-19" aria-hidden="true" tabindex="-1"></a><span class="co">        //User表和Admin表进行join查询</span></span>
<span id="cb231-20"><a href="#cb231-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Join&lt;User, Admin&gt; join = root.join(&quot;role&quot;, JoinType.LEFT);</span></span>
<span id="cb231-21"><a href="#cb231-21" aria-hidden="true" tabindex="-1"></a><span class="co">        //Admin表中的属性</span></span>
<span id="cb231-22"><a href="#cb231-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Path adminNamePath = join.get(&quot;name&quot;);</span></span>
<span id="cb231-23"><a href="#cb231-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Predicate adminNamePredicate = criteriaBuilder.like(adminNamePath, &quot;%管理员%&quot;);</span></span>
<span id="cb231-24"><a href="#cb231-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Predicate predicate3 = criteriaBuilder.or(predicate2,adminNamePredicate);</span></span>
<span id="cb231-25"><a href="#cb231-25" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb231-26"><a href="#cb231-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predicate2<span class="op">;</span></span>
<span id="cb231-27"><a href="#cb231-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb231-28"><a href="#cb231-28" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb231-29"><a href="#cb231-29" aria-hidden="true" tabindex="-1"></a><span class="co">//使用排序</span></span>
<span id="cb231-30"><a href="#cb231-30" aria-hidden="true" tabindex="-1"></a>Sort<span class="op">.</span><span class="fu">Order</span> sortOrder <span class="op">=</span> <span class="kw">new</span> Sort<span class="op">.</span><span class="fu">Order</span><span class="op">(</span>Sort<span class="op">.</span><span class="fu">Direction</span><span class="op">.</span><span class="fu">ASC</span><span class="op">,</span> <span class="st">&quot;id&quot;</span><span class="op">);</span></span>
<span id="cb231-31"><a href="#cb231-31" aria-hidden="true" tabindex="-1"></a>Sort sort <span class="op">=</span> Sort<span class="op">.</span><span class="fu">by</span><span class="op">(</span>sortOrder<span class="op">);</span></span>
<span id="cb231-32"><a href="#cb231-32" aria-hidden="true" tabindex="-1"></a>PageRequest pageRequest <span class="op">=</span> PageRequest<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> sort<span class="op">);</span></span>
<span id="cb231-33"><a href="#cb231-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb231-34"><a href="#cb231-34" aria-hidden="true" tabindex="-1"></a><span class="co">//使用JpaSpecificationExecutor的Page&lt;T&gt; findAll(Specification&lt;T&gt;, Pageable)执行复杂查询</span></span>
<span id="cb231-35"><a href="#cb231-35" aria-hidden="true" tabindex="-1"></a>Page<span class="op">&lt;</span>User<span class="op">&gt;</span> page <span class="op">=</span> userDao<span class="op">.</span><span class="fu">findAll</span><span class="op">(</span>specification<span class="op">,</span> pageRequest<span class="op">);</span></span>
<span id="cb231-36"><a href="#cb231-36" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的当前页数：&quot;</span> <span class="op">+</span> <span class="op">(</span>page<span class="op">.</span><span class="fu">getNumber</span><span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb231-37"><a href="#cb231-37" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;查询的数据的内容：&quot;</span> <span class="op">+</span> page<span class="op">.</span><span class="fu">getContent</span><span class="op">());</span></span></code></pre></div>
<p>最后生成的SQL是：</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>    user0_.<span class="kw">id</span> <span class="kw">as</span> id1_0_,</span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>    user0_.name <span class="kw">as</span> name2_0_,</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    user0_.<span class="kw">role</span> <span class="kw">as</span> role3_0_ </span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span></span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">User</span> user0_ </span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span></span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>    user0_.<span class="kw">id</span><span class="op">&lt;=</span><span class="dv">10</span> </span>
<span id="cb232-9"><a href="#cb232-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">and</span> (</span>
<span id="cb232-10"><a href="#cb232-10" aria-hidden="true" tabindex="-1"></a>    user0_.name <span class="kw">like</span> ?</span>
<span id="cb232-11"><a href="#cb232-11" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb232-12"><a href="#cb232-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">or</span> user0_.<span class="kw">role</span><span class="op">=</span>? </span>
<span id="cb232-13"><a href="#cb232-13" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span></span>
<span id="cb232-14"><a href="#cb232-14" aria-hidden="true" tabindex="-1"></a>    user0_.<span class="kw">id</span> <span class="kw">asc</span> <span class="kw">limit</span> ?</span></code></pre></div>
<p><strong>使用join</strong></p>
<p>User中有Role的外键时（一个User对应一个Role的情况，一对一）</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb233-4"><a href="#cb233-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb233-5"><a href="#cb233-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb233-6"><a href="#cb233-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb233-7"><a href="#cb233-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-8"><a href="#cb233-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToOne</span></span>
<span id="cb233-9"><a href="#cb233-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;role_id&quot;</span><span class="op">,</span>referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb233-10"><a href="#cb233-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Role</span> role<span class="op">;</span></span>
<span id="cb233-11"><a href="#cb233-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb233-12"><a href="#cb233-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-13"><a href="#cb233-13" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb233-14"><a href="#cb233-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> <span class="bu">Role</span> <span class="op">{</span></span>
<span id="cb233-15"><a href="#cb233-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb233-16"><a href="#cb233-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb233-17"><a href="#cb233-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb233-18"><a href="#cb233-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> roleName<span class="op">;</span></span>
<span id="cb233-19"><a href="#cb233-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-20"><a href="#cb233-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToOne</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;role&quot;</span><span class="op">)</span></span>
<span id="cb233-21"><a href="#cb233-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> User user<span class="op">;</span></span>
<span id="cb233-22"><a href="#cb233-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时的join查询</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co">//根据指定条件的Role找对应的User</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a><span class="co">//SELECT * FROM User u LEFT OUTER JOIN Role r ON u.role_id=r.id where r.id=1 or r.roleName like %normal%</span></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span> userList <span class="op">=</span> userDao<span class="op">.</span><span class="fu">findAll</span><span class="op">(</span><span class="kw">new</span> Specification<span class="op">&lt;</span>User<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Predicate</span> <span class="fu">toPredicate</span><span class="op">(</span>Root<span class="op">&lt;</span>User<span class="op">&gt;</span> root<span class="op">,</span> CriteriaQuery<span class="op">&lt;?&gt;</span> query<span class="op">,</span> CriteriaBuilder criteriaBuilder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//root是User，根据User实体的role属性left join</span></span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// LEFT OUTER JOIN Role r ON u.role_id=r.id</span></span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>        Join<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Role</span><span class="op">&gt;</span> join <span class="op">=</span> root<span class="op">.</span><span class="fu">join</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> JoinType<span class="op">.</span><span class="fu">LEFT</span><span class="op">);</span></span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">//join为Role实体</span></span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// r.id=1</span></span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> predicate3 <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">equal</span><span class="op">(</span>join<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">),</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// r.roleName like %normal%</span></span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Predicate</span> predicate4 <span class="op">=</span> criteriaBuilder<span class="op">.</span><span class="fu">like</span><span class="op">(</span>join<span class="op">.&lt;</span><span class="bu">String</span><span class="op">&gt;</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;roleName&quot;</span><span class="op">),</span> <span class="st">&quot;%normal%&quot;</span><span class="op">);</span></span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// or</span></span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> criteriaBuilder<span class="op">.</span><span class="fu">or</span><span class="op">(</span>predicate3<span class="op">,</span> predicate4<span class="op">);</span></span>
<span id="cb234-15"><a href="#cb234-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb234-16"><a href="#cb234-16" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>Role中有User的外键时（一个User对应多个Role的情况，一对多、多对一）</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">)</span></span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Role</span><span class="op">&gt;</span> roles <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb235-11"><a href="#cb235-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-12"><a href="#cb235-12" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb235-13"><a href="#cb235-13" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> <span class="bu">Role</span> <span class="op">{</span></span>
<span id="cb235-14"><a href="#cb235-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb235-15"><a href="#cb235-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb235-16"><a href="#cb235-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb235-17"><a href="#cb235-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> roleName<span class="op">;</span></span>
<span id="cb235-18"><a href="#cb235-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-19"><a href="#cb235-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToOne</span></span>
<span id="cb235-20"><a href="#cb235-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;user_id&quot;</span><span class="op">,</span> referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb235-21"><a href="#cb235-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> User user<span class="op">;</span></span>
<span id="cb235-22"><a href="#cb235-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时的join查询</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co">//根据指定的Role找对应的User</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a><span class="co">//SELECT * FROM User u LEFT OUTER JOIN Role r ON u.id=r.user_id where u.id&lt;10</span></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span> userList <span class="op">=</span> userDao<span class="op">.</span><span class="fu">findAll</span><span class="op">(</span><span class="kw">new</span> Specification<span class="op">&lt;</span>User<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Predicate</span> <span class="fu">toPredicate</span><span class="op">(</span>Root<span class="op">&lt;</span>User<span class="op">&gt;</span> root<span class="op">,</span> CriteriaQuery<span class="op">&lt;?&gt;</span> query<span class="op">,</span> CriteriaBuilder criteriaBuilder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//list的情况</span></span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">//ListJoin&lt;User, Role&gt; join = root.join(root.getModel().getList(&quot;roles&quot;, Role.class), JoinType.LEFT);</span></span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">//等价于</span></span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>        ListJoin<span class="op">&lt;</span>User<span class="op">,</span> <span class="bu">Role</span><span class="op">&gt;</span> join <span class="op">=</span> root<span class="op">.</span><span class="fu">joinList</span><span class="op">(</span><span class="st">&quot;roles&quot;</span><span class="op">,</span> JoinType<span class="op">.</span><span class="fu">LEFT</span><span class="op">);</span></span>
<span id="cb236-9"><a href="#cb236-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb236-10"><a href="#cb236-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//return criteriaBuilder.lt(root.&lt;Integer&gt;get(&quot;id&quot;), 10);</span></span>
<span id="cb236-11"><a href="#cb236-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以直接执行，然后返回null，两者是等价的</span></span>
<span id="cb236-12"><a href="#cb236-12" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span><span class="fu">where</span><span class="op">(</span>criteriaBuilder<span class="op">.</span><span class="fu">lt</span><span class="op">(</span>root<span class="op">.&lt;</span><span class="bu">Integer</span><span class="op">&gt;</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">),</span> <span class="dv">10</span><span class="op">));</span></span>
<span id="cb236-13"><a href="#cb236-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb236-14"><a href="#cb236-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb236-15"><a href="#cb236-15" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>如果不需要where，那直接返回null就可以了</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="co">//SELECT * FROM User u LEFT OUTER JOIN Role r ON u.id=r.user_id</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span> userList <span class="op">=</span> userDao<span class="op">.</span><span class="fu">findAll</span><span class="op">(</span><span class="kw">new</span> Specification<span class="op">&lt;</span>User<span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Predicate</span> <span class="fu">toPredicate</span><span class="op">(</span>Root<span class="op">&lt;</span>User<span class="op">&gt;</span> root<span class="op">,</span> CriteriaQuery<span class="op">&lt;?&gt;</span> query<span class="op">,</span> CriteriaBuilder criteriaBuilder<span class="op">)</span> <span class="op">{</span></span>
<span id="cb237-4"><a href="#cb237-4" aria-hidden="true" tabindex="-1"></a>        root<span class="op">.</span><span class="fu">joinList</span><span class="op">(</span><span class="st">&quot;roles&quot;</span><span class="op">,</span> JoinType<span class="op">.</span><span class="fu">LEFT</span><span class="op">);</span></span>
<span id="cb237-5"><a href="#cb237-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">//多表join：可以链式调用，第一次joinList后，返回的join是Role，第二次joinList就是根据Role的other_column属性（外键字段）再join其他的表</span></span>
<span id="cb237-6"><a href="#cb237-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">//root.joinList(&quot;roles&quot;, JoinType.LEFT).joinList(&quot;other_column&quot;, JoinType.INNER);</span></span>
<span id="cb237-7"><a href="#cb237-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb237-8"><a href="#cb237-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb237-9"><a href="#cb237-9" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h3 id="扩展repository方法">扩展Repository方法</h3>
<p><code>JpaSpecificationExecutor</code>一般写在DAO接口的实现类中，前面的例子中都是只写接口，没有实现类，如果要在Spring
Data
JPA提供的<code>Repository</code>的基础上扩展方法，实现类需要实现我们的自定义接口，并且按照指定的命名方式（指定后缀）放在和接口同一个包下</p>
<p>在applicationContext.xml中通过<code>repository-impl-postfix</code>指定实现类的后缀</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">jpa:repositories</span><span class="ot"> base-package=</span><span class="st">&quot;com.myapp.dao&quot;</span><span class="ot"> repository-impl-postfix=</span><span class="st">&quot;Impl&quot;</span><span class="ot"> entity-manager-factory-ref=</span><span class="st">&quot;entityManagerFactory&quot;</span><span class="ot"> transaction-manager-ref=</span><span class="st">&quot;transactionManager&quot;</span> /&gt;</span></code></pre></div>
<p>DAO接口同时继承<code>Repository</code>和我们自定义的接口，实现类只需继承自定义的接口，实现类一般使用<code>@PersistenceContext</code>注解获取原生的<code>EntityManager</code>对数据库进行操作</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="co">//DAO接口</span></span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> PersonDao <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>Person<span class="op">,</span><span class="bu">Integer</span><span class="op">&gt;,</span>MyInterface <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a><span class="co">//这是我们自定义的接口</span></span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> MyInterface<span class="op">{</span></span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">myMethod</span><span class="op">();</span></span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-9"><a href="#cb239-9" aria-hidden="true" tabindex="-1"></a><span class="co">//实现类需要放在和接口同一个包（或子包）下</span></span>
<span id="cb239-10"><a href="#cb239-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PersonDaoImpl <span class="kw">implements</span> MyInterface<span class="op">{</span></span>
<span id="cb239-11"><a href="#cb239-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PersistenceContext</span></span>
<span id="cb239-12"><a href="#cb239-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> EntityManager em<span class="op">;</span></span>
<span id="cb239-13"><a href="#cb239-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-14"><a href="#cb239-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">myMethod</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb239-15"><a href="#cb239-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//使用原生的EntityManager实现QBC(Query By Criteria)查询</span></span>
<span id="cb239-16"><a href="#cb239-16" aria-hidden="true" tabindex="-1"></a>        CriteriaBuilder builder <span class="op">=</span> em<span class="op">.</span><span class="fu">getCriteriaBuilder</span><span class="op">();</span></span>
<span id="cb239-17"><a href="#cb239-17" aria-hidden="true" tabindex="-1"></a>        CriteriaQuery<span class="op">&lt;</span>Person<span class="op">&gt;</span> query <span class="op">=</span> builder<span class="op">.</span><span class="fu">createQuery</span><span class="op">(</span>Person<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb239-18"><a href="#cb239-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-19"><a href="#cb239-19" aria-hidden="true" tabindex="-1"></a>        Root<span class="op">&lt;</span>Person<span class="op">&gt;</span> root <span class="op">=</span> query<span class="op">.</span><span class="fu">from</span><span class="op">(</span>Person<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb239-20"><a href="#cb239-20" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span><span class="fu">where</span><span class="op">(</span>builder<span class="op">.</span><span class="fu">like</span><span class="op">(</span>root<span class="op">.&lt;</span><span class="bu">String</span><span class="op">&gt;</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">),</span> <span class="st">&quot;%小%&quot;</span><span class="op">));</span></span>
<span id="cb239-21"><a href="#cb239-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-22"><a href="#cb239-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Person<span class="op">&gt;</span> list <span class="op">=</span> em<span class="op">.</span><span class="fu">createQuery</span><span class="op">(</span>query<span class="op">.</span><span class="fu">select</span><span class="op">(</span>root<span class="op">)).</span><span class="fu">getResultList</span><span class="op">();</span></span>
<span id="cb239-23"><a href="#cb239-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>list<span class="op">);</span></span>
<span id="cb239-24"><a href="#cb239-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-25"><a href="#cb239-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb239-26"><a href="#cb239-26" aria-hidden="true" tabindex="-1"></a><span class="co">        //使用原生的EntityManager实现OID查询，其他操作都是基于OID的</span></span>
<span id="cb239-27"><a href="#cb239-27" aria-hidden="true" tabindex="-1"></a><span class="co">        EntityTransaction transaction = em.getTransaction();</span></span>
<span id="cb239-28"><a href="#cb239-28" aria-hidden="true" tabindex="-1"></a><span class="co">        transaction.begin();</span></span>
<span id="cb239-29"><a href="#cb239-29" aria-hidden="true" tabindex="-1"></a><span class="co">        try {</span></span>
<span id="cb239-30"><a href="#cb239-30" aria-hidden="true" tabindex="-1"></a><span class="co">            Person p1 = new Person();</span></span>
<span id="cb239-31"><a href="#cb239-31" aria-hidden="true" tabindex="-1"></a><span class="co">            p1.setName(&quot;小明&quot;);</span></span>
<span id="cb239-32"><a href="#cb239-32" aria-hidden="true" tabindex="-1"></a><span class="co">            //插入（增）</span></span>
<span id="cb239-33"><a href="#cb239-33" aria-hidden="true" tabindex="-1"></a><span class="co">            em.persist(p1);</span></span>
<span id="cb239-34"><a href="#cb239-34" aria-hidden="true" tabindex="-1"></a><span class="co">            //根据OID查询（查）</span></span>
<span id="cb239-35"><a href="#cb239-35" aria-hidden="true" tabindex="-1"></a><span class="co">            Person p2 = em.find(Person.class, 1L);//查出来的对象是持久态</span></span>
<span id="cb239-36"><a href="#cb239-36" aria-hidden="true" tabindex="-1"></a><span class="co">            //Person p2 = em.getReference(Person.class,1L);//find是立即加载，要使用延迟加载，用getReference</span></span>
<span id="cb239-37"><a href="#cb239-37" aria-hidden="true" tabindex="-1"></a><span class="co">            //更新（改）</span></span>
<span id="cb239-38"><a href="#cb239-38" aria-hidden="true" tabindex="-1"></a><span class="co">            p2.setName(&quot;小红&quot;);//set持久态对象的属性后，在commit的时候会和快照对比，如果不一致则自动更新</span></span>
<span id="cb239-39"><a href="#cb239-39" aria-hidden="true" tabindex="-1"></a><span class="co">            em.merge(p2);//也可以调用merge，手动更新；merge的实际作用是，在Hibernate中，当我们查询出一个对象后，session关闭了，对象从持久态转为游离态，这时如果我们更改了游离态对象的属性，然后我们再另开一个session，再根据该对象OID查询出对象（持久态），这时就会导致内存中有两个相同OID对象的缓存，但快照中只有一份，这时如果要保存游离态对象，会报错，这时merge的作用就是把游离态对象的属性同步到刚刚查询出来的持久态对象中，把两份缓存合并成一份，这时保存持久态对象才能保存成功；这里由于Spring Data JPA中没有session的概念（一个线程只有一个session，session由容器自动创建，不需要手动管理），所以merge的作用就是单单保存</span></span>
<span id="cb239-40"><a href="#cb239-40" aria-hidden="true" tabindex="-1"></a><span class="co">            /*</span></span>
<span id="cb239-41"><a href="#cb239-41" aria-hidden="true" tabindex="-1"></a><span class="co">            //要在JPA中使用session也是可以的</span></span>
<span id="cb239-42"><a href="#cb239-42" aria-hidden="true" tabindex="-1"></a><span class="co">            Session session = em.upwrap(Session.class);</span></span>
<span id="cb239-43"><a href="#cb239-43" aria-hidden="true" tabindex="-1"></a><span class="co">            session.doWork(new Work(){</span></span>
<span id="cb239-44"><a href="#cb239-44" aria-hidden="true" tabindex="-1"></a><span class="co">                public void execute(Connection conn) throws SQLException{</span></span>
<span id="cb239-45"><a href="#cb239-45" aria-hidden="true" tabindex="-1"></a><span class="co">                    System.out.println(conn.getClass().getName());</span></span>
<span id="cb239-46"><a href="#cb239-46" aria-hidden="true" tabindex="-1"></a><span class="co">                }</span></span>
<span id="cb239-47"><a href="#cb239-47" aria-hidden="true" tabindex="-1"></a><span class="co">            });</span></span>
<span id="cb239-48"><a href="#cb239-48" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb239-49"><a href="#cb239-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">//删除（删）</span></span>
<span id="cb239-50"><a href="#cb239-50" aria-hidden="true" tabindex="-1"></a>            em<span class="op">.</span><span class="fu">remove</span><span class="op">(</span>p1<span class="op">);</span></span>
<span id="cb239-51"><a href="#cb239-51" aria-hidden="true" tabindex="-1"></a>            transaction<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb239-52"><a href="#cb239-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb239-53"><a href="#cb239-53" aria-hidden="true" tabindex="-1"></a>            transaction<span class="op">.</span><span class="fu">rollback</span><span class="op">();</span></span>
<span id="cb239-54"><a href="#cb239-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb239-55"><a href="#cb239-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">*/</span></span>
<span id="cb239-56"><a href="#cb239-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-57"><a href="#cb239-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb239-58"><a href="#cb239-58" aria-hidden="true" tabindex="-1"></a><span class="co">        //使用原生的EntityManager实现JPQL查询，JPQL和HQL的不同在于JPQL在查询的时候要写&quot;select xxx&quot;，而且xxx不能用星号(*)，而应该使用实体名或它的别名</span></span>
<span id="cb239-59"><a href="#cb239-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Query query = em.createQuery(&quot;select p from Perosn p where p.id &gt; :p_id&quot;, Person.class);</span></span>
<span id="cb239-60"><a href="#cb239-60" aria-hidden="true" tabindex="-1"></a><span class="co">        //支持聚合函数</span></span>
<span id="cb239-61"><a href="#cb239-61" aria-hidden="true" tabindex="-1"></a><span class="co">        //Query query = em.createQuery(&quot;select count(*) from Perosn&quot;);</span></span>
<span id="cb239-62"><a href="#cb239-62" aria-hidden="true" tabindex="-1"></a><span class="co">        //支持order by（默认asc(升序)，可以指定desc(倒序)）</span></span>
<span id="cb239-63"><a href="#cb239-63" aria-hidden="true" tabindex="-1"></a><span class="co">        //Query query = em.createQuery(&quot;select p from Perosn p order by p.id desc&quot;, Person.class);</span></span>
<span id="cb239-64"><a href="#cb239-64" aria-hidden="true" tabindex="-1"></a><span class="co">        //支持HQL的投影查询语法（用于查询部分数据，此时Person类中要有对应的构造器；也可以直接指定要查询的字段来替代这种写法）</span></span>
<span id="cb239-65"><a href="#cb239-65" aria-hidden="true" tabindex="-1"></a><span class="co">        //Query query = em.createQuery(&quot;select new Person(p.id, p.name) from Perosn p&quot;, Person.class);</span></span>
<span id="cb239-66"><a href="#cb239-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb239-67"><a href="#cb239-67" aria-hidden="true" tabindex="-1"></a><span class="co">        //如果没有使用别名而是直接使用?占位符，那么setParameter的下标从1开始（setParameter(1, xxx)）</span></span>
<span id="cb239-68"><a href="#cb239-68" aria-hidden="true" tabindex="-1"></a><span class="co">        query.setParameter(&quot;p_id&quot;, 10);</span></span>
<span id="cb239-69"><a href="#cb239-69" aria-hidden="true" tabindex="-1"></a><span class="co">        //分页 limit 5,5（因为不是所有数据库都支持直接分页，所以要使用对应方法设置分页），JPQL和QBC的分页设置方式一样</span></span>
<span id="cb239-70"><a href="#cb239-70" aria-hidden="true" tabindex="-1"></a><span class="co">        query.setFirstResult(5);</span></span>
<span id="cb239-71"><a href="#cb239-71" aria-hidden="true" tabindex="-1"></a><span class="co">        query.setMaxResults(5);</span></span>
<span id="cb239-72"><a href="#cb239-72" aria-hidden="true" tabindex="-1"></a><span class="co">        for (Person p : query.getResultList())</span></span>
<span id="cb239-73"><a href="#cb239-73" aria-hidden="true" tabindex="-1"></a><span class="co">            System.out.println(p);</span></span>
<span id="cb239-74"><a href="#cb239-74" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb239-75"><a href="#cb239-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb239-76"><a href="#cb239-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb239-77"><a href="#cb239-77" aria-hidden="true" tabindex="-1"></a><span class="co">        //支持原生SQL</span></span>
<span id="cb239-78"><a href="#cb239-78" aria-hidden="true" tabindex="-1"></a><span class="co">        Query query = entityManager.createNativeQuery(&quot;select * from Person p where p.id=?&quot;);</span></span>
<span id="cb239-79"><a href="#cb239-79" aria-hidden="true" tabindex="-1"></a><span class="co">        //index从1开始，指定SQL中的id为10</span></span>
<span id="cb239-80"><a href="#cb239-80" aria-hidden="true" tabindex="-1"></a><span class="co">        query.setParameter(1, 10);</span></span>
<span id="cb239-81"><a href="#cb239-81" aria-hidden="true" tabindex="-1"></a><span class="co">        List list = query.getResultList();</span></span>
<span id="cb239-82"><a href="#cb239-82" aria-hidden="true" tabindex="-1"></a><span class="co">        */</span></span>
<span id="cb239-83"><a href="#cb239-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb239-84"><a href="#cb239-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="数据关系">数据关系</h3>
<h4 id="一对一">一对一</h4>
<h5 id="直接包含">直接包含</h5>
<p>假设一个person对应一个address</p>
<p>person.java</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Person <span class="op">{</span></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">)</span></span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb240-10"><a href="#cb240-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-11"><a href="#cb240-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToOne</span><span class="op">(</span>cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span><span class="co">//使用级联，比如当删除person时，会同时删除address中对应的记录</span></span>
<span id="cb240-12"><a href="#cb240-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">,</span> referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span><span class="co">//people中的address_id字段参考address表中的id字段。即使用Address表的id作为外键字段，字段名为address_id</span></span>
<span id="cb240-13"><a href="#cb240-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Address address<span class="op">;</span></span>
<span id="cb240-14"><a href="#cb240-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb240-15"><a href="#cb240-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">//省略空构造函数和get、set、toString，下面同理</span></span>
<span id="cb240-16"><a href="#cb240-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb240-17"><a href="#cb240-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Address.java</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Address <span class="op">{</span></span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;country&quot;</span><span class="op">)</span></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> country<span class="op">;</span></span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;city&quot;</span><span class="op">)</span></span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> city<span class="op">;</span></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;street&quot;</span><span class="op">)</span></span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> street<span class="op">;</span></span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果不需要根据Address级联查询People，可以注释掉</span></span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">//optional=false，表示person不能为空。删除address，不影响person</span></span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@OneToOne(mappedBy = &quot;address&quot;, cascade = {CascadeType.MERGE, CascadeType.REFRESH}, optional = false)</span></span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//private Person person;</span></span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-22"><a href="#cb241-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb241-23"><a href="#cb241-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>生成的sql（无论Address中是否有person属性都是一样的）</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb242-14"><a href="#cb242-14" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb242-15"><a href="#cb242-15" aria-hidden="true" tabindex="-1"></a>        address_id <span class="dt">integer</span>,</span>
<span id="cb242-16"><a href="#cb242-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb242-17"><a href="#cb242-17" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb242-18"><a href="#cb242-18" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb242-19"><a href="#cb242-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb242-20"><a href="#cb242-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> Person </span>
<span id="cb242-21"><a href="#cb242-21" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK6i7nduc8blbwp1dbfwavvnvvx </span>
<span id="cb242-22"><a href="#cb242-22" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (address_id) </span>
<span id="cb242-23"><a href="#cb242-23" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Address (<span class="kw">id</span>)</span></code></pre></div>
<h5 id="使用中间表">使用中间表</h5>
<p>如果使用中间表保存两者的关系，Person改为如下，Address不变</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Person <span class="op">{</span></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">)</span></span>
<span id="cb243-9"><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb243-10"><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToOne</span><span class="op">(</span>cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span><span class="co">//使用级联，比如当删除person时，会同时删除address中对应的记录</span></span>
<span id="cb243-12"><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//中间表的表名为person_address</span></span>
<span id="cb243-13"><a href="#cb243-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinTable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;person_address&quot;</span><span class="op">,</span></span>
<span id="cb243-14"><a href="#cb243-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">//当前实体在中间表的外键字段名是people_id，它的reference是当前实体对应表的id列，如果不指定referencedColumnName，默认为主键</span></span>
<span id="cb243-15"><a href="#cb243-15" aria-hidden="true" tabindex="-1"></a>            joinColumns <span class="op">=</span> <span class="at">@JoinColumn</span><span class="op">(</span>name<span class="op">=</span><span class="st">&quot;people_id&quot;</span><span class="op">,</span> referencedColumnName<span class="op">=</span><span class="st">&quot;id&quot;</span><span class="op">),</span></span>
<span id="cb243-16"><a href="#cb243-16" aria-hidden="true" tabindex="-1"></a>            inverseJoinColumns <span class="op">=</span> <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">))</span></span>
<span id="cb243-17"><a href="#cb243-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Address address<span class="op">;</span></span>
<span id="cb243-18"><a href="#cb243-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb243-19"><a href="#cb243-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb243-20"><a href="#cb243-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时生成的SQL</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb244-5"><a href="#cb244-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb244-6"><a href="#cb244-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb244-7"><a href="#cb244-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb244-8"><a href="#cb244-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb244-9"><a href="#cb244-9" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb244-10"><a href="#cb244-10" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb244-11"><a href="#cb244-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-12"><a href="#cb244-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb244-13"><a href="#cb244-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb244-14"><a href="#cb244-14" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb244-15"><a href="#cb244-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb244-16"><a href="#cb244-16" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb244-17"><a href="#cb244-17" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb244-18"><a href="#cb244-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-19"><a href="#cb244-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> person_address (</span>
<span id="cb244-20"><a href="#cb244-20" aria-hidden="true" tabindex="-1"></a>       address_id <span class="dt">integer</span>,</span>
<span id="cb244-21"><a href="#cb244-21" aria-hidden="true" tabindex="-1"></a>        people_id <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb244-22"><a href="#cb244-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (people_id)</span>
<span id="cb244-23"><a href="#cb244-23" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb244-24"><a href="#cb244-24" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb244-25"><a href="#cb244-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-26"><a href="#cb244-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> person_address </span>
<span id="cb244-27"><a href="#cb244-27" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK5gaighxlfytjmaiy4xrma2sev </span>
<span id="cb244-28"><a href="#cb244-28" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (address_id) </span>
<span id="cb244-29"><a href="#cb244-29" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Address (<span class="kw">id</span>)</span>
<span id="cb244-30"><a href="#cb244-30" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb244-31"><a href="#cb244-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb244-32"><a href="#cb244-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> person_address </span>
<span id="cb244-33"><a href="#cb244-33" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FKpbmn6d7ivwvid8r4leifxd5cn </span>
<span id="cb244-34"><a href="#cb244-34" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (people_id) </span>
<span id="cb244-35"><a href="#cb244-35" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Person (<span class="kw">id</span>)</span></code></pre></div>
<h5 id="参数说明">参数说明</h5>
<p><strong>mappedBy</strong></p>
<p><code>mappedBy</code>:
指定关系维护端，值为另一方对应的属性名，如果关系是单向的就不需要。由于<code>JoinTable</code>和<code>JoinColumn</code>一般定义在拥有关系(在one-to-many、many-to-one中为many端)的这一端，而Hibernate又不让<code>mappedBy</code>跟<code>JoinTable</code>和<code>JoinColumn</code>定义在一起，所以<code>mappedBy</code>一定是定义在关系的被拥有方(one)。关系维护端拥有建立、解除和更新与另一方关系的能力，而另一方没有，只能被动管理，而且关系维护端可以直接删除，而另一方要先在关系维护端删除关联（把外键置为NULL），才能被删除；在双向一对多和双向多对多中同理</p>
<p>比如没有配置<code>mappedBy</code>时</p>
<p>Person.java中：</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="op">(</span>cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a><span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">,</span> referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Address address<span class="op">;</span></span></code></pre></div>
<p>Address.java中：</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="co">//不配置mappedBy(mappedBy = &quot;address&quot;)</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Person person<span class="op">;</span></span></code></pre></div>
<p>此时生成的建表语句会在两个表中都有外键，即两个外键</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>        person_id <span class="dt">integer</span>,</span>
<span id="cb247-9"><a href="#cb247-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb247-10"><a href="#cb247-10" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb247-11"><a href="#cb247-11" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb247-12"><a href="#cb247-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb247-13"><a href="#cb247-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb247-14"><a href="#cb247-14" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb247-15"><a href="#cb247-15" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb247-16"><a href="#cb247-16" aria-hidden="true" tabindex="-1"></a>        address_id <span class="dt">integer</span>,</span>
<span id="cb247-17"><a href="#cb247-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb247-18"><a href="#cb247-18" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb247-19"><a href="#cb247-19" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb247-20"><a href="#cb247-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb247-21"><a href="#cb247-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> Address </span>
<span id="cb247-22"><a href="#cb247-22" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FKdu13rl17o4h24m9gt7b2bdobo </span>
<span id="cb247-23"><a href="#cb247-23" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (person_id) </span>
<span id="cb247-24"><a href="#cb247-24" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Person (<span class="kw">id</span>)</span>
<span id="cb247-25"><a href="#cb247-25" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb247-26"><a href="#cb247-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb247-27"><a href="#cb247-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> Person </span>
<span id="cb247-28"><a href="#cb247-28" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK6i7nduc8blbwp1dbfwavvnvvx </span>
<span id="cb247-29"><a href="#cb247-29" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (address_id) </span>
<span id="cb247-30"><a href="#cb247-30" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Address (<span class="kw">id</span>)</span></code></pre></div>
<p>虽然两边都有外键也能用，但是一次修改要更新两次，会影响性能，而且实际上只需一个外键就能描述清楚两者的关系，所以我们更希望删掉其中一方的外键，只留下一个外键</p>
<p>配置<code>mappedBy</code></p>
<p>Address.java中：</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;address&quot;</span><span class="op">)</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Person person<span class="op">;</span></span></code></pre></div>
<p>此时生成的建表语句只在关系维护方的表中有外键</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a>        address_id <span class="dt">integer</span>,</span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb249-18"><a href="#cb249-18" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb249-19"><a href="#cb249-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb249-20"><a href="#cb249-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> Person </span>
<span id="cb249-21"><a href="#cb249-21" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK6i7nduc8blbwp1dbfwavvnvvx </span>
<span id="cb249-22"><a href="#cb249-22" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (address_id) </span>
<span id="cb249-23"><a href="#cb249-23" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Address (<span class="kw">id</span>)</span></code></pre></div>
<p><strong>cascade</strong></p>
<p><code>cascade</code>:
级联，<code>CascadeType.ALL</code>只能写在关系的维护端(one)（否则比如拆迁时，address没了，结果把person也删了），如果实体中含有另一实体的引用，当当前实体更改时是否要同步更改另一实体，可以指定具体哪些更改操作需要同步更改，可选值有</p>
<ul>
<li>ALL: 级联所有实体状态转换</li>
<li>PERSIST: 级联实体持久化操作</li>
<li>MERGE: 级联实体合并操作</li>
<li>REMOVE: 级联实体删除操作</li>
<li>REFRESH: 级联实体刷新操作</li>
<li>DETACH: 级联实体分离操作</li>
</ul>
<p>关于实体状态转换：新建的对象为瞬态（或临时态），保存后或从数据库中查询出来为持久态。区分这两个状态的依据是实体是否有OID，OID就是表的主键值，只有当拥有OID时才是持久态（手动设置无效，因为主键是由框架维护的，我们不应该手动设置；即使我们手动设置了OID，也不是持久态）</p>
<p>在Hibernate中，除了上面两个状态，还有游离态，即对象拥有OID，但是由于session关闭，实体的缓存和快照（在Hibernate中，所有查询出来的对象都会被缓存到实体缓存和快照两个区域，当实体缓存做过更改，在session关闭时会判断实体缓存和快照是否一致，如果不一致，则执行更新操作，这就是为什么Hibernate可以在我们set持久态的实体属性时能够更新数据库的原因）都被清空了，即使拥有OID，也无法知道是否为持久态</p>
<p>比如没有配置级联</p>
<p>Person.java中：</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="co">//不配置级联(cascade = CascadeType.ALL)</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">,</span> referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Address address<span class="op">;</span></span></code></pre></div>
<p>Address.java中：</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;address&quot;</span><span class="op">)</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Person person<span class="op">;</span></span></code></pre></div>
<p>那么如果在插入时没有保存address</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>Person person <span class="op">=</span> <span class="kw">new</span> <span class="fu">Person</span><span class="op">();</span><span class="co">//新建的对象为瞬态</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setName</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>Address address <span class="op">=</span> <span class="kw">new</span> <span class="fu">Address</span><span class="op">();</span><span class="co">//瞬态</span></span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>address<span class="op">.</span><span class="fu">setCountry</span><span class="op">(</span><span class="st">&quot;China&quot;</span><span class="op">);</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setAddress</span><span class="op">(</span>address<span class="op">);</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a><span class="co">//没有保存address</span></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a><span class="co">//addressDao.save(address);</span></span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>personDao<span class="op">.</span><span class="fu">save</span><span class="op">(</span>person<span class="op">);</span><span class="co">//保存后变为持久态</span></span></code></pre></div>
<p>会报错：save the transient instance before
flushing，因为person的外键指向了一个瞬态对象</p>
<p>除非我们手动把address保存一下</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>Person person <span class="op">=</span> <span class="kw">new</span> <span class="fu">Person</span><span class="op">();</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setName</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>Address address <span class="op">=</span> <span class="kw">new</span> <span class="fu">Address</span><span class="op">();</span></span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>address<span class="op">.</span><span class="fu">setCountry</span><span class="op">(</span><span class="st">&quot;China&quot;</span><span class="op">);</span></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setAddress</span><span class="op">(</span>address<span class="op">);</span></span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a><span class="co">//要注意保存的顺序，当前外键存在于Person表中，所以要先存address，后存person，如果顺序颠倒，会报错：save the transient instance before flushing</span></span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>addressDao<span class="op">.</span><span class="fu">save</span><span class="op">(</span>address<span class="op">);</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>personDao<span class="op">.</span><span class="fu">save</span><span class="op">(</span>person<span class="op">);</span></span></code></pre></div>
<p>当我们配置了级联</p>
<p>Person.java中：</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="at">@OneToOne</span><span class="op">(</span>cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">)</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a><span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">,</span> referencedColumnName <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> Address address<span class="op">;</span></span></code></pre></div>
<p>此时即使不保存address，也能保存成功</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>Person person <span class="op">=</span> <span class="kw">new</span> <span class="fu">Person</span><span class="op">();</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setName</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>Address address <span class="op">=</span> <span class="kw">new</span> <span class="fu">Address</span><span class="op">();</span></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>address<span class="op">.</span><span class="fu">setCountry</span><span class="op">(</span><span class="st">&quot;China&quot;</span><span class="op">);</span></span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>person<span class="op">.</span><span class="fu">setAddress</span><span class="op">(</span>address<span class="op">);</span></span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a><span class="co">//配置了级联，不需要手动保存address</span></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a><span class="co">//addressDao.save(address);</span></span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>personDao<span class="op">.</span><span class="fu">save</span><span class="op">(</span>person<span class="op">);</span></span></code></pre></div>
<p><strong>optional</strong></p>
<p><code>optional</code>:
为false时表明该参数不是可选的，即必须填入，不能为空</p>
<h4 id="一对多和多对一">一对多和多对一</h4>
<p>一对多多对一 一般是同时使用的，即双向包含</p>
<p>假设我们的person突然发财了，买了两套房子，这时一个person对应多个address（一对多），多个address可能对应同一个person（多对一）。当然，如果不需要双向包含的话，可以把任意一方的对应属性删掉，变为单向关系</p>
<p>简单地说，就是如果你所需的是一个POJO，那么就是ManyToOne，如果所需的是一个List或Set，那么就是OneToMany</p>
<p>首先要明确的是，外键应该设置在多(many)的一方，而不是一(one)的一方，那么既然确定了<code>@JoinColumn</code>，那么另一方就要使用<code>mappedBy</code>了</p>
<p>Person.java</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Person <span class="op">{</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">)</span></span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一般person决定买房和卖房，所以mappedBy应该是person</span></span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//可能address有很多，一次性加载会占很多内存，使用使用懒加载</span></span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@LazyCollection</span><span class="op">(</span>LazyCollectionOption<span class="op">.</span><span class="fu">EXTRA</span><span class="op">)</span></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OneToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;person&quot;</span><span class="op">,</span> cascade <span class="op">=</span> CascadeType<span class="op">.</span><span class="fu">ALL</span><span class="op">,</span> fetch <span class="op">=</span> FetchType<span class="op">.</span><span class="fu">LAZY</span><span class="op">)</span></span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">//因为ArrayList有默认初始容量10，如果直接new，会导致浪费内存，需要设置初始容量为0</span></span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>Address<span class="op">&gt;</span> address  <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb256-17"><a href="#cb256-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-18"><a href="#cb256-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">//set或者list一般不在toString中输出</span></span>
<span id="cb256-19"><a href="#cb256-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb256-20"><a href="#cb256-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb256-21"><a href="#cb256-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Person{&quot;</span> <span class="op">+</span></span>
<span id="cb256-22"><a href="#cb256-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;id=&quot;</span> <span class="op">+</span> id <span class="op">+</span></span>
<span id="cb256-23"><a href="#cb256-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;, name=&#39;&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="op">+</span></span>
<span id="cb256-24"><a href="#cb256-24" aria-hidden="true" tabindex="-1"></a>                <span class="ch">&#39;}&#39;</span><span class="op">;</span></span>
<span id="cb256-25"><a href="#cb256-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb256-26"><a href="#cb256-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-27"><a href="#cb256-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">//省略空构造器及get、set</span></span>
<span id="cb256-28"><a href="#cb256-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb256-29"><a href="#cb256-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Address.java</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Address <span class="op">{</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;country&quot;</span><span class="op">)</span></span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> country<span class="op">;</span></span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;city&quot;</span><span class="op">)</span></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> city<span class="op">;</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;street&quot;</span><span class="op">)</span></span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> street<span class="op">;</span></span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToOne</span><span class="op">(</span>cascade <span class="op">=</span> <span class="op">{</span>CascadeType<span class="op">.</span><span class="fu">MERGE</span><span class="op">,</span> CascadeType<span class="op">.</span><span class="fu">REFRESH</span><span class="op">},</span> optional <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">//设置在address表中的关联字段(外键)</span></span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;person_id&quot;</span><span class="op">)</span></span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> Person person<span class="op">;</span></span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-22"><a href="#cb257-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb257-23"><a href="#cb257-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb257-24"><a href="#cb257-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;Address{&quot;</span> <span class="op">+</span></span>
<span id="cb257-25"><a href="#cb257-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;id=&quot;</span> <span class="op">+</span> id <span class="op">+</span></span>
<span id="cb257-26"><a href="#cb257-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;, country=&#39;&quot;</span> <span class="op">+</span> country <span class="op">+</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="op">+</span></span>
<span id="cb257-27"><a href="#cb257-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;, city=&#39;&quot;</span> <span class="op">+</span> city <span class="op">+</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="op">+</span></span>
<span id="cb257-28"><a href="#cb257-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;, street=&#39;&quot;</span> <span class="op">+</span> street <span class="op">+</span> <span class="ch">&#39;\&#39;&#39;</span> <span class="op">+</span></span>
<span id="cb257-29"><a href="#cb257-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;, person=&quot;</span> <span class="op">+</span> person <span class="op">+</span></span>
<span id="cb257-30"><a href="#cb257-30" aria-hidden="true" tabindex="-1"></a>                <span class="ch">&#39;}&#39;</span><span class="op">;</span></span>
<span id="cb257-31"><a href="#cb257-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb257-32"><a href="#cb257-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-33"><a href="#cb257-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb257-34"><a href="#cb257-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>生成的SQL</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>        person_id <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb258-11"><a href="#cb258-11" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb258-12"><a href="#cb258-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb258-13"><a href="#cb258-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb258-14"><a href="#cb258-14" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb258-15"><a href="#cb258-15" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb258-16"><a href="#cb258-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb258-17"><a href="#cb258-17" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb258-18"><a href="#cb258-18" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb258-19"><a href="#cb258-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb258-20"><a href="#cb258-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> Address </span>
<span id="cb258-21"><a href="#cb258-21" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FKdu13rl17o4h24m9gt7b2bdobo </span>
<span id="cb258-22"><a href="#cb258-22" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (person_id) </span>
<span id="cb258-23"><a href="#cb258-23" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Person (<span class="kw">id</span>)</span></code></pre></div>
<h4 id="多对多">多对多</h4>
<p>多对多就一定要使用中间表实现了</p>
<p>假设我们的person是租的房子，和别一起合租，这时多个person可以对应一个address，而且一个address可以对应多个person，这就构成了多对多</p>
<p>多对多关系中一般不设置级联保存、级联删除、级联更新等操作（因为中间可能涉及到很多表，配置会很复杂）</p>
<p>Person.java</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Person <span class="op">{</span></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;name&quot;</span><span class="op">)</span></span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToMany</span></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JoinTable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;person_address&quot;</span><span class="op">,</span></span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>            joinColumns <span class="op">=</span> <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;person_id&quot;</span><span class="op">),</span></span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>            inverseJoinColumns <span class="op">=</span> <span class="at">@JoinColumn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;address_id&quot;</span><span class="op">))</span></span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>Address<span class="op">&gt;</span> addressList <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Address.java</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Entity</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Address <span class="op">{</span></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GeneratedValue</span><span class="op">(</span>strategy <span class="op">=</span> GenerationType<span class="op">.</span><span class="fu">IDENTITY</span><span class="op">)</span></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> id<span class="op">;</span></span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;country&quot;</span><span class="op">)</span></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> country<span class="op">;</span></span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;city&quot;</span><span class="op">)</span></span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> city<span class="op">;</span></span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Column</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;street&quot;</span><span class="op">)</span></span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> street<span class="op">;</span></span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-17"><a href="#cb260-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ManyToMany</span><span class="op">(</span>mappedBy <span class="op">=</span> <span class="st">&quot;addressList&quot;</span><span class="op">)</span></span>
<span id="cb260-18"><a href="#cb260-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">List</span><span class="op">&lt;</span>Person<span class="op">&gt;</span> personList <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb260-19"><a href="#cb260-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-20"><a href="#cb260-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb260-21"><a href="#cb260-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>生成的SQL</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Address (</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>        city <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>        country <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>        street <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb261-12"><a href="#cb261-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> Person (</span>
<span id="cb261-13"><a href="#cb261-13" aria-hidden="true" tabindex="-1"></a>       <span class="kw">id</span> <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> auto_increment,</span>
<span id="cb261-14"><a href="#cb261-14" aria-hidden="true" tabindex="-1"></a>        name <span class="dt">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb261-15"><a href="#cb261-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">primary</span> <span class="kw">key</span> (<span class="kw">id</span>)</span>
<span id="cb261-16"><a href="#cb261-16" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb261-17"><a href="#cb261-17" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb261-18"><a href="#cb261-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb261-19"><a href="#cb261-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">create</span> <span class="kw">table</span> person_address (</span>
<span id="cb261-20"><a href="#cb261-20" aria-hidden="true" tabindex="-1"></a>       person_id <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb261-21"><a href="#cb261-21" aria-hidden="true" tabindex="-1"></a>        address_id <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span></span>
<span id="cb261-22"><a href="#cb261-22" aria-hidden="true" tabindex="-1"></a>    ) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8</span>
<span id="cb261-23"><a href="#cb261-23" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb261-24"><a href="#cb261-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb261-25"><a href="#cb261-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> person_address </span>
<span id="cb261-26"><a href="#cb261-26" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK5gaighxlfytjmaiy4xrma2sev </span>
<span id="cb261-27"><a href="#cb261-27" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (address_id) </span>
<span id="cb261-28"><a href="#cb261-28" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Address (<span class="kw">id</span>)</span>
<span id="cb261-29"><a href="#cb261-29" aria-hidden="true" tabindex="-1"></a>Hibernate: </span>
<span id="cb261-30"><a href="#cb261-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb261-31"><a href="#cb261-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">alter</span> <span class="kw">table</span> person_address </span>
<span id="cb261-32"><a href="#cb261-32" aria-hidden="true" tabindex="-1"></a>       <span class="kw">add</span> <span class="kw">constraint</span> FK83s2b7rjpq74x0sebtccprse1 </span>
<span id="cb261-33"><a href="#cb261-33" aria-hidden="true" tabindex="-1"></a>       <span class="kw">foreign</span> <span class="kw">key</span> (person_id) </span>
<span id="cb261-34"><a href="#cb261-34" aria-hidden="true" tabindex="-1"></a>       <span class="kw">references</span> Person (<span class="kw">id</span>)</span></code></pre></div>
<h2 id="redis">Redis</h2>
<p><a href="http://www.redis.cn/download.html">中文官网下载地址</a></p>
<p><a href="http://doc.redisfans.com/">命令参考</a></p>
<p>Redis是一个内存数据结构存储系统，可用作数据库、缓存和消息中间件</p>
<p>Redis是单线程的，但它因为避免了频繁的加锁解锁以及处理复杂的并发问题，所以它的效率也很高</p>
<p>应用场景：</p>
<ol type="1">
<li>数据库缓存（配合Spring Cache注解使用）</li>
<li>分布式session；任务队列（list数据类型实现FIFO队列，代码中定时获取任务队列信息）</li>
<li>秒杀倒计时（过期时间=当前时间+抢购时间，通过TTL命令获得剩余时间）</li>
<li>秒杀（decr命令，每次-1，如果得到的不是负数，则抢到商品，创建订单）</li>
<li>分布式自增长id（incr命令，不过一般使用MyCat全局序列号或者snowflake等技术生成）</li>
<li>解决用户连续快速点击导致的重复提交问题（创建一个过期时间比较短的key，该key格式为默认前缀:用户的token:方法名:参数，通过AOP对有没有该key进行检测，有就拦截）</li>
</ol>
<h3 id="安装">安装</h3>
<p>进入解压目录，执行</p>
<pre class="shell"><code>make
cd src
make install PREFIX=/opt/redis</code></pre>
<p>缺少什么就根据提示下载即可</p>
<h3 id="配置">配置</h3>
<p>配置文件详解</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="co">#redis.conf</span></span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Redis configuration file example.</span></span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ./redis-server /path/to/redis.conf</span></span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a><span class="co">################################## INCLUDES ###################################</span></span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a><span class="co">#这在你有标准配置模板但是每个redis服务器又需要个性设置的时候很有用。</span></span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a><span class="co"># include /path/to/local.conf</span></span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a><span class="co"># include /path/to/other.conf</span></span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a><span class="co">################################ GENERAL #####################################</span></span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a><span class="co">#是否在后台执行，yes：后台运行；no：不是后台运行（老版本默认）</span></span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a><span class="dt">daemonize yes</span></span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span><span class="co">#3.2里的参数，是否开启保护模式，默认开启。要是配置里没有指定bind和密码。开启该参数后，redis只会本地进行访问，拒绝外部访问。要是开启了密码   和bind，可以开启。否   则最好关闭，设置为no。</span></span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a><span class="dt">protected-mode yes</span></span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a><span class="co">#redis的进程文件</span></span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a><span class="dt">pidfile /var/run/redis/redis-server.pid</span></span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-20"><a href="#cb263-20" aria-hidden="true" tabindex="-1"></a><span class="co">#redis监听的端口号。</span></span>
<span id="cb263-21"><a href="#cb263-21" aria-hidden="true" tabindex="-1"></a><span class="dt">port 6379</span></span>
<span id="cb263-22"><a href="#cb263-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-23"><a href="#cb263-23" aria-hidden="true" tabindex="-1"></a><span class="co">#此参数确定了TCP连接中已完成队列(完成三次握手之后)的长度， 当然此值必须不大于Linux系统定义的/proc/sys/net/core/somaxconn值，默认是511，而Linux的默认参数值是128。当系统并发量大并且客户端速度缓慢的时候，可以将这二个参数一起参考设定。该内核参数默认值一般是128，对于负载很大的服务程序来说大大的不够。一般会将它修改为2048或者更大。在/etc/sysctl.conf中添加:net.core.somaxconn = 2048，然后在终端中执行sysctl -p。</span></span>
<span id="cb263-24"><a href="#cb263-24" aria-hidden="true" tabindex="-1"></a><span class="dt">tcp-backlog 511</span></span>
<span id="cb263-25"><a href="#cb263-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-26"><a href="#cb263-26" aria-hidden="true" tabindex="-1"></a><span class="co">#指定 redis 只接收来自于该 IP 地址的请求，如果不进行设置，那么将处理所有请求</span></span>
<span id="cb263-27"><a href="#cb263-27" aria-hidden="true" tabindex="-1"></a><span class="dt">bind 127.0.0.1</span></span>
<span id="cb263-28"><a href="#cb263-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-29"><a href="#cb263-29" aria-hidden="true" tabindex="-1"></a><span class="co">#配置unix socket来让redis支持监听本地连接。</span></span>
<span id="cb263-30"><a href="#cb263-30" aria-hidden="true" tabindex="-1"></a><span class="co"># unixsocket /var/run/redis/redis.sock</span></span>
<span id="cb263-31"><a href="#cb263-31" aria-hidden="true" tabindex="-1"></a><span class="co">#配置unix socket使用文件的权限</span></span>
<span id="cb263-32"><a href="#cb263-32" aria-hidden="true" tabindex="-1"></a><span class="co"># unixsocketperm 700</span></span>
<span id="cb263-33"><a href="#cb263-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-34"><a href="#cb263-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 此参数为设置客户端空闲超过timeout，服务端会断开连接，为0则服务端不会主动断开连接，不能小于0。</span></span>
<span id="cb263-35"><a href="#cb263-35" aria-hidden="true" tabindex="-1"></a><span class="dt">timeout 0</span></span>
<span id="cb263-36"><a href="#cb263-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-37"><a href="#cb263-37" aria-hidden="true" tabindex="-1"></a><span class="co">#tcp keepalive参数。如果设置不为0，就使用配置tcp的SO_KEEPALIVE值，使用keepalive有两个好处:检测挂掉的对端。降低中间设备出问题而导致网络看似连接却已经与对端端口的问题。在Linux内核中，设置了keepalive，redis会定时给对端发送ack。检测到对端关闭需要两倍的设置值。</span></span>
<span id="cb263-38"><a href="#cb263-38" aria-hidden="true" tabindex="-1"></a><span class="dt">tcp-keepalive 0</span></span>
<span id="cb263-39"><a href="#cb263-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-40"><a href="#cb263-40" aria-hidden="true" tabindex="-1"></a><span class="co">#指定了服务端日志的级别。级别包括：debug（很多信息，方便开发、测试），verbose（许多有用的信息，但是没有debug级别信息多），notice（适当的日志级别，适合生产环境），warn（只有非常重要的信息）</span></span>
<span id="cb263-41"><a href="#cb263-41" aria-hidden="true" tabindex="-1"></a><span class="dt">loglevel notice</span></span>
<span id="cb263-42"><a href="#cb263-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-43"><a href="#cb263-43" aria-hidden="true" tabindex="-1"></a><span class="co">#指定了记录日志的文件。空字符串的话，日志会打印到标准输出设备。后台运行的redis标准输出是/dev/null。</span></span>
<span id="cb263-44"><a href="#cb263-44" aria-hidden="true" tabindex="-1"></a><span class="dt">logfile /var/log/redis/redis-server.log</span></span>
<span id="cb263-45"><a href="#cb263-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-46"><a href="#cb263-46" aria-hidden="true" tabindex="-1"></a><span class="co">#是否打开记录syslog功能</span></span>
<span id="cb263-47"><a href="#cb263-47" aria-hidden="true" tabindex="-1"></a><span class="co"># syslog-enabled no</span></span>
<span id="cb263-48"><a href="#cb263-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-49"><a href="#cb263-49" aria-hidden="true" tabindex="-1"></a><span class="co">#syslog的标识符。</span></span>
<span id="cb263-50"><a href="#cb263-50" aria-hidden="true" tabindex="-1"></a><span class="co"># syslog-ident redis</span></span>
<span id="cb263-51"><a href="#cb263-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-52"><a href="#cb263-52" aria-hidden="true" tabindex="-1"></a><span class="co">#日志的来源、设备</span></span>
<span id="cb263-53"><a href="#cb263-53" aria-hidden="true" tabindex="-1"></a><span class="co"># syslog-facility local0</span></span>
<span id="cb263-54"><a href="#cb263-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-55"><a href="#cb263-55" aria-hidden="true" tabindex="-1"></a><span class="co">#数据库的数量，默认使用的数据库是DB 0。可以通过”SELECT “命令选择一个db</span></span>
<span id="cb263-56"><a href="#cb263-56" aria-hidden="true" tabindex="-1"></a><span class="dt">databases 16</span></span>
<span id="cb263-57"><a href="#cb263-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-58"><a href="#cb263-58" aria-hidden="true" tabindex="-1"></a><span class="co">################################ SNAPSHOTTING ################################</span></span>
<span id="cb263-59"><a href="#cb263-59" aria-hidden="true" tabindex="-1"></a><span class="co"># 快照配置</span></span>
<span id="cb263-60"><a href="#cb263-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 注释掉“save”这一行配置项就可以让保存数据库功能失效</span></span>
<span id="cb263-61"><a href="#cb263-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置sedis进行数据库镜像的频率。</span></span>
<span id="cb263-62"><a href="#cb263-62" aria-hidden="true" tabindex="-1"></a><span class="co"># 900秒（15分钟）内至少1个key值改变（则进行数据库保存--持久化） </span></span>
<span id="cb263-63"><a href="#cb263-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 300秒（5分钟）内至少10个key值改变（则进行数据库保存--持久化） </span></span>
<span id="cb263-64"><a href="#cb263-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 60秒（1分钟）内至少10000个key值改变（则进行数据库保存--持久化）</span></span>
<span id="cb263-65"><a href="#cb263-65" aria-hidden="true" tabindex="-1"></a><span class="dt">save 900 1</span></span>
<span id="cb263-66"><a href="#cb263-66" aria-hidden="true" tabindex="-1"></a><span class="dt">save 300 10</span></span>
<span id="cb263-67"><a href="#cb263-67" aria-hidden="true" tabindex="-1"></a><span class="dt">save 60 10000</span></span>
<span id="cb263-68"><a href="#cb263-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-69"><a href="#cb263-69" aria-hidden="true" tabindex="-1"></a><span class="co">#当RDB持久化出现错误后，是否依然进行继续进行工作，yes：不能进行工作，no：可以继续进行工作，可以通过info中的rdb_last_bgsave_status了解RDB持久化是否有错误</span></span>
<span id="cb263-70"><a href="#cb263-70" aria-hidden="true" tabindex="-1"></a><span class="dt">stop-writes-on-bgsave-error yes</span></span>
<span id="cb263-71"><a href="#cb263-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-72"><a href="#cb263-72" aria-hidden="true" tabindex="-1"></a><span class="co">#使用压缩rdb文件，rdb文件压缩使用LZF压缩算法，yes：压缩，但是需要一些cpu的消耗。no：不压缩，需要更多的磁盘空间</span></span>
<span id="cb263-73"><a href="#cb263-73" aria-hidden="true" tabindex="-1"></a><span class="dt">rdbcompression yes</span></span>
<span id="cb263-74"><a href="#cb263-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-75"><a href="#cb263-75" aria-hidden="true" tabindex="-1"></a><span class="co">#是否校验rdb文件。从rdb格式的第五个版本开始，在rdb文件的末尾会带上CRC64的校验和。这跟有利于文件的容错性，但是在保存rdb文件的时候，会有大概10%的性能损耗，所以如果你追求高性能，可以关闭该配置。</span></span>
<span id="cb263-76"><a href="#cb263-76" aria-hidden="true" tabindex="-1"></a><span class="dt">rdbchecksum yes</span></span>
<span id="cb263-77"><a href="#cb263-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-78"><a href="#cb263-78" aria-hidden="true" tabindex="-1"></a><span class="co">#rdb文件的名称</span></span>
<span id="cb263-79"><a href="#cb263-79" aria-hidden="true" tabindex="-1"></a><span class="dt">dbfilename dump.rdb</span></span>
<span id="cb263-80"><a href="#cb263-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-81"><a href="#cb263-81" aria-hidden="true" tabindex="-1"></a><span class="co">#数据目录，数据库的写入会在这个目录。rdb、aof文件也会写在这个目录</span></span>
<span id="cb263-82"><a href="#cb263-82" aria-hidden="true" tabindex="-1"></a><span class="dt">dir /var/lib/redis</span></span>
<span id="cb263-83"><a href="#cb263-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-84"><a href="#cb263-84" aria-hidden="true" tabindex="-1"></a><span class="co">################################# REPLICATION #################################</span></span>
<span id="cb263-85"><a href="#cb263-85" aria-hidden="true" tabindex="-1"></a><span class="co">#复制选项，slave复制对应的master。</span></span>
<span id="cb263-86"><a href="#cb263-86" aria-hidden="true" tabindex="-1"></a><span class="co"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span></span>
<span id="cb263-87"><a href="#cb263-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-88"><a href="#cb263-88" aria-hidden="true" tabindex="-1"></a><span class="co">#如果master设置了requirepass，那么slave要连上master，需要有master的密码才行。masterauth就是用来配置master的密码，这样可以在连上master后进行认证。</span></span>
<span id="cb263-89"><a href="#cb263-89" aria-hidden="true" tabindex="-1"></a><span class="co"># masterauth &lt;master-password&gt;</span></span>
<span id="cb263-90"><a href="#cb263-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-91"><a href="#cb263-91" aria-hidden="true" tabindex="-1"></a><span class="co">#当从库同主机失去连接或者复制正在进行，从机库有两种运行方式：1) 如果slave-serve-stale-data设置为yes(默认设置)，从库会继续响应客户端的请求。2) 如果slave-serve-stale-data设置为no，除去INFO和SLAVOF命令之外的任何请求都会返回一个错误”SYNC with master in progress”。</span></span>
<span id="cb263-92"><a href="#cb263-92" aria-hidden="true" tabindex="-1"></a><span class="dt">slave-serve-stale-data yes</span></span>
<span id="cb263-93"><a href="#cb263-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-94"><a href="#cb263-94" aria-hidden="true" tabindex="-1"></a><span class="co">#作为从服务器，默认情况下是只读的（yes），可以修改成NO，用于写（不建议）。</span></span>
<span id="cb263-95"><a href="#cb263-95" aria-hidden="true" tabindex="-1"></a><span class="dt">slave-read-only yes</span></span>
<span id="cb263-96"><a href="#cb263-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-97"><a href="#cb263-97" aria-hidden="true" tabindex="-1"></a><span class="co">#是否使用socket方式复制数据。目前redis复制提供两种方式，disk和socket。如果新的slave连上来或者重连的slave无法部分同步，就会执行全量同步，master会生成rdb文件。有2种方式：disk方式是master创建一个新的进程把rdb文件保存到磁盘，再把磁盘上的rdb文件传递给slave。socket是master创建一个新的进程，直接把rdb文件以socket的方式发给slave。disk方式的时候，当一个rdb保存的过程中，多个slave都能共享这个rdb文件。socket的方式就的一个个slave顺序复制。在磁盘速度缓慢，网速快的情况下推荐用socket方式。</span></span>
<span id="cb263-98"><a href="#cb263-98" aria-hidden="true" tabindex="-1"></a><span class="dt">repl-diskless-sync no</span></span>
<span id="cb263-99"><a href="#cb263-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-100"><a href="#cb263-100" aria-hidden="true" tabindex="-1"></a><span class="co">#diskless复制的延迟时间，防止设置为0。一旦复制开始，节点不会再接收新slave的复制请求直到下一个rdb传输。所以最好等待一段时间，等更多的slave连上来。</span></span>
<span id="cb263-101"><a href="#cb263-101" aria-hidden="true" tabindex="-1"></a><span class="dt">repl-diskless-sync-delay 5</span></span>
<span id="cb263-102"><a href="#cb263-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-103"><a href="#cb263-103" aria-hidden="true" tabindex="-1"></a><span class="co">#slave根据指定的时间间隔向服务器发送ping请求。时间间隔可以通过 repl_ping_slave_period 来设置，默认10秒。</span></span>
<span id="cb263-104"><a href="#cb263-104" aria-hidden="true" tabindex="-1"></a><span class="co"># repl-ping-slave-period 10</span></span>
<span id="cb263-105"><a href="#cb263-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-106"><a href="#cb263-106" aria-hidden="true" tabindex="-1"></a><span class="co">#复制连接超时时间。master和slave都有超时时间的设置。master检测到slave上次发送的时间超过repl-timeout，即认为slave离线，清除该slave信息。slave检测到上次和master交互的时间超过repl-timeout，则认为master离线。需要注意的是repl-timeout需要设置一个比repl-ping-slave-period更大的值，不然会经常检测到超时。</span></span>
<span id="cb263-107"><a href="#cb263-107" aria-hidden="true" tabindex="-1"></a><span class="co"># repl-timeout 60</span></span>
<span id="cb263-108"><a href="#cb263-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-109"><a href="#cb263-109" aria-hidden="true" tabindex="-1"></a><span class="co">#是否禁止复制tcp链接的tcp nodelay参数，可传递yes或者no。默认是no，即使用tcp nodelay。如果master设置了yes来禁止tcp nodelay设置，在把数据复制给slave的时候，会减少包的数量和更小的网络带宽。但是这也可能带来数据的延迟。默认我们推荐更小的延迟，但是在数据量传输很大的场景下，建议选择yes。</span></span>
<span id="cb263-110"><a href="#cb263-110" aria-hidden="true" tabindex="-1"></a><span class="dt">repl-disable-tcp-nodelay no</span></span>
<span id="cb263-111"><a href="#cb263-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-112"><a href="#cb263-112" aria-hidden="true" tabindex="-1"></a><span class="co">#复制缓冲区大小，这是一个环形复制缓冲区，用来保存最新复制的命令。这样在slave离线的时候，不需要完全复制master的数据，如果可以执行部分同步，只需要把缓冲区的部分数据复制给slave，就能恢复正常复制状态。缓冲区的大小越大，slave离线的时间可以更长，复制缓冲区只有在有slave连接的时候才分配内存。没有slave的一段时间，内存会被释放出来，默认1m。</span></span>
<span id="cb263-113"><a href="#cb263-113" aria-hidden="true" tabindex="-1"></a><span class="co"># repl-backlog-size 5mb</span></span>
<span id="cb263-114"><a href="#cb263-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-115"><a href="#cb263-115" aria-hidden="true" tabindex="-1"></a><span class="co">#master没有slave一段时间会释放复制缓冲区的内存，repl-backlog-ttl用来设置该时间长度。单位为秒。</span></span>
<span id="cb263-116"><a href="#cb263-116" aria-hidden="true" tabindex="-1"></a><span class="co"># repl-backlog-ttl 3600</span></span>
<span id="cb263-117"><a href="#cb263-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-118"><a href="#cb263-118" aria-hidden="true" tabindex="-1"></a><span class="co">#当master不可用，Sentinel会根据slave的优先级选举一个master。最低的优先级的slave，当选master。而配置成0，永远不会被选举。</span></span>
<span id="cb263-119"><a href="#cb263-119" aria-hidden="true" tabindex="-1"></a><span class="dt">slave-priority 100</span></span>
<span id="cb263-120"><a href="#cb263-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-121"><a href="#cb263-121" aria-hidden="true" tabindex="-1"></a><span class="co">#redis提供了可以让master停止写入的方式，如果配置了min-slaves-to-write，健康的slave的个数小于N，mater就禁止写入。master最少得有多少个健康的slave存活才能执行写命令。这个配置虽然不能保证N个slave都一定能接收到master的写操作，但是能避免没有足够健康的slave的时候，master不能写入来避免数据丢失。设置为0是关闭该功能。</span></span>
<span id="cb263-122"><a href="#cb263-122" aria-hidden="true" tabindex="-1"></a><span class="co"># min-slaves-to-write 3</span></span>
<span id="cb263-123"><a href="#cb263-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-124"><a href="#cb263-124" aria-hidden="true" tabindex="-1"></a><span class="co">#延迟小于min-slaves-max-lag秒的slave才认为是健康的slave。</span></span>
<span id="cb263-125"><a href="#cb263-125" aria-hidden="true" tabindex="-1"></a><span class="co"># min-slaves-max-lag 10</span></span>
<span id="cb263-126"><a href="#cb263-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-127"><a href="#cb263-127" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置1或另一个设置为0禁用这个特性。</span></span>
<span id="cb263-128"><a href="#cb263-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting one or the other to 0 disables the feature.</span></span>
<span id="cb263-129"><a href="#cb263-129" aria-hidden="true" tabindex="-1"></a><span class="co"># By default min-slaves-to-write is set to 0 (feature disabled) and</span></span>
<span id="cb263-130"><a href="#cb263-130" aria-hidden="true" tabindex="-1"></a><span class="co"># min-slaves-max-lag is set to 10.</span></span>
<span id="cb263-131"><a href="#cb263-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-132"><a href="#cb263-132" aria-hidden="true" tabindex="-1"></a><span class="co">################################## </span><span class="al">SECURITY</span><span class="co"> ###################################</span></span>
<span id="cb263-133"><a href="#cb263-133" aria-hidden="true" tabindex="-1"></a><span class="co">#requirepass配置可以让用户使用AUTH命令来认证密码，才能使用其他命令。这让redis可以使用在不受信任的网络中。为了保持向后的兼容性，可以注释该命令，因为大部分用户也不需要认证。使用requirepass的时候需要注意，因为redis太快了，每秒可以认证15w次密码，简单的密码很容易被攻破，所以最好使用一个更复杂的密码。</span></span>
<span id="cb263-134"><a href="#cb263-134" aria-hidden="true" tabindex="-1"></a><span class="co"># requirepass foobared</span></span>
<span id="cb263-135"><a href="#cb263-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-136"><a href="#cb263-136" aria-hidden="true" tabindex="-1"></a><span class="co">#把危险的命令给修改成其他名称。比如CONFIG命令可以重命名为一个很难被猜到的命令，这样用户不能使用，而内部工具还能接着使用。</span></span>
<span id="cb263-137"><a href="#cb263-137" aria-hidden="true" tabindex="-1"></a><span class="co"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></span>
<span id="cb263-138"><a href="#cb263-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-139"><a href="#cb263-139" aria-hidden="true" tabindex="-1"></a><span class="co">#设置成一个空的值，可以禁止一个命令</span></span>
<span id="cb263-140"><a href="#cb263-140" aria-hidden="true" tabindex="-1"></a><span class="co"># rename-command CONFIG &quot;&quot;</span></span>
<span id="cb263-141"><a href="#cb263-141" aria-hidden="true" tabindex="-1"></a><span class="co">################################### LIMITS ####################################</span></span>
<span id="cb263-142"><a href="#cb263-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-143"><a href="#cb263-143" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置能连上redis的最大客户端连接数量。默认是10000个客户端连接。由于redis不区分连接是客户端连接还是内部打开文件或者和slave连接等，所以maxclients最小建议设置到32。如果超过了maxclients，redis会给新的连接发送’max number of clients reached’，并关闭连接。</span></span>
<span id="cb263-144"><a href="#cb263-144" aria-hidden="true" tabindex="-1"></a><span class="co"># maxclients 10000</span></span>
<span id="cb263-145"><a href="#cb263-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-146"><a href="#cb263-146" aria-hidden="true" tabindex="-1"></a><span class="co">#redis配置的最大内存容量。当内存满了，需要配合maxmemory-policy策略进行处理。注意slave的输出缓冲区是不计算在maxmemory内的。所以为了防止主机内存使用完，建议设置的maxmemory需要更小一些。</span></span>
<span id="cb263-147"><a href="#cb263-147" aria-hidden="true" tabindex="-1"></a><span class="co"># maxmemory &lt;bytes&gt;</span></span>
<span id="cb263-148"><a href="#cb263-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-149"><a href="#cb263-149" aria-hidden="true" tabindex="-1"></a><span class="co">#内存容量超过maxmemory后的过期策略</span></span>
<span id="cb263-150"><a href="#cb263-150" aria-hidden="true" tabindex="-1"></a><span class="co">#volatile-lru：利用LRU算法移除设置过过期时间的key。</span></span>
<span id="cb263-151"><a href="#cb263-151" aria-hidden="true" tabindex="-1"></a><span class="co">#volatile-random：随机移除设置过过期时间的key。</span></span>
<span id="cb263-152"><a href="#cb263-152" aria-hidden="true" tabindex="-1"></a><span class="co">#volatile-ttl：移除即将过期的key，根据最近过期时间来删除（辅以TTL）</span></span>
<span id="cb263-153"><a href="#cb263-153" aria-hidden="true" tabindex="-1"></a><span class="co">#内存容量超过maxmemory后的淘汰策略</span></span>
<span id="cb263-154"><a href="#cb263-154" aria-hidden="true" tabindex="-1"></a><span class="co">#allkeys-lru：利用LRU算法移除任何key。</span></span>
<span id="cb263-155"><a href="#cb263-155" aria-hidden="true" tabindex="-1"></a><span class="co">#allkeys-random：随机移除任何key。</span></span>
<span id="cb263-156"><a href="#cb263-156" aria-hidden="true" tabindex="-1"></a><span class="co">#noeviction：不移除任何key，只是返回一个写错误。</span></span>
<span id="cb263-157"><a href="#cb263-157" aria-hidden="true" tabindex="-1"></a><span class="co">#上面的这些驱逐策略，如果redis没有合适的key驱逐，对于写命令，还是会返回错误。redis将不再接收写请求，只接收get请求。写命令包括：set setnx setex append incr decr rpush lpush rpushx lpushx linsert lset rpoplpush sadd sinter sinterstore sunion sunionstore sdiff sdiffstore zadd zincrby zunionstore zinterstore hset hsetnx hmset hincrby incrby decrby getset mset msetnx exec sort。</span></span>
<span id="cb263-158"><a href="#cb263-158" aria-hidden="true" tabindex="-1"></a><span class="co"># maxmemory-policy noeviction</span></span>
<span id="cb263-159"><a href="#cb263-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-160"><a href="#cb263-160" aria-hidden="true" tabindex="-1"></a><span class="co">#lru检测的样本数。使用lru或者ttl淘汰算法，从需要淘汰的列表中随机选择sample个key，选出闲置时间最长的key移除。</span></span>
<span id="cb263-161"><a href="#cb263-161" aria-hidden="true" tabindex="-1"></a><span class="co"># maxmemory-samples 5</span></span>
<span id="cb263-162"><a href="#cb263-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-163"><a href="#cb263-163" aria-hidden="true" tabindex="-1"></a><span class="co">############################## APPEND ONLY MODE ###############################</span></span>
<span id="cb263-164"><a href="#cb263-164" aria-hidden="true" tabindex="-1"></a><span class="co">#默认redis使用的是rdb方式持久化，这种方式在许多应用中已经足够用了。但是redis如果中途宕机，会导致可能有几分钟的数据丢失，根据save来策略进行持久化，Append Only File是另一种持久化方式，可以提供更好的持久化特性。Redis会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时Redis都会先把这个文件的数据读入内存里，先忽略RDB文件。</span></span>
<span id="cb263-165"><a href="#cb263-165" aria-hidden="true" tabindex="-1"></a><span class="dt">appendonly no</span></span>
<span id="cb263-166"><a href="#cb263-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-167"><a href="#cb263-167" aria-hidden="true" tabindex="-1"></a><span class="co">#aof文件名</span></span>
<span id="cb263-168"><a href="#cb263-168" aria-hidden="true" tabindex="-1"></a><span class="dt">appendfilename &quot;appendonly.aof&quot;</span></span>
<span id="cb263-169"><a href="#cb263-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-170"><a href="#cb263-170" aria-hidden="true" tabindex="-1"></a><span class="co">#aof持久化策略的配置</span></span>
<span id="cb263-171"><a href="#cb263-171" aria-hidden="true" tabindex="-1"></a><span class="co">#no表示不执行fsync，由操作系统保证数据同步到磁盘，速度最快。</span></span>
<span id="cb263-172"><a href="#cb263-172" aria-hidden="true" tabindex="-1"></a><span class="co">#always表示每次写入都执行fsync，以保证数据同步到磁盘。</span></span>
<span id="cb263-173"><a href="#cb263-173" aria-hidden="true" tabindex="-1"></a><span class="co">#everysec表示每秒执行一次fsync，可能会导致丢失这1s数据。</span></span>
<span id="cb263-174"><a href="#cb263-174" aria-hidden="true" tabindex="-1"></a><span class="dt">appendfsync everysec</span></span>
<span id="cb263-175"><a href="#cb263-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-176"><a href="#cb263-176" aria-hidden="true" tabindex="-1"></a><span class="co"># 在aof重写或者写入rdb文件的时候，会执行大量IO，此时对于everysec和always的aof模式来说，执行fsync会造成阻塞过长时间，no-appendfsync-on-rewrite字段设置为默认设置为no。如果对延迟要求很高的应用，这个字段可以设置为yes，否则还是设置为no，这样对持久化特性来说这是更安全的选择。设置为yes表示rewrite期间对新写操作不fsync,暂时存在内存中,等rewrite完成后再写入，默认为no，建议yes。Linux的默认fsync策略是30秒。可能丢失30秒数据。</span></span>
<span id="cb263-177"><a href="#cb263-177" aria-hidden="true" tabindex="-1"></a><span class="dt">no-appendfsync-on-rewrite no</span></span>
<span id="cb263-178"><a href="#cb263-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-179"><a href="#cb263-179" aria-hidden="true" tabindex="-1"></a><span class="co">#aof自动重写配置。当目前aof文件大小超过上一次重写的aof文件大小的百分之多少进行重写，即当aof文件增长到一定大小的时候Redis能够调用bgrewriteaof对日志文件进行重写。当前AOF文件大小是上次日志重写得到AOF文件大小的二倍（设置为100）时，自动启动新的日志重写过程。</span></span>
<span id="cb263-180"><a href="#cb263-180" aria-hidden="true" tabindex="-1"></a><span class="dt">auto-aof-rewrite-percentage 100</span></span>
<span id="cb263-181"><a href="#cb263-181" aria-hidden="true" tabindex="-1"></a><span class="co">#设置允许重写的最小aof文件大小，避免了达到约定百分比但尺寸仍然很小的情况还要重写</span></span>
<span id="cb263-182"><a href="#cb263-182" aria-hidden="true" tabindex="-1"></a><span class="dt">auto-aof-rewrite-min-size 64mb</span></span>
<span id="cb263-183"><a href="#cb263-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-184"><a href="#cb263-184" aria-hidden="true" tabindex="-1"></a><span class="co">#aof文件可能在尾部是不完整的，当redis启动的时候，aof文件的数据被载入内存。重启可能发生在redis所在的主机操作系统宕机后，尤其在ext4文件系统没有加上data=ordered选项（redis宕机或者异常终止不会造成尾部不完整现象。）出现这种现象，可以选择让redis退出，或者导入尽可能多的数据。如果选择的是yes，当截断的aof文件被导入的时候，会自动发布一个log给客户端然后load。如果是no，用户必须手动redis-check-aof修复AOF文件才可以。</span></span>
<span id="cb263-185"><a href="#cb263-185" aria-hidden="true" tabindex="-1"></a><span class="dt">aof-load-truncated yes</span></span>
<span id="cb263-186"><a href="#cb263-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-187"><a href="#cb263-187" aria-hidden="true" tabindex="-1"></a><span class="co">################################ LUA SCRIPTING ###############################</span></span>
<span id="cb263-188"><a href="#cb263-188" aria-hidden="true" tabindex="-1"></a><span class="co"># 如果达到最大时间限制（毫秒），redis会记个log，然后返回error。当一个脚本超过了最大时限。只有SCRIPT KILL和SHUTDOWN NOSAVE可以用。第一个可以杀没有调write命令的东西。要是已经调用了write，只能用第二个命令杀。</span></span>
<span id="cb263-189"><a href="#cb263-189" aria-hidden="true" tabindex="-1"></a><span class="dt">lua-time-limit 5000</span></span>
<span id="cb263-190"><a href="#cb263-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-191"><a href="#cb263-191" aria-hidden="true" tabindex="-1"></a><span class="co">################################ REDIS CLUSTER ###############################</span></span>
<span id="cb263-192"><a href="#cb263-192" aria-hidden="true" tabindex="-1"></a><span class="co">#集群开关，默认是不开启集群模式。</span></span>
<span id="cb263-193"><a href="#cb263-193" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-enabled yes</span></span>
<span id="cb263-194"><a href="#cb263-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-195"><a href="#cb263-195" aria-hidden="true" tabindex="-1"></a><span class="co">#集群配置文件的名称，每个节点都有一个集群相关的配置文件，持久化保存集群的信息。这个文件并不需要手动配置，这个配置文件有Redis生成并更新，每个Redis集群节点需要一个单独的配置文件，请确保与实例运行的系统中配置文件名称不冲突</span></span>
<span id="cb263-196"><a href="#cb263-196" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-config-file nodes-6379.conf</span></span>
<span id="cb263-197"><a href="#cb263-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-198"><a href="#cb263-198" aria-hidden="true" tabindex="-1"></a><span class="co">#节点互连超时的阀值。集群节点超时毫秒数</span></span>
<span id="cb263-199"><a href="#cb263-199" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-node-timeout 15000</span></span>
<span id="cb263-200"><a href="#cb263-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-201"><a href="#cb263-201" aria-hidden="true" tabindex="-1"></a><span class="co">#在进行故障转移的时候，全部slave都会请求申请为master，但是有些slave可能与master断开连接一段时间了，导致数据过于陈旧，这样的slave不应该被提升为master。该参数就是用来判断slave节点与master断线的时间是否过长。判断方法是：</span></span>
<span id="cb263-202"><a href="#cb263-202" aria-hidden="true" tabindex="-1"></a><span class="co">#比较slave断开连接的时间和(node-timeout * slave-validity-factor) + repl-ping-slave-period</span></span>
<span id="cb263-203"><a href="#cb263-203" aria-hidden="true" tabindex="-1"></a><span class="co">#如果节点超时时间为三十秒, 并且slave-validity-factor为10,假设默认的repl-ping-slave-period是10秒，即如果超过310秒slave将不会尝试进行故障转移 </span></span>
<span id="cb263-204"><a href="#cb263-204" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-slave-validity-factor 10</span></span>
<span id="cb263-205"><a href="#cb263-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-206"><a href="#cb263-206" aria-hidden="true" tabindex="-1"></a><span class="co">#master的slave数量大于该值，slave才能迁移到其他孤立master上，如这个参数若被设为2，那么只有当一个主节点拥有2 个可工作的从节点时，它的一个从节点会尝试迁移。</span></span>
<span id="cb263-207"><a href="#cb263-207" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-migration-barrier 1</span></span>
<span id="cb263-208"><a href="#cb263-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-209"><a href="#cb263-209" aria-hidden="true" tabindex="-1"></a><span class="co">#默认情况下，集群全部的slot有节点负责，集群状态才为ok，才能提供服务。设置为no，可以在slot没有全部分配的时候提供服务。不建议打开该配置，这样会造成分区的时候，小分区的master一直在接受写请求，而造成很长时间数据不一致。</span></span>
<span id="cb263-210"><a href="#cb263-210" aria-hidden="true" tabindex="-1"></a><span class="co"># cluster-require-full-coverage yes</span></span>
<span id="cb263-211"><a href="#cb263-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-212"><a href="#cb263-212" aria-hidden="true" tabindex="-1"></a><span class="co">################################## SLOW LOG ###################################</span></span>
<span id="cb263-213"><a href="#cb263-213" aria-hidden="true" tabindex="-1"></a><span class="co">###slog log是用来记录redis运行中执行比较慢的命令耗时。当命令的执行超过了指定时间，就记录在slow log中，slog log保存在内存中，所以没有IO操作。</span></span>
<span id="cb263-214"><a href="#cb263-214" aria-hidden="true" tabindex="-1"></a><span class="co">#执行时间比slowlog-log-slower-than大的请求记录到slowlog里面，单位是微秒，所以1000000就是1秒。注意，负数时间会禁用慢查询日志，而0则会强制记录所有命令。</span></span>
<span id="cb263-215"><a href="#cb263-215" aria-hidden="true" tabindex="-1"></a><span class="dt">slowlog-log-slower-than 10000</span></span>
<span id="cb263-216"><a href="#cb263-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-217"><a href="#cb263-217" aria-hidden="true" tabindex="-1"></a><span class="co">#慢查询日志长度。当一个新的命令被写进日志的时候，最老的那个记录会被删掉。这个长度没有限制。只要有足够的内存就行。你可以通过 SLOWLOG RESET 来释放内存。</span></span>
<span id="cb263-218"><a href="#cb263-218" aria-hidden="true" tabindex="-1"></a><span class="dt">slowlog-max-len 128</span></span>
<span id="cb263-219"><a href="#cb263-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-220"><a href="#cb263-220" aria-hidden="true" tabindex="-1"></a><span class="co">################################ LATENCY MONITOR ##############################</span></span>
<span id="cb263-221"><a href="#cb263-221" aria-hidden="true" tabindex="-1"></a><span class="co">#延迟监控功能是用来监控redis中执行比较缓慢的一些操作，用LATENCY打印redis实例在跑命令时的耗时图表。只记录大于等于下边设置的值的操作。0的话，就是关闭监视。默认延迟监控功能是关闭的，如果你需要打开，也可以通过CONFIG SET命令动态设置。</span></span>
<span id="cb263-222"><a href="#cb263-222" aria-hidden="true" tabindex="-1"></a><span class="dt">latency-monitor-threshold 0</span></span>
<span id="cb263-223"><a href="#cb263-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-224"><a href="#cb263-224" aria-hidden="true" tabindex="-1"></a><span class="co">############################# EVENT NOTIFICATION ##############################</span></span>
<span id="cb263-225"><a href="#cb263-225" aria-hidden="true" tabindex="-1"></a><span class="co">#键空间通知使得客户端可以通过订阅频道或模式，来接收那些以某种方式改动了 Redis 数据集的事件。因为开启键空间通知功能需要消耗一些 CPU ，所以在默认配置下，该功能处于关闭状态。</span></span>
<span id="cb263-226"><a href="#cb263-226" aria-hidden="true" tabindex="-1"></a><span class="co">#notify-keyspace-events 的参数可以是以下字符的任意组合，它指定了服务器该发送哪些类型的通知：</span></span>
<span id="cb263-227"><a href="#cb263-227" aria-hidden="true" tabindex="-1"></a><span class="co">##K 键空间通知，所有通知以 __keyspace@__ 为前缀</span></span>
<span id="cb263-228"><a href="#cb263-228" aria-hidden="true" tabindex="-1"></a><span class="co">##E 键事件通知，所有通知以 __keyevent@__ 为前缀</span></span>
<span id="cb263-229"><a href="#cb263-229" aria-hidden="true" tabindex="-1"></a><span class="co">##g DEL 、 EXPIRE 、 RENAME 等类型无关的通用命令的通知</span></span>
<span id="cb263-230"><a href="#cb263-230" aria-hidden="true" tabindex="-1"></a><span class="co">##$ 字符串命令的通知</span></span>
<span id="cb263-231"><a href="#cb263-231" aria-hidden="true" tabindex="-1"></a><span class="co">##l 列表命令的通知</span></span>
<span id="cb263-232"><a href="#cb263-232" aria-hidden="true" tabindex="-1"></a><span class="co">##s 集合命令的通知</span></span>
<span id="cb263-233"><a href="#cb263-233" aria-hidden="true" tabindex="-1"></a><span class="co">##h 哈希命令的通知</span></span>
<span id="cb263-234"><a href="#cb263-234" aria-hidden="true" tabindex="-1"></a><span class="co">##z 有序集合命令的通知</span></span>
<span id="cb263-235"><a href="#cb263-235" aria-hidden="true" tabindex="-1"></a><span class="co">##x 过期事件：每当有过期键被删除时发送</span></span>
<span id="cb263-236"><a href="#cb263-236" aria-hidden="true" tabindex="-1"></a><span class="co">##e 驱逐(evict)事件：每当有键因为 maxmemory 政策而被删除时发送</span></span>
<span id="cb263-237"><a href="#cb263-237" aria-hidden="true" tabindex="-1"></a><span class="co">##A 参数 g$lshzxe 的别名</span></span>
<span id="cb263-238"><a href="#cb263-238" aria-hidden="true" tabindex="-1"></a><span class="co">#输入的参数中至少要有一个 K 或者 E，否则的话，不管其余的参数是什么，都不会有任何 通知被分发。详细使用可以参考http://redis.io/topics/notifications</span></span>
<span id="cb263-239"><a href="#cb263-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-240"><a href="#cb263-240" aria-hidden="true" tabindex="-1"></a><span class="dt">notify-keyspace-events &quot;&quot;</span></span>
<span id="cb263-241"><a href="#cb263-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-242"><a href="#cb263-242" aria-hidden="true" tabindex="-1"></a><span class="co">############################### ADVANCED CONFIG ###############################</span></span>
<span id="cb263-243"><a href="#cb263-243" aria-hidden="true" tabindex="-1"></a><span class="co">#数据量小于等于hash-max-ziplist-entries的用ziplist，大于hash-max-ziplist-entries用hash</span></span>
<span id="cb263-244"><a href="#cb263-244" aria-hidden="true" tabindex="-1"></a><span class="dt">hash-max-ziplist-entries 512</span></span>
<span id="cb263-245"><a href="#cb263-245" aria-hidden="true" tabindex="-1"></a><span class="co">#value大小小于等于hash-max-ziplist-value的用ziplist，大于hash-max-ziplist-value用hash。</span></span>
<span id="cb263-246"><a href="#cb263-246" aria-hidden="true" tabindex="-1"></a><span class="dt">hash-max-ziplist-value 64</span></span>
<span id="cb263-247"><a href="#cb263-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-248"><a href="#cb263-248" aria-hidden="true" tabindex="-1"></a><span class="co">#数据量小于等于list-max-ziplist-entries用ziplist，大于list-max-ziplist-entries用list。</span></span>
<span id="cb263-249"><a href="#cb263-249" aria-hidden="true" tabindex="-1"></a><span class="dt">list-max-ziplist-entries 512</span></span>
<span id="cb263-250"><a href="#cb263-250" aria-hidden="true" tabindex="-1"></a><span class="co">#value大小小于等于list-max-ziplist-value的用ziplist，大于list-max-ziplist-value用list。</span></span>
<span id="cb263-251"><a href="#cb263-251" aria-hidden="true" tabindex="-1"></a><span class="dt">list-max-ziplist-value 64</span></span>
<span id="cb263-252"><a href="#cb263-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-253"><a href="#cb263-253" aria-hidden="true" tabindex="-1"></a><span class="co">#数据量小于等于set-max-intset-entries用iniset，大于set-max-intset-entries用set。</span></span>
<span id="cb263-254"><a href="#cb263-254" aria-hidden="true" tabindex="-1"></a><span class="dt">set-max-intset-entries 512</span></span>
<span id="cb263-255"><a href="#cb263-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-256"><a href="#cb263-256" aria-hidden="true" tabindex="-1"></a><span class="co">#数据量小于等于zset-max-ziplist-entries用ziplist，大于zset-max-ziplist-entries用zset。</span></span>
<span id="cb263-257"><a href="#cb263-257" aria-hidden="true" tabindex="-1"></a><span class="dt">zset-max-ziplist-entries 128</span></span>
<span id="cb263-258"><a href="#cb263-258" aria-hidden="true" tabindex="-1"></a><span class="co">#value大小小于等于zset-max-ziplist-value用ziplist，大于zset-max-ziplist-value用zset。</span></span>
<span id="cb263-259"><a href="#cb263-259" aria-hidden="true" tabindex="-1"></a><span class="dt">zset-max-ziplist-value 64</span></span>
<span id="cb263-260"><a href="#cb263-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-261"><a href="#cb263-261" aria-hidden="true" tabindex="-1"></a><span class="co">#value大小小于等于hll-sparse-max-bytes使用稀疏数据结构（sparse），大于hll-sparse-max-bytes使用稠密的数据结构（dense）。一个比16000大的value是几乎没用的，建议的value大概为3000。如果对CPU要求不高，对空间要求较高的，建议设置到10000左右。</span></span>
<span id="cb263-262"><a href="#cb263-262" aria-hidden="true" tabindex="-1"></a><span class="dt">hll-sparse-max-bytes 3000</span></span>
<span id="cb263-263"><a href="#cb263-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-264"><a href="#cb263-264" aria-hidden="true" tabindex="-1"></a><span class="co">#Redis将在每100毫秒时使用1毫秒的CPU时间来对redis的hash表进行重新hash，可以降低内存的使用。当你的使用场景中，有非常严格的实时性需要，不能够接受Redis时不时的对请求有2毫秒的延迟的话，把这项配置为no。如果没有这么严格的实时性要求，可以设置为yes，以便能够尽可能快的释放内存。</span></span>
<span id="cb263-265"><a href="#cb263-265" aria-hidden="true" tabindex="-1"></a><span class="dt">activerehashing yes</span></span>
<span id="cb263-266"><a href="#cb263-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-267"><a href="#cb263-267" aria-hidden="true" tabindex="-1"></a><span class="co">##对客户端输出缓冲进行限制可以强迫那些不从服务器读取数据的客户端断开连接，用来强制关闭传输缓慢的客户端。</span></span>
<span id="cb263-268"><a href="#cb263-268" aria-hidden="true" tabindex="-1"></a><span class="co">#对于normal client，第一个0表示取消hard limit，第二个0和第三个0表示取消soft limit，normal client默认取消限制，因为如果没有寻问，他们是不会接收数据的。</span></span>
<span id="cb263-269"><a href="#cb263-269" aria-hidden="true" tabindex="-1"></a><span class="dt">client-output-buffer-limit normal 0 0 0</span></span>
<span id="cb263-270"><a href="#cb263-270" aria-hidden="true" tabindex="-1"></a><span class="co">#对于slave client和MONITER client，如果client-output-buffer一旦超过256mb，又或者超过64mb持续60秒，那么服务器就会立即断开客户端连接。</span></span>
<span id="cb263-271"><a href="#cb263-271" aria-hidden="true" tabindex="-1"></a><span class="dt">client-output-buffer-limit slave 256mb 64mb 60</span></span>
<span id="cb263-272"><a href="#cb263-272" aria-hidden="true" tabindex="-1"></a><span class="co">#对于pubsub client，如果client-output-buffer一旦超过32mb，又或者超过8mb持续60秒，那么服务器就会立即断开客户端连接。</span></span>
<span id="cb263-273"><a href="#cb263-273" aria-hidden="true" tabindex="-1"></a><span class="dt">client-output-buffer-limit pubsub 32mb 8mb 60</span></span>
<span id="cb263-274"><a href="#cb263-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-275"><a href="#cb263-275" aria-hidden="true" tabindex="-1"></a><span class="co">#redis执行任务的频率为1s除以hz。</span></span>
<span id="cb263-276"><a href="#cb263-276" aria-hidden="true" tabindex="-1"></a><span class="dt">hz 10</span></span>
<span id="cb263-277"><a href="#cb263-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-278"><a href="#cb263-278" aria-hidden="true" tabindex="-1"></a><span class="co">#在aof重写的时候，如果打开了aof-rewrite-incremental-fsync开关，系统会每32MB执行一次fsync。这对于把文件写入磁盘是有帮助的，可以避免过大的延迟峰值。</span></span>
<span id="cb263-279"><a href="#cb263-279" aria-hidden="true" tabindex="-1"></a><span class="dt">aof-rewrite-incremental-fsync yes</span></span></code></pre></div>
<h3 id="启动服务">启动服务</h3>
<p>修改配置文件把redis改成后台启动，把daemonize的值改成yes</p>
<pre><code>daemonize yes</code></pre>
<p>复制配置文件到安装目录</p>
<pre class="shell"><code>sudo cp redis.conf /opt/redis/bin/</code></pre>
<p>启动服务</p>
<pre class="shell"><code> /opt/redis/bin/redis-server /opt/redis/bin/redis.conf</code></pre>
<p>停止服务</p>
<pre class="shell"><code>ps -ef | grep redis
kill -9 redis的pid</code></pre>
<p>命令行客户端连接</p>
<pre class="shell"><code>/opt/redis/bin/redis-cli</code></pre>
<p>如果给Redis设置了密码，连接后需要使用<code>auth</code>命令登录，可以通过<code>CONFIG get requirepass</code>查看是否需要密码（一些基本的命令不需要密码也能执行）</p>
<pre><code># 返回 &quot;&quot; 表示不需要密码
CONFIG get requirepass

# 设置密码
CONFIG set requirepass &quot;mypassword&quot;</code></pre>
<p>在远程服务上执行命令</p>
<pre class="shell"><code>/opt/redis/bin/redis-cli -h hostIP -p port -a password</code></pre>
<h3 id="key">key</h3>
<p>Redis默认有16个表（可以在配置文件中改），每个表的key是独立的</p>
<pre><code># 切换表（0-15号表，默认在0号表）
select 1

# 插入、获取数据（String类型有无双引号都一样）
# a是key，1是value
set a 1
set b abc
set c 你好
set d &quot;你好&quot;
get a

# 把key移动到其他表
move d 3

# 查看所有key
keys *

# 删除key
del c
# 同时删除多个key
del a b

# 重复插入相同key的数据会覆盖
set a 1
set a 你好
get a

# 检查key是否存在
exists a

# 设置过期时间，单位为秒
expire a 10

# 查看剩余时间（-1表示不会过期），单位为秒
ttl a

# 移除过期时间，把key变成永不过期
persist a

# 查看key的类型
type a

# 重命名key（如果存在相同名字的key，会覆盖）
rename a key1

# 仅当不存在相同名字的key时，重命名key
renamenx key1 key2

# 如果配置了持久化，删除所有key的操作也会同步到rdb和aof中
# 删除所有key（当前表）
flushdb
# 删除所有key（所有表）
flushall</code></pre>
<h3 id="五大数据类型">五大数据类型</h3>
<p>Redis存储的数据是二进制安全的，除了可以存储5大数据类型外，Redis还可以存储图片等二进制数据</p>
<h4 id="string">String</h4>
<pre><code>127.0.0.1:6379&gt; SET key1 value1
OK
127.0.0.1:6379&gt; SET key2 value2
OK
127.0.0.1:6379&gt; GET key1
&quot;value1&quot;

#截取字符串
127.0.0.1:6379&gt; GETRANGE key1 0 2
&quot;val&quot;

# 设置新值并返回旧值
127.0.0.1:6379&gt; GETSET key1 haha
&quot;value1&quot;

# 一次获取多个key的值
127.0.0.1:6379&gt; MGET key1 key2
1) &quot;haha&quot;
2) &quot;value2&quot;

# 一次设置多个key
127.0.0.1:6379&gt; MSET key1 value1 key2 value2
OK

# 设置key的同时设置过期时间
127.0.0.1:6379&gt; SETEX key3 10 value3
OK

# 当key不存在时，设置key的值
127.0.0.1:6379&gt; SETNX key1 aaa
(integer) 0

# 将key中储存的数字值加1
127.0.0.1:6379&gt; set num1 1
OK
127.0.0.1:6379&gt; INCR num1
(integer) 2
# 将key中储存的数字值加上指定的值
127.0.0.1:6379&gt; INCRBY num1 5
(integer) 7

127.0.0.1:6379&gt; DECR num1
(integer) 6
127.0.0.1:6379&gt; DECRBY num1 2
(integer) 4

127.0.0.1:6379&gt; APPEND key1 aaa
(integer) 9
127.0.0.1:6379&gt; get key1
&quot;value1aaa&quot;</code></pre>
<h4 id="list">List</h4>
<p>列表，可以当栈使用，由于它可以指定入栈、出栈的方向，一般用于实现任务队列(FIFO)</p>
<pre><code>#将一个或多个值插入到列表头部
127.0.0.1:6379&gt; LPUSH mykey 1 2 3 4 5
(integer) 5

# 获取列表指定范围内的元素（从顶部到尾部输出）
127.0.0.1:6379&gt; LRANGE mykey 0 4
1) &quot;5&quot;
2) &quot;4&quot;
3) &quot;3&quot;
4) &quot;2&quot;
5) &quot;1&quot;

# 删除顶部元素
127.0.0.1:6379&gt; LPOP mykey
&quot;5&quot;

# 删除尾部元素
127.0.0.1:6379&gt; RPOP mykey
&quot;1&quot;

# 在尾部插入元素
127.0.0.1:6379&gt; RPUSH mykey 6
(integer) 5
# 0 -1表示获取所有元素
127.0.0.1:6379&gt; LRANGE mykey 0 -1
1) &quot;4&quot;
2) &quot;3&quot;
3) &quot;2&quot;
4) &quot;6&quot;</code></pre>
<h4 id="set">Set</h4>
<p>无序集合，不允许重复成员</p>
<pre><code>127.0.0.1:6379&gt; SADD mykey value1 value3 value2
(integer) 3

# 返回集合中元素个数
127.0.0.1:6379&gt; SCARD mykey
(integer) 3

# 获取所有值
127.0.0.1:6379&gt; SMEMBERS mykey
1) &quot;value3&quot;
2) &quot;value1&quot;
3) &quot;value2&quot;

# 移除并返回集合中的一个随机元素
127.0.0.1:6379&gt; SPOP mykey
&quot;value2&quot;

# 删除元素（当集合中没有元素时，对应的key也会被删除）
127.0.0.1:6379&gt; SREM mykey value1 value3
(integer) 2
127.0.0.1:6379&gt; keys *
(empty list or set)

127.0.0.1:6379&gt; SADD set1 1 4 6 7 2
(integer) 0
127.0.0.1:6379&gt; SADD set2 3 5 6 1
(integer) 4

# 差集
127.0.0.1:6379&gt; SDIFF set1 set2
1) &quot;2&quot;
2) &quot;4&quot;
3) &quot;7&quot;

# 交集
127.0.0.1:6379&gt; SINTER set1 set2
1) &quot;1&quot;
2) &quot;6&quot;

# 并集
127.0.0.1:6379&gt; SUNION set1 set2
1) &quot;1&quot;
2) &quot;2&quot;
3) &quot;3&quot;
4) &quot;4&quot;
5) &quot;5&quot;
6) &quot;6&quot;
7) &quot;7&quot;</code></pre>
<h4 id="hash">Hash</h4>
<p>存储key-value对</p>
<pre><code>127.0.0.1:6379&gt; HSET mykey key1 value1 key2 value2 key3 value3
(integer) 3

# 获取所有key
127.0.0.1:6379&gt; HKEYS mykey
1) &quot;key1&quot;
2) &quot;key2&quot;
3) &quot;key3&quot;

# 获取所有value
127.0.0.1:6379&gt; HVALS mykey
1) &quot;value1&quot;
2) &quot;value2&quot;
3) &quot;value3&quot;

# 获取所有的key、value
127.0.0.1:6379&gt; HGETALL mykey
1) &quot;key1&quot;
2) &quot;value1&quot;
3) &quot;key2&quot;
4) &quot;value2&quot;
5) &quot;key3&quot;
6) &quot;value3&quot;

# 一次获取多个
127.0.0.1:6379&gt; HMGET mykey key1 key2
1) &quot;value1&quot;
2) &quot;value2&quot;

# 获取hash表的长度
127.0.0.1:6379&gt; HLEN mykey
(integer) 3

# 获取value
127.0.0.1:6379&gt; HGET mykey key1
&quot;value1&quot;

# 删除（可删除多个）
127.0.0.1:6379&gt; HDEL mykey key3
(integer) 1

127.0.0.1:6379&gt; HEXISTS mykey key3
(integer) 0

# 设置值
127.0.0.1:6379&gt; HSET mykey key3 aaa
(integer) 1

# 当key不存在时设置值
127.0.0.1:6379&gt; HSETNX mykey key3 bbb
(integer) 0

# 一次设置多个
127.0.0.1:6379&gt; HMSET mykey key4 value4 key5 value5
OK</code></pre>
<h4 id="zset">Zset</h4>
<p>有序集合，不允许重复的成员，且每个成员都会关联一个double类型的分数，redis通过该分数来为集合中的成员进行从小到大的排序</p>
<pre><code>127.0.0.1:6379&gt; ZADD key1 5 value1 4 value2 5 value3
(integer) 3

# 返回指定索引范围内的成员，0 -1表示获取所有
127.0.0.1:6379&gt; ZRANGE key1 0 -1
1) &quot;value2&quot;
2) &quot;value1&quot;
3) &quot;value3&quot;

# 逆序返回指定索引范围内的成员，
127.0.0.1:6379&gt; ZREVRANGE key1 0 -1
1) &quot;value3&quot;
2) &quot;value1&quot;
3) &quot;value2&quot;

# 返回指定分数的区间内的成员
127.0.0.1:6379&gt; ZRANGEBYSCORE key1 0 5
1) &quot;value2&quot;
2) &quot;value1&quot;
3) &quot;value3&quot;

# 按照字典顺序获取成员
127.0.0.1:6379&gt; ZADD key2 0 a 0 b 0 c 0 d 0 e 0 f 0 g
(integer) 7
127.0.0.1:6379&gt; ZRANGEBYLEX key2 - [c
1) &quot;a&quot;
2) &quot;b&quot;
3) &quot;c&quot;

# 获取指定成员的索引
127.0.0.1:6379&gt; ZRANK key1 value3
(integer) 2

# 获取指定成员的score
127.0.0.1:6379&gt; ZSCORE key1 value1
&quot;5&quot;

# 删除指定成员
127.0.0.1:6379&gt; ZREM key1 value3 value2
(integer) 2
127.0.0.1:6379&gt; ZRANGE key1 0 -1
1) &quot;value1&quot;</code></pre>
<h3 id="事务-1">事务</h3>
<h4 id="multi">MULTI</h4>
<p><code>MULTI</code>开启事务，<code>EXEC</code>提交事务，<code>DISCARD</code>回滚</p>
<pre><code>127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; SET key1 value1
QUEUED
127.0.0.1:6379&gt; SET key2 value2
QUEUED
127.0.0.1:6379&gt; EXEC
1) OK
2) OK
127.0.0.1:6379&gt; keys *
1) &quot;key1&quot;
2) &quot;key2&quot;</code></pre>
<p>如果输错命令，整个事务都不会执行</p>
<pre><code>127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; SET key1 value1
QUEUED
127.0.0.1:6379&gt; SET key2
(error) ERR wrong number of arguments for &#39;set&#39; command
127.0.0.1:6379&gt; EXEC
(error) EXECABORT Transaction discarded because of previous errors.</code></pre>
<p>只要事务没有提交，外部（其他客户端）无法看到更改</p>
<pre><code># 客户端1（还没有EXEC）
127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; SET key1 value1
QUEUED

# 客户端2
127.0.0.1:6379&gt; keys *
(empty list or set)</code></pre>
<p>事务不能嵌套</p>
<pre><code>127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; MULTI
(error) ERR MULTI calls can not be nested</code></pre>
<p>如果某一命令执行失败，后面的仍然可以执行（不具备原子性）</p>
<pre><code>127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; SET key1 value1
QUEUED
127.0.0.1:6379&gt; RENAME key2 key1
QUEUED
127.0.0.1:6379&gt; SET key2 value2
QUEUED
127.0.0.1:6379&gt; EXEC
1) OK
2) (error) ERR no such key
3) OK</code></pre>
<h4 id="watch">WATCH</h4>
<p><code>watch</code>用于监视一个(或多个) key
，如果在事务执行之前这个(或这些) key
被其他命令所改动，那么事务将被打断</p>
<p>客户端1（未提交事务）</p>
<pre><code>127.0.0.1:6379&gt; set key1 value1
OK
127.0.0.1:6379&gt; WATCH key1
OK
127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; set key1 value2
QUEUED</code></pre>
<p>此时客户端2对key1做修改</p>
<pre><code>127.0.0.1:6379&gt; set key1 aaa
OK</code></pre>
<p>客户端1再提交会返回nil，表示事务执行失败</p>
<pre><code>127.0.0.1:6379&gt; EXEC
(nil)
127.0.0.1:6379&gt; get key1
&quot;aaa&quot;</code></pre>
<p>如果事务中还有其他操作，也不会执行</p>
<pre><code>127.0.0.1:6379&gt; WATCH key1
OK
127.0.0.1:6379&gt; MULTI
OK
127.0.0.1:6379&gt; set key1 value2
QUEUED
127.0.0.1:6379&gt; set key2 value2
QUEUED
127.0.0.1:6379&gt; EXEC
(nil)
127.0.0.1:6379&gt; keys *
1) &quot;key1&quot;
127.0.0.1:6379&gt; get key1
&quot;aaa&quot;</code></pre>
<p><code>watch</code>在每次提交事务后失效，也可以使用<code>unwatch</code>取消监视</p>
<h3 id="持久化">持久化</h3>
<p>如果只配置了rdb，则启动时只加载rdb</p>
<p>如果只配置了aof，则启动时只加载aof</p>
<p>当rdb和aof同时存在时，只加载aof</p>
<h4 id="rdb">RDB</h4>
<p>rdb就是Redis
Database，默认是开启的，他存储内存中所有的键值对，rdb默认的存储路径为安装目录下的dump.rdb，如果权限不够，会放到当前用户的home目录下（Linux环境下），可以通过配置文件修改</p>
<pre><code># 保存的时间间隔，save 900 1表示如果在900秒内有1条数据改动，则执行保存操作；可以设置多条保存规则，如果要禁用所有的保存规则，可以使用save &quot;&quot;，此时所有保存规则都会失效，此时Redis仅用作内存缓存
save 900 1
save 300 10
save 60 10000

# 在后台保存时如果出错是否停止
stop-writes-on-bgsave-error yes

# 是否压缩后再保存
rdbcompression yes

# 导出的rdb文件名
dbfilename dump.rdb

# 导出的rdb目录
dir ./</code></pre>
<p><strong>手动执行备份</strong></p>
<p>执行<code>shutdown</code>、<code>flushall</code>等命令时会把内存数据保存到rdb中，也可以手动执行<code>save</code>保存</p>
<pre><code># 保存，运行在前台，会阻塞，此时前台无法使用任何命令
127.0.0.1:6379&gt; SAVE
OK

# 在后台保存，前台可以执行其他命令，但如果更改了数据，会导致无法保存和内存中完全一样的数据
127.0.0.1:6379&gt; BGSAVE
Background saving started</code></pre>
<p><strong>备份文件修复</strong></p>
<p>Redis安装目录下有修复脚本<code>redis-check-rdb</code></p>
<pre><code>redis-check-rdb rdb文件</code></pre>
<p><strong>恢复</strong></p>
<p>把rdb放到Redis安装目录（如果权限不够，目录有可能是当前用户的home目录）中再启动服务即可恢复rdb中的内容，可以通过<code>CONFIG GET dir</code>获取目录</p>
<pre><code>CONFIG GET dir</code></pre>
<h4 id="aof">AOF</h4>
<p>aof就是append-only
file（只进行追加操作的文件），aof保存的是执行过的写命令，恢复时是根据命令重建数据的，所以恢复时间比rdb要慢，而且aof保存的文件可读性较高，不够安全；但是每次保存不需要把整个内存同步到数据库，只需要增加新的写命令，保存的时间少，所以可靠性高，同时它支持rewrite，可以生成重建数据所需的最少命令。aof默认是关闭的，可以通过配置文件修改</p>
<pre><code># 是否开启aof，默认关闭
appendonly no

# 导出的aof文件名
appendfilename &quot;appendonly.aof&quot;

# 持久化策略
# always: 同步持久化，表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全）
# everysec: 异步操作，表示每秒同步一次（折衷，默认值），如果一秒钟内宕机，会有数据丢失
# no: 表示将缓存回写的策略交给系统，linux 默认是30秒将缓冲区的数据回写硬盘的（快）
# appendfsync always
appendfsync everysec
# appendfsync no

# 在aof重写或写入rdb时是否进行append操作，设置为yes表示rewrite期间对新写操作不fsync,暂时存在内存中,等rewrite完成后再写入，默认为no
no-appendfsync-on-rewrite no

# 当目前aof文件大小超过上一次重写的aof文件大小的百分之多少进行重写，即当aof文件增长到一定大小的时候Redis能够调用bgrewriteaof对日志文件进行重写，100表示两倍于之前重写后的文件大小时进行重写
auto-aof-rewrite-percentage 100
# 最小重写大小，小于该大小不会进行重写
auto-aof-rewrite-min-size 64mb

# 当系统宕机时，保存的aof文件的尾部可能是不完整的，如果设置为yes，表示让Redis尽可能地加载数据，如果为no，必须使用redis-check-aof命令修复aof文件后才能使用
aof-load-truncated yes

# 在以前rdb和aof是独立的，它们互不影响，Redis4.0开始允许使用RDB-AOF混合持久化的方式，可以在这里打开混合开关
aof-use-rdb-preamble yes</code></pre>
<p>AOF同步过程：</p>
<ol type="1">
<li>Redis 执行 fork() ，现在同时拥有父进程和子进程</li>
<li>子进程开始将新 AOF 文件的内容写入到临时文件</li>
<li>对于所有新执行的写入命令，父进程一边将它们累积到一个内存缓存中，一边将这些改动追加到现有
AOF 文件的末尾： 这样即使在重写的中途发生停机，现有的 AOF
文件也还是安全的</li>
<li>当子进程完成重写工作时，它给父进程发送一个信号，父进程在接收到信号之后，将内存缓存中的所有数据追加到新
AOF 文件的末尾</li>
<li>原子地用新文件替换旧文件，之后所有命令都会直接追加到新 AOF
文件的末尾</li>
</ol>
<p><strong>手动执行备份</strong></p>
<p>可以通过<code>BGREWRITEAOF</code>命令备份aof，<code>BGSAVE</code>和<code>BGREWRITEAOF</code>只能同时执行一个，且同时只能备份一个aof</p>
<p>如果<code>BGSAVE</code>正在执行，而且用户显式调用了<code>BGREWRITEAOF</code>，那么服务器将向用户回复一个
<code>OK</code> 状态，
并告知用户，<code>BGREWRITEAOF</code>已经被预定执行：
一旦<code>BGSAVE</code>
执行完毕，<code>BGREWRITEAOF</code>就会正式开始</p>
<p><strong>备份文件修复</strong></p>
<p>Redis安装目录下有修复脚本<code>redis-check-aof</code></p>
<pre><code>redis-check-aof aof文件</code></pre>
<p><strong>恢复</strong></p>
<p>aof的恢复和rdb一样，把aof放到Redis安装目录或者home目录（通过<code>CONFIG GET dir</code>获取目录）下即可</p>
<p><strong>从rdb转aof</strong></p>
<p>可以在不重启的情况下，将rdb转成aof（需要先备份当前的rdb文件）</p>
<pre><code>CONFIG SET appendonly yes
CONFIG SET save &quot;&quot;</code></pre>
<h3 id="主从复制slaveof">主从复制（slaveof）</h3>
<p>master-slave模式</p>
<pre><code>SLAVEOF master的ip地址 端口号</code></pre>
<p>此时slave无法进行写操作，只能执行读操作，而且每次同步都是增量同步</p>
<p>如果master意外下线，slave还是只读，master重新上线后，slave继续和master保持同步</p>
<p>如果在master下线期间，任意一个slave执行了<code>SLAVEOF no one</code>，则slave之间会根据算法决定出一个新的master，如果原来的master重新上线，就会变成slave</p>
<p><strong>哨兵模式</strong></p>
<p>哨兵(sentinel)会一直检测当前所有主机的运行状态，如果master下线，就会自动执行<code>SLAVEOF no one</code>，自动根据算法选举出一个新的master，而且原来的master上线后，会变为slave</p>
<p>配置sentinel.conf</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sentinel端口</span></span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="dt">port 26379</span></span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 工作路径，注意路径不要和主重复</span></span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a><span class="dt">dir /tmp</span></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 守护进程模式（后台运行）</span></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="dt">daemonize yes</span></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 关闭保护模式</span></span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a><span class="dt">protected-mode no</span></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-13"><a href="#cb294-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 指明日志文件名</span></span>
<span id="cb294-14"><a href="#cb294-14" aria-hidden="true" tabindex="-1"></a><span class="dt">logfile &quot;./sentinel.log&quot;</span></span>
<span id="cb294-15"><a href="#cb294-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-16"><a href="#cb294-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 使sentinel监视一个名为mymaster的主服务器，这个主服务器的IP地址为127.0.0.1，端口号为6379，而将这个主服务器判断为失效至少需要2个sentinel同意（如果同意的sentinel的数量不达标，自动故障迁移就不会执行）</span></span>
<span id="cb294-17"><a href="#cb294-17" aria-hidden="true" tabindex="-1"></a><span class="dt">sentinel monitor mymaster 127.0.0.1 6379 2</span></span>
<span id="cb294-18"><a href="#cb294-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-19"><a href="#cb294-19" aria-hidden="true" tabindex="-1"></a><span class="co"># master或slave多长时间（默认30秒）不能使用后标记为SDOWN状态，SDOWN为主观下线，即单个sentinel对服务器做出的下线判断，当被一定数量的sentinel做出SDOWN判断后，会变成ODOWN，客观下线</span></span>
<span id="cb294-20"><a href="#cb294-20" aria-hidden="true" tabindex="-1"></a><span class="dt">sentinel down-after-milliseconds mymaster 6000</span></span>
<span id="cb294-21"><a href="#cb294-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-22"><a href="#cb294-22" aria-hidden="true" tabindex="-1"></a><span class="co"># 若sentinel在该配置值内未能完成failover操作（即故障时master/slave自动切换），则认为本次failover失败。</span></span>
<span id="cb294-23"><a href="#cb294-23" aria-hidden="true" tabindex="-1"></a><span class="dt">sentinel failover-timeout mymaster 18000</span></span>
<span id="cb294-24"><a href="#cb294-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-25"><a href="#cb294-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 指定了在执行故障转移时， 最多可以有多少个从服务器同时对新的主服务器进行同步</span></span>
<span id="cb294-26"><a href="#cb294-26" aria-hidden="true" tabindex="-1"></a><span class="dt">sentinel parallel-syncs mymaster 1</span></span>
<span id="cb294-27"><a href="#cb294-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-28"><a href="#cb294-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置master和slaves验证密码</span></span>
<span id="cb294-29"><a href="#cb294-29" aria-hidden="true" tabindex="-1"></a><span class="dt">sentinel auth-pass mymaster 123456 </span></span></code></pre></div>
<p>sentinel参数在运行时可以使用<code>SENTINEL SET</code>命令更改</p>
<p>启动哨兵</p>
<pre><code># 方式一（推荐，这种方式启动和redis实例没有任何关系）
redis-sentinel /path/to/sentinel.conf
# 方式二
redis-server /path/to/sentinel.conf --sentinel</code></pre>
<p>连接哨兵的客户端（这里的端口是哨兵配置文件中指定的端口）</p>
<pre><code>redis-cli -p 26379

# 查看master的状态，这里的mymaster是上面配置文件中指定的master的名称
sentinel master mymaster
# 查看salves的状态
SENTINEL slaves mymaster
# 查看哨兵的状态
SENTINEL sentinels mymaster

# 获取当前master的地址，如果正在执行故障转移，会返回新的主服务器地址
SENTINEL get-master-addr-by-name mymaster
# 查看哨兵信息
info sentinel

# 当主服务器失效时，在不询问其他Sentinel意见的情况下，强制开始一次自动故障迁移（不过发起故障转移的Sentinel会向其他Sentinel发送一个新的配置，其他Sentinel会根据这个配置进行相应的更新）
SENTINEL failover mymaster</code></pre>
<p>master或者slave可以通过<code>INFO replication</code>查看当前的角色以及slave的数量（slave也可以设置slave）</p>
<pre><code>127.0.0.1:6379&gt; INFO replication
# Replication
role:master
connected_slaves:0
master_replid:98615a1467c7828b9f774f7fc87ed30db45a65be
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0</code></pre>
<p>设置master密码：</p>
<pre><code>config set masterauth 123456</code></pre>
<p>要永久地设置这个密码， 那么可以将它加入到配置文件中：</p>
<pre><code>masterauth 123456</code></pre>
<h3 id="发布订阅">发布订阅</h3>
<p>开启两个客户端</p>
<p>接收端</p>
<pre><code>127.0.0.1:6379&gt; SUBSCRIBE mytopic
Reading messages... (press Ctrl-C to quit)
1) &quot;subscribe&quot;
2) &quot;mytopic&quot;
3) (integer) 1
</code></pre>
<p>发送端</p>
<pre><code>127.0.0.1:6379&gt; PUBLISH mytopic &quot;aaa&quot;
(integer) 1</code></pre>
<p>收到消息后接收端显示如下</p>
<pre><code>127.0.0.1:6379&gt; SUBSCRIBE mytopic
Reading messages... (press Ctrl-C to quit)
1) &quot;subscribe&quot;
2) &quot;mytopic&quot;
3) (integer) 1
1) &quot;message&quot;
2) &quot;mytopic&quot;
3) &quot;aaa&quot;</code></pre>
<p>其他</p>
<pre><code>订阅多个频道
PSUBSCRIBE mytopic1 mytopic2

# 可以使用通配符
PSUBSCRIBE mytopic*

# 查看所有频道（查看的所有频道的客户端要早于订阅的客户端启动才能看得到）
PUBSUB CHANNELS</code></pre>
<h3 id="jedis">Jedis</h3>
<p>在JAVA中使用Redis所用的api叫Jedis，和命令行中各命令一一对应</p>
<p><a href="https://static.javadoc.io/redis.clients/jedis/2.9.0/overview-summary.html">Jedis-API</a></p>
<p>maven依赖</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;redis.clients&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;jedis&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;2.9.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Test</span></span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">test1</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//连接本地的 Redis 服务</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>    Jedis jedis <span class="op">=</span> <span class="kw">new</span> <span class="fu">Jedis</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">);</span></span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;连接成功&quot;</span><span class="op">);</span></span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//设置 redis 字符串数据</span></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a>    jedis<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="st">&quot;value1&quot;</span><span class="op">);</span></span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 获取存储的数据并输出</span></span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>jedis<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">));</span></span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a>    jedis<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb305-11"><a href="#cb305-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb305-12"><a href="#cb305-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-13"><a href="#cb305-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-14"><a href="#cb305-14" aria-hidden="true" tabindex="-1"></a><span class="co">//使用连接池</span></span>
<span id="cb305-15"><a href="#cb305-15" aria-hidden="true" tabindex="-1"></a><span class="at">@Test</span></span>
<span id="cb305-16"><a href="#cb305-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">test2</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb305-17"><a href="#cb305-17" aria-hidden="true" tabindex="-1"></a>    JedisPool jedisPool <span class="op">=</span> <span class="kw">new</span> <span class="fu">JedisPool</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">);</span></span>
<span id="cb305-18"><a href="#cb305-18" aria-hidden="true" tabindex="-1"></a>    Jedis jedis <span class="op">=</span> pool<span class="op">.</span><span class="fu">getResource</span><span class="op">();</span></span>
<span id="cb305-19"><a href="#cb305-19" aria-hidden="true" tabindex="-1"></a>    jedis<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="st">&quot;value1&quot;</span><span class="op">);</span></span>
<span id="cb305-20"><a href="#cb305-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>jedis<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">));</span></span>
<span id="cb305-21"><a href="#cb305-21" aria-hidden="true" tabindex="-1"></a>    jedis<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb305-22"><a href="#cb305-22" aria-hidden="true" tabindex="-1"></a>    jedisPool<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb305-23"><a href="#cb305-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="分布式锁">分布式锁</h3>
<p>需要了解的命令：</p>
<p><code>SET key value [EX seconds][PX milliseconds] [NX|XX]</code></p>
<ul>
<li><code>EX</code> <em>seconds</em> –
设置键key的过期时间，单位时秒</li>
<li><code>PX</code> <em>milliseconds</em> –
设置键key的过期时间，单位时毫秒</li>
<li><code>NX</code> – 只有键key不存在的时候才会设置key的值</li>
<li><code>XX</code> – 只有键key存在的时候才会设置key的值</li>
</ul>
<p>要注意加锁和释放锁的过程必须具有原子性，即只能通过一条命令（一次连接）实现</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> JedisLock <span class="op">{</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>    Jedis jedis<span class="op">;</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">JedisLock</span><span class="op">(</span>Jedis jedis<span class="op">)</span> <span class="op">{</span></span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jedis</span> <span class="op">=</span> jedis<span class="op">;</span></span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">尝试获取分布式锁，记录锁的名称和客户端标识，这里用了</span>setnx<span class="co">，所以是不可重入锁，要让锁可重入，可以使用</span>LUA<span class="co">脚本，额外判断</span>lockKey<span class="co">对应的值是不是</span>requestId<span class="co">，如果是则返回</span>true</span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span></span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="an">lockKey</span><span class="co">    锁的名称</span></span>
<span id="cb306-12"><a href="#cb306-12" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="an">@param</span><span class="co"> </span><span class="an">requestId</span><span class="co">  请求标识，用于标识当前客户端，比如</span>IP</span>
<span id="cb306-13"><a href="#cb306-13" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="an">@param</span><span class="co"> </span><span class="an">expireTime</span><span class="co"> 超期时间，单位为毫秒（当客户端由于网络原因无法释放锁，就要有自动释放的机制）</span></span>
<span id="cb306-14"><a href="#cb306-14" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="an">@return</span> <span class="co">是否获取成功</span></span>
<span id="cb306-15"><a href="#cb306-15" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb306-16"><a href="#cb306-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">tryLock</span><span class="op">(</span><span class="bu">String</span> lockKey<span class="op">,</span> <span class="bu">String</span> requestId<span class="op">,</span> <span class="dt">int</span> expireTime<span class="op">)</span> <span class="op">{</span></span>
<span id="cb306-17"><a href="#cb306-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">//NX表示如果不存在则创建，PX表示超时时间的单位是毫秒</span></span>
<span id="cb306-18"><a href="#cb306-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> result <span class="op">=</span> jedis<span class="op">.</span><span class="fu">set</span><span class="op">(</span>lockKey<span class="op">,</span> requestId<span class="op">,</span> <span class="st">&quot;NX&quot;</span><span class="op">,</span> <span class="st">&quot;PX&quot;</span><span class="op">,</span> expireTime<span class="op">);</span></span>
<span id="cb306-19"><a href="#cb306-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;OK&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>result<span class="op">))</span> <span class="op">{</span></span>
<span id="cb306-20"><a href="#cb306-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb306-21"><a href="#cb306-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb306-22"><a href="#cb306-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb306-23"><a href="#cb306-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-24"><a href="#cb306-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-25"><a href="#cb306-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">//阻塞式获取</span></span>
<span id="cb306-26"><a href="#cb306-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">tryLockBlocking</span><span class="op">(</span><span class="bu">String</span> lockKey<span class="op">,</span> <span class="bu">String</span> requestId<span class="op">,</span> <span class="dt">int</span> expireTime<span class="op">)</span> <span class="kw">throws</span> <span class="bu">InterruptedException</span> <span class="op">{</span></span>
<span id="cb306-27"><a href="#cb306-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb306-28"><a href="#cb306-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> result <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">jedis</span><span class="op">.</span><span class="fu">set</span><span class="op">(</span>lockKey<span class="op">,</span> requestId<span class="op">,</span> <span class="st">&quot;NX&quot;</span><span class="op">,</span> <span class="st">&quot;PX&quot;</span><span class="op">,</span> expireTime<span class="op">);</span></span>
<span id="cb306-29"><a href="#cb306-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;OK&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>result<span class="op">))</span> <span class="op">{</span></span>
<span id="cb306-30"><a href="#cb306-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb306-31"><a href="#cb306-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb306-32"><a href="#cb306-32" aria-hidden="true" tabindex="-1"></a>            <span class="co">//防止一直消耗CPU</span></span>
<span id="cb306-33"><a href="#cb306-33" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">100L</span><span class="op">);</span></span>
<span id="cb306-34"><a href="#cb306-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb306-35"><a href="#cb306-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-36"><a href="#cb306-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-37"><a href="#cb306-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb306-38"><a href="#cb306-38" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">释放分布式锁</span></span>
<span id="cb306-39"><a href="#cb306-39" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span></span>
<span id="cb306-40"><a href="#cb306-40" aria-hidden="true" tabindex="-1"></a><span class="co">     * </span><span class="an">@param</span><span class="co"> </span><span class="an">lockKey</span><span class="co">   锁的名称</span></span>
<span id="cb306-41"><a href="#cb306-41" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="an">@param</span><span class="co"> </span><span class="an">requestId</span><span class="co"> 请求标识，用于标识当前客户端，比如</span>IP</span>
<span id="cb306-42"><a href="#cb306-42" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="an">@return</span> <span class="co">是否释放成功</span></span>
<span id="cb306-43"><a href="#cb306-43" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb306-44"><a href="#cb306-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">release</span><span class="op">(</span><span class="bu">String</span> lockKey<span class="op">,</span> <span class="bu">String</span> requestId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb306-45"><a href="#cb306-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">//无法使用Jedis API通过一条命令实现，所以使用了LUA脚本</span></span>
<span id="cb306-46"><a href="#cb306-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">//先判断锁是不是当前客户端加的，是就DEL</span></span>
<span id="cb306-47"><a href="#cb306-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> script <span class="op">=</span> <span class="st">&quot;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&quot;</span><span class="op">;</span></span>
<span id="cb306-48"><a href="#cb306-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">//eval(String script, List&lt;String&gt; keys, List&lt;String&gt; args)</span></span>
<span id="cb306-49"><a href="#cb306-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> result <span class="op">=</span> jedis<span class="op">.</span><span class="fu">eval</span><span class="op">(</span>script<span class="op">,</span> <span class="bu">Collections</span><span class="op">.</span><span class="fu">singletonList</span><span class="op">(</span>lockKey<span class="op">),</span> <span class="bu">Collections</span><span class="op">.</span><span class="fu">singletonList</span><span class="op">(</span>requestId<span class="op">));</span></span>
<span id="cb306-50"><a href="#cb306-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>result <span class="op">==</span> <span class="st">&quot;1&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb306-51"><a href="#cb306-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb306-52"><a href="#cb306-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb306-53"><a href="#cb306-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb306-54"><a href="#cb306-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb306-55"><a href="#cb306-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>上面的代码还有一个问题没有解决：如果处理时间超过了expireTime，就会让其他客户端获得锁，导致锁失效，解决方法是添加一个守护进程，定时给锁延时；又或者把expireTime设置得尽量长</p>
<p>关于开源的Redis的分布式锁实现有很多，比较出名的有<a href="https://github.com/redisson/redisson">redisson</a>、百度的<a href="https://github.com/baidu/dlock">dlock</a></p>
<h3 id="穿透雪崩热点key">穿透、雪崩、热点Key</h3>
<p><strong>缓存穿透</strong></p>
<p>缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时需要从数据库查询，查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，造成缓存穿透</p>
<p>解决方法：</p>
<ol type="1">
<li>缓存层缓存空值
<ol type="1">
<li>缓存太多空值，占用更多空间（优化：给个空值过期时间）</li>
<li>存储层更新代码了，缓存层还是空值（优化：后台设置时主动删除空值，并缓存把值进去）</li>
</ol></li>
<li>对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃</li>
</ol>
<p><strong>缓存雪崩</strong></p>
<p>如果缓存集中在一段时间内失效，发生大量的缓存穿透，所有的查询都落在数据库上，造成了缓存雪崩</p>
<p>解决方法：</p>
<ol type="1">
<li>不同的key，设置不同的过期时间（随机），让缓存失效的时间点尽量均匀</li>
<li>可以通过缓存reload机制，预先去更新缓存，在即将发生大并发访问前手动触发加载缓存</li>
<li>做二级缓存，或者双缓存策略。A1为原始缓存，A2为拷贝缓存，A1失效时，可以访问A2，A1缓存失效时间设置为短期，A2设置为长期</li>
</ol>
<p>缓存雪崩还有一种可能，就是Redis挂了</p>
<p>解决方法：</p>
<ol type="1">
<li>保持缓存层服务器的高可用（监控、集群、哨兵）</li>
<li>依赖隔离组件为后端限流并降级服务</li>
<li>使用熔断策略</li>
</ol>
<p><strong>热点key</strong></p>
<p>热卖商品、热点新闻、热点评论、明星直播等业务场景会出现热点key，如果在热点key缓存失效的瞬间，有大量客户端同时请求缓存，导致一个key同时被请求创建多次，会造成后端负载加大，甚至可能会让系统崩溃</p>
<p>解决方法：</p>
<ol type="1">
<li>使用互斥锁（synchronized或分布式锁），只让一个线程构建缓存</li>
<li>不设置过期时间，让key永远不过期，同时定时向数据库发起更新缓存的异步请求</li>
<li>使用熔断策略</li>
</ol>
<h3 id="集群搭建">集群搭建</h3>
<p>从Redis3开始，支持集群环境。登录任意一个Redis节点，使用get命令，会自动计算出key所在的Redis服务器，然后自动重定向，所以只要访问Redis集群中任一节点，就可以访问集群中所有Redis中的任意数据</p>
<p>Redis的集群使用了Hash槽(slot)，最多可以有16384个Hash槽(slot)，存储在Redis
Cluster中的所有键都会使用公式<code>CRC16(key)%slot</code>映射到这些slot中，即按slot进行分片。我们可以在搭建集群时通过reshard参数选择slot的数量</p>
<p>若集群中超过半数的Redis主机宕机，那么整个集群就无法工作了</p>
<p>在每个服务器上安装好Redis（Redis集群至少需要三台服务器），修改配置文件，每台服务器的配置主要的不同处如下：</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 通用配置，如果使用伪集群模拟，可能需要修改</span></span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="dt">port 6379</span></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="dt">daemonize yes</span></span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a><span class="dt">dir /var/lib/redis</span></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a><span class="dt">pidfile /var/run/redis/redis-server.pid</span></span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a><span class="dt">appendonly yes</span></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------集群环境配置-----------</span></span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 绑定当前服务器的IP</span></span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a><span class="dt">bind 192.168.1.2</span></span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 开启集群模式</span></span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a><span class="dt">cluster-enabled yes</span></span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 集群相关的配置文件名称</span></span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a><span class="dt">cluster-config-file nodes-6379.conf</span></span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a><span class="dt">cluster-node-timeout 15000</span></span></code></pre></div>
<p>然后使用<code>redis-cli --cluster SUBCOMMAND [ARGUMENTS] [OPTIONS]</code>来配置集群</p>
<pre class="shell"><code>./redis-cli --cluster create 192.168.1.2:6379 192.168.1.3:6379 192.168.1.4:6379 192.168.1.5:6379 192.168.1.6:6379 192.168.1.7:6379 --cluster-replicas 1</code></pre>
<p>其中
<code>--replicas 1</code>表示自动为每一个master节点分配一个slave节点（主从复制比例为
1:1），上面有6个节点，程序会按照一定规则生成
3个master（主）3个slave(从)</p>
<p>如果创建失败，检查防火墙中对应的端口有没有开放</p>
<p>创建成功后，可以使用<code>-c</code>参数（表示以集群方式登录）登录命令行客户端，<code>redis-cli -c -h 192.168.1.2 -p 6379</code>，然后使用<code>cluster nodes</code>命令查看集群节点信息，<code>cluster info</code>查看集群状态信息</p>
<p>使用<code>redis-cli --cluster help</code>可以查看所有可用命令：</p>
<pre class="shell"><code>Cluster Manager Commands:
  create         host1:port1 ... hostN:portN
                 --cluster-replicas &lt;arg&gt;
  check          host:port
  info           host:port
  fix            host:port
  reshard        host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-to &lt;arg&gt;
                 --cluster-slots &lt;arg&gt;
                 --cluster-yes
                 --cluster-timeout &lt;arg&gt;
                 --cluster-pipeline &lt;arg&gt;
  rebalance      host:port
                 --cluster-weight &lt;node1=w1...nodeN=wN&gt;
                 --cluster-use-empty-masters
                 --cluster-timeout &lt;arg&gt;
                 --cluster-simulate
                 --cluster-pipeline &lt;arg&gt;
                 --cluster-threshold &lt;arg&gt;
  add-node       new_host:new_port existing_host:existing_port
                 --cluster-slave
                 --cluster-master-id &lt;arg&gt;
  del-node       host:port node_id
  call           host:port command arg arg .. arg
  set-timeout    host:port milliseconds
  import         host:port
                 --cluster-from &lt;arg&gt;
                 --cluster-copy
                 --cluster-replace
  help</code></pre>
<p>比如新添加节点</p>
<pre class="shell"><code>./redis-cli --cluster add-node 192.168.1.8:6379 192.168.1.9:6379
# 添加完新节点后需要重新分片Hash槽（连接集群中任意一个可用结点都行）
./redis-cli --cluster reshard 192.168.1.2:6379</code></pre>
<p>更改主从节点</p>
<pre class="shell"><code>./redis-cli --cluster add-node --slave --master-id 5d6c61ecff23bff3b0fb01a86c66d882f2d402a0 192.168.1.8:6379 192.168.1.9:6379</code></pre>
<p>使用了集群后，Jedis需要使用<code>JedisCluster</code></p>
<div class="sourceCode" id="cb312"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Set</span><span class="op">&lt;</span>HostAndPort<span class="op">&gt;</span> nodes <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashSet</span><span class="op">&lt;&gt;();</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.2&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.3&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.4&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.5&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-6"><a href="#cb312-6" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.6&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-7"><a href="#cb312-7" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.7&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-8"><a href="#cb312-8" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.8&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-9"><a href="#cb312-9" aria-hidden="true" tabindex="-1"></a>nodes<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">HostAndPort</span><span class="op">(</span><span class="st">&quot;192.168.1.9&quot;</span><span class="op">,</span> <span class="dv">6379</span><span class="op">));</span></span>
<span id="cb312-10"><a href="#cb312-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-11"><a href="#cb312-11" aria-hidden="true" tabindex="-1"></a><span class="co">// 创建JedisCluster对象</span></span>
<span id="cb312-12"><a href="#cb312-12" aria-hidden="true" tabindex="-1"></a>JedisCluster jedisCluster <span class="op">=</span> <span class="kw">new</span> <span class="fu">JedisCluster</span><span class="op">(</span>nodes<span class="op">);</span></span>
<span id="cb312-13"><a href="#cb312-13" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span>
<span id="cb312-14"><a href="#cb312-14" aria-hidden="true" tabindex="-1"></a>jedisCluster<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h3 id="整合spring">整合Spring</h3>
<p>maven</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Jedis --&gt;</span></span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;redis.clients&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;jedis&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;2.9.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- spring-data-redis（1.7.2 开始支持Redis集群）--&gt;</span></span>
<span id="cb313-9"><a href="#cb313-9" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;                            </span>
<span id="cb313-10"><a href="#cb313-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.springframework.data&lt;/<span class="kw">groupId</span>&gt; </span>
<span id="cb313-11"><a href="#cb313-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;spring-data-redis&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb313-12"><a href="#cb313-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.7.2.RELEASE&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb313-13"><a href="#cb313-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb313-14"><a href="#cb313-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-15"><a href="#cb313-15" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb313-16"><a href="#cb313-16" aria-hidden="true" tabindex="-1"></a>　　&lt;<span class="kw">groupId</span>&gt;org.apache.commons&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb313-17"><a href="#cb313-17" aria-hidden="true" tabindex="-1"></a>　　&lt;<span class="kw">artifactId</span>&gt;commons-lang3&lt;/<span class="kw">artifactId</span>&gt; </span>
<span id="cb313-18"><a href="#cb313-18" aria-hidden="true" tabindex="-1"></a>　　&lt;<span class="kw">version</span>&gt;3.3.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb313-19"><a href="#cb313-19" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<h4 id="非集群版本">非集群版本</h4>
<p>appplicationContext-redis.xml</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;propertyPlaceholderConfigurer&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;</span>&gt;</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;locations&quot;</span>&gt;</span>
<span id="cb314-3"><a href="#cb314-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">list</span>&gt;</span>
<span id="cb314-4"><a href="#cb314-4" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">value</span>&gt;classpath*:/redis.porperties&lt;/<span class="kw">value</span>&gt;</span>
<span id="cb314-5"><a href="#cb314-5" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">list</span>&gt;</span>
<span id="cb314-6"><a href="#cb314-6" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb314-7"><a href="#cb314-7" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb314-8"><a href="#cb314-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-9"><a href="#cb314-9" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置JedisPoolConfig实例 --&gt;</span></span>
<span id="cb314-10"><a href="#cb314-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;poolConfig&quot;</span><span class="ot"> class=</span><span class="st">&quot;redis.clients.jedis.JedisPoolConfig&quot;</span>&gt;</span>
<span id="cb314-11"><a href="#cb314-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxIdle&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxIdle}&quot;</span> /&gt;</span>
<span id="cb314-12"><a href="#cb314-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxTotal&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxActive}&quot;</span> /&gt;</span>
<span id="cb314-13"><a href="#cb314-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxWaitMillis&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxWait}&quot;</span> /&gt;</span>
<span id="cb314-14"><a href="#cb314-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testOnBorrow&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testOnBorrow}&quot;</span> /&gt;</span>
<span id="cb314-15"><a href="#cb314-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testOnReturn&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testOnReturn}&quot;</span> /&gt;</span>
<span id="cb314-16"><a href="#cb314-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testWhileIdle&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testWhileIdle}&quot;</span> /&gt;</span>
<span id="cb314-17"><a href="#cb314-17" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb314-18"><a href="#cb314-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-19"><a href="#cb314-19" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置JedisConnectionFactory --&gt;</span></span>
<span id="cb314-20"><a href="#cb314-20" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;jedisConnectionFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span>&gt;</span>
<span id="cb314-21"><a href="#cb314-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hostName&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.host}&quot;</span> /&gt;</span>
<span id="cb314-22"><a href="#cb314-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;port&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.port}&quot;</span> /&gt;</span>
<span id="cb314-23"><a href="#cb314-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- &lt;property name=&quot;password&quot; value=&quot;${redis.pass}&quot; /&gt; --&gt;</span></span>
<span id="cb314-24"><a href="#cb314-24" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;database&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.dbIndex}&quot;</span> /&gt;</span>
<span id="cb314-25"><a href="#cb314-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;timeout&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.timeout}&quot;</span> /&gt;</span>
<span id="cb314-26"><a href="#cb314-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;poolConfig&quot;</span><span class="ot"> ref=</span><span class="st">&quot;poolConfig&quot;</span> /&gt;</span>
<span id="cb314-27"><a href="#cb314-27" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb314-28"><a href="#cb314-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-29"><a href="#cb314-29" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置RedisTemplate --&gt;</span></span>
<span id="cb314-30"><a href="#cb314-30" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;redisTemplate&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.core.RedisTemplate&quot;</span>&gt;</span>
<span id="cb314-31"><a href="#cb314-31" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;connectionFactory&quot;</span><span class="ot"> ref=</span><span class="st">&quot;jedisConnectionFactory&quot;</span> /&gt;</span>
<span id="cb314-32"><a href="#cb314-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 如果不配置Serializer，那么存储的时候缺省使用String，如果用User类型存储，那么会提示错误User can&#39;t cast to String！！ --&gt;</span></span>
<span id="cb314-33"><a href="#cb314-33" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;keySerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb314-34"><a href="#cb314-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashKeySerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb314-35"><a href="#cb314-35" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;valueSerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb314-36"><a href="#cb314-36" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashValueSerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb314-37"><a href="#cb314-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--开启事务支持  --&gt;</span>  </span>
<span id="cb314-38"><a href="#cb314-38" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;enableTransactionSupport&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>&gt;&lt;/<span class="kw">property</span>&gt;  </span>
<span id="cb314-39"><a href="#cb314-39" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb314-40"><a href="#cb314-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-41"><a href="#cb314-41" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;stringRedisSerializer&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.serializer.StringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb314-42"><a href="#cb314-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-43"><a href="#cb314-43" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用注解让Spring使用Redis管理缓存 --&gt;</span></span>
<span id="cb314-44"><a href="#cb314-44" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置RedisCacheManager --&gt;</span></span>
<span id="cb314-45"><a href="#cb314-45" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;redisCacheManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.cache.RedisCacheManager&quot;</span>&gt;</span>
<span id="cb314-46"><a href="#cb314-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;redisOperations&quot;</span><span class="ot"> ref=</span><span class="st">&quot;redisTemplate&quot;</span> /&gt;</span>
<span id="cb314-47"><a href="#cb314-47" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultExpiration&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.expiration}&quot;</span> /&gt;</span>
<span id="cb314-48"><a href="#cb314-48" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb314-49"><a href="#cb314-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb314-50"><a href="#cb314-50" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用缓存注解 --&gt;</span></span>
<span id="cb314-51"><a href="#cb314-51" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">cache:annotation-driven</span><span class="ot"> cache-manager=</span><span class="st">&quot;redisCacheManager&quot;</span> /&gt;</span></code></pre></div>
<p>redis.porperties</p>
<pre class="properties"><code># Redis settings
redis.host=127.0.0.1
redis.port=6379
#redis.pass=password
redis.dbIndex=0
redis.timeout=3000
redis.expiration=3000
redis.maxIdle=300
redis.maxActive=600
redis.maxWait=1000
redis.testOnBorrow=true
redis.testOnReturn=true
redis.testWhileIdle=true</code></pre>
<h4 id="集群版本">集群版本</h4>
<p>appplicationContext-redis-cluster.xml</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置JedisPoolConfig实例 --&gt;</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;poolConfig&quot;</span><span class="ot"> class=</span><span class="st">&quot;redis.clients.jedis.JedisPoolConfig&quot;</span>&gt;</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxIdle&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxIdle}&quot;</span> /&gt;</span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxTotal&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxActive}&quot;</span> /&gt;</span>
<span id="cb316-5"><a href="#cb316-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxWaitMillis&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.maxWait}&quot;</span> /&gt;</span>
<span id="cb316-6"><a href="#cb316-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testOnBorrow&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testOnBorrow}&quot;</span> /&gt;</span>
<span id="cb316-7"><a href="#cb316-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testOnReturn&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testOnReturn}&quot;</span> /&gt;</span>
<span id="cb316-8"><a href="#cb316-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;testWhileIdle&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.testWhileIdle}&quot;</span> /&gt;</span>
<span id="cb316-9"><a href="#cb316-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-10"><a href="#cb316-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-11"><a href="#cb316-11" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Redis集群配置 --&gt;</span></span>
<span id="cb316-12"><a href="#cb316-12" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;redisClusterConfig&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.RedisClusterConfiguration&quot;</span>&gt;</span>
<span id="cb316-13"><a href="#cb316-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxRedirects&quot;</span><span class="ot"> value=</span><span class="st">&quot;3&quot;</span>&gt;&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb316-14"><a href="#cb316-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;clusterNodes&quot;</span>&gt;</span>
<span id="cb316-15"><a href="#cb316-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">set</span>&gt;</span>
<span id="cb316-16"><a href="#cb316-16" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.RedisNode&quot;</span>&gt;</span>
<span id="cb316-17"><a href="#cb316-17" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;host&quot;</span><span class="ot"> value=</span><span class="st">&quot;192.168.1.2&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-18"><a href="#cb316-18" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;port&quot;</span><span class="ot"> value=</span><span class="st">&quot;6379&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-19"><a href="#cb316-19" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-20"><a href="#cb316-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-21"><a href="#cb316-21" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.RedisNode&quot;</span>&gt;</span>
<span id="cb316-22"><a href="#cb316-22" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;host&quot;</span><span class="ot"> value=</span><span class="st">&quot;192.168.1.3&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-23"><a href="#cb316-23" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;port&quot;</span><span class="ot"> value=</span><span class="st">&quot;6379&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-24"><a href="#cb316-24" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-25"><a href="#cb316-25" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.RedisNode&quot;</span>&gt;</span>
<span id="cb316-26"><a href="#cb316-26" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;host&quot;</span><span class="ot"> value=</span><span class="st">&quot;192.168.1.4&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-27"><a href="#cb316-27" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;port&quot;</span><span class="ot"> value=</span><span class="st">&quot;6379&quot;</span>&gt;&lt;/<span class="kw">constructor-arg</span>&gt;</span>
<span id="cb316-28"><a href="#cb316-28" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-29"><a href="#cb316-29" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">set</span>&gt;</span>
<span id="cb316-30"><a href="#cb316-30" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb316-31"><a href="#cb316-31" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-32"><a href="#cb316-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-33"><a href="#cb316-33" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Redis连接工厂 --&gt;</span></span>
<span id="cb316-34"><a href="#cb316-34" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;jedisConnectionFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span>&gt;</span>
<span id="cb316-35"><a href="#cb316-35" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;clusterConfig&quot;</span><span class="ot"> ref=</span><span class="st">&quot;redisClusterConfig&quot;</span> /&gt;</span>
<span id="cb316-36"><a href="#cb316-36" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;timeout&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.timeout}&quot;</span> /&gt;</span>
<span id="cb316-37"><a href="#cb316-37" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;poolConfig&quot;</span><span class="ot"> ref=</span><span class="st">&quot;poolConfig&quot;</span> /&gt;</span>
<span id="cb316-38"><a href="#cb316-38" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-39"><a href="#cb316-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-40"><a href="#cb316-40" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 集群Redis使用模板 --&gt;</span></span>
<span id="cb316-41"><a href="#cb316-41" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;clusterRedisTemplate&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.core.RedisTemplate&quot;</span>&gt;</span>
<span id="cb316-42"><a href="#cb316-42" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;connectionFactory&quot;</span><span class="ot"> ref=</span><span class="st">&quot;jedisConnectionFactory&quot;</span> /&gt;</span>
<span id="cb316-43"><a href="#cb316-43" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;keySerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb316-44"><a href="#cb316-44" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashKeySerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb316-45"><a href="#cb316-45" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;valueSerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb316-46"><a href="#cb316-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashValueSerializer&quot;</span><span class="ot"> ref=</span><span class="st">&quot;stringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb316-47"><a href="#cb316-47" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-48"><a href="#cb316-48" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 存储序列化 --&gt;</span></span>
<span id="cb316-49"><a href="#cb316-49" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> name=</span><span class="st">&quot;stringRedisSerializer&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.serializer.StringRedisSerializer&quot;</span> /&gt;</span>
<span id="cb316-50"><a href="#cb316-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-51"><a href="#cb316-51" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用注解让Spring使用Redis管理缓存 --&gt;</span></span>
<span id="cb316-52"><a href="#cb316-52" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 配置RedisCacheManager --&gt;</span></span>
<span id="cb316-53"><a href="#cb316-53" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;redisCacheManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.data.redis.cache.RedisCacheManager&quot;</span>&gt;</span>
<span id="cb316-54"><a href="#cb316-54" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;redisOperations&quot;</span><span class="ot"> ref=</span><span class="st">&quot;redisTemplate&quot;</span> /&gt;</span>
<span id="cb316-55"><a href="#cb316-55" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultExpiration&quot;</span><span class="ot"> value=</span><span class="st">&quot;${redis.expiration}&quot;</span> /&gt;</span>
<span id="cb316-56"><a href="#cb316-56" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb316-57"><a href="#cb316-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-58"><a href="#cb316-58" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用缓存注解 --&gt;</span></span>
<span id="cb316-59"><a href="#cb316-59" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">cache:annotation-driven</span><span class="ot"> cache-manager=</span><span class="st">&quot;redisCacheManager&quot;</span> /&gt;</span></code></pre></div>
<h4 id="使用redistemplate">使用RedisTemplate</h4>
<div class="sourceCode" id="cb317"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>clusterRedisTemplate<span class="op">.</span><span class="fu">execute</span><span class="op">(</span><span class="kw">new</span> RedisCallback<span class="op">&lt;</span><span class="bu">Long</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Long</span> <span class="fu">doInRedis</span><span class="op">(</span>RedisConnection connection<span class="op">)</span> <span class="kw">throws</span> DataAccessException <span class="op">{</span></span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>connection<span class="op">.</span><span class="fu">exists</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a>            connection<span class="op">.</span><span class="fu">del</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="st">&quot;value1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1L</span><span class="op">;</span></span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<h4 id="缓存注解使用">缓存注解使用</h4>
<p>使用注解让Spring使用Redis管理缓存：</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span><span class="op">(</span><span class="st">&quot;userService&quot;</span><span class="op">)</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Transactional</span><span class="op">(</span>propagation<span class="op">=</span>Propagation<span class="op">.</span><span class="fu">REQUIRED</span><span class="op">,</span> rollbackFor<span class="op">=</span><span class="bu">Exception</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a><span class="co">//@CacheConfig: 用cacheNames属性指定本类中所有用到缓存的地方，都去找这个库。只要使用了这个注解，在方法上@Cacheable、@CachePut、@CacheEvict就可以不用写value去找具体库名了（一般不怎么用）</span></span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a><span class="co">//@CacheConfig</span></span>
<span id="cb318-5"><a href="#cb318-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceImpl <span class="kw">implements</span> IUserService <span class="op">{</span></span>
<span id="cb318-6"><a href="#cb318-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-7"><a href="#cb318-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Resource</span></span>
<span id="cb318-8"><a href="#cb318-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserMapper iUserDao<span class="op">;</span></span>
<span id="cb318-9"><a href="#cb318-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-10"><a href="#cb318-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@Cacheable: 标注该方法查询的结果进入缓存，再次访问时直接读取缓存中的数据</span></span>
<span id="cb318-11"><a href="#cb318-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果未在类上使用@CacheConfig注解规定数据要缓存到哪个库中，就必须给value一个值，规定数据最后缓存到哪个redis库中</span></span>
<span id="cb318-12"><a href="#cb318-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果不指定key属性，则会按我们自定义的规则生成，key可以使用EL表达式</span></span>
<span id="cb318-13"><a href="#cb318-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//可以指定condition，condition用EL表达式写，当condition为true时才存入缓存</span></span>
<span id="cb318-14"><a href="#cb318-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cacheable</span><span class="op">(</span><span class="st">&quot;getUserById&quot;</span><span class="op">)</span></span>
<span id="cb318-15"><a href="#cb318-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb318-16"><a href="#cb318-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> User <span class="fu">getUserById</span><span class="op">(</span><span class="dt">int</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb318-17"><a href="#cb318-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">iUserDao</span><span class="op">.</span><span class="fu">selectByPrimaryKey</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb318-18"><a href="#cb318-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb318-19"><a href="#cb318-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb318-20"><a href="#cb318-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@CachePut: 每次不管缓存中有没有结果，都从数据库查找结果，并将结果更新到缓存</span></span>
<span id="cb318-21"><a href="#cb318-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CachePut</span><span class="op">(</span><span class="st">&quot;getAllUser&quot;</span><span class="op">)</span></span>
<span id="cb318-22"><a href="#cb318-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb318-23"><a href="#cb318-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="fu">getAllUser</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb318-24"><a href="#cb318-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">iUserDao</span><span class="op">.</span><span class="fu">selectAllUser</span><span class="op">();</span></span>
<span id="cb318-25"><a href="#cb318-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb318-26"><a href="#cb318-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb318-27"><a href="#cb318-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">//@CacheEvict: 清空指定的缓存，allEntries变量表示所有对象的缓存都清除</span></span>
<span id="cb318-28"><a href="#cb318-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一般进行了插入、更新、删除等操作都要更新缓存，所谓更新缓存，就是把对应的key删掉，让下次从数据库获取数据</span></span>
<span id="cb318-29"><a href="#cb318-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">@CacheEvict</span><span class="op">(</span>value<span class="op">={</span><span class="st">&quot;getUserById&quot;</span><span class="op">,</span> <span class="st">&quot;getAllUser&quot;</span><span class="op">},</span> key<span class="op">=</span><span class="st">&quot;&#39;user&#39;+#id.toString()&quot;</span><span class="op">)</span></span>
<span id="cb318-30"><a href="#cb318-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">deleteById</span><span class="op">(</span><span class="dt">int</span> id<span class="op">){</span></span>
<span id="cb318-31"><a href="#cb318-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="fu">iUserDao</span><span class="op">.</span><span class="fu">deleteUser</span><span class="op">();</span></span>
<span id="cb318-32"><a href="#cb318-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb318-33"><a href="#cb318-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="key生成策略">key生成策略</h4>
<p>如果没有指定key生成策略，会默认使用<code>SimpleKeyGenerator</code>，它是按照参数生成缓存的key的，如果2个方法，参数是一样的，但执行逻辑不同，那么将会导致执行第二个方法时命中第一个方法的缓存</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SimpleKeyGenerator <span class="kw">implements</span> <span class="bu">KeyGenerator</span> <span class="op">{</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">generate</span><span class="op">(</span><span class="bu">Object</span> target<span class="op">,</span> <span class="bu">Method</span> method<span class="op">,</span> <span class="bu">Object</span><span class="kw">...</span> params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">generateKey</span><span class="op">(</span>params<span class="op">);</span></span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb319-7"><a href="#cb319-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Object</span> <span class="fu">generateKey</span><span class="op">(</span><span class="bu">Object</span><span class="kw">...</span> params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb319-8"><a href="#cb319-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>params<span class="op">.</span><span class="fu">length</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb319-9"><a href="#cb319-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> SimpleKey<span class="op">.</span><span class="fu">EMPTY</span><span class="op">;</span></span>
<span id="cb319-10"><a href="#cb319-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb319-11"><a href="#cb319-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>params<span class="op">.</span><span class="fu">length</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb319-12"><a href="#cb319-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Object</span> param <span class="op">=</span> params<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb319-13"><a href="#cb319-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>param <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>param<span class="op">.</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">isArray</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb319-14"><a href="#cb319-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> param<span class="op">;</span></span>
<span id="cb319-15"><a href="#cb319-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb319-16"><a href="#cb319-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb319-17"><a href="#cb319-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SimpleKey</span><span class="op">(</span>params<span class="op">);</span></span>
<span id="cb319-18"><a href="#cb319-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb319-19"><a href="#cb319-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>自定义key生成策略</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RedisCacheConfig <span class="kw">extends</span> CachingConfigurerSupport <span class="op">{</span></span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//自定义redis的key生成规则，如果不在注解参数中注明key=“”的话，就采用这个类中的key生成规则生成key</span></span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//使用 本类名+方法名+参数名(中间没有逗号区分) 生成Redis的key</span></span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb320-8"><a href="#cb320-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">KeyGenerator</span> <span class="fu">keyGenerator</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb320-9"><a href="#cb320-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="bu">KeyGenerator</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb320-10"><a href="#cb320-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb320-11"><a href="#cb320-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">generate</span><span class="op">(</span><span class="bu">Object</span> obj<span class="op">,</span> <span class="bu">Method</span> method<span class="op">,</span> <span class="bu">Object</span><span class="kw">...</span> params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb320-12"><a href="#cb320-12" aria-hidden="true" tabindex="-1"></a>                <span class="bu">StringBuilder</span> sb <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb320-13"><a href="#cb320-13" aria-hidden="true" tabindex="-1"></a>                sb<span class="op">.</span><span class="fu">append</span><span class="op">(</span>obj<span class="op">.</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb320-14"><a href="#cb320-14" aria-hidden="true" tabindex="-1"></a>                sb<span class="op">.</span><span class="fu">append</span><span class="op">(</span>method<span class="op">.</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb320-15"><a href="#cb320-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span> param <span class="op">:</span> params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb320-16"><a href="#cb320-16" aria-hidden="true" tabindex="-1"></a>                    sb<span class="op">.</span><span class="fu">append</span><span class="op">(</span>param<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb320-17"><a href="#cb320-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb320-18"><a href="#cb320-18" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> sb<span class="op">.</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb320-19"><a href="#cb320-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb320-20"><a href="#cb320-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb320-21"><a href="#cb320-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb320-22"><a href="#cb320-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="zookeeper">ZooKeeper</h2>
<p>项目地址: <a href="http://zookeeper.apache.org/releases.html#download">zookeeper.apache.org</a></p>
<h3 id="配置-1">配置</h3>
<p>配置<code>conf/zoo.cfg</code></p>
<div class="sourceCode" id="cb321"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 时间单位(毫秒)</span></span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="dt">tickTime</span><span class="ot">=</span><span class="dv">2000</span></span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a><span class="co"># zookeeper实例中的从节点同步到主节点的初始化连接时间限制，超出时间限制则连接失败；这里的10表示是tickTime的10倍，即20秒</span></span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a><span class="dt">initLimit</span><span class="ot">=</span><span class="dv">10</span></span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 主从节点之间同步数据的时间限制，若超过这个时间限制，那么从节点将会被丢弃；同样，这里的5表示是tickTime的5倍</span></span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a><span class="dt">syncLimit</span><span class="ot">=</span><span class="dv">5</span></span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 存放数据的目录</span></span>
<span id="cb321-8"><a href="#cb321-8" aria-hidden="true" tabindex="-1"></a><span class="dt">dataDir</span><span class="ot">=</span><span class="st">/tmp/zookeeper</span></span>
<span id="cb321-9"><a href="#cb321-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 用于连接客户端的端口</span></span>
<span id="cb321-10"><a href="#cb321-10" aria-hidden="true" tabindex="-1"></a><span class="dt">clientPort</span><span class="ot">=</span><span class="dv">2181</span></span>
<span id="cb321-11"><a href="#cb321-11" aria-hidden="true" tabindex="-1"></a><span class="co"># the maximum number of client connections</span></span>
<span id="cb321-12"><a href="#cb321-12" aria-hidden="true" tabindex="-1"></a><span class="co">#maxClientCnxns=60</span></span>
<span id="cb321-13"><a href="#cb321-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb321-14"><a href="#cb321-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Be sure to read the maintenance section of the </span></span>
<span id="cb321-15"><a href="#cb321-15" aria-hidden="true" tabindex="-1"></a><span class="co"># administrator guide before turning on autopurge.</span></span>
<span id="cb321-16"><a href="#cb321-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb321-17"><a href="#cb321-17" aria-hidden="true" tabindex="-1"></a><span class="co"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span>
<span id="cb321-18"><a href="#cb321-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb321-19"><a href="#cb321-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The number of snapshots to retain in dataDir</span></span>
<span id="cb321-20"><a href="#cb321-20" aria-hidden="true" tabindex="-1"></a><span class="co">#autopurge.snapRetainCount=3</span></span>
<span id="cb321-21"><a href="#cb321-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Purge task interval in hours</span></span>
<span id="cb321-22"><a href="#cb321-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Set to &quot;0&quot; to disable auto purge feature</span></span>
<span id="cb321-23"><a href="#cb321-23" aria-hidden="true" tabindex="-1"></a><span class="co">#autopurge.purgeInterval=1</span></span></code></pre></div>
<p>启动</p>
<pre class="shell"><code>bin/zkServer.sh start</code></pre>
<h3 id="命令行">命令行</h3>
<p>客户端连接</p>
<pre class="shell"><code>bin/zkCli.sh -server 127.0.0.1:2181</code></pre>
<h4 id="常用命令">常用命令</h4>
<pre class="shell"><code>[zk: 127.0.0.1:2181(CONNECTED) 0] help
ZooKeeper -server host:port cmd args
    stat path [watch]
    set path data [version]
    ls path [watch]
    delquota [-n|-b] path
    ls2 path [watch]
    setAcl path acl
    setquota -n|-b val path
    history 
    redo cmdno
    printwatches on|off
    delete path [version]
    sync path
    listquota path
    rmr path
    get path [watch]
    create [-s] [-e] path data acl
    addauth scheme auth
    quit 
    getAcl path
    close 
    connect host:port</code></pre>
<p>比如</p>
<pre class="shell"><code> create /node1 data1    # 增
 create -e /node2 data2 # 创建临时节点，在客户端退出(CTRL + C)一定时间后就会被删除，或者使用quit退出时立即删除
 create -s /node data   # 创建顺序节点，此时实际创建的是/node0000000001
 delete /node1          # 删
 set /node1 newdata     # 改
 get /node1             # 查
 ls /       # 查看节点及其所有子节点
 ls2 /      # 查看节点及详细信息
 stat /node1            # 查看该节点详细信息
 history        # 查看输入的所有命令</code></pre>
<h4 id="watch机制">Watch机制</h4>
<p>添加watch有多种方式</p>
<pre class="shell"><code>stat /node1 watch
ls /node1 watch
ls2 /node1 watch
get /node1 watch</code></pre>
<p>此时如果对<code>/node1</code>进行修改，就会触发watch，但在命令行中watch被触发一次就会失效</p>
<pre><code>[zk: 127.0.0.1:2181(CONNECTED) 0] set /node1 newdata

WATCHER::

WatchedEvent state:SyncConnected type:NodeDataChanged path:/node1</code></pre>
<p>也可以给不存在的节点添加watch，如果以后添加该节点，就会触发watch</p>
<pre class="shell"><code>[zk: 127.0.0.1:2181(CONNECTED) 0] stat /node2 watch
Node does not exist: /node2
[zk: 127.0.0.1:2181(CONNECTED) 1] create /node2 data2

WATCHER::

WatchedEvent state:SyncConnected type:NodeCreated path:/node2
Created /node2</code></pre>
<h4 id="acl">ACL</h4>
<p>ACL是Access Control List，它可以控制权限</p>
<p>查看</p>
<pre class="shell"><code>[zk: 127.0.0.1:2181(CONNECTED) 0] getAcl /node1
&#39;world,&#39;anyone
: cdrwa</code></pre>
<p>world是权限模式的一种，anyone表示任何人都可以对该节点进行cdrwa操作，而cdrwa分别代表create、delete、read、write、admin(设置权限)</p>
<p><strong>scheme</strong></p>
<p>scheme是权限模式，常用的有如下</p>
<p>1、world: 最开放的权限控制模式</p>
<pre class="shell"><code>setAcl /node1 world:anyone:cdrwa</code></pre>
<p>2、auth: 和digest一样，只是这里的密码使用明文</p>
<pre class="shell"><code>[zk: 127.0.0.1:2181(CONNECTED) 0] addauth digest username:password # 使用前需先添加用户
[zk: 127.0.0.1:2181(CONNECTED) 1] setAcl /node1 auth:username:password:cdrwa # 然后使用该用户给节点添加权限
[zk: 127.0.0.1:2181(CONNECTED) 2] getAcl /node1                             
&#39;digest,&#39;username:+Ir5sN1lGJEEs8xBZhZXKvjLJ7c=
: cdrwa</code></pre>
<p>3、digest: 密码输入时使用密文</p>
<pre class="shell"><code>[zk: 127.0.0.1:2181(CONNECTED) 0] addauth digest username:password # 使用前需先添加用户
[zk: 127.0.0.1:2181(CONNECTED) 1] setAcl /node1 digest:username:+Ir5sN1lGJEEs8xBZhZXKvjLJ7c=:cdrwa
[zk: 127.0.0.1:2181(CONNECTED) 2] getAcl /node1
&#39;digest,&#39;username:+Ir5sN1lGJEEs8xBZhZXKvjLJ7c=
: cdrwa</code></pre>
<p>4、ip: 根据ip授权</p>
<pre class="shell"><code>setAcl /node1 ip:127.0.0.1:cdrwa</code></pre>
<p>5、super:
管理员权限，它和其他权限模式不一样，设置super需要更改<code>bin/zkServer.sh</code></p>
<p>首先获取加密的字符串，这里需要用JAVA代码生成</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> str <span class="op">=</span> DigestAuthenticationProvider<span class="op">.</span><span class="fu">generateDigest</span><span class="op">(</span><span class="st">&quot;super:admin&quot;</span><span class="op">);</span></span></code></pre></div>
<p>得到<code>super:xQJmxLMiHGwaqBvst5y6rkB6HQs=</code></p>
<p>打开<code>bin/zkServer.sh</code>，找到</p>
<pre class="shell"><code>nohup &quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=${ZOO_LOG_DIR}&quot; &quot;-Dzookeeper.root.logger=${ZOO_LOG4J_PROP}&quot; \</code></pre>
<p>改成</p>
<pre class="shell"><code>nohup &quot;$JAVA&quot; &quot;-Dzookeeper.log.dir=${ZOO_LOG_DIR}&quot; &quot;-Dzookeeper.root.logger=${ZOO_LOG4J_PROP}&quot; &quot;-Dzookeeper.DigestAuthenticationProvider.superDigest=super:xQJmxLMiHGwaqBvst5y6rkB6HQs=&quot; \</code></pre>
<p>使用：</p>
<pre class="shell"><code>addauth digest super:admin</code></pre>
<h3 id="四字命令">四字命令</h3>
<p><a href="http://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperAdmin.html#sc_4lw">文档</a></p>
<p>使用四字命令可以在不登录客户端的情况下获取运行的信息（需安装<code>nc</code>）</p>
<pre class="shell"><code>root@root:~$ echo conf | nc 127.0.0.1 2181
clientPort=2181
dataDir=/tmp/zookeeper/version-2
dataLogDir=/tmp/zookeeper/version-2
tickTime=2000
maxClientCnxns=60
minSessionTimeout=4000
maxSessionTimeout=40000
serverId=0</code></pre>
<ul>
<li>conf: 输出相关服务配置的详细信息</li>
<li>cons:
列出所有连接到这台服务器的客户端连接/会话的详细信息（包括“接受/发送”的包数量、session
id 、操作延迟、最后的操作执行等信息）</li>
<li>crst: 重置当前这台服务器所有连接/会话的统计信息</li>
<li>dump: 列出未经处理的会话和临时节点（只在leader上有效）</li>
<li>envi: 输出关于服务器的环境变量详细信息</li>
<li>ruok:
测试服务是否处于正确运行状态（如果正常返回”imok”，否则返回空）</li>
<li>srst: 重置服务器的统计信息</li>
<li>srvr:
输出服务器的详细信息（zk版本、接收/发送包数量、连接数、模式（leader/follower）、节点总数）</li>
<li>stat:
输出服务器的详细信息（接收/发送包数量、连接数、模式（leader/follower）、节点总数、延迟、
所有客户端的列表）</li>
<li>wchs:
列出服务器watches的简洁信息（连接总数、watching节点总数和watches总数）</li>
<li>wchc:
通过session分组，列出watch的所有节点（如果watches数量很大的话，将会产生很大的开销，会影响性能，小心使用）</li>
<li>wchp: 通过路径分组，列出所有的 watch 的session
id信息（如果watches数量很大的话，将会产生很大的开销，会影响性能，小心使用）</li>
<li>mntr:
列出集群的健康状态（包括“接受/发送”的包数量、操作延迟、当前服务模式(leader/follower)、节点总数、watch总数、临时节点总数）</li>
</ul>
<h3 id="集群搭建-1">集群搭建</h3>
<p>zookeeper集群至少需要三台主机，一台leader(主节点)，两台follower(从节点)</p>
<p>这里用伪集群来模拟集群环境。伪集群就是在一台机器上模拟集群的环境，此时各zookeeper之间的ip相同，端口号不同（集群就是ip不同，但端口号可以相同）</p>
<p>配置<code>conf/zoo.cfg</code>，给不同的zookeeper配置不同的端口(<code>clientPort</code>，客户端连接用的端口)，然后添加<code>server.1</code>节点，其中192.168.1.2是zookeeper所在服务器的ip，2888是主从复制用的端口，3888是当主节点宕机后选举新的主节点用的端口（和Redis不同，这里的选举是自动的，不需要额外配置，而且如果以后主节点重新上线，就会变成从节点）</p>
<p>zookeeper01/conf/zoo.cfg</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="dt">tickTime</span><span class="ot">=</span><span class="dv">2000</span></span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a><span class="dt">initLimit</span><span class="ot">=</span><span class="dv">10</span></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="dt">syncLimit</span><span class="ot">=</span><span class="dv">5</span></span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a><span class="dt">dataDir</span><span class="ot">=</span><span class="st">/tmp/zookeeper01</span></span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 不同的zookeeper在伪集群环境下用的端口号不同，其余配置一样</span></span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a><span class="dt">clientPort</span><span class="ot">=</span><span class="dv">2181</span></span>
<span id="cb339-7"><a href="#cb339-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-8"><a href="#cb339-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 三台zookeeper主机都要在这里配置，各主机这里的配置是一样的</span></span>
<span id="cb339-9"><a href="#cb339-9" aria-hidden="true" tabindex="-1"></a><span class="dt">server.1</span><span class="ot">=</span><span class="st">192.168.1.2:2888:3888</span></span>
<span id="cb339-10"><a href="#cb339-10" aria-hidden="true" tabindex="-1"></a><span class="dt">server.2</span><span class="ot">=</span><span class="st">192.168.1.2:2889:3889</span></span>
<span id="cb339-11"><a href="#cb339-11" aria-hidden="true" tabindex="-1"></a><span class="dt">server.3</span><span class="ot">=</span><span class="st">192.168.1.2:2890:3890</span></span></code></pre></div>
<p>然后在指定的<code>dataDir</code>下创建<code>myid</code>文件，<code>server.1</code>就创建内容为<code>1</code>的文件，<code>server.2</code>就创建内容为<code>2</code>，依次类推</p>
<pre class="shell"><code>echo 1 &gt; /tmp/zookeeper01/myid</code></pre>
<p>/tmp/zookeeper01/myid</p>
<pre><code>1</code></pre>
<p>然后依次启动zookeeper服务即可</p>
<pre class="shell"><code>bin/zkServer.sh start
# 查看状态，主节点会显示leader，从节点会显示follower，主从节点和启动顺序无关，和选举算法有关
bin/zkServer.sh status</code></pre>
<h3 id="原生java客户端">原生JAVA客户端</h3>
<h4 id="pom.xml-2">pom.xml</h4>
<div class="sourceCode" id="cb343"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">project</span><span class="ot"> xmlns=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span>
<span id="cb343-3"><a href="#cb343-3" aria-hidden="true" tabindex="-1"></a><span class="ot">         xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb343-4"><a href="#cb343-4" aria-hidden="true" tabindex="-1"></a><span class="ot">         xsi:schemaLocation=</span><span class="st">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>
<span id="cb343-5"><a href="#cb343-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">modelVersion</span>&gt;4.0.0&lt;/<span class="kw">modelVersion</span>&gt;</span>
<span id="cb343-6"><a href="#cb343-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-7"><a href="#cb343-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;myapp&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb343-8"><a href="#cb343-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;zktest&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb343-9"><a href="#cb343-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.0-SNAPSHOT&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb343-10"><a href="#cb343-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-11"><a href="#cb343-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">properties</span>&gt;</span>
<span id="cb343-12"><a href="#cb343-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">project.build.sourceEncoding</span>&gt;UTF-8&lt;/<span class="kw">project.build.sourceEncoding</span>&gt;</span>
<span id="cb343-13"><a href="#cb343-13" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">properties</span>&gt;</span>
<span id="cb343-14"><a href="#cb343-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-15"><a href="#cb343-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb343-16"><a href="#cb343-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb343-17"><a href="#cb343-17" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.apache.zookeeper&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb343-18"><a href="#cb343-18" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;zookeeper&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb343-19"><a href="#cb343-19" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;3.4.13&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb343-20"><a href="#cb343-20" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb343-21"><a href="#cb343-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-22"><a href="#cb343-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb343-23"><a href="#cb343-23" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;log4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb343-24"><a href="#cb343-24" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;log4j&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb343-25"><a href="#cb343-25" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;1.2.16&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb343-26"><a href="#cb343-26" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb343-27"><a href="#cb343-27" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb343-28"><a href="#cb343-28" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb343-29"><a href="#cb343-29" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb343-30"><a href="#cb343-30" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb343-31"><a href="#cb343-31" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb343-32"><a href="#cb343-32" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependencies</span>&gt;</span>
<span id="cb343-33"><a href="#cb343-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 指定JDK版本为8 --&gt;</span></span>
<span id="cb343-34"><a href="#cb343-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">build</span>&gt;</span>
<span id="cb343-35"><a href="#cb343-35" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">plugins</span>&gt;</span>
<span id="cb343-36"><a href="#cb343-36" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">plugin</span>&gt;</span>
<span id="cb343-37"><a href="#cb343-37" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">groupId</span>&gt;org.apache.maven.plugins&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb343-38"><a href="#cb343-38" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">artifactId</span>&gt;maven-compiler-plugin&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb343-39"><a href="#cb343-39" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">version</span>&gt;2.3.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb343-40"><a href="#cb343-40" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">configuration</span>&gt;</span>
<span id="cb343-41"><a href="#cb343-41" aria-hidden="true" tabindex="-1"></a>                    &lt;<span class="kw">source</span>&gt;1.8&lt;/<span class="kw">source</span>&gt;</span>
<span id="cb343-42"><a href="#cb343-42" aria-hidden="true" tabindex="-1"></a>                    &lt;<span class="kw">target</span>&gt;1.8&lt;/<span class="kw">target</span>&gt;</span>
<span id="cb343-43"><a href="#cb343-43" aria-hidden="true" tabindex="-1"></a>                &lt;/<span class="kw">configuration</span>&gt;</span>
<span id="cb343-44"><a href="#cb343-44" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">plugin</span>&gt;</span>
<span id="cb343-45"><a href="#cb343-45" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">plugins</span>&gt;</span>
<span id="cb343-46"><a href="#cb343-46" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">build</span>&gt;</span>
<span id="cb343-47"><a href="#cb343-47" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">project</span>&gt;</span></code></pre></div>
<h4 id="增删改查">增删改查</h4>
<div class="sourceCode" id="cb344"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyWatcher <span class="kw">implements</span> Watcher <span class="op">{</span></span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">CountDownLatch</span> countDownLatch<span class="op">;</span></span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> ZooKeeper zooKeeper<span class="op">;</span></span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyWatcher</span><span class="op">(</span><span class="bu">CountDownLatch</span> countDownLatch<span class="op">)</span> <span class="op">{</span></span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">countDownLatch</span> <span class="op">=</span> countDownLatch<span class="op">;</span></span>
<span id="cb344-7"><a href="#cb344-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb344-8"><a href="#cb344-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-9"><a href="#cb344-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setZooKeeper</span><span class="op">(</span>ZooKeeper zooKeeper<span class="op">)</span> <span class="op">{</span></span>
<span id="cb344-10"><a href="#cb344-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">zooKeeper</span> <span class="op">=</span> zooKeeper<span class="op">;</span></span>
<span id="cb344-11"><a href="#cb344-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb344-12"><a href="#cb344-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-13"><a href="#cb344-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb344-14"><a href="#cb344-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">process</span><span class="op">(</span>WatchedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb344-15"><a href="#cb344-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Receive watched event: &quot;</span> <span class="op">+</span> event<span class="op">);</span></span>
<span id="cb344-16"><a href="#cb344-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getState</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb344-17"><a href="#cb344-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> SyncConnected<span class="op">:</span></span>
<span id="cb344-18"><a href="#cb344-18" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[SyncConnected]&quot;</span><span class="op">);</span></span>
<span id="cb344-19"><a href="#cb344-19" aria-hidden="true" tabindex="-1"></a>                countDownLatch<span class="op">.</span><span class="fu">countDown</span><span class="op">();</span></span>
<span id="cb344-20"><a href="#cb344-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-21"><a href="#cb344-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Disconnected<span class="op">:</span></span>
<span id="cb344-22"><a href="#cb344-22" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[Disconnected]&quot;</span><span class="op">);</span></span>
<span id="cb344-23"><a href="#cb344-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-24"><a href="#cb344-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> AuthFailed<span class="op">:</span></span>
<span id="cb344-25"><a href="#cb344-25" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[AuthFailed]&quot;</span><span class="op">);</span></span>
<span id="cb344-26"><a href="#cb344-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-27"><a href="#cb344-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> SaslAuthenticated<span class="op">:</span></span>
<span id="cb344-28"><a href="#cb344-28" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[SaslAuthenticated]&quot;</span><span class="op">);</span></span>
<span id="cb344-29"><a href="#cb344-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-30"><a href="#cb344-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> Expired<span class="op">:</span></span>
<span id="cb344-31"><a href="#cb344-31" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[Expired]&quot;</span><span class="op">);</span></span>
<span id="cb344-32"><a href="#cb344-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb344-33"><a href="#cb344-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-34"><a href="#cb344-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb344-35"><a href="#cb344-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-36"><a href="#cb344-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getType</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb344-37"><a href="#cb344-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> None<span class="op">:</span></span>
<span id="cb344-38"><a href="#cb344-38" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[None]&quot;</span><span class="op">);</span></span>
<span id="cb344-39"><a href="#cb344-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-40"><a href="#cb344-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> NodeCreated<span class="op">:</span></span>
<span id="cb344-41"><a href="#cb344-41" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[NodeCreated]&quot;</span><span class="op">);</span></span>
<span id="cb344-42"><a href="#cb344-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-43"><a href="#cb344-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> NodeDeleted<span class="op">:</span></span>
<span id="cb344-44"><a href="#cb344-44" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[NodeDeleted]&quot;</span><span class="op">);</span></span>
<span id="cb344-45"><a href="#cb344-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-46"><a href="#cb344-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> NodeDataChanged<span class="op">:</span></span>
<span id="cb344-47"><a href="#cb344-47" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[NodeDataChanged]&quot;</span><span class="op">);</span></span>
<span id="cb344-48"><a href="#cb344-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-49"><a href="#cb344-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> NodeChildrenChanged<span class="op">:</span></span>
<span id="cb344-50"><a href="#cb344-50" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[NodeChildrenChanged]&quot;</span><span class="op">);</span></span>
<span id="cb344-51"><a href="#cb344-51" aria-hidden="true" tabindex="-1"></a>                <span class="co">//获取子节点</span></span>
<span id="cb344-52"><a href="#cb344-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb344-53"><a href="#cb344-53" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> child <span class="op">:</span> zooKeeper<span class="op">.</span><span class="fu">getChildren</span><span class="op">(</span>event<span class="op">.</span><span class="fu">getPath</span><span class="op">(),</span> <span class="kw">false</span><span class="op">))</span></span>
<span id="cb344-54"><a href="#cb344-54" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">(</span>child <span class="op">+</span> <span class="st">&quot; &quot;</span><span class="op">);</span></span>
<span id="cb344-55"><a href="#cb344-55" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb344-56"><a href="#cb344-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb344-57"><a href="#cb344-57" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb344-58"><a href="#cb344-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb344-59"><a href="#cb344-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-60"><a href="#cb344-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb344-61"><a href="#cb344-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb344-62"><a href="#cb344-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb344-63"><a href="#cb344-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb344-64"><a href="#cb344-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb344-65"><a href="#cb344-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-66"><a href="#cb344-66" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb344-67"><a href="#cb344-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb344-68"><a href="#cb344-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-69"><a href="#cb344-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">CountDownLatch</span> countDownLatch <span class="op">=</span> <span class="kw">new</span> <span class="bu">CountDownLatch</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb344-70"><a href="#cb344-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-71"><a href="#cb344-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">//连接服务端，Watcher不仅可以监听当前连接的事件，还可以监听其他连接（包括命令行客户端）的事件</span></span>
<span id="cb344-72"><a href="#cb344-72" aria-hidden="true" tabindex="-1"></a>        MyWatcher myWatcher <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyWatcher</span><span class="op">(</span>countDownLatch<span class="op">);</span></span>
<span id="cb344-73"><a href="#cb344-73" aria-hidden="true" tabindex="-1"></a>        ZooKeeper zookeeper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ZooKeeper</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> <span class="dv">5000</span><span class="op">,</span> myWatcher<span class="op">);</span></span>
<span id="cb344-74"><a href="#cb344-74" aria-hidden="true" tabindex="-1"></a>        myWatcher<span class="op">.</span><span class="fu">setZooKeeper</span><span class="op">(</span>zookeeper<span class="op">);</span></span>
<span id="cb344-75"><a href="#cb344-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;connection status: &quot;</span> <span class="op">+</span> zookeeper<span class="op">.</span><span class="fu">getState</span><span class="op">());</span></span>
<span id="cb344-76"><a href="#cb344-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-77"><a href="#cb344-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">//创建连接需要时间，这里不用countDownLatch也可以，执行命令时会等待连接完成再执行</span></span>
<span id="cb344-78"><a href="#cb344-78" aria-hidden="true" tabindex="-1"></a>        countDownLatch<span class="op">.</span><span class="fu">await</span><span class="op">();</span></span>
<span id="cb344-79"><a href="#cb344-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;connection status: &quot;</span> <span class="op">+</span> zookeeper<span class="op">.</span><span class="fu">getState</span><span class="op">());</span></span>
<span id="cb344-80"><a href="#cb344-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-81"><a href="#cb344-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">//如果断开连接，可以使用sessionId和sessionPasswd重连</span></span>
<span id="cb344-82"><a href="#cb344-82" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> sessionId <span class="op">=</span> zookeeper<span class="op">.</span><span class="fu">getSessionId</span><span class="op">();</span></span>
<span id="cb344-83"><a href="#cb344-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> sessionPasswd <span class="op">=</span> zookeeper<span class="op">.</span><span class="fu">getSessionPasswd</span><span class="op">();</span></span>
<span id="cb344-84"><a href="#cb344-84" aria-hidden="true" tabindex="-1"></a>        zookeeper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ZooKeeper</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> <span class="dv">5000</span><span class="op">,</span> myWatcher<span class="op">,</span> sessionId<span class="op">,</span> sessionPasswd<span class="op">);</span></span>
<span id="cb344-85"><a href="#cb344-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-86"><a href="#cb344-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">//同步方式创建节点，Ids.OPEN_ACL_UNSAFE为world权限，CreateMode.EPHEMERAL相当于-e参数，表示是临时节点；如果一个节点已经存在，那么创建同名节点时，会抛出NodeExistsException异常，且无法在父节点不存在的情况下创建一个子节点</span></span>
<span id="cb344-87"><a href="#cb344-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> path1 <span class="op">=</span> zookeeper<span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;data1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> ZooDefs<span class="op">.</span><span class="fu">Ids</span><span class="op">.</span><span class="fu">OPEN_ACL_UNSAFE</span><span class="op">,</span> CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">);</span></span>
<span id="cb344-88"><a href="#cb344-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-89"><a href="#cb344-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">//异步方式创建节点</span></span>
<span id="cb344-90"><a href="#cb344-90" aria-hidden="true" tabindex="-1"></a>        zookeeper<span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="st">&quot;/node2&quot;</span><span class="op">,</span> <span class="st">&quot;data2&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> ZooDefs<span class="op">.</span><span class="fu">Ids</span><span class="op">.</span><span class="fu">OPEN_ACL_UNSAFE</span><span class="op">,</span> CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">,</span></span>
<span id="cb344-91"><a href="#cb344-91" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> AsyncCallback<span class="op">.</span><span class="fu">StringCallback</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb344-92"><a href="#cb344-92" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">processResult</span><span class="op">(</span><span class="dt">int</span> rc<span class="op">,</span> <span class="bu">String</span> path<span class="op">,</span> <span class="bu">Object</span> ctx<span class="op">,</span> <span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb344-93"><a href="#cb344-93" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;rc = &quot;</span> <span class="op">+</span> rc <span class="op">+</span> <span class="st">&quot;, path = &quot;</span> <span class="op">+</span> path <span class="op">+</span> <span class="st">&quot;, ctx = &quot;</span> <span class="op">+</span> ctx <span class="op">+</span> <span class="st">&quot;, name = &quot;</span> <span class="op">+</span> name<span class="op">);</span></span>
<span id="cb344-94"><a href="#cb344-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-95"><a href="#cb344-95" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//ctx是一个标志，如果多个方法使用同一个callback，可以根据ctx执行对应的操作</span></span>
<span id="cb344-96"><a href="#cb344-96" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>ctx<span class="op">.</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;create:succeeded&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb344-97"><a href="#cb344-97" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//...</span></span>
<span id="cb344-98"><a href="#cb344-98" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb344-99"><a href="#cb344-99" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb344-100"><a href="#cb344-100" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span> <span class="st">&quot;create:succeeded&quot;</span><span class="op">);</span></span>
<span id="cb344-101"><a href="#cb344-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-102"><a href="#cb344-102" aria-hidden="true" tabindex="-1"></a>        <span class="co">//更改节点数据，第二个参数为版本号，-1表示匹配所有的版本</span></span>
<span id="cb344-103"><a href="#cb344-103" aria-hidden="true" tabindex="-1"></a>        Stat stat1 <span class="op">=</span> zookeeper<span class="op">.</span><span class="fu">setData</span><span class="op">(</span>path1<span class="op">,</span> <span class="st">&quot;newdata&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb344-104"><a href="#cb344-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>path1 <span class="op">+</span> <span class="st">&quot; version: &quot;</span> <span class="op">+</span> stat1<span class="op">.</span><span class="fu">getVersion</span><span class="op">());</span></span>
<span id="cb344-105"><a href="#cb344-105" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以异步更改</span></span>
<span id="cb344-106"><a href="#cb344-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">//zookeeper.setData(String path,byte data[], int version, StatCallback cb, Object ctx)</span></span>
<span id="cb344-107"><a href="#cb344-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-108"><a href="#cb344-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取子节点，第二个参数为是否触发watcher</span></span>
<span id="cb344-109"><a href="#cb344-109" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>path1 <span class="op">+</span> <span class="st">&quot; children: &quot;</span><span class="op">);</span></span>
<span id="cb344-110"><a href="#cb344-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> child <span class="op">:</span> zookeeper<span class="op">.</span><span class="fu">getChildren</span><span class="op">(</span>path1<span class="op">,</span> <span class="kw">true</span><span class="op">))</span></span>
<span id="cb344-111"><a href="#cb344-111" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">(</span>child <span class="op">+</span> <span class="st">&quot; &quot;</span><span class="op">);</span></span>
<span id="cb344-112"><a href="#cb344-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">();</span></span>
<span id="cb344-113"><a href="#cb344-113" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以使用其他Watcher</span></span>
<span id="cb344-114"><a href="#cb344-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">//zookeeper.getChildren(String path, Watcher watcher)</span></span>
<span id="cb344-115"><a href="#cb344-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以异步使用</span></span>
<span id="cb344-116"><a href="#cb344-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">//zookeeper.getChildren(String path, Watcher watcher, ChildrenCallback cb, Object ctx)</span></span>
<span id="cb344-117"><a href="#cb344-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-118"><a href="#cb344-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取节点数据</span></span>
<span id="cb344-119"><a href="#cb344-119" aria-hidden="true" tabindex="-1"></a>        Stat stat2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Stat</span><span class="op">();</span></span>
<span id="cb344-120"><a href="#cb344-120" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> bytes <span class="op">=</span> zookeeper<span class="op">.</span><span class="fu">getData</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span><span class="kw">true</span><span class="op">,</span>stat2<span class="op">);</span></span>
<span id="cb344-121"><a href="#cb344-121" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>bytes<span class="op">));</span></span>
<span id="cb344-122"><a href="#cb344-122" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;/node1 version: &quot;</span><span class="op">+</span>stat2<span class="op">.</span><span class="fu">getVersion</span><span class="op">());</span></span>
<span id="cb344-123"><a href="#cb344-123" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以异步获取</span></span>
<span id="cb344-124"><a href="#cb344-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">//zookeeper.getData(final String path, Watcher watcher, DataCallback cb, Object ctx)</span></span>
<span id="cb344-125"><a href="#cb344-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-126"><a href="#cb344-126" aria-hidden="true" tabindex="-1"></a>        <span class="co">//删除节点，只允许删除叶子节点，即一个节点如果有子节点，那么该节点将无法直接删除，必须先删掉其所有子节点；第二个参数为版本号，-1表示匹配所有的版本</span></span>
<span id="cb344-127"><a href="#cb344-127" aria-hidden="true" tabindex="-1"></a>        zookeeper<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>path1<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb344-128"><a href="#cb344-128" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以异步删除</span></span>
<span id="cb344-129"><a href="#cb344-129" aria-hidden="true" tabindex="-1"></a>        <span class="co">//zookeeper.delete(String path, int version, VoidCallback cb, Object ctx)</span></span>
<span id="cb344-130"><a href="#cb344-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb344-131"><a href="#cb344-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">//由于没有使用异步的方式执行命令，需等待至命令执行完成再退出</span></span>
<span id="cb344-132"><a href="#cb344-132" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500L</span><span class="op">);</span></span>
<span id="cb344-133"><a href="#cb344-133" aria-hidden="true" tabindex="-1"></a>        zookeeper<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb344-134"><a href="#cb344-134" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb344-135"><a href="#cb344-135" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="acl-1">ACL</h4>
<div class="sourceCode" id="cb345"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>ZooKeeper zookeeper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ZooKeeper</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> <span class="dv">5000</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">Watcher</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">process</span><span class="op">(</span>WatchedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Receive watched event: &quot;</span> <span class="op">+</span> event<span class="op">);</span></span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-8"><a href="#cb345-8" aria-hidden="true" tabindex="-1"></a><span class="co">//命令行设置权限的命令为 setAcl /node1 auth:username:password:cdrwa</span></span>
<span id="cb345-9"><a href="#cb345-9" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>ACL<span class="op">&gt;</span> acls <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb345-10"><a href="#cb345-10" aria-hidden="true" tabindex="-1"></a>Id token1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Id</span><span class="op">(</span><span class="st">&quot;digest&quot;</span><span class="op">,</span> DigestAuthenticationProvider<span class="op">.</span><span class="fu">generateDigest</span><span class="op">(</span><span class="st">&quot;username1:password1&quot;</span><span class="op">));</span></span>
<span id="cb345-11"><a href="#cb345-11" aria-hidden="true" tabindex="-1"></a>Id token2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Id</span><span class="op">(</span><span class="st">&quot;digest&quot;</span><span class="op">,</span> DigestAuthenticationProvider<span class="op">.</span><span class="fu">generateDigest</span><span class="op">(</span><span class="st">&quot;username2:password2&quot;</span><span class="op">));</span></span>
<span id="cb345-12"><a href="#cb345-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-13"><a href="#cb345-13" aria-hidden="true" tabindex="-1"></a>acls<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ACL</span><span class="op">(</span>ZooDefs<span class="op">.</span><span class="fu">Perms</span><span class="op">.</span><span class="fu">ALL</span><span class="op">,</span> token1<span class="op">));</span></span>
<span id="cb345-14"><a href="#cb345-14" aria-hidden="true" tabindex="-1"></a><span class="co">//多个权限可以用&quot;|&quot;</span></span>
<span id="cb345-15"><a href="#cb345-15" aria-hidden="true" tabindex="-1"></a>acls<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ACL</span><span class="op">(</span>ZooDefs<span class="op">.</span><span class="fu">Perms</span><span class="op">.</span><span class="fu">READ</span> <span class="op">|</span> ZooDefs<span class="op">.</span><span class="fu">Perms</span><span class="op">.</span><span class="fu">DELETE</span><span class="op">,</span> token2<span class="op">));</span></span>
<span id="cb345-16"><a href="#cb345-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-17"><a href="#cb345-17" aria-hidden="true" tabindex="-1"></a>zookeeper<span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;data1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> acls<span class="op">,</span> CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">);</span></span>
<span id="cb345-18"><a href="#cb345-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-19"><a href="#cb345-19" aria-hidden="true" tabindex="-1"></a><span class="co">//ip方式</span></span>
<span id="cb345-20"><a href="#cb345-20" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>ACL<span class="op">&gt;</span> aclsIP <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb345-21"><a href="#cb345-21" aria-hidden="true" tabindex="-1"></a>Id token3 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Id</span><span class="op">(</span><span class="st">&quot;ip&quot;</span><span class="op">,</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb345-22"><a href="#cb345-22" aria-hidden="true" tabindex="-1"></a>aclsIP<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ACL</span><span class="op">(</span>ZooDefs<span class="op">.</span><span class="fu">Perms</span><span class="op">.</span><span class="fu">ALL</span><span class="op">,</span> token3<span class="op">));</span></span>
<span id="cb345-23"><a href="#cb345-23" aria-hidden="true" tabindex="-1"></a>zookeeper<span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="st">&quot;/node2&quot;</span><span class="op">,</span> <span class="st">&quot;data2&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> aclsIP<span class="op">,</span> CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">);</span></span>
<span id="cb345-24"><a href="#cb345-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-25"><a href="#cb345-25" aria-hidden="true" tabindex="-1"></a><span class="co">//操作时需要先授权</span></span>
<span id="cb345-26"><a href="#cb345-26" aria-hidden="true" tabindex="-1"></a>zookeeper<span class="op">.</span><span class="fu">addAuthInfo</span><span class="op">(</span><span class="st">&quot;digest&quot;</span><span class="op">,</span> <span class="st">&quot;username1:password1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb345-27"><a href="#cb345-27" aria-hidden="true" tabindex="-1"></a>zookeeper<span class="op">.</span><span class="fu">setData</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;test&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb345-28"><a href="#cb345-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-29"><a href="#cb345-29" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500L</span><span class="op">);</span></span>
<span id="cb345-30"><a href="#cb345-30" aria-hidden="true" tabindex="-1"></a>zookeeper<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h3 id="curator客户端">Curator客户端</h3>
<p>Curator是在原生zookeeper的JAVA客户端的基础上增加了更多功能的zookeeper的JAVA客户端</p>
<h4 id="pom.xml-3">pom.xml</h4>
<div class="sourceCode" id="cb346"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- curator依赖原生的zookeeper API --&gt;</span></span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.zookeeper&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;zookeeper&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;3.4.13&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb346-8"><a href="#cb346-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- curator --&gt;</span></span>
<span id="cb346-9"><a href="#cb346-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb346-10"><a href="#cb346-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.curator&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb346-11"><a href="#cb346-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;curator-framework&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb346-12"><a href="#cb346-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;4.0.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb346-13"><a href="#cb346-13" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb346-14"><a href="#cb346-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb346-15"><a href="#cb346-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.curator&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb346-16"><a href="#cb346-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;curator-recipes&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb346-17"><a href="#cb346-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;4.0.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb346-18"><a href="#cb346-18" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb346-19"><a href="#cb346-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 日志 --&gt;</span></span>
<span id="cb346-20"><a href="#cb346-20" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb346-21"><a href="#cb346-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb346-22"><a href="#cb346-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb346-23"><a href="#cb346-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb346-24"><a href="#cb346-24" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb346-25"><a href="#cb346-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb346-26"><a href="#cb346-26" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb346-27"><a href="#cb346-27" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;slf4j-nop&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb346-28"><a href="#cb346-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;1.7.2&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb346-29"><a href="#cb346-29" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb346-30"><a href="#cb346-30" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependencies</span>&gt;</span></code></pre></div>
<h4 id="增删改查-1">增删改查</h4>
<div class="sourceCode" id="cb347"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> connectionString <span class="op">=</span> <span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">;</span></span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//多个zookeeper可以用逗号分隔</span></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//String connectionString = &quot;192.168.1.2:2181,192.168.1.3:2181,192.168.1.4:2181&quot;;</span></span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//执行过程中如果连接中断，执行的重试策略，1000为每次重试的时间间隔，3为重试次数</span></span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a>    ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//创建CuratorFramework</span></span>
<span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a>    CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span>connectionString<span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb347-10"><a href="#cb347-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb347-11"><a href="#cb347-11" aria-hidden="true" tabindex="-1"></a><span class="co">    //通过builder创建</span></span>
<span id="cb347-12"><a href="#cb347-12" aria-hidden="true" tabindex="-1"></a><span class="co">    CuratorFramework curator = CuratorFrameworkFactory.builder()</span></span>
<span id="cb347-13"><a href="#cb347-13" aria-hidden="true" tabindex="-1"></a><span class="co">            .connectString(connectionString)</span></span>
<span id="cb347-14"><a href="#cb347-14" aria-hidden="true" tabindex="-1"></a><span class="co">            .retryPolicy(retryPolicy)</span></span>
<span id="cb347-15"><a href="#cb347-15" aria-hidden="true" tabindex="-1"></a><span class="co">            .connectionTimeoutMs(10000)</span></span>
<span id="cb347-16"><a href="#cb347-16" aria-hidden="true" tabindex="-1"></a><span class="co">            .sessionTimeoutMs(5000)</span></span>
<span id="cb347-17"><a href="#cb347-17" aria-hidden="true" tabindex="-1"></a><span class="co">            .namespace(&quot;curator_namespace&quot;)</span></span>
<span id="cb347-18"><a href="#cb347-18" aria-hidden="true" tabindex="-1"></a><span class="co">            .build();</span></span>
<span id="cb347-19"><a href="#cb347-19" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb347-20"><a href="#cb347-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//开启连接</span></span>
<span id="cb347-21"><a href="#cb347-21" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb347-22"><a href="#cb347-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-23"><a href="#cb347-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//----------------------------------------------------------------------</span></span>
<span id="cb347-24"><a href="#cb347-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-25"><a href="#cb347-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">//增(可以使用同步或异步方式)</span></span>
<span id="cb347-26"><a href="#cb347-26" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb347-27"><a href="#cb347-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">)</span><span class="co">//默认创建的是PERSISTENT类型的节点，也可以指定为临时、顺序等模式</span></span>
<span id="cb347-28"><a href="#cb347-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;data1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-29"><a href="#cb347-29" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb347-30"><a href="#cb347-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">creatingParentsIfNeeded</span><span class="op">()</span><span class="co">//如果父路径不存在，可以递归创建</span></span>
<span id="cb347-31"><a href="#cb347-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">)</span><span class="co">//此时node3是临时的，但node2是永久的</span></span>
<span id="cb347-32"><a href="#cb347-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node2/node3&quot;</span><span class="op">,</span> <span class="st">&quot;data23&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-33"><a href="#cb347-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果在创建节点成功，但是服务器在返回结果前宕机，会出现虽然节点创建成功，但客户端不知道的情况；withProtection创建的节点以GUID为前缀，在创建节点时先在父路径中搜索其中包含GUID的节点，如果存在，则认为是之前尝试创建但丢失的节点</span></span>
<span id="cb347-34"><a href="#cb347-34" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb347-35"><a href="#cb347-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withProtection</span><span class="op">()</span></span>
<span id="cb347-36"><a href="#cb347-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">EPHEMERAL_SEQUENTIAL</span><span class="op">)</span></span>
<span id="cb347-37"><a href="#cb347-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node4&quot;</span><span class="op">,</span> <span class="st">&quot;data4&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-38"><a href="#cb347-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-39"><a href="#cb347-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">//----------------------------------------------------------------------</span></span>
<span id="cb347-40"><a href="#cb347-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-41"><a href="#cb347-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">//改</span></span>
<span id="cb347-42"><a href="#cb347-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">//同步方式</span></span>
<span id="cb347-43"><a href="#cb347-43" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">setData</span><span class="op">()</span></span>
<span id="cb347-44"><a href="#cb347-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withVersion</span><span class="op">(-</span><span class="dv">1</span><span class="op">)</span><span class="co">//可以指定version</span></span>
<span id="cb347-45"><a href="#cb347-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;newData1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-46"><a href="#cb347-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">//异步方式(可以使用listener或者callback)</span></span>
<span id="cb347-47"><a href="#cb347-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">//listener</span></span>
<span id="cb347-48"><a href="#cb347-48" aria-hidden="true" tabindex="-1"></a>    CuratorListener setDataListener <span class="op">=</span> <span class="kw">new</span> <span class="fu">CuratorListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb347-49"><a href="#cb347-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb347-50"><a href="#cb347-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">eventReceived</span><span class="op">(</span>CuratorFramework client<span class="op">,</span> CuratorEvent event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb347-51"><a href="#cb347-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">(</span><span class="st">&quot;eventReceived-- &quot;</span> <span class="op">+</span> event <span class="op">+</span> <span class="st">&quot; &quot;</span><span class="op">);</span></span>
<span id="cb347-52"><a href="#cb347-52" aria-hidden="true" tabindex="-1"></a>            <span class="co">//执行成功为0，执行失败不会报错，而是通过resultcode通知</span></span>
<span id="cb347-53"><a href="#cb347-53" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*</span></span>
<span id="cb347-54"><a href="#cb347-54" aria-hidden="true" tabindex="-1"></a><span class="co">               0:    成功</span></span>
<span id="cb347-55"><a href="#cb347-55" aria-hidden="true" tabindex="-1"></a><span class="co">               -4:   ConnectionLoss，即客户端与服务端断开连接</span></span>
<span id="cb347-56"><a href="#cb347-56" aria-hidden="true" tabindex="-1"></a><span class="co">               -110: NodeExists，即节点已经存在</span></span>
<span id="cb347-57"><a href="#cb347-57" aria-hidden="true" tabindex="-1"></a><span class="co">               -112: SessionExpired，即会话过期</span></span>
<span id="cb347-58"><a href="#cb347-58" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb347-59"><a href="#cb347-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getResultCode</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb347-60"><a href="#cb347-60" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">print</span><span class="op">(</span><span class="st">&quot;执行成功 &quot;</span><span class="op">);</span></span>
<span id="cb347-61"><a href="#cb347-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getType</span><span class="op">()</span> <span class="op">==</span> CuratorEventType<span class="op">.</span><span class="fu">SET_DATA</span><span class="op">)</span></span>
<span id="cb347-62"><a href="#cb347-62" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;执行了SET_DATA操作，更改的节点为&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getPath</span><span class="op">());</span></span>
<span id="cb347-63"><a href="#cb347-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb347-64"><a href="#cb347-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb347-65"><a href="#cb347-65" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">getCuratorListenable</span><span class="op">()</span></span>
<span id="cb347-66"><a href="#cb347-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">addListener</span><span class="op">(</span>setDataListener<span class="op">);</span></span>
<span id="cb347-67"><a href="#cb347-67" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">setData</span><span class="op">()</span></span>
<span id="cb347-68"><a href="#cb347-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">inBackground</span><span class="op">()</span><span class="co">//使用异步方式，会触发监听</span></span>
<span id="cb347-69"><a href="#cb347-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;newData2&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-70"><a href="#cb347-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">//listener会触发多次，直至curator.getCuratorListenable().removeListener(setDataListener);</span></span>
<span id="cb347-71"><a href="#cb347-71" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">setData</span><span class="op">()</span></span>
<span id="cb347-72"><a href="#cb347-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">inBackground</span><span class="op">()</span></span>
<span id="cb347-73"><a href="#cb347-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;newData3&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-74"><a href="#cb347-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">//callback只是当前操作有效</span></span>
<span id="cb347-75"><a href="#cb347-75" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">setData</span><span class="op">().</span><span class="fu">inBackground</span><span class="op">(</span><span class="kw">new</span> <span class="fu">BackgroundCallback</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb347-76"><a href="#cb347-76" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb347-77"><a href="#cb347-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">processResult</span><span class="op">(</span>CuratorFramework client<span class="op">,</span> CuratorEvent event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb347-78"><a href="#cb347-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;processResult-- &quot;</span> <span class="op">+</span> event<span class="op">);</span></span>
<span id="cb347-79"><a href="#cb347-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb347-80"><a href="#cb347-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}).</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;newData4&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb347-81"><a href="#cb347-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-82"><a href="#cb347-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">//----------------------------------------------------------------------</span></span>
<span id="cb347-83"><a href="#cb347-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-84"><a href="#cb347-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">//查</span></span>
<span id="cb347-85"><a href="#cb347-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">//获取节点的数据(可以使用同步或异步方式)</span></span>
<span id="cb347-86"><a href="#cb347-86" aria-hidden="true" tabindex="-1"></a>    Stat stat1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">Stat</span><span class="op">();</span></span>
<span id="cb347-87"><a href="#cb347-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">byte</span><span class="op">[]</span> data1 <span class="op">=</span> curator<span class="op">.</span><span class="fu">getData</span><span class="op">()</span></span>
<span id="cb347-88"><a href="#cb347-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">storingStatIn</span><span class="op">(</span>stat1<span class="op">)</span><span class="co">//获取节点状态，如果获取失败，stat不会为null，但其内容为空（比如version为0）</span></span>
<span id="cb347-89"><a href="#cb347-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb347-90"><a href="#cb347-90" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>data1<span class="op">));</span></span>
<span id="cb347-91"><a href="#cb347-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>stat1<span class="op">);</span></span>
<span id="cb347-92"><a href="#cb347-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">//还可以使用Watcher</span></span>
<span id="cb347-93"><a href="#cb347-93" aria-hidden="true" tabindex="-1"></a>    <span class="dt">byte</span><span class="op">[]</span> data2 <span class="op">=</span>curator<span class="op">.</span><span class="fu">getData</span><span class="op">()</span></span>
<span id="cb347-94"><a href="#cb347-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">usingWatcher</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Watcher</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb347-95"><a href="#cb347-95" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb347-96"><a href="#cb347-96" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">process</span><span class="op">(</span>WatchedEvent event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb347-97"><a href="#cb347-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-98"><a href="#cb347-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb347-99"><a href="#cb347-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">}).</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb347-100"><a href="#cb347-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">//检查节点是否存在</span></span>
<span id="cb347-101"><a href="#cb347-101" aria-hidden="true" tabindex="-1"></a>    Stat stat2 <span class="op">=</span> curator<span class="op">.</span><span class="fu">checkExists</span><span class="op">()</span></span>
<span id="cb347-102"><a href="#cb347-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node4&quot;</span><span class="op">);</span><span class="co">//如果节点不存在stat为null</span></span>
<span id="cb347-103"><a href="#cb347-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>stat2<span class="op">);</span></span>
<span id="cb347-104"><a href="#cb347-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">//获取子节点</span></span>
<span id="cb347-105"><a href="#cb347-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> children1 <span class="op">=</span> curator<span class="op">.</span><span class="fu">getChildren</span><span class="op">()</span></span>
<span id="cb347-106"><a href="#cb347-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node2&quot;</span><span class="op">);</span></span>
<span id="cb347-107"><a href="#cb347-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>children1<span class="op">);</span></span>
<span id="cb347-108"><a href="#cb347-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-109"><a href="#cb347-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">//----------------------------------------------------------------------</span></span>
<span id="cb347-110"><a href="#cb347-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-111"><a href="#cb347-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">//删(可以使用同步或异步方式)</span></span>
<span id="cb347-112"><a href="#cb347-112" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>curator<span class="op">.</span><span class="fu">checkExists</span><span class="op">().</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">)</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb347-113"><a href="#cb347-113" aria-hidden="true" tabindex="-1"></a>        curator<span class="op">.</span><span class="fu">delete</span><span class="op">()</span></span>
<span id="cb347-114"><a href="#cb347-114" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withVersion</span><span class="op">(-</span><span class="dv">1</span><span class="op">)</span><span class="co">//可以指定version</span></span>
<span id="cb347-115"><a href="#cb347-115" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb347-116"><a href="#cb347-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>curator<span class="op">.</span><span class="fu">checkExists</span><span class="op">().</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">)</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span></span>
<span id="cb347-117"><a href="#cb347-117" aria-hidden="true" tabindex="-1"></a>        curator<span class="op">.</span><span class="fu">delete</span><span class="op">()</span></span>
<span id="cb347-118"><a href="#cb347-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">guaranteed</span><span class="op">()</span><span class="co">//保障机制，若未删除成功，只要会话有效会在后台一直尝试删除</span></span>
<span id="cb347-119"><a href="#cb347-119" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">deletingChildrenIfNeeded</span><span class="op">()</span><span class="co">//若当前节点包含子节点</span></span>
<span id="cb347-120"><a href="#cb347-120" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb347-121"><a href="#cb347-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-122"><a href="#cb347-122" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb347-123"><a href="#cb347-123" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="acl-2">ACL</h4>
<div class="sourceCode" id="cb348"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">connectString</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">)</span></span>
<span id="cb348-3"><a href="#cb348-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">retryPolicy</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb348-4"><a href="#cb348-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">connectionTimeoutMs</span><span class="op">(</span><span class="dv">10000</span><span class="op">)</span></span>
<span id="cb348-5"><a href="#cb348-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sessionTimeoutMs</span><span class="op">(</span><span class="dv">5000</span><span class="op">)</span></span>
<span id="cb348-6"><a href="#cb348-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">authorization</span><span class="op">(</span><span class="st">&quot;digest&quot;</span><span class="op">,</span> <span class="st">&quot;username:password&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">())</span></span>
<span id="cb348-7"><a href="#cb348-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb348-8"><a href="#cb348-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-9"><a href="#cb348-9" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>ACL<span class="op">&gt;</span> acls <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span>ACL<span class="op">&gt;();</span></span>
<span id="cb348-10"><a href="#cb348-10" aria-hidden="true" tabindex="-1"></a>acls<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ACL</span><span class="op">(</span>ZooDefs<span class="op">.</span><span class="fu">Perms</span><span class="op">.</span><span class="fu">ALL</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">Id</span><span class="op">(</span><span class="st">&quot;digest&quot;</span><span class="op">,</span> DigestAuthenticationProvider<span class="op">.</span><span class="fu">generateDigest</span><span class="op">(</span><span class="st">&quot;username:password&quot;</span><span class="op">))));</span></span>
<span id="cb348-11"><a href="#cb348-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-12"><a href="#cb348-12" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb348-13"><a href="#cb348-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">PERSISTENT</span><span class="op">)</span></span>
<span id="cb348-14"><a href="#cb348-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withACL</span><span class="op">(</span>acls<span class="op">)</span></span>
<span id="cb348-15"><a href="#cb348-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="st">&quot;data1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span></code></pre></div>
<h4 id="事务-2">事务</h4>
<div class="sourceCode" id="cb349"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> connectionString <span class="op">=</span> <span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">;</span></span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb349-3"><a href="#cb349-3" aria-hidden="true" tabindex="-1"></a>CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span>connectionString<span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb349-4"><a href="#cb349-4" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb349-5"><a href="#cb349-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-6"><a href="#cb349-6" aria-hidden="true" tabindex="-1"></a><span class="co">//方式一 已过时(deprecated)</span></span>
<span id="cb349-7"><a href="#cb349-7" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">inTransaction</span><span class="op">()</span></span>
<span id="cb349-8"><a href="#cb349-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">create</span><span class="op">().</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">).</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node5&quot;</span><span class="op">,</span> <span class="st">&quot;data5&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">())</span></span>
<span id="cb349-9"><a href="#cb349-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">and</span><span class="op">()</span></span>
<span id="cb349-10"><a href="#cb349-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setData</span><span class="op">().</span><span class="fu">withVersion</span><span class="op">(-</span><span class="dv">1</span><span class="op">).</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node5&quot;</span><span class="op">,</span> <span class="st">&quot;newData1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">())</span></span>
<span id="cb349-11"><a href="#cb349-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">and</span><span class="op">()</span></span>
<span id="cb349-12"><a href="#cb349-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb349-13"><a href="#cb349-13" aria-hidden="true" tabindex="-1"></a><span class="co">//方式二</span></span>
<span id="cb349-14"><a href="#cb349-14" aria-hidden="true" tabindex="-1"></a>CuratorOp createOp <span class="op">=</span> curator<span class="op">.</span><span class="fu">transactionOp</span><span class="op">()</span></span>
<span id="cb349-15"><a href="#cb349-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">create</span><span class="op">()</span></span>
<span id="cb349-16"><a href="#cb349-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withMode</span><span class="op">(</span>CreateMode<span class="op">.</span><span class="fu">EPHEMERAL</span><span class="op">)</span></span>
<span id="cb349-17"><a href="#cb349-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node6&quot;</span><span class="op">,</span> <span class="st">&quot;data6&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb349-18"><a href="#cb349-18" aria-hidden="true" tabindex="-1"></a>CuratorOp setDataOp <span class="op">=</span> curator<span class="op">.</span><span class="fu">transactionOp</span><span class="op">()</span></span>
<span id="cb349-19"><a href="#cb349-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">setData</span><span class="op">()</span></span>
<span id="cb349-20"><a href="#cb349-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node5&quot;</span><span class="op">,</span> <span class="st">&quot;newData2&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb349-21"><a href="#cb349-21" aria-hidden="true" tabindex="-1"></a>CuratorOp deleteOp <span class="op">=</span> curator<span class="op">.</span><span class="fu">transactionOp</span><span class="op">()</span></span>
<span id="cb349-22"><a href="#cb349-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">delete</span><span class="op">()</span></span>
<span id="cb349-23"><a href="#cb349-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forPath</span><span class="op">(</span><span class="st">&quot;/node2/node3&quot;</span><span class="op">);</span></span>
<span id="cb349-24"><a href="#cb349-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-25"><a href="#cb349-25" aria-hidden="true" tabindex="-1"></a><span class="bu">Collection</span><span class="op">&lt;</span>CuratorTransactionResult<span class="op">&gt;</span> results <span class="op">=</span> curator<span class="op">.</span><span class="fu">transaction</span><span class="op">()</span></span>
<span id="cb349-26"><a href="#cb349-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forOperations</span><span class="op">(</span>createOp<span class="op">,</span> setDataOp<span class="op">,</span> deleteOp<span class="op">);</span></span>
<span id="cb349-27"><a href="#cb349-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>CuratorTransactionResult result <span class="op">:</span> results<span class="op">)</span> <span class="op">{</span></span>
<span id="cb349-28"><a href="#cb349-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">.</span><span class="fu">getForPath</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot; - &quot;</span> <span class="op">+</span> result<span class="op">.</span><span class="fu">getType</span><span class="op">());</span></span>
<span id="cb349-29"><a href="#cb349-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb349-30"><a href="#cb349-30" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h4 id="子节点监听">子节点监听</h4>
<p>原生的zookeeper
API中，watcher每次操作都要设置，而使用Curator的Cache，可以设置一次，多次监听</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>ring connectionString <span class="op">=</span> <span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">;</span></span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span>connectionString<span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb350-5"><a href="#cb350-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-6"><a href="#cb350-6" aria-hidden="true" tabindex="-1"></a><span class="co">//监听当前节点事件</span></span>
<span id="cb350-7"><a href="#cb350-7" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> NodeCache nodeCache <span class="op">=</span> <span class="kw">new</span> <span class="fu">NodeCache</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb350-8"><a href="#cb350-8" aria-hidden="true" tabindex="-1"></a>nodeCache<span class="op">.</span><span class="fu">start</span><span class="op">();</span><span class="co">//开始监听</span></span>
<span id="cb350-9"><a href="#cb350-9" aria-hidden="true" tabindex="-1"></a>nodeCache<span class="op">.</span><span class="fu">getListenable</span><span class="op">().</span><span class="fu">addListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">NodeCacheListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb350-10"><a href="#cb350-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb350-11"><a href="#cb350-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">nodeChanged</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb350-12"><a href="#cb350-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> res <span class="op">=</span> nodeCache<span class="op">.</span><span class="fu">getCurrentData</span><span class="op">().</span><span class="fu">getData</span><span class="op">();</span></span>
<span id="cb350-13"><a href="#cb350-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;data: &quot;</span> <span class="op">+</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>res<span class="op">));</span></span>
<span id="cb350-14"><a href="#cb350-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb350-15"><a href="#cb350-15" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb350-16"><a href="#cb350-16" aria-hidden="true" tabindex="-1"></a><span class="co">//在这里执行的增删改查都会被监听到</span></span>
<span id="cb350-17"><a href="#cb350-17" aria-hidden="true" tabindex="-1"></a>nodeCache<span class="op">.</span><span class="fu">close</span><span class="op">();</span><span class="co">//结束监听</span></span>
<span id="cb350-18"><a href="#cb350-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-19"><a href="#cb350-19" aria-hidden="true" tabindex="-1"></a><span class="co">//监听当前节点和子节点事件</span></span>
<span id="cb350-20"><a href="#cb350-20" aria-hidden="true" tabindex="-1"></a><span class="co">//第三个参数表示是否在初始化时拉取缓存数据</span></span>
<span id="cb350-21"><a href="#cb350-21" aria-hidden="true" tabindex="-1"></a><span class="dt">final</span> PathChildrenCache pathChildrenCache <span class="op">=</span> <span class="kw">new</span> <span class="fu">PathChildrenCache</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/node1&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb350-22"><a href="#cb350-22" aria-hidden="true" tabindex="-1"></a><span class="co">//POST_INITIALIZED_EVENT: 当Cache初始化数据后发送一个PathChildrenCacheEvent.Type#INITIALIZED事件；如果不传StartMode，则初始会把监听节点的所有存在的节点都作为节点改变，发出事件，导致初始化时有大量事件产生</span></span>
<span id="cb350-23"><a href="#cb350-23" aria-hidden="true" tabindex="-1"></a>pathChildrenCache<span class="op">.</span><span class="fu">start</span><span class="op">(</span>PathChildrenCache<span class="op">.</span><span class="fu">StartMode</span><span class="op">.</span><span class="fu">POST_INITIALIZED_EVENT</span><span class="op">);</span></span>
<span id="cb350-24"><a href="#cb350-24" aria-hidden="true" tabindex="-1"></a>pathChildrenCache<span class="op">.</span><span class="fu">getListenable</span><span class="op">().</span><span class="fu">addListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PathChildrenCacheListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb350-25"><a href="#cb350-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb350-26"><a href="#cb350-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">childEvent</span><span class="op">(</span>CuratorFramework curator<span class="op">,</span> PathChildrenCacheEvent event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb350-27"><a href="#cb350-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getType</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb350-28"><a href="#cb350-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> CHILD_ADDED<span class="op">:</span></span>
<span id="cb350-29"><a href="#cb350-29" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;add:&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getData</span><span class="op">());</span></span>
<span id="cb350-30"><a href="#cb350-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb350-31"><a href="#cb350-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> CHILD_UPDATED<span class="op">:</span></span>
<span id="cb350-32"><a href="#cb350-32" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;update:&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getData</span><span class="op">());</span></span>
<span id="cb350-33"><a href="#cb350-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb350-34"><a href="#cb350-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> CHILD_REMOVED<span class="op">:</span></span>
<span id="cb350-35"><a href="#cb350-35" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;remove:&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getData</span><span class="op">());</span></span>
<span id="cb350-36"><a href="#cb350-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb350-37"><a href="#cb350-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb350-38"><a href="#cb350-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb350-39"><a href="#cb350-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb350-40"><a href="#cb350-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb350-41"><a href="#cb350-41" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb350-42"><a href="#cb350-42" aria-hidden="true" tabindex="-1"></a>pathChildrenCache<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb350-43"><a href="#cb350-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-44"><a href="#cb350-44" aria-hidden="true" tabindex="-1"></a><span class="co">//监听整个节点树的事件</span></span>
<span id="cb350-45"><a href="#cb350-45" aria-hidden="true" tabindex="-1"></a>TreeCache treeCache <span class="op">=</span> <span class="kw">new</span> <span class="fu">TreeCache</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/node1&quot;</span><span class="op">);</span></span>
<span id="cb350-46"><a href="#cb350-46" aria-hidden="true" tabindex="-1"></a>treeCache<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb350-47"><a href="#cb350-47" aria-hidden="true" tabindex="-1"></a>treeCache<span class="op">.</span><span class="fu">getListenable</span><span class="op">().</span><span class="fu">addListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">TreeCacheListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb350-48"><a href="#cb350-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb350-49"><a href="#cb350-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">childEvent</span><span class="op">(</span>CuratorFramework client<span class="op">,</span> TreeCacheEvent event<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb350-50"><a href="#cb350-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>event<span class="op">.</span><span class="fu">getData</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb350-51"><a href="#cb350-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;type=&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getType</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot; path=&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getData</span><span class="op">().</span><span class="fu">getPath</span><span class="op">());</span></span>
<span id="cb350-52"><a href="#cb350-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb350-53"><a href="#cb350-53" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;type=&quot;</span> <span class="op">+</span> event<span class="op">.</span><span class="fu">getType</span><span class="op">());</span></span>
<span id="cb350-54"><a href="#cb350-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb350-55"><a href="#cb350-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb350-56"><a href="#cb350-56" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb350-57"><a href="#cb350-57" aria-hidden="true" tabindex="-1"></a>treeCache<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb350-58"><a href="#cb350-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb350-59"><a href="#cb350-59" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h4 id="leader选取">Leader选取</h4>
<h5 id="leaderlatch">LeaderLatch</h5>
<p>LeaderLatch选举模式的本质是连接ZooKeeper，然后在指定节点下为每个LeaderLatch创建临时有序节点，然后选取序列号最小的节点作为leader，其他节点则监听比当前节点序号小的节点的删除事件（这里用for循环模拟，实际的分布式环境中，应该是在每个应用节点中完成创建）</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="co">//创建CuratorFramework和LeaderLatch</span></span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>CuratorFramework<span class="op">&gt;</span> clients <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb351-3"><a href="#cb351-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>LeaderLatch<span class="op">&gt;</span> latchList <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb351-4"><a href="#cb351-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb351-5"><a href="#cb351-5" aria-hidden="true" tabindex="-1"></a>    ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb351-6"><a href="#cb351-6" aria-hidden="true" tabindex="-1"></a>    CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb351-7"><a href="#cb351-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-8"><a href="#cb351-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> LeaderLatch leaderLatch <span class="op">=</span> <span class="kw">new</span> <span class="fu">LeaderLatch</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/latchPath&quot;</span><span class="op">,</span> <span class="st">&quot;client#&quot;</span> <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb351-9"><a href="#cb351-9" aria-hidden="true" tabindex="-1"></a>    leaderLatch<span class="op">.</span><span class="fu">addListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">LeaderLatchListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb351-10"><a href="#cb351-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb351-11"><a href="#cb351-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">isLeader</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb351-12"><a href="#cb351-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>leaderLatch<span class="op">.</span><span class="fu">getId</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;:I am leader. I am doing jobs!&quot;</span><span class="op">);</span></span>
<span id="cb351-13"><a href="#cb351-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb351-14"><a href="#cb351-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-15"><a href="#cb351-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb351-16"><a href="#cb351-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">notLeader</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb351-17"><a href="#cb351-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>leaderLatch<span class="op">.</span><span class="fu">getId</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;:I am not leader. I will do nothing!&quot;</span><span class="op">);</span></span>
<span id="cb351-18"><a href="#cb351-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb351-19"><a href="#cb351-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb351-20"><a href="#cb351-20" aria-hidden="true" tabindex="-1"></a>    clients<span class="op">.</span><span class="fu">add</span><span class="op">(</span>curator<span class="op">);</span></span>
<span id="cb351-21"><a href="#cb351-21" aria-hidden="true" tabindex="-1"></a>    latchList<span class="op">.</span><span class="fu">add</span><span class="op">(</span>leaderLatch<span class="op">);</span></span>
<span id="cb351-22"><a href="#cb351-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-23"><a href="#cb351-23" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb351-24"><a href="#cb351-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">//start后， LeaderLatch会和其它使用相同latch path的其它LeaderLatch交涉，然后随机的选择其中一个作为leader</span></span>
<span id="cb351-25"><a href="#cb351-25" aria-hidden="true" tabindex="-1"></a>    leaderLatch<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb351-26"><a href="#cb351-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb351-27"><a href="#cb351-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-28"><a href="#cb351-28" aria-hidden="true" tabindex="-1"></a><span class="co">//等待选举完成</span></span>
<span id="cb351-29"><a href="#cb351-29" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">5000L</span><span class="op">);</span></span>
<span id="cb351-30"><a href="#cb351-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-31"><a href="#cb351-31" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>latchList<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb351-32"><a href="#cb351-32" aria-hidden="true" tabindex="-1"></a>    LeaderLatch currentLeader <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb351-33"><a href="#cb351-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">//找出当前leader</span></span>
<span id="cb351-34"><a href="#cb351-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>LeaderLatch leaderLatch <span class="op">:</span> latchList<span class="op">)</span> <span class="op">{</span></span>
<span id="cb351-35"><a href="#cb351-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>leaderLatch<span class="op">.</span><span class="fu">hasLeadership</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb351-36"><a href="#cb351-36" aria-hidden="true" tabindex="-1"></a>            currentLeader <span class="op">=</span> leaderLatch<span class="op">;</span></span>
<span id="cb351-37"><a href="#cb351-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span><span class="op">;</span></span>
<span id="cb351-38"><a href="#cb351-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb351-39"><a href="#cb351-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-40"><a href="#cb351-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>currentLeader <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb351-41"><a href="#cb351-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;当前leader是： &quot;</span> <span class="op">+</span> currentLeader<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb351-42"><a href="#cb351-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">//模拟leader宕机，从剩下的节点中继续选举leader</span></span>
<span id="cb351-43"><a href="#cb351-43" aria-hidden="true" tabindex="-1"></a>        currentLeader<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb351-44"><a href="#cb351-44" aria-hidden="true" tabindex="-1"></a>        latchList<span class="op">.</span><span class="fu">remove</span><span class="op">(</span>currentLeader<span class="op">);</span></span>
<span id="cb351-45"><a href="#cb351-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">//等待选举完成</span></span>
<span id="cb351-46"><a href="#cb351-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">5000L</span><span class="op">);</span></span>
<span id="cb351-47"><a href="#cb351-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb351-48"><a href="#cb351-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb351-49"><a href="#cb351-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb351-50"><a href="#cb351-50" aria-hidden="true" tabindex="-1"></a><span class="co">//回收资源</span></span>
<span id="cb351-51"><a href="#cb351-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>CuratorFramework client <span class="op">:</span> clients<span class="op">)</span> <span class="op">{</span></span>
<span id="cb351-52"><a href="#cb351-52" aria-hidden="true" tabindex="-1"></a>    CloseableUtils<span class="op">.</span><span class="fu">closeQuietly</span><span class="op">(</span>client<span class="op">);</span></span>
<span id="cb351-53"><a href="#cb351-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h5 id="leaderelection">LeaderElection</h5>
<p>LeaderElection与LeaderLatch选举策略不同之处在于每个实例都能公平获取领导权，而且当获取领导权的实例在释放领导权之后，该实例还有机会再次获取领导权。另外，选举出来的leader不会一直占有领导权，当
takeLeadership(CuratorFramework client)
方法执行结束之后会自动释放领导权</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a><span class="co">//创建CuratorFramework和LeaderSelector</span></span>
<span id="cb352-2"><a href="#cb352-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>CuratorFramework<span class="op">&gt;</span> curators <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb352-3"><a href="#cb352-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span>LeaderSelector<span class="op">&gt;</span> selectors <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb352-4"><a href="#cb352-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb352-5"><a href="#cb352-5" aria-hidden="true" tabindex="-1"></a>    ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb352-6"><a href="#cb352-6" aria-hidden="true" tabindex="-1"></a>    CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb352-7"><a href="#cb352-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-8"><a href="#cb352-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">final</span> <span class="dt">int</span> clientIndex <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb352-9"><a href="#cb352-9" aria-hidden="true" tabindex="-1"></a>    LeaderSelector leaderSelector <span class="op">=</span> <span class="kw">new</span> <span class="fu">LeaderSelector</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/selectPath&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">LeaderSelectorListenerAdapter</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb352-10"><a href="#cb352-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">final</span> <span class="bu">String</span> name <span class="op">=</span> <span class="st">&quot;client#&quot;</span> <span class="op">+</span> clientIndex<span class="op">;</span></span>
<span id="cb352-11"><a href="#cb352-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">AtomicInteger</span> leaderCount <span class="op">=</span> <span class="kw">new</span> <span class="bu">AtomicInteger</span><span class="op">();</span></span>
<span id="cb352-12"><a href="#cb352-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-13"><a href="#cb352-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb352-14"><a href="#cb352-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">takeLeadership</span><span class="op">(</span>CuratorFramework client<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb352-15"><a href="#cb352-15" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;当前leader是: &quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;，之前被选举为leader的次数: &quot;</span> <span class="op">+</span> leaderCount<span class="op">.</span><span class="fu">getAndIncrement</span><span class="op">());</span></span>
<span id="cb352-16"><a href="#cb352-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">//只要该方法不返回，当前节点就一直是leader，返回后会重新选举</span></span>
<span id="cb352-17"><a href="#cb352-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">2000L</span><span class="op">);</span></span>
<span id="cb352-18"><a href="#cb352-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb352-19"><a href="#cb352-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb352-20"><a href="#cb352-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//自动重新排队，如果不设置，每个selector被选举为leader一次后就不再参加选举了</span></span>
<span id="cb352-21"><a href="#cb352-21" aria-hidden="true" tabindex="-1"></a>    leaderSelector<span class="op">.</span><span class="fu">autoRequeue</span><span class="op">();</span></span>
<span id="cb352-22"><a href="#cb352-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-23"><a href="#cb352-23" aria-hidden="true" tabindex="-1"></a>    curators<span class="op">.</span><span class="fu">add</span><span class="op">(</span>curator<span class="op">);</span></span>
<span id="cb352-24"><a href="#cb352-24" aria-hidden="true" tabindex="-1"></a>    selectors<span class="op">.</span><span class="fu">add</span><span class="op">(</span>leaderSelector<span class="op">);</span></span>
<span id="cb352-25"><a href="#cb352-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-26"><a href="#cb352-26" aria-hidden="true" tabindex="-1"></a>    curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb352-27"><a href="#cb352-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">//start后， leaderSelector会和其它使用相同select path的其它leaderSelector交涉，然后随机的选择其中一个作为leader</span></span>
<span id="cb352-28"><a href="#cb352-28" aria-hidden="true" tabindex="-1"></a>    leaderSelector<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb352-29"><a href="#cb352-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb352-30"><a href="#cb352-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-31"><a href="#cb352-31" aria-hidden="true" tabindex="-1"></a><span class="co">//按任意键退出</span></span>
<span id="cb352-32"><a href="#cb352-32" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">in</span><span class="op">.</span><span class="fu">read</span><span class="op">();</span></span>
<span id="cb352-33"><a href="#cb352-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb352-34"><a href="#cb352-34" aria-hidden="true" tabindex="-1"></a><span class="co">//释放资源</span></span>
<span id="cb352-35"><a href="#cb352-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>CuratorFramework client <span class="op">:</span> curators<span class="op">)</span> <span class="op">{</span></span>
<span id="cb352-36"><a href="#cb352-36" aria-hidden="true" tabindex="-1"></a>    CloseableUtils<span class="op">.</span><span class="fu">closeQuietly</span><span class="op">(</span>client<span class="op">);</span></span>
<span id="cb352-37"><a href="#cb352-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="分布式锁-1">分布式锁</h4>
<p>在分布式的情况下，无法像JAVA中，使用对象标识一个锁，curator的做法是用节点来标识一个锁，其实现如下</p>
<ol type="1">
<li>客户端连接zookeeper，并在/lock下创建临时的且有序的子节点，第一个客户端对应的子节点为/lock/lock-0000000000，第二个为/lock/lock-0000000001，以此类推</li>
<li>客户端获取/lock下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁，否则监听刚好在自己之前一位的子节点的删除消息，获得子节点变更通知后重复此步骤直至获得锁</li>
<li>执行业务代码</li>
<li>完成业务流程后，删除对应的子节点释放锁</li>
</ol>
<p>同时，为了避免连接中断时，客户端没有释放锁造成死锁，这些节点必须是临时节点，这样当连接中断时，一段时间过后会自动删除节点，使业务继续执行</p>
<p>curator提供了几种常用的锁</p>
<ul>
<li>InterProcessMutex: 可重入共享锁(Shared Reentrant
Lock)，同一个客户端的一个线程在拥有锁的同时，可以多次获取，不会被阻塞，但如果在同一个客户端的不同线程，仍然无法获取</li>
<li>InterProcessSemaphoreMutex: 不可重入共享锁(Shared Lock)</li>
<li>InterProcessReadWriteLock: 可重入读写锁(Shared Reentrant Read Write
Lock)，一个拥有写锁的线程可重入读锁，但是读锁却不能进入写锁。这也意味着写锁可以降级成读锁</li>
<li>InterProcessMultiLock: 多共享锁对象(Multi Shared
Lock)，一个锁的容器。 当调用<code>acquire()</code>，
所有的锁都会被<code>acquire()</code>，如果请求失败，所有的锁都会被release，同样调用<code>release()</code>时所有的锁都被release</li>
<li>InterProcessSemaphoreV2: 信号量</li>
</ul>
<p>简单的使用</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb353-3"><a href="#cb353-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//模拟10台主机并发访问共享资源，不同主机使用的锁对象是不一样的，所以只能通过zookeeper的节点标识一个锁</span></span>
<span id="cb353-4"><a href="#cb353-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb353-5"><a href="#cb353-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> workerIndex <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb353-6"><a href="#cb353-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="bu">Thread</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb353-7"><a href="#cb353-7" aria-hidden="true" tabindex="-1"></a>                ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb353-8"><a href="#cb353-8" aria-hidden="true" tabindex="-1"></a>                CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb353-9"><a href="#cb353-9" aria-hidden="true" tabindex="-1"></a>                curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb353-10"><a href="#cb353-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-11"><a href="#cb353-11" aria-hidden="true" tabindex="-1"></a>                Worker worker <span class="op">=</span> <span class="kw">new</span> <span class="fu">Worker</span><span class="op">(</span>curator<span class="op">,</span> <span class="kw">new</span> <span class="fu">InterProcessMutex</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/locks&quot;</span><span class="op">),</span> <span class="st">&quot;client&quot;</span> <span class="op">+</span> workerIndex<span class="op">);</span></span>
<span id="cb353-12"><a href="#cb353-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb353-13"><a href="#cb353-13" aria-hidden="true" tabindex="-1"></a>                    worker<span class="op">.</span><span class="fu">doWork</span><span class="op">();</span></span>
<span id="cb353-14"><a href="#cb353-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb353-15"><a href="#cb353-15" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb353-16"><a href="#cb353-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb353-17"><a href="#cb353-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-18"><a href="#cb353-18" aria-hidden="true" tabindex="-1"></a>                curator<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb353-19"><a href="#cb353-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb353-20"><a href="#cb353-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb353-21"><a href="#cb353-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb353-22"><a href="#cb353-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb353-23"><a href="#cb353-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-24"><a href="#cb353-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Worker <span class="op">{</span></span>
<span id="cb353-25"><a href="#cb353-25" aria-hidden="true" tabindex="-1"></a>    CuratorFramework curator<span class="op">;</span></span>
<span id="cb353-26"><a href="#cb353-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InterProcessMutex lock<span class="op">;</span></span>
<span id="cb353-27"><a href="#cb353-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> workerName<span class="op">;</span></span>
<span id="cb353-28"><a href="#cb353-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-29"><a href="#cb353-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Worker</span><span class="op">(</span>CuratorFramework curator<span class="op">,</span> InterProcessMutex lock<span class="op">,</span> <span class="bu">String</span> workerName<span class="op">)</span> <span class="op">{</span></span>
<span id="cb353-30"><a href="#cb353-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">curator</span> <span class="op">=</span> curator<span class="op">;</span></span>
<span id="cb353-31"><a href="#cb353-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">lock</span> <span class="op">=</span> lock<span class="op">;</span></span>
<span id="cb353-32"><a href="#cb353-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">workerName</span> <span class="op">=</span> workerName<span class="op">;</span></span>
<span id="cb353-33"><a href="#cb353-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb353-34"><a href="#cb353-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb353-35"><a href="#cb353-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doWork</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb353-36"><a href="#cb353-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">//阻塞至获得锁为止</span></span>
<span id="cb353-37"><a href="#cb353-37" aria-hidden="true" tabindex="-1"></a>        lock<span class="op">.</span><span class="fu">acquire</span><span class="op">();</span></span>
<span id="cb353-38"><a href="#cb353-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">//使用超时机制就不会阻塞，获取失败直接返回false</span></span>
<span id="cb353-39"><a href="#cb353-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>lock<span class="op">.</span><span class="fu">acquire</span><span class="op">(</span><span class="dv">500</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">MILLISECONDS</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb353-40"><a href="#cb353-40" aria-hidden="true" tabindex="-1"></a>            lock<span class="op">.</span><span class="fu">release</span><span class="op">();</span><span class="co">//前面acquire了一次，这里要release一次，否则会出现死锁</span></span>
<span id="cb353-41"><a href="#cb353-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalStateException</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot;could not acquire the lock&quot;</span><span class="op">);</span></span>
<span id="cb353-42"><a href="#cb353-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb353-43"><a href="#cb353-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb353-44"><a href="#cb353-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; has the lock&quot;</span><span class="op">);</span></span>
<span id="cb353-45"><a href="#cb353-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">//操作没有加锁的共享资源</span></span>
<span id="cb353-46"><a href="#cb353-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">//curator.create().forPath(&quot;/otherPath/node1&quot;);</span></span>
<span id="cb353-47"><a href="#cb353-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000L</span><span class="op">);</span></span>
<span id="cb353-48"><a href="#cb353-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb353-49"><a href="#cb353-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; releasing the lock&quot;</span><span class="op">);</span></span>
<span id="cb353-50"><a href="#cb353-50" aria-hidden="true" tabindex="-1"></a>            lock<span class="op">.</span><span class="fu">release</span><span class="op">();</span><span class="co">//可重入锁，acquire几次就要release几次</span></span>
<span id="cb353-51"><a href="#cb353-51" aria-hidden="true" tabindex="-1"></a>            lock<span class="op">.</span><span class="fu">release</span><span class="op">();</span></span>
<span id="cb353-52"><a href="#cb353-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb353-53"><a href="#cb353-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb353-54"><a href="#cb353-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对于InterProcessReadWriteLock</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Worker <span class="op">{</span></span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>    CuratorFramework curator<span class="op">;</span></span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InterProcessReadWriteLock lock<span class="op">;</span></span>
<span id="cb354-4"><a href="#cb354-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InterProcessMutex readLock<span class="op">;</span></span>
<span id="cb354-5"><a href="#cb354-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> InterProcessMutex writeLock<span class="op">;</span></span>
<span id="cb354-6"><a href="#cb354-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> workerName<span class="op">;</span></span>
<span id="cb354-7"><a href="#cb354-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-8"><a href="#cb354-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">Worker</span><span class="op">(</span>CuratorFramework curator<span class="op">,</span> InterProcessReadWriteLock lock<span class="op">,</span> <span class="bu">String</span> workerName<span class="op">)</span> <span class="op">{</span></span>
<span id="cb354-9"><a href="#cb354-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">curator</span> <span class="op">=</span> curator<span class="op">;</span></span>
<span id="cb354-10"><a href="#cb354-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">lock</span> <span class="op">=</span> lock<span class="op">;</span></span>
<span id="cb354-11"><a href="#cb354-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">readLock</span> <span class="op">=</span> lock<span class="op">.</span><span class="fu">readLock</span><span class="op">();</span></span>
<span id="cb354-12"><a href="#cb354-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">writeLock</span> <span class="op">=</span> lock<span class="op">.</span><span class="fu">writeLock</span><span class="op">();</span></span>
<span id="cb354-13"><a href="#cb354-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">workerName</span> <span class="op">=</span> workerName<span class="op">;</span></span>
<span id="cb354-14"><a href="#cb354-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb354-15"><a href="#cb354-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb354-16"><a href="#cb354-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doWork</span><span class="op">(</span><span class="dt">long</span> time<span class="op">,</span> <span class="bu">TimeUnit</span> unit<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb354-17"><a href="#cb354-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 注意只能先得到写锁再得到读锁，不能反过来！！！</span></span>
<span id="cb354-18"><a href="#cb354-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>writeLock<span class="op">.</span><span class="fu">acquire</span><span class="op">(</span>time<span class="op">,</span> unit<span class="op">))</span> <span class="op">{</span></span>
<span id="cb354-19"><a href="#cb354-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalStateException</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; 不能得到写锁&quot;</span><span class="op">);</span></span>
<span id="cb354-20"><a href="#cb354-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb354-21"><a href="#cb354-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>readLock<span class="op">.</span><span class="fu">acquire</span><span class="op">(</span>time<span class="op">,</span> unit<span class="op">))</span> <span class="op">{</span></span>
<span id="cb354-22"><a href="#cb354-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">IllegalStateException</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; 不能得到读锁&quot;</span><span class="op">);</span></span>
<span id="cb354-23"><a href="#cb354-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb354-24"><a href="#cb354-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; 已得到读锁&quot;</span><span class="op">);</span></span>
<span id="cb354-25"><a href="#cb354-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb354-26"><a href="#cb354-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">//...</span></span>
<span id="cb354-27"><a href="#cb354-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb354-28"><a href="#cb354-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb354-29"><a href="#cb354-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>workerName <span class="op">+</span> <span class="st">&quot; 释放读写锁&quot;</span><span class="op">);</span></span>
<span id="cb354-30"><a href="#cb354-30" aria-hidden="true" tabindex="-1"></a>            readLock<span class="op">.</span><span class="fu">release</span><span class="op">();</span></span>
<span id="cb354-31"><a href="#cb354-31" aria-hidden="true" tabindex="-1"></a>            writeLock<span class="op">.</span><span class="fu">release</span><span class="op">();</span></span>
<span id="cb354-32"><a href="#cb354-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb354-33"><a href="#cb354-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb354-34"><a href="#cb354-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>对于InterProcessSemaphoreV2</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>ExponentialBackoffRetry retryPolicy <span class="op">=</span> <span class="kw">new</span> <span class="fu">ExponentialBackoffRetry</span><span class="op">(</span><span class="dv">1000</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>CuratorFramework curator <span class="op">=</span> CuratorFrameworkFactory<span class="op">.</span><span class="fu">newClient</span><span class="op">(</span><span class="st">&quot;127.0.0.1:2181&quot;</span><span class="op">,</span> retryPolicy<span class="op">);</span></span>
<span id="cb355-3"><a href="#cb355-3" aria-hidden="true" tabindex="-1"></a>curator<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb355-4"><a href="#cb355-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-5"><a href="#cb355-5" aria-hidden="true" tabindex="-1"></a>InterProcessSemaphoreV2 semaphore <span class="op">=</span> <span class="kw">new</span> <span class="fu">InterProcessSemaphoreV2</span><span class="op">(</span>curator<span class="op">,</span> <span class="st">&quot;/locks&quot;</span><span class="op">,</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb355-6"><a href="#cb355-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-7"><a href="#cb355-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Collection</span><span class="op">&lt;</span><span class="bu">Lease</span><span class="op">&gt;</span> leases <span class="op">=</span> semaphore<span class="op">.</span><span class="fu">acquire</span><span class="op">(</span><span class="dv">5</span><span class="op">);</span></span>
<span id="cb355-8"><a href="#cb355-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Lease</span> lease <span class="op">=</span> semaphore<span class="op">.</span><span class="fu">acquire</span><span class="op">();</span></span>
<span id="cb355-9"><a href="#cb355-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-10"><a href="#cb355-10" aria-hidden="true" tabindex="-1"></a><span class="co">//do something...</span></span>
<span id="cb355-11"><a href="#cb355-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-12"><a href="#cb355-12" aria-hidden="true" tabindex="-1"></a>semaphore<span class="op">.</span><span class="fu">returnLease</span><span class="op">(</span>lease<span class="op">);</span></span>
<span id="cb355-13"><a href="#cb355-13" aria-hidden="true" tabindex="-1"></a>semaphore<span class="op">.</span><span class="fu">returnAll</span><span class="op">(</span>leases<span class="op">);</span></span></code></pre></div>
<h2 id="dubbo">Dubbo</h2>
<p>项目地址: <a href="https://github.com/apache/incubator-dubbo">apache/incubator-dubbo</a></p>
<p>Dubbo是一个WebService应用程序，它用于把service层和controller层分开。当访问量大的时候，可以使用分布式的service架构来处理请求</p>
<p>同类型的框架还有Apache CXF、Spring
Cloud，它们都是遵循WebService规范(包括<code>JAX-WS</code>(Java API For
XML-WebService)、<code>JAX-RS</code>(Java API for RESTful Web
Services)、<code>JAXM&amp;SAAJ</code>三种规范)</p>
<p>Dubbo分为注册中心(Registry)、服务提供者(Provider)、服务消费者(Consumer)、监视器(Monitor)
四个模块 注册中心有以下选择：</p>
<ul>
<li>Multicast注册中心</li>
<li>Zookeeper注册中心</li>
<li>Redis注册中心</li>
<li>Simple注册中心</li>
</ul>
<h3 id="结合spring使用">结合Spring使用</h3>
<p>安装并启动注册中心后，新建Spring工程（两个，一个是服务提供者，一个是服务消费者），在Spring中配置Dubbo</p>
<h4 id="服务提供者">服务提供者</h4>
<div class="sourceCode" id="cb356"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb356-2"><a href="#cb356-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb356-3"><a href="#cb356-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb356-4"><a href="#cb356-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb356-5"><a href="#cb356-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:dubbo=</span><span class="st">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span>
<span id="cb356-6"><a href="#cb356-6" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans </span></span>
<span id="cb356-7"><a href="#cb356-7" aria-hidden="true" tabindex="-1"></a><span class="st">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span>
<span id="cb356-8"><a href="#cb356-8" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/context</span></span>
<span id="cb356-9"><a href="#cb356-9" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/context/context.xsd</span></span>
<span id="cb356-10"><a href="#cb356-10" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/dubbo </span></span>
<span id="cb356-11"><a href="#cb356-11" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span>
<span id="cb356-12"><a href="#cb356-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-13"><a href="#cb356-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;dao.repository&quot;</span> /&gt;</span>
<span id="cb356-14"><a href="#cb356-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-15"><a href="#cb356-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Dubbo相关配置 --&gt;</span></span>
<span id="cb356-16"><a href="#cb356-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- dubbo注解扫描 --&gt;</span></span>
<span id="cb356-17"><a href="#cb356-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:annotation</span><span class="ot"> package=</span><span class="st">&quot;dao.repository&quot;</span> /&gt;</span>
<span id="cb356-18"><a href="#cb356-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 定义了提供方应用信息，用于计算依赖关系；在 dubbo-admin 或 dubbo-monitor 会显示这个名字，方便辨识 --&gt;</span></span>
<span id="cb356-19"><a href="#cb356-19" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:application</span><span class="ot"> name=</span><span class="st">&quot;demotest-provider&quot;</span><span class="ot"> owner=</span><span class="st">&quot;programmer&quot;</span><span class="ot"> organization=</span><span class="st">&quot;dubbox&quot;</span>/&gt;</span>
<span id="cb356-20"><a href="#cb356-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 使用 zookeeper 注册中心暴露服务，注意要先开启 zookeeper --&gt;</span></span>
<span id="cb356-21"><a href="#cb356-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:registry</span><span class="ot"> address=</span><span class="st">&quot;zookeeper://127.0.0.1:2181&quot;</span>/&gt;</span>
<span id="cb356-22"><a href="#cb356-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 如果有多个zookeeper主机，用逗号隔开</span></span>
<span id="cb356-23"><a href="#cb356-23" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;dubbo:registry protocol=&quot;zookeeper&quot;  address=&quot;192.168.1.2:2181,192.168.1.3:2181,192.168.1.4:2181&quot; /&gt; --&gt;</span></span>
<span id="cb356-24"><a href="#cb356-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-25"><a href="#cb356-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 用dubbo协议在20880端口暴露服务 --&gt;</span></span>
<span id="cb356-26"><a href="#cb356-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:protocol</span><span class="ot"> name=</span><span class="st">&quot;dubbo&quot;</span><span class="ot"> port=</span><span class="st">&quot;20880&quot;</span> /&gt;</span>
<span id="cb356-27"><a href="#cb356-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb356-28"><a href="#cb356-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 由于使用了扫描注解，以下两个配置就不需要了</span></span>
<span id="cb356-29"><a href="#cb356-29" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;dubbo:service interface=&quot;dao.repository.IUserService&quot; ref=&quot;userServiceImpl&quot; protocol=&quot;dubbo&quot; connections=&quot;100&quot; timeout=&quot;2000&quot; retries=&quot;0&quot; cluster=&quot;failover&quot; loadbalance=&quot;roundrobin&quot; /&gt;</span></span>
<span id="cb356-30"><a href="#cb356-30" aria-hidden="true" tabindex="-1"></a><span class="co">    具体实现该接口的 bean</span></span>
<span id="cb356-31"><a href="#cb356-31" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;bean id=&quot;userServiceImpl&quot; class=&quot;dao.repository.impl.UserServiceImpl&quot; /&gt; --&gt;</span></span>
<span id="cb356-32"><a href="#cb356-32" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p>service接口</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> dao</span><span class="op">.</span><span class="im">repository</span><span class="op">;</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> IUserService <span class="op">{</span></span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">(</span><span class="bu">String</span> str<span class="op">);</span></span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>service实现类</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> dao</span><span class="op">.</span><span class="im">repository</span><span class="op">.</span><span class="im">impl</span><span class="op">;</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">alibaba</span><span class="op">.</span><span class="im">dubbo</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Service</span><span class="op">;</span></span>
<span id="cb358-5"><a href="#cb358-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-6"><a href="#cb358-6" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb358-7"><a href="#cb358-7" aria-hidden="true" tabindex="-1"></a><span class="co">//这里的@Service不是spring的@Service，而是Dubbo的@Service注解</span></span>
<span id="cb358-8"><a href="#cb358-8" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span><span class="op">(</span>interfaceClass<span class="op">=</span>dao<span class="op">.</span><span class="fu">repository</span><span class="op">.</span><span class="fu">IUserService</span><span class="op">.</span><span class="fu">class</span><span class="op">,</span> protocol<span class="op">={</span><span class="st">&quot;dubbo&quot;</span><span class="op">},</span> timeout<span class="op">=</span><span class="dv">10000</span><span class="op">,</span> retries<span class="op">=</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb358-9"><a href="#cb358-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceImpl <span class="kw">implements</span> UserServiceImpl <span class="op">{</span></span>
<span id="cb358-10"><a href="#cb358-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb358-11"><a href="#cb358-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">(</span><span class="bu">String</span> str<span class="op">)</span> <span class="op">{</span></span>
<span id="cb358-12"><a href="#cb358-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;张三&quot;</span> <span class="op">+</span> str<span class="op">;</span></span>
<span id="cb358-13"><a href="#cb358-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb358-14"><a href="#cb358-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="服务消费者">服务消费者</h4>
<div class="sourceCode" id="cb359"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:dubbo=</span><span class="st">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span>
<span id="cb359-6"><a href="#cb359-6" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans </span></span>
<span id="cb359-7"><a href="#cb359-7" aria-hidden="true" tabindex="-1"></a><span class="st">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span>
<span id="cb359-8"><a href="#cb359-8" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/context</span></span>
<span id="cb359-9"><a href="#cb359-9" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/context/context.xsd</span></span>
<span id="cb359-10"><a href="#cb359-10" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/dubbo </span></span>
<span id="cb359-11"><a href="#cb359-11" aria-hidden="true" tabindex="-1"></a><span class="st">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span>
<span id="cb359-12"><a href="#cb359-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-13"><a href="#cb359-13" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--</span></span>
<span id="cb359-14"><a href="#cb359-14" aria-hidden="true" tabindex="-1"></a><span class="co">如果同时使用Dubbo和Spring的注解扫描，要注意让Dubbo先扫描，否则如果先扫controller，再扫dubbo的服务，会出现空指针，因为在controller实例化的时候是没有对应的dubbo的服务实例的，所以就会造成无法注入(就是说Dubbo并不会真正注入，而是把生成的服务Bean交给Spring，让Spring通过set的方式负责注入)</span></span>
<span id="cb359-15"><a href="#cb359-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-16"><a href="#cb359-16" aria-hidden="true" tabindex="-1"></a><span class="co">另一种解决方案是在Spring配置文件中配置：</span></span>
<span id="cb359-17"><a href="#cb359-17" aria-hidden="true" tabindex="-1"></a><span class="co"> &lt;dubbo:reference id=&quot;userService&quot; interface=&quot;dao.repository.IUserService&quot; check=&quot;false&quot; /&gt;</span></span>
<span id="cb359-18"><a href="#cb359-18" aria-hidden="true" tabindex="-1"></a><span class="co">然后在代码中直接使用</span></span>
<span id="cb359-19"><a href="#cb359-19" aria-hidden="true" tabindex="-1"></a><span class="co">@Reference</span></span>
<span id="cb359-20"><a href="#cb359-20" aria-hidden="true" tabindex="-1"></a><span class="co">private UserService userService;</span></span>
<span id="cb359-21"><a href="#cb359-21" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb359-22"><a href="#cb359-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:annotation</span><span class="ot"> package=</span><span class="st">&quot;controller&quot;</span> /&gt;</span>
<span id="cb359-23"><a href="#cb359-23" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;controller&quot;</span> /&gt;</span>
<span id="cb359-24"><a href="#cb359-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-25"><a href="#cb359-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:application</span><span class="ot"> name=</span><span class="st">&quot;demotest-consumer&quot;</span>/&gt;</span>
<span id="cb359-26"><a href="#cb359-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--向 zookeeper 订阅 provider 的地址，由 zookeeper 定时推送--&gt;</span></span>
<span id="cb359-27"><a href="#cb359-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:registry</span><span class="ot"> address=</span><span class="st">&quot;zookeeper://127.0.0.1:2181&quot;</span>/&gt;</span>
<span id="cb359-28"><a href="#cb359-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-29"><a href="#cb359-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 由于使用了注解扫描，下面的配置就不需要了</span></span>
<span id="cb359-30"><a href="#cb359-30" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;dubbo:reference id=&quot;userService&quot; interface=&quot;dao.repository.IUserService&quot; check=&quot;false&quot; /&gt; --&gt;</span></span>
<span id="cb359-31"><a href="#cb359-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-32"><a href="#cb359-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 为所有dubbo:reference配置通用属性时可以使用dubbo:consumer --&gt;</span></span>
<span id="cb359-33"><a href="#cb359-33" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dubbo:consumer</span><span class="ot"> timeout=</span><span class="st">&quot;3000&quot;</span>/&gt;</span>
<span id="cb359-34"><a href="#cb359-34" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p>controller</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> controller</span><span class="op">;</span></span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-3"><a href="#cb360-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">alibaba</span><span class="op">.</span><span class="im">dubbo</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Reference</span><span class="op">;</span></span>
<span id="cb360-4"><a href="#cb360-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb360-5"><a href="#cb360-5" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb360-6"><a href="#cb360-6" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb360-7"><a href="#cb360-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserController <span class="op">{</span></span>
<span id="cb360-8"><a href="#cb360-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb360-9"><a href="#cb360-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//通过Dubbo的@Reference获取service实例，也可以使用ApplicationContext通过getBean获取</span></span>
<span id="cb360-10"><a href="#cb360-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Reference</span><span class="op">(</span>interfaceClass <span class="op">=</span> IUserService<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb360-11"><a href="#cb360-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> UserService userService<span class="op">;</span></span>
<span id="cb360-12"><a href="#cb360-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb360-13"><a href="#cb360-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;getName&quot;</span><span class="op">)</span></span>
<span id="cb360-14"><a href="#cb360-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseBody</span></span>
<span id="cb360-15"><a href="#cb360-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">(</span><span class="bu">String</span> str<span class="op">){</span></span>
<span id="cb360-16"><a href="#cb360-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> userService<span class="op">.</span><span class="fu">getName</span><span class="op">(</span><span class="st">&quot;Hello&quot;</span><span class="op">);</span></span>
<span id="cb360-17"><a href="#cb360-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb360-18"><a href="#cb360-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="参数说明-1">参数说明</h4>
<h5 id="cluster">cluster</h5>
<p>cluster可以指定集群容错模式，可以在<code>dubbo:reference</code>或<code>dubbo:service</code>中配置</p>
<ul>
<li>failover:
失败自动切换，当出现失败，重试其它服务器，可通过设置<code>retries</code>来设置重试次数(不含第一次)，<code>retries</code>默认为2，但是<code>retries</code>一般设置为0，以避免重复服务（比如服务端执行需要2秒，但消费端超时时间设置为1秒，这样就会导致消费端多次请求，造成重复服务，而且系统请求也会变为正常值的retries倍，容易引起服务雪崩）；该策略通常用于读操作，但重试会带来更长延。没有设置cluster时，failover为默认值</li>
<li>failfast:
快速失败，只发起一次调用，失败立即报错；该策略通常用于非幂等性的写操作，比如新增记录</li>
<li>failsafe:
失败安全，出现异常时，直接忽略；该策略通常用于写入审计日志等操作</li>
<li>failback:
失败自动恢复，后台记录失败请求，定时重发；该策略通常用于消息通知操作</li>
<li>forking:
并行调用多个服务器，只要一个成功即返回；该策略通常用于实时性要求较高的读操作，但需要浪费更多服务资源（可通过forks=“2”来设置最大并行数）</li>
<li>broadcast:
广播调用所有提供者，逐个调用，任意一台报错则报错；该策略通常用于通知所有提供者更新缓存或日志等本地资源信息</li>
</ul>
<h5 id="loadbalance">loadbalance</h5>
<p>loadbalance可以指定负载均衡策略，可以在<code>dubbo:reference</code>或<code>dubbo:service</code>中配置，可选值为</p>
<ul>
<li>random: 随机，按权重设置随机概率</li>
<li>roundrobin: 轮循，按公约后的权重设置轮循比率</li>
<li>leastactive:
最少活跃调用数，相同活跃数的随机，活跃数指调用前后计数差(调用前的时刻减去响应后的时刻的值)，使慢的提供者收到更少请求</li>
<li>consistenthash: 一致性Hash，相同参数的请求总是发到同一提供者</li>
</ul>
<h5 id="check">check</h5>
<p>check可以指定依赖检查，如果一个服务既是服务提供者，又是服务消费者，而且提供服务的实现类使用了其他服务(消费)，则需要设置<code>check=&quot;true&quot;</code>来确保依赖的服务先启动（check默认就是true）</p>
<p>对于立即加载的服务Bean，如果<code>check=&quot;true&quot;</code>，那么Dubbo会在启动时检查依赖的服务是否可用，不可用时会抛出异常，阻止Spring初始化完成，以便上线时，能及早发现问题；如果设置<code>check=&quot;false&quot;</code>，那么不会影响启动，后续服务初始化完成后依然可以正常连上</p>
<p>对于懒加载的服务Bean（比如使用了<code>beanFactory.getBean(&quot;userService&quot;)</code>），如果<code>check=&quot;true&quot;</code>，则在使用该Bean的时候（即Bean初始化时）才进行依赖检查，此时如果服务不可用，则会抛出异常，返回null，这时除非重启应用，否则使用时不会再次连上服务。所以对于懒加载的Bean，需要把设置<code>check=false</code>，这样当服务恢复时，依然可以正常连上</p>
<h4 id="设计原则-幂等性">设计原则: 幂等性</h4>
<p>上面提到使用failover策略时如果retries不为0时，可能造成重复服务，这就要求服务端的接口设计具有幂等性</p>
<p>幂等性就是用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次请求而产生了副作用，比如用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条，这样的系统就不具有幂等性</p>
<p>在以前的单应用系统中，我们只需要把数据操作放入事务中即可，发生错误立即回滚，但是在响应客户端的时候也有可能出现网络中断等异常</p>
<p>要保证单次操作和多次操作的结果一致，我们需要关心增加和修改操作（查询不会造成结果不一致，而删除多次对结果没有影响）</p>
<p>方法一：单次支付请求，不需要额外的数据库操作了，这个时候发起异步请求创建一个唯一的ticketId，就是门票，这张门票只能使用一次就作废，具体步骤如下</p>
<ol type="1">
<li>异步请求获取门票</li>
<li>调用支付，传入门票</li>
<li>根据门票ID查询此次操作是否存在，如果存在则表示该操作已经执行过，直接返回结果；如果不存在，支付扣款，保存结果</li>
<li>返回结果到客户端</li>
</ol>
<p>如果步骤4通信失败，用户再次发起请求，那么最终结果还是一样的</p>
<p>方法二：给订单设置支付状态</p>
<ol type="1">
<li>查询订单支付状态</li>
<li>如果已经支付，直接返回结果</li>
<li>如果未支付，则支付扣款并且保存流水</li>
<li>返回支付结果</li>
</ol>
<h3 id="泛化调用">泛化调用</h3>
<p>有时我们在服务消费方没有对应的服务接口，这时可以通过泛化调用来使用服务</p>
<p>服务提供方代码不变，服务消费方需添加<code>generic=&quot;true&quot;</code>属性：</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dubbo:reference</span><span class="ot"> id=</span><span class="st">&quot;userService&quot;</span><span class="ot"> interface=</span><span class="st">&quot;dao.repository.IUserService&quot;</span><span class="ot"> generic=</span><span class="st">&quot;true&quot;</span>/&gt;</span></code></pre></div>
<p>通过GenericService使用服务：</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a>ClassPathXmlApplicationContext context <span class="op">=</span> <span class="kw">new</span> <span class="fu">ClassPathXmlApplicationContext</span><span class="op">(</span><span class="st">&quot;applicationContext.xml&quot;</span><span class="op">);</span></span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a><span class="co">//对于没有重裁的方法，参数类型可以不指定，传null即可；但方法重载的情况下，必须指定参数类型</span></span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>GenericService service <span class="op">=</span> <span class="op">(</span>GenericService<span class="op">)</span> context<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span><span class="st">&quot;userService&quot;</span><span class="op">);</span></span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> result <span class="op">=</span> service<span class="op">.</span>$<span class="fu">invoke</span><span class="op">(</span><span class="st">&quot;getName&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">[]</span> <span class="op">{</span> <span class="st">&quot;java.lang.String&quot;</span> <span class="op">},</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">[]{</span> <span class="st">&quot;Hello&quot;</span> <span class="op">});</span></span>
<span id="cb362-7"><a href="#cb362-7" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">);</span></span></code></pre></div>
<p>如果服务消费方不使用Spring，可以：</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="co">//普通编码配置方式  </span></span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>ApplicationConfig application <span class="op">=</span> <span class="kw">new</span> <span class="fu">ApplicationConfig</span><span class="op">();</span></span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>application<span class="op">.</span><span class="fu">setName</span><span class="op">(</span><span class="st">&quot;demotest-consumer&quot;</span><span class="op">);</span></span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a><span class="co">//连接注册中心配置</span></span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a>RegistryConfig registry <span class="op">=</span> <span class="kw">new</span> <span class="fu">RegistryConfig</span><span class="op">();</span></span>
<span id="cb363-7"><a href="#cb363-7" aria-hidden="true" tabindex="-1"></a>registry<span class="op">.</span><span class="fu">setAddress</span><span class="op">(</span><span class="st">&quot;zookeeper://127.0.0.1:2181&quot;</span><span class="op">);</span></span>
<span id="cb363-8"><a href="#cb363-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-9"><a href="#cb363-9" aria-hidden="true" tabindex="-1"></a>ReferenceConfig<span class="op">&lt;</span>GenericService<span class="op">&gt;</span> reference <span class="op">=</span> <span class="kw">new</span> ReferenceConfig<span class="op">&lt;</span>GenericService<span class="op">&gt;();</span></span>
<span id="cb363-10"><a href="#cb363-10" aria-hidden="true" tabindex="-1"></a>reference<span class="op">.</span><span class="fu">setApplication</span><span class="op">(</span>application<span class="op">);</span></span>
<span id="cb363-11"><a href="#cb363-11" aria-hidden="true" tabindex="-1"></a>reference<span class="op">.</span><span class="fu">setRegistry</span><span class="op">(</span>registry<span class="op">);</span></span>
<span id="cb363-12"><a href="#cb363-12" aria-hidden="true" tabindex="-1"></a>reference<span class="op">.</span><span class="fu">setTimeout</span><span class="op">(</span><span class="dv">6000</span><span class="op">);</span></span>
<span id="cb363-13"><a href="#cb363-13" aria-hidden="true" tabindex="-1"></a>reference<span class="op">.</span><span class="fu">setInterface</span><span class="op">(</span><span class="st">&quot;dao.repository.IUserService&quot;</span><span class="op">);</span></span>
<span id="cb363-14"><a href="#cb363-14" aria-hidden="true" tabindex="-1"></a>reference<span class="op">.</span><span class="fu">setGeneric</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span> <span class="co">//声明为泛化接口</span></span>
<span id="cb363-15"><a href="#cb363-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-16"><a href="#cb363-16" aria-hidden="true" tabindex="-1"></a><span class="co">//GenericService创建的开销很大，所以使用了缓存机制</span></span>
<span id="cb363-17"><a href="#cb363-17" aria-hidden="true" tabindex="-1"></a>ReferenceConfigCache cache <span class="op">=</span> ReferenceConfigCache<span class="op">.</span><span class="fu">getCache</span><span class="op">();</span></span>
<span id="cb363-18"><a href="#cb363-18" aria-hidden="true" tabindex="-1"></a>GenericService genericService <span class="op">=</span> cache<span class="op">.</span><span class="fu">get</span><span class="op">(</span>reference<span class="op">);</span></span>
<span id="cb363-19"><a href="#cb363-19" aria-hidden="true" tabindex="-1"></a><span class="co">//GenericService genericService = (GenericService) reference.get();</span></span>
<span id="cb363-20"><a href="#cb363-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-21"><a href="#cb363-21" aria-hidden="true" tabindex="-1"></a><span class="co">//基本类型以及Date,List,Map等不需要转换，直接调用</span></span>
<span id="cb363-22"><a href="#cb363-22" aria-hidden="true" tabindex="-1"></a><span class="bu">Object</span> result <span class="op">=</span> genericService<span class="op">.</span>$<span class="fu">invoke</span><span class="op">(</span><span class="st">&quot;getName&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="bu">String</span><span class="op">[]</span> <span class="op">{</span> <span class="st">&quot;java.lang.String&quot;</span> <span class="op">},</span> <span class="kw">new</span> <span class="bu">Object</span><span class="op">[]</span> <span class="op">{</span> <span class="st">&quot;Hello&quot;</span> <span class="op">});</span></span>
<span id="cb363-23"><a href="#cb363-23" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">);</span></span></code></pre></div>
<h3 id="后台管理页面">后台管理页面</h3>
<p>dubbo-admin可以展示服务提供者、消费者、路由信息、权重等信息，以及修改服务提供者，消息者的属性，以达到服务治理的目的</p>
<p><strong>dubbo-2.6.0及之前的版本</strong></p>
<p>下载源码: <a href="https://github.com/apache/incubator-dubbo/tree/dubbo-2.6.0">dubbo-2.6.0</a></p>
<p>找到dubbo-admin工程，进入dubbo-admin文件夹，使用maven命令<code>mvn package -Dskiptest=true</code>打包成war文件，并放到tomcat目录下</p>
<p>如果dubbo和注册中心不在同一台主机，先启动一次tomcat，让tomcat解压war包，然后修改webapps-admin-2.6.0-INF下的dubbo.properties文件，设置注册中心</p>
<pre><code>dubbo.registry.address=zookeeper://127.0.0.1:2181
dubbo.admin.root.password=root
dubbo.admin.guest.password=guest</code></pre>
<p>重启tomcat，浏览器打开对应页面登录即可</p>
<p><strong>dubbo-2.6.1及之后的版本</strong></p>
<pre class="shell"><code># 安装tomcat
wget https://archive.apache.org/dist/tomcat/tomcat-6/v6.0.35/bin/apache-tomcat-6.0.35.tar.gz
tar zxvf apache-tomcat-6.0.35.tar.gz
cd apache-tomcat-6.0.35
rm -rf webapps/ROOT

# dubbo-admin在2.6.0后改名为dubbo-ops
git clone https://github.com/dubbo/dubbo-ops.git
/var/tmp/dubbo-ops
pushd /var/tmp/dubbo-ops
mvn clean package
popd

# 解压到tomcat目录
unzip /var/tmp/dubbo-ops/dubbo-admin/target/dubbo-admin-2.0.0.war -d webapps/ROOT</code></pre>
<p>配置 <code>dubbo.properties</code> 把 dubbo
注解中心地址配置成真正项目里面的注册中心</p>
<pre class="shell"><code>vi webapps/ROOT/WEB-INF/dubbo.properties</code></pre>
<p>dubbo.properties</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="dt">dubbo.registry.address</span><span class="ot">=</span><span class="st">zookeeper://127.0.0.1:2181</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a><span class="dt">dubbo.admin.root.password</span><span class="ot">=</span><span class="st">root</span></span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a><span class="dt">dubbo.admin.guest.password</span><span class="ot">=</span><span class="st">guest</span></span></code></pre></div>
<p>启动、停止</p>
<pre class="shell"><code>./bin/startup.sh

./bin/shutdown.sh</code></pre>
<p>然后可以通过: <code>http://127.0.0.1:8080/</code> 进行访问</p>
<h3 id="dubbox">Dubbox</h3>
<p>项目地址: <a href="https://github.com/dangdangdotcom/dubbox">dangdangdotcom/dubbox</a></p>
<p>Dubbox是在Dubbo的基础上添加了REST、JSON、Kryo等支持</p>
<p><strong>RESTful</strong></p>
<p>接口</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserService <span class="op">{</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">registerUser</span><span class="op">(</span>User user<span class="op">);</span></span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a>    User <span class="fu">getUser</span><span class="op">(</span><span class="bu">Long</span> id<span class="op">);</span></span>
<span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>实现（注解写在实现或接口均可，建议写在实现上；写在实现上的注解会覆盖接口上的）</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Path</span><span class="op">(</span><span class="st">&quot;users&quot;</span><span class="op">)</span></span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a><span class="at">@Produces</span><span class="op">({</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_JSON</span><span class="op">,</span> MediaType<span class="op">.</span><span class="fu">TEXT_XML</span><span class="op">})</span><span class="co">//该URL可以使用JSON或XML格式返回</span></span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a><span class="at">@Consumes</span><span class="op">({</span>ContentType<span class="op">.</span><span class="fu">APPLICATION_JSON_UTF_8</span><span class="op">,</span> ContentType<span class="op">.</span><span class="fu">TEXT_XML_UTF_8</span><span class="op">})</span><span class="co">//该URL可以使用JSON或XML格式的参数；如果出现乱码，可以指定编码为UTF-8</span></span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceImpl <span class="kw">implements</span> UserService <span class="op">{</span></span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@POST</span></span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Path</span><span class="op">(</span><span class="st">&quot;register&quot;</span><span class="op">)</span></span>
<span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Consumes</span><span class="op">({</span>MediaType<span class="op">.</span><span class="fu">APPLICATION_JSON</span><span class="op">})</span><span class="co">//使用JSON类型的参数，自动映射成POJO</span></span>
<span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">registerUser</span><span class="op">(</span>User user<span class="op">)</span> <span class="op">{</span></span>
<span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// save the user...</span></span>
<span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-13"><a href="#cb370-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GET</span></span>
<span id="cb370-14"><a href="#cb370-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Path</span><span class="op">(</span><span class="st">&quot;getuser&quot;</span><span class="op">)</span></span>
<span id="cb370-15"><a href="#cb370-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Produces</span><span class="op">({</span><span class="st">&quot;application/json&quot;</span><span class="op">,</span> <span class="st">&quot;text/xml&quot;</span><span class="op">})</span></span>
<span id="cb370-16"><a href="#cb370-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> User <span class="fu">getUser</span><span class="op">(</span><span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">){</span></span>
<span id="cb370-17"><a href="#cb370-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">();</span></span>
<span id="cb370-18"><a href="#cb370-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb370-19"><a href="#cb370-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果需要上下文信息</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="co">//方法一: 使用@Context获取</span></span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> User <span class="fu">getUser</span><span class="op">(</span><span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">,</span> <span class="at">@Context</span> HttpServletRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Client address is &quot;</span> <span class="op">+</span> request<span class="op">.</span><span class="fu">getRemoteAddr</span><span class="op">());</span></span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a><span class="co">//方法一: 使用RpcContext获取</span></span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> User <span class="fu">getUser</span><span class="op">(</span><span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Client address is &quot;</span> <span class="op">+</span> RpcContext<span class="op">.</span><span class="fu">getContext</span><span class="op">().</span><span class="fu">getRemoteAddressString</span><span class="op">());</span></span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时User类需实现序列化接口</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="at">@XmlRootElement</span><span class="co">//使用XML</span></span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a><span class="at">@XmlAccessorType</span><span class="op">(</span><span class="bu">XmlAccessType</span><span class="op">.</span><span class="fu">FIELD</span><span class="op">)</span></span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb372-4"><a href="#cb372-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-5"><a href="#cb372-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@XmlElement</span><span class="op">(</span>name<span class="op">=</span><span class="st">&quot;username&quot;</span><span class="op">)</span></span>
<span id="cb372-6"><a href="#cb372-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb372-7"><a href="#cb372-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb372-8"><a href="#cb372-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*使用JSON</span></span>
<span id="cb372-9"><a href="#cb372-9" aria-hidden="true" tabindex="-1"></a><span class="co">    @JsonProperty(&quot;username&quot;)</span></span>
<span id="cb372-10"><a href="#cb372-10" aria-hidden="true" tabindex="-1"></a><span class="co">    private String name;</span></span>
<span id="cb372-11"><a href="#cb372-11" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb372-12"><a href="#cb372-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>配置REST协议，<code>server</code>可以使用<code>tomcat</code>、<code>jetty</code>、<code>netty</code>、<code>servlet</code></p>
<div class="sourceCode" id="cb373"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用外部的服务 --&gt;</span></span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dubbo:protocol</span><span class="ot"> name=</span><span class="st">&quot;rest&quot;</span><span class="ot"> server=</span><span class="st">&quot;servlet&quot;</span>/&gt;</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用内置的服务配置端口即可 --&gt;</span></span>
<span id="cb373-5"><a href="#cb373-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dubbo:protocol</span><span class="ot"> name=</span><span class="st">&quot;rest&quot;</span><span class="ot"> port=</span><span class="st">&quot;8888&quot;</span>/&gt;</span></code></pre></div>
<p>如果使用<code>servlet</code>还需要配置web.xml</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">web-app</span>&gt;</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context-param</span>&gt;</span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-name</span>&gt;contextConfigLocation&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-value</span>&gt;/WEB-INF/classes/META-INF/spring/dubbo-demo-provider.xml&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">context-param</span>&gt;</span>
<span id="cb374-6"><a href="#cb374-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-7"><a href="#cb374-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- dubbo的listener的必须放在Spring的listener前面 --&gt;</span></span>
<span id="cb374-8"><a href="#cb374-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">listener</span>&gt;</span>
<span id="cb374-9"><a href="#cb374-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">listener-class</span>&gt;com.alibaba.dubbo.remoting.http.servlet.BootstrapListener&lt;/<span class="kw">listener-class</span>&gt;</span>
<span id="cb374-10"><a href="#cb374-10" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">listener</span>&gt;</span>
<span id="cb374-11"><a href="#cb374-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-12"><a href="#cb374-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">listener</span>&gt;</span>
<span id="cb374-13"><a href="#cb374-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">listener-class</span>&gt;org.springframework.web.context.ContextLoaderListener&lt;/<span class="kw">listener-class</span>&gt;</span>
<span id="cb374-14"><a href="#cb374-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">listener</span>&gt;</span>
<span id="cb374-15"><a href="#cb374-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-16"><a href="#cb374-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet</span>&gt;</span>
<span id="cb374-17"><a href="#cb374-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;dispatcher&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb374-18"><a href="#cb374-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-class</span>&gt;com.alibaba.dubbo.remoting.http.servlet.DispatcherServlet&lt;/<span class="kw">servlet-class</span>&gt;</span>
<span id="cb374-19"><a href="#cb374-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">load-on-startup</span>&gt;1&lt;/<span class="kw">load-on-startup</span>&gt;</span>
<span id="cb374-20"><a href="#cb374-20" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet</span>&gt;</span>
<span id="cb374-21"><a href="#cb374-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-22"><a href="#cb374-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb374-23"><a href="#cb374-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">servlet-name</span>&gt;dispatcher&lt;/<span class="kw">servlet-name</span>&gt;</span>
<span id="cb374-24"><a href="#cb374-24" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb374-25"><a href="#cb374-25" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">servlet-mapping</span>&gt;</span>
<span id="cb374-26"><a href="#cb374-26" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">web-app</span>&gt;</span></code></pre></div>
<h2 id="activemq">ActiveMQ</h2>
<p><a href="http://activemq.apache.org/download.html">下载ActiveMQ</a></p>
<p>ActiveMQ是Apache的基于JMS的消息中间件，同类型的有RabbitMQ（支持AMQP事务处理），Kafka（使用zero-copy机制，高吞吐量(tps)）</p>
<p>ActiveMQ支持点对点（queue）和一对多（topic）两种消息机制</p>
<p><strong>启动</strong></p>
<pre><code>apache-activemq-5.15.7/bin/activemq start</code></pre>
<p>登录后台: http://127.0.0.1:8161/admin/ （默认账号: admin，密码:
admin，可以在conf/jetty.xml中配置）</p>
<p>开发时可以使用ActiveMQ解压目录下的activemq.jar，也可以使用maven</p>
<p><strong>pom.xml</strong></p>
<div class="sourceCode" id="cb376"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- https://mvnrepository.com/artifact/org.apache.activemq/activemq-core --&gt;</span></span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.activemq&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;activemq-core&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb376-6"><a href="#cb376-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;5.7.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb376-7"><a href="#cb376-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb376-8"><a href="#cb376-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependencies</span>&gt;</span></code></pre></div>
<p><strong>使用</strong>（注意要让消费者先启动）：</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Test <span class="op">{</span></span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">test1</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//ActiveMq 的默认用户名、密码、连接地址</span></span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> username <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_USER</span><span class="op">;</span></span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> password <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_PASSWORD</span><span class="op">;</span></span>
<span id="cb377-7"><a href="#cb377-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> brokenUrl <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_BROKER_URL</span><span class="op">;</span><span class="co">//默认为failover://tcp://localhost:61616</span></span>
<span id="cb377-8"><a href="#cb377-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-9"><a href="#cb377-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//连接工厂</span></span>
<span id="cb377-10"><a href="#cb377-10" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory<span class="op">;</span></span>
<span id="cb377-11"><a href="#cb377-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//连接接对象</span></span>
<span id="cb377-12"><a href="#cb377-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb377-13"><a href="#cb377-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">//事务管理</span></span>
<span id="cb377-14"><a href="#cb377-14" aria-hidden="true" tabindex="-1"></a>        Session session <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb377-15"><a href="#cb377-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-16"><a href="#cb377-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-17"><a href="#cb377-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">//用户名密码可以在conf/jetty-realm.properties中配置</span></span>
<span id="cb377-18"><a href="#cb377-18" aria-hidden="true" tabindex="-1"></a>            connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ActiveMQConnectionFactory</span><span class="op">(</span>username<span class="op">,</span> password<span class="op">,</span> brokenUrl<span class="op">);</span></span>
<span id="cb377-19"><a href="#cb377-19" aria-hidden="true" tabindex="-1"></a>            connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">createConnection</span><span class="op">();</span></span>
<span id="cb377-20"><a href="#cb377-20" aria-hidden="true" tabindex="-1"></a>            connection<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb377-21"><a href="#cb377-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-22"><a href="#cb377-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">//第一个参数指定是否使用事务，第二个参数为应答方式，使用事务时为Session.SESSION_TRANSACTED</span></span>
<span id="cb377-23"><a href="#cb377-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">//生产者和消费者的session模式可以不同，但最好一致</span></span>
<span id="cb377-24"><a href="#cb377-24" aria-hidden="true" tabindex="-1"></a>            session <span class="op">=</span> connection<span class="op">.</span><span class="fu">createSession</span><span class="op">(</span><span class="kw">true</span><span class="op">,</span> Session<span class="op">.</span><span class="fu">SESSION_TRANSACTED</span><span class="op">);</span></span>
<span id="cb377-25"><a href="#cb377-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-26"><a href="#cb377-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*</span></span>
<span id="cb377-27"><a href="#cb377-27" aria-hidden="true" tabindex="-1"></a><span class="co">            //使用点对点</span></span>
<span id="cb377-28"><a href="#cb377-28" aria-hidden="true" tabindex="-1"></a><span class="co">            Destination destination = session.createQueue(&quot;name&quot;);</span></span>
<span id="cb377-29"><a href="#cb377-29" aria-hidden="true" tabindex="-1"></a><span class="co">            producer = session.createProducer(destination);</span></span>
<span id="cb377-30"><a href="#cb377-30" aria-hidden="true" tabindex="-1"></a><span class="co">            //设置持久化传输（对该生产者有效），持久化可以通过conf/activemq.xml中的persistenceAdapter属性配置</span></span>
<span id="cb377-31"><a href="#cb377-31" aria-hidden="true" tabindex="-1"></a><span class="co">            producer.setDeliveryMode(DeliveryMode.PERSISTENT);</span></span>
<span id="cb377-32"><a href="#cb377-32" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb377-33"><a href="#cb377-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">//使用一对多</span></span>
<span id="cb377-34"><a href="#cb377-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">//producter和consumer要使用同一个topic才能收到消息</span></span>
<span id="cb377-35"><a href="#cb377-35" aria-hidden="true" tabindex="-1"></a>            Topic topic <span class="op">=</span> session<span class="op">.</span><span class="fu">createTopic</span><span class="op">(</span><span class="st">&quot;topic1&quot;</span><span class="op">);</span></span>
<span id="cb377-36"><a href="#cb377-36" aria-hidden="true" tabindex="-1"></a>            TextMessage message <span class="op">=</span> session<span class="op">.</span><span class="fu">createTextMessage</span><span class="op">(</span><span class="st">&quot;消息1&quot;</span><span class="op">);</span></span>
<span id="cb377-37"><a href="#cb377-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*</span></span>
<span id="cb377-38"><a href="#cb377-38" aria-hidden="true" tabindex="-1"></a><span class="co">            //设置持久化传输（对该消息有效）</span></span>
<span id="cb377-39"><a href="#cb377-39" aria-hidden="true" tabindex="-1"></a><span class="co">            message.setJMSDeliveryMode(DeliveryMode.PERSISTENT);</span></span>
<span id="cb377-40"><a href="#cb377-40" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb377-41"><a href="#cb377-41" aria-hidden="true" tabindex="-1"></a>            <span class="co">//生产者</span></span>
<span id="cb377-42"><a href="#cb377-42" aria-hidden="true" tabindex="-1"></a>            MessageProducer producter <span class="op">=</span> session<span class="op">.</span><span class="fu">createProducer</span><span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb377-43"><a href="#cb377-43" aria-hidden="true" tabindex="-1"></a>            producter<span class="op">.</span><span class="fu">send</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb377-44"><a href="#cb377-44" aria-hidden="true" tabindex="-1"></a>            session<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb377-45"><a href="#cb377-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-46"><a href="#cb377-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--发送了消息&quot;</span><span class="op">);</span></span>
<span id="cb377-47"><a href="#cb377-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-48"><a href="#cb377-48" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-49"><a href="#cb377-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb377-50"><a href="#cb377-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>connection <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-51"><a href="#cb377-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-52"><a href="#cb377-52" aria-hidden="true" tabindex="-1"></a>                    connection<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb377-53"><a href="#cb377-53" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-54"><a href="#cb377-54" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-55"><a href="#cb377-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-56"><a href="#cb377-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb377-57"><a href="#cb377-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>session <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-58"><a href="#cb377-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-59"><a href="#cb377-59" aria-hidden="true" tabindex="-1"></a>                    session<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb377-60"><a href="#cb377-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-61"><a href="#cb377-61" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-62"><a href="#cb377-62" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-63"><a href="#cb377-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb377-64"><a href="#cb377-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb377-65"><a href="#cb377-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-66"><a href="#cb377-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb377-67"><a href="#cb377-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-68"><a href="#cb377-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb377-69"><a href="#cb377-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">test2</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb377-70"><a href="#cb377-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">//ActiveMq 的默认用户名、密码、连接地址</span></span>
<span id="cb377-71"><a href="#cb377-71" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> username <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_USER</span><span class="op">;</span></span>
<span id="cb377-72"><a href="#cb377-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> password <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_PASSWORD</span><span class="op">;</span></span>
<span id="cb377-73"><a href="#cb377-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> brokenUrl <span class="op">=</span> ActiveMQConnection<span class="op">.</span><span class="fu">DEFAULT_BROKER_URL</span><span class="op">;</span></span>
<span id="cb377-74"><a href="#cb377-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-75"><a href="#cb377-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">//连接工厂</span></span>
<span id="cb377-76"><a href="#cb377-76" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory<span class="op">;</span></span>
<span id="cb377-77"><a href="#cb377-77" aria-hidden="true" tabindex="-1"></a>        <span class="co">//连接接对象</span></span>
<span id="cb377-78"><a href="#cb377-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb377-79"><a href="#cb377-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">//事务管理</span></span>
<span id="cb377-80"><a href="#cb377-80" aria-hidden="true" tabindex="-1"></a>        Session session <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb377-81"><a href="#cb377-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-82"><a href="#cb377-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-83"><a href="#cb377-83" aria-hidden="true" tabindex="-1"></a>            connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ActiveMQConnectionFactory</span><span class="op">(</span>username<span class="op">,</span> password<span class="op">,</span> brokenUrl<span class="op">);</span></span>
<span id="cb377-84"><a href="#cb377-84" aria-hidden="true" tabindex="-1"></a>            connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">createConnection</span><span class="op">();</span></span>
<span id="cb377-85"><a href="#cb377-85" aria-hidden="true" tabindex="-1"></a>            connection<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb377-86"><a href="#cb377-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-87"><a href="#cb377-87" aria-hidden="true" tabindex="-1"></a>            <span class="co">//第一个参数指定是否使用事务，第二个参数为应答方式，这里使用Session.CLIENT_ACKNOWLEDGE，需要我们手动应答，这时失败可以重发（也可以设置成Session.AUTO_ACKNOWLEDGE，但可能会丢失信息）</span></span>
<span id="cb377-88"><a href="#cb377-88" aria-hidden="true" tabindex="-1"></a>            session <span class="op">=</span> connection<span class="op">.</span><span class="fu">createSession</span><span class="op">(</span><span class="kw">false</span><span class="op">,</span> Session<span class="op">.</span><span class="fu">CLIENT_ACKNOWLEDGE</span><span class="op">);</span></span>
<span id="cb377-89"><a href="#cb377-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-90"><a href="#cb377-90" aria-hidden="true" tabindex="-1"></a>            <span class="co">//producter和consumer要使用同一个topic才能收到消息</span></span>
<span id="cb377-91"><a href="#cb377-91" aria-hidden="true" tabindex="-1"></a>            Topic topic <span class="op">=</span> session<span class="op">.</span><span class="fu">createTopic</span><span class="op">(</span><span class="st">&quot;topic1&quot;</span><span class="op">);</span></span>
<span id="cb377-92"><a href="#cb377-92" aria-hidden="true" tabindex="-1"></a>            TextMessage message <span class="op">=</span> session<span class="op">.</span><span class="fu">createTextMessage</span><span class="op">(</span><span class="st">&quot;消息1&quot;</span><span class="op">);</span></span>
<span id="cb377-93"><a href="#cb377-93" aria-hidden="true" tabindex="-1"></a>            <span class="co">//消费者</span></span>
<span id="cb377-94"><a href="#cb377-94" aria-hidden="true" tabindex="-1"></a>            MessageConsumer consumer <span class="op">=</span> session<span class="op">.</span><span class="fu">createConsumer</span><span class="op">(</span>topic<span class="op">);</span></span>
<span id="cb377-95"><a href="#cb377-95" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*</span></span>
<span id="cb377-96"><a href="#cb377-96" aria-hidden="true" tabindex="-1"></a><span class="co">            消费者可以指定接收何种类型的message，这里可以支持SQL的条件语法（AND、OR、IN...）</span></span>
<span id="cb377-97"><a href="#cb377-97" aria-hidden="true" tabindex="-1"></a><span class="co">            MessageConsumer consumer = session.createConsumer(destination,&quot;JMSXGroupID=&#39;A&#39;&quot;);</span></span>
<span id="cb377-98"><a href="#cb377-98" aria-hidden="true" tabindex="-1"></a><span class="co">            此时生产者需要：message.setStringProperty(&quot;JMSXGroupID&quot;,&quot;A&quot;);</span></span>
<span id="cb377-99"><a href="#cb377-99" aria-hidden="true" tabindex="-1"></a><span class="co">            */</span></span>
<span id="cb377-100"><a href="#cb377-100" aria-hidden="true" tabindex="-1"></a>            <span class="dt">final</span> Session finalSession <span class="op">=</span> session<span class="op">;</span></span>
<span id="cb377-101"><a href="#cb377-101" aria-hidden="true" tabindex="-1"></a>            consumer<span class="op">.</span><span class="fu">setMessageListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MessageListener</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb377-102"><a href="#cb377-102" aria-hidden="true" tabindex="-1"></a>                <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onMessage</span><span class="op">(</span>Message message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-103"><a href="#cb377-103" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-104"><a href="#cb377-104" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--收到: -&quot;</span> <span class="op">+</span> <span class="op">((</span>TextMessage<span class="op">)</span> message<span class="op">).</span><span class="fu">getText</span><span class="op">());</span></span>
<span id="cb377-105"><a href="#cb377-105" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//手动应答</span></span>
<span id="cb377-106"><a href="#cb377-106" aria-hidden="true" tabindex="-1"></a>                        message<span class="op">.</span><span class="fu">acknowledge</span><span class="op">();</span></span>
<span id="cb377-107"><a href="#cb377-107" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-108"><a href="#cb377-108" aria-hidden="true" tabindex="-1"></a>                        e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-109"><a href="#cb377-109" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-110"><a href="#cb377-110" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--接收失败，正在重试&quot;</span><span class="op">);</span></span>
<span id="cb377-111"><a href="#cb377-111" aria-hidden="true" tabindex="-1"></a>                            <span class="co">//失败时重发</span></span>
<span id="cb377-112"><a href="#cb377-112" aria-hidden="true" tabindex="-1"></a>                            finalSession<span class="op">.</span><span class="fu">recover</span><span class="op">();</span></span>
<span id="cb377-113"><a href="#cb377-113" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e1<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-114"><a href="#cb377-114" aria-hidden="true" tabindex="-1"></a>                            e1<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-115"><a href="#cb377-115" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb377-116"><a href="#cb377-116" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb377-117"><a href="#cb377-117" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-118"><a href="#cb377-118" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb377-119"><a href="#cb377-119" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果线程结束，则无法接收到发过来的消息</span></span>
<span id="cb377-120"><a href="#cb377-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-121"><a href="#cb377-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-122"><a href="#cb377-122" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb377-123"><a href="#cb377-123" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">InterruptedException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-124"><a href="#cb377-124" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-125"><a href="#cb377-125" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-126"><a href="#cb377-126" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb377-127"><a href="#cb377-127" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-128"><a href="#cb377-128" aria-hidden="true" tabindex="-1"></a>            e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-129"><a href="#cb377-129" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">finally</span> <span class="op">{</span></span>
<span id="cb377-130"><a href="#cb377-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>connection <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-131"><a href="#cb377-131" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-132"><a href="#cb377-132" aria-hidden="true" tabindex="-1"></a>                    connection<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb377-133"><a href="#cb377-133" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-134"><a href="#cb377-134" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-135"><a href="#cb377-135" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-136"><a href="#cb377-136" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb377-137"><a href="#cb377-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>session <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-138"><a href="#cb377-138" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb377-139"><a href="#cb377-139" aria-hidden="true" tabindex="-1"></a>                    session<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb377-140"><a href="#cb377-140" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>JMSException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb377-141"><a href="#cb377-141" aria-hidden="true" tabindex="-1"></a>                    e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb377-142"><a href="#cb377-142" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb377-143"><a href="#cb377-143" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb377-144"><a href="#cb377-144" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb377-145"><a href="#cb377-145" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb377-146"><a href="#cb377-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb377-147"><a href="#cb377-147" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="rabbitmq">RabbitMQ</h2>
<p>RabbitMQ基于ErLang开发，安装前需安装ErLang环境</p>
<p>配置文件</p>
<p><code>/etc/rabbitmq/rabbitmq-env.conf</code>关键参数：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>RABBITMQ_NODENAME</td>
<td>节点名称</td>
</tr>
<tr>
<td>RABBITMQ_NODE_IP_ADDRESS</td>
<td>监听IP，一般设置为127.0.0.1</td>
</tr>
<tr>
<td>RABBITMQ_NODE_PORT</td>
<td>监听端口，一般设置为5672</td>
</tr>
<tr>
<td>RABBITMQ_LOG_BASE</td>
<td>日志目录</td>
</tr>
<tr>
<td>RABBITMQ_PLUGINS_DIR</td>
<td>插件目录</td>
</tr>
<tr>
<td>RABBITMQ_MNESIA_BASE</td>
<td>后端存储目录</td>
</tr>
</tbody>
</table>
<p><code>/etc/rabbitmq/rabbitmq.config</code>关键参数：</p>
<table>
<colgroup>
<col style="width: 28%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tcp_listerners</td>
<td>设置rabbimq的监听端口，默认为[5672]</td>
</tr>
<tr>
<td>disk_free_limit</td>
<td>磁盘低水位线，若磁盘容量低于指定值则停止接收数据，默认值为{mem_relative,
1.0},即与内存相关联1：1，也可定制为多少byte</td>
</tr>
<tr>
<td>vm_memory_high_watermark</td>
<td>设置内存低水位线，若低于该水位线，则开启流控机制，默认值是0.4，即内存总量的40%</td>
</tr>
<tr>
<td>hipe_compile</td>
<td>将部分rabbimq代码用High Performance Erlang
compiler编译，可提升性能，该参数是实验性，若出现erlang vm
segfaults，应关掉</td>
</tr>
<tr>
<td>force_fine_statistics</td>
<td>该参数属于rabbimq_management，若为true则进行精细化的统计，但会影响性能</td>
</tr>
</tbody>
</table>
<h3 id="基本使用">基本使用</h3>
<pre class="shell"><code># 启动与停止（rabbitmq-server和rabbitmqctl均可）
rabbitmq-server start
rabbitmqctl stop_app

# 开启图形化管理插件（http://127.0.0.1:15672，默认用户名密码都是guest）
rabbitmq-plugins enable rabbitmq_management</code></pre>
<p>也可以通过命令行管理</p>
<pre class="shell"><code># 用户管理
rabbitmqctl add_user username password
rabbitmqctl list_users
rabbitmqctl change_password username newpassword
rabbitmqctl delete_user username

# 用户权限管理
rabbitmqctl set_permissions -p vhost username &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;
rabbitmqctl list_user_permissions username
rabbitmqctl clear_permissions -p vhostpath username

# 虚拟主机
rabbitmqctl add_vhost vhostpath
rabbitmqctl list_vhosts
rabbitmqctl list_permissions -p vhostpath
rabbitmqctl delete_vhost vhostpath

# 消息队列
rabbitmqctl list_queues
rabbitmqctl -p vhostpath purge_queue blue # 清除队列里的消息

# 其他
# 清除所有数据，要在rabbitmqctl stop_app之后使用
rabbitmqctl reset

# 集群
# 加入集群（会重置当前节点），可以指定数据存在内存中还是磁盘中
rabbitmqctl join_cluster clusternode [--ram | --disc]
# 修改集群节点存储形式（必须先停止该节点）
rabbitmqctl change_cluster_node_type disc|ram
# 修改节点名称
rabbitmqctl rename_cluster_node oldnode1 newnode1 [oldnode2 newnode2 ...]
# 从集群中删除节点（下次使用被删除的节点需先reset再start_app）
# 情况一：slave节点宕机可以在任意在线的节点上直接使用forget命令剔除
# 情况二：master和slave节点同时宕机，且master无法恢复，导致slave也无法重新启动，则需添加--offline参数，在所有节点都离线的状态下剔除master节点，这样slave节点才能正常的重新启动（此时会在slave节点中选取一个当master，并把原来的主节点剔除）
# 情况三：master和slave同时宕机，且都无法恢复，但可以访问其中一个的磁盘文件，则需拷贝$RABBIT_HOME/var/lib中的数据库文件到新的节点上，并把新节点的hostname改成和原来的一致，如果可以访问的是master中的磁盘文件，则按情况一处理（直接forget），如果可以访问的是slave中的磁盘文件，则按情况二处理（添加--offline参数）
rabbitmqctl forget_cluster_node nodename [--offline]
rabbitmqctl cluster_status</code></pre>
<h3 id="消息发送与接收">消息发送与接收</h3>
<div class="sourceCode" id="cb380"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="co">//消费者</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">//同一个vhost中不能有同名的exchange或同名的queue</span></span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-10"><a href="#cb380-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb380-11"><a href="#cb380-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb380-12"><a href="#cb380-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-13"><a href="#cb380-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> queueName <span class="op">=</span> <span class="st">&quot;test001&quot;</span><span class="op">;</span></span>
<span id="cb380-14"><a href="#cb380-14" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span>queueName<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb380-15"><a href="#cb380-15" aria-hidden="true" tabindex="-1"></a>        QueueingConsumer queueingConsumer <span class="op">=</span> <span class="kw">new</span> <span class="fu">QueueingConsumer</span><span class="op">(</span>channel<span class="op">);</span></span>
<span id="cb380-16"><a href="#cb380-16" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicConsume</span><span class="op">(</span>queueName<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> queueingConsumer<span class="op">);</span></span>
<span id="cb380-17"><a href="#cb380-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-18"><a href="#cb380-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb380-19"><a href="#cb380-19" aria-hidden="true" tabindex="-1"></a>            Delivery delivery <span class="op">=</span> queueingConsumer<span class="op">.</span><span class="fu">nextDelivery</span><span class="op">();</span></span>
<span id="cb380-20"><a href="#cb380-20" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>delivery<span class="op">.</span><span class="fu">getBody</span><span class="op">()));</span></span>
<span id="cb380-21"><a href="#cb380-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb380-22"><a href="#cb380-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb380-23"><a href="#cb380-23" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb380-24"><a href="#cb380-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-25"><a href="#cb380-25" aria-hidden="true" tabindex="-1"></a><span class="bu">Thread</span><span class="op">.</span><span class="fu">sleep</span><span class="op">(</span><span class="dv">500L</span><span class="op">);</span>    <span class="co">//确保消费者先启动</span></span>
<span id="cb380-26"><a href="#cb380-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-27"><a href="#cb380-27" aria-hidden="true" tabindex="-1"></a><span class="co">//生产者</span></span>
<span id="cb380-28"><a href="#cb380-28" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb380-29"><a href="#cb380-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb380-30"><a href="#cb380-30" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb380-31"><a href="#cb380-31" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb380-32"><a href="#cb380-32" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb380-33"><a href="#cb380-33" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb380-34"><a href="#cb380-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-35"><a href="#cb380-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb380-36"><a href="#cb380-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb380-37"><a href="#cb380-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-38"><a href="#cb380-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb380-39"><a href="#cb380-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> msg <span class="op">=</span> <span class="st">&quot;Hello world&quot;</span><span class="op">;</span></span>
<span id="cb380-40"><a href="#cb380-40" aria-hidden="true" tabindex="-1"></a>            channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;test001&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> msg<span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb380-41"><a href="#cb380-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb380-42"><a href="#cb380-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb380-43"><a href="#cb380-43" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb380-44"><a href="#cb380-44" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb380-45"><a href="#cb380-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb380-46"><a href="#cb380-46" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<h3 id="消息投递方式">消息投递方式</h3>
<p>消息投递方式由exchangeType控制，不同的exchangeType匹配不同类型的routingKey，而每个queue对应一个routingKey（不同的queue可以使用同一个routingKey）</p>
<p>exchange有以下类型： - <code>direct</code>: 直接根据routingkey全匹配
- <code>topic</code>:
routingkey可以使用通配符，<code>#</code>匹配一个或多个单词，<code>*</code>只匹配一个单词（比如<code>user.#</code>可以匹配到<code>user.name.update</code>，而<code>user.*</code>只能匹配到<code>user.name</code>）
- <code>fanout</code>:
不管routingkey，把消息发送到所有绑定到当前exchange的queue</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="co">//消费者</span></span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb381-7"><a href="#cb381-7" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb381-8"><a href="#cb381-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-9"><a href="#cb381-9" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setAutomaticRecoveryEnabled</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb381-10"><a href="#cb381-10" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setNetworkRecoveryInterval</span><span class="op">(</span><span class="dv">3000</span><span class="op">);</span></span>
<span id="cb381-11"><a href="#cb381-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-12"><a href="#cb381-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb381-13"><a href="#cb381-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb381-14"><a href="#cb381-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-15"><a href="#cb381-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> exchangeName <span class="op">=</span> <span class="st">&quot;test_exchange&quot;</span><span class="op">;</span></span>
<span id="cb381-16"><a href="#cb381-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> exchangeType <span class="op">=</span> <span class="st">&quot;direct&quot;</span><span class="op">;</span>     <span class="co">//direct、topic、fanout</span></span>
<span id="cb381-17"><a href="#cb381-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> queueName <span class="op">=</span> <span class="st">&quot;test001&quot;</span><span class="op">;</span></span>
<span id="cb381-18"><a href="#cb381-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> routingKey <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">;</span>         <span class="co">//根据exchangeType不同可以换成user.#、user.*等形式</span></span>
<span id="cb381-19"><a href="#cb381-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-20"><a href="#cb381-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-21"><a href="#cb381-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">//exchange和queue的声明放在生产端或消费端都可以（如果已有同名且属性相同不会重复创建；但如果属性不同，重复声明可能会有问题）</span></span>
<span id="cb381-22"><a href="#cb381-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">//exchangeDeclare(exchange, type, durable /*持久化*/, autoDelete, arguments)</span></span>
<span id="cb381-23"><a href="#cb381-23" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">exchangeDeclare</span><span class="op">(</span>exchangeName<span class="op">,</span> exchangeType<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb381-24"><a href="#cb381-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-25"><a href="#cb381-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">//queueDeclare(queue, durable, exclusive /*独占，queue只对当前connection可见*/, autoDelete /*断开连接后是否自动删除，设置exclusive后一般也要设置这个*/, arguments  /*可以设置TTL(过期时间)、数量限制等，可以使用图形化的管控台查看所有选项*/)</span></span>
<span id="cb381-26"><a href="#cb381-26" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span>queueName<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb381-27"><a href="#cb381-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-28"><a href="#cb381-28" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueBind</span><span class="op">(</span>queueName<span class="op">,</span> exchangeName<span class="op">,</span> routingKey<span class="op">);</span></span>
<span id="cb381-29"><a href="#cb381-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-30"><a href="#cb381-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-31"><a href="#cb381-31" aria-hidden="true" tabindex="-1"></a>        QueueingConsumer queueingConsumer <span class="op">=</span> <span class="kw">new</span> <span class="fu">QueueingConsumer</span><span class="op">(</span>channel<span class="op">);</span></span>
<span id="cb381-32"><a href="#cb381-32" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicConsume</span><span class="op">(</span>queueName<span class="op">,</span> <span class="kw">true</span><span class="op">,</span> queueingConsumer<span class="op">);</span></span>
<span id="cb381-33"><a href="#cb381-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-34"><a href="#cb381-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb381-35"><a href="#cb381-35" aria-hidden="true" tabindex="-1"></a>            Delivery delivery <span class="op">=</span> queueingConsumer<span class="op">.</span><span class="fu">nextDelivery</span><span class="op">();</span></span>
<span id="cb381-36"><a href="#cb381-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> delivery<span class="op">.</span><span class="fu">getProperties</span><span class="op">().</span><span class="fu">getHeaders</span><span class="op">();</span></span>
<span id="cb381-37"><a href="#cb381-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>delivery<span class="op">.</span><span class="fu">getBody</span><span class="op">())</span> <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> map<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;mypro1&quot;</span><span class="op">));</span></span>
<span id="cb381-38"><a href="#cb381-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb381-39"><a href="#cb381-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb381-40"><a href="#cb381-40" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb381-41"><a href="#cb381-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-42"><a href="#cb381-42" aria-hidden="true" tabindex="-1"></a><span class="co">//生产者</span></span>
<span id="cb381-43"><a href="#cb381-43" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb381-44"><a href="#cb381-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb381-45"><a href="#cb381-45" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb381-46"><a href="#cb381-46" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb381-47"><a href="#cb381-47" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb381-48"><a href="#cb381-48" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb381-49"><a href="#cb381-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-50"><a href="#cb381-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb381-51"><a href="#cb381-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb381-52"><a href="#cb381-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-53"><a href="#cb381-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb381-54"><a href="#cb381-54" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;mypro1&quot;</span><span class="op">,</span> <span class="st">&quot;aaa&quot;</span><span class="op">);</span></span>
<span id="cb381-55"><a href="#cb381-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-56"><a href="#cb381-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">//message附加属性</span></span>
<span id="cb381-57"><a href="#cb381-57" aria-hidden="true" tabindex="-1"></a>        AMQP<span class="op">.</span><span class="fu">BasicProperties</span> properties <span class="op">=</span> <span class="kw">new</span> AMQP<span class="op">.</span><span class="fu">BasicProperties</span><span class="op">.</span><span class="fu">Builder</span><span class="op">()</span></span>
<span id="cb381-58"><a href="#cb381-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">deliveryMode</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span>        <span class="co">//持久化消息</span></span>
<span id="cb381-59"><a href="#cb381-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">contentEncoding</span><span class="op">(</span><span class="st">&quot;UTF-8&quot;</span><span class="op">)</span></span>
<span id="cb381-60"><a href="#cb381-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">expiration</span><span class="op">(</span><span class="st">&quot;10000&quot;</span><span class="op">)</span>    <span class="co">//10s后过期</span></span>
<span id="cb381-61"><a href="#cb381-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">headers</span><span class="op">(</span>map<span class="op">)</span>           <span class="co">//自定义属性</span></span>
<span id="cb381-62"><a href="#cb381-62" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb381-63"><a href="#cb381-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-64"><a href="#cb381-64" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> exchangeName <span class="op">=</span> <span class="st">&quot;test_exchange&quot;</span><span class="op">;</span></span>
<span id="cb381-65"><a href="#cb381-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> routingKey1 <span class="op">=</span> <span class="st">&quot;user&quot;</span><span class="op">;</span></span>
<span id="cb381-66"><a href="#cb381-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> routingKey2 <span class="op">=</span> <span class="st">&quot;user.name&quot;</span><span class="op">;</span></span>
<span id="cb381-67"><a href="#cb381-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> routingKey3 <span class="op">=</span> <span class="st">&quot;user.name.save&quot;</span><span class="op">;</span></span>
<span id="cb381-68"><a href="#cb381-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> routingKey4 <span class="op">=</span> <span class="st">&quot;xxxxx&quot;</span><span class="op">;</span></span>
<span id="cb381-69"><a href="#cb381-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-70"><a href="#cb381-70" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span>exchangeName<span class="op">,</span> routingKey1<span class="op">,</span> properties<span class="op">,</span> <span class="st">&quot;Hello direct&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb381-71"><a href="#cb381-71" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span>exchangeName<span class="op">,</span> routingKey2<span class="op">,</span> properties<span class="op">,</span> <span class="st">&quot;Hello topic1&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb381-72"><a href="#cb381-72" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span>exchangeName<span class="op">,</span> routingKey3<span class="op">,</span> properties<span class="op">,</span> <span class="st">&quot;Hello topic2&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb381-73"><a href="#cb381-73" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span>exchangeName<span class="op">,</span> routingKey4<span class="op">,</span> properties<span class="op">,</span> <span class="st">&quot;Hello fanout&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb381-74"><a href="#cb381-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-75"><a href="#cb381-75" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb381-76"><a href="#cb381-76" aria-hidden="true" tabindex="-1"></a>        connection<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb381-77"><a href="#cb381-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb381-78"><a href="#cb381-78" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<h3 id="可靠性投递">可靠性投递</h3>
<p><strong>可靠性投递</strong></p>
<p>方案一：生产端数据入库，并对消息状态打标（两次入库），为避免消费端接收完消息就故障，还需要设置超时时间（分布式定时任务检测超时没有ack的消息并重新发送），有时因为routingkey不对或其他原因导致有些消息确实无法正确发送，这时还要设置最大重试次数</p>
<p>方案二：生产端数据入库然后立即发送第一条消息到消费端，然后生成第二条消息并做延迟投递（RabbitMQ实现可以用rabbitmq-delayed-message-exchange插件，或消息加TTL然后在死信队列中处理），投递到回调服务器中，消费端处理完消息后生成一条确认消息，发送到回调服务器，而回调服务器收到生产端的延迟投递的消息后查找是否有对应的确认消息，如果没有则启用补偿机制，与生产端进行RPC通信，要求重发消息</p>
<p>对比：</p>
<ol type="1">
<li><p>第一种方案的缺点是多次操作数据库，导致性能不好，而且无法得知消费端是处理完消息后才故障还是接收到消息就故障了，还需再次对消息做幂等的处理</p></li>
<li><p>第二种方案的缺点是如果延迟的时间太短，可能消息还没处理完，回调就已经发送了RPC指令要求重发，可能有重复消费的问题，优点是把对消息状态的打标放到了回调服务器中，减轻了生产端的压力</p></li>
</ol>
<p><strong>幂等</strong></p>
<p>方案一：利用数据库主键唯一性实现，可以通过唯一ID+指纹码做主键，同时还可以通过对ID进行分片解决性能瓶颈</p>
<p>方案二：利用Redis原子特性实现（比如自增），但是如果数据需要持久化，无法保证数据库和Redis同时成功或同时失败</p>
<p><strong>其他问题</strong></p>
<p>合并消息：使用序列化工具，把多条消息放到一个Map或自定义的对象中，在消费端再反序列化</p>
<p>顺序消息：自定义header告知消费端消息总数及id，消费端接收到消息后不立即处理，而是存储到数据库中，然后发一个给自己的延迟消息，等消息全部接收完成后，在延迟消息中检测消息是否完整，如果不完整，做补偿机制，完整则开始处理消息（或者把多条顺序消息合并再发送也可以实现）</p>
<p><strong>消息监听</strong></p>
<p>生产端使用<code>ConfirmListener</code>监听消费端的ack应答，使用<code>ReturnListener</code>监听错误的routingkey或其他原因导致消息不可达的情况</p>
<p>消费端自定义继承自<code>DefaultConsumer</code>的类可以通过回调的方式监听接收的消息</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyConsumer <span class="kw">extends</span> DefaultConsumer <span class="op">{</span></span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyConsumer</span><span class="op">(</span><span class="bu">Channel</span> channel<span class="op">)</span> <span class="op">{</span></span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span>channel<span class="op">);</span></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-6"><a href="#cb382-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleDelivery</span><span class="op">(</span><span class="bu">String</span> consumerTag<span class="op">,</span> Envelope envelope<span class="op">,</span> BasicProperties properties<span class="op">,</span> <span class="dt">byte</span><span class="op">[]</span> body<span class="op">)</span> <span class="cf">throw</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb382-7"><a href="#cb382-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>body<span class="op">));</span></span>
<span id="cb382-8"><a href="#cb382-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>envelope<span class="op">);</span></span>
<span id="cb382-9"><a href="#cb382-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb382-10"><a href="#cb382-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb382-11"><a href="#cb382-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-12"><a href="#cb382-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-13"><a href="#cb382-13" aria-hidden="true" tabindex="-1"></a><span class="co">//消费者</span></span>
<span id="cb382-14"><a href="#cb382-14" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb382-15"><a href="#cb382-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb382-16"><a href="#cb382-16" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb382-17"><a href="#cb382-17" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb382-18"><a href="#cb382-18" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb382-19"><a href="#cb382-19" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb382-20"><a href="#cb382-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-21"><a href="#cb382-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb382-22"><a href="#cb382-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb382-23"><a href="#cb382-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-24"><a href="#cb382-24" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">exchangeDeclare</span><span class="op">(</span><span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;topic&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb382-25"><a href="#cb382-25" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb382-26"><a href="#cb382-26" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueBind</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;confirm.#&quot;</span><span class="op">);</span></span>
<span id="cb382-27"><a href="#cb382-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-28"><a href="#cb382-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">//第二个参数为是否自动ack</span></span>
<span id="cb382-29"><a href="#cb382-29" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicConsume</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">MyConsumer</span><span class="op">(</span>channel<span class="op">));</span></span>
<span id="cb382-30"><a href="#cb382-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb382-31"><a href="#cb382-31" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb382-32"><a href="#cb382-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-33"><a href="#cb382-33" aria-hidden="true" tabindex="-1"></a><span class="co">//生产者</span></span>
<span id="cb382-34"><a href="#cb382-34" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb382-35"><a href="#cb382-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb382-36"><a href="#cb382-36" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb382-37"><a href="#cb382-37" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb382-38"><a href="#cb382-38" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb382-39"><a href="#cb382-39" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb382-40"><a href="#cb382-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-41"><a href="#cb382-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb382-42"><a href="#cb382-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb382-43"><a href="#cb382-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-44"><a href="#cb382-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">//启用消息确认监听</span></span>
<span id="cb382-45"><a href="#cb382-45" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">confirmSelect</span><span class="op">();</span></span>
<span id="cb382-46"><a href="#cb382-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-47"><a href="#cb382-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">//添加消息确认监听</span></span>
<span id="cb382-48"><a href="#cb382-48" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">addConfirmListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ConfirmListener</span><span class="op">(){</span></span>
<span id="cb382-49"><a href="#cb382-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleNack</span><span class="op">(</span><span class="dt">long</span> deliveryTag<span class="op">,</span> <span class="dt">boolean</span> multiple<span class="op">)</span> <span class="cf">throw</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb382-50"><a href="#cb382-50" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Not ACK&quot;</span><span class="op">);</span></span>
<span id="cb382-51"><a href="#cb382-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb382-52"><a href="#cb382-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleAck</span><span class="op">(</span><span class="dt">long</span> deliveryTag<span class="op">,</span> <span class="dt">boolean</span> multiple<span class="op">)</span> <span class="cf">throw</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb382-53"><a href="#cb382-53" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;ACK&quot;</span><span class="op">);</span></span>
<span id="cb382-54"><a href="#cb382-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb382-55"><a href="#cb382-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb382-56"><a href="#cb382-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-57"><a href="#cb382-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">//添加不可达消息监听</span></span>
<span id="cb382-58"><a href="#cb382-58" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">addReturnListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ReturnListener</span><span class="op">(){</span></span>
<span id="cb382-59"><a href="#cb382-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleReturn</span><span class="op">(</span><span class="dt">int</span> replyCode<span class="op">,</span> <span class="bu">String</span> replyText<span class="op">,</span> <span class="bu">String</span> exchange<span class="op">,</span> <span class="bu">String</span> routingkey<span class="op">,</span> BasicProperties properties<span class="op">,</span> <span class="dt">byte</span><span class="op">[]</span> body<span class="op">)</span> <span class="cf">throw</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb382-60"><a href="#cb382-60" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;return&quot;</span><span class="op">);</span></span>
<span id="cb382-61"><a href="#cb382-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb382-62"><a href="#cb382-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb382-63"><a href="#cb382-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-64"><a href="#cb382-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">//发送正常消息</span></span>
<span id="cb382-65"><a href="#cb382-65" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span><span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;confirm.save&quot;</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="st">&quot;Hello confirm&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb382-66"><a href="#cb382-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-67"><a href="#cb382-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">//发送不可达消息</span></span>
<span id="cb382-68"><a href="#cb382-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">//第三个参数为mandatory：当消息不可达时是放到returnListener中(true)还是直接删除(false)</span></span>
<span id="cb382-69"><a href="#cb382-69" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicPublish</span><span class="op">(</span><span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;abc.xxx&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="st">&quot;Hello confirm&quot;</span><span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb382-70"><a href="#cb382-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-71"><a href="#cb382-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-72"><a href="#cb382-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">//如果close就无法收到消息确认的应答了</span></span>
<span id="cb382-73"><a href="#cb382-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">//channel.close();</span></span>
<span id="cb382-74"><a href="#cb382-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">//connection.close();</span></span>
<span id="cb382-75"><a href="#cb382-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb382-76"><a href="#cb382-76" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<h3 id="消费端限流">消费端限流</h3>
<p>如果RabbitMQ中堆积了很多的未处理消息，这时如果直接打开消费端会导致严重的线上故障，这时可以通过消费端限流保证接收的消息不超过一定数量</p>
<p>在非自动签收的前提下，可以通过给Channel或Consumer设置Qos(服务质量保证)，来限制未被确认的消息超过一定数量就不再消费新的消息</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyConsumer <span class="kw">extends</span> DefaultConsumer <span class="op">{</span></span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Channel</span> channel<span class="op">;</span></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyConsumer</span><span class="op">(</span><span class="bu">Channel</span> channel<span class="op">)</span> <span class="op">{</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">(</span>channel<span class="op">);</span></span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">channel</span> <span class="op">=</span> channel<span class="op">;</span></span>
<span id="cb383-7"><a href="#cb383-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb383-8"><a href="#cb383-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-9"><a href="#cb383-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleDelivery</span><span class="op">(</span><span class="bu">String</span> consumerTag<span class="op">,</span> Envelope envelope<span class="op">,</span> BasicProperties properties<span class="op">,</span> <span class="dt">byte</span><span class="op">[]</span> body<span class="op">)</span> <span class="cf">throw</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb383-10"><a href="#cb383-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="kw">new</span> <span class="bu">String</span><span class="op">(</span>body<span class="op">));</span></span>
<span id="cb383-11"><a href="#cb383-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-12"><a href="#cb383-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">//手动签收</span></span>
<span id="cb383-13"><a href="#cb383-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">//basicAck(deliveryTag, multiple /*是否批量签收*/)</span></span>
<span id="cb383-14"><a href="#cb383-14" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicAck</span><span class="op">(</span>envelope<span class="op">.</span><span class="fu">getDeliveryTag</span><span class="op">(),</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb383-15"><a href="#cb383-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-16"><a href="#cb383-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">//拒签，一般放到catch中，表示处理失败</span></span>
<span id="cb383-17"><a href="#cb383-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">//basicNack(deliveryTag, multiple, requeue /*是否重新放回消息队列中(尾端)，如果有些代码确实无法成功执行，会导致一直尝试，一般不使用*/)</span></span>
<span id="cb383-18"><a href="#cb383-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">//channel.basicNack(envelope.getDeliveryTag(), false， false);</span></span>
<span id="cb383-19"><a href="#cb383-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb383-20"><a href="#cb383-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb383-21"><a href="#cb383-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-22"><a href="#cb383-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-23"><a href="#cb383-23" aria-hidden="true" tabindex="-1"></a><span class="co">//消费者</span></span>
<span id="cb383-24"><a href="#cb383-24" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb383-25"><a href="#cb383-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb383-26"><a href="#cb383-26" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb383-27"><a href="#cb383-27" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb383-28"><a href="#cb383-28" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb383-29"><a href="#cb383-29" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb383-30"><a href="#cb383-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-31"><a href="#cb383-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb383-32"><a href="#cb383-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb383-33"><a href="#cb383-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-34"><a href="#cb383-34" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">exchangeDeclare</span><span class="op">(</span><span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;topic&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb383-35"><a href="#cb383-35" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb383-36"><a href="#cb383-36" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueBind</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;qos.#&quot;</span><span class="op">);</span></span>
<span id="cb383-37"><a href="#cb383-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-38"><a href="#cb383-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">//开启限流</span></span>
<span id="cb383-39"><a href="#cb383-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">//basicQos(prefetchSize /*消息大小限制(0表示不限制)*/, prefetchCount /*消息数量限制*/, global /*限制对当前channel有效(true)还是对consumer有效(false)*/);</span></span>
<span id="cb383-40"><a href="#cb383-40" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicQos</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb383-41"><a href="#cb383-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-42"><a href="#cb383-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">//第二个参数为是否auto_ack，使用限流要设置为false</span></span>
<span id="cb383-43"><a href="#cb383-43" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicConsume</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">MyConsumer</span><span class="op">(</span>channel<span class="op">));</span></span>
<span id="cb383-44"><a href="#cb383-44" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<h3 id="死信队列">死信队列</h3>
<p>死信队列(DLX，Dead-Letter-Exchange)，当投递到当前queue的消息没有被正确消费时，会自动重新publish到一个被设置为DLX的exchange中（在queue的arguments中添加<code>x-dead-letter-exchange</code>参数，指定投递到当前queue的消息变成死信时重新publish到哪个exchange中）</p>
<p>消息变成死信有如下情况： 1.
消费端调用basicReject或basicNack，且requeue为false 2. 消息TTL过期 3.
队列达到最大长度</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="co">//消费者</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Thread</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Runnable</span><span class="op">(){</span></span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">(){</span></span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a>        ConnectionFactory connectionFactory <span class="op">=</span> <span class="kw">new</span> <span class="fu">ConnectionFactory</span><span class="op">();</span></span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setHost</span><span class="op">(</span><span class="st">&quot;127.0.0.1&quot;</span><span class="op">);</span></span>
<span id="cb384-6"><a href="#cb384-6" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setPort</span><span class="op">(</span><span class="dv">5672</span><span class="op">);</span></span>
<span id="cb384-7"><a href="#cb384-7" aria-hidden="true" tabindex="-1"></a>        connectionFactory<span class="op">.</span><span class="fu">setVirtualHost</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb384-8"><a href="#cb384-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-9"><a href="#cb384-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Connection</span> connection <span class="op">=</span> connectionFactory<span class="op">.</span><span class="fu">newConnection</span><span class="op">();</span></span>
<span id="cb384-10"><a href="#cb384-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Channel</span> channel <span class="op">=</span> connection<span class="op">.</span><span class="fu">createChannel</span><span class="op">();</span></span>
<span id="cb384-11"><a href="#cb384-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-12"><a href="#cb384-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> arguments <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb384-13"><a href="#cb384-13" aria-hidden="true" tabindex="-1"></a>        arguments<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;x-dead-letter-exchange&quot;</span><span class="op">,</span> <span class="st">&quot;dlx.exchange&quot;</span><span class="op">);</span></span>
<span id="cb384-14"><a href="#cb384-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-15"><a href="#cb384-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//声明普通exchange和queue</span></span>
<span id="cb384-16"><a href="#cb384-16" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">exchangeDeclare</span><span class="op">(</span><span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;topic&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb384-17"><a href="#cb384-17" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> arguments<span class="op">);</span></span>
<span id="cb384-18"><a href="#cb384-18" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueBind</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="st">&quot;test_exchange&quot;</span><span class="op">,</span> <span class="st">&quot;dlx.#&quot;</span><span class="op">);</span></span>
<span id="cb384-19"><a href="#cb384-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb384-20"><a href="#cb384-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">//声明用于处理死信的exchange和queue</span></span>
<span id="cb384-21"><a href="#cb384-21" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">exchangeDeclare</span><span class="op">(</span><span class="st">&quot;dlx.exchange&quot;</span><span class="op">,</span> <span class="st">&quot;topic&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb384-22"><a href="#cb384-22" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueDeclare</span><span class="op">(</span><span class="st">&quot;dlx.queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb384-23"><a href="#cb384-23" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">queueBind</span><span class="op">(</span><span class="st">&quot;dlx.queue&quot;</span><span class="op">,</span> <span class="st">&quot;dlx.exchange&quot;</span><span class="op">,</span> <span class="st">&quot;#&quot;</span><span class="op">);</span></span>
<span id="cb384-24"><a href="#cb384-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-25"><a href="#cb384-25" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">.</span><span class="fu">basicConsume</span><span class="op">(</span><span class="st">&quot;test_queue&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">MyConsumer</span><span class="op">(</span>channel<span class="op">));</span></span>
<span id="cb384-26"><a href="#cb384-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb384-27"><a href="#cb384-27" aria-hidden="true" tabindex="-1"></a><span class="op">}).</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<h3 id="集群搭建-2">集群搭建</h3>
<p><strong>RabbitMQ</strong></p>
<p>RabbitMQ配置</p>
<pre class="shell"><code># 停止所有节点（每个节点上都执行）
rabbitmqctl stop_app

# 把cookie复制到其他节点，同步数据，然后把文件权限还原成400（当前节点是192.168.1.71）
/etc/init.d/rabbitmq-server stop
scp /var/lib/rabbitmq/.erlang.cookie 192.168.1.72:/var/lib/rabbitmq/
scp /var/lib/rabbitmq/.erlang.cookie 192.168.1.73:/var/lib/rabbitmq/

# 所有节点用detached方式启动（每个节点上都执行）
rabbitmq-server -detached

# slave加入集群（node72是hostname）
node72: rabbitmqctl stop_app
node72: rabbitmqctl join_cluster rabbit@node71
node72: rabbitmqctl start_app

node73: rabbitmqctl stop_app
node73: rabbitmqctl join_cluster rabbit@node71
node73: rabbitmqctl start_app

# 修改集群名称（默认为第一个node名称），可以在集群中的任意一个节点中修改
#rabbitmqctl set_cluster_name rabbitmq_cluster1
# 删除节点
#rabbitmqctl forget_cluster_node rabbit@node73

# 查看集群状态
rabbitmqctl cluster_status

# 执行镜像策略，使用镜像队列的集群模式，让队列在节点之间复制
rabbitmqctl set_policy ha-all &quot;^&quot; &#39;{&quot;ha_mode&quot;:&quot;all&quot;}&#39;</code></pre>
<p><strong>HAProxy</strong></p>
<p>使用HAProxy做负载均衡</p>
<pre class="shell"><code># 下载haproxy
wget http://www.haproxy.org/download/1.6/src/haproxy-1.6.5.tar.gz

# 解压
tar -zxvf haproxy-1.6.5.tar.gz -C /usr/local

# 进入目录、进行编译、安装
cd /usr/local/haproxy-1.6.5
make TARGET=linux31 PREFIX=/usr/local/haproxy
make install PREFIX=/usr/local/haproxy
mkdir /etc/haproxy

# 赋权
groupadd -r -g 149 haproxy
useradd -g haproxy -r -s /sbin/nologin -u 149 haproxy

# 创建haproxy配置文件
touch /etc/haproxy/haproxy.cfg</code></pre>
<p>haproxy.cfg内容如下</p>
<pre class="properties"><code>#logging options
global
    log 127.0.0.1 local0 info
    maxconn 5120
    chroot /usr/local/haproxy
    uid 99
    gid 99
    daemon
    quiet
    nbproc 20
    pidfile /var/run/haproxy.pid

defaults
    log global
    #使用4层代理模式，”mode http”为7层代理模式
    mode tcp
    #if you set mode to tcp,then you nust change tcplog into httplog
    option tcplog
    option dontlognull
    retries 3
    option redispatch
    maxconn 2000
    contimeout 5s
    ##客户端空闲超时时间为 60秒 则HA发起重连机制
    clitimeout 60s
    ##服务器端链接超时时间为 15秒 则HA发起重连机制
    srvtimeout 15s
#front-end IP for consumers and producters

listen rabbitmq_cluster
    bind 0.0.0.0:5672
    #配置TCP模式
    mode tcp
    #balance url_param userid
    #balance url_param session_id check_post 64
    #balance hdr(User-Agent)
    #balance hdr(host)
    #balance hdr(Host) use_domain_only
    #balance rdp-cookie
    #balance leastconn
    #balance source //ip
    #简单的轮询
    balance roundrobin
    #rabbitmq集群节点配置 #inter 每隔五秒对mq集群做健康检查， 2次正确证明服务器可用，2次失败证明服务器不可用，并且配置主备机制
        server node71 192.168.1.71:5672 check inter 5000 rise 2 fall 2
        server node72 192.168.1.72:5672 check inter 5000 rise 2 fall 2
        server node73 192.168.1.73:5672 check inter 5000 rise 2 fall 2

#配置haproxy web监控，查看统计信息
listen stats
    bind 192.168.1.74:8100
    mode http
    option httplog
    stats enable
    #设置haproxy监控地址为http://localhost:8100/rabbitmq-stats
    stats uri /rabbitmq-stats
    stats refresh 5s</code></pre>
<p>启动HAProxy，然后访问<code>http://192.168.1.74:8100/rabbitmq-stats</code></p>
<pre class="shell"><code>/usr/local/haproxy/sbin/haproxy -f /etc/haproxy/haproxy.cfg

# 查看haproxy进程状态
ps -ef | grep haproxy

# 关闭
#killall haproxy</code></pre>
<p><strong>跨集群通信</strong></p>
<p>要在多个集群之间发送消息，则需要使用federation插件</p>
<ol type="1">
<li><p>启用插件（在所有集群中的所有主机都启用该插件(需下载并放到插件目录)）</p>
<pre class="shell"><code>rabbitmq-plugins enable rabbitmq_federation

# 开启web管理页面支持
rabbitmq-plugins enable rabbitmq_federation_management</code></pre></li>
<li><p>然后在下游RabbitMQ中创建用于跨集群通信的exchange和queue并绑定</p></li>
<li><p>再在下游RabbitMQ的web管理页面的Admin选项卡中创建新的Upstreams（指定上游的RabbitMQ的URL，消息从指定的上游RabbitMQ转发到下游的RabbitMQ）及Policies（匹配策略，Pattern使用正则匹配exchange及queue的名字，Definition设置<code>federation-upstream-set</code>为<code>all</code>）</p></li>
<li><p>这时就可以在上游的RabbitMQ中看到在下游创建的exchange，通过该exchange发送的消息就可以被下游的queue接收</p></li>
<li><p>如果发送的消息想在本地也能接收，只需在该exchange中绑定一个本地的queue即可</p></li>
</ol>
<h2 id="shiro">Shiro</h2>
<p><a href="http://shiro.apache.org/">Apache Shiro</a></p>
<p>Shiro是一个权限管理框架</p>
<p>几个概念</p>
<ul>
<li>Authentication: 认证，比如登录认证，用户名密码匹配则认证成功</li>
<li>Authorization:
授权，比如管理员和普通用户，是不同的角色(Role)，每个角色(Role)的权限(permission)是不一样的</li>
<li>Ralm: 权限检测模块，可以用于认证和授权</li>
</ul>
<h3 id="环境搭建">环境搭建</h3>
<p>创建Spring MVC工程</p>
<pre><code>src/main
├── java
│   └── controller
│       └── User.java
├── resources
│   ├── applicationContext.xml
│   ├── log4j.properties
│   └── shiro.ini
└── webapp
    ├── index.jsp
    └── WEB-INF
        ├── jsp
        │   ├── admin_info.jsp
        │   ├── login.jsp
        │   ├── unauthorized.jsp
        │   └── user_info.jsp
        └── web.xml</code></pre>
<p>Shiro依赖(maven)</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Shiro --&gt;</span></span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;net.sf.ehcache&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;ehcache&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;2.10.6&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  Shiro uses SLF4J for logging. --&gt;</span></span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb391-11"><a href="#cb391-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;slf4j-log4j12&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb391-12"><a href="#cb391-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb391-13"><a href="#cb391-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb391-14"><a href="#cb391-14" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb391-15"><a href="#cb391-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb391-16"><a href="#cb391-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb391-17"><a href="#cb391-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb391-18"><a href="#cb391-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<p>shiro.ini</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="co"># username = password, role1, role2, ..., roleN</span></span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 分为管理员和普通用户</span></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a><span class="kw">[users]</span></span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a><span class="dt">root </span><span class="ot">=</span><span class="st"> root, admin, user</span></span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a><span class="dt">user </span><span class="ot">=</span><span class="st"> 123456, user</span></span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a><span class="co"># roleName = permission1, permission2, ..., permissionN</span></span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 可以使用通配符*，表示匹配零个或多个字符</span></span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a><span class="kw">[roles]</span></span>
<span id="cb392-10"><a href="#cb392-10" aria-hidden="true" tabindex="-1"></a><span class="dt">admin </span><span class="ot">=</span><span class="st"> *</span></span>
<span id="cb392-11"><a href="#cb392-11" aria-hidden="true" tabindex="-1"></a><span class="dt">user </span><span class="ot">=</span><span class="st"> user</span></span></code></pre></div>
<h3 id="代码使用-1">代码使用</h3>
<p>controller中User.java</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/login&quot;</span><span class="op">)</span></span>
<span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">login</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;login&quot;</span><span class="op">;</span></span>
<span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-10"><a href="#cb393-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/dologin&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb393-11"><a href="#cb393-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">doLogin</span><span class="op">(</span><span class="bu">String</span> username<span class="op">,</span> <span class="bu">String</span> password<span class="op">,</span> HttpSession session<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-12"><a href="#cb393-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>username <span class="op">+</span> <span class="st">&quot;--&quot;</span> <span class="op">+</span> password<span class="op">);</span></span>
<span id="cb393-13"><a href="#cb393-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-14"><a href="#cb393-14" aria-hidden="true" tabindex="-1"></a>        Factory factory <span class="op">=</span> <span class="kw">new</span> <span class="fu">IniSecurityManagerFactory</span><span class="op">(</span><span class="st">&quot;classpath:shiro.ini&quot;</span><span class="op">);</span></span>
<span id="cb393-15"><a href="#cb393-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">SecurityManager</span> securityManager <span class="op">=</span> <span class="op">(</span><span class="bu">SecurityManager</span><span class="op">)</span> factory<span class="op">.</span><span class="fu">getInstance</span><span class="op">();</span></span>
<span id="cb393-16"><a href="#cb393-16" aria-hidden="true" tabindex="-1"></a>        SecurityUtils<span class="op">.</span><span class="fu">setSecurityManager</span><span class="op">(</span>securityManager<span class="op">);</span></span>
<span id="cb393-17"><a href="#cb393-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-18"><a href="#cb393-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">//每个用户就是一个subject</span></span>
<span id="cb393-19"><a href="#cb393-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Subject</span> currentUser <span class="op">=</span> SecurityUtils<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb393-20"><a href="#cb393-20" aria-hidden="true" tabindex="-1"></a>        UsernamePasswordToken token <span class="op">=</span> <span class="kw">new</span> <span class="fu">UsernamePasswordToken</span><span class="op">(</span>username<span class="op">,</span> password<span class="op">);</span></span>
<span id="cb393-21"><a href="#cb393-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">//是否记住用户</span></span>
<span id="cb393-22"><a href="#cb393-22" aria-hidden="true" tabindex="-1"></a>        token<span class="op">.</span><span class="fu">setRememberMe</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb393-23"><a href="#cb393-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-24"><a href="#cb393-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb393-25"><a href="#cb393-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">//登录</span></span>
<span id="cb393-26"><a href="#cb393-26" aria-hidden="true" tabindex="-1"></a>            currentUser<span class="op">.</span><span class="fu">login</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb393-27"><a href="#cb393-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-28"><a href="#cb393-28" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果登录成功</span></span>
<span id="cb393-29"><a href="#cb393-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>currentUser<span class="op">.</span><span class="fu">isAuthenticated</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb393-30"><a href="#cb393-30" aria-hidden="true" tabindex="-1"></a>                <span class="co">//有管理员权限</span></span>
<span id="cb393-31"><a href="#cb393-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>currentUser<span class="op">.</span><span class="fu">isPermitted</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb393-32"><a href="#cb393-32" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//shiro的session和servlet的session是不一样的</span></span>
<span id="cb393-33"><a href="#cb393-33" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//currentUser.getSession().setAttribute(&quot;role&quot;, &quot;admin&quot;);</span></span>
<span id="cb393-34"><a href="#cb393-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-35"><a href="#cb393-35" aria-hidden="true" tabindex="-1"></a>                    session<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span><span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb393-36"><a href="#cb393-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="st">&quot;admin_info&quot;</span><span class="op">;</span></span>
<span id="cb393-37"><a href="#cb393-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb393-38"><a href="#cb393-38" aria-hidden="true" tabindex="-1"></a>                <span class="co">//普通用户</span></span>
<span id="cb393-39"><a href="#cb393-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>currentUser<span class="op">.</span><span class="fu">hasRole</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb393-40"><a href="#cb393-40" aria-hidden="true" tabindex="-1"></a>                    session<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span><span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb393-41"><a href="#cb393-41" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="st">&quot;user_info&quot;</span><span class="op">;</span></span>
<span id="cb393-42"><a href="#cb393-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb393-43"><a href="#cb393-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb393-44"><a href="#cb393-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>UnknownAccountException uae<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-45"><a href="#cb393-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;账户不存在&quot;</span><span class="op">);</span></span>
<span id="cb393-46"><a href="#cb393-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>IncorrectCredentialsException ice<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-47"><a href="#cb393-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;密码不正确&quot;</span><span class="op">);</span></span>
<span id="cb393-48"><a href="#cb393-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>LockedAccountException lae<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-49"><a href="#cb393-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;用户被锁定了 &quot;</span><span class="op">);</span></span>
<span id="cb393-50"><a href="#cb393-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">AuthenticationException</span> ae<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-51"><a href="#cb393-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">//无法判断是什么错了</span></span>
<span id="cb393-52"><a href="#cb393-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>ae<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb393-53"><a href="#cb393-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb393-54"><a href="#cb393-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;unauthorized&quot;</span><span class="op">;</span></span>
<span id="cb393-55"><a href="#cb393-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb393-56"><a href="#cb393-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-57"><a href="#cb393-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/userinfo&quot;</span><span class="op">)</span></span>
<span id="cb393-58"><a href="#cb393-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">userInfo</span><span class="op">(</span><span class="at">@SessionAttribute</span><span class="op">(</span>required <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="bu">String</span> role<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-59"><a href="#cb393-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>role <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="op">(</span>role<span class="op">.</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">)</span> <span class="op">||</span> role<span class="op">.</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)))</span></span>
<span id="cb393-60"><a href="#cb393-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;user_info&quot;</span><span class="op">;</span></span>
<span id="cb393-61"><a href="#cb393-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb393-62"><a href="#cb393-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;unauthorized&quot;</span><span class="op">;</span></span>
<span id="cb393-63"><a href="#cb393-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb393-64"><a href="#cb393-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb393-65"><a href="#cb393-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/admininfo&quot;</span><span class="op">)</span></span>
<span id="cb393-66"><a href="#cb393-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">adminInfo</span><span class="op">(</span><span class="at">@SessionAttribute</span><span class="op">(</span>required <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="bu">String</span> role<span class="op">)</span> <span class="op">{</span></span>
<span id="cb393-67"><a href="#cb393-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>role <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> role<span class="op">.</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">))</span></span>
<span id="cb393-68"><a href="#cb393-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;admin_info&quot;</span><span class="op">;</span></span>
<span id="cb393-69"><a href="#cb393-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb393-70"><a href="#cb393-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;unauthorized&quot;</span><span class="op">;</span></span>
<span id="cb393-71"><a href="#cb393-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb393-72"><a href="#cb393-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="与spring-mvc整合">与Spring MVC整合</h3>
<p>目录结构</p>
<pre><code>src/main
├── java
│   ├── controller
│   │   └── User.java
│   └── shiro
│       ├── FilterChainDefinitionMapBuilder.java
│       └── realms
│           ├── FirstRealm.java
│           └── SecondRealm.java
├── main.iml
├── resources
│   ├── applicationContext.xml
│   ├── ehcache.xml
│   └── log4j.properties
└── webapp
    ├── index.jsp
    └── WEB-INF
        ├── jsp
        │   ├── admin_info.jsp
        │   ├── info.jsp
        │   ├── login.jsp
        │   ├── unauthorized.jsp
        │   └── user_info.jsp
        └── web.xml</code></pre>
<h4 id="pom.xml-4">pom.xml</h4>
<p>在maven添加对web、Spring、Ehcache的依赖</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">properties</span>&gt;</span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">shiro-version</span>&gt;1.4.0&lt;/<span class="kw">shiro-version</span>&gt;</span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">properties</span>&gt;</span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependencies</span>&gt;</span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Shiro --&gt;</span></span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.shiro&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;shiro-core&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${shiro-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.shiro&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-14"><a href="#cb395-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;shiro-web&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-15"><a href="#cb395-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${shiro-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-16"><a href="#cb395-16" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-17"><a href="#cb395-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-18"><a href="#cb395-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.shiro&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-19"><a href="#cb395-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;shiro-spring&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-20"><a href="#cb395-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${shiro-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-21"><a href="#cb395-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-22"><a href="#cb395-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-23"><a href="#cb395-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.shiro&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-24"><a href="#cb395-24" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;shiro-ehcache&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-25"><a href="#cb395-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${shiro-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-26"><a href="#cb395-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-27"><a href="#cb395-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-28"><a href="#cb395-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.apache.shiro&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-29"><a href="#cb395-29" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;shiro-cas&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-30"><a href="#cb395-30" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${shiro-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-31"><a href="#cb395-31" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-32"><a href="#cb395-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-33"><a href="#cb395-33" aria-hidden="true" tabindex="-1"></a>     <span class="co">&lt;!--  Shiro uses SLF4J for logging. --&gt;</span></span>
<span id="cb395-34"><a href="#cb395-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-35"><a href="#cb395-35" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-36"><a href="#cb395-36" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;slf4j-log4j12&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-37"><a href="#cb395-37" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-38"><a href="#cb395-38" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-39"><a href="#cb395-39" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-40"><a href="#cb395-40" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-41"><a href="#cb395-41" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-42"><a href="#cb395-42" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-43"><a href="#cb395-43" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-44"><a href="#cb395-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-45"><a href="#cb395-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Ehcache --&gt;</span></span>
<span id="cb395-46"><a href="#cb395-46" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-47"><a href="#cb395-47" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;net.sf.ehcache&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-48"><a href="#cb395-48" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;ehcache&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-49"><a href="#cb395-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;2.10.6&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-50"><a href="#cb395-50" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-51"><a href="#cb395-51" aria-hidden="true" tabindex="-1"></a>     <span class="co">&lt;!--不加这个org.springframework.cache.ehcache.EhCacheManagerFactoryBean找不到--&gt;</span></span>
<span id="cb395-52"><a href="#cb395-52" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb395-53"><a href="#cb395-53" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">groupId</span>&gt;org.springframework&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb395-54"><a href="#cb395-54" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">artifactId</span>&gt;spring-context-support&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb395-55"><a href="#cb395-55" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">version</span>&gt;${spring-version}&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb395-56"><a href="#cb395-56" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb395-57"><a href="#cb395-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-58"><a href="#cb395-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--  Spring(省略) ---&gt;</span></span>
<span id="cb395-59"><a href="#cb395-59" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependencies</span>&gt;</span></code></pre></div>
<h4 id="ehcache.xml">ehcache.xml</h4>
<div class="sourceCode" id="cb396"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">ehcache</span>&gt;</span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 缓存路径</span></span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="co">     使用java.io.tmpdir是获取系统的/tmp目录，此时需要su权限，如果没有权限会报错</span></span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a><span class="co">     使用user.home是当前用户的home目录，不需要su权限</span></span>
<span id="cb396-5"><a href="#cb396-5" aria-hidden="true" tabindex="-1"></a><span class="co">     --&gt;</span></span>
<span id="cb396-6"><a href="#cb396-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">diskStore</span><span class="ot"> path=</span><span class="st">&quot;user.home&quot;</span>/&gt;</span>
<span id="cb396-7"><a href="#cb396-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 默认缓存区 --&gt;</span></span>
<span id="cb396-8"><a href="#cb396-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">defaultCache</span></span>
<span id="cb396-9"><a href="#cb396-9" aria-hidden="true" tabindex="-1"></a><span class="ot">            maxElementsInMemory=</span><span class="st">&quot;10000&quot;</span></span>
<span id="cb396-10"><a href="#cb396-10" aria-hidden="true" tabindex="-1"></a><span class="ot">            eternal=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb396-11"><a href="#cb396-11" aria-hidden="true" tabindex="-1"></a><span class="ot">            timeToIdleSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-12"><a href="#cb396-12" aria-hidden="true" tabindex="-1"></a><span class="ot">            timeToLiveSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-13"><a href="#cb396-13" aria-hidden="true" tabindex="-1"></a><span class="ot">            maxElementsOnDisk=</span><span class="st">&quot;10000000&quot;</span></span>
<span id="cb396-14"><a href="#cb396-14" aria-hidden="true" tabindex="-1"></a><span class="ot">            diskExpiryThreadIntervalSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-15"><a href="#cb396-15" aria-hidden="true" tabindex="-1"></a><span class="ot">            memoryStoreEvictionPolicy=</span><span class="st">&quot;LRU&quot;</span>&gt;</span>
<span id="cb396-16"><a href="#cb396-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--</span></span>
<span id="cb396-17"><a href="#cb396-17" aria-hidden="true" tabindex="-1"></a><span class="co">             localTempSwap: 当堆内存或者非堆内存里面的元素已经满了的时候，将其中的元素临时的存放在磁盘上，一旦重启就会消失</span></span>
<span id="cb396-18"><a href="#cb396-18" aria-hidden="true" tabindex="-1"></a><span class="co">             localRestartable: 该策略只对企业版Ehcache有用。它可以在重启的时候将堆内存或者非堆内存里面的元素持久化到硬盘上，重启之后再从硬盘上恢复元素到内存中</span></span>
<span id="cb396-19"><a href="#cb396-19" aria-hidden="true" tabindex="-1"></a><span class="co">             none: 不持久化缓存的元素</span></span>
<span id="cb396-20"><a href="#cb396-20" aria-hidden="true" tabindex="-1"></a><span class="co">             distributed: 该策略不适用于单机，是用于分布式的</span></span>
<span id="cb396-21"><a href="#cb396-21" aria-hidden="true" tabindex="-1"></a><span class="co">         --&gt;</span></span>
<span id="cb396-22"><a href="#cb396-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">persistence</span><span class="ot"> strategy=</span><span class="st">&quot;localTempSwap&quot;</span>/&gt;</span>
<span id="cb396-23"><a href="#cb396-23" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">defaultCache</span>&gt;</span>
<span id="cb396-24"><a href="#cb396-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 自定义缓存区 --&gt;</span></span>
<span id="cb396-25"><a href="#cb396-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">cache</span><span class="ot"> name=</span><span class="st">&quot;bos&quot;</span></span>
<span id="cb396-26"><a href="#cb396-26" aria-hidden="true" tabindex="-1"></a><span class="ot">           maxElementsInMemory=</span><span class="st">&quot;10000&quot;</span></span>
<span id="cb396-27"><a href="#cb396-27" aria-hidden="true" tabindex="-1"></a><span class="ot">           eternal=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb396-28"><a href="#cb396-28" aria-hidden="true" tabindex="-1"></a><span class="ot">           timeToIdleSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-29"><a href="#cb396-29" aria-hidden="true" tabindex="-1"></a><span class="ot">           timeToLiveSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-30"><a href="#cb396-30" aria-hidden="true" tabindex="-1"></a><span class="ot">           maxElementsOnDisk=</span><span class="st">&quot;10000000&quot;</span></span>
<span id="cb396-31"><a href="#cb396-31" aria-hidden="true" tabindex="-1"></a><span class="ot">           diskExpiryThreadIntervalSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-32"><a href="#cb396-32" aria-hidden="true" tabindex="-1"></a><span class="ot">           memoryStoreEvictionPolicy=</span><span class="st">&quot;LRU&quot;</span>&gt;</span>
<span id="cb396-33"><a href="#cb396-33" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">persistence</span><span class="ot"> strategy=</span><span class="st">&quot;localTempSwap&quot;</span>/&gt;</span>
<span id="cb396-34"><a href="#cb396-34" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">cache</span>&gt;</span>
<span id="cb396-35"><a href="#cb396-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 自定义缓存区 --&gt;</span></span>
<span id="cb396-36"><a href="#cb396-36" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">cache</span><span class="ot"> name=</span><span class="st">&quot;standard&quot;</span></span>
<span id="cb396-37"><a href="#cb396-37" aria-hidden="true" tabindex="-1"></a><span class="ot">           maxElementsInMemory=</span><span class="st">&quot;10000&quot;</span></span>
<span id="cb396-38"><a href="#cb396-38" aria-hidden="true" tabindex="-1"></a><span class="ot">           eternal=</span><span class="st">&quot;false&quot;</span></span>
<span id="cb396-39"><a href="#cb396-39" aria-hidden="true" tabindex="-1"></a><span class="ot">           timeToIdleSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-40"><a href="#cb396-40" aria-hidden="true" tabindex="-1"></a><span class="ot">           timeToLiveSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-41"><a href="#cb396-41" aria-hidden="true" tabindex="-1"></a><span class="ot">           maxElementsOnDisk=</span><span class="st">&quot;10000000&quot;</span></span>
<span id="cb396-42"><a href="#cb396-42" aria-hidden="true" tabindex="-1"></a><span class="ot">           diskExpiryThreadIntervalSeconds=</span><span class="st">&quot;120&quot;</span></span>
<span id="cb396-43"><a href="#cb396-43" aria-hidden="true" tabindex="-1"></a><span class="ot">           memoryStoreEvictionPolicy=</span><span class="st">&quot;LRU&quot;</span>&gt;</span>
<span id="cb396-44"><a href="#cb396-44" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">persistence</span><span class="ot"> strategy=</span><span class="st">&quot;localTempSwap&quot;</span>/&gt;</span>
<span id="cb396-45"><a href="#cb396-45" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">cache</span>&gt;</span>
<span id="cb396-46"><a href="#cb396-46" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">ehcache</span>&gt;</span></code></pre></div>
<h4 id="log4j.properties">log4j.properties</h4>
<div class="sourceCode" id="cb397"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.rootLogger</span><span class="ot">=</span><span class="st">INFO, stdout, </span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout</span><span class="ot">=</span><span class="st">org.apache.log4j.ConsoleAppender</span></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout.layout</span><span class="ot">=</span><span class="st">org.apache.log4j.PatternLayout</span></span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.appender.stdout.layout.ConversionPattern</span><span class="ot">=</span><span class="st">%d %p [%c] - %m %n</span></span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a><span class="co"># General Apache libraries</span></span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.apache</span><span class="ot">=</span><span class="st">WARN</span></span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Spring</span></span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.springframework</span><span class="ot">=</span><span class="st">WARN</span></span>
<span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Default Shiro logging</span></span>
<span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.apache.shiro</span><span class="ot">=</span><span class="st">TRACE</span></span>
<span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Disable verbose logging</span></span>
<span id="cb397-17"><a href="#cb397-17" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.apache.shiro.util.ThreadContext</span><span class="ot">=</span><span class="st">WARN</span></span>
<span id="cb397-18"><a href="#cb397-18" aria-hidden="true" tabindex="-1"></a><span class="dt">log4j.logger.org.apache.shiro.cache.ehcache.EhCache</span><span class="ot">=</span><span class="st">WARN</span></span></code></pre></div>
<h4 id="web.xml">web.xml</h4>
<p>在web.xml中加入Shiro的过滤器</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb398-1"><a href="#cb398-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter</span>&gt;</span>
<span id="cb398-2"><a href="#cb398-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;shiroFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb398-3"><a href="#cb398-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-class</span>&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/<span class="kw">filter-class</span>&gt;</span>
<span id="cb398-4"><a href="#cb398-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">init-param</span>&gt;</span>
<span id="cb398-5"><a href="#cb398-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-name</span>&gt;targetFilterLifecycle&lt;/<span class="kw">param-name</span>&gt;</span>
<span id="cb398-6"><a href="#cb398-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">param-value</span>&gt;true&lt;/<span class="kw">param-value</span>&gt;</span>
<span id="cb398-7"><a href="#cb398-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">init-param</span>&gt;</span>
<span id="cb398-8"><a href="#cb398-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter</span>&gt;</span>
<span id="cb398-9"><a href="#cb398-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb398-10"><a href="#cb398-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">filter-mapping</span>&gt;</span>
<span id="cb398-11"><a href="#cb398-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">filter-name</span>&gt;shiroFilter&lt;/<span class="kw">filter-name</span>&gt;</span>
<span id="cb398-12"><a href="#cb398-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">url-pattern</span>&gt;/*&lt;/<span class="kw">url-pattern</span>&gt;</span>
<span id="cb398-13"><a href="#cb398-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;REQUEST&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb398-14"><a href="#cb398-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;FORWARD&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb398-15"><a href="#cb398-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;INCLUDE&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb398-16"><a href="#cb398-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dispatcher</span>&gt;ERROR&lt;/<span class="kw">dispatcher</span>&gt;</span>
<span id="cb398-17"><a href="#cb398-17" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">filter-mapping</span>&gt;</span></code></pre></div>
<h4 id="applicationcontext.xml-1">applicationContext.xml</h4>
<p>在Spring配置文件中配置Shiro（主要配置ShiroFilter、SecurityManager和Realm，CacheManager和SessionManager都是可选的）</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb399-1"><a href="#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb399-2"><a href="#cb399-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">beans</span><span class="ot"> xmlns=</span><span class="st">&quot;http://www.springframework.org/schema/beans&quot;</span></span>
<span id="cb399-3"><a href="#cb399-3" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:xsi=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span id="cb399-4"><a href="#cb399-4" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:context=</span><span class="st">&quot;http://www.springframework.org/schema/context&quot;</span></span>
<span id="cb399-5"><a href="#cb399-5" aria-hidden="true" tabindex="-1"></a><span class="ot">       xmlns:mvc=</span><span class="st">&quot;http://www.springframework.org/schema/mvc&quot;</span></span>
<span id="cb399-6"><a href="#cb399-6" aria-hidden="true" tabindex="-1"></a><span class="ot">       xsi:schemaLocation=</span><span class="st">&quot;http://www.springframework.org/schema/beans</span></span>
<span id="cb399-7"><a href="#cb399-7" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</span></span>
<span id="cb399-8"><a href="#cb399-8" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context</span></span>
<span id="cb399-9"><a href="#cb399-9" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/context/spring-context.xsd</span></span>
<span id="cb399-10"><a href="#cb399-10" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/mvc</span></span>
<span id="cb399-11"><a href="#cb399-11" aria-hidden="true" tabindex="-1"></a><span class="st">                           http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;</span>&gt;</span>
<span id="cb399-12"><a href="#cb399-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-13"><a href="#cb399-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">context:component-scan</span><span class="ot"> base-package=</span><span class="st">&quot;controller&quot;</span>/&gt;</span>
<span id="cb399-14"><a href="#cb399-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-15"><a href="#cb399-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:annotation-driven</span>/&gt;</span>
<span id="cb399-16"><a href="#cb399-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">mvc:default-servlet-handler</span>/&gt;</span>
<span id="cb399-17"><a href="#cb399-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-18"><a href="#cb399-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span>
<span id="cb399-19"><a href="#cb399-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;prefix&quot;</span><span class="ot"> value=</span><span class="st">&quot;/WEB-INF/jsp/&quot;</span>/&gt;</span>
<span id="cb399-20"><a href="#cb399-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;suffix&quot;</span><span class="ot"> value=</span><span class="st">&quot;.jsp&quot;</span>/&gt;</span>
<span id="cb399-21"><a href="#cb399-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-22"><a href="#cb399-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-23"><a href="#cb399-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-24"><a href="#cb399-24" aria-hidden="true" tabindex="-1"></a><span class="co">    1. 配置 SecurityManager</span></span>
<span id="cb399-25"><a href="#cb399-25" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-26"><a href="#cb399-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;securityManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.web.mgt.DefaultWebSecurityManager&quot;</span>&gt;</span>
<span id="cb399-27"><a href="#cb399-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 认证器，可以配置Realm和认证策略 --&gt;</span></span>
<span id="cb399-28"><a href="#cb399-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;authenticator&quot;</span><span class="ot"> ref=</span><span class="st">&quot;authenticator&quot;</span>/&gt;</span>
<span id="cb399-29"><a href="#cb399-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 单个Realm的配置</span></span>
<span id="cb399-30"><a href="#cb399-30" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;realm&quot; ref=&quot;firstRealm&quot;/&gt;</span></span>
<span id="cb399-31"><a href="#cb399-31" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb399-32"><a href="#cb399-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 多个Realm的配置 --&gt;</span></span>
<span id="cb399-33"><a href="#cb399-33" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;realms&quot;</span>&gt;</span>
<span id="cb399-34"><a href="#cb399-34" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">list</span>&gt;</span>
<span id="cb399-35"><a href="#cb399-35" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">ref</span><span class="ot"> bean=</span><span class="st">&quot;firstRealm&quot;</span>/&gt;</span>
<span id="cb399-36"><a href="#cb399-36" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">ref</span><span class="ot"> bean=</span><span class="st">&quot;secondRealm&quot;</span>/&gt;</span>
<span id="cb399-37"><a href="#cb399-37" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">list</span>&gt;</span>
<span id="cb399-38"><a href="#cb399-38" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb399-39"><a href="#cb399-39" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sessionManager&quot;</span><span class="ot"> ref=</span><span class="st">&quot;sessionManager&quot;</span>/&gt;</span>
<span id="cb399-40"><a href="#cb399-40" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;cacheManager&quot;</span><span class="ot"> ref=</span><span class="st">&quot;shiroCacheManager&quot;</span>/&gt;</span>
<span id="cb399-41"><a href="#cb399-41" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-42"><a href="#cb399-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-43"><a href="#cb399-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-44"><a href="#cb399-44" aria-hidden="true" tabindex="-1"></a><span class="co">    2. 配置 Realm</span></span>
<span id="cb399-45"><a href="#cb399-45" aria-hidden="true" tabindex="-1"></a><span class="co">       直接配置实现了 org.apache.shiro.realm.Realm 接口的 bean</span></span>
<span id="cb399-46"><a href="#cb399-46" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-47"><a href="#cb399-47" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;firstRealm&quot;</span><span class="ot"> class=</span><span class="st">&quot;shiro.realms.FirstRealm&quot;</span>&gt;</span>
<span id="cb399-48"><a href="#cb399-48" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;credentialsMatcher&quot;</span>&gt;</span>
<span id="cb399-49"><a href="#cb399-49" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.authc.credential.HashedCredentialsMatcher&quot;</span>&gt;</span>
<span id="cb399-50"><a href="#cb399-50" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashAlgorithmName&quot;</span><span class="ot"> value=</span><span class="st">&quot;MD5&quot;</span>/&gt;</span>
<span id="cb399-51"><a href="#cb399-51" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashIterations&quot;</span><span class="ot"> value=</span><span class="st">&quot;1024&quot;</span>/&gt;</span>
<span id="cb399-52"><a href="#cb399-52" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-53"><a href="#cb399-53" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb399-54"><a href="#cb399-54" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-55"><a href="#cb399-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-56"><a href="#cb399-56" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;secondRealm&quot;</span><span class="ot"> class=</span><span class="st">&quot;shiro.realms.SecondRealm&quot;</span>&gt;</span>
<span id="cb399-57"><a href="#cb399-57" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;credentialsMatcher&quot;</span>&gt;</span>
<span id="cb399-58"><a href="#cb399-58" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.authc.credential.HashedCredentialsMatcher&quot;</span>&gt;</span>
<span id="cb399-59"><a href="#cb399-59" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashAlgorithmName&quot;</span><span class="ot"> value=</span><span class="st">&quot;SHA1&quot;</span>/&gt;</span>
<span id="cb399-60"><a href="#cb399-60" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;hashIterations&quot;</span><span class="ot"> value=</span><span class="st">&quot;1024&quot;</span>/&gt;</span>
<span id="cb399-61"><a href="#cb399-61" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-62"><a href="#cb399-62" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb399-63"><a href="#cb399-63" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-64"><a href="#cb399-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-65"><a href="#cb399-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 认证器，配置自定义的Realm及认证策略，自定义的Realm也可以在securityManager中直接配置 --&gt;</span></span>
<span id="cb399-66"><a href="#cb399-66" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;authenticator&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.authc.pam.ModularRealmAuthenticator&quot;</span>&gt;</span>
<span id="cb399-67"><a href="#cb399-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 认证策略，如果有多个Realm，可以设置为只要一个Realm通过就认为通过认证，或者必须所有Realm都通过才认为通过认证 --&gt;</span></span>
<span id="cb399-68"><a href="#cb399-68" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;authenticationStrategy&quot;</span>&gt;</span>
<span id="cb399-69"><a href="#cb399-69" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.authc.pam.AtLeastOneSuccessfulStrategy&quot;</span>/&gt;</span>
<span id="cb399-70"><a href="#cb399-70" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">property</span>&gt;</span>
<span id="cb399-71"><a href="#cb399-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 多个Realm也可以在这里配置</span></span>
<span id="cb399-72"><a href="#cb399-72" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;realms&quot;&gt;</span></span>
<span id="cb399-73"><a href="#cb399-73" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;list&gt;</span></span>
<span id="cb399-74"><a href="#cb399-74" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;ref bean=&quot;firstRealm&quot;/&gt;</span></span>
<span id="cb399-75"><a href="#cb399-75" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;ref bean=&quot;secondRealm&quot;/&gt;</span></span>
<span id="cb399-76"><a href="#cb399-76" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;/list&gt;</span></span>
<span id="cb399-77"><a href="#cb399-77" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/property&gt;</span></span>
<span id="cb399-78"><a href="#cb399-78" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb399-79"><a href="#cb399-79" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-80"><a href="#cb399-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-81"><a href="#cb399-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-82"><a href="#cb399-82" aria-hidden="true" tabindex="-1"></a><span class="co">     3. sessionManager</span></span>
<span id="cb399-83"><a href="#cb399-83" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-84"><a href="#cb399-84" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;sessionManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.web.session.mgt.DefaultWebSessionManager&quot;</span>&gt;</span>
<span id="cb399-85"><a href="#cb399-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 设置session的失效扫描间隔，单位为毫秒 --&gt;</span></span>
<span id="cb399-86"><a href="#cb399-86" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sessionValidationInterval&quot;</span><span class="ot"> value=</span><span class="st">&quot;100000&quot;</span>/&gt;</span>
<span id="cb399-87"><a href="#cb399-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 设置全局会话超时时间，默认30分钟，即如果30分钟内没有访问会话将过期 1800000 --&gt;</span></span>
<span id="cb399-88"><a href="#cb399-88" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;globalSessionTimeout&quot;</span><span class="ot"> value=</span><span class="st">&quot;1800000&quot;</span>/&gt;</span>
<span id="cb399-89"><a href="#cb399-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 删除失效的session --&gt;</span></span>
<span id="cb399-90"><a href="#cb399-90" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;deleteInvalidSessions&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb399-91"><a href="#cb399-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 是否开启会话验证器，默认是开启的 --&gt;</span></span>
<span id="cb399-92"><a href="#cb399-92" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sessionValidationSchedulerEnabled&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb399-93"><a href="#cb399-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- session还支持持久化，可以实现SessionDAO来把session保存到数据库或文件</span></span>
<span id="cb399-94"><a href="#cb399-94" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;sessionDAO&quot; ref=&quot;&quot;/&gt; --&gt;</span></span>
<span id="cb399-95"><a href="#cb399-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-96"><a href="#cb399-96" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sessionIdCookie&quot;</span><span class="ot"> ref=</span><span class="st">&quot;sessionIdCookie&quot;</span>/&gt;</span>
<span id="cb399-97"><a href="#cb399-97" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sessionIdCookieEnabled&quot;</span><span class="ot"> value=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb399-98"><a href="#cb399-98" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-99"><a href="#cb399-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-100"><a href="#cb399-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Shiro的session是独立于servlet的session的</span></span>
<span id="cb399-101"><a href="#cb399-101" aria-hidden="true" tabindex="-1"></a><span class="co">         如果设置了把Shiro的session保存在cookie中，默认的名字是JSESSIONID，会和servlet的session冲突，需要另起名字 --&gt;</span></span>
<span id="cb399-102"><a href="#cb399-102" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;sessionIdCookie&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.web.servlet.SimpleCookie&quot;</span>&gt;</span>
<span id="cb399-103"><a href="#cb399-103" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">constructor-arg</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span><span class="ot"> value=</span><span class="st">&quot;shiroSession&quot;</span>/&gt;</span>
<span id="cb399-104"><a href="#cb399-104" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-105"><a href="#cb399-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-106"><a href="#cb399-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-107"><a href="#cb399-107" aria-hidden="true" tabindex="-1"></a><span class="co">    4. 配置 CacheManager.</span></span>
<span id="cb399-108"><a href="#cb399-108" aria-hidden="true" tabindex="-1"></a><span class="co">       使用Ehcache需要加入Ehcache的jar包及配置文件.</span></span>
<span id="cb399-109"><a href="#cb399-109" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-110"><a href="#cb399-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-111"><a href="#cb399-111" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;bean id=&quot;ehCacheManager&quot; class=&quot;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&quot;&gt;</span></span>
<span id="cb399-112"><a href="#cb399-112" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;property name=&quot;configLocation&quot; value=&quot;classpath:ehcache.xml&quot;/&gt;</span></span>
<span id="cb399-113"><a href="#cb399-113" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/bean&gt;</span></span>
<span id="cb399-114"><a href="#cb399-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-115"><a href="#cb399-115" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;bean id=&quot;shiroCacheManager&quot; class=&quot;org.apache.shiro.cache.ehcache.EhCacheManager&quot;&gt;</span></span>
<span id="cb399-116"><a href="#cb399-116" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;property name=&quot;cacheManager&quot; ref=&quot;ehCacheManager&quot;/&gt;</span></span>
<span id="cb399-117"><a href="#cb399-117" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/bean&gt;</span></span>
<span id="cb399-118"><a href="#cb399-118" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-119"><a href="#cb399-119" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;shiroCacheManager&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.cache.ehcache.EhCacheManager&quot;</span>&gt;</span>
<span id="cb399-120"><a href="#cb399-120" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;cacheManagerConfigFile&quot;</span><span class="ot"> value=</span><span class="st">&quot;classpath:ehcache.xml&quot;</span>/&gt;</span>
<span id="cb399-121"><a href="#cb399-121" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-122"><a href="#cb399-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-123"><a href="#cb399-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 如果需要使用注解，则配置5、6 --&gt;</span></span>
<span id="cb399-124"><a href="#cb399-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-125"><a href="#cb399-125" aria-hidden="true" tabindex="-1"></a><span class="co">    5. 配置 LifecycleBeanPostProcessor. 可以自定的来调用配置在 Spring IOC 容器中 shiro bean 的生命周期方法.</span></span>
<span id="cb399-126"><a href="#cb399-126" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-127"><a href="#cb399-127" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;lifecycleBeanPostProcessor&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.spring.LifecycleBeanPostProcessor&quot;</span>/&gt;</span>
<span id="cb399-128"><a href="#cb399-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-129"><a href="#cb399-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-130"><a href="#cb399-130" aria-hidden="true" tabindex="-1"></a><span class="co">    6. 启用 IOC 容器中使用 shiro 的注解. 但必须在配置了 LifecycleBeanPostProcessor 之后才可以使用.</span></span>
<span id="cb399-131"><a href="#cb399-131" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-132"><a href="#cb399-132" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator&quot;</span></span>
<span id="cb399-133"><a href="#cb399-133" aria-hidden="true" tabindex="-1"></a><span class="ot">          depends-on=</span><span class="st">&quot;lifecycleBeanPostProcessor&quot;</span>/&gt;</span>
<span id="cb399-134"><a href="#cb399-134" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor&quot;</span>&gt;</span>
<span id="cb399-135"><a href="#cb399-135" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;securityManager&quot;</span><span class="ot"> ref=</span><span class="st">&quot;securityManager&quot;</span>/&gt;</span>
<span id="cb399-136"><a href="#cb399-136" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-137"><a href="#cb399-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-138"><a href="#cb399-138" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb399-139"><a href="#cb399-139" aria-hidden="true" tabindex="-1"></a><span class="co">    7. 配置 ShiroFilter.</span></span>
<span id="cb399-140"><a href="#cb399-140" aria-hidden="true" tabindex="-1"></a><span class="co">       id 必须和 web.xml 文件中配置的 DelegatingFilterProxy 的 &lt;filter-name&gt; 一致.</span></span>
<span id="cb399-141"><a href="#cb399-141" aria-hidden="true" tabindex="-1"></a><span class="co">    若不一致, 则会抛出: NoSuchBeanDefinitionException. 因为 Shiro 会来 IOC 容器中查找和 &lt;filter-name&gt; 名字对应的 filter bean.</span></span>
<span id="cb399-142"><a href="#cb399-142" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb399-143"><a href="#cb399-143" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;shiroFilter&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.apache.shiro.spring.web.ShiroFilterFactoryBean&quot;</span>&gt;</span>
<span id="cb399-144"><a href="#cb399-144" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;securityManager&quot;</span><span class="ot"> ref=</span><span class="st">&quot;securityManager&quot;</span>/&gt;</span>
<span id="cb399-145"><a href="#cb399-145" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;loginUrl&quot;</span><span class="ot"> value=</span><span class="st">&quot;/user/login&quot;</span>/&gt;</span>
<span id="cb399-146"><a href="#cb399-146" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;successUrl&quot;</span><span class="ot"> value=</span><span class="st">&quot;/user/info&quot;</span>/&gt;</span>
<span id="cb399-147"><a href="#cb399-147" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;unauthorizedUrl&quot;</span><span class="ot"> value=</span><span class="st">&quot;/user/unauthorized&quot;</span>/&gt;</span>
<span id="cb399-148"><a href="#cb399-148" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 通过xml配置各路径所需的权限</span></span>
<span id="cb399-149"><a href="#cb399-149" aria-hidden="true" tabindex="-1"></a><span class="co">            配置哪些页面需要受保护，以及访问这些页面需要的权限.</span></span>
<span id="cb399-150"><a href="#cb399-150" aria-hidden="true" tabindex="-1"></a><span class="co">            Shiro会按顺序搜索页面及对应的权限，前面的会覆盖后面的。所以全通配 /** 必须放在最后</span></span>
<span id="cb399-151"><a href="#cb399-151" aria-hidden="true" tabindex="-1"></a><span class="co">            1). anon 可以被匿名访问</span></span>
<span id="cb399-152"><a href="#cb399-152" aria-hidden="true" tabindex="-1"></a><span class="co">            2). authc 必须认证(即登录)后才可能访问的页面.</span></span>
<span id="cb399-153"><a href="#cb399-153" aria-hidden="true" tabindex="-1"></a><span class="co">            3). logout 登出.</span></span>
<span id="cb399-154"><a href="#cb399-154" aria-hidden="true" tabindex="-1"></a><span class="co">            4). roles 角色过滤器</span></span>
<span id="cb399-155"><a href="#cb399-155" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;filterChainDefinitions&quot;&gt;</span></span>
<span id="cb399-156"><a href="#cb399-156" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;value&gt;</span></span>
<span id="cb399-157"><a href="#cb399-157" aria-hidden="true" tabindex="-1"></a><span class="co">                / = anon</span></span>
<span id="cb399-158"><a href="#cb399-158" aria-hidden="true" tabindex="-1"></a><span class="co">                index.jsp = anon</span></span>
<span id="cb399-159"><a href="#cb399-159" aria-hidden="true" tabindex="-1"></a><span class="co">                /user/login = anon</span></span>
<span id="cb399-160"><a href="#cb399-160" aria-hidden="true" tabindex="-1"></a><span class="co">                /user/dologin = anon</span></span>
<span id="cb399-161"><a href="#cb399-161" aria-hidden="true" tabindex="-1"></a><span class="co">                /user/logout = logout</span></span>
<span id="cb399-162"><a href="#cb399-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-163"><a href="#cb399-163" aria-hidden="true" tabindex="-1"></a><span class="co">                /user/userinfo = roles[user]</span></span>
<span id="cb399-164"><a href="#cb399-164" aria-hidden="true" tabindex="-1"></a><span class="co">                /user/admininfo = roles[admin]</span></span>
<span id="cb399-165"><a href="#cb399-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-166"><a href="#cb399-166" aria-hidden="true" tabindex="-1"></a><span class="co">                /** = authc</span></span>
<span id="cb399-167"><a href="#cb399-167" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;/value&gt;</span></span>
<span id="cb399-168"><a href="#cb399-168" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/property&gt;</span></span>
<span id="cb399-169"><a href="#cb399-169" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb399-170"><a href="#cb399-170" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 也可以通过代码查询数据库，获取各路径对应的权限 --&gt;</span></span>
<span id="cb399-171"><a href="#cb399-171" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;filterChainDefinitionMap&quot;</span><span class="ot"> ref=</span><span class="st">&quot;filterChainDefinitionMap&quot;</span>/&gt;</span>
<span id="cb399-172"><a href="#cb399-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-173"><a href="#cb399-173" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">bean</span>&gt;</span>
<span id="cb399-174"><a href="#cb399-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-175"><a href="#cb399-175" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 生成各个路径对应权限的Builder，其实就是生成一个LinkedHashMap&lt;String, String&gt; --&gt;</span></span>
<span id="cb399-176"><a href="#cb399-176" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bean</span><span class="ot"> id=</span><span class="st">&quot;filterChainDefinitionMap&quot;</span><span class="ot"> class=</span><span class="st">&quot;shiro.FilterChainDefinitionMapBuilder&quot;</span><span class="ot"> factory-method=</span><span class="st">&quot;build&quot;</span>/&gt;</span>
<span id="cb399-177"><a href="#cb399-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb399-178"><a href="#cb399-178" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">beans</span>&gt;</span></code></pre></div>
<p>FilterChainDefinitionMapBuilder.java</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> FilterChainDefinitionMapBuilder <span class="op">{</span></span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> <span class="fu">build</span><span class="op">(){</span></span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">LinkedHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb400-4"><a href="#cb400-4" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="st">&quot;anon&quot;</span><span class="op">);</span></span>
<span id="cb400-5"><a href="#cb400-5" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/index.jsp&quot;</span><span class="op">,</span> <span class="st">&quot;anon&quot;</span><span class="op">);</span></span>
<span id="cb400-6"><a href="#cb400-6" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/user/login&quot;</span><span class="op">,</span> <span class="st">&quot;anon&quot;</span><span class="op">);</span></span>
<span id="cb400-7"><a href="#cb400-7" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/user/dologin&quot;</span><span class="op">,</span> <span class="st">&quot;anon&quot;</span><span class="op">);</span></span>
<span id="cb400-8"><a href="#cb400-8" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/user/logout&quot;</span><span class="op">,</span> <span class="st">&quot;logout&quot;</span><span class="op">);</span></span>
<span id="cb400-9"><a href="#cb400-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-10"><a href="#cb400-10" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/user/userinfo&quot;</span><span class="op">,</span> <span class="st">&quot;authc,roles[user]&quot;</span><span class="op">);</span></span>
<span id="cb400-11"><a href="#cb400-11" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/user/admininfo&quot;</span><span class="op">,</span> <span class="st">&quot;authc,roles[admin]&quot;</span><span class="op">);</span></span>
<span id="cb400-12"><a href="#cb400-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-13"><a href="#cb400-13" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/**&quot;</span><span class="op">,</span> <span class="st">&quot;authc&quot;</span><span class="op">);</span></span>
<span id="cb400-14"><a href="#cb400-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> map<span class="op">;</span></span>
<span id="cb400-15"><a href="#cb400-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb400-16"><a href="#cb400-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="jsp-1">JSP</h4>
<p>在jsp中使用Shiro的标签来为不同用户显示不同内容</p>
<ul>
<li><code>&lt;shiro:authenticated&gt;</code>: 登录之后</li>
<li><code>&lt;shiro:notAuthenticated&gt;</code>: 不在登录状态时</li>
<li><code>&lt;shiro:guest&gt;</code>: 用户在没有RememberMe时</li>
<li><code>&lt;shiro:user&gt;</code>: 用户在RememberMe时</li>
<li><code>&lt;shiro:hasAnyRoles name=&quot;admin,user&quot;&gt;</code>:
在有admin或者user角色时</li>
<li><code>&lt;shiro:hasRole name=&quot;user&quot;&gt;</code>: 拥有角色user</li>
<li><code>&lt;shiro:lacksRole name=&quot;admin&quot;&gt;</code>:
没有角色admin</li>
<li><code>&lt;shiro:hasPermission name=&quot;admin&quot;&gt;</code>:
拥有权限admin</li>
<li><code>&lt;shiro:lacksPermission name=&quot;admin&quot;&gt;</code>:
没有admin权限</li>
<li><code>&lt;shiro:principal&gt;</code>: 显示用户身份名称</li>
<li><code>&lt;shiro:principal property=&quot;username&quot;/&gt;</code>:
显示用户身份中的属性值</li>
</ul>
<p>info.jsp</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb401-1"><a href="#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> language</span>=<span class="st">&quot;java&quot;</span><span class="ot"> contentType</span>=<span class="st">&quot;text/html; charset=ISO-8859-1&quot;</span></span>
<span id="cb401-2"><a href="#cb401-2" aria-hidden="true" tabindex="-1"></a><span class="ot">         pageEncoding</span>=<span class="st">&quot;ISO-8859-1&quot;</span><span class="bu">%&gt;</span></span>
<span id="cb401-3"><a href="#cb401-3" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ taglib</span><span class="ot"> prefix</span>=<span class="st">&quot;shiro&quot;</span><span class="ot"> uri</span>=<span class="st">&quot;http://shiro.apache.org/tags&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb401-4"><a href="#cb401-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-5"><a href="#cb401-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="ot">!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span>
<span id="cb401-6"><a href="#cb401-6" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb401-7"><a href="#cb401-7" aria-hidden="true" tabindex="-1"></a>&lt;head&gt;</span>
<span id="cb401-8"><a href="#cb401-8" aria-hidden="true" tabindex="-1"></a>    &lt;meta<span class="ot"> http-equiv</span>=<span class="dt">&quot;Content-Type&quot;</span><span class="ot"> content</span>=<span class="dt">&quot;text/html; charset=ISO-8859-1&quot;</span>&gt;</span>
<span id="cb401-9"><a href="#cb401-9" aria-hidden="true" tabindex="-1"></a>    &lt;title&gt;Insert title here&lt;/title&gt;</span>
<span id="cb401-10"><a href="#cb401-10" aria-hidden="true" tabindex="-1"></a>&lt;/head&gt;</span>
<span id="cb401-11"><a href="#cb401-11" aria-hidden="true" tabindex="-1"></a>&lt;body&gt;</span>
<span id="cb401-12"><a href="#cb401-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-13"><a href="#cb401-13" aria-hidden="true" tabindex="-1"></a>&lt;h4&gt;List Page&lt;/h4&gt;</span>
<span id="cb401-14"><a href="#cb401-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-15"><a href="#cb401-15" aria-hidden="true" tabindex="-1"></a>Welcome: <span class="kw">&lt;shiro:principal&gt;&lt;/shiro:principal&gt;</span></span>
<span id="cb401-16"><a href="#cb401-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-17"><a href="#cb401-17" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;shiro:hasRole</span><span class="ot"> name</span>=<span class="dt">&quot;admin&quot;</span><span class="kw">&gt;</span></span>
<span id="cb401-18"><a href="#cb401-18" aria-hidden="true" tabindex="-1"></a>    &lt;br/&gt;</span>
<span id="cb401-19"><a href="#cb401-19" aria-hidden="true" tabindex="-1"></a>    &lt;a<span class="ot"> href</span>=<span class="dt">&quot;admininfo&quot;</span>&gt;Admin Page&lt;/a&gt;</span>
<span id="cb401-20"><a href="#cb401-20" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/shiro:hasRole&gt;</span></span>
<span id="cb401-21"><a href="#cb401-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-22"><a href="#cb401-22" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;shiro:hasRole</span><span class="ot"> name</span>=<span class="dt">&quot;user&quot;</span><span class="kw">&gt;</span></span>
<span id="cb401-23"><a href="#cb401-23" aria-hidden="true" tabindex="-1"></a>    &lt;br/&gt;</span>
<span id="cb401-24"><a href="#cb401-24" aria-hidden="true" tabindex="-1"></a>    &lt;a<span class="ot"> href</span>=<span class="dt">&quot;userinfo&quot;</span>&gt;User Page&lt;/a&gt;</span>
<span id="cb401-25"><a href="#cb401-25" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/shiro:hasRole&gt;</span></span>
<span id="cb401-26"><a href="#cb401-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-27"><a href="#cb401-27" aria-hidden="true" tabindex="-1"></a>&lt;br/&gt;</span>
<span id="cb401-28"><a href="#cb401-28" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;logout&quot;</span>&gt;Logout&lt;/a&gt;</span>
<span id="cb401-29"><a href="#cb401-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb401-30"><a href="#cb401-30" aria-hidden="true" tabindex="-1"></a>&lt;/body&gt;</span>
<span id="cb401-31"><a href="#cb401-31" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<p>index.jsp</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> contentType</span>=<span class="st">&quot;text/html;charset=UTF-8&quot;</span><span class="ot"> language</span>=<span class="st">&quot;java&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a>&lt;head&gt;</span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a>    &lt;title&gt;index&lt;/title&gt;</span>
<span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a>&lt;/head&gt;</span>
<span id="cb402-6"><a href="#cb402-6" aria-hidden="true" tabindex="-1"></a>&lt;body&gt;</span>
<span id="cb402-7"><a href="#cb402-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-8"><a href="#cb402-8" aria-hidden="true" tabindex="-1"></a>&lt;h1&gt;Welcome!!&lt;/h1&gt;</span>
<span id="cb402-9"><a href="#cb402-9" aria-hidden="true" tabindex="-1"></a>&lt;hr/&gt;</span>
<span id="cb402-10"><a href="#cb402-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-11"><a href="#cb402-11" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;/user/login&quot;</span>&gt;login&lt;/a&gt;&lt;br/&gt;</span>
<span id="cb402-12"><a href="#cb402-12" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;/user/userinfo&quot;</span>&gt;user info&lt;/a&gt;&lt;br/&gt;</span>
<span id="cb402-13"><a href="#cb402-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-14"><a href="#cb402-14" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;/user/admininfo&quot;</span>&gt;admin info&lt;/a&gt;&lt;br/&gt;</span>
<span id="cb402-15"><a href="#cb402-15" aria-hidden="true" tabindex="-1"></a>&lt;a<span class="ot"> href</span>=<span class="dt">&quot;/logout&quot;</span>&gt;logout&lt;/a&gt;</span>
<span id="cb402-16"><a href="#cb402-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-17"><a href="#cb402-17" aria-hidden="true" tabindex="-1"></a>&lt;/body&gt;</span>
<span id="cb402-18"><a href="#cb402-18" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<p>login.jsp</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode jsp"><code class="sourceCode jsp"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="bu">&lt;%@ page</span><span class="ot"> contentType</span>=<span class="st">&quot;text/html;charset=UTF-8&quot;</span><span class="ot"> language</span>=<span class="st">&quot;java&quot;</span><span class="ot"> </span><span class="bu">%&gt;</span></span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a>&lt;head&gt;</span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>    &lt;title&gt;user login&lt;/title&gt;</span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a>&lt;/head&gt;</span>
<span id="cb403-6"><a href="#cb403-6" aria-hidden="true" tabindex="-1"></a>&lt;body&gt;</span>
<span id="cb403-7"><a href="#cb403-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-8"><a href="#cb403-8" aria-hidden="true" tabindex="-1"></a>Login&lt;br/&gt;</span>
<span id="cb403-9"><a href="#cb403-9" aria-hidden="true" tabindex="-1"></a>&lt;form<span class="ot"> action</span>=<span class="dt">&quot;dologin&quot;</span><span class="ot"> method</span>=<span class="dt">&quot;post&quot;</span>&gt;</span>
<span id="cb403-10"><a href="#cb403-10" aria-hidden="true" tabindex="-1"></a>    username: &lt;input<span class="ot"> type</span>=<span class="dt">&quot;text&quot;</span><span class="ot"> name</span>=<span class="dt">&quot;username&quot;</span>/&gt;&lt;br/&gt;</span>
<span id="cb403-11"><a href="#cb403-11" aria-hidden="true" tabindex="-1"></a>    password: &lt;input<span class="ot"> type</span>=<span class="dt">&quot;password&quot;</span><span class="ot"> name</span>=<span class="dt">&quot;password&quot;</span>/&gt;&lt;br/&gt;</span>
<span id="cb403-12"><a href="#cb403-12" aria-hidden="true" tabindex="-1"></a>    &lt;input<span class="ot"> type</span>=<span class="dt">&quot;submit&quot;</span>/&gt;</span>
<span id="cb403-13"><a href="#cb403-13" aria-hidden="true" tabindex="-1"></a>&lt;/form&gt;</span>
<span id="cb403-14"><a href="#cb403-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-15"><a href="#cb403-15" aria-hidden="true" tabindex="-1"></a>&lt;/body&gt;</span>
<span id="cb403-16"><a href="#cb403-16" aria-hidden="true" tabindex="-1"></a>&lt;/html&gt;</span></code></pre></div>
<h4 id="realm">Realm</h4>
<p>FirstRealm.java</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="co">//使用md5的Realm，即需要认证又需要授权验证则继承AuthorizingRealm</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> FirstRealm <span class="kw">extends</span> AuthorizingRealm <span class="op">{</span></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//认证</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthenticationInfo <span class="fu">doGetAuthenticationInfo</span><span class="op">(</span>AuthenticationToken token<span class="op">)</span> <span class="kw">throws</span> <span class="bu">AuthenticationException</span> <span class="op">{</span></span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[FirstRealm] doGetAuthenticationInfo&quot;</span><span class="op">);</span></span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-9"><a href="#cb404-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">//1. 把 AuthenticationToken 转换为 UsernamePasswordToken</span></span>
<span id="cb404-10"><a href="#cb404-10" aria-hidden="true" tabindex="-1"></a>        UsernamePasswordToken upToken <span class="op">=</span> <span class="op">(</span>UsernamePasswordToken<span class="op">)</span> token<span class="op">;</span></span>
<span id="cb404-11"><a href="#cb404-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-12"><a href="#cb404-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">//2. 从 UsernamePasswordToken 中来获取 username</span></span>
<span id="cb404-13"><a href="#cb404-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> username <span class="op">=</span> upToken<span class="op">.</span><span class="fu">getUsername</span><span class="op">();</span></span>
<span id="cb404-14"><a href="#cb404-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-15"><a href="#cb404-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">//3. 调用数据库的方法, 从数据库中查询 username 对应的用户记录</span></span>
<span id="cb404-16"><a href="#cb404-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;从数据库中获取 username: &quot;</span> <span class="op">+</span> username <span class="op">+</span> <span class="st">&quot; 所对应的用户信息.&quot;</span><span class="op">);</span></span>
<span id="cb404-17"><a href="#cb404-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-18"><a href="#cb404-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">//4. 若用户不存在, 则可以抛出 UnknownAccountException 异常</span></span>
<span id="cb404-19"><a href="#cb404-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;unknown&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb404-20"><a href="#cb404-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnknownAccountException</span><span class="op">(</span><span class="st">&quot;用户不存在!&quot;</span><span class="op">);</span></span>
<span id="cb404-21"><a href="#cb404-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb404-22"><a href="#cb404-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-23"><a href="#cb404-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">//5. 根据用户信息的情况, 决定是否需要抛出其他的 AuthenticationException 异常.</span></span>
<span id="cb404-24"><a href="#cb404-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;monster&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb404-25"><a href="#cb404-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">LockedAccountException</span><span class="op">(</span><span class="st">&quot;用户被锁定&quot;</span><span class="op">);</span></span>
<span id="cb404-26"><a href="#cb404-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb404-27"><a href="#cb404-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-28"><a href="#cb404-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">//6. 根据用户的情况, 来构建 AuthenticationInfo 对象并返回. 通常使用的实现类为: SimpleAuthenticationInfo</span></span>
<span id="cb404-29"><a href="#cb404-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">//以下信息是从数据库中获取的.</span></span>
<span id="cb404-30"><a href="#cb404-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">//1). principal: 认证的实体信息. 可以是 username, 也可以是数据表对应的用户的实体类对象.</span></span>
<span id="cb404-31"><a href="#cb404-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> principal <span class="op">=</span> username<span class="op">;</span></span>
<span id="cb404-32"><a href="#cb404-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">//2). credentials: 密码.</span></span>
<span id="cb404-33"><a href="#cb404-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">//以下模拟从数据库查询出md5加密后的结果</span></span>
<span id="cb404-34"><a href="#cb404-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> credentials <span class="op">=</span> <span class="kw">null</span><span class="op">;</span> <span class="co">//&quot;fc1709d0a95a6be30bc5926fdb7f22f4&quot;;</span></span>
<span id="cb404-35"><a href="#cb404-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb404-36"><a href="#cb404-36" aria-hidden="true" tabindex="-1"></a>            credentials <span class="op">=</span> <span class="st">&quot;4ec847db9bc2bad60e4279cce1fad5db&quot;</span><span class="op">;</span></span>
<span id="cb404-37"><a href="#cb404-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb404-38"><a href="#cb404-38" aria-hidden="true" tabindex="-1"></a>            credentials <span class="op">=</span> <span class="st">&quot;098d2c478e9c11555ce2823231e02ec1&quot;</span><span class="op">;</span></span>
<span id="cb404-39"><a href="#cb404-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb404-40"><a href="#cb404-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-41"><a href="#cb404-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">//3). realmName: 当前 realm 对象的 name. 调用父类的 getName() 方法即可</span></span>
<span id="cb404-42"><a href="#cb404-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> realmName <span class="op">=</span> <span class="fu">getName</span><span class="op">();</span></span>
<span id="cb404-43"><a href="#cb404-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-44"><a href="#cb404-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">//直接使用md5</span></span>
<span id="cb404-45"><a href="#cb404-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">//SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(principal, credentials, realmName);</span></span>
<span id="cb404-46"><a href="#cb404-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-47"><a href="#cb404-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">//4). 使用md5加盐，即使不同用户的密码相同，它们的MD5也不一样</span></span>
<span id="cb404-48"><a href="#cb404-48" aria-hidden="true" tabindex="-1"></a>        ByteSource credentialsSalt <span class="op">=</span> ByteSource<span class="op">.</span><span class="fu">Util</span><span class="op">.</span><span class="fu">bytes</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb404-49"><a href="#cb404-49" aria-hidden="true" tabindex="-1"></a>        SimpleAuthenticationInfo info <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleAuthenticationInfo</span><span class="op">(</span>principal<span class="op">,</span> credentials<span class="op">,</span> credentialsSalt<span class="op">,</span> realmName<span class="op">);</span></span>
<span id="cb404-50"><a href="#cb404-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb404-51"><a href="#cb404-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb404-52"><a href="#cb404-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-53"><a href="#cb404-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用于计算MD5，用于模拟从数据库查询出MD5加密的密码</span></span>
<span id="cb404-54"><a href="#cb404-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb404-55"><a href="#cb404-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> hashAlgorithmName <span class="op">=</span> <span class="st">&quot;MD5&quot;</span><span class="op">;</span></span>
<span id="cb404-56"><a href="#cb404-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> credentials <span class="op">=</span> <span class="st">&quot;root&quot;</span><span class="op">;</span></span>
<span id="cb404-57"><a href="#cb404-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> salt <span class="op">=</span> ByteSource<span class="op">.</span><span class="fu">Util</span><span class="op">.</span><span class="fu">bytes</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb404-58"><a href="#cb404-58" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> hashIterations <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb404-59"><a href="#cb404-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-60"><a href="#cb404-60" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> result <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleHash</span><span class="op">(</span>hashAlgorithmName<span class="op">,</span> credentials<span class="op">,</span> salt<span class="op">,</span> hashIterations<span class="op">);</span></span>
<span id="cb404-61"><a href="#cb404-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb404-62"><a href="#cb404-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb404-63"><a href="#cb404-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-64"><a href="#cb404-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-65"><a href="#cb404-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">//授权验证</span></span>
<span id="cb404-66"><a href="#cb404-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb404-67"><a href="#cb404-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthorizationInfo <span class="fu">doGetAuthorizationInfo</span><span class="op">(</span>PrincipalCollection principals<span class="op">)</span> <span class="op">{</span></span>
<span id="cb404-68"><a href="#cb404-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">//1. 从 PrincipalCollection 中来获取登录用户的信息</span></span>
<span id="cb404-69"><a href="#cb404-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> principal <span class="op">=</span> principals<span class="op">.</span><span class="fu">getPrimaryPrincipal</span><span class="op">();</span></span>
<span id="cb404-70"><a href="#cb404-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-71"><a href="#cb404-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">//2. 利用登录的用户的信息来设置用户当前用户的角色或权限(可能需要查询数据库)</span></span>
<span id="cb404-72"><a href="#cb404-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> roles <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashSet</span><span class="op">&lt;&gt;();</span></span>
<span id="cb404-73"><a href="#cb404-73" aria-hidden="true" tabindex="-1"></a>        roles<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">);</span></span>
<span id="cb404-74"><a href="#cb404-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>principal<span class="op">)){</span></span>
<span id="cb404-75"><a href="#cb404-75" aria-hidden="true" tabindex="-1"></a>            roles<span class="op">.</span><span class="fu">add</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb404-76"><a href="#cb404-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb404-77"><a href="#cb404-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-78"><a href="#cb404-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">//3. 创建 SimpleAuthorizationInfo</span></span>
<span id="cb404-79"><a href="#cb404-79" aria-hidden="true" tabindex="-1"></a>        SimpleAuthorizationInfo info <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleAuthorizationInfo</span><span class="op">(</span>roles<span class="op">);</span></span>
<span id="cb404-80"><a href="#cb404-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-81"><a href="#cb404-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">//4. 返回 SimpleAuthorizationInfo 对象.</span></span>
<span id="cb404-82"><a href="#cb404-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb404-83"><a href="#cb404-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb404-84"><a href="#cb404-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-85"><a href="#cb404-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>SecondRealm.java</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="co">//使用sha1的Realm，只需要认证则继承AuthenticatingRealm</span></span>
<span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SecondRealm <span class="kw">extends</span> AuthenticatingRealm <span class="op">{</span></span>
<span id="cb405-3"><a href="#cb405-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-4"><a href="#cb405-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb405-5"><a href="#cb405-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthenticationInfo <span class="fu">doGetAuthenticationInfo</span><span class="op">(</span>AuthenticationToken token<span class="op">)</span> <span class="kw">throws</span> <span class="bu">AuthenticationException</span> <span class="op">{</span></span>
<span id="cb405-6"><a href="#cb405-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;[SecondRealm] doGetAuthenticationInfo&quot;</span><span class="op">);</span></span>
<span id="cb405-7"><a href="#cb405-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-8"><a href="#cb405-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">//1. 把 AuthenticationToken 转换为 UsernamePasswordToken</span></span>
<span id="cb405-9"><a href="#cb405-9" aria-hidden="true" tabindex="-1"></a>        UsernamePasswordToken upToken <span class="op">=</span> <span class="op">(</span>UsernamePasswordToken<span class="op">)</span> token<span class="op">;</span></span>
<span id="cb405-10"><a href="#cb405-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-11"><a href="#cb405-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//2. 从 UsernamePasswordToken 中来获取 username</span></span>
<span id="cb405-12"><a href="#cb405-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> username <span class="op">=</span> upToken<span class="op">.</span><span class="fu">getUsername</span><span class="op">();</span></span>
<span id="cb405-13"><a href="#cb405-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-14"><a href="#cb405-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//3. 调用数据库的方法, 从数据库中查询 username 对应的用户记录</span></span>
<span id="cb405-15"><a href="#cb405-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;从数据库中获取 username: &quot;</span> <span class="op">+</span> username <span class="op">+</span> <span class="st">&quot; 所对应的用户信息.&quot;</span><span class="op">);</span></span>
<span id="cb405-16"><a href="#cb405-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-17"><a href="#cb405-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">//4. 若用户不存在, 则可以抛出 UnknownAccountException 异常</span></span>
<span id="cb405-18"><a href="#cb405-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;unknown&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb405-19"><a href="#cb405-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnknownAccountException</span><span class="op">(</span><span class="st">&quot;用户不存在!&quot;</span><span class="op">);</span></span>
<span id="cb405-20"><a href="#cb405-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb405-21"><a href="#cb405-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-22"><a href="#cb405-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">//5. 根据用户信息的情况, 决定是否需要抛出其他的 AuthenticationException 异常.</span></span>
<span id="cb405-23"><a href="#cb405-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;monster&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb405-24"><a href="#cb405-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">LockedAccountException</span><span class="op">(</span><span class="st">&quot;用户被锁定&quot;</span><span class="op">);</span></span>
<span id="cb405-25"><a href="#cb405-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb405-26"><a href="#cb405-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-27"><a href="#cb405-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">//6. 根据用户的情况, 来构建 AuthenticationInfo 对象并返回. 通常使用的实现类为: SimpleAuthenticationInfo</span></span>
<span id="cb405-28"><a href="#cb405-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">//以下信息是从数据库中获取的.</span></span>
<span id="cb405-29"><a href="#cb405-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">//1). principal: 认证的实体信息. 可以是 username, 也可以是数据表对应的用户的实体类对象.</span></span>
<span id="cb405-30"><a href="#cb405-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> principal <span class="op">=</span> username<span class="op">;</span></span>
<span id="cb405-31"><a href="#cb405-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">//2). credentials: 密码.</span></span>
<span id="cb405-32"><a href="#cb405-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> credentials <span class="op">=</span> <span class="kw">null</span><span class="op">;</span> <span class="co">//&quot;fc1709d0a95a6be30bc5926fdb7f22f4&quot;;</span></span>
<span id="cb405-33"><a href="#cb405-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb405-34"><a href="#cb405-34" aria-hidden="true" tabindex="-1"></a>            credentials <span class="op">=</span> <span class="st">&quot;15a9aeaa034f1f65730feaffbdbe4260c02dd8aa&quot;</span><span class="op">;</span></span>
<span id="cb405-35"><a href="#cb405-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb405-36"><a href="#cb405-36" aria-hidden="true" tabindex="-1"></a>            credentials <span class="op">=</span> <span class="st">&quot;073d4c3ae812935f23cb3f2a71943f49e082a718&quot;</span><span class="op">;</span></span>
<span id="cb405-37"><a href="#cb405-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb405-38"><a href="#cb405-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-39"><a href="#cb405-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">//3). realmName: 当前 realm 对象的 name. 调用父类的 getName() 方法即可</span></span>
<span id="cb405-40"><a href="#cb405-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> realmName <span class="op">=</span> <span class="fu">getName</span><span class="op">();</span></span>
<span id="cb405-41"><a href="#cb405-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">//4). 盐值.</span></span>
<span id="cb405-42"><a href="#cb405-42" aria-hidden="true" tabindex="-1"></a>        ByteSource credentialsSalt <span class="op">=</span> ByteSource<span class="op">.</span><span class="fu">Util</span><span class="op">.</span><span class="fu">bytes</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb405-43"><a href="#cb405-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-44"><a href="#cb405-44" aria-hidden="true" tabindex="-1"></a>        SimpleAuthenticationInfo info <span class="op">=</span> <span class="kw">null</span><span class="op">;</span> <span class="co">//new SimpleAuthenticationInfo(principal, credentials, realmName);</span></span>
<span id="cb405-45"><a href="#cb405-45" aria-hidden="true" tabindex="-1"></a>        info <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleAuthenticationInfo</span><span class="op">(</span><span class="st">&quot;secondRealmName&quot;</span><span class="op">,</span> credentials<span class="op">,</span> credentialsSalt<span class="op">,</span> realmName<span class="op">);</span></span>
<span id="cb405-46"><a href="#cb405-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb405-47"><a href="#cb405-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb405-48"><a href="#cb405-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-49"><a href="#cb405-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用于计算SHA1，用于模拟从数据库查询出SHA1加密的密码</span></span>
<span id="cb405-50"><a href="#cb405-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb405-51"><a href="#cb405-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> hashAlgorithmName <span class="op">=</span> <span class="st">&quot;SHA1&quot;</span><span class="op">;</span></span>
<span id="cb405-52"><a href="#cb405-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> credentials <span class="op">=</span> <span class="st">&quot;root&quot;</span><span class="op">;</span></span>
<span id="cb405-53"><a href="#cb405-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> salt <span class="op">=</span> ByteSource<span class="op">.</span><span class="fu">Util</span><span class="op">.</span><span class="fu">bytes</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">);</span></span>
<span id="cb405-54"><a href="#cb405-54" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> hashIterations <span class="op">=</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb405-55"><a href="#cb405-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb405-56"><a href="#cb405-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> result <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleHash</span><span class="op">(</span>hashAlgorithmName<span class="op">,</span> credentials<span class="op">,</span> salt<span class="op">,</span> hashIterations<span class="op">);</span></span>
<span id="cb405-57"><a href="#cb405-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>result<span class="op">);</span></span>
<span id="cb405-58"><a href="#cb405-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb405-59"><a href="#cb405-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="controller">Controller</h4>
<div class="sourceCode" id="cb406"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/user&quot;</span><span class="op">)</span></span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/login&quot;</span><span class="op">)</span></span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">login</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;login&quot;</span><span class="op">;</span></span>
<span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-10"><a href="#cb406-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/dologin&quot;</span><span class="op">,</span> method <span class="op">=</span> RequestMethod<span class="op">.</span><span class="fu">POST</span><span class="op">)</span></span>
<span id="cb406-11"><a href="#cb406-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">doLogin</span><span class="op">(</span><span class="bu">String</span> username<span class="op">,</span> <span class="bu">String</span> password<span class="op">,</span> HttpSession session<span class="op">)</span> <span class="op">{</span></span>
<span id="cb406-12"><a href="#cb406-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Subject</span> currentUser <span class="op">=</span> SecurityUtils<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb406-13"><a href="#cb406-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>currentUser<span class="op">.</span><span class="fu">isAuthenticated</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb406-14"><a href="#cb406-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 把用户名和密码封装为 UsernamePasswordToken 对象</span></span>
<span id="cb406-15"><a href="#cb406-15" aria-hidden="true" tabindex="-1"></a>            UsernamePasswordToken token <span class="op">=</span> <span class="kw">new</span> <span class="fu">UsernamePasswordToken</span><span class="op">(</span>username<span class="op">,</span> password<span class="op">);</span></span>
<span id="cb406-16"><a href="#cb406-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// rememberme</span></span>
<span id="cb406-17"><a href="#cb406-17" aria-hidden="true" tabindex="-1"></a>            token<span class="op">.</span><span class="fu">setRememberMe</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb406-18"><a href="#cb406-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb406-19"><a href="#cb406-19" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 执行登录.</span></span>
<span id="cb406-20"><a href="#cb406-20" aria-hidden="true" tabindex="-1"></a>                currentUser<span class="op">.</span><span class="fu">login</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb406-21"><a href="#cb406-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb406-22"><a href="#cb406-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 所有认证时异常的父类.</span></span>
<span id="cb406-23"><a href="#cb406-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">catch</span> <span class="op">(</span><span class="bu">AuthenticationException</span> ae<span class="op">)</span> <span class="op">{</span></span>
<span id="cb406-24"><a href="#cb406-24" aria-hidden="true" tabindex="-1"></a>                <span class="co">//unexpected condition?  error?</span></span>
<span id="cb406-25"><a href="#cb406-25" aria-hidden="true" tabindex="-1"></a>                <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;登录失败: &quot;</span> <span class="op">+</span> ae<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb406-26"><a href="#cb406-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb406-27"><a href="#cb406-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">&quot;info&quot;</span><span class="op">;</span></span>
<span id="cb406-28"><a href="#cb406-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb406-29"><a href="#cb406-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;unauthorized&quot;</span><span class="op">;</span></span>
<span id="cb406-30"><a href="#cb406-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-31"><a href="#cb406-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-32"><a href="#cb406-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/userinfo&quot;</span><span class="op">)</span></span>
<span id="cb406-33"><a href="#cb406-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">userInfo</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-34"><a href="#cb406-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;user_info&quot;</span><span class="op">;</span></span>
<span id="cb406-35"><a href="#cb406-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-36"><a href="#cb406-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-37"><a href="#cb406-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/admininfo&quot;</span><span class="op">)</span></span>
<span id="cb406-38"><a href="#cb406-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">adminInfo</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-39"><a href="#cb406-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;admin_info&quot;</span><span class="op">;</span></span>
<span id="cb406-40"><a href="#cb406-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-41"><a href="#cb406-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-42"><a href="#cb406-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/info&quot;</span><span class="op">)</span></span>
<span id="cb406-43"><a href="#cb406-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">info</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-44"><a href="#cb406-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;info&quot;</span><span class="op">;</span></span>
<span id="cb406-45"><a href="#cb406-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-46"><a href="#cb406-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-47"><a href="#cb406-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;unauthorized&quot;</span><span class="op">)</span></span>
<span id="cb406-48"><a href="#cb406-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">unauthorized</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-49"><a href="#cb406-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;unauthorized&quot;</span><span class="op">;</span></span>
<span id="cb406-50"><a href="#cb406-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-51"><a href="#cb406-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb406-52"><a href="#cb406-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;logout&quot;</span><span class="op">)</span></span>
<span id="cb406-53"><a href="#cb406-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">logout</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb406-54"><a href="#cb406-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;/index.jsp&quot;</span><span class="op">;</span></span>
<span id="cb406-55"><a href="#cb406-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb406-56"><a href="#cb406-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="注解-2">注解</h3>
<p>如果Service层使用了其他代理，使用Shiro的注解可能会报错，这时可以选择在Controller使用Shiro的注解</p>
<ul>
<li><code>@RequiresAuthentication</code>:
使用该注解标注的类，实例，方法在访问或调用时，当前Subject必须在当前session中已经过认证</li>
<li><code>@RequiresGuest</code>:
使用该注解标注的类，实例，方法在访问或调用时，当前Subject可以是“gust”身份，不需要经过认证或者在原先的session中存在记录</li>
<li><code>@RequiresPermissions</code>:
当前Subject需要拥有某些特定的权限时，才能执行被该注解标注的方法。如果当前Subject不具有这样的权限，则方法不会被执行</li>
<li><code>@RequiresRoles</code>:
当前Subject必须拥有所有指定的角色时，才能访问被该注解标注的方法。如果当前Subject不同时拥有所有指定角色，则方法不会执行还会抛出AuthorizationException异常</li>
<li><code>@RequiresUser</code>:
当前Subject必须是应用的用户，才能访问或调用被该注解标注的类，实例，方法</li>
</ul>
<h2 id="quartz">Quartz</h2>
<p>Quartz是一个任务调度框架</p>
<p>几个概念</p>
<ul>
<li>Scheduler: 调度器。所有的任务调度都是由它控制</li>
<li>Trigger: 定义触发的条件</li>
<li>JobDetail: 任务数据</li>
<li>Job: 要执行的任务</li>
</ul>
<h3 id="pom.xml-5">pom.xml</h3>
<div class="sourceCode" id="cb407"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Quartz --&gt;</span></span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb407-3"><a href="#cb407-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.quartz-scheduler&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb407-4"><a href="#cb407-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;quartz&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb407-5"><a href="#cb407-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;2.2.3&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb407-6"><a href="#cb407-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb407-7"><a href="#cb407-7" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb407-8"><a href="#cb407-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.quartz-scheduler&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb407-9"><a href="#cb407-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;quartz-jobs&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb407-10"><a href="#cb407-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;2.2.3&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb407-11"><a href="#cb407-11" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb407-12"><a href="#cb407-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb407-13"><a href="#cb407-13" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- log4j --&gt;</span></span>
<span id="cb407-14"><a href="#cb407-14" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb407-15"><a href="#cb407-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb407-16"><a href="#cb407-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;slf4j-log4j12&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb407-17"><a href="#cb407-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb407-18"><a href="#cb407-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span>
<span id="cb407-19"><a href="#cb407-19" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb407-20"><a href="#cb407-20" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.slf4j&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb407-21"><a href="#cb407-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;slf4j-api&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb407-22"><a href="#cb407-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;1.6.1&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb407-23"><a href="#cb407-23" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<h3 id="使用-1">使用</h3>
<div class="sourceCode" id="cb408"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main <span class="op">{</span></span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> SchedulerException <span class="op">{</span></span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//任务的数据，其实是一个Map</span></span>
<span id="cb408-4"><a href="#cb408-4" aria-hidden="true" tabindex="-1"></a>        JobDataMap jobDataMap <span class="op">=</span> <span class="kw">new</span> <span class="fu">JobDataMap</span><span class="op">();</span></span>
<span id="cb408-5"><a href="#cb408-5" aria-hidden="true" tabindex="-1"></a>        jobDataMap<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">,</span> <span class="kw">new</span> <span class="fu">User</span><span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">));</span></span>
<span id="cb408-6"><a href="#cb408-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-7"><a href="#cb408-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">//任务详情，用于设置任务所需的数据</span></span>
<span id="cb408-8"><a href="#cb408-8" aria-hidden="true" tabindex="-1"></a>        JobDetail jobDetail <span class="op">=</span> JobBuilder<span class="op">.</span><span class="fu">newJob</span><span class="op">(</span>MyJob<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb408-9"><a href="#cb408-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;jobDetail1&quot;</span><span class="op">,</span> <span class="st">&quot;d_group1&quot;</span><span class="op">)</span><span class="co">//设置jobDetail的id</span></span>
<span id="cb408-10"><a href="#cb408-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">,</span> <span class="st">&quot;data1&quot;</span><span class="op">)</span><span class="co">//设置简单的数据</span></span>
<span id="cb408-11"><a href="#cb408-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span>jobDataMap<span class="op">)</span><span class="co">//设置复杂的数据</span></span>
<span id="cb408-12"><a href="#cb408-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb408-13"><a href="#cb408-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-14"><a href="#cb408-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//触发器，设置任务何时触发，是否重复触发等</span></span>
<span id="cb408-15"><a href="#cb408-15" aria-hidden="true" tabindex="-1"></a>        Trigger trigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb408-16"><a href="#cb408-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger1&quot;</span><span class="op">,</span> <span class="st">&quot;t_group1&quot;</span><span class="op">)</span><span class="co">//设置trigger的id</span></span>
<span id="cb408-17"><a href="#cb408-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span><span class="st">&quot;key2&quot;</span><span class="op">,</span> <span class="st">&quot;data2&quot;</span><span class="op">)</span><span class="co">//trigger也可以设置简单数据和复杂数据</span></span>
<span id="cb408-18"><a href="#cb408-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">,</span><span class="st">&quot;trigger_data&quot;</span><span class="op">)</span></span>
<span id="cb408-19"><a href="#cb408-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withPriority</span><span class="op">(</span><span class="dv">2</span><span class="op">)</span><span class="co">//优先级</span></span>
<span id="cb408-20"><a href="#cb408-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>SimpleScheduleBuilder<span class="op">.</span><span class="fu">simpleSchedule</span><span class="op">()</span></span>
<span id="cb408-21"><a href="#cb408-21" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">withIntervalInSeconds</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span><span class="co">//隔10秒执行一次</span></span>
<span id="cb408-22"><a href="#cb408-22" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">withRepeatCount</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span><span class="co">//或者.repeatForever())，重复执行，设置为5表示开始执行1次，然后在重复5次，总共执行6次</span></span>
<span id="cb408-23"><a href="#cb408-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">startAt</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span><span class="bu">System</span><span class="op">.</span><span class="fu">currentTimeMillis</span><span class="op">()</span> <span class="op">+</span> <span class="dv">5000</span><span class="op">))</span><span class="co">//5秒后开始执行，或者.startNow()</span></span>
<span id="cb408-24"><a href="#cb408-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb408-25"><a href="#cb408-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-26"><a href="#cb408-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">//调度器，用于执行任务</span></span>
<span id="cb408-27"><a href="#cb408-27" aria-hidden="true" tabindex="-1"></a>        Scheduler scheduler <span class="op">=</span> StdSchedulerFactory<span class="op">.</span><span class="fu">getDefaultScheduler</span><span class="op">();</span></span>
<span id="cb408-28"><a href="#cb408-28" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">.</span><span class="fu">scheduleJob</span><span class="op">(</span>jobDetail<span class="op">,</span> trigger<span class="op">);</span></span>
<span id="cb408-29"><a href="#cb408-29" aria-hidden="true" tabindex="-1"></a>        scheduler<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb408-30"><a href="#cb408-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb408-31"><a href="#cb408-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb408-32"><a href="#cb408-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-33"><a href="#cb408-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User <span class="op">{</span></span>
<span id="cb408-34"><a href="#cb408-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> name<span class="op">;</span></span>
<span id="cb408-35"><a href="#cb408-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb408-36"><a href="#cb408-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">User</span><span class="op">(</span><span class="bu">String</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb408-37"><a href="#cb408-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">name</span> <span class="op">=</span> name<span class="op">;</span></span>
<span id="cb408-38"><a href="#cb408-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb408-39"><a href="#cb408-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Job</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyJob <span class="kw">implements</span> Job <span class="op">{</span></span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//重复任务每次都会new，而不是使用之前的任务</span></span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//底层使用了jobClass.newInstance()，所以必须要有public的无参构造器</span></span>
<span id="cb409-5"><a href="#cb409-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">MyJob</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb409-6"><a href="#cb409-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;new MyJob()&quot;</span><span class="op">);</span></span>
<span id="cb409-7"><a href="#cb409-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb409-8"><a href="#cb409-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-9"><a href="#cb409-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span><span class="op">(</span>JobExecutionContext jobExecutionContext<span class="op">)</span> <span class="kw">throws</span> JobExecutionException <span class="op">{</span></span>
<span id="cb409-10"><a href="#cb409-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//任务开始时间</span></span>
<span id="cb409-11"><a href="#cb409-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">DateFormat</span> format <span class="op">=</span> <span class="kw">new</span> <span class="bu">SimpleDateFormat</span><span class="op">(</span><span class="st">&quot;yyyy-mm-dd--HH:mm:ss&quot;</span><span class="op">);</span></span>
<span id="cb409-12"><a href="#cb409-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;start time: &quot;</span><span class="op">+</span>format<span class="op">.</span><span class="fu">format</span><span class="op">(</span>jobExecutionContext<span class="op">.</span><span class="fu">getFireTime</span><span class="op">()));</span></span>
<span id="cb409-13"><a href="#cb409-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-14"><a href="#cb409-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//获取从jobDetail或trigger处设置的数据，使用MergedJobDataMap时，如果key有重复，trigger会覆盖jobDetail的</span></span>
<span id="cb409-15"><a href="#cb409-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;key1: &quot;</span><span class="op">+</span>jobExecutionContext<span class="op">.</span><span class="fu">getMergedJobDataMap</span><span class="op">().</span><span class="fu">getString</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">));</span></span>
<span id="cb409-16"><a href="#cb409-16" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> <span class="op">(</span>User<span class="op">)</span> jobExecutionContext<span class="op">.</span><span class="fu">getMergedJobDataMap</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;user&quot;</span><span class="op">);</span></span>
<span id="cb409-17"><a href="#cb409-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;user.name: &quot;</span><span class="op">+</span>user<span class="op">.</span><span class="fu">name</span><span class="op">);</span></span>
<span id="cb409-18"><a href="#cb409-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-19"><a href="#cb409-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">//也可以获取jobDetail和trigger，这样即使key有重复也可以获取</span></span>
<span id="cb409-20"><a href="#cb409-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">//直接set的数据其实是set到了map中</span></span>
<span id="cb409-21"><a href="#cb409-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;jobDetail key1: &quot;</span><span class="op">+</span>jobExecutionContext<span class="op">.</span><span class="fu">getJobDetail</span><span class="op">().</span><span class="fu">getJobDataMap</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">));</span></span>
<span id="cb409-22"><a href="#cb409-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;trigger key1: &quot;</span><span class="op">+</span>jobExecutionContext<span class="op">.</span><span class="fu">getTrigger</span><span class="op">().</span><span class="fu">getJobDataMap</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;key1&quot;</span><span class="op">));</span></span>
<span id="cb409-23"><a href="#cb409-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;trigger key2: &quot;</span><span class="op">+</span>jobExecutionContext<span class="op">.</span><span class="fu">getTrigger</span><span class="op">().</span><span class="fu">getJobDataMap</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;key2&quot;</span><span class="op">));</span></span>
<span id="cb409-24"><a href="#cb409-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-25"><a href="#cb409-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;-----------------------------&quot;</span><span class="op">);</span></span>
<span id="cb409-26"><a href="#cb409-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb409-27"><a href="#cb409-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="job">Job</h3>
<p>设计成<code>JobDetail</code>+<code>Job</code>的原因：重复的任务每次执行，都会新建一个<code>Job</code>的实例，这样可以避免并发产生的问题，但是有时候又需要设置一些共享的数据，于是就有了<code>JobDetail</code>，用于存储共享的数据</p>
<h4 id="disallowconcurrentexecution"><span class="citation" data-cites="DisallowConcurrentExecution">@DisallowConcurrentExecution</span></h4>
<p>Job是有可能并发执行的，比如一个任务要执行10秒中，而调度算法是每5秒中触发1次，那么就有可能多个任务被并发执行。有时候我们并不想任务并发执行，比如<code>Job</code>是对系统做检测，重复的检测是没有意义的，这时就可以使用<code>@DisallowConcurrentExecution</code>。使用<code>@DisallowConcurrentExecution</code>后，会等待任务执行完毕以后再重新执行（这样会导致任务的执行不是按照我们预先定义的时间间隔执行）</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a><span class="at">@DisallowConcurrentExecution</span></span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyJob <span class="kw">implements</span> Job <span class="op">{</span></span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span><span class="op">(</span>JobExecutionContext jobExecutionContext<span class="op">)</span> <span class="kw">throws</span> JobExecutionException <span class="op">{</span></span>
<span id="cb410-4"><a href="#cb410-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//do something</span></span>
<span id="cb410-5"><a href="#cb410-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb410-6"><a href="#cb410-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>@DisallowConcurrentExecution</code>是对<code>JobDetail</code>实例生效的，也就是如果你定义两个<code>JobDetail</code>实例，引用同一个<code>Job</code>类，仍然是可以并发执行的</p>
<h4 id="persistjobdataafterexecution"><span class="citation" data-cites="PersistJobDataAfterExecution">@PersistJobDataAfterExecution</span></h4>
<p>表示当正常执行完Job后，JobDataMap中的数据应该被改动，以被下一次调用时用（在默认情况下，也就是没有设置<code>@PersistJobDataAfterExecution</code>的时候
每个<code>Job</code>都拥有独立<code>JobDataMap</code>）</p>
<p>当使用<code>@PersistJobDataAfterExecution</code>注解时，为了避免并发时，存储数据造成混乱，建议把<code>@DisallowConcurrentExecution</code>注解也加上</p>
<h3 id="jobdetail">JobDetail</h3>
<p>除了identity、description、jobData等属性外，还有两个属性：</p>
<ul>
<li>durability:
默认为false，为false时，当没有<code>Trigger</code>关联<code>JobDetail</code>的时候，它就会被自动删除；为true时，如果没有<code>Trigger</code>关联，则会将<code>JobDetail</code>保存在队列中</li>
<li>requestRecovery: 如果一个任务是”requests
recovery”，那么当任务运行过程非正常退出时（比如进程崩溃，机器断电，但不包括抛出异常这种情况），Quartz再次启动时，会重新运行一次这个任务实例</li>
</ul>
<h3 id="trigger">Trigger</h3>
<h4 id="simpletrigger">SimpleTrigger</h4>
<p>指定从某一个时间开始，以一定的时间间隔（单位可以是毫秒、秒、分钟、小时）执行的任务，它可以指定重复的次数</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a>SimpleTrigger simpleTrigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger&quot;</span><span class="op">)</span></span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>SimpleScheduleBuilder<span class="op">.</span><span class="fu">simpleSchedule</span><span class="op">()</span></span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withMisfireHandlingInstructionFireNow</span><span class="op">()</span></span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIntervalInSeconds</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withRepeatCount</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb411-7"><a href="#cb411-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb411-8"><a href="#cb411-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<h4 id="calendarintervaltrigger">CalendarIntervalTrigger</h4>
<p>指定从某一个时间开始，以一定的时间间隔执行的任务，它支持的时间单位比<code>SimpleTrigger</code>多，<code>CalendarIntervalTrigger</code>支持的间隔单位有秒、分钟、小时、天、星期、月，年，但是<code>CalendarIntervalTrigger</code>不能指定重复次数</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a>CalendarIntervalTrigger calendarIntervalTrigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger&quot;</span><span class="op">)</span></span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>CalendarIntervalScheduleBuilder<span class="op">.</span><span class="fu">calendarIntervalSchedule</span><span class="op">()</span></span>
<span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIntervalInWeeks</span><span class="op">(</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<h4 id="dailytimeintervaltrigger">DailyTimeIntervalTrigger</h4>
<p>指定每天的某个时间段内，以一定的时间间隔执行任务，它还可以支持指定星期几</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a>DailyTimeIntervalTrigger dailyTimeIntervalTrigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger&quot;</span><span class="op">)</span></span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>DailyTimeIntervalScheduleBuilder<span class="op">.</span><span class="fu">dailyTimeIntervalSchedule</span><span class="op">()</span></span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">startingDailyAt</span><span class="op">(</span>TimeOfDay<span class="op">.</span><span class="fu">hourAndMinuteOfDay</span><span class="op">(</span><span class="dv">9</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="co">//每天9：00开始</span></span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">endingDailyAt</span><span class="op">(</span>TimeOfDay<span class="op">.</span><span class="fu">hourAndMinuteOfDay</span><span class="op">(</span><span class="dv">16</span><span class="op">,</span> <span class="dv">0</span><span class="op">))</span> <span class="co">//16：00 结束</span></span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">onDaysOfTheWeek</span><span class="op">(</span>MONDAY<span class="op">,</span> TUESDAY<span class="op">,</span> WEDNESDAY<span class="op">,</span> THURSDAY<span class="op">,</span> FRIDAY<span class="op">)</span> <span class="co">//周一至周五执行</span></span>
<span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIntervalInHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="co">//每间隔1小时执行一次</span></span>
<span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withRepeatCount</span><span class="op">(</span><span class="dv">100</span><span class="op">))</span> <span class="co">//最多重复100次（实际执行100+1次）</span></span>
<span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb413-10"><a href="#cb413-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<h4 id="crontrigger">CronTrigger</h4>
<p>适合于更复杂的任务，它支持类型于Linux
Cron的语法，可以通过cron表达式设置任务的执行时间</p>
<div class="sourceCode" id="cb414"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb414-1"><a href="#cb414-1" aria-hidden="true" tabindex="-1"></a>CronTrigger cronTrigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb414-2"><a href="#cb414-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger&quot;</span><span class="op">)</span></span>
<span id="cb414-3"><a href="#cb414-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>CronScheduleBuilder<span class="op">.</span><span class="fu">cronSchedule</span><span class="op">(</span><span class="st">&quot;0 0/2 8-17 * * ?&quot;</span><span class="op">))</span> <span class="co">//每天8:00-17:00，每隔2分钟执行一次</span></span>
<span id="cb414-4"><a href="#cb414-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb414-5"><a href="#cb414-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<p>Cron表达式：</p>
<table>
<thead>
<tr>
<th>位置</th>
<th>时间域</th>
<th>允许值</th>
<th>特殊值</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>秒</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>2</td>
<td>分钟</td>
<td>0-59</td>
<td>, - * /</td>
</tr>
<tr>
<td>3</td>
<td>小时</td>
<td>0-23</td>
<td>, - * /</td>
</tr>
<tr>
<td>4</td>
<td>日期</td>
<td>1-31</td>
<td>, - * ? / L W C</td>
</tr>
<tr>
<td>5</td>
<td>月份</td>
<td>1-12</td>
<td>, - * /</td>
</tr>
<tr>
<td>6</td>
<td>星期</td>
<td>1-7</td>
<td>, - * ? / L C #</td>
</tr>
<tr>
<td>7</td>
<td>年份（可选）</td>
<td>1-31</td>
<td>, - * /</td>
</tr>
</tbody>
</table>
<ul>
<li><p>星号(<code>*</code>):
可用在所有字段中，表示对应时间域的每一个时刻，例如，*
在分钟字段时，表示“每分钟”；</p></li>
<li><p>问号(<code>?</code>):
该字符只在日期和星期字段中使用，它通常指定为“无意义的值”，相当于点位符；</p></li>
<li><p>减号(<code>-</code>):
表达一个范围，如在小时字段中使用“10-12”，则表示从10到12点，即10,11,12；</p></li>
<li><p>逗号(<code>,</code>):
表达一个列表值，如在星期字段中使用“MON,WED,FRI”，则表示星期一，星期三和星期五；</p></li>
<li><p>斜杠(<code>/</code>):
x/y表达一个等步长序列，x为起始值，y为增量步长值。如在分钟字段中使用0/15，则表示为0,15,30和45秒，而5/15在分钟字段中表示5,20,35,50，你也可以使用*/y，它等同于0/y；</p></li>
<li><p>L:
该字符只在日期和星期字段中使用，代表“Last”的意思，但它在两个字段中意思不同。L在日期字段中，表示这个月份的最后一天，如一月的31号，非闰年二月的28号；如果L用在星期中，则表示星期六，等同于7。但是，如果L出现在星期字段里，而且在前面有一个数值X，则表示“这个月的最后X天”，例如，6L表示该月的最后星期五；</p></li>
<li><p>W:
该字符只能出现在日期字段里，是对前导日期的修饰，表示离该日期最近的工作日。例如15W表示离该月15号最近的工作日，如果该月15号是星期六，则匹配14号星期五；如果15日是星期日，则匹配16号星期一；如果15号是星期二，那结果就是15号星期二。但必须注意关联的匹配日期不能够跨月，如你指定1W，如果1号是星期六，结果匹配的是3号星期一，而非上个月最后的那天。W字符串只能指定单一日期，而不能指定日期范围；</p></li>
<li><p>LW组合:
在日期字段可以组合使用LW，它的意思是当月的最后一个工作日；</p></li>
<li><p>井号(<code>#</code>):
该字符只能在星期字段中使用，表示当月某个工作日。如6#3表示当月的第三个星期五(6表示星期五，#3表示当前的第三个)，而4#5表示当月的第五个星期三，假设当月没有第五个星期三，忽略不触发；</p></li>
<li><p>C:
该字符只在日期和星期字段中使用，代表“Calendar”的意思。它的意思是计划所关联的日期，如果日期没有被关联，则相当于日历中所有日期。例如5C在日期字段中就相当于日历5日以后的第一天。1C在星期字段中相当于星期日后的第一天。</p></li>
</ul>
<p>Cron表达式对特殊字符的大小写不敏感，对代表星期、月份的缩写英文大小写也不敏感（星期使用数字时，1表示星期天，2才是星期一；星期可以使用英文缩写代替，如MON、FRI；月份也可以使用英文缩写，如JAN、DEC）</p>
<h4 id="calendar">Calendar</h4>
<p><code>Trigger</code>可以使用Quartz的<code>Calendar</code>来执行周期较长的任务</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a>AnnualCalendar cal <span class="op">=</span> <span class="kw">new</span> <span class="fu">AnnualCalendar</span><span class="op">();</span> <span class="co">//定义一个每年执行Calendar，精度为天</span></span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a>java<span class="op">.</span><span class="fu">util</span><span class="op">.</span><span class="fu">Calendar</span> excludeDay <span class="op">=</span> <span class="kw">new</span> <span class="bu">GregorianCalendar</span><span class="op">();</span></span>
<span id="cb415-3"><a href="#cb415-3" aria-hidden="true" tabindex="-1"></a>excludeDay<span class="op">.</span><span class="fu">setTime</span><span class="op">(</span><span class="fu">newDate</span><span class="op">().</span><span class="fu">inMonthOnDay</span><span class="op">(</span><span class="dv">2</span><span class="op">,</span> <span class="dv">25</span><span class="op">).</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb415-4"><a href="#cb415-4" aria-hidden="true" tabindex="-1"></a>cal<span class="op">.</span><span class="fu">setDayExcluded</span><span class="op">(</span>excludeDay<span class="op">,</span> <span class="kw">true</span><span class="op">);</span> <span class="co">//设置排除2.25这个日期</span></span>
<span id="cb415-5"><a href="#cb415-5" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">addCalendar</span><span class="op">(</span><span class="st">&quot;FebCal&quot;</span><span class="op">,</span> cal<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> <span class="co">//scheduler加入这个Calendar</span></span>
<span id="cb415-6"><a href="#cb415-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb415-7"><a href="#cb415-7" aria-hidden="true" tabindex="-1"></a>Trigger trigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">().</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger1&quot;</span><span class="op">,</span> <span class="st">&quot;group1&quot;</span><span class="op">)</span></span>
<span id="cb415-8"><a href="#cb415-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span><span class="co">//一旦加入scheduler，立即生效</span></span>
<span id="cb415-9"><a href="#cb415-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">modifiedByCalendar</span><span class="op">(</span><span class="st">&quot;FebCal&quot;</span><span class="op">)</span> <span class="co">//使用Calendar !!</span></span>
<span id="cb415-10"><a href="#cb415-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span><span class="fu">simpleSchedule</span><span class="op">()</span></span>
<span id="cb415-11"><a href="#cb415-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIntervalInSeconds</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb415-12"><a href="#cb415-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">repeatForever</span><span class="op">())</span></span>
<span id="cb415-13"><a href="#cb415-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<p>一共有如下<code>Calendar</code></p>
<ul>
<li>HolidayCalendar: 指定特定的日期，比如20180101。精度到天</li>
<li>DailyCalendar: 指定每天的时间段（rangeStartingTime,
rangeEndingTime)，格式是HH:MM[:SS[:mmm]]。也就是最大精度可以到毫秒</li>
<li>WeeklyCalendar:
指定每星期的星期几，可选值比如为java.util.Calendar.SUNDAY。精度是天</li>
<li>MonthlyCalendar: 指定每月的几号。可选值为1-31。精度是天</li>
<li>AnnualCalendar: 指定每年的哪一天。精度是天</li>
<li>CronCalendar:
指定Cron表达式。精度取决于Cron表达式，也就是最大精度可以到秒</li>
</ul>
<h4 id="misfire错失策略">Misfire(错失策略)</h4>
<div class="sourceCode" id="cb416"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb416-1"><a href="#cb416-1" aria-hidden="true" tabindex="-1"></a>Trigger trigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb416-2"><a href="#cb416-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger1&quot;</span><span class="op">,</span> <span class="st">&quot;t_group1&quot;</span><span class="op">)</span></span>
<span id="cb416-3"><a href="#cb416-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>SimpleScheduleBuilder<span class="op">.</span><span class="fu">simpleSchedule</span><span class="op">()</span></span>
<span id="cb416-4"><a href="#cb416-4" aria-hidden="true" tabindex="-1"></a>                  <span class="co">//设置错失策略，对应SimpleTrigger.MISFIRE_INSTRUCTION_FIRE_NOW;</span></span>
<span id="cb416-5"><a href="#cb416-5" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">withMisfireHandlingInstructionFireNow</span><span class="op">()</span></span>
<span id="cb416-6"><a href="#cb416-6" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">withIntervalInSeconds</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb416-7"><a href="#cb416-7" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">withRepeatCount</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb416-8"><a href="#cb416-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span>map<span class="op">)</span></span>
<span id="cb416-9"><a href="#cb416-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb416-10"><a href="#cb416-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<p>通用的错失策略</p>
<ul>
<li>MISFIRE_INSTRUCTION_SMART_POLICY:
默认值，如果是只执行一次的调度，使用MISFIRE_INSTRUCTION_FIRE_NOW；如果是无限次的调度，使用MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNT；否则，使用MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNT</li>
<li>MISFIRE_INSTRUCTION_IGNORE_MISFIRE_POLICY:
在资源合适的时候，重新触发所有的MisFire任务，并且不会影响现有的调度时间。比如，SimpleTrigger每15秒执行一次，而中间有5分钟时间它都MisFire了，一共错失了20个，5分钟后，假设资源充足了，并且任务允许并发，它会被一次性触发</li>
</ul>
<p>SimpleTrigger的错失策略</p>
<ul>
<li>MISFIRE_INSTRUCTION_FIRE_NOW:
忽略已经MisFire的任务，并且立即执行调度。这通常只适用于只执行一次的任务</li>
<li>MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNT:
将startTime设置当前时间，立即重新调度任务，包括的MisFire的</li>
<li>MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_REMAINING_REPEAT_COUNT:
忽略已经MisFire的任务，并将startTime设置当前时间，立即重新调度任务</li>
<li>MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNT:
忽略已经MisFire的任务，在下一次调度时间点，重新开始调度任务</li>
<li>MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_EXISTING_COUNT:
在下一次调度时间点，重新开始调度任务，包括的MisFire的</li>
<li>REPEAT_INDEFINITELY: 一直执行</li>
</ul>
<p>CronTrigger的错失策略</p>
<ul>
<li>MISFIRE_INSTRUCTION_FIRE_ONCE_NOW:
立即执行一次，然后等到下一次调度的时间点继续按触发频率执行</li>
<li>MISFIRE_INSTRUCTION_DO_NOTHING:
在下一次调度的时间点继续按触发频率执行</li>
</ul>
<h3 id="scheduler">Scheduler</h3>
<p><code>Scheduler</code>由<code>SchedulerFactory</code>创建，<code>SchedulerFactory</code>有两种实现，一种是<code>DirectSchedulerFactory</code>，可以在代码中设置<code>Scheduler</code>的各种参数；另一种是<code>StdSchdulerFactory</code>，通过读取classpath下的quartz.properties来配置<code>Scheduler</code>，如果文件不存在，则取默认值</p>
<p>一个简单的配置文件如下</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="co"># scheduler</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.scheduler.instanceName </span><span class="ot">=</span><span class="st"> DefaultQuartzScheduler</span></span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.scheduler.instanceId </span><span class="ot">=</span><span class="st"> AUTO</span></span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb417-5"><a href="#cb417-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ThreadPool</span></span>
<span id="cb417-6"><a href="#cb417-6" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.threadPool.class </span><span class="ot">=</span><span class="st"> org.quartz.simpl.SimpleThreadPool</span></span>
<span id="cb417-7"><a href="#cb417-7" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.threadPool.threadCount </span><span class="ot">=</span><span class="st"> </span><span class="dv">10</span><span class="st"> </span></span>
<span id="cb417-8"><a href="#cb417-8" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.threadPool.threadPriority </span><span class="ot">=</span><span class="st"> </span><span class="dv">5</span></span>
<span id="cb417-9"><a href="#cb417-9" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></span>
<span id="cb417-10"><a href="#cb417-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb417-11"><a href="#cb417-11" aria-hidden="true" tabindex="-1"></a><span class="co"># jobStore</span></span>
<span id="cb417-12"><a href="#cb417-12" aria-hidden="true" tabindex="-1"></a><span class="dt">org.quartz.jobStore.class </span><span class="ot">=</span><span class="st"> org.quartz.simpl.RAMJobStore</span></span></code></pre></div>
<p>Scheduler包含一个两个重要组件: JobStore和ThreadPool</p>
<p><strong>JobStore</strong></p>
<p>JobStore是会来存储运行时信息的，包括Trigger、Schduler、JobDetail、业务锁等，它有多种实现：RAMJob(内存实现)、JobStoreTX(JDBC，事务由Quartz管理）、JobStoreCMT(JDBC，使用容器事务)、ClusteredJobStore(集群实现)、TerracottaJobStore</p>
<p><strong>ThreadPool</strong></p>
<p>ThreadPool就是线程池，Quartz有自己的线程池实现。所有任务的都会由线程池执行</p>
<h3 id="其他-1">其他</h3>
<h4 id="自动设置">自动设置</h4>
<p>如果在Job中有成员变量，且设置了set方法，可以自动设置</p>
<div class="sourceCode" id="cb418"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyJob <span class="kw">implements</span> Job <span class="op">{</span></span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> jobData<span class="op">;</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setJobData</span><span class="op">(</span><span class="bu">String</span> jobData<span class="op">)</span> <span class="op">{</span></span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jobData</span> <span class="op">=</span> jobData<span class="op">;</span></span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span><span class="op">(</span>JobExecutionContext jobExecutionContext<span class="op">)</span> <span class="kw">throws</span> JobExecutionException <span class="op">{</span></span>
<span id="cb418-9"><a href="#cb418-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;jobData: &quot;</span> <span class="op">+</span> jobData<span class="op">);</span></span>
<span id="cb418-10"><a href="#cb418-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb418-11"><a href="#cb418-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用时</p>
<div class="sourceCode" id="cb419"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a>JobDetail jobDetail <span class="op">=</span> JobBuilder<span class="op">.</span><span class="fu">newJob</span><span class="op">(</span>MyJob<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;jobDetail1&quot;</span><span class="op">,</span> <span class="st">&quot;d_group1&quot;</span><span class="op">)</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">usingJobData</span><span class="op">(</span><span class="st">&quot;jobData&quot;</span><span class="op">,</span><span class="st">&quot;任务数据&quot;</span><span class="op">)</span><span class="co">//可以自动调用setJobData</span></span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span></code></pre></div>
<h4 id="joblistener">JobListener</h4>
<div class="sourceCode" id="cb420"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyJobListener <span class="kw">implements</span> JobListener <span class="op">{</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;MyJobListener&quot;</span><span class="op">;</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//执行前</span></span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">jobToBeExecuted</span><span class="op">(</span>JobExecutionContext context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb420-10"><a href="#cb420-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;正在监听&quot;</span><span class="op">+</span>context<span class="op">.</span><span class="fu">getJobDetail</span><span class="op">().</span><span class="fu">getJobClass</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb420-11"><a href="#cb420-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb420-12"><a href="#cb420-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-13"><a href="#cb420-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//JobDetail被否决，否决是由TriggerListener执行的</span></span>
<span id="cb420-14"><a href="#cb420-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb420-15"><a href="#cb420-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">jobExecutionVetoed</span><span class="op">(</span>JobExecutionContext context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb420-16"><a href="#cb420-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;jobExecutionVetoed&quot;</span><span class="op">);</span></span>
<span id="cb420-17"><a href="#cb420-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb420-18"><a href="#cb420-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-19"><a href="#cb420-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//执行完</span></span>
<span id="cb420-20"><a href="#cb420-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb420-21"><a href="#cb420-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">jobWasExecuted</span><span class="op">(</span>JobExecutionContext context<span class="op">,</span> JobExecutionException jobException<span class="op">)</span> <span class="op">{</span></span>
<span id="cb420-22"><a href="#cb420-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;完成对监听&quot;</span><span class="op">+</span>context<span class="op">.</span><span class="fu">getJobDetail</span><span class="op">().</span><span class="fu">getJobClass</span><span class="op">().</span><span class="fu">getName</span><span class="op">());</span></span>
<span id="cb420-23"><a href="#cb420-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb420-24"><a href="#cb420-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>注册</strong></p>
<p>可以给单个<code>JobDetail</code>注册监听，也可以给所有<code>JobDetail</code>注册监听</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>JobDetail jobDetail <span class="op">=</span> JobBuilder<span class="op">.</span><span class="fu">newJob</span><span class="op">(</span>MyJob<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb421-2"><a href="#cb421-2" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;jobDetail1&quot;</span><span class="op">,</span> <span class="st">&quot;d_group1&quot;</span><span class="op">)</span></span>
<span id="cb421-3"><a href="#cb421-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb421-4"><a href="#cb421-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-5"><a href="#cb421-5" aria-hidden="true" tabindex="-1"></a>Trigger trigger <span class="op">=</span> TriggerBuilder<span class="op">.</span><span class="fu">newTrigger</span><span class="op">()</span></span>
<span id="cb421-6"><a href="#cb421-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withIdentity</span><span class="op">(</span><span class="st">&quot;trigger1&quot;</span><span class="op">,</span> <span class="st">&quot;t_group1&quot;</span><span class="op">)</span></span>
<span id="cb421-7"><a href="#cb421-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">withSchedule</span><span class="op">(</span>SimpleScheduleBuilder<span class="op">.</span><span class="fu">simpleSchedule</span><span class="op">()</span></span>
<span id="cb421-8"><a href="#cb421-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withIntervalInSeconds</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb421-9"><a href="#cb421-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withRepeatCount</span><span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb421-10"><a href="#cb421-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">startNow</span><span class="op">()</span></span>
<span id="cb421-11"><a href="#cb421-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb421-12"><a href="#cb421-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-13"><a href="#cb421-13" aria-hidden="true" tabindex="-1"></a>Scheduler scheduler <span class="op">=</span> StdSchedulerFactory<span class="op">.</span><span class="fu">getDefaultScheduler</span><span class="op">();</span></span>
<span id="cb421-14"><a href="#cb421-14" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">scheduleJob</span><span class="op">(</span>jobDetail<span class="op">,</span> trigger<span class="op">);</span></span>
<span id="cb421-15"><a href="#cb421-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-16"><a href="#cb421-16" aria-hidden="true" tabindex="-1"></a>MyJobListener listener <span class="op">=</span> <span class="kw">new</span> <span class="fu">MyJobListener</span><span class="op">();</span></span>
<span id="cb421-17"><a href="#cb421-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-18"><a href="#cb421-18" aria-hidden="true" tabindex="-1"></a><span class="co">//给单个jobDetail注册一个全局的Job Listener</span></span>
<span id="cb421-19"><a href="#cb421-19" aria-hidden="true" tabindex="-1"></a><span class="co">//scheduler.getListenerManager().addJobListener(listener, KeyMatcher.keyEquals(JobKey.jobKey(&quot;jobDetail1&quot;, &quot;d_group1&quot;)));</span></span>
<span id="cb421-20"><a href="#cb421-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-21"><a href="#cb421-21" aria-hidden="true" tabindex="-1"></a><span class="co">//注册一个全局的Job Listener</span></span>
<span id="cb421-22"><a href="#cb421-22" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">getListenerManager</span><span class="op">().</span><span class="fu">addJobListener</span><span class="op">(</span>listener<span class="op">);</span></span>
<span id="cb421-23"><a href="#cb421-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb421-24"><a href="#cb421-24" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span></code></pre></div>
<p>给单个jobDetail注册时使用的Matcher除了<code>KeyMatcher</code>，还有<code>OrMatcher</code>、<code>AndMatcher</code>、<code>GroupMatcher</code>、<code>EverythingMatcher</code></p>
<h4 id="triggerlistener">TriggerListener</h4>
<div class="sourceCode" id="cb422"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyTriggerListener <span class="kw">implements</span> TriggerListener <span class="op">{</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//相当于设置触发器的名称</span></span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;MyTriggerListener&quot;</span><span class="op">;</span></span>
<span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-9"><a href="#cb422-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当与监听器相关联的Trigger被触发，即Job上的execute()方法将被执行时，Scheduler就调用该方法</span></span>
<span id="cb422-10"><a href="#cb422-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb422-11"><a href="#cb422-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">triggerFired</span><span class="op">(</span>Trigger trigger<span class="op">,</span> JobExecutionContext context<span class="op">)</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb422-12"><a href="#cb422-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-13"><a href="#cb422-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在 Trigger 触发后，Job 将要被执行时由 Scheduler 调用这个方法。TriggerListener 给了一个选择去否决 Job 的执行。假如这个方法返回 true，这个 Job 将不会为此次 Trigger 触发而得到执行</span></span>
<span id="cb422-14"><a href="#cb422-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb422-15"><a href="#cb422-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">vetoJobExecution</span><span class="op">(</span>Trigger trigger<span class="op">,</span> JobExecutionContext context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb422-16"><a href="#cb422-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb422-17"><a href="#cb422-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb422-18"><a href="#cb422-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-19"><a href="#cb422-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Scheduler 调用这个方法是在 Trigger 错过触发时。你应该关注此方法中持续时间长的逻辑：在出现许多错过触发的 Trigger 时，长逻辑会导致骨牌效应。你应当保持这上方法尽量的小</span></span>
<span id="cb422-20"><a href="#cb422-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb422-21"><a href="#cb422-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">triggerMisfired</span><span class="op">(</span>Trigger trigger<span class="op">)</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb422-22"><a href="#cb422-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-23"><a href="#cb422-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//Trigger 被触发并且完成了 Job 的执行时，Scheduler 调用这个方法</span></span>
<span id="cb422-24"><a href="#cb422-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb422-25"><a href="#cb422-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">triggerComplete</span><span class="op">(</span>Trigger trigger<span class="op">,</span> JobExecutionContext context<span class="op">,</span> Trigger<span class="op">.</span><span class="fu">CompletedExecutionInstruction</span> triggerInstructionCode<span class="op">)</span> <span class="op">{</span>  <span class="op">}</span></span>
<span id="cb422-26"><a href="#cb422-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>注册</strong></p>
<p>注册和JobListener类似</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="co">//单个</span></span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">getListenerManager</span><span class="op">().</span><span class="fu">addTriggerListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyTriggerListener</span><span class="op">(),</span>KeyMatcher<span class="op">.</span><span class="fu">keyEquals</span><span class="op">(</span>TriggerKey<span class="op">.</span><span class="fu">triggerKey</span><span class="op">(</span><span class="st">&quot;trigger&quot;</span><span class="op">,</span><span class="st">&quot;group&quot;</span><span class="op">)));</span></span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a><span class="co">//全局</span></span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">getListenerManager</span><span class="op">().</span><span class="fu">addTriggerListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MyTriggerListener</span><span class="op">());</span></span></code></pre></div>
<h4 id="schedulerlistener">SchedulerListener</h4>
<p>SchedulerListener接口定义如下</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> SchedulerListener <span class="op">{</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用于部署JobDetail时调用</span></span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobScheduled</span><span class="op">(</span>Trigger trigger<span class="op">);</span></span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用于卸载JobDetail时调用</span></span>
<span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobUnscheduled</span><span class="op">(</span>TriggerKey triggerKey<span class="op">);</span></span>
<span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当一个 Trigger 来到了再也不会触发的状态时调用这个方法。除非这个 Job 已设置成了持久性，否则它就会从 Scheduler 中移除</span></span>
<span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">triggerFinalized</span><span class="op">(</span>Trigger trigger<span class="op">);</span></span>
<span id="cb424-10"><a href="#cb424-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-11"><a href="#cb424-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当一个 Trigger 或一组 Trigger 被暂停时调用triggerPaused</span></span>
<span id="cb424-12"><a href="#cb424-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">triggerPaused</span><span class="op">(</span>TriggerKey triggerKey<span class="op">);</span></span>
<span id="cb424-13"><a href="#cb424-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-14"><a href="#cb424-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">triggersPaused</span><span class="op">(</span><span class="bu">String</span> triggerGroup<span class="op">);</span></span>
<span id="cb424-15"><a href="#cb424-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-16"><a href="#cb424-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当一个 Trigger 或一组 Trigger 从暂停中恢复时调用triggerResumed</span></span>
<span id="cb424-17"><a href="#cb424-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">triggerResumed</span><span class="op">(</span>TriggerKey triggerKey<span class="op">);</span></span>
<span id="cb424-18"><a href="#cb424-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-19"><a href="#cb424-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">triggersResumed</span><span class="op">(</span><span class="bu">String</span> triggerGroup<span class="op">);</span></span>
<span id="cb424-20"><a href="#cb424-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-21"><a href="#cb424-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobAdded</span><span class="op">(</span>JobDetail jobDetail<span class="op">);</span></span>
<span id="cb424-22"><a href="#cb424-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-23"><a href="#cb424-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobDeleted</span><span class="op">(</span>JobKey jobKey<span class="op">);</span></span>
<span id="cb424-24"><a href="#cb424-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-25"><a href="#cb424-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当一个或一组 JobDetail 暂停时调用jobPaused</span></span>
<span id="cb424-26"><a href="#cb424-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobPaused</span><span class="op">(</span>JobKey jobKey<span class="op">);</span></span>
<span id="cb424-27"><a href="#cb424-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-28"><a href="#cb424-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobsPaused</span><span class="op">(</span><span class="bu">String</span> jobGroup<span class="op">);</span></span>
<span id="cb424-29"><a href="#cb424-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-30"><a href="#cb424-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当一个或一组 Job 从暂停上恢复时调用jobResumed</span></span>
<span id="cb424-31"><a href="#cb424-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobResumed</span><span class="op">(</span>JobKey jobKey<span class="op">);</span></span>
<span id="cb424-32"><a href="#cb424-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-33"><a href="#cb424-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">jobsResumed</span><span class="op">(</span><span class="bu">String</span> jobGroup<span class="op">);</span></span>
<span id="cb424-34"><a href="#cb424-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-35"><a href="#cb424-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerError</span><span class="op">(</span><span class="bu">String</span> msg<span class="op">,</span> SchedulerException cause<span class="op">);</span></span>
<span id="cb424-36"><a href="#cb424-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-37"><a href="#cb424-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当Scheduler处于StandBy模式时，调用该方法</span></span>
<span id="cb424-38"><a href="#cb424-38" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerInStandbyMode</span><span class="op">();</span></span>
<span id="cb424-39"><a href="#cb424-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-40"><a href="#cb424-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当Scheduler 开启时，调用该方法</span></span>
<span id="cb424-41"><a href="#cb424-41" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerStarted</span><span class="op">();</span></span>
<span id="cb424-42"><a href="#cb424-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-43"><a href="#cb424-43" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerStarting</span><span class="op">();</span></span>
<span id="cb424-44"><a href="#cb424-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-45"><a href="#cb424-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当Scheduler停止时，调用该方法</span></span>
<span id="cb424-46"><a href="#cb424-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerShutdown</span><span class="op">();</span></span>
<span id="cb424-47"><a href="#cb424-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-48"><a href="#cb424-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulerShuttingdown</span><span class="op">();</span></span>
<span id="cb424-49"><a href="#cb424-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-50"><a href="#cb424-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">//当Scheduler中的数据被清除时，调用该方法</span></span>
<span id="cb424-51"><a href="#cb424-51" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">schedulingDataCleared</span><span class="op">();</span></span>
<span id="cb424-52"><a href="#cb424-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>注册</strong></p>
<p>注册和前面的一样，但是<code>Scheduler</code>只有一个，所以没有区分单个和全局</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a>scheduler<span class="op">.</span><span class="fu">getListenerManager</span><span class="op">().</span><span class="fu">addSchedulerListener</span><span class="op">(</span><span class="kw">new</span> <span class="fu">MySchedulerListener</span><span class="op">());</span></span></code></pre></div>
<h2 id="mycat">MyCat</h2>
<p><a href="http://mycat.io/">Mycat官网</a></p>
<p>Mycat是一个数据库分库分表中间件，通过Mycat连接MySql，能够把分布在不同服务器上的数据库虚拟成一个数据库，这样在代码中可以以访问一个数据库的方式来访问分布式的数据库，这样对于业务的升级，可以减少代码的修改量</p>
<h3 id="安装-1">安装</h3>
<p>安装JDK并配置环境变量（MyCat依赖JDK）</p>
<pre class="shell"><code>vim ~/.profile</code></pre>
<div class="sourceCode" id="cb427"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="dt">JAVA_HOME</span><span class="ot">=</span><span class="st">/usr/lib/jdk1.8.0_101</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CLASSPATH</span><span class="ot">=</span><span class="st">.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar </span></span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="dt">PATH</span><span class="ot">=</span><span class="st">$JAVA_HOME/bin:$HOME/bin:$HOME/.local/bin:$PATH</span></span></code></pre></div>
<pre class="shell"><code>source ~/.profile</code></pre>
<p>启动mysql<code>service mysql start</code></p>
<p><strong>mycat</strong></p>
<p>下载、解压</p>
<pre class="shell"><code>wget http://dl.mycat.io/1.6.5/Mycat-server-1.6.5-release-20180122220033-linux.tar.gz
tar -zxvf Mycat-server-1.6.5-release-20180122220033-linux.tar.gz
mv mycat /usr/local/</code></pre>
<p>配置启动参数</p>
<pre class="shell"><code>vim wrapper.conf</code></pre>
<p>添加mycat用户组</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="ex">groupadd</span> mycat</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a><span class="ex">adduser</span> <span class="at">-r</span> <span class="at">-g</span> mycat mycat</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a><span class="fu">passwd</span> mycat</span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> <span class="at">-R</span> mycat.mycat /usr/local/mycat  //修改mycat目录所属mycat用户</span></code></pre></div>
<p>在schema.xml中设置mysql的地址、用户名和密码</p>
<div class="sourceCode" id="cb432"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;hostM1&quot;</span><span class="ot"> url=</span><span class="st">&quot;localhost:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;root&quot;</span>&gt;</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">readHost</span><span class="ot"> host=</span><span class="st">&quot;hostS1&quot;</span><span class="ot"> url=</span><span class="st">&quot;localhost:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;root&quot;</span> /&gt;</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">writeHost</span>&gt;</span></code></pre></div>
<p>在server.xml中设置mycat的用户名密码</p>
<div class="sourceCode" id="cb433"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;root&quot;</span>&gt;</span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a>   &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;123456&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a>   &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;schemas&quot;</span>&gt;testdb&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">user</span>&gt;</span></code></pre></div>
<p>启动mycat、连接mycat</p>
<pre class="shell"><code>/usr/local/mycat/bin/mycat start
mysql -uroot -p123456 -h127.0.0.1 -P8066 -Dtestdb</code></pre>
<h3 id="配置-2">配置</h3>
<h4 id="server.xml">server.xml</h4>
<p>用于配置系统参数、防火墙、用户信息</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mycat:server</span> SYSTEM &quot;server.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mycat:server</span><span class="ot"> xmlns:mycat=</span><span class="st">&quot;http://io.mycat/&quot;</span>&gt;</span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">system</span>&gt;</span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;nonePasswordLogin&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt; <span class="co">&lt;!-- 0为需要密码登陆、1为不需要密码登陆 ,默认为0，设置为1则需要指定默认账户--&gt;</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useHandshakeV10&quot;</span>&gt;1&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useSqlStat&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;  <span class="co">&lt;!-- 1为开启实时统计、0为关闭 --&gt;</span></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useGlobleTableCheck&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;  <span class="co">&lt;!-- 1为开启全局一致性检测、0为关闭 --&gt;</span></span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 全局序列号</span></span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a><span class="co">        0表示使用本地文件方式，需配置sequence_conf.properties文件</span></span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a><span class="co">        1表示数据库方式，此时需要配置数据库和sequence_db_conf.properties文件</span></span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a><span class="co">        2表示本地时间戳方式，需配置sequence_time_conf.properties文件</span></span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a><span class="co">        3表示使用分布式ZK ID生成器，需配置sequence_distributed_conf.properties文件，ZK的连接信息统一在myid.properties的zkURL属性中配置</span></span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a><span class="co">        4表示使用Zk递增方式，需配置sequence_conf.properties文件，ZK的连接信息统一在myid.properties的zkURL属性中配置</span></span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb435-17"><a href="#cb435-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sequnceHandlerType&quot;</span>&gt;2&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-18"><a href="#cb435-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-19"><a href="#cb435-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;subqueryRelationshipCheck&quot;</span>&gt;false&lt;/<span class="kw">property</span>&gt; <span class="co">&lt;!-- 子查询中存在关联查询的情况下,检查关联字段中是否有分片字段 .默认 false --&gt;</span></span>
<span id="cb435-20"><a href="#cb435-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--  &lt;property name=&quot;useCompression&quot;&gt;1&lt;/property&gt;--&gt;</span> <span class="co">&lt;!--1为开启mysql压缩协议--&gt;</span></span>
<span id="cb435-21"><a href="#cb435-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--  &lt;property name=&quot;fakeMySQLVersion&quot;&gt;5.6.20&lt;/property&gt;--&gt;</span> <span class="co">&lt;!--设置模拟的MySQL版本号--&gt;</span></span>
<span id="cb435-22"><a href="#cb435-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- &lt;property name=&quot;processorBufferChunk&quot;&gt;40960&lt;/property&gt; --&gt;</span></span>
<span id="cb435-23"><a href="#cb435-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- </span></span>
<span id="cb435-24"><a href="#cb435-24" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;processors&quot;&gt;1&lt;/property&gt; </span></span>
<span id="cb435-25"><a href="#cb435-25" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;processorExecutor&quot;&gt;32&lt;/property&gt; </span></span>
<span id="cb435-26"><a href="#cb435-26" aria-hidden="true" tabindex="-1"></a><span class="co">         --&gt;</span></span>
<span id="cb435-27"><a href="#cb435-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--默认为type 0: DirectByteBufferPool | type 1 ByteBufferArena | type 2 NettyBufferPool --&gt;</span></span>
<span id="cb435-28"><a href="#cb435-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;processorBufferPoolType&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-29"><a href="#cb435-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--默认是65535 64K 用于sql解析时最大文本长度 --&gt;</span></span>
<span id="cb435-30"><a href="#cb435-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;maxStringLiteralLength&quot;&gt;65535&lt;/property&gt;--&gt;</span></span>
<span id="cb435-31"><a href="#cb435-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;sequnceHandlerType&quot;&gt;0&lt;/property&gt;--&gt;</span></span>
<span id="cb435-32"><a href="#cb435-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;backSocketNoDelay&quot;&gt;1&lt;/property&gt;--&gt;</span></span>
<span id="cb435-33"><a href="#cb435-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;frontSocketNoDelay&quot;&gt;1&lt;/property&gt;--&gt;</span></span>
<span id="cb435-34"><a href="#cb435-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;processorExecutor&quot;&gt;16&lt;/property&gt;--&gt;</span></span>
<span id="cb435-35"><a href="#cb435-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- MyCat的服务端口及管理端口，如果不配置，就默认是8066和9066 --&gt;</span></span>
<span id="cb435-36"><a href="#cb435-36" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;serverPort&quot;</span>&gt;8066&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-37"><a href="#cb435-37" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;managerPort&quot;</span>&gt;9066&lt;/<span class="kw">property</span>&gt; </span>
<span id="cb435-38"><a href="#cb435-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--</span></span>
<span id="cb435-39"><a href="#cb435-39" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;idleTimeout&quot;&gt;300000&lt;/property&gt;</span></span>
<span id="cb435-40"><a href="#cb435-40" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;bindIp&quot;&gt;0.0.0.0&lt;/property&gt; </span></span>
<span id="cb435-41"><a href="#cb435-41" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;frontWriteQueueSize&quot;&gt;4096&lt;/property&gt;</span></span>
<span id="cb435-42"><a href="#cb435-42" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;property name=&quot;processors&quot;&gt;32&lt;/property&gt;</span></span>
<span id="cb435-43"><a href="#cb435-43" aria-hidden="true" tabindex="-1"></a><span class="co">        --&gt;</span></span>
<span id="cb435-44"><a href="#cb435-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--分布式事务开关，0为不过滤分布式事务，1为过滤分布式事务（如果分布式事务内只涉及全局表，则不过滤），2为不过滤分布式事务,但是记录分布式事务日志--&gt;</span></span>
<span id="cb435-45"><a href="#cb435-45" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;handleDistributedTransactions&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-46"><a href="#cb435-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-47"><a href="#cb435-47" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useOffHeapForMerge&quot;</span>&gt;1&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- off heap for merge/order/group/limit  1开启 0关闭 --&gt;</span></span>
<span id="cb435-48"><a href="#cb435-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-49"><a href="#cb435-49" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;memoryPageSize&quot;</span>&gt;64k&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 默认单位为m --&gt;</span></span>
<span id="cb435-50"><a href="#cb435-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-51"><a href="#cb435-51" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;spillsFileBufferSize&quot;</span>&gt;1k&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 默认单位为k --&gt;</span></span>
<span id="cb435-52"><a href="#cb435-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-53"><a href="#cb435-53" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useStreamOutput&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-54"><a href="#cb435-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-55"><a href="#cb435-55" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;systemReserveMemorySize&quot;</span>&gt;384m&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 默认单位为m --&gt;</span></span>
<span id="cb435-56"><a href="#cb435-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-57"><a href="#cb435-57" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useZKSwitch&quot;</span>&gt;false&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 是否采用zookeeper协调切换 --&gt;</span></span>
<span id="cb435-58"><a href="#cb435-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-59"><a href="#cb435-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;XARecoveryLogBaseDir&quot;&gt;./&lt;/property&gt;--&gt;&lt;!-- XA Recovery Log日志路径 --&gt;</span></span>
<span id="cb435-60"><a href="#cb435-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;property name=&quot;XARecoveryLogBaseName&quot;&gt;tmlog&lt;/property&gt;--&gt;&lt;!-- XA Recovery Log日志名称 --&gt;</span></span>
<span id="cb435-61"><a href="#cb435-61" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">system</span>&gt;</span>
<span id="cb435-62"><a href="#cb435-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb435-63"><a href="#cb435-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 全局SQL防火墙设置 --&gt;</span></span>
<span id="cb435-64"><a href="#cb435-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--白名单可以使用通配符%或者*--&gt;</span></span>
<span id="cb435-65"><a href="#cb435-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--例如&lt;host host=&quot;127.0.0.*&quot; user=&quot;root&quot;/&gt;--&gt;</span></span>
<span id="cb435-66"><a href="#cb435-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--例如&lt;host host=&quot;127.0.*&quot; user=&quot;root&quot;/&gt;--&gt;</span></span>
<span id="cb435-67"><a href="#cb435-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--例如&lt;host host=&quot;127.*&quot; user=&quot;root&quot;/&gt;--&gt;</span></span>
<span id="cb435-68"><a href="#cb435-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--例如&lt;host host=&quot;1*7.*&quot; user=&quot;root&quot;/&gt;--&gt;</span></span>
<span id="cb435-69"><a href="#cb435-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--这些配置情况下对于127.0.0.1都能以root账户登录--&gt;</span></span>
<span id="cb435-70"><a href="#cb435-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb435-71"><a href="#cb435-71" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;firewall&gt;</span></span>
<span id="cb435-72"><a href="#cb435-72" aria-hidden="true" tabindex="-1"></a><span class="co">       &lt;whitehost&gt;</span></span>
<span id="cb435-73"><a href="#cb435-73" aria-hidden="true" tabindex="-1"></a><span class="co">          &lt;host host=&quot;1*7.0.0.*&quot; user=&quot;root&quot;/&gt;</span></span>
<span id="cb435-74"><a href="#cb435-74" aria-hidden="true" tabindex="-1"></a><span class="co">       &lt;/whitehost&gt;</span></span>
<span id="cb435-75"><a href="#cb435-75" aria-hidden="true" tabindex="-1"></a><span class="co">       &lt;blacklist check=&quot;true&quot;&gt;</span></span>
<span id="cb435-76"><a href="#cb435-76" aria-hidden="true" tabindex="-1"></a><span class="co">           &lt;property name=&quot;selelctAllow&quot;&gt;false&lt;/property&gt;</span></span>
<span id="cb435-77"><a href="#cb435-77" aria-hidden="true" tabindex="-1"></a><span class="co">       &lt;/blacklist&gt;</span></span>
<span id="cb435-78"><a href="#cb435-78" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/firewall&gt;</span></span>
<span id="cb435-79"><a href="#cb435-79" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb435-80"><a href="#cb435-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-81"><a href="#cb435-81" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;root&quot;</span><span class="ot"> defaultAccount=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb435-82"><a href="#cb435-82" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;123456&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-83"><a href="#cb435-83" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;schemas&quot;</span>&gt;testdb&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-84"><a href="#cb435-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-85"><a href="#cb435-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 表级 DML 权限设置 --&gt;</span></span>
<span id="cb435-86"><a href="#cb435-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--        </span></span>
<span id="cb435-87"><a href="#cb435-87" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;privileges check=&quot;false&quot;&gt;</span></span>
<span id="cb435-88"><a href="#cb435-88" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;schema name=&quot;TESTDB&quot; dml=&quot;0110&quot; &gt;</span></span>
<span id="cb435-89"><a href="#cb435-89" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;table name=&quot;tb01&quot; dml=&quot;0000&quot;&gt;&lt;/table&gt;</span></span>
<span id="cb435-90"><a href="#cb435-90" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;table name=&quot;tb02&quot; dml=&quot;1111&quot;&gt;&lt;/table&gt;</span></span>
<span id="cb435-91"><a href="#cb435-91" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;/schema&gt;</span></span>
<span id="cb435-92"><a href="#cb435-92" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/privileges&gt;       </span></span>
<span id="cb435-93"><a href="#cb435-93" aria-hidden="true" tabindex="-1"></a><span class="co">         --&gt;</span></span>
<span id="cb435-94"><a href="#cb435-94" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">user</span>&gt;</span>
<span id="cb435-95"><a href="#cb435-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-96"><a href="#cb435-96" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;user&quot;</span>&gt;</span>
<span id="cb435-97"><a href="#cb435-97" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;user&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-98"><a href="#cb435-98" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;schemas&quot;</span>&gt;testdb&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-99"><a href="#cb435-99" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;readOnly&quot;</span>&gt;true&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb435-100"><a href="#cb435-100" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">user</span>&gt;</span>
<span id="cb435-101"><a href="#cb435-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-102"><a href="#cb435-102" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mycat:server</span>&gt;</span></code></pre></div>
<h5 id="user配置">user配置</h5>
<p>配置用户名、密码、可访问的表（逻辑表）</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;test&quot;</span>&gt;</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;123456&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;schemas&quot;</span>&gt;testdb&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 用户可访问的表 --&gt;</span></span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--&lt;property name=&quot;schemas&quot;&gt;db1,db2,db3&lt;/property&gt;--&gt;&lt;!-- 多个表用逗号分隔 --&gt;</span></span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;readOnly&quot;</span>&gt;false&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">user</span>&gt;</span></code></pre></div>
<p>给每个 数据库/表 配置具体权限</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;test&quot;</span>&gt;</span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;123456&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 给每个 数据库/表 配置具体权限 --&gt;</span></span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">privileges</span><span class="ot"> check=</span><span class="st">&quot;false&quot;</span>&gt;</span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- dml四个数字分别代表insert、update、select、delete权限 --&gt;</span></span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">schema</span><span class="ot"> name=</span><span class="st">&quot;testdb&quot;</span><span class="ot"> dml=</span><span class="st">&quot;0110&quot;</span> &gt;</span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;tb01&quot;</span><span class="ot"> dml=</span><span class="st">&quot;0010&quot;</span>&gt;&lt;/<span class="kw">table</span>&gt;</span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!-- 如果表不配置权限，则使用数据库的权限 --&gt;</span></span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;tb02&quot;</span>&gt;&lt;/<span class="kw">table</span>&gt;</span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">schema</span>&gt;</span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">privileges</span>&gt;</span>
<span id="cb437-12"><a href="#cb437-12" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">user</span>&gt;</span></code></pre></div>
<p>密码可以加密存储，可以通过<code>java -cp Mycat-server-1.6.5-release.jar io.mycat.util.DecryptUtil 0:test:123456</code>生成密码，命令中的<code>0:test:123456</code>，0表示通过前端应用进行加密，test为用户名，123456为密码</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;test&quot;</span>&gt;</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;usingDecrypt&quot;</span>&gt;1&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 使用加密 --&gt;</span></span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;F8VKn5UHlz5J3pPQSEL/xQiTh9HmKvgd94MOxfPGcvhv1gbrSB8Iw7Hh8eHfS5NlFB2K81UnxOLotNF9ATkYKA==&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">user</span>&gt;</span></code></pre></div>
<h5 id="防火墙配置">防火墙配置</h5>
<p>SQL配置</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 6%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr>
<th>配置项</th>
<th>缺省值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>selelctAllow</td>
<td>true</td>
<td>是否允许执行</td>
</tr>
<tr>
<td>selectAllColumnAllow</td>
<td>true</td>
<td>是否允许执行<code>SELECT * FROM T</code>这样的语句。如果设置为false，不允许执行<code>select * from t</code>，但<code>select * from (select id, name from t) a</code>。这个选项是防御程序通过调用<code>select *</code>获得数据表的结构信息</td>
</tr>
<tr>
<td>selectIntoAllow</td>
<td>true</td>
<td>SELECT查询中是否允许INTO字句</td>
</tr>
<tr>
<td>deleteAllow</td>
<td>true</td>
<td>是否允许执行DELETE语句</td>
</tr>
<tr>
<td>updateAllow</td>
<td>true</td>
<td>是否允许执行UPDATE语句</td>
</tr>
<tr>
<td>insertAllow</td>
<td>true</td>
<td>是否允许执行INSERT语句</td>
</tr>
<tr>
<td>replaceAllow</td>
<td>true</td>
<td>是否允许执行REPLACE语句</td>
</tr>
<tr>
<td>mergeAllow</td>
<td>true</td>
<td>是否允许执行MERGE语句，这个只在Oracle中有用</td>
</tr>
<tr>
<td>callAllow</td>
<td>true</td>
<td>是否允许通过jdbc的call语法调用存储过程</td>
</tr>
<tr>
<td>setAllow</td>
<td>true</td>
<td>是否允许使用SET语法</td>
</tr>
<tr>
<td>truncateAllow</td>
<td>true</td>
<td>truncate语句是危险，缺省打开，若需要自行关闭</td>
</tr>
<tr>
<td>createTableAllow</td>
<td>true</td>
<td>是否允许创建表</td>
</tr>
<tr>
<td>alterTableAllow</td>
<td>true</td>
<td>是否允许执行Alter Table语句</td>
</tr>
<tr>
<td>dropTableAllow</td>
<td>true</td>
<td>是否允许修改表</td>
</tr>
<tr>
<td>commentAllow</td>
<td>false</td>
<td>是否允许语句中存在注释，Oracle 的用户不用担心，Wall 能够识别
hints和注释的区别</td>
</tr>
<tr>
<td>noneBaseStatementAllow</td>
<td>false</td>
<td>是否允许非以上基本语句的其他语句，缺省关闭，通过这个选项就能够屏蔽
DDL</td>
</tr>
<tr>
<td>multiStatementAllow</td>
<td>false</td>
<td>是否允许一次执行多条语句，缺省关闭</td>
</tr>
<tr>
<td>useAllow</td>
<td>true</td>
<td>是否允许执行mysql的use语句，缺省打开</td>
</tr>
<tr>
<td>describeAllow</td>
<td>true</td>
<td>是否允许执行mysql的describe语句，缺省打开</td>
</tr>
<tr>
<td>showAllow</td>
<td>true</td>
<td>是否允许执行mysql的show语句，缺省打开</td>
</tr>
<tr>
<td>commitAllow</td>
<td>true</td>
<td>是否允许执行commit操作</td>
</tr>
<tr>
<td>rollbackAllow</td>
<td>true</td>
<td>是否允许执行roll back操作</td>
</tr>
</tbody>
</table>
<p>如果把
selectIntoAllow、deleteAllow、updateAllow、insertAllow、mergeAllow
都设置为 false，这就是一 个只读数据源了</p>
<p>拦截配置－永真条件</p>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 6%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr>
<th>配置项</th>
<th>缺省值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>selectWhereAlwayTrueCheck</td>
<td>true</td>
<td>检查 SELECT 语句的 WHERE 子句是否是一个永真条件</td>
</tr>
<tr>
<td>selectHavingAlwayTrueCheck</td>
<td>true</td>
<td>检查 SELECT 语句的 HAVING 子句是否是一个永真条件</td>
</tr>
<tr>
<td>deleteWhereAlwayTrueCheck</td>
<td>true</td>
<td>检查 DELETE 语句的 WHERE 子句是否是一个永真条件</td>
</tr>
<tr>
<td>deleteWhereNoneCheck</td>
<td>false</td>
<td>检查 DELETE 语句是否无 where 条件，这是有风险的，但不是 SQL
注入类型的风险</td>
</tr>
<tr>
<td>updateWhereAlayTrueCheck</td>
<td>true</td>
<td>检查 UPDATE 语句的 WHERE 子句是否是一个永真条件</td>
</tr>
<tr>
<td>updateWhereNoneCheck</td>
<td>false</td>
<td>检查 UPDATE 语句是否无 where 条件，这是有风险的，但不是SQL
注入类型的风险</td>
</tr>
<tr>
<td>conditionAndAlwayTrueAllow</td>
<td>false</td>
<td>检查查询条件(WHERE/HAVING 子句)中是否包含 AND 永真条件</td>
</tr>
<tr>
<td>conditionAndAlwayFalseAllow</td>
<td>false</td>
<td>检查查询条件(WHERE/HAVING 子句)中是否包含 AND 永假条件</td>
</tr>
<tr>
<td>conditionLikeTrueAllow</td>
<td>true</td>
<td>检查查询条件(WHERE/HAVING 子句)中是否包含 LIKE 永真条件</td>
</tr>
</tbody>
</table>
<p>其他拦截配置</p>
<table>
<colgroup>
<col style="width: 27%" />
<col style="width: 6%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>配置项</th>
<th>缺省值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>selectIntoOutfileAllow</td>
<td>false</td>
<td><code>SELECT...INTO OUTFILE</code>是否允许，这个是mysql注入攻击的常见手段，缺省是禁止的</td>
</tr>
<tr>
<td>selectUnionCheck</td>
<td>true</td>
<td>检测SELECT UNION</td>
</tr>
<tr>
<td>selectMinusCheck</td>
<td>true</td>
<td>检测SELECT MINUS</td>
</tr>
<tr>
<td>selectExceptCheck</td>
<td>true</td>
<td>检测SELECT EXCEPT</td>
</tr>
<tr>
<td>selectIntersectCheck</td>
<td>true</td>
<td>检测SELECT INTERSECT</td>
</tr>
<tr>
<td>mustParameterized</td>
<td>false</td>
<td>是否必须参数化，如果为true，则不允许类似<code>WHERE ID = 1</code>这种不参数化的SQL</td>
</tr>
<tr>
<td>strictSyntaxCheck</td>
<td>true</td>
<td>是否进行严格的语法检测，Druid SQL
Parser在某些场景不能覆盖所有的SQL语法，出现解析SQL出错，可以临时把这个选项设置为false，同时把SQL反馈给Druid的开发者。</td>
</tr>
<tr>
<td>conditionOpXorAllow</td>
<td>false</td>
<td>查询条件中是否允许有XOR条件。XOR不常用，很难判断永真或者永假，缺省不允许。</td>
</tr>
<tr>
<td>conditionOpBitwseAllow</td>
<td>true</td>
<td>查询条件中是否允许有”&amp;“、”~“、”</td>
</tr>
<tr>
<td>conditionDoubleConstAllow</td>
<td>false</td>
<td>查询条件中是否允许连续两个常量运算表达式</td>
</tr>
<tr>
<td>minusAllow</td>
<td>true</td>
<td>是否允许<code>SELECT * FROM A MINUS SELECT * FROM B</code>这样的语句</td>
</tr>
<tr>
<td>intersectAllow</td>
<td>true</td>
<td>是否允许<code>SELECT * FROM A INTERSECT SELECT * FROM B</code>这样的语句</td>
</tr>
<tr>
<td>constArithmeticAllow</td>
<td>true</td>
<td>拦截常量运算的条件，比如说<code>WHERE FID = 3 - 1</code>，其中”3 -
1”是常量运算表达式</td>
</tr>
<tr>
<td>limitZeroAllow</td>
<td>false</td>
<td>是否允许<code>limit 0</code>这样的语句</td>
</tr>
<tr>
<td>tableCheck</td>
<td>true</td>
<td>检测是否使用了禁用的表</td>
</tr>
<tr>
<td>schemaCheck</td>
<td>true</td>
<td>检测是否使用了禁用的 Schema</td>
</tr>
<tr>
<td>functionCheck</td>
<td>true</td>
<td>检测是否使用了禁用的函数</td>
</tr>
<tr>
<td>objectCheck</td>
<td>true</td>
<td>检测是否使用了“禁用对对象”</td>
</tr>
<tr>
<td>variantCheck</td>
<td>true</td>
<td>检测是否使用了“禁用的变量”</td>
</tr>
<tr>
<td>readOnlyTables</td>
<td>空</td>
<td>指定的表只读，不能够在 SELECT
INTO、DELETE、UPDATE、INSERT、MERGE</td>
</tr>
</tbody>
</table>
<h5 id="拦截器">拦截器</h5>
<p>拦截器并不是用于拦截SQL，而是用于记录SQL，以进行日志分析（如果使用MySql的日志记录，会导致日志分布在各个MySql服务器上，不方便统一管理），真正要拦截SQL应该在防火墙中设置</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">system</span>&gt; </span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sqlInterceptor&quot;</span>&gt;</span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a>        io.mycat.server.interceptor.impl.StatisticsSqlInterceptor</span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt; </span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sqlInterceptorType&quot;</span>&gt;</span>
<span id="cb439-6"><a href="#cb439-6" aria-hidden="true" tabindex="-1"></a>        update，insert，delete</span>
<span id="cb439-7"><a href="#cb439-7" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">property</span>&gt; </span>
<span id="cb439-8"><a href="#cb439-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sqlInterceptorFile&quot;</span>&gt;/tmp/sql.txt&lt;/<span class="kw">property</span>&gt; </span>
<span id="cb439-9"><a href="#cb439-9" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">system</span>&gt;</span></code></pre></div>
<p>update、insert、delete的SQL就会被记录到<code>/tmp/sql.txt</code>中</p>
<h5 id="全局序列号">全局序列号</h5>
<p>如果使用水平分片，MySql的<code>AUTO_INCREMENT</code>无法满足在分布式的情况下保持主键的唯一性，这时可以使用MyCat提供的生成全局序列号的功能</p>
<p>全局序列号的生成方式有多种，可以通过<code>sequnceHandlerType</code>指定</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sequnceHandlerType&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span></code></pre></div>
<p>然后在schema.xml的<code>table</code>中使用<code>autoIncrement=&quot;true&quot;</code>让全局序列生效，此时该<code>table</code>的主键由MyCat生成</p>
<ul>
<li>0表示使用本地文件方式，需配置<code>sequence_conf.properties</code>文件</li>
</ul>
<div class="sourceCode" id="cb441"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb441-1"><a href="#cb441-1" aria-hidden="true" tabindex="-1"></a><span class="co">#default global sequence</span></span>
<span id="cb441-2"><a href="#cb441-2" aria-hidden="true" tabindex="-1"></a><span class="dt">GLOBAL.HISIDS</span><span class="ot">=</span></span>
<span id="cb441-3"><a href="#cb441-3" aria-hidden="true" tabindex="-1"></a><span class="dt">GLOBAL.MINID</span><span class="ot">=</span><span class="dv">10001</span></span>
<span id="cb441-4"><a href="#cb441-4" aria-hidden="true" tabindex="-1"></a><span class="dt">GLOBAL.MAXID</span><span class="ot">=</span><span class="dv">20000</span></span>
<span id="cb441-5"><a href="#cb441-5" aria-hidden="true" tabindex="-1"></a><span class="dt">GLOBAL.CURID</span><span class="ot">=</span><span class="dv">10000</span></span>
<span id="cb441-6"><a href="#cb441-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb441-7"><a href="#cb441-7" aria-hidden="true" tabindex="-1"></a><span class="co"># self define sequence</span></span>
<span id="cb441-8"><a href="#cb441-8" aria-hidden="true" tabindex="-1"></a><span class="dt">MY_TABLE.HISIDS</span><span class="ot">=</span></span>
<span id="cb441-9"><a href="#cb441-9" aria-hidden="true" tabindex="-1"></a><span class="dt">MY_TABLE.MINID</span><span class="ot">=</span><span class="dv">1001</span></span>
<span id="cb441-10"><a href="#cb441-10" aria-hidden="true" tabindex="-1"></a><span class="dt">MY_TABLE.MAXID</span><span class="ot">=</span><span class="dv">2000</span></span>
<span id="cb441-11"><a href="#cb441-11" aria-hidden="true" tabindex="-1"></a><span class="dt">MY_TABLE.CURID</span><span class="ot">=</span><span class="dv">1000</span></span></code></pre></div>
<blockquote>
<p>HISIDS: 表示使用过的历史分段(一般无特殊需要可不配置)</p>
<p>MINID: 最小ID值</p>
<p>MAXID: 表示最大ID值</p>
<p>CURID 表示当前ID 值</p>
</blockquote>
<p>当<code>sequence_conf.properties</code>的配置名字与表名一致的时候sql可以不包含ID字段（此处表名为<code>MY_TABLE</code>）</p>
<p>缺点：</p>
<ol type="1">
<li><p>mycat重新发布时，seq文件需要替换，集群部署无法用此方式，路由到不同的mycat上无法保证id唯一</p></li>
<li><p>使mycat变成了有状态的中间件</p></li>
</ol>
<ul>
<li>1表示数据库方式，此时需要配置数据库和<code>sequence_db_conf.properties</code>文件</li>
</ul>
<p>原理是在数据库中建立一张表，存放sequence名称(name)，sequence当前值(current_value)，步长(increment)等信息</p>
<p>sequence_db_conf.properties：</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sequence stored in datanode</span></span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a><span class="co"># MY_TABLE是表名，要和插入的序列名一致，必须大写</span></span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a><span class="dt">MY_TABLE</span><span class="ot">=</span><span class="st">node1</span></span></code></pre></div>
<p>MY_TABLE是使用该序列的逻辑表的表名（表示该表的主键使用该序列生成），要和后面插入的序列名一致，node1是schema.xml中配置的<code>dataNode</code>的<code>name</code></p>
<p>schema.xml：</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">schema</span><span class="ot"> name=</span><span class="st">&quot;TESTDB&quot;</span><span class="ot"> checkSQLschema=</span><span class="st">&quot;false&quot;</span><span class="ot"> sqlMaxLimit=</span><span class="st">&quot;100&quot;</span>&gt;</span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 这里要使用autoIncrement=&quot;true&quot; --&gt;</span></span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;my_table&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;node1&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;id&quot;</span><span class="ot"> autoIncrement=</span><span class="st">&quot;true&quot;</span><span class="ot"> rule=</span><span class="st">&quot;my_rule&quot;</span> /&gt;</span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">schema</span>&gt;</span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;node1&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;localhost1&quot;</span><span class="ot"> database=</span><span class="st">&quot;MY_DB&quot;</span> /&gt;</span></code></pre></div>
<p>在该<code>dataNode</code>对应的主机的对应的数据库中导入mycat安装包下<code>conf/dbseq.sql</code>文件，创建存放序列的表和用于生成序列的函数，该文件内容如下：</p>
<div class="sourceCode" id="cb444"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a># 创建用于存储序列信息的表</span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> MYCAT_SEQUENCE;</span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> MYCAT_SEQUENCE (  name <span class="dt">VARCHAR</span>(<span class="dv">64</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,  current_value BIGINT(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,  <span class="kw">increment</span> <span class="dt">INT</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="dv">1</span>, <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (name) ) ENGINE<span class="op">=</span>InnoDB;</span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-5"><a href="#cb444-5" aria-hidden="true" tabindex="-1"></a># 创建存储函数，用于生成序列</span>
<span id="cb444-6"><a href="#cb444-6" aria-hidden="true" tabindex="-1"></a># 获取当前sequence的值（返回当前值,增量）</span>
<span id="cb444-7"><a href="#cb444-7" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> `mycat_seq_currval`;</span>
<span id="cb444-8"><a href="#cb444-8" aria-hidden="true" tabindex="-1"></a>DELIMITER ;;</span>
<span id="cb444-9"><a href="#cb444-9" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> `mycat_seq_currval`(seq_name <span class="dt">VARCHAR</span>(<span class="dv">64</span>)) RETURNS <span class="dt">varchar</span>(<span class="dv">64</span>) CHARSET latin1</span>
<span id="cb444-10"><a href="#cb444-10" aria-hidden="true" tabindex="-1"></a>    DETERMINISTIC</span>
<span id="cb444-11"><a href="#cb444-11" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb444-12"><a href="#cb444-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> retval <span class="dt">VARCHAR</span>(<span class="dv">64</span>);</span>
<span id="cb444-13"><a href="#cb444-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> retval<span class="op">=</span><span class="ot">&quot;-1,0&quot;</span>;</span>
<span id="cb444-14"><a href="#cb444-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">concat</span>(<span class="fu">CAST</span>(current_value <span class="kw">AS</span> <span class="dt">CHAR</span>),<span class="ot">&quot;,&quot;</span>,<span class="fu">CAST</span>(<span class="kw">increment</span> <span class="kw">AS</span> <span class="dt">CHAR</span>) ) <span class="kw">INTO</span> retval <span class="kw">FROM</span> MYCAT_SEQUENCE  <span class="kw">WHERE</span> name <span class="op">=</span> seq_name;</span>
<span id="cb444-15"><a href="#cb444-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> retval ;</span>
<span id="cb444-16"><a href="#cb444-16" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb444-17"><a href="#cb444-17" aria-hidden="true" tabindex="-1"></a>;;</span>
<span id="cb444-18"><a href="#cb444-18" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb444-19"><a href="#cb444-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-20"><a href="#cb444-20" aria-hidden="true" tabindex="-1"></a># 获取下一个sequence值</span>
<span id="cb444-21"><a href="#cb444-21" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> `mycat_seq_nextval`;</span>
<span id="cb444-22"><a href="#cb444-22" aria-hidden="true" tabindex="-1"></a>DELIMITER ;;</span>
<span id="cb444-23"><a href="#cb444-23" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> `mycat_seq_nextval`(seq_name <span class="dt">VARCHAR</span>(<span class="dv">64</span>)) RETURNS <span class="dt">varchar</span>(<span class="dv">64</span>) CHARSET latin1</span>
<span id="cb444-24"><a href="#cb444-24" aria-hidden="true" tabindex="-1"></a>    DETERMINISTIC</span>
<span id="cb444-25"><a href="#cb444-25" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb444-26"><a href="#cb444-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> retval <span class="dt">VARCHAR</span>(<span class="dv">64</span>);</span>
<span id="cb444-27"><a href="#cb444-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> val BIGINT;</span>
<span id="cb444-28"><a href="#cb444-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> inc <span class="dt">INT</span>;</span>
<span id="cb444-29"><a href="#cb444-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> seq_lock <span class="dt">INT</span>;</span>
<span id="cb444-30"><a href="#cb444-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> val <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb444-31"><a href="#cb444-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">set</span> inc <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb444-32"><a href="#cb444-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> seq_lock <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb444-33"><a href="#cb444-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> GET_LOCK(seq_name, <span class="dv">15</span>) <span class="kw">into</span> seq_lock;</span>
<span id="cb444-34"><a href="#cb444-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seq_lock <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb444-35"><a href="#cb444-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> current_value <span class="op">+</span> <span class="kw">increment</span>, <span class="kw">increment</span> <span class="kw">INTO</span> val, inc <span class="kw">FROM</span> MYCAT_SEQUENCE <span class="kw">WHERE</span> name <span class="op">=</span> seq_name <span class="cf">for</span> <span class="kw">update</span>;</span>
<span id="cb444-36"><a href="#cb444-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> val <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb444-37"><a href="#cb444-37" aria-hidden="true" tabindex="-1"></a>          <span class="kw">UPDATE</span> MYCAT_SEQUENCE <span class="kw">SET</span> current_value <span class="op">=</span> val <span class="kw">WHERE</span> name <span class="op">=</span> seq_name;</span>
<span id="cb444-38"><a href="#cb444-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb444-39"><a href="#cb444-39" aria-hidden="true" tabindex="-1"></a>      <span class="kw">SELECT</span> RELEASE_LOCK(seq_name) <span class="kw">into</span> seq_lock;</span>
<span id="cb444-40"><a href="#cb444-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb444-41"><a href="#cb444-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">concat</span>(<span class="fu">CAST</span>((val <span class="op">-</span> inc <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="dt">CHAR</span>),<span class="ot">&quot;,&quot;</span>,<span class="fu">CAST</span>(inc <span class="kw">as</span> <span class="dt">CHAR</span>)) <span class="kw">INTO</span> retval;</span>
<span id="cb444-42"><a href="#cb444-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> retval;</span>
<span id="cb444-43"><a href="#cb444-43" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb444-44"><a href="#cb444-44" aria-hidden="true" tabindex="-1"></a>;;</span>
<span id="cb444-45"><a href="#cb444-45" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb444-46"><a href="#cb444-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-47"><a href="#cb444-47" aria-hidden="true" tabindex="-1"></a># 获取跳过指定count后的sequence值</span>
<span id="cb444-48"><a href="#cb444-48" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> `mycat_seq_nextvals`;</span>
<span id="cb444-49"><a href="#cb444-49" aria-hidden="true" tabindex="-1"></a>DELIMITER ;;</span>
<span id="cb444-50"><a href="#cb444-50" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> `mycat_seq_nextvals`(seq_name <span class="dt">VARCHAR</span>(<span class="dv">64</span>), <span class="fu">count</span> <span class="dt">INT</span>) RETURNS <span class="dt">VARCHAR</span>(<span class="dv">64</span>) CHARSET latin1</span>
<span id="cb444-51"><a href="#cb444-51" aria-hidden="true" tabindex="-1"></a>    DETERMINISTIC</span>
<span id="cb444-52"><a href="#cb444-52" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb444-53"><a href="#cb444-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> retval <span class="dt">VARCHAR</span>(<span class="dv">64</span>);</span>
<span id="cb444-54"><a href="#cb444-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> val BIGINT;</span>
<span id="cb444-55"><a href="#cb444-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> seq_lock <span class="dt">INT</span>;</span>
<span id="cb444-56"><a href="#cb444-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> val <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb444-57"><a href="#cb444-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> seq_lock <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>;</span>
<span id="cb444-58"><a href="#cb444-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> GET_LOCK(seq_name, <span class="dv">15</span>) <span class="kw">into</span> seq_lock;</span>
<span id="cb444-59"><a href="#cb444-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seq_lock <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span></span>
<span id="cb444-60"><a href="#cb444-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> current_value <span class="op">+</span> <span class="fu">count</span> <span class="kw">INTO</span> val <span class="kw">FROM</span> MYCAT_SEQUENCE <span class="kw">WHERE</span> name <span class="op">=</span> seq_name <span class="cf">for</span> <span class="kw">update</span>;</span>
<span id="cb444-61"><a href="#cb444-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">IF</span> val <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span> <span class="cf">THEN</span></span>
<span id="cb444-62"><a href="#cb444-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">UPDATE</span> MYCAT_SEQUENCE <span class="kw">SET</span> current_value <span class="op">=</span> val <span class="kw">WHERE</span> name <span class="op">=</span> seq_name;</span>
<span id="cb444-63"><a href="#cb444-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb444-64"><a href="#cb444-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">SELECT</span> RELEASE_LOCK(seq_name) <span class="kw">into</span> seq_lock;</span>
<span id="cb444-65"><a href="#cb444-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span> <span class="cf">if</span>;</span>
<span id="cb444-66"><a href="#cb444-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">CONCAT</span>(<span class="fu">CAST</span>((val <span class="op">-</span> <span class="fu">count</span> <span class="op">+</span> <span class="dv">1</span>) <span class="kw">as</span> <span class="dt">CHAR</span>), <span class="ot">&quot;,&quot;</span>, <span class="fu">CAST</span>(val <span class="kw">as</span> <span class="dt">CHAR</span>)) <span class="kw">INTO</span> retval;</span>
<span id="cb444-67"><a href="#cb444-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> retval;</span>
<span id="cb444-68"><a href="#cb444-68" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb444-69"><a href="#cb444-69" aria-hidden="true" tabindex="-1"></a>;;</span>
<span id="cb444-70"><a href="#cb444-70" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span>
<span id="cb444-71"><a href="#cb444-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-72"><a href="#cb444-72" aria-hidden="true" tabindex="-1"></a># 设置sequence值</span>
<span id="cb444-73"><a href="#cb444-73" aria-hidden="true" tabindex="-1"></a><span class="kw">DROP</span> <span class="kw">FUNCTION</span> <span class="cf">IF</span> <span class="kw">EXISTS</span> `mycat_seq_setval`;</span>
<span id="cb444-74"><a href="#cb444-74" aria-hidden="true" tabindex="-1"></a>DELIMITER ;;</span>
<span id="cb444-75"><a href="#cb444-75" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> `mycat_seq_setval`(seq_name <span class="dt">VARCHAR</span>(<span class="dv">64</span>), <span class="fu">value</span> BIGINT) RETURNS <span class="dt">varchar</span>(<span class="dv">64</span>) CHARSET latin1</span>
<span id="cb444-76"><a href="#cb444-76" aria-hidden="true" tabindex="-1"></a>    DETERMINISTIC</span>
<span id="cb444-77"><a href="#cb444-77" aria-hidden="true" tabindex="-1"></a><span class="cf">BEGIN</span></span>
<span id="cb444-78"><a href="#cb444-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> retval <span class="dt">VARCHAR</span>(<span class="dv">64</span>);</span>
<span id="cb444-79"><a href="#cb444-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">DECLARE</span> inc <span class="dt">INT</span>;</span>
<span id="cb444-80"><a href="#cb444-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SET</span> inc <span class="op">=</span> <span class="dv">0</span>;</span>
<span id="cb444-81"><a href="#cb444-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="kw">increment</span> <span class="kw">INTO</span> inc <span class="kw">FROM</span> MYCAT_SEQUENCE <span class="kw">WHERE</span> name <span class="op">=</span> seq_name;</span>
<span id="cb444-82"><a href="#cb444-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">UPDATE</span> MYCAT_SEQUENCE <span class="kw">SET</span> current_value <span class="op">=</span> <span class="fu">value</span> <span class="kw">WHERE</span> name <span class="op">=</span> seq_name;</span>
<span id="cb444-83"><a href="#cb444-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> <span class="fu">concat</span>(<span class="fu">CAST</span>(<span class="fu">value</span> <span class="kw">as</span> <span class="dt">CHAR</span>),<span class="ot">&quot;,&quot;</span>,<span class="fu">CAST</span>(inc <span class="kw">as</span> <span class="dt">CHAR</span>)) <span class="kw">INTO</span> retval;</span>
<span id="cb444-84"><a href="#cb444-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RETURN</span> retval;</span>
<span id="cb444-85"><a href="#cb444-85" aria-hidden="true" tabindex="-1"></a><span class="cf">END</span></span>
<span id="cb444-86"><a href="#cb444-86" aria-hidden="true" tabindex="-1"></a>;;</span>
<span id="cb444-87"><a href="#cb444-87" aria-hidden="true" tabindex="-1"></a>DELIMITER ;</span></code></pre></div>
<p>往表中插入序列</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a># 创建一个名为my_table的序列，初始值是1，步长是1</span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> MYCAT_SEQUENCE(name,current_value,<span class="kw">increment</span>) <span class="kw">VALUES</span> (<span class="st">&#39;my_table&#39;</span>, <span class="dv">1</span>, <span class="dv">1</span>);</span></code></pre></div>
<p>缺点：当配置节点的部署是主从复制，当主挂了切从后会有重复</p>
<ul>
<li>2表示本地时间戳方式，需配置<code>sequence_time_conf.properties</code>文件</li>
</ul>
<div class="sourceCode" id="cb446"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="co">#sequence depend on TIME</span></span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a><span class="co"># WORKID和DATAACENTERID都是 0-31 任意整数</span></span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKID</span><span class="ot">=</span><span class="dv">01</span></span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a><span class="dt">DATAACENTERID</span><span class="ot">=</span><span class="dv">01</span></span></code></pre></div>
<p>此时序列的计算方式为：64 位二进制 = 42(毫秒)+5(机器
ID)+5(业务编码)+12(重复累加) 。此时要求主键字段长度大于18位</p>
<ul>
<li>3表示使用分布式ZooKeeper
ID生成器，需配置<code>sequence_distributed_conf.properties</code>文件，ZK的连接信息统一在<code>myid.properties</code>的<code>zkURL</code>属性中配置</li>
</ul>
<p>myid.properties：</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用zk管理mycat和ID</span></span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a><span class="dt">loadZk</span><span class="ot">=</span><span class="kw">true</span></span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a><span class="co"># zk服务器的地址和端口</span></span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a><span class="dt">zkURL</span><span class="ot">=</span><span class="st">192.168.0.10:2181</span></span>
<span id="cb447-5"><a href="#cb447-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 本机房mycat集群的ID</span></span>
<span id="cb447-6"><a href="#cb447-6" aria-hidden="true" tabindex="-1"></a><span class="dt">clusterId</span><span class="ot">=</span><span class="st">mycat-cluster-1</span></span>
<span id="cb447-7"><a href="#cb447-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 集群内mycat的ID</span></span>
<span id="cb447-8"><a href="#cb447-8" aria-hidden="true" tabindex="-1"></a><span class="dt">myid</span><span class="ot">=</span><span class="st">mycat_fz_01</span></span>
<span id="cb447-9"><a href="#cb447-9" aria-hidden="true" tabindex="-1"></a><span class="co"># mycat节点的名称</span></span>
<span id="cb447-10"><a href="#cb447-10" aria-hidden="true" tabindex="-1"></a><span class="dt">clusterNodes</span><span class="ot">=</span><span class="st">mycat_fz_01</span></span></code></pre></div>
<p>sequence_distributed_conf.properties：</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="co">#代表使用zk</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a><span class="dt">INSTANCEID</span><span class="ot">=</span><span class="st">ZK</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a><span class="co">#与myid.properties中的CLUSTERID设置的值相同</span></span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a><span class="dt">CLUSTERID</span><span class="ot">=</span><span class="st">mycat-cluster-1</span></span></code></pre></div>
<ul>
<li>4表示使用Zookeeper递增方式，需配置<code>sequence_distributed_conf.properties</code>和<code>sequence_conf.properties</code>文件，ZK的连接信息统一在<code>myid.properties</code>的<code>zkURL</code>属性中配置</li>
</ul>
<p>sequence_distributed_conf.properties和myid.properties配置和3一样</p>
<p>sequence_conf.properties：</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb449-1"><a href="#cb449-1" aria-hidden="true" tabindex="-1"></a><span class="co"># self define sequence</span></span>
<span id="cb449-2"><a href="#cb449-2" aria-hidden="true" tabindex="-1"></a><span class="co">#可以不填写</span></span>
<span id="cb449-3"><a href="#cb449-3" aria-hidden="true" tabindex="-1"></a><span class="dt">ACCOUNT.HISIDS</span><span class="ot">=</span></span>
<span id="cb449-4"><a href="#cb449-4" aria-hidden="true" tabindex="-1"></a><span class="co">#某线程当前区间内最小值</span></span>
<span id="cb449-5"><a href="#cb449-5" aria-hidden="true" tabindex="-1"></a><span class="dt">ACCOUNT.MINID</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb449-6"><a href="#cb449-6" aria-hidden="true" tabindex="-1"></a><span class="co">#某线程当前区间内最大值</span></span>
<span id="cb449-7"><a href="#cb449-7" aria-hidden="true" tabindex="-1"></a><span class="dt">ACCOUNT.MAXID</span><span class="ot">=</span><span class="dv">2000</span></span>
<span id="cb449-8"><a href="#cb449-8" aria-hidden="true" tabindex="-1"></a><span class="co">#某线程当前区间内当前值</span></span>
<span id="cb449-9"><a href="#cb449-9" aria-hidden="true" tabindex="-1"></a><span class="dt">ACCOUNT.CURID</span><span class="ot">=</span><span class="dv">0</span></span></code></pre></div>
<h4 id="log4j2.xml">log4j2.xml</h4>
<p>日志配置</p>
<div class="sourceCode" id="cb450"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb450-2"><a href="#cb450-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">Configuration</span><span class="ot"> status=</span><span class="st">&quot;WARN&quot;</span>&gt;</span>
<span id="cb450-3"><a href="#cb450-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Appenders</span>&gt;</span>
<span id="cb450-4"><a href="#cb450-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">Console</span><span class="ot"> name=</span><span class="st">&quot;Console&quot;</span><span class="ot"> target=</span><span class="st">&quot;SYSTEM_OUT&quot;</span>&gt;</span>
<span id="cb450-5"><a href="#cb450-5" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">PatternLayout</span><span class="ot"> pattern=</span><span class="st">&quot;%d [%-5p][%t] %m %throwable{full} (%C:%F:%L) %n&quot;</span>/&gt;</span>
<span id="cb450-6"><a href="#cb450-6" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">Console</span>&gt;</span>
<span id="cb450-7"><a href="#cb450-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb450-8"><a href="#cb450-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">RollingFile</span><span class="ot"> name=</span><span class="st">&quot;RollingFile&quot;</span><span class="ot"> fileName=</span><span class="st">&quot;${sys:MYCAT_HOME}/logs/mycat.log&quot;</span></span>
<span id="cb450-9"><a href="#cb450-9" aria-hidden="true" tabindex="-1"></a><span class="ot">                     filePattern=</span><span class="st">&quot;${sys:MYCAT_HOME}/logs/$${date:yyyy-MM}/mycat-%d{MM-dd}-%i.log.gz&quot;</span>&gt;</span>
<span id="cb450-10"><a href="#cb450-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">PatternLayout</span>&gt;</span>
<span id="cb450-11"><a href="#cb450-11" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">Pattern</span>&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} %5p [%t] (%l) - %m%n&lt;/<span class="kw">Pattern</span>&gt;</span>
<span id="cb450-12"><a href="#cb450-12" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">PatternLayout</span>&gt;</span>
<span id="cb450-13"><a href="#cb450-13" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">Policies</span>&gt;</span>
<span id="cb450-14"><a href="#cb450-14" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">OnStartupTriggeringPolicy</span>/&gt;</span>
<span id="cb450-15"><a href="#cb450-15" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">SizeBasedTriggeringPolicy</span><span class="ot"> size=</span><span class="st">&quot;250 MB&quot;</span>/&gt;</span>
<span id="cb450-16"><a href="#cb450-16" aria-hidden="true" tabindex="-1"></a>                &lt;<span class="kw">TimeBasedTriggeringPolicy</span>/&gt;</span>
<span id="cb450-17"><a href="#cb450-17" aria-hidden="true" tabindex="-1"></a>            &lt;/<span class="kw">Policies</span>&gt;</span>
<span id="cb450-18"><a href="#cb450-18" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">RollingFile</span>&gt;</span>
<span id="cb450-19"><a href="#cb450-19" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Appenders</span>&gt;</span>
<span id="cb450-20"><a href="#cb450-20" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">Loggers</span>&gt;</span>
<span id="cb450-21"><a href="#cb450-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;AsyncLogger name=&quot;io.mycat&quot; level=&quot;info&quot; includeLocation=&quot;true&quot; additivity=&quot;false&quot;&gt;--&gt;</span></span>
<span id="cb450-22"><a href="#cb450-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!--&lt;AppenderRef ref=&quot;Console&quot;/&gt;--&gt;</span></span>
<span id="cb450-23"><a href="#cb450-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!--&lt;AppenderRef ref=&quot;RollingFile&quot;/&gt;--&gt;</span></span>
<span id="cb450-24"><a href="#cb450-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!--&lt;/AsyncLogger&gt;--&gt;</span></span>
<span id="cb450-25"><a href="#cb450-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">asyncRoot</span><span class="ot"> level=</span><span class="st">&quot;info&quot;</span><span class="ot"> includeLocation=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb450-26"><a href="#cb450-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">&lt;!--&lt;AppenderRef ref=&quot;Console&quot; /&gt;--&gt;</span></span>
<span id="cb450-27"><a href="#cb450-27" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">AppenderRef</span><span class="ot"> ref=</span><span class="st">&quot;RollingFile&quot;</span>/&gt;</span>
<span id="cb450-28"><a href="#cb450-28" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">asyncRoot</span>&gt;</span>
<span id="cb450-29"><a href="#cb450-29" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">Loggers</span>&gt;</span>
<span id="cb450-30"><a href="#cb450-30" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">Configuration</span>&gt;</span></code></pre></div>
<p><code>Pattern</code>的<code>%d{yyyy-MM-dd HH:mm:ss.SSS} %5p [%t] (%l) - %m%n</code>指定日志格式，其中<code>%d{yyyy-MM-dd HH:mm:ss.SSS}</code>表示日期格式，<code>%5p</code>表示日志级别，其中5表示最多显示5个字符，<code>%t</code>表示记录线程的名称，<code>%m</code>表示输出代码中提取的消息，<code>%n</code>表示输出换行符</p>
<p><code>asyncRoot</code>的<code>level</code>可以指定日志级别，mycat支持的日志级别有All
&lt; Trace &lt; Debug &lt; Info &lt; Warm &lt; Error &lt; Fatal &lt;
Off</p>
<h4 id="rule.xml">rule.xml</h4>
<p>用于配置表的分片规则，分片分为垂直分片和水平分片</p>
<p>垂直分片是按照数据结构进行的切分，它把一个表分成多个更小的表，该表存储的字段更少（比如本来一张表有id、name、addr，现在拆分成两个表，一个表存储id和name，另一个存储id和addr，这样一张表存储的字段变少了，索引也就更快了，而且还可以存储到不同的服务器上）</p>
<p>水平分片是按照数据行的切分，它把一张表拆分成多个部分存储，每个部分放到不同的服务器上，而且只负责存储一部分信息（比如将id为1w-2w存储在服务器1上，id为2w-3w存储在服务器2上，…）</p>
<p>rule.xml中主要定义水平分片的规则</p>
<div class="sourceCode" id="cb451"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb451-1"><a href="#cb451-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb451-2"><a href="#cb451-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mycat:rule</span> SYSTEM &quot;rule.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb451-3"><a href="#cb451-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mycat:rule</span><span class="ot"> xmlns:mycat=</span><span class="st">&quot;http://io.mycat/&quot;</span>&gt;</span>
<span id="cb451-4"><a href="#cb451-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">tableRule</span><span class="ot"> name=</span><span class="st">&quot;rule-mod-long-3&quot;</span>&gt;</span>
<span id="cb451-5"><a href="#cb451-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">rule</span>&gt;</span>
<span id="cb451-6"><a href="#cb451-6" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">columns</span>&gt;id&lt;/<span class="kw">columns</span>&gt;</span>
<span id="cb451-7"><a href="#cb451-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">algorithm</span>&gt;mod-long&lt;/<span class="kw">algorithm</span>&gt;</span>
<span id="cb451-8"><a href="#cb451-8" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">rule</span>&gt;</span>
<span id="cb451-9"><a href="#cb451-9" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">tableRule</span>&gt;</span>
<span id="cb451-10"><a href="#cb451-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-11"><a href="#cb451-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 分片算法 --&gt;</span></span>
<span id="cb451-12"><a href="#cb451-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 一致性hash --&gt;</span></span>
<span id="cb451-13"><a href="#cb451-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;murmur&quot;</span></span>
<span id="cb451-14"><a href="#cb451-14" aria-hidden="true" tabindex="-1"></a><span class="ot">        class=</span><span class="st">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span>
<span id="cb451-15"><a href="#cb451-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;seed&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 默认是0 --&gt;</span></span>
<span id="cb451-16"><a href="#cb451-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;count&quot;</span>&gt;2&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span></span>
<span id="cb451-17"><a href="#cb451-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;virtualBucketTimes&quot;</span>&gt;160&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span></span>
<span id="cb451-18"><a href="#cb451-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- &lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt; 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --&gt;</span></span>
<span id="cb451-19"><a href="#cb451-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- &lt;property name=&quot;bucketMapPath&quot;&gt;/etc/mycat/bucketMapPath&lt;/property&gt; </span></span>
<span id="cb451-20"><a href="#cb451-20" aria-hidden="true" tabindex="-1"></a><span class="co">            用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span></span>
<span id="cb451-21"><a href="#cb451-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-22"><a href="#cb451-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-23"><a href="#cb451-23" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;crc32slot&quot;</span></span>
<span id="cb451-24"><a href="#cb451-24" aria-hidden="true" tabindex="-1"></a><span class="ot">              class=</span><span class="st">&quot;io.mycat.route.function.PartitionByCRC32PreSlot&quot;</span>&gt;</span>
<span id="cb451-25"><a href="#cb451-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;count&quot;</span>&gt;2&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span></span>
<span id="cb451-26"><a href="#cb451-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-27"><a href="#cb451-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-28"><a href="#cb451-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 枚举法 --&gt;</span></span>
<span id="cb451-29"><a href="#cb451-29" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;hash-int&quot;</span></span>
<span id="cb451-30"><a href="#cb451-30" aria-hidden="true" tabindex="-1"></a><span class="ot">        class=</span><span class="st">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span>
<span id="cb451-31"><a href="#cb451-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;partition-hash-int.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-32"><a href="#cb451-32" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-33"><a href="#cb451-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-34"><a href="#cb451-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 范围约定 --&gt;</span></span>
<span id="cb451-35"><a href="#cb451-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- autopartition-long.txt</span></span>
<span id="cb451-36"><a href="#cb451-36" aria-hidden="true" tabindex="-1"></a><span class="co">        # range start-end ,data node index</span></span>
<span id="cb451-37"><a href="#cb451-37" aria-hidden="true" tabindex="-1"></a><span class="co">        # K=1000,M=10000.</span></span>
<span id="cb451-38"><a href="#cb451-38" aria-hidden="true" tabindex="-1"></a><span class="co">        0-500M=0</span></span>
<span id="cb451-39"><a href="#cb451-39" aria-hidden="true" tabindex="-1"></a><span class="co">        500M-1000M=1</span></span>
<span id="cb451-40"><a href="#cb451-40" aria-hidden="true" tabindex="-1"></a><span class="co">        1000M-1500M=2</span></span>
<span id="cb451-41"><a href="#cb451-41" aria-hidden="true" tabindex="-1"></a><span class="co">        或</span></span>
<span id="cb451-42"><a href="#cb451-42" aria-hidden="true" tabindex="-1"></a><span class="co">        0-10000000=0</span></span>
<span id="cb451-43"><a href="#cb451-43" aria-hidden="true" tabindex="-1"></a><span class="co">        10000001-20000000=1</span></span>
<span id="cb451-44"><a href="#cb451-44" aria-hidden="true" tabindex="-1"></a><span class="co">     --&gt;</span></span>
<span id="cb451-45"><a href="#cb451-45" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;rang-long&quot;</span></span>
<span id="cb451-46"><a href="#cb451-46" aria-hidden="true" tabindex="-1"></a><span class="ot">        class=</span><span class="st">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span>
<span id="cb451-47"><a href="#cb451-47" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;autopartition-long.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-48"><a href="#cb451-48" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-49"><a href="#cb451-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-50"><a href="#cb451-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 求模法 --&gt;</span></span>
<span id="cb451-51"><a href="#cb451-51" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;mod-long&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span>
<span id="cb451-52"><a href="#cb451-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- how many data nodes --&gt;</span></span>
<span id="cb451-53"><a href="#cb451-53" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;count&quot;</span>&gt;3&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-54"><a href="#cb451-54" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-55"><a href="#cb451-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-56"><a href="#cb451-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 固定分片hash算法 --&gt;</span></span>
<span id="cb451-57"><a href="#cb451-57" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;func1&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span>
<span id="cb451-58"><a href="#cb451-58" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;partitionCount&quot;</span>&gt;8&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-59"><a href="#cb451-59" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;partitionLength&quot;</span>&gt;128&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-60"><a href="#cb451-60" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-61"><a href="#cb451-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-62"><a href="#cb451-62" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;latestMonth&quot;</span></span>
<span id="cb451-63"><a href="#cb451-63" aria-hidden="true" tabindex="-1"></a><span class="ot">        class=</span><span class="st">&quot;io.mycat.route.function.LatestMonthPartion&quot;</span>&gt;</span>
<span id="cb451-64"><a href="#cb451-64" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;splitOneDay&quot;</span>&gt;24&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-65"><a href="#cb451-65" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-66"><a href="#cb451-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-67"><a href="#cb451-67" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;partbymonth&quot;</span></span>
<span id="cb451-68"><a href="#cb451-68" aria-hidden="true" tabindex="-1"></a><span class="ot">        class=</span><span class="st">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span>
<span id="cb451-69"><a href="#cb451-69" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dateFormat&quot;</span>&gt;yyyy-MM-dd&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-70"><a href="#cb451-70" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sBeginDate&quot;</span>&gt;2015-01-01&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-71"><a href="#cb451-71" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-72"><a href="#cb451-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb451-73"><a href="#cb451-73" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;rang-mod&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByRangeMod&quot;</span>&gt;</span>
<span id="cb451-74"><a href="#cb451-74" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;partition-range-mod.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-75"><a href="#cb451-75" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-76"><a href="#cb451-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb451-77"><a href="#cb451-77" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;jump-consistent-hash&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByJumpConsistentHash&quot;</span>&gt;</span>
<span id="cb451-78"><a href="#cb451-78" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;totalBuckets&quot;</span>&gt;3&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-79"><a href="#cb451-79" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-80"><a href="#cb451-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb451-81"><a href="#cb451-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 日期列分区法 --&gt;</span></span>
<span id="cb451-82"><a href="#cb451-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!--</span></span>
<span id="cb451-83"><a href="#cb451-83" aria-hidden="true" tabindex="-1"></a><span class="co">        2014-01-01为0</span></span>
<span id="cb451-84"><a href="#cb451-84" aria-hidden="true" tabindex="-1"></a><span class="co">        2014-01-10为1</span></span>
<span id="cb451-85"><a href="#cb451-85" aria-hidden="true" tabindex="-1"></a><span class="co">        ...</span></span>
<span id="cb451-86"><a href="#cb451-86" aria-hidden="true" tabindex="-1"></a><span class="co">        2014-05-01为12</span></span>
<span id="cb451-87"><a href="#cb451-87" aria-hidden="true" tabindex="-1"></a><span class="co">        ...</span></span>
<span id="cb451-88"><a href="#cb451-88" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb451-89"><a href="#cb451-89" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;sharding-by-date&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span>
<span id="cb451-90"><a href="#cb451-90" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;dateFormat&quot;</span>&gt;yyyy-MM-dd&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-91"><a href="#cb451-91" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sBeginDate&quot;</span>&gt;2014-01-01&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-92"><a href="#cb451-92" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sPartionDay&quot;</span>&gt;10&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-93"><a href="#cb451-93" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-94"><a href="#cb451-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb451-95"><a href="#cb451-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 通配取模 --&gt;</span></span>
<span id="cb451-96"><a href="#cb451-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- partition-pattern.txt </span></span>
<span id="cb451-97"><a href="#cb451-97" aria-hidden="true" tabindex="-1"></a><span class="co">        # id partition range start-end ,data node index</span></span>
<span id="cb451-98"><a href="#cb451-98" aria-hidden="true" tabindex="-1"></a><span class="co">        1-32=0</span></span>
<span id="cb451-99"><a href="#cb451-99" aria-hidden="true" tabindex="-1"></a><span class="co">        33-64=1</span></span>
<span id="cb451-100"><a href="#cb451-100" aria-hidden="true" tabindex="-1"></a><span class="co">        65-96=2</span></span>
<span id="cb451-101"><a href="#cb451-101" aria-hidden="true" tabindex="-1"></a><span class="co">        97-128=3</span></span>
<span id="cb451-102"><a href="#cb451-102" aria-hidden="true" tabindex="-1"></a><span class="co">        129-160=4</span></span>
<span id="cb451-103"><a href="#cb451-103" aria-hidden="true" tabindex="-1"></a><span class="co">        161-192=5</span></span>
<span id="cb451-104"><a href="#cb451-104" aria-hidden="true" tabindex="-1"></a><span class="co">        193-224=6</span></span>
<span id="cb451-105"><a href="#cb451-105" aria-hidden="true" tabindex="-1"></a><span class="co">        225-256=7</span></span>
<span id="cb451-106"><a href="#cb451-106" aria-hidden="true" tabindex="-1"></a><span class="co">        0-0=7</span></span>
<span id="cb451-107"><a href="#cb451-107" aria-hidden="true" tabindex="-1"></a><span class="co">    --&gt;</span></span>
<span id="cb451-108"><a href="#cb451-108" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;sharding-by-pattern&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByPattern&quot;</span>&gt;</span>
<span id="cb451-109"><a href="#cb451-109" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;patternValue&quot;</span>&gt;256&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 求模基数 --&gt;</span></span>
<span id="cb451-110"><a href="#cb451-110" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultNode&quot;</span>&gt;7&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 默认节点，如果不配置，则默认是0；如果分片字段不是整形，也会放到默认节点 --&gt;</span></span>
<span id="cb451-111"><a href="#cb451-111" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;partition-pattern.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb451-112"><a href="#cb451-112" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">function</span>&gt;</span>
<span id="cb451-113"><a href="#cb451-113" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mycat:rule</span>&gt;</span></code></pre></div>
<p><code>tableRule</code>定义根据哪个字段进行分片，以及使用什么分片算法，分片算法由<code>function</code>标签定义</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">tableRule</span><span class="ot"> name=</span><span class="st">&quot;rule-mod-long-3&quot;</span>&gt;<span class="co">&lt;!-- 这里的name会在schema.xml中用到 --&gt;</span></span>
<span id="cb452-2"><a href="#cb452-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">rule</span>&gt;</span>
<span id="cb452-3"><a href="#cb452-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">columns</span>&gt;id&lt;/<span class="kw">columns</span>&gt;<span class="co">&lt;!-- 根据id进行分片 --&gt;</span></span>
<span id="cb452-4"><a href="#cb452-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">algorithm</span>&gt;mod-long&lt;/<span class="kw">algorithm</span>&gt;<span class="co">&lt;!-- 这里指定function的name --&gt;</span></span>
<span id="cb452-5"><a href="#cb452-5" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">rule</span>&gt;</span>
<span id="cb452-6"><a href="#cb452-6" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">tableRule</span>&gt;</span></code></pre></div>
<p>常用的分片算法有：</p>
<div class="sourceCode" id="cb453"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 简单取模，一般用于分片字段为整数类型 --&gt;</span></span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;mod-long&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;count&quot;</span>&gt;3&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 分成3个表，下标从0开始 --&gt;</span></span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">function</span>&gt;</span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 枚举分片，一般用于分片字段只有有限个可选值的情况，比如地区编码、性别等 --&gt;</span></span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- partition-hash-int.txt：</span></span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a><span class="co">1000=0</span></span>
<span id="cb453-9"><a href="#cb453-9" aria-hidden="true" tabindex="-1"></a><span class="co">1001=1</span></span>
<span id="cb453-10"><a href="#cb453-10" aria-hidden="true" tabindex="-1"></a><span class="co">DEFAULT_NODE=0</span></span>
<span id="cb453-11"><a href="#cb453-11" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb453-12"><a href="#cb453-12" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;hash-int&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span>
<span id="cb453-13"><a href="#cb453-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;partition-hash-int.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb453-14"><a href="#cb453-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;type&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 0表示分片字段为int类型，1表示为String类型 --&gt;</span></span>
<span id="cb453-15"><a href="#cb453-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultNode&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 是否使用default node，小于0表示不设置默认节点，大于等于0表示设置默认节点；不设置默认节点时，如果碰到没有匹配的值会报错 --&gt;</span></span>
<span id="cb453-16"><a href="#cb453-16" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">function</span>&gt;</span>
<span id="cb453-17"><a href="#cb453-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-18"><a href="#cb453-18" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ASCII码求模通配，用于分片字段为字符串类型；该算法会取字符串的前n个字符，对其ASCII求和再模以指定值，最后得出的数再在指定的文件中按照范围匹配 --&gt;</span></span>
<span id="cb453-19"><a href="#cb453-19" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- partition-pattern.txt：</span></span>
<span id="cb453-20"><a href="#cb453-20" aria-hidden="true" tabindex="-1"></a><span class="co">0-63=0</span></span>
<span id="cb453-21"><a href="#cb453-21" aria-hidden="true" tabindex="-1"></a><span class="co">64-127=1</span></span>
<span id="cb453-22"><a href="#cb453-22" aria-hidden="true" tabindex="-1"></a><span class="co">--&gt;</span></span>
<span id="cb453-23"><a href="#cb453-23" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">function</span><span class="ot"> name=</span><span class="st">&quot;sharding-by-pattern&quot;</span><span class="ot"> class=</span><span class="st">&quot;io.mycat.route.function.PartitionByPrefixPattern&quot;</span>&gt;</span>
<span id="cb453-24"><a href="#cb453-24" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;patternValue&quot;</span>&gt;128&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 取模基数 --&gt;</span></span>
<span id="cb453-25"><a href="#cb453-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;prefixLength&quot;</span>&gt;5&lt;/<span class="kw">property</span>&gt;<span class="co">&lt;!-- 取字符串的前5个字符 --&gt;</span></span>
<span id="cb453-26"><a href="#cb453-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;mapFile&quot;</span>&gt;partition-pattern.txt&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb453-27"><a href="#cb453-27" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">function</span>&gt;</span></code></pre></div>
<p>可以使用编程来对分片算法进行测试</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb454-1"><a href="#cb454-1" aria-hidden="true" tabindex="-1"></a>PartitionByString rule <span class="op">=</span> <span class="kw">new</span> <span class="fu">PartitionByString</span><span class="op">();</span></span>
<span id="cb454-2"><a href="#cb454-2" aria-hidden="true" tabindex="-1"></a>rule<span class="op">.</span><span class="fu">setPartitionLength</span><span class="op">(</span><span class="st">&quot;512&quot;</span><span class="op">);</span></span>
<span id="cb454-3"><a href="#cb454-3" aria-hidden="true" tabindex="-1"></a>rule<span class="op">.</span><span class="fu">setPartitionCount</span><span class="op">(</span><span class="st">&quot;2&quot;</span><span class="op">);</span></span>
<span id="cb454-4"><a href="#cb454-4" aria-hidden="true" tabindex="-1"></a>rule<span class="op">.</span><span class="fu">init</span><span class="op">();</span></span>
<span id="cb454-5"><a href="#cb454-5" aria-hidden="true" tabindex="-1"></a>rule<span class="op">.</span><span class="fu">setHashSlice</span><span class="op">(</span><span class="st">&quot;0:2&quot;</span><span class="op">);</span></span>
<span id="cb454-6"><a href="#cb454-6" aria-hidden="true" tabindex="-1"></a>Assert<span class="op">.</span><span class="fu">assertEquals</span><span class="op">(</span><span class="kw">true</span><span class="op">,</span> <span class="dv">0</span> <span class="op">==</span> rule<span class="op">.</span><span class="fu">calculate</span><span class="op">(</span><span class="st">&quot;45a&quot;</span><span class="op">));</span></span></code></pre></div>
<h4 id="schema.xml">schema.xml</h4>
<p>用于配置逻辑库、逻辑表以及对应的物理库（逻辑表直接对应物理库中的同名物理表，不再另外配置）</p>
<div class="sourceCode" id="cb455"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mycat:schema</span> SYSTEM &quot;schema.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mycat:schema</span><span class="ot"> xmlns:mycat=</span><span class="st">&quot;http://io.mycat/&quot;</span>&gt;</span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- 逻辑库、逻辑表（逻辑表的名字要和物理表的名字一样） --&gt;</span></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">schema</span><span class="ot"> name=</span><span class="st">&quot;testdb&quot;</span><span class="ot"> checkSQLschema=</span><span class="st">&quot;false&quot;</span><span class="ot"> sqlMaxLimit=</span><span class="st">&quot;100&quot;</span>&gt;</span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;customer&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;dn1,dn2,dn3&quot;</span><span class="ot"> rule=</span><span class="st">&quot;rule-mod-long-3&quot;</span> /&gt;</span>
<span id="cb455-7"><a href="#cb455-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- &lt;table name=&quot;dual&quot; primaryKey=&quot;id&quot; dataNode=&quot;dn3&quot; type=&quot;global&quot; autoIncrement=&quot;true&quot; needAddLimit=&quot;false&quot;/&gt; --&gt;</span></span>
<span id="cb455-8"><a href="#cb455-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- &lt;table name=&quot;customer&quot; primaryKey=&quot;ID&quot; dataNode=&quot;dn1,dn2&quot; rule=&quot;sharding-by-intfile&quot;&gt;</span></span>
<span id="cb455-9"><a href="#cb455-9" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;childTable name=&quot;orders&quot; primaryKey=&quot;ID&quot; joinKey=&quot;customer_id&quot; parentKey=&quot;id&quot;&gt;</span></span>
<span id="cb455-10"><a href="#cb455-10" aria-hidden="true" tabindex="-1"></a><span class="co">                &lt;childTable name=&quot;order_items&quot; joinKey=&quot;order_id&quot; parentKey=&quot;id&quot; /&gt;</span></span>
<span id="cb455-11"><a href="#cb455-11" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;/childTable&gt;</span></span>
<span id="cb455-12"><a href="#cb455-12" aria-hidden="true" tabindex="-1"></a><span class="co">            &lt;childTable name=&quot;customer_addr&quot; primaryKey=&quot;ID&quot; joinKey=&quot;customer_id&quot; parentKey=&quot;id&quot; /&gt;</span></span>
<span id="cb455-13"><a href="#cb455-13" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/table&gt; --&gt;</span></span>
<span id="cb455-14"><a href="#cb455-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">schema</span>&gt;</span>
<span id="cb455-15"><a href="#cb455-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb455-16"><a href="#cb455-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;dn1&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;localhost1&quot;</span><span class="ot"> database=</span><span class="st">&quot;db1&quot;</span> /&gt;</span>
<span id="cb455-17"><a href="#cb455-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;dn2&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;localhost1&quot;</span><span class="ot"> database=</span><span class="st">&quot;db2&quot;</span> /&gt;</span>
<span id="cb455-18"><a href="#cb455-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;dn3&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;localhost1&quot;</span><span class="ot"> database=</span><span class="st">&quot;db3&quot;</span> /&gt;</span>
<span id="cb455-19"><a href="#cb455-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb455-20"><a href="#cb455-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb455-21"><a href="#cb455-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataHost</span><span class="ot"> name=</span><span class="st">&quot;localhost1&quot;</span><span class="ot"> maxCon=</span><span class="st">&quot;1000&quot;</span><span class="ot"> minCon=</span><span class="st">&quot;10&quot;</span><span class="ot"> balance=</span><span class="st">&quot;0&quot;</span><span class="ot"> writeType=</span><span class="st">&quot;0&quot;</span><span class="ot"> dbType=</span><span class="st">&quot;mysql&quot;</span><span class="ot"> dbDriver=</span><span class="st">&quot;native&quot;</span><span class="ot"> switchType=</span><span class="st">&quot;1&quot;</span><span class="ot"> slaveThreshold=</span><span class="st">&quot;100&quot;</span>&gt;</span>
<span id="cb455-22"><a href="#cb455-22" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">heartbeat</span>&gt;select user()&lt;/<span class="kw">heartbeat</span>&gt;</span>
<span id="cb455-23"><a href="#cb455-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-24"><a href="#cb455-24" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;hostM1&quot;</span><span class="ot"> url=</span><span class="st">&quot;localhost:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;123456&quot;</span>&gt;</span>
<span id="cb455-25"><a href="#cb455-25" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">readHost</span><span class="ot"> host=</span><span class="st">&quot;hostS2&quot;</span><span class="ot"> url=</span><span class="st">&quot;192.168.1.200:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;xxx&quot;</span> /&gt;</span>
<span id="cb455-26"><a href="#cb455-26" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">writeHost</span>&gt;</span>
<span id="cb455-27"><a href="#cb455-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 如果hostM1宕机，则自动把hostS2变为writeHost --&gt;</span></span>
<span id="cb455-28"><a href="#cb455-28" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;hostS2&quot;</span><span class="ot"> url=</span><span class="st">&quot;192.168.1.200:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;xxx&quot;</span> /&gt;</span>
<span id="cb455-29"><a href="#cb455-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb455-30"><a href="#cb455-30" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;hostS1&quot;</span><span class="ot"> url=</span><span class="st">&quot;localhost:3316&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;123456&quot;</span> /&gt;</span>
<span id="cb455-31"><a href="#cb455-31" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dataHost</span>&gt;</span>
<span id="cb455-32"><a href="#cb455-32" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mycat:schema</span>&gt;</span></code></pre></div>
<p><code>schema</code></p>
<ul>
<li>name: 逻辑库的名字，名字要唯一</li>
<li>checkSQLschema:
是否检查发给MyCat的SQL是否包含库名，为true时，查询时可以使用testdb.customer来指定数据库，但是这样效率会低，不推荐使用</li>
<li>sqlMaxLimit:
限制返回结果集的行数，-1表示不限制；如果SQL语句中指定了limit，会覆盖该值；如果运行的schema为非拆分库的，那么该属性不会生效</li>
</ul>
<p><code>table</code></p>
<ul>
<li>name: 逻辑表的名字，同一个库中的表名要唯一</li>
<li>primaryKey:
主键；如果用于分片的键不是主键，MyCat会在查询时把主键缓存，以提高效率，因为主键的查询效率是最高的</li>
<li>dataNode: 该逻辑表对应哪个数据节点，要和dataNode的name属性对应</li>
<li>rule: 分片规则，要和rule.xml中tableRule的name属性对应</li>
<li>ruleRequired:
是否绑定分片规则，为true但是没有配置具体rule时候，就会报错</li>
<li>type:
逻辑表的类型，目前逻辑表只有全局表和普通表，全局表该属性的值为global，普通表不设置该属性即可</li>
<li>autoIncrement:
mycat提供的自增长主键功能，可以为true或false，如果使用这个功能，最好配合使用数据库模式的全局序列</li>
<li>needAddLimit:
是否需要自动的在每个语句后面加上limit限制（前面schema中指定的sqlMaxLimit），这个属性默认为true，可以自己设置为false禁用</li>
</ul>
<p><code>childTable</code>（用于定义E-R分片的子表）</p>
<ul>
<li>name: 子表的表名</li>
<li>joinKey: 插入子表的时候会使用这个列的值查找父表存储的数据节点</li>
<li>primaryKey:
属性指定的值一般为与父表建立关联关系的列名。程序首先获取<code>joinkey</code>的值，再通过<code>parentKey</code>属性指定的列名产生查询语句，通过执行该语句得到父表存储在哪个分片上。从而确定子表存储的位置</li>
<li>parentKey: 子表的主键</li>
<li>needAddLimit: 是否需要自动的在每个语句后面加上limit限制</li>
</ul>
<p><code>dataNode</code></p>
<ul>
<li>name: 数据节点的名字，名字要唯一</li>
<li>dataHost: 该分片属于哪个数据库实例，要和dataHost的name属性对应</li>
<li>database: 该分片属于哪个物理数据库</li>
</ul>
<p><code>dataHost</code></p>
<ul>
<li>name: dataHost的名字，名字要唯一</li>
<li>maxCon、minCon: 每个读写实例连接池的最大、最小连接数</li>
<li>balance: 负载均称类型
<ul>
<li>0: 不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</li>
<li>1: 全部的readHost与stand by
writeHost参与select语句的负载均衡，简单的说，当双主双从模式（M1-S1，M2-S2
并且M1 M2互为主备），正常情况下，M2,S1,S2都参与select语句的负载均衡</li>
<li>2: 所有读操作都随机的在writeHost、readHost上分发</li>
<li>3:
所有读请求随机的分发到writeHst对应的readHost执行，writeHost不负担读写压力</li>
</ul></li>
<li>writeType: 负载均衡类型
<ul>
<li>0:
所有的写操作发送到配置的第一个writeHost，第一个挂了切换到第二个。切换记录在文件dnindex.properties</li>
<li>1:
所有的写操作都随机的发送到配置的writeHost，1.5以后版本废弃不推荐</li>
<li>2: 不执行写操作</li>
</ul></li>
<li>dbType: 数据库类型，比如mysql、mongodb、oracle、spark</li>
<li>dbDriver:
连接类型，可以是native或JDBC，目前native只支持二进制的mysql协议（mysql和maridb可以使用native），使用其他数据库时需使用JDBC（使用JDBC时要把jar把放到<code>mycat\lib</code>目录下，并检查驱动jar包中包括如下目录结构文件
META-INF.sql.Driver。
在这个文件写上具体的driver类名，例如com.mysql.jdbc.Driver）</li>
<li>switchType: 主从模式下如果主机挂了，是否自动把从机切换主机
<ul>
<li>-1: 不自动切换</li>
<li>1: 自动切换（默认值）</li>
<li>2:
基于MySql主从同步的状态决定是否切换，心跳语句为<code>show slave status</code></li>
<li>3: 基于mysql galary cluster
的切换机制（适合集群），心跳语句为<code>show status like &#39;wsrep%&#39;</code></li>
</ul></li>
<li>slaveThreshold: 从机最大个数上限</li>
</ul>
<p><code>heartbeat</code>: 心跳检测语句</p>
<p><code>writeHost</code>、<code>readHost</code>:
读主机、写主机，如果后端数据库宕机，那么这个<code>writeHost</code>绑定的所有<code>readHost</code>都将不可用</p>
<h3 id="垂直分库案例">垂直分库案例</h3>
<p>需求：从192.168.1.2中垂直分库，192.168.1.3负责存储customer数据，192.168.1.4负责存储order数据，192.168.1.5负责存储product数据</p>
<p><strong>192.168.1.2</strong></p>
<p>创建用于主从复制的用户，这里要使用<code>--master-data=2</code>记录事务日志点</p>
<div class="sourceCode" id="cb456"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="fu">user</span> <span class="st">&#39;repl_user&#39;</span>@<span class="st">&#39;192.168.1.%&#39;</span> <span class="kw">identified</span> <span class="kw">by</span> <span class="st">&#39;123456&#39;</span>;</span>
<span id="cb456-2"><a href="#cb456-2" aria-hidden="true" tabindex="-1"></a><span class="kw">grant</span> replication slave <span class="kw">on</span> <span class="op">*</span>.<span class="op">*</span> <span class="kw">to</span> <span class="st">&#39;repl_user&#39;</span>@<span class="st">&#39;192.168.1.%&#39;</span>;</span></code></pre></div>
<p>使用mysqldump导出数据，然后使用scp命令把导出的数据拷贝到三台从机上</p>
<pre class="shell"><code>mysqldump --master-data=2 --single-transaction --routines --triggers --events -uroot -p main_db &gt; back_main_db.sql

scp back_main_db.sql root@192.168.1.3:/root
scp back_main_db.sql root@192.168.1.4:/root
scp back_main_db.sql root@192.168.1.5:/root</code></pre>
<p><strong>192.168.1.3/5</strong></p>
<p>创建customer_db数据库，从主数据库导出的文件恢复数据</p>
<p>然后使用<code>change master to</code>配置复制链路，开启主从复制</p>
<p>由于我们要垂直分库，所以从机的数据库名称和主机不一致，所以还需要使用<code>change replication filter</code>配置数据库名转换</p>
<p>最后创建Mycat连接MySql所用的用户</p>
<p>其他两台从机同理</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a>mysql <span class="op">-</span>uroot <span class="op">-</span>p <span class="op">-</span>e<span class="ot">&quot;create database customer_db&quot;</span></span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>mysql <span class="op">-</span>uroot <span class="op">-</span>p customer_db <span class="op">&lt;</span>  back_main_db.sql</span>
<span id="cb458-3"><a href="#cb458-3" aria-hidden="true" tabindex="-1"></a><span class="kw">change</span> <span class="kw">master</span> <span class="kw">to</span>  <span class="kw">master</span> host<span class="op">=</span><span class="st">&#39;192.168.1.2&#39;</span>,master_user<span class="op">=</span><span class="st">&#39;repl_user&#39;</span>,master_password<span class="op">=</span><span class="st">&#39;123456&#39;</span>,MASTER_LOG_FILE<span class="op">=</span><span class="st">&#39;mysql-bin.000001&#39;</span>,MASTER_LOG_POS<span class="op">=</span><span class="dv">4532519</span>;</span>
<span id="cb458-4"><a href="#cb458-4" aria-hidden="true" tabindex="-1"></a><span class="kw">change</span> replication <span class="kw">filter</span> replicate <span class="kw">rewrite</span> db<span class="op">=</span>((main_db,customer_db));</span>
<span id="cb458-5"><a href="#cb458-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-6"><a href="#cb458-6" aria-hidden="true" tabindex="-1"></a><span class="kw">start</span> slave;</span>
<span id="cb458-7"><a href="#cb458-7" aria-hidden="true" tabindex="-1"></a>show slave stauts \G</span>
<span id="cb458-8"><a href="#cb458-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-9"><a href="#cb458-9" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="fu">user</span> <span class="st">&#39;mycat&#39;</span>@<span class="st">&#39;192.168.1.%&#39;</span> <span class="kw">identified</span> <span class="kw">by</span> <span class="st">&#39;123456&#39;</span>;</span>
<span id="cb458-10"><a href="#cb458-10" aria-hidden="true" tabindex="-1"></a><span class="kw">grant</span> <span class="kw">select</span>,<span class="kw">insert</span>,<span class="kw">update</span>,<span class="kw">delete</span>,<span class="kw">execute</span> <span class="kw">on</span> <span class="op">*</span>.<span class="op">*</span> <span class="kw">to</span> <span class="st">&#39;mycat&#39;</span>@<span class="st">&#39;192.168.1.%&#39;</span></span></code></pre></div>
<p><code>MASTER_LOG_FILE</code>和<code>MASTER_LOG_POS</code>是通过在192.168.1.2中使用<code>more back_main_db.sql</code>查看的</p>
<p>至此，主从复制已经配置好了，然后需要配置schema.xml和server.xml（由于我们只需要垂直分库，不需要配置rule.xml）</p>
<p><strong>192.168.1.2</strong></p>
<p><strong>schema.xml</strong></p>
<div class="sourceCode" id="cb459"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mycat:schema</span> SYSTEM &quot;schema.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mycat:schema</span><span class="ot"> xmlns:mycat=</span><span class="st">&quot;http://io.mycat/&quot;</span>&gt;</span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-5"><a href="#cb459-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- schema的name就是我们最后模拟成一个逻辑库的名字 --&gt;</span></span>
<span id="cb459-6"><a href="#cb459-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">schema</span><span class="ot"> name=</span><span class="st">&quot;website_db&quot;</span><span class="ot"> checkSQLschema=</span><span class="st">&quot;false&quot;</span><span class="ot"> sqlMaxLimit=</span><span class="st">&quot;100&quot;</span>&gt;</span>
<span id="cb459-7"><a href="#cb459-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- MyCat跨分片的关联查询速度很慢，一个解决方案是把共用的数据冗余到各个数据库中，这时就需要使用全局表，但是如果以后需要修改全局表的数据，必须通过MyCat修改，否则会出现数据不一致的情况 --&gt;</span></span>
<span id="cb459-8"><a href="#cb459-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;region_info&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;region_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;cusdb,orddb,prodb&quot;</span><span class="ot"> type=</span><span class="st">&quot;global&quot;</span> /&gt;</span>
<span id="cb459-9"><a href="#cb459-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-10"><a href="#cb459-10" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;customer_inf&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;customer_inf_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;cusdb&quot;</span> /&gt;</span>
<span id="cb459-11"><a href="#cb459-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;customer_login&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;login_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;cusdb&quot;</span> /&gt;</span>
<span id="cb459-12"><a href="#cb459-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;customer_level&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;customer_level_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;cusdb&quot;</span> /&gt;</span>
<span id="cb459-13"><a href="#cb459-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-14"><a href="#cb459-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;order_detail&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;order_detail_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;orddb&quot;</span> /&gt;</span>
<span id="cb459-15"><a href="#cb459-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;order_master&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;login_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;orddb&quot;</span> /&gt;</span>
<span id="cb459-16"><a href="#cb459-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;order_cart&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;cart_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;orddb&quot;</span> /&gt;</span>
<span id="cb459-17"><a href="#cb459-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;order_customer_addr&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;customer_addr_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;orddb&quot;</span> /&gt;</span>
<span id="cb459-18"><a href="#cb459-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-19"><a href="#cb459-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;product_category&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;category_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;prodb&quot;</span> /&gt;</span>
<span id="cb459-20"><a href="#cb459-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;product_brand_infos&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;brand_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;prodb&quot;</span> /&gt;</span>
<span id="cb459-21"><a href="#cb459-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">table</span><span class="ot"> name=</span><span class="st">&quot;product_info&quot;</span><span class="ot"> primaryKey=</span><span class="st">&quot;product_id&quot;</span><span class="ot"> dataNode=</span><span class="st">&quot;prodb&quot;</span> /&gt;</span>
<span id="cb459-22"><a href="#cb459-22" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">schema</span>&gt;</span>
<span id="cb459-23"><a href="#cb459-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb459-24"><a href="#cb459-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- database就是刚才创建的库 --&gt;</span></span>
<span id="cb459-25"><a href="#cb459-25" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;cusdb&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;mysql0103&quot;</span><span class="ot"> database=</span><span class="st">&quot;customer_db&quot;</span> /&gt;</span>
<span id="cb459-26"><a href="#cb459-26" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;orddb&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;mysql0104&quot;</span><span class="ot"> database=</span><span class="st">&quot;order_db&quot;</span> /&gt;</span>
<span id="cb459-27"><a href="#cb459-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataNode</span><span class="ot"> name=</span><span class="st">&quot;prodb&quot;</span><span class="ot"> dataHost=</span><span class="st">&quot;mysql0105&quot;</span><span class="ot"> database=</span><span class="st">&quot;product_db&quot;</span> /&gt;</span>
<span id="cb459-28"><a href="#cb459-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb459-29"><a href="#cb459-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- dataHost命名最后使用ip相关的名字，提高可读性 --&gt;</span></span>
<span id="cb459-30"><a href="#cb459-30" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataHost</span><span class="ot"> name=</span><span class="st">&quot;mysql0103&quot;</span><span class="ot"> maxCon=</span><span class="st">&quot;1000&quot;</span><span class="ot"> minCon=</span><span class="st">&quot;10&quot;</span><span class="ot"> balance=</span><span class="st">&quot;3&quot;</span><span class="ot"> writeType=</span><span class="st">&quot;0&quot;</span><span class="ot"> dbType=</span><span class="st">&quot;mysql&quot;</span><span class="ot"> dbDriver=</span><span class="st">&quot;native&quot;</span><span class="ot"> switchType=</span><span class="st">&quot;1&quot;</span>&gt;</span>
<span id="cb459-31"><a href="#cb459-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">heartbeat</span>&gt;select user()&lt;/<span class="kw">heartbeat</span>&gt;</span>
<span id="cb459-32"><a href="#cb459-32" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;192.168.1.3&quot;</span><span class="ot"> url=</span><span class="st">&quot;192.168.1.3:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;mycat&quot;</span><span class="ot"> password=</span><span class="st">&quot;123456&quot;</span>/&gt;</span>
<span id="cb459-33"><a href="#cb459-33" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dataHost</span>&gt;</span>
<span id="cb459-34"><a href="#cb459-34" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataHost</span><span class="ot"> name=</span><span class="st">&quot;mysql0104&quot;</span><span class="ot"> maxCon=</span><span class="st">&quot;1000&quot;</span><span class="ot"> minCon=</span><span class="st">&quot;10&quot;</span><span class="ot"> balance=</span><span class="st">&quot;3&quot;</span><span class="ot"> writeType=</span><span class="st">&quot;0&quot;</span><span class="ot"> dbType=</span><span class="st">&quot;mysql&quot;</span><span class="ot"> dbDriver=</span><span class="st">&quot;native&quot;</span><span class="ot"> switchType=</span><span class="st">&quot;1&quot;</span>&gt;</span>
<span id="cb459-35"><a href="#cb459-35" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">heartbeat</span>&gt;select user()&lt;/<span class="kw">heartbeat</span>&gt;</span>
<span id="cb459-36"><a href="#cb459-36" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;192.168.1.4&quot;</span><span class="ot"> url=</span><span class="st">&quot;192.168.1.4:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;mycat&quot;</span><span class="ot"> password=</span><span class="st">&quot;123456&quot;</span>/&gt;</span>
<span id="cb459-37"><a href="#cb459-37" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dataHost</span>&gt;</span>
<span id="cb459-38"><a href="#cb459-38" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataHost</span><span class="ot"> name=</span><span class="st">&quot;mysql0103&quot;</span><span class="ot"> maxCon=</span><span class="st">&quot;1000&quot;</span><span class="ot"> minCon=</span><span class="st">&quot;10&quot;</span><span class="ot"> balance=</span><span class="st">&quot;3&quot;</span><span class="ot"> writeType=</span><span class="st">&quot;0&quot;</span><span class="ot"> dbType=</span><span class="st">&quot;mysql&quot;</span><span class="ot"> dbDriver=</span><span class="st">&quot;native&quot;</span><span class="ot"> switchType=</span><span class="st">&quot;1&quot;</span>&gt;</span>
<span id="cb459-39"><a href="#cb459-39" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">heartbeat</span>&gt;select user()&lt;/<span class="kw">heartbeat</span>&gt;</span>
<span id="cb459-40"><a href="#cb459-40" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">writeHost</span><span class="ot"> host=</span><span class="st">&quot;192.168.1.5&quot;</span><span class="ot"> url=</span><span class="st">&quot;192.168.1.5:3306&quot;</span><span class="ot"> user=</span><span class="st">&quot;mycat&quot;</span><span class="ot"> password=</span><span class="st">&quot;123456&quot;</span>/&gt;</span>
<span id="cb459-41"><a href="#cb459-41" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">dataHost</span>&gt;</span>
<span id="cb459-42"><a href="#cb459-42" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mycat:schema</span>&gt;</span></code></pre></div>
<p><strong>server.xml</strong></p>
<div class="sourceCode" id="cb460"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb460-1"><a href="#cb460-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb460-2"><a href="#cb460-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">mycat:server</span> SYSTEM &quot;server.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb460-3"><a href="#cb460-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">mycat:server</span><span class="ot"> xmlns:mycat=</span><span class="st">&quot;http://io.mycat/&quot;</span>&gt;</span>
<span id="cb460-4"><a href="#cb460-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">system</span>&gt;</span>
<span id="cb460-5"><a href="#cb460-5" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;serverPort&quot;</span>&gt;8066&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-6"><a href="#cb460-6" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;managerPort&quot;</span>&gt;9066&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-7"><a href="#cb460-7" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;nonePasswordLogin&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-8"><a href="#cb460-8" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;bindIp&quot;</span>&gt;0.0.0.0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-9"><a href="#cb460-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;frontWriteQueueSize&quot;</span>&gt;2048&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-10"><a href="#cb460-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb460-11"><a href="#cb460-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;charset&quot;</span>&gt;utf8&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-12"><a href="#cb460-12" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;txIsolation&quot;</span>&gt;2&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-13"><a href="#cb460-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;processors&quot;</span>&gt;8&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-14"><a href="#cb460-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;idleTimeout&quot;</span>&gt;1800000&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-15"><a href="#cb460-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sqlExecuteTimeout&quot;</span>&gt;300&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-16"><a href="#cb460-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useSqlStat&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-17"><a href="#cb460-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;useGlobleTableCheck&quot;</span>&gt;0&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-18"><a href="#cb460-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;sequnceHandlerType&quot;</span>&gt;2&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-19"><a href="#cb460-19" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;defaultMaxLimit&quot;</span>&gt;100&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-20"><a href="#cb460-20" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;maxPacketSize&quot;</span>&gt;104857600&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-21"><a href="#cb460-21" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">system</span>&gt;</span>
<span id="cb460-22"><a href="#cb460-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">user</span><span class="ot"> name=</span><span class="st">&quot;mycat_root&quot;</span><span class="ot"> defaultAccount=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb460-23"><a href="#cb460-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;password&quot;</span>&gt;123456&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-24"><a href="#cb460-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&lt;!-- 这里的schemas是前面指定的逻辑库的名字 --&gt;</span></span>
<span id="cb460-25"><a href="#cb460-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">property</span><span class="ot"> name=</span><span class="st">&quot;schemas&quot;</span>&gt;website_db&lt;/<span class="kw">property</span>&gt;</span>
<span id="cb460-26"><a href="#cb460-26" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">user</span>&gt;</span>
<span id="cb460-27"><a href="#cb460-27" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">mycat:server</span>&gt;</span></code></pre></div>
<p>最后启动MyCat，通过Mycat的端口、账号、密码登陆MySql</p>
<pre class="shell"><code>/usr/local/mycat/bin/mycat start
mysql -umycat_root -p -h192.168.1.2 -P8066 -Dwebsite_db</code></pre>
<p><strong>192.168.1.3/5</strong></p>
<p>停止主从复制，删除冗余数据，其他两个从库同理</p>
<div class="sourceCode" id="cb462"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb462-1"><a href="#cb462-1" aria-hidden="true" tabindex="-1"></a><span class="kw">stop</span> slave;</span>
<span id="cb462-2"><a href="#cb462-2" aria-hidden="true" tabindex="-1"></a><span class="kw">reset</span> slave <span class="kw">all</span>;</span>
<span id="cb462-3"><a href="#cb462-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb462-4"><a href="#cb462-4" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">table</span> order_detail;<span class="kw">drop</span> <span class="kw">table</span> order_master;<span class="kw">drop</span> <span class="kw">table</span> order_cart;<span class="kw">drop</span> <span class="kw">table</span> order_customer_addr;<span class="kw">drop</span> <span class="kw">table</span> product_category;<span class="kw">drop</span> <span class="kw">table</span> product_brand_infos;<span class="kw">drop</span> <span class="kw">table</span> product_info;</span></code></pre></div>
<h3 id="mycatzookeeper">MyCat+ZooKeeper</h3>
<p>前面垂直分库中只使用了一个MyCat，但真实环境中我们需要使用MyCat集群，这时就需要通过ZooKeeper同步配置</p>
<p>为了测试方便，需要关闭防火墙和selinux，如果熟悉它们的配置，也可以修改对应的规则，不用关闭</p>
<pre class="shell"><code># 关闭防火墙
systemctl stop firewalld.service
systemctl disable firewalld.service
 
# 关闭SELINUX
sed -i &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; /etc/sysconfig/selinux
setenforce 0</code></pre>
<p>首先配置ZooKeeper集群（略，参考ZooKeeper章节），并启动各ZooKeeper</p>
<p>修改所有MyCat主机的<code>mycat/conf/myid.properties</code>，配置ZooKeeper所在的服务器（以其中一台为例，其余的同理，不同MyCat主机只是<code>myid</code>不同）</p>
<div class="sourceCode" id="cb464"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb464-1"><a href="#cb464-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 是否使用ZooKeeper</span></span>
<span id="cb464-2"><a href="#cb464-2" aria-hidden="true" tabindex="-1"></a><span class="dt">loadZk</span><span class="ot">=</span><span class="kw">true</span></span>
<span id="cb464-3"><a href="#cb464-3" aria-hidden="true" tabindex="-1"></a><span class="co"># zookeeper集群节点，逗号分隔</span></span>
<span id="cb464-4"><a href="#cb464-4" aria-hidden="true" tabindex="-1"></a><span class="dt">zkURL</span><span class="ot">=</span><span class="st">192.168.1.6:2181,192.168.1.7:2181,192.168.1.8:2181</span></span>
<span id="cb464-5"><a href="#cb464-5" aria-hidden="true" tabindex="-1"></a><span class="co"># mycat集群名字，会在ZooKeeper的mycat节点下创建指定clusterId的名称节点</span></span>
<span id="cb464-6"><a href="#cb464-6" aria-hidden="true" tabindex="-1"></a><span class="dt">clusterId</span><span class="ot">=</span><span class="st">mycat-cluster-1</span></span>
<span id="cb464-7"><a href="#cb464-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 当前mycat节点名字，每台MyCat主机都不同</span></span>
<span id="cb464-8"><a href="#cb464-8" aria-hidden="true" tabindex="-1"></a><span class="dt">myid</span><span class="ot">=</span><span class="st">mycat_01</span></span>
<span id="cb464-9"><a href="#cb464-9" aria-hidden="true" tabindex="-1"></a><span class="co"># MyCat主机数量，这里假设有两台MyCat主机</span></span>
<span id="cb464-10"><a href="#cb464-10" aria-hidden="true" tabindex="-1"></a><span class="dt">clusterSize</span><span class="ot">=</span><span class="dv">2</span></span>
<span id="cb464-11"><a href="#cb464-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mycat集群节点成员，和前面的myid对应</span></span>
<span id="cb464-12"><a href="#cb464-12" aria-hidden="true" tabindex="-1"></a><span class="dt">clusterNodes</span><span class="ot">=</span><span class="st">mycat_01,mycat_02</span></span>
<span id="cb464-13"><a href="#cb464-13" aria-hidden="true" tabindex="-1"></a><span class="co">#server  booster  ;   booster install on db same server,will reset all minCon to 2</span></span>
<span id="cb464-14"><a href="#cb464-14" aria-hidden="true" tabindex="-1"></a><span class="dt">type</span><span class="ot">=</span><span class="st">server</span></span>
<span id="cb464-15"><a href="#cb464-15" aria-hidden="true" tabindex="-1"></a><span class="dt">boosterDataHosts</span><span class="ot">=</span><span class="st">dataHost1</span></span></code></pre></div>
<p>选择其中一台MyCat主机，把mycat的<code>conf</code>目录下的<code>server.xml</code>、<code>rule.xml</code>、<code>schema.xml</code>移动到<code>conf/zkconf</code>，如果使用全局序列号，还需要复制对应的文件</p>
<pre class="shell"><code>cp server.xml rule.xml schema.xml ./zkconf
cp sequence_db_conf.properties ./zkconf/</code></pre>
<p>在该MyCat主机中使用<code>mycat/bin</code>的<code>init_zk_data.sh</code>脚本把配置同步到ZooKeeper中（要求配置的zookeeper集群节点必须全部在线）</p>
<pre class="shell"><code> mycat/bin/init_zk_data.sh</code></pre>
<p>此时登录其中一台ZooKeeper客户端，使用<code>ls /mycat/mycat-cluster-1</code>如果可以看到mycat对应的节点，说明配置成功</p>
<p>然后再重启各服务器上的MyCat就可以获取到配置</p>
<p>如果以后要修改MyCat配置，可以通过ZooKeeper的<code>ZooInspector</code>工具直接修改ZooKeeper中对应的节点，然后等待1分钟左右就会同步配置了；又或者直接修改MyCat的配置文件，然后再次运行<code>init_zk_data.sh</code>脚本进行同步也可以</p>
<h3 id="haproxyxinetdkeepalived">HAProxy+xinetd+KeepAlived</h3>
<h4 id="haproxy">HAProxy</h4>
<p>HAProxy可以实现MyCat的负载均衡</p>
<p>安装HAProxy（最好在安装MyCat的服务器上安装，因为要对MyCat进行存活检测；如果安装多个HAProxy，它们的配置是一样的）</p>
<pre class="shell"><code>sudo apt install haproxy</code></pre>
<p>配置HAProxy：<code>vim /etc/haproxy/haproxy.cfg</code>，配置如下</p>
<div class="sourceCode" id="cb468"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 全局参数的设置（一般不用改，也可以根据需要改）</span></span>
<span id="cb468-2"><a href="#cb468-2" aria-hidden="true" tabindex="-1"></a><span class="dt">global</span></span>
<span id="cb468-3"><a href="#cb468-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># log语法：log &lt;address_1&gt; [max_level_1]</span></span>
<span id="cb468-4"><a href="#cb468-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 比如 log 127.0.0.1 local2 info</span></span>
<span id="cb468-5"><a href="#cb468-5" aria-hidden="true" tabindex="-1"></a><span class="dt">    log /dev/log    local0</span></span>
<span id="cb468-6"><a href="#cb468-6" aria-hidden="true" tabindex="-1"></a><span class="dt">    log /dev/log    local1 notice</span></span>
<span id="cb468-7"><a href="#cb468-7" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># chroot为工作目录</span></span>
<span id="cb468-8"><a href="#cb468-8" aria-hidden="true" tabindex="-1"></a><span class="dt">    chroot /var/lib/haproxy</span></span>
<span id="cb468-9"><a href="#cb468-9" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># pid文件位置</span></span>
<span id="cb468-10"><a href="#cb468-10" aria-hidden="true" tabindex="-1"></a><span class="dt">    pidfile     /var/run/haproxy.pid</span></span>
<span id="cb468-11"><a href="#cb468-11" aria-hidden="true" tabindex="-1"></a><span class="dt">    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span></span>
<span id="cb468-12"><a href="#cb468-12" aria-hidden="true" tabindex="-1"></a><span class="dt">    stats timeout 30s</span></span>
<span id="cb468-13"><a href="#cb468-13" aria-hidden="true" tabindex="-1"></a><span class="dt">    maxconn 4000</span></span>
<span id="cb468-14"><a href="#cb468-14" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># user和group会自动创建linux用户</span></span>
<span id="cb468-15"><a href="#cb468-15" aria-hidden="true" tabindex="-1"></a><span class="dt">    user haproxy</span></span>
<span id="cb468-16"><a href="#cb468-16" aria-hidden="true" tabindex="-1"></a><span class="dt">    group haproxy</span></span>
<span id="cb468-17"><a href="#cb468-17" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 后台运行</span></span>
<span id="cb468-18"><a href="#cb468-18" aria-hidden="true" tabindex="-1"></a><span class="dt">    daemon</span></span>
<span id="cb468-19"><a href="#cb468-19" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 启动1个实例，可以启多个来提高效率</span></span>
<span id="cb468-20"><a href="#cb468-20" aria-hidden="true" tabindex="-1"></a><span class="dt">    nbproc 1</span></span>
<span id="cb468-21"><a href="#cb468-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-22"><a href="#cb468-22" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 定义连接后端服务器的失败重连次数（失败超过指定次数时将服务器标记为不可用）</span></span>
<span id="cb468-23"><a href="#cb468-23" aria-hidden="true" tabindex="-1"></a><span class="dt">    retries 3</span></span>
<span id="cb468-24"><a href="#cb468-24" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># http请求超时时间</span></span>
<span id="cb468-25"><a href="#cb468-25" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout http-request    10s</span></span>
<span id="cb468-26"><a href="#cb468-26" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 一个请求在队列里的超时时间</span></span>
<span id="cb468-27"><a href="#cb468-27" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout queue   1m</span></span>
<span id="cb468-28"><a href="#cb468-28" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 连接超时</span></span>
<span id="cb468-29"><a href="#cb468-29" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout connect 10s</span></span>
<span id="cb468-30"><a href="#cb468-30" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 客户端超时</span></span>
<span id="cb468-31"><a href="#cb468-31" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout client  1m</span></span>
<span id="cb468-32"><a href="#cb468-32" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 服务器端超时</span></span>
<span id="cb468-33"><a href="#cb468-33" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout server  1m</span></span>
<span id="cb468-34"><a href="#cb468-34" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 设置http-keep-alive的超时时间</span></span>
<span id="cb468-35"><a href="#cb468-35" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout http-keep-alive 10s</span></span>
<span id="cb468-36"><a href="#cb468-36" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 检测超时</span></span>
<span id="cb468-37"><a href="#cb468-37" aria-hidden="true" tabindex="-1"></a><span class="dt">    timeout check   10s</span></span>
<span id="cb468-38"><a href="#cb468-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-39"><a href="#cb468-39" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 每次请求完毕后主动关闭http通道（禁用长连接）</span></span>
<span id="cb468-40"><a href="#cb468-40" aria-hidden="true" tabindex="-1"></a><span class="dt">    option http-server-close</span></span>
<span id="cb468-41"><a href="#cb468-41" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 当serverId对应的服务器挂掉后，强制定向到其他健康的服务器</span></span>
<span id="cb468-42"><a href="#cb468-42" aria-hidden="true" tabindex="-1"></a><span class="dt">    option redispatch</span></span>
<span id="cb468-43"><a href="#cb468-43" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</span></span>
<span id="cb468-44"><a href="#cb468-44" aria-hidden="true" tabindex="-1"></a><span class="dt">    option abortonclose</span></span>
<span id="cb468-45"><a href="#cb468-45" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 保证HAProxy不记录上级负载均衡发送过来的用于检测状态没有数据的心跳包 </span></span>
<span id="cb468-46"><a href="#cb468-46" aria-hidden="true" tabindex="-1"></a><span class="dt">    option dontlognull</span></span>
<span id="cb468-47"><a href="#cb468-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-48"><a href="#cb468-48" aria-hidden="true" tabindex="-1"></a><span class="dt">defaults</span></span>
<span id="cb468-49"><a href="#cb468-49" aria-hidden="true" tabindex="-1"></a><span class="dt">    log global</span></span>
<span id="cb468-50"><a href="#cb468-50" aria-hidden="true" tabindex="-1"></a><span class="dt">    mode    http</span></span>
<span id="cb468-51"><a href="#cb468-51" aria-hidden="true" tabindex="-1"></a><span class="dt">    option  httplog</span></span>
<span id="cb468-52"><a href="#cb468-52" aria-hidden="true" tabindex="-1"></a><span class="dt">    option  dontlognull</span></span>
<span id="cb468-53"><a href="#cb468-53" aria-hidden="true" tabindex="-1"></a><span class="dt">        timeout connect 5000</span></span>
<span id="cb468-54"><a href="#cb468-54" aria-hidden="true" tabindex="-1"></a><span class="dt">        timeout client  50000</span></span>
<span id="cb468-55"><a href="#cb468-55" aria-hidden="true" tabindex="-1"></a><span class="dt">        timeout server  50000</span></span>
<span id="cb468-56"><a href="#cb468-56" aria-hidden="true" tabindex="-1"></a><span class="dt">    errorfile 400 /etc/haproxy/errors/400.http</span></span>
<span id="cb468-57"><a href="#cb468-57" aria-hidden="true" tabindex="-1"></a><span class="dt">    errorfile 403 /etc/haproxy/errors/403.http</span></span>
<span id="cb468-58"><a href="#cb468-58" aria-hidden="true" tabindex="-1"></a><span class="dt">    errorfile 500 /etc/haproxy/errors/500.http</span></span>
<span id="cb468-59"><a href="#cb468-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-60"><a href="#cb468-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 下面是我们的配置</span></span>
<span id="cb468-61"><a href="#cb468-61" aria-hidden="true" tabindex="-1"></a><span class="co"># HAProxy的状态信息统计页面</span></span>
<span id="cb468-62"><a href="#cb468-62" aria-hidden="true" tabindex="-1"></a><span class="dt">listen admin_status</span></span>
<span id="cb468-63"><a href="#cb468-63" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 用于使用keepalived监控HaProxy的虚拟ip及端口，使用keepalived时，只有绑定了虚拟网卡的主机能够对外提供服务，其余的HAProxy主机是备用机；需要使用ifconfig eth0:1 192.168.1.10/24配置虚拟网卡</span></span>
<span id="cb468-64"><a href="#cb468-64" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co">#bind 192.168.1.10:48800</span></span>
<span id="cb468-65"><a href="#cb468-65" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 使用0.0.0.0可以绑定所有的IP，就不需要每个服务器都配置了，同时还可用避免虚拟ip被切走就无法启动的情况</span></span>
<span id="cb468-66"><a href="#cb468-66" aria-hidden="true" tabindex="-1"></a><span class="dt">    bind 0.0.0.0:48800</span></span>
<span id="cb468-67"><a href="#cb468-67" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 监控的url</span></span>
<span id="cb468-68"><a href="#cb468-68" aria-hidden="true" tabindex="-1"></a><span class="dt">    stats uri /admin-status</span></span>
<span id="cb468-69"><a href="#cb468-69" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 使用用户名admin密码admin登录监控页面，如果要设置多个，另起一行写入即可</span></span>
<span id="cb468-70"><a href="#cb468-70" aria-hidden="true" tabindex="-1"></a><span class="dt">    stats auth admin:admin</span></span>
<span id="cb468-71"><a href="#cb468-71" aria-hidden="true" tabindex="-1"></a><span class="dt">    mode http</span></span>
<span id="cb468-72"><a href="#cb468-72" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 启用日志记录HTTP请求</span></span>
<span id="cb468-73"><a href="#cb468-73" aria-hidden="true" tabindex="-1"></a><span class="dt">    option httplog</span></span>
<span id="cb468-74"><a href="#cb468-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-75"><a href="#cb468-75" aria-hidden="true" tabindex="-1"></a><span class="co"># MyCat对外提供服务的端口，此时要通过8096端口登录mysql</span></span>
<span id="cb468-76"><a href="#cb468-76" aria-hidden="true" tabindex="-1"></a><span class="dt">listen allmycat_servicce</span></span>
<span id="cb468-77"><a href="#cb468-77" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co">#bind 192.168.1.10:8096</span></span>
<span id="cb468-78"><a href="#cb468-78" aria-hidden="true" tabindex="-1"></a><span class="dt">    bind 0.0.0.0:8096</span></span>
<span id="cb468-79"><a href="#cb468-79" aria-hidden="true" tabindex="-1"></a><span class="dt">    mode tcp</span></span>
<span id="cb468-80"><a href="#cb468-80" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 使用tcplog的日志格式</span></span>
<span id="cb468-81"><a href="#cb468-81" aria-hidden="true" tabindex="-1"></a><span class="dt">    option tcplog</span></span>
<span id="cb468-82"><a href="#cb468-82" aria-hidden="true" tabindex="-1"></a><span class="dt">    option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www</span></span>
<span id="cb468-83"><a href="#cb468-83" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 负载均衡算法</span></span>
<span id="cb468-84"><a href="#cb468-84" aria-hidden="true" tabindex="-1"></a><span class="dt">    balance roundrobin</span></span>
<span id="cb468-85"><a href="#cb468-85" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co"># 使用48700端口对MyCat进行存活检测，inter:每隔5秒检测一次，fail:失败后重试3次，rise:如果连续两次检测成功，则认为服务从离线状态恢复成正常状态；48700会在后面使用xinetd通过检测脚本检测</span></span>
<span id="cb468-86"><a href="#cb468-86" aria-hidden="true" tabindex="-1"></a><span class="dt">    server mycat_01 192.169.1.3:8066 checkport 48700 inter 5s rise 2 fail 3</span></span>
<span id="cb468-87"><a href="#cb468-87" aria-hidden="true" tabindex="-1"></a><span class="dt">    server mycat_01 192.169.1.4:8066 checkport 48700 inter 5s rise 2 fail 3</span></span>
<span id="cb468-88"><a href="#cb468-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb468-89"><a href="#cb468-89" aria-hidden="true" tabindex="-1"></a><span class="co"># 管理mycat</span></span>
<span id="cb468-90"><a href="#cb468-90" aria-hidden="true" tabindex="-1"></a><span class="dt">listen allmycat_admin</span></span>
<span id="cb468-91"><a href="#cb468-91" aria-hidden="true" tabindex="-1"></a><span class="dt">    </span><span class="co">#bind 192.168.1.10:8097</span></span>
<span id="cb468-92"><a href="#cb468-92" aria-hidden="true" tabindex="-1"></a><span class="dt">    bind 0.0.0.0:8097</span></span>
<span id="cb468-93"><a href="#cb468-93" aria-hidden="true" tabindex="-1"></a><span class="dt">    mode tcp</span></span>
<span id="cb468-94"><a href="#cb468-94" aria-hidden="true" tabindex="-1"></a><span class="dt">    option tcplog</span></span>
<span id="cb468-95"><a href="#cb468-95" aria-hidden="true" tabindex="-1"></a><span class="dt">    option httpchk OPTIONS * HTTP/1.1\r\nHost:\ www</span></span>
<span id="cb468-96"><a href="#cb468-96" aria-hidden="true" tabindex="-1"></a><span class="dt">    balance roundrobin</span></span>
<span id="cb468-97"><a href="#cb468-97" aria-hidden="true" tabindex="-1"></a><span class="dt">    server mycat_01 192.169.1.3:9066 checkport 48700 inter 5s rise 2 fail 3</span></span>
<span id="cb468-98"><a href="#cb468-98" aria-hidden="true" tabindex="-1"></a><span class="dt">    server mycat_01 192.169.1.4:9066 checkport 48700 </span></span></code></pre></div>
<p>配置虚拟IP<code>ifconfig eth0:1 192.168.1.10/24</code>（只需配置其中一台主机即可，使用keepalived时，只有绑定了虚拟IP的主机能对外提供服务，其余主机作为备用机，当出现故障时，keepalived会把虚拟IP从一台主机迁移到另一台主机）</p>
<p>设置HAProxy开机启动</p>
<pre class="shell"><code># 拷贝开机启动文件
cp /usr/local/src/haproxy-1.5.16/examples/haproxy.init /etc/rc.d/init.d/haproxy
chmod +x /etc/rc.d/init.d/haproxy

ln -s /usr/local/haproxy/sbin/haproxy /usr/sbin

# 设置HAProxy开机启动
chkconfig --add haproxy
chkconfig haproxy on</code></pre>
<p>启动HAProxy：<code>haproxy -f /etc/haproxy/haproxy.cfg</code></p>
<h4 id="xinetd">xinetd</h4>
<p>在安装HAProxy的主机上使用xinetd通过48700端口返回MyCat的存活检测结果（每台主机上的配置都是一样的）</p>
<pre class="shell"><code>sudo apt install xinetd</code></pre>
<p>检查<code>/etc/xinetd.conf</code>的末尾是否有<code>includedir /etc/xinetd.d</code>，没有就加上，并检查<code>/etc/xinetd.d</code>目录是否存在，不存在则创建</p>
<div class="sourceCode" id="cb471"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple configuration file for xinetd</span></span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Some defaults, and include /etc/xinetd.d/</span></span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a><span class="dt">defaults</span></span>
<span id="cb471-5"><a href="#cb471-5" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span></span>
<span id="cb471-6"><a href="#cb471-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Please note that you need a log_type line to be able to use log_on_success</span></span>
<span id="cb471-7"><a href="#cb471-7" aria-hidden="true" tabindex="-1"></a><span class="co"># and log_on_failure. The default is the following :</span></span>
<span id="cb471-8"><a href="#cb471-8" aria-hidden="true" tabindex="-1"></a><span class="co"># log_type = SYSLOG daemon info</span></span>
<span id="cb471-9"><a href="#cb471-9" aria-hidden="true" tabindex="-1"></a><span class="dt">}</span></span>
<span id="cb471-10"><a href="#cb471-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-11"><a href="#cb471-11" aria-hidden="true" tabindex="-1"></a><span class="dt">includedir /etc/xinetd.d</span></span></code></pre></div>
<p>增加MyCat存活状态检测服务配置：<code>touch /etc/xinetd.d/mycatchk</code>，配置如下</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a><span class="dt">service mycatchk</span></span>
<span id="cb472-2"><a href="#cb472-2" aria-hidden="true" tabindex="-1"></a><span class="dt">{</span></span>
<span id="cb472-3"><a href="#cb472-3" aria-hidden="true" tabindex="-1"></a><span class="dt">    flags </span><span class="ot">=</span><span class="st"> REUSE</span></span>
<span id="cb472-4"><a href="#cb472-4" aria-hidden="true" tabindex="-1"></a><span class="dt">    socket_type </span><span class="ot">=</span><span class="st"> stream</span></span>
<span id="cb472-5"><a href="#cb472-5" aria-hidden="true" tabindex="-1"></a><span class="dt">    port </span><span class="ot">=</span><span class="st"> </span><span class="dv">48700</span></span>
<span id="cb472-6"><a href="#cb472-6" aria-hidden="true" tabindex="-1"></a><span class="dt">    wait </span><span class="ot">=</span><span class="st"> </span><span class="kw">no</span></span>
<span id="cb472-7"><a href="#cb472-7" aria-hidden="true" tabindex="-1"></a><span class="dt">    user </span><span class="ot">=</span><span class="st"> root</span></span>
<span id="cb472-8"><a href="#cb472-8" aria-hidden="true" tabindex="-1"></a><span class="dt">    server </span><span class="ot">=</span><span class="st"> /user/local/bin/mycat_status</span></span>
<span id="cb472-9"><a href="#cb472-9" aria-hidden="true" tabindex="-1"></a><span class="dt">    log_on_failure +</span><span class="ot">=</span><span class="st"> USERID</span></span>
<span id="cb472-10"><a href="#cb472-10" aria-hidden="true" tabindex="-1"></a><span class="dt">    disable </span><span class="ot">=</span><span class="st"> </span><span class="kw">no</span></span>
<span id="cb472-11"><a href="#cb472-11" aria-hidden="true" tabindex="-1"></a><span class="dt">} </span></span></code></pre></div>
<p>创建检测脚本：<code>touch /user/local/bin/mycat_status</code>，内容如下</p>
<pre class="shell"><code>#!/bin/bash
#/usr/local/bin/mycat_status.sh
# This script checks if a mycat server is healthy running on localhost.
# It will return:
#
# &quot;HTTP/1.x 200 OK\r&quot; (if mycat is running smoothly)
#
# &quot;HTTP/1.x 503 Internal Server Error\r&quot; (else)
mycat=`/user/local/bin/mycat status | grep &#39;not running&#39; | wc -l`
if [ &quot;$mycat&quot; = &quot;0&quot; ];
then
    /bin/echo -en &quot;HTTP/1.1 200 OK\r\n&quot;
    /bin/echo -en &quot;Content-Type: text/plain\r\n&quot;
    /bin/echo -en &quot;Connection: close\r\n&quot;
    /bin/echo -en &quot;Content-Length: 40\r\n&quot;
    /bin/echo -en &quot;\r\n&quot;
    /bin/echo -en &quot;MyCat Cluster Node is synced.\r\n&quot;
    exit 0
else
    /bin/echo -e &quot;HTTP/1.1 503 Service Unavailable\r\n&quot;
    /bin/echo -en &quot;Content-Type: text/plain\r\n&quot;
    /bin/echo -en &quot;Connection: close\r\n&quot;
    /bin/echo -en &quot;Content-Length: 44\r\n&quot;
    /bin/echo -en &quot;\r\n&quot;
    /bin/echo -en &quot;MyCat Cluster Node is not synced.\r\n&quot;
    exit 1
fi</code></pre>
<p>给脚本添加执行权限：<code>chmod a+x /user/local/bin/mycat_status</code></p>
<p>如果打开了防火墙，可以修改<code>/etc/sysconfig/iptables</code>，添加<code>-A INPUT -m state --state NEW -m tcp -p tcp --dport 48700 -j ACCEPT</code>，然后重启防火墙<code>service iptables restart</code>（HAProxy的信息统计页面对应的端口以及MyCat对应的服务、管理端口同理）</p>
<p>修改<code>/etc/services</code>，添加</p>
<pre><code>mycatchk 48700/tcp # mycatchk</code></pre>
<p>重启xinetd：<code>service xinetd restart</code></p>
<p>查看是否启动成功:<code>netstat -nltp | grep 48700</code>或<code>ps -ef | grep 48700</code></p>
<h4 id="测试haproxyxinetd">测试HAProxy+xinetd</h4>
<p>重启HAProxy：<code>systemctl reload haproxy</code>或<code>service haproxy restart</code></p>
<p>测试mysql是否连接成功<code>mysql -utest -p -h192.168.1.10 -P8096</code>（如果没有使用虚拟网卡，把ip改成HAProxy主机的ip即可）</p>
<p>登录HAProxy信息统计页面：http://192.168.1.10:48800/admin_status</p>
<p>如果连接失败，检查：</p>
<ol type="1">
<li>是否关闭了selinux</li>
<li>iptables中是否允许范围对应的端口（或者直接关闭iptables再测试）</li>
</ol>
<h4 id="keepalived">KeepAlived</h4>
<p>要保证HAProxy的高可用，需要使用KeepAlived，在安装HAProxy的主机上安装KeepAlived：</p>
<pre class="shell"><code> sudo apt install keepalived</code></pre>
<p>创建keepalived的配置文件<code>touch /etc/keepalived/keepalived.conf</code>，配置如下（备用机的state要修改为BACKUP；如果希望在MASTER下线后再上线时重新保持MASTER，可以修改priority，把其他主机的priority调低；如果不希望抢占VIP，让当前的MASTER继续保持，可以使用<code>nopreempt</code>）</p>
<pre class="properties"><code>! Configuration File for keepalived
vrrp_script chk_port
{
     script &quot;/etc/keepalived/check_haproxy.sh&quot;
     interval 2
     timeout 2
     fall 3
     weight 2
}
vrrp_instance VI_1 {
    #可以指定MASTER和BACKUP
    state MASTER
    # 网卡
    interface eth0
    # VRRP组名，同一集群的keepalived的主、备机的virtual_router_id必须相同,取值0-255
    virtual_router_id 51
    # 优先级，MASTER的优先级应该比BACKUP的高
    priority 100
    # 设置为不抢夺VIP，可以避免频繁的切换主机
    nopreempt
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    # 要执行的脚本，就是上面设置的vrrp_script
    track_script {
         chk_port
    }
    # 如果有多个IP，换行写
    virtual_ipaddress {
        192.168.1.10 dev eth0 scope global
    }
}</code></pre>
<p>KeepAlived通过检测主机上的KeepAlived是否存活来决定是否需要转移VIP，我们需要编写脚本检测HAProxy是否存活，如果HAProxy挂了，就把当前的KeepAlived停掉，让KeepAlived转移VIP到其他KeepAlived备用机上</p>
<p>创建用于检测HAProxy是否存活的脚本<code>touch /etc/keepalived/check_haproxy.sh</code>，如果HAProxy挂了，再次尝试启动，如果启动失败，则停止当前KeepAlived，让其他机器上的KeepAlived转移VIP</p>
<pre class="shell"><code>#!/bin/bash
STARTHAPROXY=&quot;/user/sbin/haproxy -f /etc/haproxy/haproxy.cfg&quot;
STOPKEEPALIVED=&quot;/etc/init.d/keepalived stop&quot;
#STOPKEEPALIVED=&quot;/usr/bin/systemctl stop keepalived&quot;
LOGFILE=&quot;/var/log/keepalived-haproxy-state.log&quot;

echo &quot;[check_haproxy status]&quot; &gt;&gt; $LOGFILE
A=`ps -C haproxy --no-header | wc -l`
echo &quot;[check_haproxy status]&quot; &gt;&gt; $LOGFILE
date &gt;&gt; $LOGFILE

if [ $A -eq 0 ];then
    echo $STARTHAPROXY &gt;&gt; $LOGFILE
    $STARTHAPROXY &gt;&gt; $LOGFILE 2&gt;&amp;1
    sleep 5

    if [ `ps -C haproxy --no-header | wc -l` -eq 0];then
        $STOPKEEPALIVED &gt;&gt; $LOGFILE
        exit 0
    else
        exit 1
    fi
fi</code></pre>
<p>给脚本添加执行权限：<code>chmod a+x /etc/keepalived/check_haproxy.sh</code></p>
<p>设置KeepAlived开机启动：<code>chkconfig keepalived on</code></p>
<p>前面已经配置过虚拟IP了，这里只需要直接启动KeepAlived即可：<code>/etc/init.d/keepalived start</code>或<code>service keepalived start</code></p>
<h4 id="测试keepalived">测试KeepAlived</h4>
<p>在有虚拟IP的主机上关闭KeepAlived：<code>/etc/init.d/keepalived stop</code></p>
<p>查看当前主机是否有我们之前配置的虚拟IP：<code>ip addr</code>，如果没有，说明虚拟IP已被迁移；再查看其他主机是否有被自动迁移的虚拟IP：<code>ip addr</code>，如果有任意一台有，则说明配置成功，最后把原来的KeepAlived启动，如果MASTER的priority最高，那么重启后会重新获得虚拟IP</p>
<h3 id="mycat管理">MyCat管理</h3>
<p>使用server.xml中定义的用户通过指定的管理端口（默认为9066）登录mysql：<code>mysql -uroot -p123456 -P9066 -h127.0.0.1</code></p>
<p>常用命令：</p>
<ul>
<li><code>show @@help</code>: 显示所有管理命令</li>
<li><code>show @@backend</code>:
显示后端物理库连接信息，包括当前连接数，端口等信息</li>
<li><code>show @@connection</code>: 显示当前前端客户端连接情况</li>
<li><code>show @@threadpool</code>:
显示当前线程池的执行情况，显示是否有积压(active_count)以及待处理的SQL(task_queue_size)，若积压数目一直保值，则说明后端物理连接可能不够或者SQL执行比较缓慢</li>
<li><code>show @@heartbeat</code>:
显示后端物理库的心跳检测情况,RS_CODE为1表示心跳正常</li>
<li><code>show @@datanode</code>: 显示数据节点的访问情况</li>
<li><code>show @@processor</code>:
显示当前processors的处理情况，包括每个processor的IO吞吐量(NET_IN/NET_OUT)、IO队列的积压情况(R_QUEY/W_QUEUE)，Socket
Buffer Pool的使用情况 BU_PERCENT为已使用的百分比、BU_WARNS为Socket
Buffer
Pool不够时，临时创建的新的BUFFER的次数，若百分比经常超过90%并且BU_WARNS&gt;0，则表明BUFFER不够，需要增大</li>
<li><code>show @@cache</code>: 显示缓存的使用情况</li>
<li><code>reload @@config</code>:
重新加载配置文件schema.xml，其他文件的更改仍需重启MyCat</li>
</ul>
<h3 id="mycat优化">MyCat优化</h3>
<p><strong>linux优化</strong></p>
<p>1、修改<code>/etc/sysctl.conf</code>优化内核相关参数，可以把tcp缓存池容量、连接数等调大</p>
<p>2、通过<code>/etc/security/limits.conf</code>修改资源限制，一般在最后增加如下两行（意思是控制打开文件数量的限制）</p>
<pre><code>* soft nofile 65535
* hard nofile 65535</code></pre>
<p><code>*</code>表示对所有用户有效，<code>soft</code>表示当前系统生效的设置，<code>hard</code>表示系统中可以设置的最大值（<code>soft</code>的值要小于等于<code>hard</code>），<code>nofile</code>表示要控制的是打开文件的最大数，该数目就是65535</p>
<p><strong>MyCat优化</strong></p>
<p>1、修改<code>/conf/wrapper.conf</code>优化JVM参数，主要是修改直接内存的大小<code>wrapper.java.additional.5=-XX:MaxDirectMemorySize=4G</code>，对于独占服务器，最好设置为系统内存的一半或者三分之二</p>
<p>2、server.xml的system标签中的参数，主要有如下：</p>
<ul>
<li>frontWriteQueueSize:
指定前端写队列大小，当MyCat返回的结果集较大时，需要调大</li>
<li>processors: 指定系统可用线程的数量，根据CPU压力，可以是CPU*4</li>
<li>processorBufferPool:
指定所用的ByteBuffer池的总字节容量，单位为字节，默认是2M(2097152B)</li>
<li>processorBufferChunk:
指定所使用的单个ByteBuffer的容量，单位为字节，默认是4K(4096B)</li>
<li>processorExecutor: 每个processor的线程池大小，可以为16-64</li>
</ul>
<p><strong>MySQL优化</strong></p>
<p>修改<code>my.cnf</code>优化MySQL配置</p>
<ul>
<li>default_storage_engine:
建议使用InnoDB引擎（MySQL5.7中为默认值）</li>
<li>max_allowed_packet: 最大传输包的大小，如果结果集较大，需要调大</li>
<li>relay_log:
主从复制日志，建议使用专有的文件名，否则默认使用主机名作为文件名，不方便管理，而且最好不要放在和数据文件相同的目录，应该区分开</li>
<li>innodb_flush_log_at_trx_commit: innoDB写入磁盘的频率，一般设置为2
<ul>
<li>0: log buffer将每秒一次地写入log file中，并且log
file的flush(刷到磁盘)操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作。该模式速度最快，但不太安全，mysqld进程的崩溃会导致上一秒钟所有事务数据的丢失</li>
<li>1: 每次事务提交时MySQL都会把log buffer的数据写入log
file，并且flush(刷到磁盘)中去，该模式为系统默认。该模式是最安全的，但也是最慢的一种方式，在mysqld服务崩溃或者服务器主机crash的情况下，binary_log只有可能丢失最多一个语句或者一个事务</li>
<li>2: 每次事务提交时MySQL都会把log buffer的数据写入log
file，但是flush(刷到磁盘)操作并不会同时进行。该模式下，MySQL会每秒执行一次
flush(刷到磁盘)操作。该模式速度较快，也比0安全，只有在操作系统崩溃或者系统断电的情况下，上一秒钟所有事务数据才可能丢失</li>
</ul></li>
<li>innodb_file_per_table:
是否使用独立表空间，建议设置为1，使用单独的表空间，以便空间回收
<ul>
<li>共享表空间：某一个数据库的所有的表数据，索引文件全部放在一个文件中，默认这个共享表空间的文件路径在data目录下，这样方便管理，但是如果一个表做了大量删除操作后表空间中将会有大量的空隙，对于统计分析，日志系统这类应用最不适合用共享表空间</li>
<li>独立表空间：每一个表都将会生成以独立的文件方式来进行存储，每一个表都有一个.frm表描述文件，还有一个.ibd文件，这样可以实现单表在不同的数据库中移动，而且空间可以回收（除drop
table操作处，表空不能自已回收）。相比较之下，使用独占表空间的效率以及性能会更高一点</li>
</ul></li>
<li>innodb_buffer_pool_size:
如果是独占服务器，最好设置为系统内存的三分之二以上</li>
<li>innodb_buffer_pool_instances:
创建的缓存池的实例个数，每个实例的大小就是<code>innodb_buffer_pool_size/innodb_buffer_pool_instances</code></li>
</ul>
<h2 id="solr">Solr</h2>
<h3 id="安装-2">安装</h3>
<p>下载地址：<a href="https://lucene.apache.org/solr/">Apache
Solr</a>，<a href="http://lucene.apache.org/solr/guide/7_5/index.html">Solr-7.5文档</a></p>
<p>Solr对中文支持不太好，所以需要另外安装中文分词器，这里用的是<a href="https://code.google.com/archive/p/ik-analyzer/">IKAnalyzer2012</a>或者<a href="https://github.com/magese/ik-analyzer-solr7">ik-analyzer-solr7</a></p>
<p><strong>Solr安装</strong></p>
<p>下载完Solr后，解压，运行</p>
<div class="sourceCode" id="cb479"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb479-1"><a href="#cb479-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span> solr-7.5.0.zip</span>
<span id="cb479-2"><a href="#cb479-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mv solr-7.5.0 /opt/solr</span>
<span id="cb479-3"><a href="#cb479-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /opt/solr/bin/</span>
<span id="cb479-4"><a href="#cb479-4" aria-hidden="true" tabindex="-1"></a><span class="ex">solr</span> start <span class="at">-p</span> 8983</span></code></pre></div>
<p>此时可以通过<code>http://127.0.0.1:8983/solr</code>访问Solr的web界面，我们可以使用web界面创建core，也可以通过命令行创建core（core就是solr的一个实例，一个solr服务下可以有多个core，每个core下都有自己的索引库和与之相应的配置文件，类似数据库中的database和table的关系），下面以命令行为例</p>
<pre class="shell"><code>solr create -c corename</code></pre>
<p>命令说明</p>
<ul>
<li><code>solr -help</code>: 查看帮助</li>
<li><code>bin/solr start</code>:
单机版启动，可以加<code>-cloud</code>参数改为分布式启动；默认端口为8983，也可以通过<code>-p</code>参数指定其他端口；可以通过<code>-f</code>参数指定为前台启动</li>
<li><code>solr restart</code>: 重启Solr</li>
<li><code>solr stop -all</code>: 停止Solr</li>
<li><code>solr status</code>: 查看Solr状态</li>
<li><code>solr create -c corename</code>:
创建指定名字的core，默认的创建位置在solr安装目录下的<code>server/solr</code>下</li>
<li><code>solr delete -c corename</code>: 删除core</li>
</ul>
<p><strong>中文分词器安装</strong></p>
<p>解压分词器的压缩包，把<code>ik-analyzer-7.5.0.jar</code>复制到Solr安装目录下的<code>server/solr-webapp/webapp/WEB-INF/lib</code>中，把<code>IKAnalyzer.cfg.xml</code>、<code>ext.dic</code>、<code>stopword.dic</code>、<code>ik.conf</code>、<code>dynamicdic.txt</code>五个文件复制到<code>server/solr-webapp/webapp/WEB-INF/classes</code>中，其中<code>classes</code>文件夹需要手动创建</p>
<p>在<code>server/solr/configsets/_default/conf/managed-schema</code>中配置</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb481-1"><a href="#cb481-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ik分词器 --&gt;</span></span>
<span id="cb481-2"><a href="#cb481-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">fieldType</span><span class="ot"> name=</span><span class="st">&quot;text_ik&quot;</span><span class="ot"> class=</span><span class="st">&quot;solr.TextField&quot;</span>&gt;</span>
<span id="cb481-3"><a href="#cb481-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">analyzer</span><span class="ot"> type=</span><span class="st">&quot;index&quot;</span><span class="ot"> useSmart=</span><span class="st">&quot;false&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.wltea.analyzer.lucene.IKAnalyzer&quot;</span>/&gt;</span>
<span id="cb481-4"><a href="#cb481-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">analyzer</span><span class="ot"> type=</span><span class="st">&quot;query&quot;</span><span class="ot"> useSmart=</span><span class="st">&quot;false&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.wltea.analyzer.lucene.IKAnalyzer&quot;</span>/&gt;</span>
<span id="cb481-5"><a href="#cb481-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">fieldType</span>&gt;</span>
<span id="cb481-6"><a href="#cb481-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb481-7"><a href="#cb481-7" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 使用ik.conf配置文件可以这样配 --&gt;</span></span>
<span id="cb481-8"><a href="#cb481-8" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">fieldType</span><span class="ot"> name=</span><span class="st">&quot;text_ik&quot;</span><span class="ot"> class=</span><span class="st">&quot;solr.TextField&quot;</span>&gt;</span>
<span id="cb481-9"><a href="#cb481-9" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">analyzer</span><span class="ot"> type=</span><span class="st">&quot;index&quot;</span>&gt;</span>
<span id="cb481-10"><a href="#cb481-10" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">tokenizer</span><span class="ot"> class=</span><span class="st">&quot;org.wltea.analyzer.lucene.IKTokenizerFactory&quot;</span><span class="ot"> useSmart=</span><span class="st">&quot;false&quot;</span><span class="ot"> conf=</span><span class="st">&quot;ik.conf&quot;</span>/&gt;</span>
<span id="cb481-11"><a href="#cb481-11" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">filter</span><span class="ot"> class=</span><span class="st">&quot;solr.LowerCaseFilterFactory&quot;</span>/&gt;</span>
<span id="cb481-12"><a href="#cb481-12" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">analyzer</span>&gt;</span>
<span id="cb481-13"><a href="#cb481-13" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">analyzer</span><span class="ot"> type=</span><span class="st">&quot;query&quot;</span>&gt;</span>
<span id="cb481-14"><a href="#cb481-14" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">tokenizer</span><span class="ot"> class=</span><span class="st">&quot;org.wltea.analyzer.lucene.IKTokenizerFactory&quot;</span><span class="ot"> useSmart=</span><span class="st">&quot;true&quot;</span><span class="ot"> conf=</span><span class="st">&quot;ik.conf&quot;</span>/&gt;</span>
<span id="cb481-15"><a href="#cb481-15" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">filter</span><span class="ot"> class=</span><span class="st">&quot;solr.LowerCaseFilterFactory&quot;</span>/&gt;</span>
<span id="cb481-16"><a href="#cb481-16" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">analyzer</span>&gt;</span>
<span id="cb481-17"><a href="#cb481-17" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">fieldType</span>&gt;</span></code></pre></div>
<p>这时使用<code>solr create -c corename</code>创建的core就会使用该配置创建；如果是使用web端创建，会提示创建失败，但<code>server/solr</code>下确实多了一个叫corename的文件夹，这时我们手动把<code>server/solr/configsets/_default</code>下的conf文件夹复制到<code>server/solr/corename</code>中即可；如果是之前就创建好的core，直接修改<code>server/solr/corename</code>下的配置文件即可</p>
<p>重启Solr，然后登录web端，找到刚才创建的corename，选择Analysis标签，即可测试分词器</p>
<p>如果想要扩展词库，可以在ext.dic文件中配置自定义的中文词组（编码是UTF-8无BOM模式），在stopword.dic中配置禁止使用的词</p>
<h3 id="配置-3">配置</h3>
<h4 id="field相关">field相关</h4>
<p>前面都是使用默认配置，Solr的配置在<code>server/solr/configsets</code>中，默认配置的文件夹是<code>_default</code>，其中<code>managed-schema</code>是主要的配置文件，它负责管理字段相关的配置</p>
<ul>
<li>field:
创建索引用的字段，可以通过<code>indexed</code>指定是否生成索引，通过<code>stored</code>指定是否存储索引，通过<code>required</code>指定是否必须，通过<code>multiValued</code>指定是否可以有多个值，通过<code>type</code>指定其类型，该类型由<code>fieldType</code>标签定义</li>
<li>dynamicField:
动态字段，允许solr索引没有在schema中明确定义的字段，其实就是可以使用通配符适配的字段（先在常规字段中匹配，没有再匹配动态字段）</li>
<li>copyField:
把指定<code>source</code>的数据复制到<code>dest</code>中，<code>source</code>和<code>dest</code>都可以使用通配符，如果查询字段要来自多个字段，使用CopyField可以化多个字段为一个字段，但缺点是不能区分各个字段的重要度差别</li>
<li>fieldType:
为field定义类型，最主要作用是定义分词器，分词器决定着如何从文档中检索关键字
<ul>
<li>analyzer:
分词器，是fieldType的子标签，它通过<code>tokenizer</code>子标签指定分词器的class，通过<code>filter</code>指定过滤器</li>
</ul></li>
</ul>
<p>下面是一个简单使用的例子</p>
<div class="sourceCode" id="cb482"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb482-1"><a href="#cb482-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;id&quot;</span><span class="ot"> type=</span><span class="st">&quot;string&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;true&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span><span class="ot"> required=</span><span class="st">&quot;true&quot;</span><span class="ot"> multiValued=</span><span class="st">&quot;false&quot;</span> /&gt;</span>
<span id="cb482-2"><a href="#cb482-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;_text_&quot;</span><span class="ot"> type=</span><span class="st">&quot;text_general&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;true&quot;</span><span class="ot"> stored=</span><span class="st">&quot;false&quot;</span><span class="ot"> multiValued=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb482-3"><a href="#cb482-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-4"><a href="#cb482-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dynamicField</span><span class="ot"> name=</span><span class="st">&quot;*_t&quot;</span><span class="ot"> type=</span><span class="st">&quot;text_general&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;true&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span><span class="ot"> multiValued=</span><span class="st">&quot;false&quot;</span>/&gt;</span>
<span id="cb482-5"><a href="#cb482-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-6"><a href="#cb482-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">copyField</span><span class="ot"> source=</span><span class="st">&quot;*_name&quot;</span><span class="ot"> dest=</span><span class="st">&quot;destinationFieldName&quot;</span><span class="ot"> maxChars=</span><span class="st">&quot;30000&quot;</span>/&gt;</span>
<span id="cb482-7"><a href="#cb482-7" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">copyField</span><span class="ot"> source=</span><span class="st">&quot;*_content&quot;</span><span class="ot"> dest=</span><span class="st">&quot;destinationFieldName&quot;</span><span class="ot"> maxChars=</span><span class="st">&quot;30000&quot;</span>/&gt;</span>
<span id="cb482-8"><a href="#cb482-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-9"><a href="#cb482-9" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">uniqueKey</span>&gt;id&lt;/<span class="kw">uniqueKey</span>&gt;</span>
<span id="cb482-10"><a href="#cb482-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb482-11"><a href="#cb482-11" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">fieldType</span><span class="ot"> name=</span><span class="st">&quot;string&quot;</span><span class="ot"> class=</span><span class="st">&quot;solr.StrField&quot;</span><span class="ot"> sortMissingLast=</span><span class="st">&quot;true&quot;</span><span class="ot"> docValues=</span><span class="st">&quot;true&quot;</span> /&gt;</span>
<span id="cb482-12"><a href="#cb482-12" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">fieldType</span><span class="ot"> name=</span><span class="st">&quot;text_general&quot;</span><span class="ot"> class=</span><span class="st">&quot;solr.TextField&quot;</span><span class="ot"> positionIncrementGap=</span><span class="st">&quot;100&quot;</span><span class="ot"> multiValued=</span><span class="st">&quot;true&quot;</span>&gt;</span>
<span id="cb482-13"><a href="#cb482-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">analyzer</span><span class="ot"> type=</span><span class="st">&quot;index&quot;</span>&gt;</span>
<span id="cb482-14"><a href="#cb482-14" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">tokenizer</span><span class="ot"> class=</span><span class="st">&quot;solr.StandardTokenizerFactory&quot;</span>/&gt;</span>
<span id="cb482-15"><a href="#cb482-15" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">filter</span><span class="ot"> class=</span><span class="st">&quot;solr.StopFilterFactory&quot;</span><span class="ot"> ignoreCase=</span><span class="st">&quot;true&quot;</span><span class="ot"> words=</span><span class="st">&quot;stopwords.txt&quot;</span> /&gt;</span>
<span id="cb482-16"><a href="#cb482-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">filter</span><span class="ot"> class=</span><span class="st">&quot;solr.LowerCaseFilterFactory&quot;</span>/&gt;</span>
<span id="cb482-17"><a href="#cb482-17" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">analyzer</span>&gt;</span>
<span id="cb482-18"><a href="#cb482-18" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">fieldType</span>&gt;</span></code></pre></div>
<p>如果直接修改上面的配置需要重启Solr，在实际应用中，我们需要动态修改配置而不重启，这时可以使用Solr的Schema
API上传配置</p>
<p>Schema
API其实就是用post请求向Solr服务器发送携带json参数的请求，所有操作内容都封装在json中，如果是linux系统直接使用curl工具，如果是windows系统推荐使用Postman</p>
<p>Solr的配置上传可以使用web界面，也可以使用命令行，在Solr安装目录下的<code>example/exampledocs</code>有一个<code>post.jar</code>可以通过该jar包上传数据</p>
<pre class="shell"><code>java -jar post.jar -help

# corename为core的名字，*.xml为要上传的文件
# 通过java参数上传
java -Durl=http://localhost:8983/solr/corename/update -jar post.jar *.xml
# 或者
java -Dtype=text/csv -Dc=corename -jar post.jar *.csv

# 通过curl工具上传
curl http://localhost:8983/solr/corename/update --data-binary @*.xml -H &#39;Content-type:text/xml; charset=utf-8&#39;
# 或者使用json数据，具体参考文档中Documents, Fields, and Schema Design一章中Schema API小节
curl -X POST -H &#39;Content-type:application/json&#39; --data-binary &#39;{
  &quot;add-field&quot;:{
     &quot;name&quot;:&quot;sell_by&quot;,
     &quot;type&quot;:&quot;pdate&quot;,
     &quot;stored&quot;:true }
}&#39; http://localhost:8983/solr/corename/schema

curl -X POST -H &#39;Content-type:application/json&#39; --data-binary &#39;{
  &quot;delete-field&quot; : { &quot;name&quot;:&quot;sell_by&quot; }
}&#39; http://localhost:8983/solr/corename/schema

curl -X POST -H &#39;Content-type:application/json&#39; --data-binary &#39;{
  &quot;replace-field&quot;:{
     &quot;name&quot;:&quot;sell_by&quot;,
     &quot;type&quot;:&quot;date&quot;,
     &quot;stored&quot;:false }
}&#39; http://localhost:8983/solr/corename/schema</code></pre>
<h4 id="dhi">DHI</h4>
<p>DIH全称是Data Import
Handler数据导入处理器，大部分情况下我们需要连接数据库来对数据进行索引，来提升我们的查询效率</p>
<p>下载mysql连接驱动<code>mysql-connector-java-8.0.13.jar</code>，并找到Solr安装目录下的<code>dist</code>文件夹下的<code>solr-dataimporthandler-7.5.0.jar</code>和<code>solr-dataimporthandler-extras-7.5.0.jar</code>两个jar包，复制到<code>server\solr-webapp\webapp\WEB-INF\lib</code>中</p>
<p>数据库的配置可以参考<code>example/example-DIH/solr/db/conf</code></p>
<p>修改<code>server/solr/corename/conf</code>下的<code>solrconfig.xml</code>，指定数据库配置文件的位置，其中<code>/dataimport</code>是指当请求以<code>http://localhost:8983/solr/corename/dataimport/</code>开头时(<code>localhost:8983</code>可以是其他url)，匹配该数据库配置文件（Solr命令执行的方式就是通过发起命令请求）</p>
<div class="sourceCode" id="cb484"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb484-1"><a href="#cb484-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">requestHandler</span><span class="ot"> name=</span><span class="st">&quot;/dataimport&quot;</span><span class="ot"> class=</span><span class="st">&quot;solr.DataImportHandler&quot;</span>&gt;</span>
<span id="cb484-2"><a href="#cb484-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">lst</span><span class="ot"> name=</span><span class="st">&quot;defaults&quot;</span>&gt;</span>
<span id="cb484-3"><a href="#cb484-3" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">str</span><span class="ot"> name=</span><span class="st">&quot;config&quot;</span>&gt;db-data-config.xml&lt;/<span class="kw">str</span>&gt;</span>
<span id="cb484-4"><a href="#cb484-4" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">lst</span>&gt;</span>
<span id="cb484-5"><a href="#cb484-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">requestHandler</span>&gt;</span></code></pre></div>
<p>修改<code>db-data-config.xml</code>，配置entity与数据库中字段的对应关系（document相当于数据库中的database，entity相当于数据库中的一个表），比如</p>
<div class="sourceCode" id="cb485"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb485-1"><a href="#cb485-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dataConfig</span>&gt;</span>
<span id="cb485-2"><a href="#cb485-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataSource</span><span class="ot"> driver=</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span><span class="ot"> url=</span><span class="st">&quot;jdbc:mysql://127.0.0.1:3306/solr?charactorEncoding=utf-8&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;root&quot;</span> /&gt;</span>
<span id="cb485-3"><a href="#cb485-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">document</span>&gt;</span>
<span id="cb485-4"><a href="#cb485-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">entity</span><span class="ot"> name=</span><span class="st">&quot;student&quot;</span><span class="ot"> query=</span><span class="st">&quot;select * from student&quot;</span><span class="ot"> pk=</span><span class="st">&quot;id&quot;</span>&gt;</span>
<span id="cb485-5"><a href="#cb485-5" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;id&quot;</span><span class="ot"> name=</span><span class="st">&quot;id&quot;</span> /&gt;</span>
<span id="cb485-6"><a href="#cb485-6" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;name&quot;</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span> /&gt;</span>
<span id="cb485-7"><a href="#cb485-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;code&quot;</span><span class="ot"> name=</span><span class="st">&quot;code&quot;</span> /&gt;</span>
<span id="cb485-8"><a href="#cb485-8" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;create_time&quot;</span><span class="ot"> name=</span><span class="st">&quot;createTime&quot;</span> /&gt;</span>
<span id="cb485-9"><a href="#cb485-9" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">entity</span>&gt;</span>
<span id="cb485-10"><a href="#cb485-10" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">document</span>&gt;</span>
<span id="cb485-11"><a href="#cb485-11" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dataConfig</span>&gt;</span></code></pre></div>
<p>数据库的建表语句如下</p>
<div class="sourceCode" id="cb486"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb486-1"><a href="#cb486-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> `student` (</span>
<span id="cb486-2"><a href="#cb486-2" aria-hidden="true" tabindex="-1"></a>  `id` bigint(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> AUTO_INCREMENT,</span>
<span id="cb486-3"><a href="#cb486-3" aria-hidden="true" tabindex="-1"></a>  `name` <span class="dt">varchar</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb486-4"><a href="#cb486-4" aria-hidden="true" tabindex="-1"></a>  `code` <span class="dt">varchar</span>(<span class="dv">20</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb486-5"><a href="#cb486-5" aria-hidden="true" tabindex="-1"></a>  `create_time` datetime <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb486-6"><a href="#cb486-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (`id`)</span>
<span id="cb486-7"><a href="#cb486-7" aria-hidden="true" tabindex="-1"></a>) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8;</span>
<span id="cb486-8"><a href="#cb486-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb486-9"><a href="#cb486-9" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> student <span class="fu">value</span>(<span class="st">&#39;1&#39;</span>,<span class="st">&#39;小明&#39;</span>,<span class="st">&#39;hello world&#39;</span>,<span class="st">&#39;2018-10-01&#39;</span>);</span>
<span id="cb486-10"><a href="#cb486-10" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> student <span class="fu">value</span>(<span class="st">&#39;2&#39;</span>,<span class="st">&#39;小红&#39;</span>,<span class="st">&#39;hello 小明&#39;</span>,<span class="st">&#39;2018-10-01&#39;</span>);</span></code></pre></div>
<p>修改<code>managed-schema</code>，配置entity的索引，要和上面的配置对应</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;id&quot;</span><span class="ot"> required=</span><span class="st">&quot;true&quot;</span><span class="ot"> type=</span><span class="st">&quot;string&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;true&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb487-2"><a href="#cb487-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span><span class="ot"> type=</span><span class="st">&quot;string&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;true&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb487-3"><a href="#cb487-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;code&quot;</span><span class="ot"> type=</span><span class="st">&quot;string&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;false&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb487-4"><a href="#cb487-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">field</span><span class="ot"> name=</span><span class="st">&quot;createTime&quot;</span><span class="ot"> type=</span><span class="st">&quot;pdate&quot;</span><span class="ot"> indexed=</span><span class="st">&quot;false&quot;</span><span class="ot"> stored=</span><span class="st">&quot;true&quot;</span>/&gt;</span>
<span id="cb487-5"><a href="#cb487-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb487-6"><a href="#cb487-6" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">uniqueKey</span>&gt;id&lt;/<span class="kw">uniqueKey</span>&gt;</span></code></pre></div>
<p>配置完成后重启Solr，访问
http://127.0.0.1:8983/solr/#/corename/dataimport//dataimport
，里面的Entity中有我们设置的student，点击Refresh Status导入数据</p>
<p>上面的导入方式是手动的全量导入，如果要自动增量导入，需要使用<a href="https://github.com/yunois/solr-dataimportscheduler">solr-dataimportscheduler</a></p>
<p>全量导入其实就是发送<code>http://localhost:8983/solr/corename/dataimport?command=full-import</code>指令，增量导入就是发送<code>http://localhost:8983/solr/corename/dataimport?command=delta-import</code>指令</p>
<p>修改<code>server/solr-webapp/webapp/WEB-INF</code>下的<code>web.xml</code>，添加监听器配置</p>
<div class="sourceCode" id="cb488"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb488-1"><a href="#cb488-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">listener</span>&gt;</span>
<span id="cb488-2"><a href="#cb488-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">listener-class</span>&gt;</span>
<span id="cb488-3"><a href="#cb488-3" aria-hidden="true" tabindex="-1"></a>        org.apache.solr.handler.dataimport.scheduler.ApplicationListener</span>
<span id="cb488-4"><a href="#cb488-4" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">listener-class</span>&gt;</span>
<span id="cb488-5"><a href="#cb488-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">listener</span>&gt;</span></code></pre></div>
<p>在<code>server/solr</code>下创建<code>conf</code>文件夹，在此文件夹下创建<code>dataimport.properties</code>文件，内容如下</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a><span class="co">#################################################</span></span>
<span id="cb489-2"><a href="#cb489-2" aria-hidden="true" tabindex="-1"></a><span class="co">#       dataimport scheduler properties         #</span></span>
<span id="cb489-3"><a href="#cb489-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                                               #</span></span>
<span id="cb489-4"><a href="#cb489-4" aria-hidden="true" tabindex="-1"></a><span class="co">#################################################</span></span>
<span id="cb489-5"><a href="#cb489-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  to sync or not to sync</span></span>
<span id="cb489-6"><a href="#cb489-6" aria-hidden="true" tabindex="-1"></a><span class="co">#  1 - active; anything else - inactive</span></span>
<span id="cb489-7"><a href="#cb489-7" aria-hidden="true" tabindex="-1"></a><span class="dt">syncEnabled</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb489-8"><a href="#cb489-8" aria-hidden="true" tabindex="-1"></a><span class="co">#  which cores to schedule</span></span>
<span id="cb489-9"><a href="#cb489-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  in a multi-core environment you can decide which cores you want syncronized</span></span>
<span id="cb489-10"><a href="#cb489-10" aria-hidden="true" tabindex="-1"></a><span class="co">#  leave empty or comment it out if using single-core deployment</span></span>
<span id="cb489-11"><a href="#cb489-11" aria-hidden="true" tabindex="-1"></a><span class="co">#  修改成你所使用的core</span></span>
<span id="cb489-12"><a href="#cb489-12" aria-hidden="true" tabindex="-1"></a><span class="dt">syncCores</span><span class="ot">=</span><span class="st">test01</span></span>
<span id="cb489-13"><a href="#cb489-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  solr server name or IP address</span></span>
<span id="cb489-14"><a href="#cb489-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  [defaults to localhost if empty]</span></span>
<span id="cb489-15"><a href="#cb489-15" aria-hidden="true" tabindex="-1"></a><span class="co">#  这个一般都是localhost不会变</span></span>
<span id="cb489-16"><a href="#cb489-16" aria-hidden="true" tabindex="-1"></a><span class="dt">server</span><span class="ot">=</span><span class="st">172.0.0.1</span></span>
<span id="cb489-17"><a href="#cb489-17" aria-hidden="true" tabindex="-1"></a><span class="co">#  solr server port</span></span>
<span id="cb489-18"><a href="#cb489-18" aria-hidden="true" tabindex="-1"></a><span class="co">#  [defaults to 80 if empty]</span></span>
<span id="cb489-19"><a href="#cb489-19" aria-hidden="true" tabindex="-1"></a><span class="co">#  安装solr的tomcat端口，如果你使用的是默认的端口，就不用改了，否则改成自己的端口就好了</span></span>
<span id="cb489-20"><a href="#cb489-20" aria-hidden="true" tabindex="-1"></a><span class="dt">port</span><span class="ot">=</span><span class="dv">8983</span></span>
<span id="cb489-21"><a href="#cb489-21" aria-hidden="true" tabindex="-1"></a><span class="co">#  application name/context</span></span>
<span id="cb489-22"><a href="#cb489-22" aria-hidden="true" tabindex="-1"></a><span class="co">#  [defaults to current ServletContextListener&#39;s context (app) name]</span></span>
<span id="cb489-23"><a href="#cb489-23" aria-hidden="true" tabindex="-1"></a><span class="co">#  这里默认不改</span></span>
<span id="cb489-24"><a href="#cb489-24" aria-hidden="true" tabindex="-1"></a><span class="dt">webapp</span><span class="ot">=</span><span class="st">/</span></span>
<span id="cb489-25"><a href="#cb489-25" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span></span>
<span id="cb489-26"><a href="#cb489-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  URL params [mandatory]</span></span>
<span id="cb489-27"><a href="#cb489-27" aria-hidden="true" tabindex="-1"></a><span class="co">#  remainder of URL</span></span>
<span id="cb489-28"><a href="#cb489-28" aria-hidden="true" tabindex="-1"></a><span class="co">#  这里改成下面的形式，solr同步数据时请求的链接</span></span>
<span id="cb489-29"><a href="#cb489-29" aria-hidden="true" tabindex="-1"></a><span class="dt">params</span><span class="ot">=</span><span class="st">/dataimport?command=delta-import&amp;clean=false&amp;commit=true</span></span>
<span id="cb489-30"><a href="#cb489-30" aria-hidden="true" tabindex="-1"></a><span class="co">#  schedule interval</span></span>
<span id="cb489-31"><a href="#cb489-31" aria-hidden="true" tabindex="-1"></a><span class="co">#  number of minutes between two runs</span></span>
<span id="cb489-32"><a href="#cb489-32" aria-hidden="true" tabindex="-1"></a><span class="co">#  [defaults to 30 if empty]</span></span>
<span id="cb489-33"><a href="#cb489-33" aria-hidden="true" tabindex="-1"></a><span class="co">#  这里是设置定时任务的，单位是秒，也就是多长时间你检测一次数据同步，根据项目需求修改</span></span>
<span id="cb489-34"><a href="#cb489-34" aria-hidden="true" tabindex="-1"></a><span class="co">#  开始测试的时候为了方便看到效果，时间可以设置短一点</span></span>
<span id="cb489-35"><a href="#cb489-35" aria-hidden="true" tabindex="-1"></a><span class="dt">interval</span><span class="ot">=</span><span class="dv">30</span></span>
<span id="cb489-36"><a href="#cb489-36" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span></span>
<span id="cb489-37"><a href="#cb489-37" aria-hidden="true" tabindex="-1"></a><span class="co">#  重做索引的时间间隔，单位分钟，默认7200，即5天; </span></span>
<span id="cb489-38"><a href="#cb489-38" aria-hidden="true" tabindex="-1"></a><span class="co">#  为空,为0,或者注释掉:表示永不重做索引</span></span>
<span id="cb489-39"><a href="#cb489-39" aria-hidden="true" tabindex="-1"></a><span class="co">#reBuildIndexInterval=7200</span></span>
<span id="cb489-40"><a href="#cb489-40" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span></span>
<span id="cb489-41"><a href="#cb489-41" aria-hidden="true" tabindex="-1"></a><span class="co">#  重做索引的参数</span></span>
<span id="cb489-42"><a href="#cb489-42" aria-hidden="true" tabindex="-1"></a><span class="co">#reBuildIndexParams=/select?qt=/dataimport&amp;command=full-import&amp;clean=true&amp;commit=true</span></span>
<span id="cb489-43"><a href="#cb489-43" aria-hidden="true" tabindex="-1"></a><span class="dt">  </span></span>
<span id="cb489-44"><a href="#cb489-44" aria-hidden="true" tabindex="-1"></a><span class="co">#  重做索引时间间隔的计时开始时间，第一次真正执行的时间=reBuildIndexBeginTime+reBuildIndexInterval*60*1000；</span></span>
<span id="cb489-45"><a href="#cb489-45" aria-hidden="true" tabindex="-1"></a><span class="co">#  两种格式：2012-04-11 03:10:00 或者  03:10:00，后一种会自动补全日期部分为服务启动时的日期</span></span>
<span id="cb489-46"><a href="#cb489-46" aria-hidden="true" tabindex="-1"></a><span class="co">#reBuildIndexBeginTime=03:10:00</span></span>
<span id="cb489-47"><a href="#cb489-47" aria-hidden="true" tabindex="-1"></a><span class="co">#  延迟执行时间 默认是30分钟</span></span>
<span id="cb489-48"><a href="#cb489-48" aria-hidden="true" tabindex="-1"></a><span class="dt">initialDelay</span><span class="ot">=</span><span class="dv">1</span></span>
<span id="cb489-49"><a href="#cb489-49" aria-hidden="true" tabindex="-1"></a><span class="co">#  执行线程数 默认是10</span></span>
<span id="cb489-50"><a href="#cb489-50" aria-hidden="true" tabindex="-1"></a><span class="dt">threadPoolCount</span><span class="ot">=</span><span class="dv">10</span></span></code></pre></div>
<p>在<code>server/solr/corename/conf/db-data-config.xml</code>中添加<code>deltaImportQuery</code>和<code>deltaQuery</code>，指定增量时使用的SQL</p>
<div class="sourceCode" id="cb490"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb490-1"><a href="#cb490-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dataConfig</span>&gt;</span>
<span id="cb490-2"><a href="#cb490-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">dataSource</span><span class="ot"> driver=</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span><span class="ot"> url=</span><span class="st">&quot;jdbc:mysql://127.0.0.1:3306/solr?charactorEncoding=utf-8&quot;</span><span class="ot"> user=</span><span class="st">&quot;root&quot;</span><span class="ot"> password=</span><span class="st">&quot;root&quot;</span> /&gt;</span>
<span id="cb490-3"><a href="#cb490-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">document</span>&gt;</span>
<span id="cb490-4"><a href="#cb490-4" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">entity</span><span class="ot"> name=</span><span class="st">&quot;student&quot;</span><span class="ot"> query=</span><span class="st">&quot;select * from student&quot;</span><span class="ot"> pk=</span><span class="st">&quot;id&quot;</span></span>
<span id="cb490-5"><a href="#cb490-5" aria-hidden="true" tabindex="-1"></a><span class="ot">            deltaImportQuery=</span><span class="st">&quot;select * from student where id=&#39;${dataimporter.delta.id}&#39;&quot;</span></span>
<span id="cb490-6"><a href="#cb490-6" aria-hidden="true" tabindex="-1"></a><span class="ot">            deltaQuery=</span><span class="st">&quot;select * from student where `create_time` &gt; &#39;${dataimporter.last_index_time}&#39;&quot;</span>&gt;</span>
<span id="cb490-7"><a href="#cb490-7" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;id&quot;</span><span class="ot"> name=</span><span class="st">&quot;id&quot;</span> /&gt;</span>
<span id="cb490-8"><a href="#cb490-8" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;name&quot;</span><span class="ot"> name=</span><span class="st">&quot;name&quot;</span> /&gt;</span>
<span id="cb490-9"><a href="#cb490-9" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;code&quot;</span><span class="ot"> name=</span><span class="st">&quot;code&quot;</span> /&gt;</span>
<span id="cb490-10"><a href="#cb490-10" aria-hidden="true" tabindex="-1"></a>            &lt;<span class="kw">field</span><span class="ot"> column=</span><span class="st">&quot;create_time&quot;</span><span class="ot"> name=</span><span class="st">&quot;createTime&quot;</span> /&gt;</span>
<span id="cb490-11"><a href="#cb490-11" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">entity</span>&gt;</span>
<span id="cb490-12"><a href="#cb490-12" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">document</span>&gt;</span>
<span id="cb490-13"><a href="#cb490-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dataConfig</span>&gt;</span></code></pre></div>
<p><code>${dataimporter.delta.id}</code>是根据主键的名字写的，如果主键id配置的不叫id，如叫studentId，那么，这个取变量就应该写成<code>${dataimporter.delta.studentId}</code>，而<code>${dataimporter.last_index_time}</code>是固定写法</p>
<p>在<code>solr/server/solr/corename/conf</code>中创建<code>dataimport.properties</code>文件（和前面的配置文件名字相同但路径不同），内容如下</p>
<div class="sourceCode" id="cb491"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 往前推迟的数量，单位秒</span></span>
<span id="cb491-2"><a href="#cb491-2" aria-hidden="true" tabindex="-1"></a><span class="dt">before_second:1</span></span>
<span id="cb491-3"><a href="#cb491-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 最后更新时间，系统默认添加，每次系统自己记录</span></span>
<span id="cb491-4"><a href="#cb491-4" aria-hidden="true" tabindex="-1"></a><span class="dt">student.last_index_time:2018-10-01 00\:00\:00</span></span>
<span id="cb491-5"><a href="#cb491-5" aria-hidden="true" tabindex="-1"></a><span class="dt">last_index_time:2018-10-01 00\:00\:00</span></span></code></pre></div>
<h3 id="添加数据">添加数据</h3>
<p>使用web端添加数据可以在core的Documents页面使用xml格式添加</p>
<div class="sourceCode" id="cb492"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb492-1"><a href="#cb492-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Solr没有更新，如果id已存在则是更新，否则是插入 --&gt;</span></span>
<span id="cb492-2"><a href="#cb492-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">add</span>&gt; </span>
<span id="cb492-3"><a href="#cb492-3" aria-hidden="true" tabindex="-1"></a>   &lt;<span class="kw">doc</span>&gt; </span>
<span id="cb492-4"><a href="#cb492-4" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">field</span><span class="ot"> name</span> <span class="ot">=</span> <span class="st">&quot;id&quot;</span>&gt;1&lt;/<span class="kw">field</span>&gt;</span>
<span id="cb492-5"><a href="#cb492-5" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">field</span><span class="ot"> name</span> <span class="ot">=</span> <span class="st">&quot;name&quot;</span>&gt;小明&lt;/<span class="kw">field</span>&gt;</span>
<span id="cb492-6"><a href="#cb492-6" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">field</span><span class="ot"> name</span> <span class="ot">=</span> <span class="st">&quot;age&quot;</span>&gt;14&lt;/<span class="kw">field</span>&gt;</span>
<span id="cb492-7"><a href="#cb492-7" aria-hidden="true" tabindex="-1"></a>   &lt;/<span class="kw">doc</span>&gt;</span>
<span id="cb492-8"><a href="#cb492-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">add</span>&gt;</span>
<span id="cb492-9"><a href="#cb492-9" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 不要忘了提交 --&gt;</span></span>
<span id="cb492-10"><a href="#cb492-10" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">commit</span> /&gt;</span>
<span id="cb492-11"><a href="#cb492-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb492-12"><a href="#cb492-12" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 根据id删除 --&gt;</span></span>
<span id="cb492-13"><a href="#cb492-13" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">delete</span>&gt;</span>
<span id="cb492-14"><a href="#cb492-14" aria-hidden="true" tabindex="-1"></a>   &lt;<span class="kw">id</span>&gt;1&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb492-15"><a href="#cb492-15" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">delete</span>&gt;</span>
<span id="cb492-16"><a href="#cb492-16" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">commit</span> /&gt;</span>
<span id="cb492-17"><a href="#cb492-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb492-18"><a href="#cb492-18" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 根据查询删除 --&gt;</span></span>
<span id="cb492-19"><a href="#cb492-19" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">delete</span>&gt; </span>
<span id="cb492-20"><a href="#cb492-20" aria-hidden="true" tabindex="-1"></a>   &lt;<span class="kw">query</span>&gt;name:小明&lt;/<span class="kw">query</span>&gt; </span>
<span id="cb492-21"><a href="#cb492-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">delete</span>&gt;</span>
<span id="cb492-22"><a href="#cb492-22" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">commit</span> /&gt;</span></code></pre></div>
<h3 id="查询语法">查询语法</h3>
<p>web端的Query页面有如下查询条件</p>
<ul>
<li><code>qt</code>(query type):
使用哪个Request-Handler处理该查询，默认是<code>/select</code>，可以在<code>server/solr/corename/conf/solrconfig.xml</code>中配置Request-Handler</li>
<li><code>q</code>(query):
查询的条件，比如<code>*:*</code>查询全部，<code>id=1</code>查询id为1的数据</li>
<li><code>fq</code>(filter query):
过虑查询，最后会返回符合q查询的结果中同时符合的fq查询的结果</li>
<li><code>sort</code>:
排序方式，比如<code>id  desc</code>根据id降序</li>
<li><code>start</code>, <code>rows</code>:
分页，类似mysql的limit，第几页，每页几条记录，默认第0页，每页10条记录</li>
<li><code>fl</code>:
指定返回哪些字段（字段区分大小写），如果有多个用逗号或空格分隔，比如<code>id,name,age</code></li>
<li><code>df</code>: 默认的查询字段</li>
<li><code>wt</code>(writer type):
输出格式，有json,xml,csv,php,python,ruby等</li>
<li><code>indent</code>:
返回的结果是否缩进，默认关闭，一般调试json,php,phps,ruby输出才有必要用这个参数</li>
<li><code>q.op</code>: q查询中的运算符（可以是AND或OR）</li>
<li><code>hl</code>: 是否高亮，比如<code>hl=true</code></li>
<li><code>hl.fl</code>:
需要高亮的字段，如果有多个用逗号或空格分隔，比如<code>hl.fl=name,age</code></li>
<li><code>hl.simple.pre</code>、<code>hl.simple.post</code>:
高亮字段用什么包裹，比如<code>hl.simple.pre=&lt;em&gt;</code>，<code>hl.simple.post=&lt;/em&gt;</code>，一般用在html输出</li>
<li><code>facet</code>: 是否启动统计</li>
<li><code>facet.field</code>: 使用统计的字段</li>
</ul>
<p>关于查询语句，可以使用如下的检索运算符</p>
<ul>
<li><code>:</code>:
指定字段查指定值，比如<code>*:*</code>、<code>name:tom</code></li>
<li><code>?</code>:
匹配单个字符，比如<code>te?t</code>，匹配test或者text</li>
<li><code>*</code>:
匹配零个或多个字符，比如<code>xiao*</code>，匹配xiao或xiaoming</li>
<li><code>AND</code>、<code>&amp;&amp;</code>:
与，两边的查询词要同时出现，比如<code>&quot;jakarta apache&quot; AND &quot;Apache Lucene&quot;</code></li>
<li><code>OR</code>、<code>||</code>: 或，两边的查询词至少出现一个</li>
<li><code>NOT</code>、<code>!</code>、<code>-</code>:
非，指定的查询词不能出现</li>
<li><code>+</code>:
存在操作符，要求符号<code>+</code>后的项必须在文档相应的域中存在</li>
<li><code>~</code>:
基于编辑距离的模糊检索，比如<code>roam~</code>，会匹配如<code>roams</code>、<code>foam</code>、<code>foams</code>；也可以指定相似度，比如<code>roam~0.7</code>，会检索相似度在0.7以上的记录；或者指定编辑距离，比如<code>roam~1</code>，指定编辑距离为1，可以匹配<code>roams</code>、<code>foam</code>，但不会匹配<code>foams</code></li>
<li><code>~n</code>:
邻近查询，查找相隔一定距离的单词，比如<code>&quot;jakarta apache&quot;~10</code>，相隔10个单词</li>
<li><code>TO</code>:
范围查询，<code>[]</code>包含边界，<code>{}</code>不包含边界，比如<code>[201810 TO 201811]</code>、<code>{201810 TO 201811}</code>，可以使用<code>*</code>，比如<code>[* TO 100]</code>，表示小于等于100</li>
<li><code>^</code>:
加权因子，比如<code>jakarta^4 apache</code>查找结果中jakarta更相关</li>
<li><code>^=</code>:
指定查询语句的score得分为常量，比如<code>(description:blue OR color:blue)^=1.0 text:shoes</code></li>
<li><code>()</code>:
子查询，比如<code>title:(jakarta OR apache) AND website</code></li>
<li><code>/*xxx*/</code>:
注释，比如<code>title:jakarta /*注释*/ OR apache</code></li>
</ul>
<p>如果要使用<code>+</code>、<code>-</code>、<code>&amp;&amp;</code>、<code>||</code>、<code>!</code>、<code>( )</code>、<code>{ }</code>、<code>[ ]</code>、<code>^</code>、<code>&quot;</code>、<code>~</code>、<code>*</code>、<code>?</code>、<code>:</code>、<code>/</code>这些特殊字符，需要加反斜杠进行转义，比如
<code>\(1\+1\):2</code></p>
<p>可以在q中更改查询参数，比如<code>q={!q.op=AND df=title}jakarta apache</code>，更改参数的语句要以<code>{!</code>开头，以<code>}</code>结束，中间是任意用空格分隔的查询参数（key=value形式）</p>
<p>Solr的日期的格式是<code>yyyy-MM-ddTHH:mm:ssZ</code>，日期和小时之间用T分隔，最后以Z结束（Z代表时区是UTC）</p>
<p>日期的内建表达式（时间单位都可以带S,也可以不带,意义一样，比如HOUR或HOURS）：</p>
<ul>
<li><code>NOW</code>: 当前时间</li>
<li><code>YEAR</code>: 年</li>
<li><code>MONTH</code>: 月</li>
<li><code>DAY</code>: 日</li>
<li><code>DATE</code>: 日，和DAY一样</li>
<li><code>HOUR</code>: 时</li>
<li><code>MINUTE</code>: 分</li>
<li><code>SECOND</code>: 秒</li>
<li><code>MILLI</code>: 毫秒</li>
<li><code>MILLISECOND</code>: 毫秒，和MILLI一样</li>
<li><code>TZ</code>:
时区，默认是UTC，可以设置TZ=Asia/Shanghai北京时间，但它不能修正Solr输出、输入时区</li>
<li><code>NOW+2MONTHS</code>: 之后的两个月时间内</li>
<li><code>NOW-1DAY</code>: 一天前</li>
<li><code>NOW/HOUR</code>: 从这个小时开始，从当前小时零分开始</li>
</ul>
<p>比如</p>
<ul>
<li><code>[2018-01-01T00:00:00 TO *]</code>: 2018年1月1号以后</li>
<li><code>2018-01</code>: 表示2018年整个1月份</li>
<li><code>2017-01T13</code>: 2017年整个1月每天13:00到14:00</li>
<li><code>[2018-01-01 TO 2018-01-23]</code>: 表示2018年1月1号到23号</li>
<li><code>[2018 TO 2018-01-23]</code>: 2018年1月1号到23号</li>
<li><code>[ * TO 2018-01-23]</code>: 2018年1月23号之前</li>
<li><code>NOW/DAY</code>: 当天零点零分</li>
<li><code>[NOW-1YEAR/DAY TO NOW/DAY+1DAY]</code>:
一年前的这一天开始，到今天过后</li>
</ul>
<h3 id="java客户端">JAVA客户端</h3>
<p>maven依赖</p>
<div class="sourceCode" id="cb493"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dependency</span>&gt;</span>
<span id="cb493-2"><a href="#cb493-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">groupId</span>&gt;org.apache.solr&lt;/<span class="kw">groupId</span>&gt;</span>
<span id="cb493-3"><a href="#cb493-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">artifactId</span>&gt;solr-solrj&lt;/<span class="kw">artifactId</span>&gt;</span>
<span id="cb493-4"><a href="#cb493-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">version</span>&gt;7.5.0&lt;/<span class="kw">version</span>&gt;</span>
<span id="cb493-5"><a href="#cb493-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dependency</span>&gt;</span></code></pre></div>
<p>java代码（一般配置DHI后只需直接查询，不需要增删改）</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb494-1"><a href="#cb494-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> solrUrl <span class="op">=</span> <span class="st">&quot;http://127.0.0.1:8983/solr/corename&quot;</span><span class="op">;</span></span>
<span id="cb494-2"><a href="#cb494-2" aria-hidden="true" tabindex="-1"></a>HttpSolrClient solrClient <span class="op">=</span> <span class="kw">new</span> HttpSolrClient<span class="op">.</span><span class="fu">Builder</span><span class="op">(</span>solrUrl<span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb494-3"><a href="#cb494-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ------------ 插入 ------------</span></span>
<span id="cb494-4"><a href="#cb494-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Collection</span><span class="op">&lt;</span>SolrInputDocument<span class="op">&gt;</span> docs <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;</span>SolrInputDocument<span class="op">&gt;();</span></span>
<span id="cb494-5"><a href="#cb494-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-6"><a href="#cb494-6" aria-hidden="true" tabindex="-1"></a>SolrInputDocument doc1 <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrInputDocument</span><span class="op">();</span></span>
<span id="cb494-7"><a href="#cb494-7" aria-hidden="true" tabindex="-1"></a>doc1<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb494-8"><a href="#cb494-8" aria-hidden="true" tabindex="-1"></a>doc1<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;小王&quot;</span><span class="op">);</span></span>
<span id="cb494-9"><a href="#cb494-9" aria-hidden="true" tabindex="-1"></a>doc1<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;code&quot;</span><span class="op">,</span> <span class="st">&quot;hello&quot;</span><span class="op">);</span></span>
<span id="cb494-10"><a href="#cb494-10" aria-hidden="true" tabindex="-1"></a>doc1<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;createTime&quot;</span><span class="op">,</span> <span class="st">&quot;2018-10-01&quot;</span><span class="op">);</span></span>
<span id="cb494-11"><a href="#cb494-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-12"><a href="#cb494-12" aria-hidden="true" tabindex="-1"></a>docs<span class="op">.</span><span class="fu">add</span><span class="op">(</span>doc1<span class="op">);</span></span>
<span id="cb494-13"><a href="#cb494-13" aria-hidden="true" tabindex="-1"></a>UpdateResponse rsp1 <span class="op">=</span> solrclient<span class="op">.</span><span class="fu">add</span><span class="op">(</span>docs<span class="op">);</span></span>
<span id="cb494-14"><a href="#cb494-14" aria-hidden="true" tabindex="-1"></a>UpdateResponse rspcommit1 <span class="op">=</span> solrclient<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb494-15"><a href="#cb494-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-16"><a href="#cb494-16" aria-hidden="true" tabindex="-1"></a><span class="co">// ------------ 修改 ------------</span></span>
<span id="cb494-17"><a href="#cb494-17" aria-hidden="true" tabindex="-1"></a><span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;();</span></span>
<span id="cb494-18"><a href="#cb494-18" aria-hidden="true" tabindex="-1"></a><span class="co">// 多值更新方法</span></span>
<span id="cb494-19"><a href="#cb494-19" aria-hidden="true" tabindex="-1"></a><span class="co">//List&lt;String&gt; mulitValues = new ArrayList&lt;String&gt;();</span></span>
<span id="cb494-20"><a href="#cb494-20" aria-hidden="true" tabindex="-1"></a><span class="co">//mulitValues.add(&quot;小花&quot;);</span></span>
<span id="cb494-21"><a href="#cb494-21" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;set&quot;</span><span class="op">,</span> <span class="st">&quot;小花&quot;</span><span class="op">);</span></span>
<span id="cb494-22"><a href="#cb494-22" aria-hidden="true" tabindex="-1"></a>SolrInputDocument doc2 <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrInputDocument</span><span class="op">();</span></span>
<span id="cb494-23"><a href="#cb494-23" aria-hidden="true" tabindex="-1"></a>doc2<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">);</span></span>
<span id="cb494-24"><a href="#cb494-24" aria-hidden="true" tabindex="-1"></a>doc2<span class="op">.</span><span class="fu">addField</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> map<span class="op">);</span></span>
<span id="cb494-25"><a href="#cb494-25" aria-hidden="true" tabindex="-1"></a>UpdateResponse rsp2 <span class="op">=</span> solrclient<span class="op">.</span><span class="fu">add</span><span class="op">(</span>doc2<span class="op">);</span></span>
<span id="cb494-26"><a href="#cb494-26" aria-hidden="true" tabindex="-1"></a>UpdateResponse rspCommit2 <span class="op">=</span> solrclient<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb494-27"><a href="#cb494-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-28"><a href="#cb494-28" aria-hidden="true" tabindex="-1"></a><span class="co">// ------------ 查询 ------------</span></span>
<span id="cb494-29"><a href="#cb494-29" aria-hidden="true" tabindex="-1"></a><span class="co">// 创建搜索对象</span></span>
<span id="cb494-30"><a href="#cb494-30" aria-hidden="true" tabindex="-1"></a>SolrQuery query <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrQuery</span><span class="op">();</span></span>
<span id="cb494-31"><a href="#cb494-31" aria-hidden="true" tabindex="-1"></a><span class="co">// 设置搜索条件</span></span>
<span id="cb494-32"><a href="#cb494-32" aria-hidden="true" tabindex="-1"></a>query<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;q&quot;</span><span class="op">,</span><span class="st">&quot;name:小明&quot;</span><span class="op">);</span></span>
<span id="cb494-33"><a href="#cb494-33" aria-hidden="true" tabindex="-1"></a><span class="co">// 分页参数</span></span>
<span id="cb494-34"><a href="#cb494-34" aria-hidden="true" tabindex="-1"></a>query<span class="op">.</span><span class="fu">setStart</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb494-35"><a href="#cb494-35" aria-hidden="true" tabindex="-1"></a><span class="co">// 设置每页显示多少条</span></span>
<span id="cb494-36"><a href="#cb494-36" aria-hidden="true" tabindex="-1"></a>query<span class="op">.</span><span class="fu">setRows</span><span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb494-37"><a href="#cb494-37" aria-hidden="true" tabindex="-1"></a><span class="co">//发起搜索请求</span></span>
<span id="cb494-38"><a href="#cb494-38" aria-hidden="true" tabindex="-1"></a>QueryResponse response <span class="op">=</span> solrClient<span class="op">.</span><span class="fu">query</span><span class="op">(</span>query<span class="op">);</span></span>
<span id="cb494-39"><a href="#cb494-39" aria-hidden="true" tabindex="-1"></a><span class="co">// 查询结果</span></span>
<span id="cb494-40"><a href="#cb494-40" aria-hidden="true" tabindex="-1"></a>SolrDocumentList docs <span class="op">=</span> response<span class="op">.</span><span class="fu">getResults</span><span class="op">();</span></span>
<span id="cb494-41"><a href="#cb494-41" aria-hidden="true" tabindex="-1"></a><span class="co">// 查询结果总数</span></span>
<span id="cb494-42"><a href="#cb494-42" aria-hidden="true" tabindex="-1"></a><span class="dt">long</span> count<span class="op">=</span> docs<span class="op">.</span><span class="fu">getNumFound</span><span class="op">();</span></span>
<span id="cb494-43"><a href="#cb494-43" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;总条数为&quot;</span><span class="op">+</span>count<span class="op">+</span><span class="st">&quot;条&quot;</span><span class="op">);</span></span>
<span id="cb494-44"><a href="#cb494-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>SolrDocument doc <span class="op">:</span> docs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb494-45"><a href="#cb494-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;id:&quot;</span><span class="op">+</span> doc<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="op">+</span> <span class="st">&quot;,name:&quot;</span><span class="op">+</span> doc<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">));</span></span>
<span id="cb494-46"><a href="#cb494-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb494-47"><a href="#cb494-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-48"><a href="#cb494-48" aria-hidden="true" tabindex="-1"></a><span class="co">// ------------ 删除 ------------</span></span>
<span id="cb494-49"><a href="#cb494-49" aria-hidden="true" tabindex="-1"></a>UpdateResponse rsp3 <span class="op">=</span> solrclient<span class="op">.</span><span class="fu">deleteById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb494-50"><a href="#cb494-50" aria-hidden="true" tabindex="-1"></a>solrclient<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb494-51"><a href="#cb494-51" aria-hidden="true" tabindex="-1"></a><span class="co">// 或者</span></span>
<span id="cb494-52"><a href="#cb494-52" aria-hidden="true" tabindex="-1"></a>UpdateResponse rsp4 <span class="op">=</span> client<span class="op">.</span><span class="fu">deleteByQuery</span><span class="op">(</span><span class="st">&quot;name:小明&quot;</span><span class="op">);</span></span>
<span id="cb494-53"><a href="#cb494-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb494-54"><a href="#cb494-54" aria-hidden="true" tabindex="-1"></a>solrClient<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<p>通过JavaBean操作</p>
<div class="sourceCode" id="cb495"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Student<span class="op">{</span></span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">)</span></span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> id<span class="op">;</span></span>
<span id="cb495-4"><a href="#cb495-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-5"><a href="#cb495-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">)</span></span>
<span id="cb495-6"><a href="#cb495-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> name<span class="op">;</span></span>
<span id="cb495-7"><a href="#cb495-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-8"><a href="#cb495-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span><span class="st">&quot;code&quot;</span><span class="op">)</span></span>
<span id="cb495-9"><a href="#cb495-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> code<span class="op">;</span></span>
<span id="cb495-10"><a href="#cb495-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb495-11"><a href="#cb495-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span><span class="st">&quot;createTime&quot;</span><span class="op">)</span></span>
<span id="cb495-12"><a href="#cb495-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> createTime<span class="op">;</span></span>
<span id="cb495-13"><a href="#cb495-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb495-14"><a href="#cb495-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">//省略构造器、get、set</span></span>
<span id="cb495-15"><a href="#cb495-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb495-16"><a href="#cb495-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb495-17"><a href="#cb495-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-18"><a href="#cb495-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Main<span class="op">{</span></span>
<span id="cb495-19"><a href="#cb495-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">){</span></span>
<span id="cb495-20"><a href="#cb495-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> solrUrl <span class="op">=</span> <span class="st">&quot;http://127.0.0.1:8983/solr/corename&quot;</span><span class="op">;</span></span>
<span id="cb495-21"><a href="#cb495-21" aria-hidden="true" tabindex="-1"></a>        HttpSolrClient solrClient <span class="op">=</span> <span class="kw">new</span> HttpSolrClient<span class="op">.</span><span class="fu">Builder</span><span class="op">(</span>solrUrl<span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb495-22"><a href="#cb495-22" aria-hidden="true" tabindex="-1"></a>        Student student <span class="op">=</span> <span class="kw">new</span> <span class="fu">Student</span><span class="op">(</span><span class="dv">5</span><span class="op">,</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="st">&quot;hello&quot;</span><span class="op">,</span><span class="st">&quot;2018-10-01&quot;</span><span class="op">);</span></span>
<span id="cb495-23"><a href="#cb495-23" aria-hidden="true" tabindex="-1"></a>        solrClient<span class="op">.</span><span class="fu">addBean</span><span class="op">(</span>student<span class="op">);</span></span>
<span id="cb495-24"><a href="#cb495-24" aria-hidden="true" tabindex="-1"></a>        solrClient<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb495-25"><a href="#cb495-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-26"><a href="#cb495-26" aria-hidden="true" tabindex="-1"></a>        SolrQuery query <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrQuery</span><span class="op">();</span></span>
<span id="cb495-27"><a href="#cb495-27" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;q&quot;</span><span class="op">,</span><span class="st">&quot;*:*&quot;</span><span class="op">);</span></span>
<span id="cb495-28"><a href="#cb495-28" aria-hidden="true" tabindex="-1"></a>        QueryResponse response <span class="op">=</span> solrClient<span class="op">.</span><span class="fu">query</span><span class="op">(</span>query<span class="op">);</span></span>
<span id="cb495-29"><a href="#cb495-29" aria-hidden="true" tabindex="-1"></a>        SolrDocumentList docs <span class="op">=</span> response<span class="op">.</span><span class="fu">getResults</span><span class="op">();</span></span>
<span id="cb495-30"><a href="#cb495-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>SolrDocument doc <span class="op">:</span> docs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb495-31"><a href="#cb495-31" aria-hidden="true" tabindex="-1"></a>            Student s <span class="op">=</span> solrClient<span class="op">.</span><span class="fu">getBinder</span><span class="op">().</span><span class="fu">getBean</span><span class="op">(</span>Student<span class="op">.</span><span class="fu">class</span><span class="op">,</span> doc<span class="op">);</span></span>
<span id="cb495-32"><a href="#cb495-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>s<span class="op">);</span></span>
<span id="cb495-33"><a href="#cb495-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb495-34"><a href="#cb495-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb495-35"><a href="#cb495-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb495-36"><a href="#cb495-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="集群搭建-3">集群搭建</h3>
<p>安装ZooKeeper集群（略）</p>
<p>从安装包中解压脚本并执行，<code>--strip-components=2</code>是指去掉前两层目录，是tar命令的参数，该脚本的作用是把Solr安装成系统服务，以便运行，默认安装目录是<code>/opt</code>目录+压缩包名，建议先把压缩包重命名为<code>solr.tgz</code>，方便以后升级（以后升级只需替换<code>/opt/solr</code>的文件即可）</p>
<pre class="shell"><code>tar xzf solr-7.5.0.tgz solr-7.5.0/bin/install_solr_service.sh --strip-components=2
sudo ./install_solr_service.sh solr-7.5.0.tgz

# 也可以指定安装参数
sudo ./install_solr_service.sh solr-7.5.0.tgz -d /var/solr -i /opt/ -p 8983 -s solr -u solr -n

sudo service solr start
sudo service solr restart
sudo service solr status
sudo service solr stop</code></pre>
<p>参数说明</p>
<ul>
<li><code>-d</code>:
solr的一些参数和可写的文件存放的位置，默认为<code>/var/solr</code></li>
<li><code>-i</code>: solr解压位置，默认为<code>/opt/</code></li>
<li><code>-p</code>: 绑定的端口号</li>
<li><code>-s</code>: service的名称</li>
<li><code>-u</code>:
创建的用户名，默认为<code>solr</code>，solr会自动创建linux用户来运行solr</li>
<li><code>-n</code>: 执行完脚本后不启动solr</li>
<li><code>-f</code>: 更新solr，重建符号链接和启动脚本</li>
</ul>
<p>安装完成后，到<code>/var/solr/data</code>目录，修改<code>solr.xml</code>文件，修改host参数，在后面填入本机ip</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">solr</span>&gt;</span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">solrcloud</span>&gt;</span>
<span id="cb497-3"><a href="#cb497-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">str</span><span class="ot"> name=</span><span class="st">&quot;host&quot;</span>&gt;${host:192.168.1.2}&lt;/<span class="kw">str</span>&gt;</span>
<span id="cb497-4"><a href="#cb497-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;hostPort&quot;</span>&gt;${jetty.port:8983}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-5"><a href="#cb497-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">str</span><span class="ot"> name=</span><span class="st">&quot;hostContext&quot;</span>&gt;${hostContext:solr}&lt;/<span class="kw">str</span>&gt;</span>
<span id="cb497-6"><a href="#cb497-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb497-7"><a href="#cb497-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">bool</span><span class="ot"> name=</span><span class="st">&quot;genericCoreNodeNames&quot;</span>&gt;${genericCoreNodeNames:true}&lt;/<span class="kw">bool</span>&gt;</span>
<span id="cb497-8"><a href="#cb497-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb497-9"><a href="#cb497-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;zkClientTimeout&quot;</span>&gt;${zkClientTimeout:30000}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-10"><a href="#cb497-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;distribUpdateSoTimeout&quot;</span>&gt;${distribUpdateSoTimeout:600000}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-11"><a href="#cb497-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;distribUpdateConnTimeout&quot;</span>&gt;${distribUpdateConnTimeout:60000}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-12"><a href="#cb497-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">str</span><span class="ot"> name=</span><span class="st">&quot;zkCredentialsProvider&quot;</span>&gt;${zkCredentialsProvider:org.apache.solr.common.cloud.DefaultZkCredentialsProvider}&lt;/<span class="kw">str</span>&gt;</span>
<span id="cb497-13"><a href="#cb497-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">str</span><span class="ot"> name=</span><span class="st">&quot;zkACLProvider&quot;</span>&gt;${zkACLProvider:org.apache.solr.common.cloud.DefaultZkACLProvider}&lt;/<span class="kw">str</span>&gt;</span>
<span id="cb497-14"><a href="#cb497-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">solrcloud</span>&gt;</span>
<span id="cb497-15"><a href="#cb497-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb497-16"><a href="#cb497-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">shardHandlerFactory</span><span class="ot"> name=</span><span class="st">&quot;shardHandlerFactory&quot;</span></span>
<span id="cb497-17"><a href="#cb497-17" aria-hidden="true" tabindex="-1"></a><span class="ot">    class=</span><span class="st">&quot;HttpShardHandlerFactory&quot;</span>&gt;</span>
<span id="cb497-18"><a href="#cb497-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;socketTimeout&quot;</span>&gt;${socketTimeout:600000}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-19"><a href="#cb497-19" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">int</span><span class="ot"> name=</span><span class="st">&quot;connTimeout&quot;</span>&gt;${connTimeout:60000}&lt;/<span class="kw">int</span>&gt;</span>
<span id="cb497-20"><a href="#cb497-20" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">shardHandlerFactory</span>&gt;</span>
<span id="cb497-21"><a href="#cb497-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">solr</span>&gt;</span></code></pre></div>
<p>再到<code>/etc/default/</code>下修改<code>solr.in.sh</code>文件，配置ZK_HOST参数</p>
<div class="sourceCode" id="cb498"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb498-1"><a href="#cb498-1" aria-hidden="true" tabindex="-1"></a><span class="dt">ZK_HOST</span><span class="ot">=</span><span class="st">&quot;192.168.1.2:2181,192.168.1.3:2181,192.168.1.4:2181&quot;</span></span></code></pre></div>
<p>然后上传配置到ZooKeeper中</p>
<pre class="shell"><code>./solr zk upconfig -d [要上传的配置文件目录] -n [zookeeper上保存配置文件的节点名称] -z [zookeeper的集群地址]

# 使用/opt/solr/server/scripts/cloud-scripts/zkcli.sh也可以，三个参数也是对应的
 ./zkcli.sh -zkhost 192.168.1.2:2181,192.168.1.3:2181,192.168.1.4:2181 -cmd upconfig -confdir /opt/solr/server/solr/corename/conf -confname myconf</code></pre>
<p>创建集合</p>
<pre class="shell"><code>./solr create-collection -c [新建集合的名字] -n [zookeeper上配置文件的节点名称，上一步设置的那个n] -shards 2 [分两块] -replicationFactor 2 [replic数量]</code></pre>
<p>如果没有把Solr安装为系统服务，而是直接解压，那么<code>solr.xml</code>就应该在<code>/opt/solr/server/solr</code>目录配置，<code>solr.in.sh</code>应该在<code>/opt/solr/bin</code>下配置，无论是否安装为系统服务，它们的配置是一样的，只是路径不同</p>
<p>集群版Solr的JAVA客户端连接</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> ZK_HOST <span class="op">=</span> <span class="st">&quot;192.168.1.2:2181,192.168.1.3:2181,192.168.1.4:2181&quot;</span><span class="op">;</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a>CloudSolrClient solr<span class="op">=</span><span class="kw">new</span> CloudSolrClient<span class="op">.</span><span class="fu">Builder</span><span class="op">().</span><span class="fu">withZkHost</span><span class="op">(</span>ZK_HOST<span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb501-3"><a href="#cb501-3" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setDefaultCollection</span><span class="op">(</span><span class="st">&quot;mycollection&quot;</span><span class="op">);</span></span>
<span id="cb501-4"><a href="#cb501-4" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setParser</span><span class="op">(</span><span class="kw">new</span> <span class="fu">XMLResponseParser</span><span class="op">());</span></span>
<span id="cb501-5"><a href="#cb501-5" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setRequestWriter</span><span class="op">(</span><span class="kw">new</span> <span class="fu">BinaryRequestWriter</span><span class="op">());</span></span>
<span id="cb501-6"><a href="#cb501-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb501-7"><a href="#cb501-7" aria-hidden="true" tabindex="-1"></a><span class="co">//id存在就是改，不存在就是增</span></span>
<span id="cb501-8"><a href="#cb501-8" aria-hidden="true" tabindex="-1"></a>SolrInputDocument document <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrInputDocument</span><span class="op">();</span></span>
<span id="cb501-9"><a href="#cb501-9" aria-hidden="true" tabindex="-1"></a>document<span class="op">.</span><span class="fu">setField</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="dv">1L</span><span class="op">);</span></span>
<span id="cb501-10"><a href="#cb501-10" aria-hidden="true" tabindex="-1"></a>document<span class="op">.</span><span class="fu">setField</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb501-11"><a href="#cb501-11" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">add</span><span class="op">(</span>document<span class="op">);</span></span>
<span id="cb501-12"><a href="#cb501-12" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb501-13"><a href="#cb501-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb501-14"><a href="#cb501-14" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<p>或者</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb502-1"><a href="#cb502-1" aria-hidden="true" tabindex="-1"></a>ConcurrentUpdateSolrClient solr <span class="op">=</span> <span class="kw">new</span> ConcurrentUpdateSolrClient<span class="op">.</span><span class="fu">Builder</span><span class="op">(</span>url<span class="op">).</span><span class="fu">withQueueSize</span><span class="op">(</span><span class="dv">20</span><span class="op">).</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb502-2"><a href="#cb502-2" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setParser</span><span class="op">(</span><span class="kw">new</span> <span class="fu">XMLResponseParser</span><span class="op">());</span></span>
<span id="cb502-3"><a href="#cb502-3" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setConnectionTimeout</span><span class="op">(</span><span class="dv">10000</span><span class="op">);</span></span>
<span id="cb502-4"><a href="#cb502-4" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">setRequestWriter</span><span class="op">(</span><span class="kw">new</span> <span class="fu">BinaryRequestWriter</span><span class="op">());</span></span>
<span id="cb502-5"><a href="#cb502-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-6"><a href="#cb502-6" aria-hidden="true" tabindex="-1"></a>SolrInputDocument document <span class="op">=</span> <span class="kw">new</span> <span class="fu">SolrInputDocument</span><span class="op">();</span></span>
<span id="cb502-7"><a href="#cb502-7" aria-hidden="true" tabindex="-1"></a>document<span class="op">.</span><span class="fu">setField</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="dv">1L</span><span class="op">);</span></span>
<span id="cb502-8"><a href="#cb502-8" aria-hidden="true" tabindex="-1"></a>document<span class="op">.</span><span class="fu">setField</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">);</span></span>
<span id="cb502-9"><a href="#cb502-9" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb502-10"><a href="#cb502-10" aria-hidden="true" tabindex="-1"></a><span class="co">UpdateResponse response = solr.add(d);</span></span>
<span id="cb502-11"><a href="#cb502-11" aria-hidden="true" tabindex="-1"></a><span class="co">commit();</span></span>
<span id="cb502-12"><a href="#cb502-12" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb502-13"><a href="#cb502-13" aria-hidden="true" tabindex="-1"></a><span class="co">//或者</span></span>
<span id="cb502-14"><a href="#cb502-14" aria-hidden="true" tabindex="-1"></a>UpdateRequest request <span class="op">=</span> <span class="kw">new</span> <span class="fu">UpdateRequest</span><span class="op">();</span></span>
<span id="cb502-15"><a href="#cb502-15" aria-hidden="true" tabindex="-1"></a>request<span class="op">.</span><span class="fu">setAction</span><span class="op">(</span>ACTION<span class="op">.</span><span class="fu">COMMIT</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb502-16"><a href="#cb502-16" aria-hidden="true" tabindex="-1"></a>request<span class="op">.</span><span class="fu">add</span><span class="op">(</span>document<span class="op">);</span></span>
<span id="cb502-17"><a href="#cb502-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-18"><a href="#cb502-18" aria-hidden="true" tabindex="-1"></a>UpdateResponse response1 <span class="op">=</span> request<span class="op">.</span><span class="fu">process</span><span class="op">(</span>solr<span class="op">);</span></span>
<span id="cb502-19"><a href="#cb502-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-20"><a href="#cb502-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-21"><a href="#cb502-21" aria-hidden="true" tabindex="-1"></a>UpdateResponse response2 <span class="op">=</span> solr<span class="op">.</span><span class="fu">deleteById</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb502-22"><a href="#cb502-22" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">commit</span><span class="op">();</span></span>
<span id="cb502-23"><a href="#cb502-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb502-24"><a href="#cb502-24" aria-hidden="true" tabindex="-1"></a>solr<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span></code></pre></div>
<h2 id="rxjava">Rxjava</h2>
<p><a href="http://reactivex.io/">reactivex官网</a></p>
<p>rxjava是一个提供响应式编程的框架，它是基于观察者模式的</p>
<h3 id="无背压">无背压</h3>
<p>无背压问题的可以使用<code>Observable</code>作为观察者</p>
<ul>
<li><p>Observable: 被观察者</p></li>
<li><p>ObservableOnSubscribe: 被观察者在被观察时执行的动作</p></li>
<li><p>ObservableEmitter:
发射器，被观察者向观察者报告状态（发射数据）的途径</p></li>
<li><p>Observer: 观察者</p></li>
<li><p>Disposable:
描述了观察者正在接收数据的状态，可以通过<code>disposable.dispose()</code>来停止接收数据</p></li>
</ul>
<div class="sourceCode" id="cb503"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Observable</span><span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="kw">new</span> ObservableOnSubscribe<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">subscribe</span><span class="op">(</span>ObservableEmitter<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> emitter<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb503-3"><a href="#cb503-3" aria-hidden="true" tabindex="-1"></a>        emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">);</span></span>
<span id="cb503-4"><a href="#cb503-4" aria-hidden="true" tabindex="-1"></a>        emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;2&quot;</span><span class="op">);</span></span>
<span id="cb503-5"><a href="#cb503-5" aria-hidden="true" tabindex="-1"></a>        emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;3&quot;</span><span class="op">);</span></span>
<span id="cb503-6"><a href="#cb503-6" aria-hidden="true" tabindex="-1"></a>        emitter<span class="op">.</span><span class="fu">onComplete</span><span class="op">();</span></span>
<span id="cb503-7"><a href="#cb503-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb503-8"><a href="#cb503-8" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb503-9"><a href="#cb503-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span><span class="op">(</span><span class="kw">new</span> Function<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb503-10"><a href="#cb503-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">apply</span><span class="op">(</span><span class="bu">String</span> s<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb503-11"><a href="#cb503-11" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;mapping &quot;</span> <span class="op">+</span> s<span class="op">);</span></span>
<span id="cb503-12"><a href="#cb503-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Integer</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>s<span class="op">);</span></span>
<span id="cb503-13"><a href="#cb503-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb503-14"><a href="#cb503-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb503-15"><a href="#cb503-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subscribe</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Observer</span><span class="op">&lt;</span><span class="bu">Integer</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb503-16"><a href="#cb503-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onSubscribe</span><span class="op">(</span>Disposable d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb503-17"><a href="#cb503-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onSubscribe&quot;</span><span class="op">);</span></span>
<span id="cb503-18"><a href="#cb503-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb503-19"><a href="#cb503-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-20"><a href="#cb503-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onNext</span><span class="op">(</span><span class="bu">Integer</span> integer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb503-21"><a href="#cb503-21" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onNext i=&quot;</span> <span class="op">+</span> integer<span class="op">);</span></span>
<span id="cb503-22"><a href="#cb503-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb503-23"><a href="#cb503-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-24"><a href="#cb503-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onError</span><span class="op">(</span><span class="bu">Throwable</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb503-25"><a href="#cb503-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onError e=&quot;</span> <span class="op">+</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb503-26"><a href="#cb503-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb503-27"><a href="#cb503-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-28"><a href="#cb503-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onComplete</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb503-29"><a href="#cb503-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onComplete&quot;</span><span class="op">);</span></span>
<span id="cb503-30"><a href="#cb503-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb503-31"><a href="#cb503-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span></code></pre></div>
<h3 id="背压">背压</h3>
<p>当被观察者产出远高于观察者的处理能力时，会产生背压问题，此时需要使用支持背压策略的被观察者(<code>Flowable</code>)，同时观察者也需指定最大消费能力，当超出消费能力后，数据会根据背压策略进行处理</p>
<ul>
<li><p>Flowable: 被观察者</p></li>
<li><p>FlowableOnSubscribe: 被观察者在被观察时执行的动作</p></li>
<li><p>FlowableEmitter:
发射器，被观察者向观察者报告状态（发射数据）的途径</p></li>
<li><p>BackpressureStrategy:
背压策略，可选值为：<code>MISSING</code>、<code>ERROR</code>、<code>BUFFER</code>、<code>DROP</code>、<code>LATEST</code></p></li>
<li><p>Subscriber: 观察者</p></li>
<li><p>Subscription:
描述了观察者正在接收数据的状态，可以通过<code>subscription.cancel()</code>来停止接收数据</p></li>
</ul>
<div class="sourceCode" id="cb504"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb504-1"><a href="#cb504-1" aria-hidden="true" tabindex="-1"></a>Flowable<span class="op">.</span><span class="fu">create</span><span class="op">(</span><span class="kw">new</span> FlowableOnSubscribe<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb504-2"><a href="#cb504-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">subscribe</span><span class="op">(</span>FlowableEmitter<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> flowableEmitter<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb504-3"><a href="#cb504-3" aria-hidden="true" tabindex="-1"></a>        flowableEmitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">);</span></span>
<span id="cb504-4"><a href="#cb504-4" aria-hidden="true" tabindex="-1"></a>        flowableEmitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">);</span></span>
<span id="cb504-5"><a href="#cb504-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb504-6"><a href="#cb504-6" aria-hidden="true" tabindex="-1"></a><span class="op">},</span> BackpressureStrategy<span class="op">.</span><span class="fu">BUFFER</span><span class="op">)</span></span>
<span id="cb504-7"><a href="#cb504-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subscribe</span><span class="op">(</span><span class="kw">new</span> Subscriber<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;()</span> <span class="op">{</span></span>
<span id="cb504-8"><a href="#cb504-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onSubscribe</span><span class="op">(</span>Subscription subscription<span class="op">)</span> <span class="op">{</span></span>
<span id="cb504-9"><a href="#cb504-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onSubscribe&quot;</span><span class="op">);</span></span>
<span id="cb504-10"><a href="#cb504-10" aria-hidden="true" tabindex="-1"></a>            subscription<span class="op">.</span><span class="fu">request</span><span class="op">(</span><span class="bu">Long</span><span class="op">.</span><span class="fu">MAX_VALUE</span><span class="op">);</span><span class="co">//消费能力，超出指定数量后数据会被丢弃</span></span>
<span id="cb504-11"><a href="#cb504-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb504-12"><a href="#cb504-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb504-13"><a href="#cb504-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onNext</span><span class="op">(</span><span class="bu">String</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb504-14"><a href="#cb504-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onNext-- &quot;</span> <span class="op">+</span> s<span class="op">);</span></span>
<span id="cb504-15"><a href="#cb504-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb504-16"><a href="#cb504-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb504-17"><a href="#cb504-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onError</span><span class="op">(</span><span class="bu">Throwable</span> throwable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb504-18"><a href="#cb504-18" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onError&quot;</span> <span class="op">+</span> throwable<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb504-19"><a href="#cb504-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb504-20"><a href="#cb504-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb504-21"><a href="#cb504-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb504-22"><a href="#cb504-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onComplete</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb504-23"><a href="#cb504-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;onComplete&quot;</span><span class="op">);</span></span>
<span id="cb504-24"><a href="#cb504-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb504-25"><a href="#cb504-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span></code></pre></div>
<p>调用<code>Emitter</code>的方法其实会调用<code>Subscriber</code>对应的方法：</p>
<ul>
<li><p>onNext可以调用多次</p></li>
<li><p>onComplete可以调用多次，但只有第一次生效，而且之后的任何操作都不再生效</p></li>
<li><p>onError会在出现异常时自动调用，不需要手动调用，而且之后的任何操作都不再生效</p></li>
</ul>
<div class="sourceCode" id="cb505"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">subscribe</span><span class="op">(</span>FlowableEmitter<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> emitter<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;hello&quot;</span><span class="op">);</span></span>
<span id="cb505-3"><a href="#cb505-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb505-4"><a href="#cb505-4" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">);</span></span>
<span id="cb505-5"><a href="#cb505-5" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">.</span><span class="fu">onComplete</span><span class="op">();</span></span>
<span id="cb505-6"><a href="#cb505-6" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">.</span><span class="fu">onComplete</span><span class="op">();</span></span>
<span id="cb505-7"><a href="#cb505-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>还可以指定工作的线程</p>
<ul>
<li>subscribeOn指定被观察者在哪一条线程工作</li>
<li>observeOn指定观察者在哪一条线程工作</li>
</ul>
<div class="sourceCode" id="cb506"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb506-1"><a href="#cb506-1" aria-hidden="true" tabindex="-1"></a><span class="bu">Observable</span><span class="op">.</span><span class="fu">create</span><span class="op">(</span>emitter <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb506-2"><a href="#cb506-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//在io线程工作</span></span>
<span id="cb506-3"><a href="#cb506-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">5</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb506-4"><a href="#cb506-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;--发射中-- i = &quot;</span> <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb506-5"><a href="#cb506-5" aria-hidden="true" tabindex="-1"></a>        emitter<span class="op">.</span><span class="fu">onNext</span><span class="op">(</span>i<span class="op">);</span></span>
<span id="cb506-6"><a href="#cb506-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb506-7"><a href="#cb506-7" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb506-8"><a href="#cb506-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subscribeOn</span><span class="op">(</span>Schedulers<span class="op">.</span><span class="fu">io</span><span class="op">())</span></span>
<span id="cb506-9"><a href="#cb506-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">observeOn</span><span class="op">(</span>Schedulers<span class="op">.</span><span class="fu">newThread</span><span class="op">())</span></span>
<span id="cb506-10"><a href="#cb506-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subscribe</span><span class="op">(</span><span class="co">//在newThread工作</span></span>
<span id="cb506-11"><a href="#cb506-11" aria-hidden="true" tabindex="-1"></a>    i <span class="op">-&gt;</span> <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="bu">Thread</span><span class="op">.</span><span class="fu">currentThread</span><span class="op">().</span><span class="fu">getName</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;-- &quot;</span> <span class="op">+</span> i<span class="op">));</span></span></code></pre></div>
</body>
</html>
