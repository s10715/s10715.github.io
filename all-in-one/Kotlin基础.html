<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Kotlin基础</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">html {scroll-behavior: smooth;}body {font-size: 1rem;line-height: 1.6;tab-size: 4;color: rgb(51, 51, 51);font-family: Microsoft YaHei,"Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;-webkit-font-smoothing: antialiased;position: relative;top: 0;left: 300px;width: calc(90% - 300px);padding: 2em 5%;}h1,h2,h3,h4,h5,h6 {position: relative;margin-top: 1rem;margin-bottom: 1rem;padding-bottom: 0;font-weight: bold;line-height: 1.4;cursor: text;}h1 {font-size: 2.25em;line-height: 1.2;border-bottom: 1px solid #eee;}h2 {font-size: 1.75em;line-height: 1.225;border-bottom: 1px solid #eee;}h3 {font-size: 1.5em;line-height: 1.43;}h4 {font-size: 1.25em;}h5 {font-size: 1em;}h6 {font-size: 1em;color: #777;}p,blockquote{ margin: 0.8em 0 !important; }ul,ol,dl,table{margin: 0.8em 0;}li>ol,li>ul {margin: 0 0;}a {color: #4183C4;text-decoration: none;}hr {height: 2px;padding: 0;margin: 16px 0;background-color: #e7e7e7;border: 0 none;overflow: hidden;box-sizing: content-box;}li p.first {display: inline-block;}ul,ol {padding-left: 20px;}ul:first-child,ol:first-child {margin-top: 0;}ul:last-child,ol:last-child {margin-bottom: 0;}blockquote {border-left: 4px solid #dfe2e5 !important;padding: 0 15px;color: #777777 !important;background-color: #ffffff !important;}blockquote blockquote {padding-right: 0;}table {padding: 0;word-break: initial;border-collapse: collapse;}table tr {border: 1px solid #dfe2e5;margin: 0;padding: 0;}table tr:nth-child(2n),thead {background-color: #f8f8f8;}table th {font-weight: normal;text-align: unset;border-bottom: 0;border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table td {border: 1px solid #dfe2e5;margin: 0;padding: 6px 13px;}table th:first-child,table td:first-child {margin-top: 0;}table th:last-child,table td:last-child {margin-bottom: 0;}tt {border: 1px solid #e7eaed;background-color: #f8f8f8;border-radius: 3px;padding: 2px 4px 0px 4px;font-size: 0.9em;}code {border: 1px solid #e7eaed;background-color: #f3f4f4;border-radius: 3px;padding: 0 2px 0 2px;font-size: 0.9em;}img {width: 50%;height: 50%;display: block;vertical-align: middle;image-orientation: from-image;margin: auto;}figcaption {text-align: center;}pre>code{counter-reset: linenumber;display: block;white-space: pre;overflow: auto !important;padding: 0.2em;border-radius: 7px;}pre>code>span {counter-increment: linenumber;display: inline-block;line-height: 1.25em !important;}pre>code>span::before {content: counter(linenumber);display: inline-block;font-size: 0.9em;color: #999;min-width: 1.8em;margin-right: 0.5em;padding-right: 0.25em;text-align: right;border-right: 1px solid #999;line-height: 1.9em;user-select: none;pointer-events: none;}#TOC {font-size: 0.8rem;position: fixed;top: 0;left: 0;width: 300px;height: 100%;padding: 32px 16px 48px 16px !important;box-shadow: 0 0 4px rgba(150,150,150,0.33);box-sizing: border-box;overflow: auto;}#TOC::-webkit-scrollbar{width: 1px;border-right: 1px solid #f5f5f5;}#TOC a{color: #333333;text-decoration: none;}#TOC a:hover{color: #333333 !important;text-decoration: underline !important;}#TOC ul { list-style: none; }#TOC li { margin-bottom: 0.25rem; }@media (max-width: 700px) {#TOC { display: none; }body { left: 0px; width: 90%; }}</style>
  <script type="text/javascript">
  window.onload = function(){
    document.querySelectorAll('a[href^="#"]').forEach(function(item,index,arr){
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const target =  document.getElementById(decodeURI((item.href.substring(item.href.indexOf('#')+1))));
            if(target == null) { return; }
            target.scrollIntoView({ behavior: 'smooth' });
        });
    })
    const toc_a = document.querySelectorAll('#TOC a');
    function updateTOC(){
      const scrollPosition = window.scrollY;
      let highlightTarget;
      for(let i=toc_a.length-1; i>=0; i--){
        const target = document.getElementById(decodeURI((toc_a[i].href.substring(toc_a[i].href.indexOf('#')+1))));
        if(target == null) { continue; }
        const ItemPosition = target.offsetTop;
        if (scrollPosition > ItemPosition && typeof(highlightTarget) == "undefined") {
          highlightTarget = toc_a[i];
        } else if(typeof(highlightTarget) == "undefined" && i == 0) {
          highlightTarget = toc_a[0];
        }
      }
      toc_a.forEach( item => {
        item.style.fontWeight = "";
      });
      if(typeof(highlightTarget) == "undefined") { return; }
      highlightTarget.style.fontWeight = "bold";
    }
    let timer = null;
    window.addEventListener('scroll', () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(() => { updateTOC() }, 200);
    });
  };
  </script>
  <base target="_blank">
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#基本数据类型" id="toc-基本数据类型">基本数据类型</a>
<ul>
<li><a href="#数据类型" id="toc-数据类型">数据类型</a></li>
<li><a href="#常量与变量" id="toc-常量与变量">常量与变量</a></li>
<li><a href="#位运算" id="toc-位运算">位运算</a></li>
<li><a href="#转义字符" id="toc-转义字符">转义字符</a></li>
<li><a href="#字符串模板长字符串" id="toc-字符串模板长字符串">字符串模板、长字符串</a></li>
<li><a href="#比较与" id="toc-比较与">比较(<code>==</code>与<code>===</code>)</a></li>
<li><a href="#安全空类型" id="toc-安全空类型">安全空类型</a></li>
<li><a href="#类型转换类型判断" id="toc-类型转换类型判断">类型转换、类型判断</a></li>
<li><a href="#区间" id="toc-区间">区间</a></li>
<li><a href="#数组" id="toc-数组">数组</a></li>
<li><a href="#包" id="toc-包">包</a></li>
<li><a href="#别名" id="toc-别名">别名</a></li>
</ul></li>
<li><a href="#程序结构" id="toc-程序结构">程序结构</a>
<ul>
<li><a href="#条件表达式ifwhen" id="toc-条件表达式ifwhen">条件表达式(if、when)</a></li>
<li><a href="#循环语句forwhiledo-whilecontinuebreak" id="toc-循环语句forwhiledo-whilecontinuebreak">循环语句(for、while、do
while、continue、break)</a></li>
<li><a href="#异常捕获trycatchfinally" id="toc-异常捕获trycatchfinally">异常捕获(try、catch、finally)</a></li>
</ul></li>
<li><a href="#函数" id="toc-函数">函数</a>
<ul>
<li><a href="#函数的定义" id="toc-函数的定义">函数的定义</a></li>
<li><a href="#具名参数变长参数默认参数" id="toc-具名参数变长参数默认参数">具名参数、变长参数、默认参数</a></li>
<li><a href="#lambda表达式" id="toc-lambda表达式">Lambda表达式</a>
<ul>
<li><a href="#使用规则" id="toc-使用规则">使用规则</a></li>
<li><a href="#this" id="toc-this">this</a></li>
<li><a href="#方法引用" id="toc-方法引用">方法引用</a></li>
<li><a href="#inline" id="toc-inline">inline</a></li>
</ul></li>
<li><a href="#特殊函数" id="toc-特殊函数">特殊函数</a>
<ul>
<li><a href="#operator函数" id="toc-operator函数">operator函数</a></li>
<li><a href="#infix函数" id="toc-infix函数">infix函数</a></li>
<li><a href="#functionn接口" id="toc-functionn接口">FunctionN接口</a></li>
<li><a href="#componentn函数" id="toc-componentn函数">componentN函数</a></li>
<li><a href="#invoke约定" id="toc-invoke约定">invoke约定</a></li>
</ul></li>
<li><a href="#函数复合" id="toc-函数复合">函数复合</a></li>
<li><a href="#高阶函数" id="toc-高阶函数">高阶函数</a></li>
<li><a href="#柯里化currying及偏函数" id="toc-柯里化currying及偏函数">柯里化(currying)及偏函数</a></li>
<li><a href="#尾递归优化" id="toc-尾递归优化">尾递归优化</a></li>
</ul></li>
<li><a href="#类与对象" id="toc-类与对象">类与对象</a>
<ul>
<li><a href="#类的定义" id="toc-类的定义">类的定义</a></li>
<li><a href="#接口与抽象类" id="toc-接口与抽象类">接口与抽象类</a></li>
<li><a href="#成员变量" id="toc-成员变量">成员变量</a>
<ul>
<li><a href="#getset" id="toc-getset">get、set</a></li>
<li><a href="#属性代理delegate类代理" id="toc-属性代理delegate类代理">属性代理(delegate)、类代理</a></li>
</ul></li>
<li><a href="#继承" id="toc-继承">继承</a></li>
<li><a href="#方法重裁" id="toc-方法重裁">方法重裁</a></li>
<li><a href="#扩展" id="toc-扩展">扩展</a>
<ul>
<li><a href="#扩展函数" id="toc-扩展函数">扩展函数</a></li>
<li><a href="#扩展lambda" id="toc-扩展lambda">扩展Lambda</a></li>
<li><a href="#扩展属性" id="toc-扩展属性">扩展属性</a></li>
<li><a href="#扩展域" id="toc-扩展域">扩展域</a></li>
</ul></li>
<li><a href="#泛型" id="toc-泛型">泛型</a>
<ul>
<li><a href="#泛型的定义" id="toc-泛型的定义">泛型的定义</a></li>
<li><a href="#泛型约束" id="toc-泛型约束">泛型约束</a></li>
<li><a href="#泛型实化" id="toc-泛型实化">泛型实化</a></li>
<li><a href="#星投影" id="toc-星投影">星投影</a></li>
<li><a href="#协变与逆变" id="toc-协变与逆变">协变与逆变</a></li>
</ul></li>
<li><a href="#单例模式object" id="toc-单例模式object">单例模式(object)</a></li>
<li><a href="#伴生对象companion-object" id="toc-伴生对象companion-object">伴生对象(companion object)</a></li>
<li><a href="#内部类inner-class" id="toc-内部类inner-class">内部类(inner
class)</a>
<ul>
<li><a href="#静态与非静态内部类" id="toc-静态与非静态内部类">静态与非静态内部类</a></li>
<li><a href="#匿名内部类" id="toc-匿名内部类">匿名内部类</a></li>
<li><a href="#闭包" id="toc-闭包">闭包</a></li>
<li><a href="#函数式接口" id="toc-函数式接口">函数式接口</a></li>
</ul></li>
<li><a href="#数据类data-class" id="toc-数据类data-class">数据类(data
class)</a></li>
<li><a href="#枚举enum-class" id="toc-枚举enum-class">枚举(enum
class)</a></li>
<li><a href="#密封类sealed-class" id="toc-密封类sealed-class">密封类(sealed class)</a></li>
<li><a href="#注解" id="toc-注解">注解</a></li>
</ul></li>
<li><a href="#dsl" id="toc-dsl">DSL</a></li>
<li><a href="#协程coroutines" id="toc-协程coroutines">协程(Coroutines)</a>
<ul>
<li><a href="#简单使用" id="toc-简单使用">简单使用</a></li>
<li><a href="#实现异步" id="toc-实现异步">实现异步</a></li>
<li><a href="#封装" id="toc-封装">封装</a>
<ul>
<li><a href="#step1" id="toc-step1">step1</a></li>
<li><a href="#step2" id="toc-step2">step2</a></li>
<li><a href="#step3" id="toc-step3">step3</a></li>
<li><a href="#step4" id="toc-step4">step4</a></li>
<li><a href="#step5" id="toc-step5">step5</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<p><a href="https://kotlinlang.org/docs/home.html">Kotlin Docs</a></p>
<p><a href="https://github.com/JetBrains/kotlin">Kotlin in
Github</a></p>
<h2 id="基本数据类型">基本数据类型</h2>
<h3 id="数据类型">数据类型</h3>
<p>Kotlin的基本数据类型最后都会转化成JAVA中对应的基本数据类型</p>
<pre><code>类型     bit/可选值
Boolean true/false
Double  64
Float   32
Long    64
Int     32
Short   32
Byte    8

Char    16</code></pre>
<h3 id="常量与变量">常量与变量</h3>
<p><code>val</code>是常量，<code>var</code>是变量</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">//val相当于JAVA的final，是常量，var是变量</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">A_LONG</span><span class="op">:</span> <span class="kw">Long</span> <span class="op">=</span> <span class="dv">10000L</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">B_LONG</span><span class="op">:</span> <span class="kw">Long</span> <span class="op">=</span> <span class="bn">0xffff</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">C_BYTE</span><span class="op">:</span> <span class="kw">Byte</span> <span class="op">=</span> <span class="bn">0b01111111</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">dFloat</span><span class="op">:</span> <span class="kw">Float</span> <span class="op">=</span> <span class="fl">12.3F</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">//可以给数字之间加下划线以提高可读性</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">fInt</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">1_000_000</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">//自动类型推断，类型可以省略</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">fChar</span> <span class="op">=</span> <span class="ch">&#39;\u000f&#39;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">//基本数据类型之间不能自动转换</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">a</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">b</span><span class="op">:</span> <span class="kw">Long</span> <span class="op">=</span> a<span class="op">.</span>toLong<span class="op">()</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">//NaN(Not a number)之间总是不相等的</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">d1</span><span class="op">:</span><span class="kw">Double</span> <span class="op">=</span> <span class="kw">Double</span><span class="op">.</span>NaN</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">d2</span><span class="op">:</span><span class="kw">Double</span> <span class="op">=</span> <span class="kw">Double</span><span class="op">.</span>NaN</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>print<span class="op">(</span>d1<span class="op">==</span>d2<span class="op">)</span><span class="co">//false</span></span></code></pre></div>
<p><code>val</code>修饰的常量只是在语义上不可修改，但编译成字节码的时候仍然是使用其引用，不会宏替换，如果想使用宏替换，需要定义编译期常量，编译期常量用<code>const val</code>修饰，相当于JAVA中用final修饰的变量，会被编译优化</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="kw">val</span> <span class="va">SUBSYSTEM_DEPRECATED</span><span class="op">:</span> <span class="kw">String</span> <span class="op">=</span> <span class="st">&quot;This subsystem is deprecated&quot;</span></span></code></pre></div>
<h3 id="位运算">位运算</h3>
<p>只能用于Int和Long</p>
<pre><code>shl  – 相当于Java的&quot;&lt;&lt;&quot;
shr  – 相当于Java的&quot;&gt;&gt;&quot;
ushr – 相当于Java的&quot;&gt;&gt;&gt;&quot;
and  - 与
or   - 或
xor  - 异或
inv  - 取反</code></pre>
<p>如</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">x</span> <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> shl <span class="dv">2</span><span class="op">)</span> and <span class="bn">0x000FF000</span></span></code></pre></div>
<h3 id="转义字符">转义字符</h3>
<p>Char类型及String可以用转义字符</p>
<pre><code>\t          制表符
\b          光标后退一个字符
\n          回车
\r          光标回到行首
\&#39;          单引号
\&quot;          双引号
\\          反斜杠
\$          美元符号，Kotlin 支持美元符号开头的字符串模板</code></pre>
<h3 id="字符串模板长字符串">字符串模板、长字符串</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">//字符串模板用$name，或${name}，对于复杂的表达式必须带大括号(如调用对象的属性时)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;小明&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span><span class="st">&quot;Hello </span><span class="ss">${</span>name<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">//长字符串用三个引号包裹，长字符串无法使用转义字符，但可以用字符串模板</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">blobText</span> <span class="op">=</span> <span class="st">&quot;&quot;&quot;你好</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="sc">\t</span><span class="st">Hello</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="sc">\$</span><span class="st">{name}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>blobText<span class="op">)</span></span></code></pre></div>
<h3 id="比较与">比较(<code>==</code>与<code>===</code>)</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">//==比较字符串内容，相当于JAVA的的equals，===比较是否为同一个对象，这同样适用于基本数据类型（同理也有!=和!==）</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">aString</span> <span class="op">=</span> <span class="st">&quot;Hello World!&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">hello</span> <span class="op">=</span> <span class="st">&quot;Hello&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">bString</span> <span class="op">=</span> hello <span class="op">+</span> <span class="st">&quot; World!&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>aString <span class="op">==</span> bString<span class="op">)</span><span class="co">//true</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>aString <span class="op">===</span> bString<span class="op">)</span><span class="co">//false</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">//基本数据类型会根据需要转换成JAVA的装箱类，也会出现值相同，但对象不相同的情况</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">//可空的基本数据类型是会自动装箱的，因为JAVA中的int等基本数据类型是不能为null的，而包装类Integer是可以为null的</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">i1</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">i2</span><span class="op">:</span> <span class="kw">Int</span><span class="op">?</span> <span class="op">=</span> i1<span class="co">//Integer.valueOf(i1)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">i3</span><span class="op">:</span> <span class="kw">Int</span><span class="op">?</span> <span class="op">=</span> i1<span class="co">//Integer.valueOf(i1)</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>i2 <span class="op">==</span> i3<span class="op">)</span><span class="co">//true</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>i2 <span class="op">===</span> i3<span class="op">)</span><span class="co">//false</span></span></code></pre></div>
<h3 id="安全空类型">安全空类型</h3>
<p>如果想像JAVA一样定义一个String，给其赋值为null，在Kotlin里面是不行的，如果一定要这样做，需要使用可空类型(<code>类名?</code>)</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">str</span><span class="op">:</span> <span class="kw">String</span><span class="op">?</span> <span class="op">=</span> <span class="kw">null</span></span></code></pre></div>
<p>但是使用的时候就要加<code>?</code>或<code>!!</code>(非空断言)</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">//尝试去掉length，如果str为null，则返回null</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>str<span class="op">?.</span>length<span class="op">)</span><span class="co">//null</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">//确定str不为null，如果str为null，则抛异常</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>str<span class="op">!!.</span>length<span class="op">)</span><span class="co">//报kotlin.KotlinNullPointerException</span></span></code></pre></div>
<p>如果觉得每次都这样写很烦，可以先判断不为空，这时编译器可以智能识别</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>str <span class="op">!=</span> <span class="kw">null</span><span class="op">){</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//因为判过是否为空，则调用时不需加?或!!</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>str<span class="op">.</span>length<span class="op">)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">//同样，在&amp;&amp;或者||右边也是可以智能识别的</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>str <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> str<span class="op">.</span>length <span class="op">&gt;</span> <span class="dv">5</span><span class="op">){</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//..</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>判空的简化写法(Elvis运算符)</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">str</span><span class="op">:</span> <span class="kw">String</span><span class="op">?</span> <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>str<span class="op">?:</span> <span class="st">&quot;str is null&quot;</span><span class="op">)</span><span class="co">//如果str为null，则打印str is null</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">//如果不为空则打印长度，如果为空则打印“empty”</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>str<span class="op">?.</span>length <span class="op">?:</span> <span class="st">&quot;empty&quot;</span><span class="op">)</span></span></code></pre></div>
<p>这种写法在JAVA中实现就需要用到Optional类了</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> <span class="fu">strLength</span><span class="op">(</span>Optional<span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果s里面的内容是null，那就先给s的内容设置一个默认值，然后再调用其length方法</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s<span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">).</span><span class="fu">length</span><span class="op">();</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//JAVA的Optional有点像Kotlin的安全空类型，如果想设置null，要调用ofNullable，就像Kotlin中要声明为可空类型一样</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span> <span class="fu">strLength</span><span class="op">(</span>Optional<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">))</span> <span class="op">);</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span> <span class="fu">strLength</span><span class="op">(</span>Optional<span class="op">.</span><span class="fu">ofNullable</span><span class="op">(</span><span class="kw">null</span><span class="op">))</span> <span class="op">);</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="类型转换类型判断">类型转换、类型判断</h3>
<p>类型转换使用<code>as</code>关键字，相当于JAVA的小括号</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">//会有ClassCastException的风险</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">child</span><span class="op">:</span> Child <span class="op">=</span> parent <span class="kw">as</span> Child</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">//智能类型转换；如果转换失败，则返回null</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">child</span><span class="op">:</span> Child <span class="op">=</span> parent <span class="kw">as</span><span class="op">?</span> Child</span></code></pre></div>
<p>类型判断使用<code>is</code>关键字，可以判断对象是否为某个类或该类的子类</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> Person</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student<span class="op">:</span> <span class="dt">Person</span><span class="op">()</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">person</span> <span class="op">=</span> Person<span class="op">()</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>person <span class="kw">is</span> Any<span class="op">)</span><span class="co">//true</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>person <span class="kw">is</span> Person<span class="op">)</span><span class="co">//true</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>person <span class="kw">is</span> Student<span class="op">)</span><span class="co">//false</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="区间">区间</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fl">0..100</span> <span class="co">//相当于[0, 100]，对应的类型是IntRange</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span> until <span class="dv">100</span> <span class="co">//相当于[0, 100)，对应的类型还是IntRange，其实就是[0,99]</span></span></code></pre></div>
<p>区间可用于for循环，<code>in</code>用在for中可以遍历区间内的元素，用在条件判断中可以判断一个数是否在该区间内（<code>in</code>、<code>!in</code>）</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span>i <span class="kw">in</span> <span class="fl">1..20</span><span class="op">){</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">//in关键字的另一个用法</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span><span class="dv">2</span> <span class="kw">in</span> <span class="fl">1..10</span><span class="op">){</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>还可以使用<code>downTo</code>(倒序)和<code>step</code>(步长)（step无法使用浮点型）</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span>i <span class="kw">in</span> <span class="dv">20</span> downTo <span class="dv">1</span> step <span class="dv">4</span><span class="op">){</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>i<span class="op">)</span><span class="co">//20 16 12 8 4</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="数组">数组</h3>
<p>基本数据类型都有xxxArrayOf的函数，得到一个基本数据类型的数组xxxArray，其他类型用<code>arrayOf</code>，得到<code>Array&lt;类型&gt;</code></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">ints</span><span class="op">:</span> IntArray <span class="op">=</span> IntArrayOf<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">charArray</span><span class="op">:</span> CharArray <span class="op">=</span> charArrayOf<span class="op">(</span><span class="ch">&#39;a&#39;</span><span class="op">,</span> <span class="ch">&#39;b&#39;</span><span class="op">,</span> <span class="ch">&#39;c&#39;</span><span class="op">,</span> <span class="ch">&#39;d&#39;</span><span class="op">,</span> <span class="ch">&#39;e&#39;</span><span class="op">)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">stringArray</span><span class="op">:</span> Array<span class="op">&lt;</span><span class="kw">String</span><span class="op">&gt;</span> <span class="op">=</span> arrayOf<span class="op">(</span><span class="st">&quot;小红&quot;</span><span class="op">,</span> <span class="st">&quot;小明&quot;</span><span class="op">,</span> <span class="st">&quot;小花&quot;</span><span class="op">,</span> <span class="st">&quot;小强&quot;</span><span class="op">,</span> <span class="st">&quot;小王&quot;</span><span class="op">)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>charArray<span class="op">.</span>joinToString<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">))</span><span class="co">//abcde</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>stringArray<span class="op">.</span>slice<span class="op">(</span><span class="fl">1..3</span> step <span class="dv">2</span><span class="op">))</span><span class="co">//[小明, 小强]</span></span></code></pre></div>
<p>也可以直接调用Array的构造函数</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">//创建一个长度为5，内容为下标的平方的数组</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">square</span><span class="op">:</span> Array<span class="op">&lt;</span><span class="kw">Int</span><span class="op">&gt;</span> <span class="op">=</span> Array<span class="op">(</span><span class="dv">5</span><span class="op">,</span> <span class="op">{</span> i <span class="op">-&gt;</span> i <span class="op">*</span> i <span class="op">})</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>square<span class="op">.</span>forEach<span class="op">(::</span>println<span class="op">)</span><span class="co">//输出0 1 4 9 16</span></span></code></pre></div>
<h3 id="包">包</h3>
<p>包的概念和JAVA一样，包的声明也应该在最前面</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> <span class="im">com</span><span class="op">.</span><span class="im">myapp</span></span></code></pre></div>
<h3 id="别名">别名</h3>
<p>导入包中的某个类的时候可以给这个类取别名</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">myapp</span><span class="op">.</span><span class="im">MyClass</span> <span class="kw">as</span> <span class="dt">A</span><span class="co">//MyClass这个类别名为A</span></span></code></pre></div>
<p>也可以在代码中给类取别名</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typealias</span> B <span class="op">=</span> <span class="kw">Boolean</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">b</span><span class="op">:</span> B <span class="op">=</span> <span class="kw">true</span></span></code></pre></div>
<h2 id="程序结构">程序结构</h2>
<h3 id="条件表达式ifwhen">条件表达式(if、when)</h3>
<p>if与JAVA中的if一样，when相当于JAVA中的switch，但JAVA的switch只支持几个基本数据类型及String，而Kotlin的when几乎支持所有的类型</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>条件<span class="er">1</span><span class="op">){</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span><span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>条件<span class="er">2</span><span class="op">){</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span><span class="cf">else</span><span class="op">{</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="cf">when</span><span class="op">(</span>条件<span class="op">){</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  条件值<span class="er">1</span> <span class="op">-&gt;</span> 执行语句<span class="er">1</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  条件值<span class="er">2</span> <span class="op">-&gt;</span> 执行语句<span class="er">2</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  条件值<span class="er">3</span><span class="op">,</span> 条件值<span class="er">4</span> <span class="op">-&gt;</span> 执行语句<span class="er">3</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> <span class="op">-&gt;</span> 执行语句<span class="er">4</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">view</span> <span class="op">=</span> RecyclerView<span class="op">()</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    myPrint<span class="op">(</span>view<span class="op">)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">myPrint</span><span class="op">(</span><span class="va">view</span> <span class="op">:</span> <span class="dt">View</span><span class="op">){</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">when</span> <span class="op">(</span>view<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">is</span> TextView <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;TextView&quot;</span><span class="op">)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">is</span> RecyclerView <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;RecyclerView&quot;</span><span class="op">)</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">is</span> SearchView <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;SearchView&quot;</span><span class="op">)</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">//甚至可以调函数</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        getMyView<span class="op">()</span> <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;MyView&quot;</span><span class="op">)</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">is</span> View <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;basic View&quot;</span><span class="op">)</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;View type not supported&quot;</span><span class="op">)</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> View</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TextView<span class="op">:</span><span class="dt">View</span><span class="op">()</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RecyclerView<span class="op">:</span><span class="dt">View</span><span class="op">()</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SearchView<span class="op">:</span><span class="dt">View</span><span class="op">()</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyView<span class="op">:</span><span class="dt">View</span><span class="op">()</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getMyView</span><span class="op">()</span> <span class="op">=</span> MyView<span class="op">()</span></span></code></pre></div>
<p>除此以外，if和when是有返回值的，当需要用到返回值时，要求表达式是完备的(有<code>else</code>)，通常用于成员变量(<code>val</code>类型)初始化</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Grade<span class="op">(</span><span class="kw">val</span> <span class="va">grade</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">TYPE1</span><span class="op">:</span> <span class="kw">String</span> <span class="op">=</span> <span class="cf">if</span><span class="op">(</span>grade <span class="kw">in</span> <span class="fl">1..60</span><span class="op">){</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;BAD&quot;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span><span class="cf">else</span> <span class="cf">if</span><span class="op">(</span>grade <span class="kw">in</span> <span class="fl">61..80</span><span class="op">){</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;GOOD&quot;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span><span class="cf">else</span><span class="op">{</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;BEST&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">TYPE2</span><span class="op">:</span> <span class="kw">String</span> <span class="op">=</span> <span class="cf">when</span><span class="op">(</span>grade<span class="op">){</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">in</span> <span class="fl">1..60</span> <span class="op">-&gt;</span> <span class="st">&quot;BAD&quot;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">in</span> <span class="fl">61..80</span> <span class="op">-&gt;</span> <span class="st">&quot;GOOD&quot;</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="op">-&gt;</span> <span class="st">&quot;BEST&quot;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co">//when还可以作为返回值返回</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">transform</span><span class="op">(</span><span class="va">color</span><span class="op">:</span> <span class="dt">String</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="cf">when</span><span class="op">(</span>color<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Red&quot;</span> <span class="op">-&gt;</span> <span class="dv">0</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Green&quot;</span> <span class="op">-&gt;</span> <span class="dv">1</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Blue&quot;</span> <span class="op">-&gt;</span> <span class="dv">2</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="op">-&gt;</span> <span class="kw">throw</span> IllegalArgumentException<span class="op">(</span><span class="st">&quot;Invalid color param value&quot;</span><span class="op">)</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在Kotlin中没有三元表达式，因为JAVA中的三元表达式完全可以用if或when替代</p>
<p>JAVA:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> text <span class="op">=</span> x <span class="op">&gt;</span> <span class="dv">5</span> <span class="op">?</span> <span class="st">&quot;x &gt; 5&quot;</span> <span class="op">:</span> <span class="st">&quot;x &lt;= 5&quot;</span><span class="op">;</span></span></code></pre></div>
<p>Kotlin:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">text</span> <span class="op">=</span> <span class="cf">if</span> <span class="op">(</span>x <span class="op">&gt;</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;x &gt; 5&quot;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>           <span class="cf">else</span> <span class="st">&quot;x &lt;= 5&quot;</span></span></code></pre></div>
<h3 id="循环语句forwhiledo-whilecontinuebreak">循环语句(for、while、do
while、continue、break)</h3>
<p>循环语句没有返回值，<code>for</code>循环使用<code>in</code>遍历区间或集合</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">items</span> <span class="op">=</span> listOf<span class="op">(</span><span class="st">&quot;apple&quot;</span><span class="op">,</span> <span class="st">&quot;banana&quot;</span><span class="op">,</span> <span class="st">&quot;kiwi&quot;</span><span class="op">)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>i <span class="kw">in</span> <span class="fl">1..10</span><span class="op">)</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>item <span class="kw">in</span> items<span class="op">)</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>item<span class="op">)</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>i <span class="kw">in</span> items<span class="op">.</span>indices<span class="op">)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>items<span class="op">[</span>i<span class="op">])</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">//实现了operator componentN后可以以这种方式遍历</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">((</span>index<span class="op">,</span> value<span class="op">)</span> <span class="kw">in</span> items<span class="op">.</span>withIndex<span class="op">())</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;index=</span><span class="ss">$index</span><span class="st"> value=</span><span class="ss">$value</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">lists</span> <span class="op">=</span> listOf<span class="op">(</span>mapOf<span class="op">(</span><span class="st">&quot;name&quot;</span> to <span class="st">&quot;小红&quot;</span><span class="op">,</span> <span class="st">&quot;age&quot;</span> to <span class="dv">14</span><span class="op">),</span> mapOf<span class="op">(</span><span class="st">&quot;name&quot;</span> to <span class="st">&quot;小明&quot;</span><span class="op">,</span> <span class="st">&quot;age&quot;</span> to <span class="dv">15</span><span class="op">))</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span><span class="op">(</span>map <span class="kw">in</span> lists<span class="op">){</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">((</span>key<span class="op">,</span>value<span class="op">)</span> <span class="kw">in</span> map<span class="op">){</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$key</span><span class="st"> = </span><span class="ss">$value</span><span class="st"> &quot;</span><span class="op">)</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>for可以遍历任何提供了<code>iterator</code>的函数或对象</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="kw">in</span> fibonacci<span class="op">())</span> <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>i <span class="op">&gt;</span> <span class="dv">100</span><span class="op">)</span> <span class="cf">break</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">fibonacci</span><span class="op">():</span> <span class="dt">Iterable</span><span class="op">&lt;</span><span class="dt">Long</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">first</span> <span class="op">=</span> <span class="dv">0L</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">second</span> <span class="op">=</span> <span class="dv">1L</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Iterable <span class="op">{</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">object</span> <span class="op">:</span> <span class="dt">LongIterator</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">hasNext</span><span class="op">():</span> <span class="dt">Boolean</span> <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">nextLong</span><span class="op">():</span> <span class="dt">Long</span> <span class="op">{</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">val</span> <span class="va">result</span> <span class="op">=</span> second</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>                second <span class="op">+=</span> first</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>                first <span class="op">=</span> second <span class="op">-</span> first</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> result</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>while、do while和JAVA中一样</p>
<p>continue和break可以使用标签</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>loop<span class="at">@</span> <span class="cf">for</span><span class="op">(</span>i <span class="kw">in</span> <span class="fl">1..5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>j <span class="kw">in</span> <span class="fl">1..5</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>i<span class="op">==</span>j <span class="op">&amp;&amp;</span> i<span class="op">&gt;</span><span class="dv">3</span><span class="op">)</span> break<span class="at">@loop</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;(</span><span class="ss">$i</span><span class="st">,</span><span class="ss">$j</span><span class="st">) &quot;</span><span class="op">)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="异常捕获trycatchfinally">异常捕获(try、catch、finally)</h3>
<p>和if、when一样，try也是有返回值的，捕获异常用try、catch、finally，抛异常用throw，和JAVA是一样的</p>
<h2 id="函数">函数</h2>
<h3 id="函数的定义">函数的定义</h3>
<p>函数声明用<code>fun</code>，函数参数后面用<code>:返回值类型</code></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span><span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> x <span class="op">+</span> y</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>当函数体只有一行（单表达式函数）时可以写成</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">//此时返回值类型可以自动推断，返回值的类型可以省略</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y</span></code></pre></div>
<p>函数还可以返回一个函数或Lambda表达式（Kotlin支持闭包）</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">//返回匿名函数，此时返回值类型为(Int, Int) -&gt; Int</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getAdd1</span><span class="op">():</span> <span class="op">(</span><span class="dt">Int</span><span class="op">,</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">fun</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span><span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> x <span class="op">+</span> y</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">//函数体只有一行，可以简写成</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getAdd2</span><span class="op">():</span> <span class="op">(</span><span class="dt">Int</span><span class="op">,</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span><span class="op">{</span> <span class="kw">return</span> x <span class="op">+</span> y <span class="op">}</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">//此时函数的返回值类型可以省略</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getAdd3</span><span class="op">()</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">//返回Lambda表达式，返回值类型同上面一样</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getAdd4</span><span class="op">():</span> <span class="op">(</span><span class="dt">Int</span><span class="op">,</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">add</span> <span class="op">=</span> <span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> x <span class="op">+</span> y <span class="op">}</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> add</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co">//同理，函数体只有一行，可以简写成</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getAdd5</span><span class="op">()</span> <span class="op">=</span> <span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span><span class="op">,</span> y<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> x <span class="op">+</span> y <span class="op">}</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co">//调用方式</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>getAdd3<span class="op">()(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co">//或者</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">add3</span> <span class="op">=</span> getAdd3<span class="op">()</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>add3<span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span></span></code></pre></div>
<p>函数如果没有返回值，则返回值类型为<code>Unit</code>（用于返回函数时对函数类型的声明，普通函数不写返回值类型就行了）</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getMethod</span><span class="op">():</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)-&gt;</span><span class="dt">Unit</span><span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">fun</span><span class="op">(</span><span class="va">i</span><span class="op">:</span> <span class="dt">Int</span><span class="op">){</span> println<span class="op">(</span>i<span class="op">)</span> <span class="op">}</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">method1</span><span class="op">(){</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;Hello World&quot;</span><span class="op">)</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果想表示一个函数永远返回<code>null</code>，可以使用<code>Nothing?</code></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">method2</span><span class="op">():</span> <span class="dt">Nothing</span><span class="op">?{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">null</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="具名参数变长参数默认参数">具名参数、变长参数、默认参数</h3>
<p>除了具名参数外，函数还可以有默认参数，变长参数(<code>vararg</code>)，只要前面省略了默认参数，则后面的参数必须使用具名参数写法，变长参数不能直接传数组，要把数组的元素放到变长参数的位置，则要用<code>*</code>(spread
operator)</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">method1</span><span class="op">(</span><span class="va">num1</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span><span class="kw">vararg</span> <span class="va">str</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">num2</span><span class="op">:</span> <span class="dt">Double</span><span class="op">){</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">array</span> <span class="op">=</span> arrayOf<span class="op">(</span><span class="st">&quot;aa&quot;</span><span class="op">,</span> <span class="st">&quot;bb&quot;</span><span class="op">,</span> <span class="st">&quot;cc&quot;</span><span class="op">)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    method1<span class="op">(</span>str <span class="op">=</span> <span class="op">*</span>array<span class="op">,</span> num2 <span class="op">=</span> <span class="fl">2.3</span><span class="op">)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>由于JAVA不支持默认参数，如果想在JAVA中使用Kotlin定义的默认参数函数，可以加<code>@JvmOverloads</code></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="at">@JvmOverloads</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">method2</span><span class="op">(</span><span class="va">num1</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">vararg</span> <span class="va">str</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">num2</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>num1<span class="op">)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    str<span class="op">.</span>forEach <span class="op">{</span> println<span class="op">(</span>it<span class="op">)</span> <span class="op">}</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>num2<span class="op">)</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时会生成两个不同的重裁方法</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="at">@JvmOverloads</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">void</span> <span class="fu">method2</span><span class="op">(</span><span class="dt">int</span> num1<span class="op">,</span> <span class="at">@NotNull</span> <span class="bu">String</span><span class="op">[]</span> str<span class="op">,</span> <span class="dt">double</span> num2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    Intrinsics<span class="op">.</span><span class="fu">checkParameterIsNotNull</span><span class="op">(</span>str<span class="op">,</span> <span class="st">&quot;str&quot;</span><span class="op">);</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="at">@JvmOverloads</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> method2$<span class="fu">default</span><span class="op">(</span><span class="dt">int</span> var0<span class="op">,</span> <span class="bu">String</span><span class="op">[]</span> var1<span class="op">,</span> <span class="dt">double</span> var2<span class="op">,</span> <span class="dt">int</span> var4<span class="op">,</span> <span class="bu">Object</span> var5<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">((</span>var4 <span class="op">&amp;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        var0 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">method2</span><span class="op">(</span>var0<span class="op">,</span> var1<span class="op">,</span> var2<span class="op">);</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="at">@JvmOverloads</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">void</span> <span class="fu">method2</span><span class="op">(</span><span class="at">@NotNull</span> <span class="bu">String</span><span class="op">[]</span> str<span class="op">,</span> <span class="dt">double</span> num2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    method2$<span class="fu">default</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> str<span class="op">,</span> num2<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="op">(</span><span class="bu">Object</span><span class="op">)</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="lambda表达式">Lambda表达式</h3>
<h4 id="使用规则">使用规则</h4>
<p>Lambda表达式可以认为是匿名函数的简化写法</p>
<ul>
<li><p>当函数最后一个参数是Lambda表达式时，Lambda表达式可以移出括号外</p></li>
<li><p>如果函数只有一个参数且该参数是Lambda表达式时，则表示函数参数列表的小括号可以省略</p></li>
<li><p>Lambda只有一个参数时，参数名字默认为it，此时可以省略参数列表</p></li>
<li><p>Lambda表达式支持自动类型推断，如函数接收Lambda表达式参数时指定了Lambda表达式的类型，从而Lambda表达式的参数类型也确定了，这时使用该函数时Lambda表达式的参数类型可以省略</p></li>
<li><p>Lambda表达式的返回值为最后一行表达式的值，如果最后一行没有值，则返回值类型为Unit</p></li>
<li><p>Lambda表达式可以用下划线<code>_</code>表示没有用到的参数</p></li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">array</span><span class="op">:</span> Array<span class="op">&lt;</span><span class="kw">String</span><span class="op">&gt;</span> <span class="op">=</span> arrayOf<span class="op">(</span><span class="st">&quot;1&quot;</span><span class="op">,</span><span class="st">&quot;2&quot;</span><span class="op">,</span><span class="st">&quot;3&quot;</span><span class="op">)</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">//array.forEach({ println(it) })</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">//array.forEach(){ println(it) }</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">//和上面的写法完全等价</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>array<span class="op">.</span>forEach <span class="op">{</span> println<span class="op">(</span>it<span class="op">)</span> <span class="op">}</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">map</span> <span class="op">=</span> mapOf<span class="op">(</span><span class="st">&quot;a&quot;</span> to <span class="st">&quot;1&quot;</span><span class="op">,</span><span class="st">&quot;b&quot;</span> to <span class="st">&quot;2&quot;</span><span class="op">,</span><span class="st">&quot;c&quot;</span> to <span class="st">&quot;3&quot;</span><span class="op">)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span>forEach<span class="op">{</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">,</span> value <span class="op">-&gt;</span> println<span class="op">(</span><span class="st">&quot;</span><span class="ss">$value</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Kotlin调用JAVA时，Kotlin支持JAVA的<code>FunctionalInterface</code>写法，即如果一个JAVA中的接口是<code>FunctionalInterface</code>时，创建该接口的匿名内部类时可以用Lambda表达式替代，但Kotlin自身没有<code>FunctionalInterface</code>的写法，如果要那样写，就要为使用接口类型参数和使用Lambda类型参数定义两个重裁的方法</p>
<h4 id="this">this</h4>
<p>一般情况下，把Lambda表达式作为参数传入时，Lambda表达式中的this指的是Lambda表达式所在的类，但像<code>apply</code>，其Lambda参数类型定义为<code>T.() -&gt; Unit</code>（指定接收者的Lambda，在后面<code>扩展Lambda</code>一节中会详细讲到），此时Lambda表达式中的this指调用者，而不再指向所在类了</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">//这里Lambda的类型为T.() -&gt; Unit，这时Lambda中的this指向调用者本身，也就是T</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="at">@kotlin</span><span class="op">.</span><span class="kw">internal</span><span class="op">.</span>InlineOnly</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">T</span><span class="op">.</span><span class="fu">apply</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">T</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>)<span class="op">:</span> <span class="dt">T</span> <span class="op">{</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    contract <span class="op">{</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        callsInPlace<span class="op">(</span>block<span class="op">,</span> InvocationKind<span class="op">.</span>EXACTLY_ONCE<span class="op">)</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    block<span class="op">()</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">this</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">//其他把Lambda作为参数的函数中Lambda类型是(T) -&gt; Unit，这时Lambda中this指Lambda所在类，如果是包级函数，则不能使用this</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">Array</span><span class="op">&lt;</span><span class="kw">out</span> <span class="dt">T</span><span class="op">&gt;.</span><span class="fu">forEach</span><span class="op">(</span><span class="va">action</span><span class="op">:</span> <span class="op">(</span><span class="dt">T</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Unit</span><span class="op">):</span> <span class="dt">Unit</span> <span class="op">{</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>element <span class="kw">in</span> <span class="kw">this</span><span class="op">)</span> action<span class="op">(</span>element<span class="op">)</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="方法引用">方法引用</h4>
<p>包级函数可用<code>::方法名</code>，如<code>::println</code>，类中的函数可用<code>类名::方法名</code>或<code>实例::方法名</code>来获取方法引用</p>
<h4 id="inline">inline</h4>
<p>Lambda表达式中不允许直接使用<code>return</code>返回，但仍可以通过标签返回</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">//下面代码编译不通过</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">fun func1(): Int{</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">    var innerfunc = {x: Int -&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">        if(x == 0)</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co">            return 0//不能在Lambda中直接使用return返回</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">        println(x)</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co">        1</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="co">    }</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="co">    println(&quot;func1 -- end&quot;)</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="co">//下面代码可以通过编译</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    func1<span class="op">()</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">func1</span><span class="op">(){</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">innerfunc</span><span class="op">:</span> <span class="op">(</span><span class="kw">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="kw">Int</span> <span class="op">=</span> tag<span class="at">@</span><span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">){</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;x is zero!!&quot;</span><span class="op">)</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>            return<span class="at">@tag</span> <span class="dv">0</span><span class="co">//通过标签返回是允许的，注意带返回值的标签返回的写法</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Lambda表达式最后一行是返回值，这里相当于return@tag 1（这里也不能直接用return）</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    innerfunc<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func1 -- end&quot;</span><span class="op">)</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>x is zero!!
func1 -- end</code></pre>
<p>但是如果是函数(无论匿名还是具名函数)就可以使用空白的<code>return</code>返回，此时返回的是内部函数，外部函数并不会返回</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">//下面代码可以通过编译</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">func1</span><span class="op">(){</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">innerfunc</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">){</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;x is 0!!&quot;</span><span class="op">)</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    innerfunc<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func1 -- end&quot;</span><span class="op">)</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>x is 0!!
func1 -- end</code></pre>
<p>当接收该Lambda表达式的函数是内联(<code>inline</code>)的时候，Lambda表达式中可以直接使用<code>return</code>返回，此时<code>return</code>会把定义该Lambda表达式的函数返回（<code>非局部返回</code>），而不是结束当前Lambda表达式</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>func2<span class="op">())</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;main: -- end&quot;</span><span class="op">)</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">func2</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    func1 <span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;func2: x is 0!!&quot;</span><span class="op">)</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">//这里return是把func2函数返回，所以返回值类型和func2一致</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;x is zero!!&quot;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;func2: x is </span><span class="ss">$x</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Lambda表达式最后一行是返回值，这里会返回到调用该Lambda表达式的地方，也就是func1，而且不会把func1返回，所以返回值类型只要和函数参数要求一样就行了</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>        x</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func2: -- end&quot;</span><span class="op">)</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;FUNC2&quot;</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(</span><span class="va">myFunc</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">ret</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> myFunc<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func1: resilt is </span><span class="ss">$ret</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func1: -- end&quot;</span><span class="op">)</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时输出</p>
<pre><code>func2: x is 0!!
x is zero!!
main: -- end</code></pre>
<p>如果把myFunc(0)改成myFunc(1)，则输出</p>
<pre><code>func2: x is 1
func1: resilt is 1
func1: -- end
func2: -- end
FUNC2
main: -- end</code></pre>
<p>比如forEach就是内联的</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">Iterable</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">forEach</span><span class="op">(</span><span class="va">action</span><span class="op">:</span> <span class="op">(</span><span class="dt">T</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Unit</span><span class="op">):</span> <span class="dt">Unit</span> <span class="op">{</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>element <span class="kw">in</span> <span class="kw">this</span><span class="op">)</span> action<span class="op">(</span>element<span class="op">)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>所以可以使用<code>return</code>返回</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">items</span> <span class="op">=</span> arrayListOf<span class="op">&lt;</span><span class="kw">Int</span><span class="op">&gt;(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">7</span><span class="op">)</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span>forEach<span class="op">{</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>it <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="kw">return</span> <span class="co">//返回到定义该Lambda表达式的地方，也就是结束当前Lambda表达式</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>it<span class="op">)</span><span class="co">//输出1 4</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//可以使用隐式标签，隐式标签为使用该Lambda表达式的函数名</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span>forEach <span class="op">{</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>it <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> return<span class="at">@forEach</span><span class="co">//跳过此次遍历，有点像循环控制中的continue</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>it<span class="op">)</span><span class="co">//输出1 4 9 7</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>由于<code>inline</code>会导致函数中所有参数都被内联，如果希望某些参数不被内联，可以使用<code>noinline</code>修饰这些参数</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    func1 <span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>x<span class="op">==</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>            return<span class="at">@func1</span>  <span class="dv">0</span><span class="co">//此时只能通过标签返回，隐式标签返回会返回到使用该Lambda表达式的地方，所以后面的打印还能继续执行</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>        x <span class="op">+</span> <span class="dv">10</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(</span><span class="kw">noinline</span> <span class="va">myFunc</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>myFunc<span class="op">(</span><span class="dv">0</span><span class="op">))</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="st">&quot;func1 -- end&quot;</span><span class="op">)</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>0
func1 -- end</code></pre>
<p>在<code>inline</code>函数中使用<code>crossinline</code>修饰的参数会被禁止<code>非局部返回</code></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(</span><span class="kw">noinline</span> <span class="va">myFunc</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>myFunc<span class="op">(</span><span class="dv">0</span><span class="op">))</span><span class="co">//此时myFunc也不能直接使用return，只能通过标签的形式返回</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>内联函数还可以使用<code>reified</code>关键字来具体化类型参数</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>isTypeof<span class="op">(</span>Person<span class="op">(),</span> Person<span class="op">::</span><span class="kw">class</span>.java))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span><span class="va">isTypeof</span>&lt;<span class="va">Person</span>&gt;(<span class="va">Person</span>(<span class="op">)</span>))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="co">//普通函数由于无法知道T是什么具体类型。不能使用is判断</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> isTypeof<span class="op">(</span><span class="va">obj</span><span class="op">:</span> <span class="dt">Any</span><span class="op">,</span> <span class="va">clazz</span><span class="op">:</span> <span class="dt">Class</span>&lt;<span class="va">T</span>&gt;<span class="op">):</span> <span class="dt">Boolean</span> <span class="op">{</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> clazz<span class="op">.</span>isInstance<span class="op">(</span>obj<span class="op">)</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">//使用了reified后，T的类型就是确定了的，可以使用is判断</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="kw">reified</span> <span class="dt">T</span><span class="op">&gt;</span> <span class="fu">isTypeof</span><span class="op">(</span><span class="va">obj</span><span class="op">:</span> <span class="dt">Any</span><span class="op">):</span> <span class="dt">Boolean</span> <span class="op">{</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> obj <span class="kw">is</span> T</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="特殊函数">特殊函数</h3>
<h4 id="operator函数">operator函数</h4>
<p>Kotlin中可以重裁已有的运算符，重裁对应的方法即可</p>
<pre><code>运算符     对应的函数名
+a          unaryPlus
-a          unaryMinus
!a          not
a++         inc
a--         des
a + b       plus
a - b       minus
a * b       times
a / b       div
a % b       mod
a..b        rangeTo
a in b      contains
a[i]        get(i)
a[i] = b    set(i, b)
a(i)        invoke(i)
a(i, j)     invoke(i, j)
a += b      plusAssign
a -= b      minusAssign
a *= b      timesAssign
a /= b      divAssign
a %= b      modAssign
&gt;、&lt;、&gt;=、&lt;=   compareTo
a == b      a?.equals(b)?:b.identityEquals(null)</code></pre>
<p>如</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span>Complex<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">-</span> Complex<span class="op">(</span><span class="fl">2.0</span><span class="op">,</span> <span class="fl">1.5</span><span class="op">))</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Complex<span class="op">(</span><span class="kw">var</span> <span class="va">real</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="kw">var</span> <span class="va">imaginary</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">plus</span><span class="op">(</span><span class="va">c</span><span class="op">:</span> <span class="dt">Complex</span><span class="op">):</span> <span class="dt">Complex</span> <span class="op">{</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Complex<span class="op">(</span>c<span class="op">.</span>real <span class="op">+</span> real<span class="op">,</span> c<span class="op">.</span>imaginary <span class="op">+</span> imaginary<span class="op">)</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">minus</span><span class="op">(</span><span class="va">c</span><span class="op">:</span> <span class="dt">Complex</span><span class="op">):</span> <span class="dt">Complex</span> <span class="op">{</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Complex<span class="op">(</span>real <span class="op">-</span> c<span class="op">.</span>real<span class="op">,</span> imaginary <span class="op">-</span> c<span class="op">.</span>imaginary<span class="op">)</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">toString</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;</span><span class="ss">$real</span><span class="st"> + </span><span class="ss">$imaginary</span><span class="st"> * i&quot;</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="infix函数">infix函数</h4>
<p>像<code>in</code>、<code>by</code>这样的叫中缀表达式，它们通过infix来定义</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">partent</span> <span class="op">=</span> Partent<span class="op">()</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">stu</span> <span class="op">=</span> Student<span class="op">()</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>stu belongTo partent<span class="op">)</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> Partent</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student<span class="op">()</span> <span class="op">:</span> <span class="dt">Partent</span><span class="op">(){</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">infix</span> <span class="kw">fun</span> <span class="fu">belongTo</span><span class="op">(</span><span class="va">s</span><span class="op">:</span> <span class="dt">Student</span><span class="op">):</span> <span class="dt">Boolean</span><span class="op">{</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> s <span class="kw">is</span> Partent</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">infix</span> <span class="kw">fun</span> <span class="fu">belongTo</span><span class="op">(</span><span class="va">s</span><span class="op">:</span> <span class="dt">Partent</span><span class="op">):</span> <span class="dt">Boolean</span><span class="op">{</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> s <span class="kw">is</span> Partent</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="functionn接口">FunctionN接口</h4>
<p>在Kotlin中，对于每种函数都有对应的接口声明，如：没有参数的函数对应<code>Function0</code>，一个参数的函数对应<code>Function1</code>…</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> Function0<span class="op">&lt;</span><span class="kw">out</span> <span class="dt">R</span><span class="op">&gt;</span> <span class="op">:</span> <span class="dt">Function</span><span class="op">&lt;</span><span class="dt">R</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">():</span> <span class="dt">R</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> <span class="fu">Function1</span><span class="op">&lt;</span><span class="kw">in</span> <span class="dt">P1</span>, <span class="kw">out</span> <span class="dt">R</span><span class="op">&gt;</span> <span class="op">:</span> <span class="dt">Function</span><span class="op">&lt;</span><span class="dt">R</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">(</span><span class="va">p1</span><span class="op">:</span> <span class="dt">P1</span><span class="op">):</span> <span class="dt">R</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> <span class="fu">Function22</span><span class="op">&lt;</span><span class="kw">in</span> <span class="dt">P1</span>, <span class="kw">in</span> <span class="dt">P2</span>, <span class="kw">in</span> <span class="dt">P3</span>, <span class="kw">in</span> <span class="dt">P4</span>, <span class="kw">in</span> <span class="dt">P5</span>, <span class="kw">in</span> <span class="dt">P6</span>, <span class="kw">in</span> <span class="dt">P7</span>, <span class="kw">in</span> <span class="dt">P8</span>, <span class="kw">in</span> <span class="dt">P9</span>, <span class="kw">in</span> <span class="dt">P10</span>, <span class="kw">in</span> <span class="dt">P11</span>, <span class="kw">in</span> <span class="dt">P12</span>, <span class="kw">in</span> <span class="dt">P13</span>, <span class="kw">in</span> <span class="dt">P14</span>, <span class="kw">in</span> <span class="dt">P15</span>, <span class="kw">in</span> <span class="dt">P16</span>, <span class="kw">in</span> <span class="dt">P17</span>, <span class="kw">in</span> <span class="dt">P18</span>, <span class="kw">in</span> <span class="dt">P19</span>, <span class="kw">in</span> <span class="dt">P20</span>, <span class="kw">in</span> <span class="dt">P21</span>, <span class="kw">in</span> <span class="dt">P22</span>, <span class="kw">out</span> <span class="dt">R</span><span class="op">&gt;</span> <span class="op">:</span> <span class="dt">Function</span><span class="op">&lt;</span><span class="dt">R</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">(</span><span class="va">p1</span><span class="op">:</span> <span class="dt">P1</span><span class="op">,</span> <span class="va">p2</span><span class="op">:</span> <span class="dt">P2</span><span class="op">,</span> <span class="va">p3</span><span class="op">:</span> <span class="dt">P3</span><span class="op">,</span> <span class="va">p4</span><span class="op">:</span> <span class="dt">P4</span><span class="op">,</span> <span class="va">p5</span><span class="op">:</span> <span class="dt">P5</span><span class="op">,</span> <span class="va">p6</span><span class="op">:</span> <span class="dt">P6</span><span class="op">,</span> <span class="va">p7</span><span class="op">:</span> <span class="dt">P7</span><span class="op">,</span> <span class="va">p8</span><span class="op">:</span> <span class="dt">P8</span><span class="op">,</span> <span class="va">p9</span><span class="op">:</span> <span class="dt">P9</span><span class="op">,</span> <span class="va">p10</span><span class="op">:</span> <span class="dt">P10</span><span class="op">,</span> <span class="va">p11</span><span class="op">:</span> <span class="dt">P11</span><span class="op">,</span> <span class="va">p12</span><span class="op">:</span> <span class="dt">P12</span><span class="op">,</span> <span class="va">p13</span><span class="op">:</span> <span class="dt">P13</span><span class="op">,</span> <span class="va">p14</span><span class="op">:</span> <span class="dt">P14</span><span class="op">,</span> <span class="va">p15</span><span class="op">:</span> <span class="dt">P15</span><span class="op">,</span> <span class="va">p16</span><span class="op">:</span> <span class="dt">P16</span><span class="op">,</span> <span class="va">p17</span><span class="op">:</span> <span class="dt">P17</span><span class="op">,</span> <span class="va">p18</span><span class="op">:</span> <span class="dt">P18</span><span class="op">,</span> <span class="va">p19</span><span class="op">:</span> <span class="dt">P19</span><span class="op">,</span> <span class="va">p20</span><span class="op">:</span> <span class="dt">P20</span><span class="op">,</span> <span class="va">p21</span><span class="op">:</span> <span class="dt">P21</span><span class="op">,</span> <span class="va">p22</span><span class="op">:</span> <span class="dt">P22</span><span class="op">):</span> <span class="dt">R</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="componentn函数">componentN函数</h4>
<p>像<code>(index, value) in list.withIndex()</code>(解构声明)是通过重写<code>componentN</code>函数实现的，data
class默认重写了这两个函数，对于非data class，可以自己重写</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User<span class="op">(</span><span class="kw">val</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">val</span> <span class="va">addr</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//componentN是操作符,重载它,必须添加operator修饰符</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">component1</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> name</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">component2</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> addr</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> (<span class="va">name</span><span class="op">,</span> addr<span class="op">)</span> <span class="op">=</span> User<span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="st">&quot;地址&quot;</span><span class="op">)</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="invoke约定">invoke约定</h4>
<p>其实是运算符重裁的一种，调用<code>实例()</code>时，括号内有几个参数就会调有几个参数的<code>invoke</code>方法（参数类型要匹配）</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">p</span> <span class="op">=</span> Person<span class="op">(</span><span class="st">&quot;aaa&quot;</span><span class="op">)</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    p<span class="op">()</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    p<span class="op">(</span><span class="st">&quot;bbb&quot;</span><span class="op">)</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    p<span class="op">(</span><span class="st">&quot;aaa&quot;</span><span class="op">,</span> <span class="st">&quot;bbb&quot;</span><span class="op">,</span> <span class="st">&quot;ccc&quot;</span><span class="op">,</span> <span class="st">&quot;ddd&quot;</span><span class="op">)</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person<span class="op">(</span><span class="kw">val</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;my name is </span><span class="ss">$name</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">(</span><span class="va">str</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;my name is </span><span class="ss">$str</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">invoke</span><span class="op">(</span><span class="va">str1</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">str2</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">str3</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">str4</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;</span><span class="ss">$str1</span><span class="st"> </span><span class="ss">$str2</span><span class="st"> </span><span class="ss">$str3</span><span class="st"> </span><span class="ss">$str4</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>my name is aaa
my name is bbb
aaa bbb ccc ddd</code></pre>
<h3 id="函数复合">函数复合</h3>
<p>前面提到过，函数可以返回函数或Lambda表达式，同样，Lambda表达式也可以作为参数传入函数，也就可以实现数学意义上<code>f(g(x))</code>的写法了</p>
<p>如，集合中的filter函数</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">Iterable</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">filter</span><span class="op">(</span><span class="va">predicate</span><span class="op">:</span> <span class="op">(</span><span class="dt">T</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Boolean</span><span class="op">):</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> filterTo<span class="op">(</span>ArrayList<span class="op">&lt;</span>T<span class="op">&gt;(),</span> predicate<span class="op">)</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span>, <span class="dt">C</span> <span class="op">:</span> <span class="dt">MutableCollection</span><span class="op">&lt;</span><span class="kw">in</span> <span class="dt">T</span><span class="op">&gt;&gt;</span> <span class="fu">Iterable</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">filterTo</span><span class="op">(</span><span class="va">destination</span><span class="op">:</span> <span class="dt">C</span><span class="op">,</span> <span class="va">predicate</span><span class="op">:</span> <span class="op">(</span><span class="dt">T</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Boolean</span><span class="op">):</span> <span class="dt">C</span> <span class="op">{</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>element <span class="kw">in</span> <span class="kw">this</span><span class="op">)</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>predicate<span class="op">(</span>element<span class="op">))</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>            destination<span class="op">.</span>add<span class="op">(</span>element<span class="op">)</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> destination</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>实现函数复合</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>compose<span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="op">{</span> x <span class="op">-&gt;</span> x <span class="op">+</span> <span class="dv">5</span> <span class="op">},</span> <span class="op">{</span> y <span class="op">-&gt;</span> y <span class="op">*</span> <span class="dv">2</span> <span class="op">}))</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">compose</span><span class="op">(</span><span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">block1</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">block2</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> block2<span class="op">(</span>block1<span class="op">(</span>num<span class="op">))</span><span class="co">//相当于 (4 + 5) * 2，输出18</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>或者</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">fg</span> <span class="op">=</span> fgx<span class="op">(::</span>fx<span class="op">,</span> <span class="op">::</span>gx<span class="op">)</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>fg<span class="op">(</span><span class="dv">4</span><span class="op">))</span><span class="co">//相当于 (4 + 5) * 2，输出18</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">fx</span><span class="op">(</span><span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> num <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">gx</span><span class="op">(</span><span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> num <span class="op">+</span> <span class="dv">5</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">fgx</span><span class="op">(</span><span class="va">fx</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">gx</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> <span class="op">{</span> num<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> fx<span class="op">(</span>gx<span class="op">(</span>num<span class="op">))</span> <span class="op">}</span></span></code></pre></div>
<p>也可以将一个函数的返回值作为参数传入，如</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">add5</span> <span class="op">=</span> <span class="op">{</span> i<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> i <span class="op">+</span> <span class="dv">5</span> <span class="op">}</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">multiplyBy2</span> <span class="op">=</span> <span class="op">{</span> i<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> i <span class="op">*</span> <span class="dv">2</span> <span class="op">}</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>multiplyBy2<span class="op">(</span>add5<span class="op">(</span><span class="dv">4</span><span class="op">)))</span><span class="co">//相当于 (4 + 5) * 2，输出18</span></span></code></pre></div>
<p>这时，如果想对任意函数实现复合，可以给FunctionN添加拓展方法，为了简化书写，我们一般还把复合函数定义成中缀表达式</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">infix</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">P2</span>, <span class="dt">R</span><span class="op">&gt;</span> <span class="fu">Function1</span><span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">P2</span><span class="op">&gt;.</span><span class="fu">andThen</span><span class="op">(</span><span class="va">function</span><span class="op">:</span> <span class="dt">Function1</span>&lt;<span class="va">P2</span><span class="op">,</span> <span class="va">R</span>&gt;<span class="op">):</span> <span class="dt">Function1</span><span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">R</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">fun</span><span class="op">(</span><span class="va">p1</span><span class="op">:</span> <span class="dt">P1</span><span class="op">):</span> <span class="dt">R</span> <span class="op">{</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> function<span class="op">.</span>invoke<span class="op">(</span><span class="kw">this</span><span class="op">.</span>invoke<span class="op">(</span>p1<span class="op">))</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="kw">infix</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">P2</span>, <span class="dt">R</span><span class="op">&gt;</span> <span class="fu">Function1</span><span class="op">&lt;</span><span class="dt">P2</span>, <span class="dt">R</span><span class="op">&gt;.</span><span class="fu">compose</span><span class="op">(</span><span class="va">function</span><span class="op">:</span> <span class="dt">Function1</span>&lt;<span class="va">P1</span><span class="op">,</span> <span class="va">P2</span>&gt;<span class="op">):</span> <span class="dt">Function1</span><span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">R</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">fun</span><span class="op">(</span><span class="va">p1</span><span class="op">:</span> <span class="dt">P1</span><span class="op">):</span> <span class="dt">R</span> <span class="op">{</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">this</span><span class="op">.</span>invoke<span class="op">(</span>function<span class="op">.</span>invoke<span class="op">(</span>p1<span class="op">))</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">add5AndMultiplyBy2</span> <span class="op">=</span> add5 andThen multiplyBy2</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">add5ComposeMultiplyBy2</span> <span class="op">=</span> add5 compose multiplyBy2</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>add5AndMultiplyBy2<span class="op">(</span><span class="dv">8</span><span class="op">))</span><span class="co">//相当于 (8 + 5) * 2，输出26</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>add5ComposeMultiplyBy2<span class="op">(</span><span class="dv">8</span><span class="op">))</span><span class="co">//相当于 8 * 2 + 5，输出21</span></span></code></pre></div>
<h3 id="高阶函数">高阶函数</h3>
<p>函数复合的具体应用，如<code>forEach</code>、<code>map</code>、<code>flatMap</code>、<code>reduce</code>、<code>fold</code>、<code>filter</code>、<code>takeWhile</code>、<code>let</code>、<code>apply</code>、<code>with</code>、<code>use</code>等函数式编程用到的函数</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">a</span> <span class="op">=</span> arrayListOf<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">9</span><span class="op">)</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//forEach和map的区别在于，forEach没有返回值，而map会返回一个新的集合</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1 7 5 2 0 3 9</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//map后会返回一个新的集合，而不会对a做任何修改</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>map <span class="op">{</span> it <span class="op">+</span> <span class="dv">10</span> <span class="op">}.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//11 17 15 12 10 13 19</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">//把多个集合展开成一个</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">b</span> <span class="op">=</span> arrayListOf<span class="op">(</span><span class="fl">1..3</span><span class="op">,</span> <span class="fl">2..4</span><span class="op">,</span> <span class="fl">3..5</span><span class="op">)</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    b<span class="op">.</span>flatMap <span class="op">{</span> it<span class="op">.</span>map <span class="op">{</span> <span class="st">&quot;No.</span><span class="ss">$it</span><span class="st">&quot;</span> <span class="op">}</span> <span class="op">}.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//No.1 No.2 No.3 No.2 No.3 No.4 No.3 No.4 No.5</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//reduce适用于累加、累乘等情况</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>a<span class="op">.</span>reduce <span class="op">{</span> ret<span class="op">,</span> i <span class="op">-&gt;</span> ret <span class="op">+</span> i <span class="op">})</span><span class="co">//27</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">//fold就是有初始值的reduce</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>a<span class="op">.</span>fold<span class="op">(</span><span class="dv">5</span><span class="op">)</span> <span class="op">{</span> ret<span class="op">,</span> i <span class="op">-&gt;</span> ret <span class="op">+</span> i <span class="op">})</span><span class="co">//32</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//筛选</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>filter <span class="op">{</span> it <span class="op">&gt;</span> <span class="dv">4</span> <span class="op">}.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//7 5 9</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">//取出符合条件的，直到有不符合就不再往后取</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>takeWhile <span class="op">{</span> it <span class="op">&lt;</span> <span class="dv">7</span> <span class="op">}.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">//let中的it是a(也就是ArrayList)，对it做更改就是对a做更改，let可以有任意返回值</span></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>let <span class="op">{</span> it<span class="op">.</span>add<span class="op">(</span><span class="dv">10</span><span class="op">)</span> <span class="op">}</span><span class="co">//ArrayList的add方法返回boolean，所以这里返回值类型就是Boolean</span></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1 7 5 2 0 3 9 10</span></span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">//apply中的this是a(也就是ArrayList)，在里面对a的更改是有效的，apply返回a本身</span></span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>apply <span class="op">{</span> add<span class="op">(</span><span class="dv">11</span><span class="op">)</span> <span class="op">}.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1 7 5 2 0 3 9 10 11</span></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1 7 5 2 0 3 9 10 11</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">//with的作用和apply一样，里面的this是a，也可以在里面对a做更改，但它可以有任意返回值</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>with<span class="op">(</span>a<span class="op">){</span> removeAt<span class="op">(</span><span class="dv">8</span><span class="op">)</span> <span class="op">})</span><span class="co">//11，removeAt返回被删除的元素</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>forEach <span class="op">{</span> print<span class="op">(</span><span class="st">&quot;</span><span class="ss">$it</span><span class="st"> &quot;</span><span class="op">)</span> <span class="op">}</span><span class="co">//1 7 5 2 0 3 9 10</span></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    println<span class="op">()</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">//use用于io操作，对于实现了AutoCloseable接口的io流，在use中使用，可以不写close</span></span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>    FileReader<span class="op">(</span>File<span class="op">(</span><span class="st">&quot;test.iml&quot;</span><span class="op">)).</span>use <span class="op">{</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Kotlin给JAVA的io添加了很多方法，readLines就是其中一个</span></span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>it<span class="op">.</span>readLines<span class="op">())</span></span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="柯里化currying及偏函数">柯里化(currying)及偏函数</h3>
<p>把多参数的函数转化成一系列单参数函数就是柯里化</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">//原函数</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">//柯里化后</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="op">(</span><span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">fun</span><span class="op">(</span><span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> x <span class="op">+</span> y</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co">//可以简写成</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co">//调用</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>add<span class="op">(</span><span class="dv">4</span><span class="op">)(</span><span class="dv">5</span><span class="op">)</span><span class="co">//相当于4 + 5，输出9</span></span></code></pre></div>
<p>同样，我们也可以通过给FunctionN添加拓展方法来实现对任意函数的柯里化</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">ret</span> <span class="op">=</span> <span class="op">::</span>add<span class="op">.</span>curried<span class="op">()(</span><span class="dv">2</span><span class="op">)(</span><span class="dv">3</span><span class="op">)(</span><span class="dv">4</span><span class="op">)</span><span class="co">//通过函数引用调用Function3的curried方法</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>ret<span class="op">)</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">add</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">y</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">z</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">=</span> x <span class="op">+</span> y <span class="op">+</span> z</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">P2</span>, <span class="dt">P3</span>, <span class="dt">R</span><span class="op">&gt;</span> <span class="fu">Function3</span><span class="op">&lt;</span><span class="dt">P1</span>, <span class="dt">P2</span>, <span class="dt">P3</span>, <span class="dt">R</span><span class="op">&gt;.</span><span class="fu">curried</span><span class="op">()</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">p1</span><span class="op">:</span> <span class="dt">P1</span><span class="op">)</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">p2</span><span class="op">:</span> <span class="dt">P2</span><span class="op">)</span> <span class="op">=</span> <span class="kw">fun</span><span class="op">(</span><span class="va">p3</span><span class="op">:</span> <span class="dt">P3</span><span class="op">)</span> <span class="op">=</span> <span class="kw">this</span><span class="op">(</span>p1<span class="op">,</span> p2<span class="op">,</span> p3<span class="op">)</span><span class="co">//这里的this指Function3这个接口</span></span></code></pre></div>
<p>如果函数有固定的几个参数，可以使用默认参数简化书写，也可以使用偏函数(使用柯里化后的函数，固定前几个参数，返回的函数就是偏函数)</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">add2And3</span> <span class="op">=</span> <span class="op">::</span>add<span class="op">.</span>curried<span class="op">()(</span><span class="dv">2</span><span class="op">)(</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>add2And3<span class="op">(</span><span class="dv">4</span><span class="op">))</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>add2And3<span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>println<span class="op">(</span>add2And3<span class="op">(</span><span class="dv">6</span><span class="op">))</span></span></code></pre></div>
<h3 id="尾递归优化">尾递归优化</h3>
<p>Kotlin支持通过<code>tailrec</code>关键字给尾递函数归优化，优化后会在编译时把尾递归函数展开成while循环，这样就可以避免内存溢出</p>
<p>尾递归是指递归调用在函数的最后一行且没有其他运算，这时函数在递归时就不需要保存上一次的状态</p>
<p>如，求阶乘的两种写法</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">//非尾递归，因为有乘运算</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co">//非尾递归使用tailrec修饰无效</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">fact</span><span class="op">(</span><span class="va">i</span><span class="op">:</span> <span class="dt">Long</span><span class="op">):</span> <span class="dt">Long</span><span class="op">{</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>i <span class="op">==</span> <span class="dv">1L</span><span class="op">)</span> <span class="kw">return</span> <span class="dv">1L</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> i <span class="op">*</span> fact<span class="op">(</span>i <span class="op">-</span> <span class="dv">1L</span><span class="op">)</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co">//尾递归，在最后一行递归且无其他运算</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="kw">tailrec</span> <span class="kw">fun</span> <span class="fu">fact</span><span class="op">(</span><span class="va">i</span><span class="op">:</span> <span class="dt">Long</span><span class="op">,</span> <span class="va">ret</span><span class="op">:</span> <span class="dt">Long</span> <span class="op">=</span> <span class="dv">1L</span><span class="op">):</span> <span class="dt">Long</span><span class="op">{</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>i <span class="op">==</span> <span class="dv">1L</span><span class="op">)</span> <span class="kw">return</span> ret</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fact<span class="op">(</span>i <span class="op">-</span> <span class="dv">1L</span><span class="op">,</span> ret <span class="op">*</span> i<span class="op">)</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="类与对象">类与对象</h2>
<h3 id="类的定义">类的定义</h3>
<p>类名后面的是默认构造器，其中var或val修饰的会变成成员变量，没有被var或val修饰则只能在构造器或<code>init</code>块中使用，多个构造器用<code>constructor</code>，此时在主构造器里用var或val声明过的变量无需再用var或val修饰，其他构造器必须调用默认构造器</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student <span class="kw">constructor</span><span class="op">(</span><span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">sex</span><span class="op">:</span> <span class="dt">Char</span><span class="op">){</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    init <span class="op">{</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//相当于构造函数体，无论调哪个构造器，都会执行init块</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//其他构造器必须调用默认构造器，其实这里可以用默认参数实现，后面会讲</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constructor</span><span class="op">(</span>name<span class="op">:</span><span class="kw">String</span><span class="op">)</span> <span class="op">:</span> <span class="kw">this</span><span class="op">(</span>name<span class="op">,</span><span class="dv">10</span><span class="op">,</span><span class="ch">&#39;M&#39;</span><span class="op">)</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co">//如果构造器没有参数，或类没有自定义的方法，只是定义一个类，则主构造器或大括号可以省略，通常用于data class</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Myclass</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co">//如果主构造函数没有注解或可见性说明，则 constructor 关键字是可以省略的</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student2 <span class="op">(</span><span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">sex</span><span class="op">:</span> <span class="dt">Char</span><span class="op">)</span></span></code></pre></div>
<p>创建对象不需要写<code>new</code></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">stu</span><span class="op">:</span> Student <span class="op">=</span> Student<span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="dv">14</span><span class="op">,</span><span class="ch">&#39;M&#39;</span><span class="op">)</span></span></code></pre></div>
<h3 id="接口与抽象类">接口与抽象类</h3>
<p>接口和JDK8中是一致的，接口方法可以有默认实现，如果接口和抽象类有同名、同参数的且已实现的方法，子类可以通过super<父类 父接口名>的方式去指定调用哪个父类/父接口的方法，而此时子类必须重写重名的方法，若两个重名方法参数一致但返回值类型不一致，则子类无法重写（返回值不一致不能构成重裁），也就无法同时
继承/实现 方法冲突的两个 类/接口 了</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">abstract</span> <span class="kw">class</span> A<span class="op">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//抽象类中的非抽象方法是final的，子类要重写需open</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">open</span> <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(){</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;A-&gt;func1&quot;</span><span class="op">)</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> B<span class="op">{</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">property</span><span class="op">:</span> <span class="kw">Int</span> <span class="co">//abstract</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(){</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;B-&gt;func1&quot;</span><span class="op">)</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func2</span><span class="op">()</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="co">//继承的类要调其构造函数，而实现的接口不用，类与多个接口之间用逗号隔开</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">C</span><span class="op">:</span> <span class="dt">A</span><span class="op">()</span>, <span class="fu">B</span><span class="op">{</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">val</span> <span class="va">property</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">func1</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;C-&gt;func1&quot;</span><span class="op">)</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">func2</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;C-&gt;func2&quot;</span><span class="op">)</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">&lt;</span>A<span class="op">&gt;.</span>func1<span class="op">()</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">&lt;</span>B<span class="op">&gt;.</span>func1<span class="op">()</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        func1<span class="op">()</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="成员变量">成员变量</h3>
<h4 id="getset">get、set</h4>
<p>成员变量可以通过get、set方法实现访问控制，<code>field</code>只有在get和set中才能访问到</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="kw">String</span><span class="op">?</span> <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span><span class="op">(</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;set name&quot;</span><span class="op">)</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>            field <span class="op">=</span> value</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">get</span> <span class="op">{</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;get name&quot;</span><span class="op">)</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> field</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">set</span><span class="op">(</span>value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;set age&quot;</span><span class="op">)</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>            field <span class="op">=</span> value</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">get</span> <span class="op">{</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;get age&quot;</span><span class="op">)</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> field</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果只希望限制属性的读写属性，不需要做其他处理，可以直接这样写</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">setterVisibility</span><span class="op">:</span> <span class="kw">String</span> <span class="op">=</span> <span class="st">&quot;abc&quot;</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">private</span> <span class="kw">set</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="属性代理delegate类代理">属性代理(delegate)、类代理</h4>
<p>成员变量可以通过<code>by</code>关键字使用delegate(代理)，如懒加载用到的<code>lazy</code>(用于<code>val</code>)</p>
<p>对应<code>lazy</code>，<code>var</code>也可以使用<code>lateinit</code>来延迟加载，但<code>lateinit</code>不是delegate</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student<span class="op">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//一般在定义变量时就要求初始化，使用lateinit可以延迟初始化</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lateinit</span> <span class="kw">var</span> <span class="va">mName</span><span class="op">:</span> <span class="kw">String</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//只有当使用到这个成员变量时，才会在内存中初始化</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">mSex</span><span class="op">:</span> <span class="kw">Char</span> <span class="kw">by</span> lazy<span class="op">{</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        <span class="ch">&#39;M&#39;</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">setName</span><span class="op">(</span><span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">){</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>        mName <span class="op">=</span> name</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>kotlin.properties.Delegates</code>提供了很多有用的代理，而我们也可以自定义delegate，属性代理不需要任何接口的实现，但必须要提供<code>getValue</code>和<code>setValue</code>两个方法（对于<code>var</code>，要重写<code>getValue</code>和<code>setValue</code>；对于<code>val</code>，只需重写<code>getValue</code>）</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">kotlin</span><span class="op">.</span><span class="im">reflect</span><span class="op">.</span><span class="im">KProperty</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">stu</span> <span class="op">=</span> Student<span class="op">()</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>stu<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    stu<span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;小明&quot;</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>stu<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Student <span class="op">{</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="kw">String</span> <span class="kw">by</span> MyDelegate<span class="op">()</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDelegate<span class="op">{</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">mName</span><span class="op">:</span> <span class="kw">String</span><span class="op">?</span> <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">getValue</span><span class="op">(</span><span class="va">thisRef</span><span class="op">:</span> <span class="dt">Student</span><span class="op">,</span> <span class="va">property</span><span class="op">:</span> <span class="dt">KProperty</span>&lt;*&gt;<span class="op">):</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> mName<span class="op">?:</span><span class="st">&quot;无名氏&quot;</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">setValue</span><span class="op">(</span><span class="va">thisRef</span><span class="op">:</span> <span class="dt">Student</span><span class="op">,</span> <span class="va">property</span><span class="op">:</span> <span class="dt">KProperty</span>&lt;*&gt;<span class="op">,</span> <span class="va">value</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>        mName <span class="op">=</span> value</span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>同样，类也可以有代理</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> Base <span class="op">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">print</span><span class="op">()</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="fu">BaseImpl</span><span class="op">(</span><span class="kw">val</span> <span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Base</span> <span class="op">{</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">print</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Derived<span class="op">(</span><span class="va">b</span><span class="op">:</span> <span class="dt">Base</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Base</span> <span class="kw">by</span> b</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">b</span> <span class="op">=</span> BaseImpl<span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    Derived<span class="op">(</span>b<span class="op">).</span>print<span class="op">()</span><span class="co">//Derived的print由代理对象BaseImpl提供</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="继承">继承</h3>
<p>所有类都继承自<code>Any</code>，相当于JAVA的<code>Object</code></p>
<p>要使类可继承，需要添加<code>open</code>关键字(否则默认是<code>final</code>的)，同样，要使属性、方法可重写，也需要添加<code>open</code>关键字（接口、接口方法、抽象类、抽象类的抽象方法默认是<code>open</code>的），而且属性、方法的重写必须添加override关键字</p>
<p>继承使用<code>默认构造器:父类构造器</code>的形式</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> Person<span class="op">(</span><span class="kw">open</span> <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">open</span> <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">){</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">open</span> <span class="kw">fun</span> <span class="fu">speak</span><span class="op">(){</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;speak&quot;</span><span class="op">)</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Man<span class="op">(</span><span class="kw">override</span> <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">override</span> <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span><span class="dt">Person</span><span class="op">(</span><span class="va">name</span><span class="op">,</span> <span class="va">age</span><span class="op">){</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">speak</span><span class="op">(){</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;man speak&quot;</span><span class="op">)</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>和JAVA不同，方法默认是<code>public的</code>，要更改方法的可见性，和JAVA一样，可以使用<code>private</code>、<code>protected</code>、<code>public</code>，除此以外，Kotlin还有<code>internal</code>，可见范围是module内可见</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person<span class="op">(</span><span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span><span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">){</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">speak</span><span class="op">(){}</span><span class="co">//默认为public</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">fun</span> <span class="fu">walk</span><span class="op">(){}</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="kw">fun</span> <span class="fu">eat</span><span class="op">(){}</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">internal</span> <span class="kw">fun</span> <span class="fu">sleep</span><span class="op">(){}</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="方法重裁">方法重裁</h3>
<p>前面提到过，方法可以有具名参数、变长参数、默认参数，而方法重裁一般可以通过默认参数来实现，但由于JAVA不支持默认参数，要想在JAVA中使用Kotlin定义的通过默认参数实现方法重裁的函数，需添加<code>@JvmOverloads</code>注解</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OverLoadTest <span class="op">{</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JvmOverLoads</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func1</span><span class="op">(</span><span class="va">num</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="va">str</span><span class="op">:</span> <span class="dt">String</span><span class="op">=</span><span class="st">&quot;&quot;</span><span class="op">)</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在JAVA中调用</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>OverLoadTest test <span class="op">=</span> <span class="kw">new</span> <span class="fu">OverLoadTest</span><span class="op">();</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">func1</span><span class="op">()</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">func1</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>test<span class="op">.</span><span class="fu">func1</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="st">&quot;aaa&quot;</span><span class="op">)</span></span></code></pre></div>
<h3 id="扩展">扩展</h3>
<h4 id="扩展函数">扩展函数</h4>
<p>可以使用<code>类名.方法名</code>的形式在类的外部给类添加函数</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User<span class="op">(</span><span class="kw">var</span> <span class="va">name</span><span class="op">:</span><span class="dt">String</span><span class="op">){}</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co">//扩展函数，在扩展函数里也可以使用this</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">User</span><span class="op">.</span><span class="fu">print</span><span class="op">(){</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;用户名 </span><span class="ss">${</span><span class="kw">this</span><span class="op">.</span>name<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">arg</span><span class="op">:</span><span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">){</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">user</span> <span class="op">=</span> User<span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">)</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    user<span class="op">.</span>print<span class="op">()</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>扩展函数是动态解析的</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> A</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> B <span class="op">:</span> <span class="dt">A</span><span class="op">()</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">A</span><span class="op">.</span><span class="fu">foo</span><span class="op">()</span> <span class="op">=</span> <span class="st">&quot;a&quot;</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">B</span><span class="op">.</span><span class="fu">foo</span><span class="op">()</span> <span class="op">=</span> <span class="st">&quot;b&quot;</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">printFoo</span><span class="op">(</span><span class="va">a</span><span class="op">:</span> <span class="dt">A</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>a<span class="op">.</span>foo<span class="op">())</span><span class="co">//扩展函数由发起函数调用的表达式的类型决定的，无论传入的a是A还是A的子类，都调用的是A的foo()</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    printFoo<span class="op">(</span>B<span class="op">())</span><span class="co">//a</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果扩展函数与类中的函数重名，则调类中的函数</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A <span class="op">{</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">foo</span><span class="op">()</span> <span class="op">=</span> println<span class="op">(</span><span class="st">&quot;member&quot;</span><span class="op">)</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">A</span><span class="op">.</span><span class="fu">foo</span><span class="op">()</span> <span class="op">=</span> println<span class="op">(</span><span class="st">&quot;extension&quot;</span><span class="op">)</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    A<span class="op">().</span>foo<span class="op">()</span><span class="co">//打印&quot;member&quot;</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>扩展函数中的<code>this</code>指扩展的类，且扩展函数可以扩展可空类型，这时对空类型的检查在扩展函数中完成，调用时无需进行判空</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">Any</span>?<span class="op">.</span><span class="fu">toString</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">this</span> <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="kw">return</span> <span class="st">&quot;null&quot;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 在空检查之后，this被自动转为非空类型，因此 toString() 可以被解析到任何类的成员函数中</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> toString<span class="op">()</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="扩展lambda">扩展Lambda</h4>
<p>当Lambda表达式作为参数传入函数中时，可以指定该Lambda表达式的接收者</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">//声明Lambda的接收者为StringBuilder，且Lambda的类型为()-&gt;Unit</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">kotlinDSL</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">StringBuilder</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>)<span class="op">{</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//block需要一个类型为StringBuilder的接收者，通过invoke来给它创建接收者</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//如果没有创建接受者，Lambda表达式就不会执行</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    block<span class="op">(</span>StringBuilder<span class="op">(</span><span class="st">&quot;Kotlin&quot;</span><span class="op">))</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        kotlinDSL <span class="op">{</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>            append<span class="op">(</span><span class="st">&quot; DSL&quot;</span><span class="op">)</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">//this就是block通过invoke创建的那个StringBuilder</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="kw">this</span><span class="op">)</span><span class="co">//stringBuilder.toString()</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">//也可以通过隐式标签指定用哪个this</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>this<span class="at">@kotlinDSL</span><span class="op">)</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>this<span class="at">@MyClass</span><span class="op">)</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    MyClass<span class="op">().</span>func<span class="op">()</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>输出</p>
<pre><code>Kotlin DSL</code></pre>
<p>当类的扩展方法与方法中的扩展Lambda的接收者一致时，不需要创建接收者，此时接收者就是扩展的类</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass<span class="op">(</span><span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> MyClass.changeName<span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">MyClass</span>.(<span class="op">)</span> -&gt; String)<span class="op">:</span> <span class="dt">MyClass</span> <span class="op">{</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//这里的this指扩展的类(MyClass)</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>name <span class="op">=</span> block<span class="op">()</span><span class="co">//执行Lambda表达式，获取结果</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">this</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">myClass</span> <span class="op">=</span> MyClass<span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">)</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    myClass<span class="op">.</span>changeName <span class="op">{</span> <span class="st">&quot;小红&quot;</span> <span class="op">}</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>myClass<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="扩展属性">扩展属性</h4>
<p>对于属性的拓展，无法在get、set中访问<code>field</code>字段，一般来说拓展属性的意义不大</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> &lt;<span class="va">T</span><span class="op">&gt;</span> List<span class="op">&lt;</span>T<span class="op">&gt;.</span>lastIndex<span class="op">:</span>  <span class="kw">Int</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">get</span><span class="op">()</span> <span class="op">=</span> size<span class="op">-</span><span class="dv">1</span></span></code></pre></div>
<h4 id="扩展域">扩展域</h4>
<p>扩展域：</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> <span class="im">foo</span><span class="op">.</span><span class="im">bar</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">Baz</span><span class="op">.</span><span class="fu">goo</span><span class="op">()</span> <span class="op">{</span>  <span class="op">}</span></span></code></pre></div>
<p>为了在除声明的包外使用这个扩展，我们需要在 import 时导入</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> <span class="im">com</span><span class="op">.</span><span class="im">example</span>,<span class="im">usage</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">foo</span><span class="op">.</span><span class="im">bar</span><span class="op">.</span><span class="im">goo</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="co">//或者</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co">/*import foo.bar.*</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co">fun usage(baz: Baz) {</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co">    baz.goo()</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co">}</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span></code></pre></div>
<h3 id="泛型">泛型</h3>
<h4 id="泛型的定义">泛型的定义</h4>
<p>跟JAVA类似，有泛型类、泛型接口，泛型函数，带泛型的属性，也可以在扩展函数、扩展属性、包级函数中使用泛型</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> List<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StringList <span class="op">:</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">&gt;</span> <span class="co">// 具体类型实参</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyList<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">:</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span>       <span class="co">// 泛型类型形参</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span>  <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">slice</span><span class="op">(</span><span class="va">incides</span><span class="op">:</span><span class="dt">IntRange</span><span class="op">):</span><span class="dt">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">penultimate</span><span class="op">:</span> <span class="dt">T</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">get</span><span class="op">()</span> <span class="op">=</span> <span class="kw">this</span><span class="op">[</span>size <span class="op">-</span> <span class="dv">1</span><span class="op">]</span></span></code></pre></div>
<h4 id="泛型约束">泛型约束</h4>
<p>也有泛型约束，上界使用<code>&lt;T: 类名&gt;</code>，规定T必须是所给的类的子类，也可以有多个约束，使用<code>where 泛型占位符:类1, 泛型占位符:类2, ...</code>，相当于JAVA的<code>&lt;泛型占位符 extends 类1 &amp; 类2&gt;</code></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span> <span class="op">:</span> <span class="dt">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;&gt;</span> <span class="fu">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">sum1</span><span class="op">(){</span>  <span class="op">}</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co">//相当于JAVA中的&lt;T extends Number &amp; Appendable&gt;)</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">List</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;.</span><span class="fu">sum2</span><span class="op">():</span><span class="dt">T</span> <span class="kw">where</span> <span class="fu">T</span> <span class="op">:</span> <span class="dt">Number</span>, <span class="fu">T</span><span class="op">:</span> <span class="dt">Appendable</span><span class="op">{</span>  <span class="op">}</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co">//如果不指定泛型，上界默认为Any?，如果不想类型可空，应用Any做上界</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass<span class="op">&lt;</span><span class="dt">T</span><span class="op">:</span> <span class="dt">Any</span><span class="op">&gt;</span></span></code></pre></div>
<h4 id="泛型实化">泛型实化</h4>
<p>JAVA中有泛型擦除，而Kotlin中可以通过<code>inline</code>函数实现类型实参，不被擦除（Kotlin称实化）</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">//因为泛型会被擦除，下面的代码无法通过编译</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co">//fun &lt;T&gt; isA(value: Any) = value is T   // 不能确定T</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co">//使用inline后，会把每一个的函数调用换成实际的代码调用，Lambda也是一样，并结合 reified 标记类型参数，上面的 value is T 就可以通过编译了</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="kw">reified</span> <span class="dt">T</span><span class="op">&gt;</span> <span class="fu">isA</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">Any</span><span class="op">)</span> <span class="op">=</span> value <span class="kw">is</span> T</span></code></pre></div>
<h4 id="星投影">星投影</h4>
<p>泛型类在初始化时必须指定泛型，如果不想指定泛型，可以使用<code>*</code>(星投影)</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">list</span> <span class="op">=</span> listOf<span class="op">(</span><span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co">//判断一个变量是否是列表</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span><span class="op">(</span>list <span class="kw">is</span> List<span class="op">&lt;*&gt;)</span> <span class="op">{</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 星投影，类似Java的 &lt;?&gt;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>和JAVA不同，泛型可以用在类型转换中</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">intList</span> <span class="op">=</span> list <span class="kw">as</span><span class="op">?</span> kotlin<span class="op">.</span>collections<span class="op">.</span>List<span class="op">&lt;</span><span class="kw">Int</span><span class="op">&gt;</span> <span class="op">?</span> <span class="op">:</span> <span class="kw">throw</span> IllegalArgumentException<span class="op">(</span><span class="st">&quot;转换失败&quot;</span><span class="op">)</span></span></code></pre></div>
<h4 id="协变与逆变">协变与逆变</h4>
<p>使用<code>out</code>和<code>in</code>来声明泛型是可协变/逆变的</p>
<p><strong>协变（covariant：Foo<父类> =&gt; Foo<子类>）</strong></p>
<p>协变为父类泛型型变为具体子类，Kotlin 提供 <strong>in</strong>
关键字，来代替 Java
中<code>&lt;? extends E&gt;</code>的通配符语法，同时为了解决Java中泛型型变类型擦除中，所引起的类型转换安全，Kotlin
采用了 C#
的策略，即<strong>协变类型作为消费者，只能读取而不能写入</strong></p>
<p><strong>逆变（contravariance：Foo<子类> =&gt;
Foo<父类>）</strong></p>
<p>逆变为子类型型变为具体父类，Kotlin 提供 out 关键字，来代替 Java
中<code>&lt;? super E&gt;</code> 的通配符语法，同样采用了 C#
的策略，<strong>逆变类型作为生产者，只能写入而不能读取</strong></p>
<h3 id="单例模式object">单例模式(object)</h3>
<p>使用<code>object</code>修饰的类是单例的，实现方式为饿汉式，其方法的调用和JAVA中静态函数调用方式一样，但它不是定义静态类，只是和JAVA中静态函数调用的写法一样而已</p>
<p><code>object</code>在局部域内使用没有声明单例对象的语义，在局部域内使用<code>object</code>关键字表示创建匿名内部类</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> DriverManager<span class="op">{</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">connect</span><span class="op">(</span><span class="va">str</span><span class="op">:</span> <span class="dt">String</span><span class="op">){</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>str<span class="op">)</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    DriverManager<span class="op">.</span>connect<span class="op">(</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span><span class="op">)</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>其Kotlin字节码反编译成JAVA后的代码</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> <span class="bu">DriverManager</span> <span class="op">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">DriverManager</span> INSTANCE<span class="op">;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">public</span> <span class="dt">final</span> <span class="dt">void</span> <span class="fu">connect</span><span class="op">(</span><span class="at">@NotNull</span> <span class="bu">String</span> str<span class="op">)</span> <span class="op">{</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>      Intrinsics<span class="op">.</span><span class="fu">checkParameterIsNotNull</span><span class="op">(</span>str<span class="op">,</span> <span class="st">&quot;str&quot;</span><span class="op">);</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>      <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>str<span class="op">);</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>   <span class="dt">static</span> <span class="op">{</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>      <span class="bu">DriverManager</span> var0 <span class="op">=</span> <span class="kw">new</span> <span class="bu">DriverManager</span><span class="op">();</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>      INSTANCE <span class="op">=</span> var0<span class="op">;</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>在JAVA中使用该类通过INSTANCE获取实例（由此可以看出其方法并非真正的静态），通过实例掉对应方法</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="bu">DriverManager</span> dm <span class="op">=</span> <span class="bu">DriverManager</span><span class="op">.</span><span class="fu">INSTANCE</span><span class="op">;</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>dm<span class="op">.</span><span class="fu">connect</span><span class="op">(</span><span class="st">&quot;com.mysql.jdbc.Driver&quot;</span><span class="op">)</span></span></code></pre></div>
<h3 id="伴生对象companion-object">伴生对象(companion object)</h3>
<p>在Kotlin中没有static关键字，因为对于工具类的函数，在Kotlin中可以转化为包级函数，但如果要声明静态变量或静态函数，可以使用伴生对象(<code>companion object</code>)（虽然object可以实现静态调用的写法，但其全部方法、变量都要写成JAVA中静态调用的形式的，而<code>companion object</code>可以实现部分方法、变量静态；而且<code>companion object</code>是在对应的类加载时初始化的，和Java的静态初始化是对应的）</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DriverManager <span class="op">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">companion</span> <span class="kw">object</span> <span class="op">{</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">//companion object块内的方法及变量可以静态调用</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">//JvmField使在JAVA里可以像静态变量那样调用，否则在JAVA里要通过DriverManager.Companion.getMysqlUrl()的方式获取</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">@JvmField</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">mysqlUrl</span> <span class="op">=</span> <span class="st">&quot;com.mysql.jdbc.Driver&quot;</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">@JvmField</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">sqlServerUrl</span> <span class="op">=</span> <span class="st">&quot;com.microsoft.sqlserver.jdbc.SQLServerDriver&quot;</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//JvmStatic使在JAVA里可以像静态函数那样调用，否则在JAVA中要通过DriverManager.Companion.connect的方式调用</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">@JvmStatic</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fun</span> <span class="fu">connect</span><span class="op">(</span><span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//其他函数要通过对象调用</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">otherfun</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;otherfun&quot;</span><span class="op">)</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    DriverManager<span class="op">.</span>connect<span class="op">(</span>DriverManager<span class="op">.</span>mysqlUrl<span class="op">)</span></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">dm</span> <span class="op">=</span> DriverManager<span class="op">()</span></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a>    dm<span class="op">.</span>otherfun<span class="op">()</span></span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="内部类inner-class">内部类(inner class)</h3>
<h4 id="静态与非静态内部类">静态与非静态内部类</h4>
<p>Kotlin中，内部类默认是静态的，如果想定义非静态的内部类，可以通过<code>inner</code>关键字实现，要访问外部类名字冲突的函数/变量，可以使用<code>this@Outter</code>（同理有<code>this@Inner</code>）</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> A<span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">num</span> <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">inner</span> <span class="kw">class</span> B<span class="op">{</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">num</span> <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fun</span> <span class="fu">funB1</span><span class="op">(){</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;funB1 </span><span class="ss">${</span>this<span class="at">@A</span><span class="op">.</span>num<span class="ss">}</span><span class="st"> </span><span class="ss">${</span>this<span class="at">@B</span><span class="op">.</span>num<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> C<span class="op">{</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fun</span> <span class="fu">funC1</span><span class="op">(){</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;funC1&quot;</span><span class="op">)</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">b</span> <span class="op">=</span> A<span class="op">().</span>B<span class="op">()</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">c</span> <span class="op">=</span> A<span class="op">.</span>C<span class="op">()</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="匿名内部类">匿名内部类</h4>
<p>匿名内部类使用<code>object:父类构造函数,接口1,接口2,...</code>，可以在继承类的同时实现接口，这点是在JAVA中做不到的</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> B<span class="op">{</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func</span><span class="op">()</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> <span class="fu">A</span><span class="op">(</span><span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">){</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">a</span><span class="op">:</span> A <span class="op">=</span> <span class="kw">object</span><span class="op">:</span><span class="dt">A</span><span class="op">(</span>&quot;<span class="va">aaa</span>&quot;<span class="op">),</span> <span class="dt">B</span><span class="op">{</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>有时候我们只是需要一个没有父类的对象，我们可以这样写：</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">position</span> <span class="op">=</span> <span class="kw">object</span> <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">x</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">y</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="闭包">闭包</h4>
<p>和JAVA不同，Kotlin支持闭包</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">interface</span> B<span class="op">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">func</span><span class="op">()</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> <span class="fu">A</span><span class="op">(</span><span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">getB</span><span class="op">():</span> <span class="dt">B</span><span class="op">{</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">num</span><span class="op">:</span> <span class="kw">Int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">object</span><span class="op">:</span><span class="dt">A</span><span class="op">(</span>&quot;<span class="va">aaa</span>&quot;<span class="op">),</span> <span class="dt">B</span><span class="op">{</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(++</span>num<span class="op">)</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">a</span><span class="op">:</span> B <span class="op">=</span> getB<span class="op">()</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>func<span class="op">()</span><span class="co">//1</span></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>    a<span class="op">.</span>func<span class="op">()</span><span class="co">//2</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="函数式接口">函数式接口</h4>
<p>和JDK8一样，如果一个接口是函数式接口，则可以用Lambda表达式创建，不需要使用匿名内部类（Kotlin调用JAVA时，Kotlin支持JAVA的<code>FunctionalInterface</code>写法，但Kotlin自身没有<code>FunctionalInterface</code>的写法，只能定义两个重裁的方法或使用别名(把Lambda类型的别名起的和类名一样)）</p>
<h3 id="数据类data-class">数据类(data class)</h3>
<p>数据类的出现是为了简化JavaBean，一个用<code>data</code>修饰的类会对构造函数中用<code>var</code>或<code>val</code>修饰的参数创建get、set方法(在JAVA中调用get、set，在Kotlin中直接调属性)，以及会重写toString、equals、hashCode、copy、componentN等方法</p>
<p>数据类有如下限制：</p>
<ul>
<li>主构造函数至少包含一个参数</li>
<li>参数必须标识为<code>val</code>或者<code>var</code></li>
<li>不能为<code>abstract</code>,<code>open</code>,<code>sealed</code>或者<code>inner</code></li>
<li>不能继承其它类 (但可以实现接口)</li>
</ul>
<p>和JavaBean不同的是，data class没有默认的空构造器，且data
class默认为final类型，但可以通过安装<code>allOpen</code>、<code>noArg</code>插件更改生成的字节码</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="kw">class</span> Person<span class="op">(</span><span class="kw">val</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="kw">var</span> <span class="va">age</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> main<span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">p</span> <span class="op">=</span> Person<span class="op">(</span><span class="st">&quot;小明&quot;</span><span class="op">,</span><span class="dv">14</span><span class="op">)</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>p<span class="op">.</span>age<span class="op">)</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>p<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>p<span class="op">.</span>toString<span class="op">())</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>p<span class="op">.</span>hashCode<span class="op">())</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> (<span class="va">name</span><span class="op">,</span> age<span class="op">)</span> <span class="op">=</span> Person<span class="op">(</span><span class="st">&quot;小红&quot;</span><span class="op">,</span> <span class="dv">13</span><span class="op">)</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="枚举enum-class">枚举(enum class)</h3>
<p>每个枚举常量只有一个实例，用法和JAVA类似</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> <span class="kw">class</span> Color<span class="op">(</span><span class="kw">val</span> <span class="va">rgb</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    RED<span class="op">(</span><span class="bn">0xFF0000</span><span class="op">){</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">printSelf</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;RED&quot;</span><span class="op">)</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    GREEN<span class="op">(</span><span class="bn">0x00FF00</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">printSelf</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;GREEN&quot;</span><span class="op">)</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">},</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    BLUE<span class="op">(</span><span class="bn">0x0000FF</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">printSelf</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span><span class="st">&quot;BLUE&quot;</span><span class="op">)</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span><span class="co">//枚举成员与函数之间必须用分号隔开</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">printValues</span><span class="op">(){</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span><span class="st">&quot;RED GREEN BLUE&quot;</span><span class="op">)</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">abstract</span> <span class="kw">fun</span> <span class="fu">printSelf</span><span class="op">()</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span><span class="op">(</span>c <span class="kw">in</span> Color<span class="op">.</span>values<span class="op">()){</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>c<span class="op">)</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="密封类sealed-class">密封类(sealed class)</h3>
<p>密封类可以限制类的子类有限（好处在于写when的时候不用写else），密封类要求其子类与其定义在同一个文件中</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">class</span> Operation <span class="op">{</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Add<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Substract<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Multiply<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Divide<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>或者</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">class</span> Operation <span class="op">{</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Add<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Substract<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Multiply<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Divide<span class="op">(</span><span class="kw">val</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">:</span> <span class="dt">Operation</span><span class="op">()</span></span></code></pre></div>
<h3 id="注解">注解</h3>
<p>Kotlin的注解在使用上完全兼容JAVA的注解</p>
<p>声明</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">annotation</span> <span class="kw">class</span> myanno</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="co">//也可以有构造函数</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a><span class="kw">annotation</span> <span class="kw">class</span> special<span class="op">(</span><span class="kw">val</span> <span class="va">why</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span></span></code></pre></div>
<p>使用</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="at">@myanno</span> <span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@myanno</span> <span class="kw">fun</span> <span class="fu">func</span><span class="op">(</span>@<span class="va">myanno</span> <span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span><span class="at">@myanno</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="co">//有构造函数时</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="at">@special</span><span class="op">(</span><span class="st">&quot;example&quot;</span><span class="op">)</span> <span class="kw">class</span> MyClass <span class="op">{}</span></span></code></pre></div>
<p>在多数情形中<code>@</code>标识是可选的。只有在注解表达式或本地声明中才必须：</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>myanno <span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    myanno <span class="kw">fun</span> <span class="fu">func</span><span class="op">(</span><span class="va">myanno</span> <span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">):</span> <span class="dt">Int</span> <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span><span class="at">@myanno</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>如果要给构造函数注解，就需要在构造函数声明时添加 constructor
关键字，并且需要在前面添加注解</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass @inject <span class="kw">constructor</span><span class="op">(</span><span class="va">num</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span></span></code></pre></div>
<p>也可以注解属性访问者</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyClass <span class="op">{</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">num</span><span class="op">:</span> <span class="kw">Int</span><span class="op">?=</span><span class="kw">null</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">@inject</span> <span class="kw">set</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>也可以给Lambda表达式加注解（区别于标签，标签的<code>@</code>在后面），这将会应用到
lambda 生成的<code>invoke()</code>方法</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> <span class="va">f</span> <span class="op">=</span> <span class="at">@myanno</span> <span class="op">{</span> x<span class="op">:</span> <span class="kw">Int</span> <span class="op">-&gt;</span> x <span class="op">+</span> <span class="dv">10</span> <span class="op">}</span></span></code></pre></div>
<h2 id="dsl">DSL</h2>
<p>通过DSL，Kotlin可以实现其他语言的部分写法，比如写如下的Kotlin风格的html</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>html <span class="op">{</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>    head <span class="op">{</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>        charset <span class="op">=</span> <span class="st">&quot;utf-8&quot;</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    body <span class="op">{</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>        h1 <span class="op">{</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">+</span><span class="st">&quot;标题&quot;</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>html其实是一个参数为Lambda的函数，所以小括号可以省略，head、body同理，charset其实是一个成员变量，由于head的Lambda使用了扩展Lambda，所以里面的this就是指html函数对应的HtmlNode类；真正封装数据的是TagNode类，里面有properties和children两个成员变量，像charset这种成员变量要添加到properties这个map中是通过delegate实现的</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">StringBuilder</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">kotlin</span><span class="op">.</span><span class="im">reflect</span><span class="op">.</span><span class="im">KProperty</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//使用我们自己的dsl</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">str</span> <span class="op">=</span> html <span class="op">{</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>        head <span class="op">{</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>            charset <span class="op">=</span> <span class="st">&quot;utf-8&quot;</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>        body <span class="op">{</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>            h1 <span class="op">{</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span><span class="st">&quot;标题&quot;</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>render<span class="op">()</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>str<span class="op">)</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a><span class="co">//四个参数为Lambda的函数，分别对应html的标签(html、head、body、h1)，可以实现&quot;html{  }&quot;的写法</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">html</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">HtmlNode</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>)<span class="op">:</span> <span class="dt">HtmlNode</span> <span class="op">{</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> HtmlNode<span class="op">().</span>apply <span class="op">{</span> block<span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a><span class="co">//把子节点加到HtmlNode中，要访问HtmlNode的children成员变量，所以要给HtmlNode添加扩展方法</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a><span class="co">//要像使用HeadNode的charset属性，就要把Lambda的接收者指定为HeadNode</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">HtmlNode</span><span class="op">.</span><span class="fu">head</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">HeadNode</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>) <span class="op">{</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">//这里两个this是不同的，加标签以区分两个this</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>    this<span class="at">@head</span><span class="op">.</span>children<span class="op">.</span>add<span class="op">(</span>HeadNode<span class="op">().</span>apply <span class="op">{</span> block<span class="op">(</span>this<span class="at">@apply</span><span class="op">)</span> <span class="op">})</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">HtmlNode</span><span class="op">.</span><span class="fu">body</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">BodyNode</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>) <span class="op">{</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">//不加标签其实也一样，但可读性不好</span></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span>children<span class="op">.</span>add<span class="op">(</span>BodyNode<span class="op">().</span>apply <span class="op">{</span> block<span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">})</span></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">BodyNode</span><span class="op">.</span><span class="fu">h1</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">H1Node</span>.(<span class="op">)</span> -&gt; <span class="fu">Unit</span>) <span class="op">{</span></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">//前面的this也可以不写，但后面的this不写就无法使用H1Node的运算符重裁了</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>    children<span class="op">.</span>add<span class="op">(</span>H1Node<span class="op">().</span>apply <span class="op">{</span> block<span class="op">(</span><span class="kw">this</span><span class="op">)</span> <span class="op">})</span></span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a><span class="co">//html标签的基类</span></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a><span class="kw">open</span> <span class="kw">class</span> TagNode<span class="op">(</span><span class="kw">open</span> <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">properties</span> <span class="op">=</span> HashMap<span class="op">&lt;</span><span class="kw">String</span><span class="op">,</span> Any<span class="op">&gt;()</span></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">children</span> <span class="op">=</span> ArrayList<span class="op">&lt;</span>TagNode<span class="op">&gt;()</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">//打印节点对应的html字符串的函数</span></span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">open</span> <span class="kw">fun</span> <span class="fu">render</span><span class="op">():</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> StringBuilder<span class="op">()</span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>append<span class="op">(</span><span class="st">&quot;&lt;</span><span class="ss">$name</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>apply <span class="op">{</span></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">((</span>key<span class="op">,</span> value<span class="op">)</span> <span class="kw">in</span> properties<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>                        append<span class="op">(</span><span class="st">&quot; </span><span class="ss">$key</span><span class="st">=</span><span class="sc">\&quot;</span><span class="ss">$value</span><span class="sc">\&quot;</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>append<span class="op">(</span><span class="st">&quot;&gt;&quot;</span><span class="op">)</span></span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>apply <span class="op">{</span></span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span>child <span class="kw">in</span> children<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>                        append<span class="op">(</span>child<span class="op">.</span>render<span class="op">())</span></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">}.</span>append<span class="op">(</span><span class="st">&quot;&lt;/</span><span class="ss">$name</span><span class="st">&gt;&quot;</span><span class="op">).</span>toString<span class="op">()</span></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a><span class="co">//每个具体的html标签对应的类，在各个类中可以有自己的属性</span></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HtmlNode <span class="op">:</span> <span class="dt">TagNode</span><span class="op">(</span>&quot;<span class="va">html</span>&quot;<span class="op">)</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HeadNode <span class="op">:</span> <span class="dt">TagNode</span><span class="op">(</span>&quot;<span class="va">head</span>&quot;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">//属性最后要添加到properties这个map中，通过delegate实现</span></span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">charset</span> <span class="kw">by</span> MyDelegate<span class="op">(</span>properties<span class="op">)</span></span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BodyNode <span class="op">:</span> <span class="dt">TagNode</span><span class="op">(</span>&quot;<span class="va">body</span>&quot;<span class="op">)</span></span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StringNode<span class="op">(</span><span class="kw">override</span> <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">:</span> <span class="dt">TagNode</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">render</span><span class="op">():</span> <span class="dt">String</span> <span class="op">=</span> name</span>
<span id="cb118-76"><a href="#cb118-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-77"><a href="#cb118-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-78"><a href="#cb118-78" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> H1Node <span class="op">:</span> <span class="dt">TagNode</span><span class="op">(</span>&quot;<span class="va">h1</span>&quot;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-79"><a href="#cb118-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">String</span><span class="op">.</span><span class="fu">unaryPlus</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb118-80"><a href="#cb118-80" aria-hidden="true" tabindex="-1"></a>        children<span class="op">.</span>add<span class="op">(</span>StringNode<span class="op">(</span><span class="kw">this</span><span class="op">))</span></span>
<span id="cb118-81"><a href="#cb118-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-82"><a href="#cb118-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb118-83"><a href="#cb118-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-84"><a href="#cb118-84" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDelegate<span class="op">(</span><span class="kw">var</span> <span class="va">properties</span><span class="op">:</span> <span class="dt">HashMap</span>&lt;<span class="va">String</span><span class="op">,</span> <span class="va">Any</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-85"><a href="#cb118-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">getValue</span><span class="op">(</span><span class="va">headNode</span><span class="op">:</span> <span class="dt">HeadNode</span><span class="op">,</span> <span class="va">property</span><span class="op">:</span> <span class="dt">KProperty</span>&lt;*&gt;<span class="op">):</span> <span class="dt">Any</span> <span class="op">{</span></span>
<span id="cb118-86"><a href="#cb118-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> properties<span class="op">[</span>property<span class="op">.</span>name<span class="op">]</span> <span class="op">?:</span> <span class="st">&quot;&quot;</span></span>
<span id="cb118-87"><a href="#cb118-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-88"><a href="#cb118-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-89"><a href="#cb118-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">operator</span> <span class="kw">fun</span> <span class="fu">setValue</span><span class="op">(</span><span class="va">headNode</span><span class="op">:</span> <span class="dt">HeadNode</span><span class="op">,</span> <span class="va">property</span><span class="op">:</span> <span class="dt">KProperty</span>&lt;*&gt;<span class="op">,</span> <span class="va">value</span><span class="op">:</span> <span class="dt">Any</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb118-90"><a href="#cb118-90" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">[</span>property<span class="op">.</span>name<span class="op">]</span> <span class="op">=</span> value</span>
<span id="cb118-91"><a href="#cb118-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-92"><a href="#cb118-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-93"><a href="#cb118-93" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>以上只是一个demo，官方有很多完备DSL可以参考官方项目<a href="https://github.com/Kotlin/kotlinx.html">kotlinx.html</a></p>
<h2 id="协程coroutines">协程(Coroutines)</h2>
<p>传统的线程的运行是抢占式的，什么时候运行哪个线程是由系统决定的，我们无法预知，而协程是可以<code>yield</code>(谦让)的，它给线程运行提供了暂停(<code>suspend</code>，挂起)的能力，线程可以主动把执行权让出来，从而我们可以控制协程间的运行顺序，协程常用到的几个概念</p>
<ul>
<li><p>CoroutineContext:
协程的上下文，类似android的context的概念，负责管理协程，一般来说，每个模块会用不同的<code>CoroutineContext</code>，如果把多个模块整合起来就要用到多个<code>CoroutineContext</code>，这时就可以通过设定的key来区分不同的<code>CoroutineContext</code>；如果不需要用到上下文，可以使用<code>EmptyCoroutineContext</code></p></li>
<li><p>Continuation:
前面说过，协程提供了一种暂停的能力，而可继续执行才是最终的目的；<code>Continuation</code>是一个接口，
它有两个方法，一个是<code>resume</code>，它代表当前协程运行结束，程序恢复到主线程或其他协程，并把返回值返回，如果我们的程序没有任何异常，那么直接调用这个方法并传入需要返回的值；另一个是<code>resumeWithException</code>，如果我们的程序出了异常，那我们可以通过调用这个方法把异常传递出去；它还有一个需要重写的属性。就是上面提到的<code>CoroutineContext</code></p></li>
<li><p>suspend关键字:
表示要被挂起(<code>suspend</code>)的代码，用于修饰函数或Lambda，用<code>suspend</code>关键字修饰函数或Lambda只能运行在协程或其它<code>suspend</code>函数中，被<code>suspend</code>修饰的函数或Lambda可以使用<code>startCoroutine</code>或<code>createCoroutine</code>函数来启动协程</p></li>
<li><p>suspendCoroutine函数:
真正在协程中运行的代码，参数是一个Lambda表达式，该Lambda表达式为要在协程中运行的代码，函数的返回值就是通过<code>continuation.resume</code>返回的返回值</p></li>
</ul>
<h3 id="简单使用">简单使用</h3>
<p>下面是一个使用协程的例子</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">kotlin</span><span class="op">.</span><span class="im">coroutines</span><span class="op">.</span><span class="im">experimental</span><span class="op">.*</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">//启动协程(通过startCoroutine，这里通过loadImage函数进行了封装)</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    loadImage<span class="op">(</span><span class="st">&quot;127.0.0.1/img.png&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">//使用协程执行耗时操作</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> suspendCoroutine <span class="op">{</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">//这个continuation就是我们创建的那个内部类</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>ByteArray<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>requestUrl<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">[</span>ImageUrlContext<span class="op">]!!.</span>url<span class="op">))</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">//Lambda表达式的最后一行表示返回值</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>        result</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a><span class="co">//上下文，用来存放我们需要的信息</span></span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageUrlContext<span class="op">(</span><span class="kw">val</span> <span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">:</span> <span class="dt">AbstractCoroutineContextElement</span><span class="op">(</span><span class="va">ImageUrlContext</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">companion</span> <span class="kw">object</span> Key <span class="op">:</span> <span class="dt">CoroutineContext</span>.<span class="dt">Key</span><span class="op">&lt;</span><span class="dt">ImageUrlContext</span><span class="op">&gt;</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a><span class="co">//用于开启协程的函数</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">loadImage</span><span class="op">(</span><span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">block</span><span class="op">:</span> <span class="dt">suspend</span> (<span class="op">)</span> -&gt; <span class="fu">ByteArray</span>) <span class="op">{</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">continuation</span> <span class="op">=</span> <span class="kw">object</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">ByteArray</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> CoroutineContext <span class="op">=</span> ImageUrlContext<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">imageArray</span><span class="op">:</span> <span class="dt">ByteArray</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- resume: </span><span class="ss">${</span>imageArray<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>exception<span class="op">.</span>toString<span class="op">())</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>    block<span class="op">.</span>startCoroutine<span class="op">(</span>continuation<span class="op">)</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a><span class="co">//在协程中运行的耗时操作</span></span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">requestUrl</span><span class="op">(</span><span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">):</span> <span class="dt">ByteArray</span> <span class="op">{</span></span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- request url for </span><span class="ss">$url</span><span class="st">.&quot;</span><span class="op">)</span></span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">//暂时用这个模拟耗时</span></span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>    Thread<span class="op">.</span>sleep<span class="op">(</span><span class="dv">1000</span><span class="op">)</span></span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">//暂时用这个模拟获取的图片</span></span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ByteArray<span class="op">(</span><span class="dv">1024</span><span class="op">)</span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>打印</p>
<pre><code>main-- before coroutine
main-- in coroutine. Before suspend.
main-- in suspend block.
main-- request url for 127.0.0.1/img.png.
main-- after resume.
main-- in coroutine. After suspend. image size = 1024
main-- resume: 1024
main-- after coroutine</code></pre>
<p>为什么没有在子线程中运行我们的耗时操作呢？这是因为协程不知道哪些是耗时的操作，也不知道应该分为几个线程去执行我们的代码，所以我们要自己指定</p>
<h3 id="实现异步">实现异步</h3>
<p>这里使用线程池来实现异步</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">//创建一个线程池</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="kw">val</span> <span class="va">executor</span> <span class="op">=</span> Executors<span class="op">.</span>newSingleThreadScheduledExecutor <span class="op">{</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    it<span class="op">:</span> Runnable <span class="op">-&gt;</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    Thread<span class="op">(</span>it<span class="op">,</span> <span class="st">&quot;scheduler&quot;</span><span class="op">)</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    loadImage<span class="op">(</span><span class="st">&quot;127.0.0.1/img.png&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> suspendCoroutine <span class="op">{</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>ByteArray<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">//把协程加到线程池中</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>            executor<span class="op">.</span>submit <span class="op">{</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>                continuation<span class="op">.</span>resume<span class="op">(</span>requestUrl<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">[</span>ImageUrlContext<span class="op">]!!.</span>url<span class="op">))</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>                println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>shutdown<span class="op">()</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>        result</span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>此时打印</p>
<pre><code>main-- before coroutine
main-- in coroutine. Before suspend.
main-- in suspend block.
main-- after coroutine
scheduler-- request url for 127.0.0.1/img.png.
scheduler-- in coroutine. After suspend. image size = 1024
scheduler-- resume: 1024
scheduler-- after resume.</code></pre>
<p>这时，先执行<code>after coroutine</code>，然后才执行<code>request url</code>，被挂起的代码在子线程中执行了</p>
<p>但是这样一看，似乎和多线程没什么区别啊？其实区别还是有的，首先，协程是可以控制执行顺序的，其次，多个协程可以共享一个线程，当服务器高并发时，比如有1k用户连接，如果使用多线程，一个用户创建一个线程，那创建1k个线程是很大的开销，而且不是每个用户都同时需要数据传输，而如果使用协程，那我们可以使用少数用于承载用户数据传输的协程的线程，只有用户使用到数据传输时才去响应，其余时间挂起，这样对内存的消耗要比多线程少得多</p>
<h3 id="封装">封装</h3>
<h4 id="step1">step1</h4>
<p>首先把异步代码封装一下</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co">//伪代码，模拟需要在主线程更新UI</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="kw">val</span> <span class="va">imageView</span> <span class="op">=</span> ImageView<span class="op">()</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ImageView <span class="op">{</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">setBackground</span><span class="op">(</span><span class="va">imageArray</span><span class="op">:</span> <span class="dt">ByteArray</span><span class="op">)</span> <span class="op">=</span> println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- setBackground&quot;</span><span class="op">)</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a><span class="co">//----------------------------------------------</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;127.0.0.1/img.png&quot;</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>    suspend <span class="op">{</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> suspendCoroutine <span class="op">{</span> continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>ByteArray<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>            AsyncTask <span class="op">{</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">val</span> <span class="va">byteArray</span> <span class="op">=</span> requestUrl<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>byteArray<span class="op">.</span>size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//成功获取图片</span></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>                    SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>                        continuation<span class="op">.</span>resume<span class="op">(</span>byteArray<span class="op">)</span></span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span><span class="cf">else</span><span class="op">{</span></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//获取图片失败</span></span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>                    SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>                        continuation<span class="op">.</span>resumeWithException<span class="op">(</span>RuntimeException<span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">))</span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>                println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}.</span>execute<span class="op">()</span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">//在resume的时候切到了UI线程，所以这里在UI线程执行</span></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>        imageView<span class="op">.</span>setBackground<span class="op">(</span>result<span class="op">)</span><span class="co">//伪代码</span></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>        result</span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>startCoroutine<span class="op">(</span>MyContinuation<span class="op">())</span></span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AsyncTask<span class="op">(</span><span class="kw">val</span> <span class="va">block</span><span class="op">:</span> <span class="op">()</span> <span class="op">-&gt;</span> <span class="dt">Unit</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">//创建一个线程池</span></span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">executor</span> <span class="kw">by</span> lazy <span class="op">{</span></span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a>        Executors<span class="op">.</span>newCachedThreadPool<span class="op">()</span></span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">execute</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">//在线程池中执行</span></span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>execute<span class="op">(</span>block<span class="op">)</span></span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">//等待任务执行完成,然后关闭</span></span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>shutdown<span class="op">()</span></span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb123-55"><a href="#cb123-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-56"><a href="#cb123-56" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuation<span class="op">(</span><span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> <span class="dt">CoroutineContext</span> <span class="op">=</span> EmptyCoroutineContext<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">ByteArray</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb123-57"><a href="#cb123-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">ByteArray</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb123-58"><a href="#cb123-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-59"><a href="#cb123-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb123-60"><a href="#cb123-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb123-61"><a href="#cb123-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-62"><a href="#cb123-62" aria-hidden="true" tabindex="-1"></a><span class="co">//在协程中运行的耗时操作</span></span>
<span id="cb123-63"><a href="#cb123-63" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">requestUrl</span><span class="op">(</span><span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">):</span> <span class="dt">ByteArray</span> <span class="op">{</span></span>
<span id="cb123-64"><a href="#cb123-64" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- request url for </span><span class="ss">$url</span><span class="st">.&quot;</span><span class="op">)</span></span>
<span id="cb123-65"><a href="#cb123-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">//暂时用这个模拟耗时</span></span>
<span id="cb123-66"><a href="#cb123-66" aria-hidden="true" tabindex="-1"></a>    Thread<span class="op">.</span>sleep<span class="op">(</span><span class="dv">1000</span><span class="op">)</span></span>
<span id="cb123-67"><a href="#cb123-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">//暂时用这个模拟获取的图片</span></span>
<span id="cb123-68"><a href="#cb123-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> ByteArray<span class="op">(</span><span class="dv">1024</span><span class="op">)</span></span>
<span id="cb123-69"><a href="#cb123-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是这里<code>invokeLater</code>写了好多遍，所以我们希望优化一下</p>
<h4 id="step2">step2</h4>
<p>这里用到了<code>wrapper</code>(包装)的概念</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuationWrapper<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="kw">val</span> <span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> CoroutineContext <span class="op">=</span> EmptyCoroutineContext</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>value<span class="op">)</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resumeWithException<span class="op">(</span>exception<span class="op">)</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这时，<code>main</code>函数可以改成</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;127.0.0.1/img.png&quot;</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    suspend <span class="op">{</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> suspendCoroutine <span class="op">{</span> continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>ByteArray<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">//使用wrapper帮我们调SwingUtilities.invokeLater</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="va">continuationWrapper</span> <span class="op">=</span> MyContinuationWrapper<span class="op">(</span>continuation<span class="op">)</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>            AsyncTask <span class="op">{</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>                <span class="kw">val</span> <span class="va">byteArray</span> <span class="op">=</span> requestUrl<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>byteArray<span class="op">.</span>size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>                    continuationWrapper<span class="op">.</span>resume<span class="op">(</span>byteArray<span class="op">)</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>                    continuationWrapper<span class="op">.</span>resumeWithException<span class="op">(</span>RuntimeException<span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">))</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>                println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}.</span>execute<span class="op">()</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>        imageView<span class="op">.</span>setBackground<span class="op">(</span>result<span class="op">)</span><span class="co">//伪代码</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>        result</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>startCoroutine<span class="op">(</span>MyContinuation<span class="op">())</span></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是这时要定义一个<code>MyContinuationWrapper</code>，不方便，我们还希望优化一下</p>
<h4 id="step3">step3</h4>
<p>这里用到了<code>ContinuationInterceptor</code>(拦截器)的概念，我们通过拦截器帮我们创建<code>wrapper</code></p>
<div class="sourceCode" id="cb126"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">//拦截功能通过Context实现,所以Context要实现拦截器接口</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co">//我们一般会把拦截器作为Context的key（AbstractCoroutineContextElement的构造函数传入key）</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyCoroutineContext<span class="op">:</span> <span class="dt">AbstractCoroutineContextElement</span><span class="op">(</span><span class="va">ContinuationInterceptor</span><span class="op">),</span><span class="dt">ContinuationInterceptor</span><span class="op">{</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">//不同的Continuation要用不同的拦截器,如果传入的Continuation用的拦截器不是MyCoroutineContext,则要调它的拦截器对应的拦截方法</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">interceptContinuation</span><span class="op">(</span><span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">):</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> MyContinuationWrapper<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">.</span>fold<span class="op">(</span>continuation<span class="op">)</span> <span class="op">{</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">//cont:Continuation，element:Continuation的拦截器</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>            cont<span class="op">,</span> element <span class="op">-&gt;</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>element <span class="op">!=</span> this<span class="at">@MyCoroutineContext</span> <span class="op">&amp;&amp;</span> element <span class="kw">is</span> ContinuationInterceptor<span class="op">)</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>                element<span class="op">.</span>interceptContinuation<span class="op">(</span>continuation<span class="op">)</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> cont</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这时，我们要把上下文设置为<code>MyCoroutineContext</code>，由于上下文有拦截器的功能，所以它可以帮我们创建<code>wrapper</code></p>
<div class="sourceCode" id="cb127"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;127.0.0.1/img.png&quot;</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    suspend <span class="op">{</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> suspendCoroutine <span class="op">{</span> continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>ByteArray<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>            AsyncTask <span class="op">{</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>                <span class="kw">val</span> <span class="va">byteArray</span> <span class="op">=</span> requestUrl<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>byteArray<span class="op">.</span>size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>byteArray<span class="op">)</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resumeWithException<span class="op">(</span>RuntimeException<span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">))</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>                println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}.</span>execute<span class="op">()</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>        imageView<span class="op">.</span>setBackground<span class="op">(</span>result<span class="op">)</span><span class="co">//伪代码</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>        result</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>startCoroutine<span class="op">(</span>MyContinuation<span class="op">(</span>MyCoroutineContext<span class="op">()))</span><span class="co">//设置成我们的上下文</span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="step4">step4</h4>
<p>至此，我们已经完成封装了，我们还可以把上面的代码抽象成可以执行任意任务的函数</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">runtask</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">suspend</span> (<span class="op">)</span> -&gt; <span class="fu">T</span>) <span class="op">{</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    block<span class="op">.</span>startCoroutine<span class="op">(</span>MyContinuation<span class="op">(</span>MyCoroutineContext<span class="op">()))</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>suspend <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">task</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="op">()</span> <span class="op">-&gt;</span> <span class="dt">T</span><span class="op">)</span> <span class="op">=</span> suspendCoroutine <span class="op">{</span> continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>    AsyncTask <span class="op">{</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>block<span class="op">())</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>e<span class="op">:</span> Exception<span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resumeWithException<span class="op">(</span>e<span class="op">)</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>execute<span class="op">()</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AsyncTask<span class="op">(</span><span class="kw">val</span> <span class="va">block</span><span class="op">:</span> <span class="op">()</span> <span class="op">-&gt;</span> <span class="dt">Unit</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">executor</span> <span class="kw">by</span> lazy <span class="op">{</span></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>        Executors<span class="op">.</span>newCachedThreadPool<span class="op">()</span></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">execute</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>execute<span class="op">(</span>block<span class="op">)</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>shutdown<span class="op">()</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuation<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> <span class="dt">CoroutineContext</span> <span class="op">=</span> EmptyCoroutineContext<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuationWrapper<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="kw">val</span> <span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> CoroutineContext <span class="op">=</span> EmptyCoroutineContext</span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>value<span class="op">)</span></span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resumeWithException<span class="op">(</span>exception<span class="op">)</span></span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyCoroutineContext <span class="op">:</span> <span class="dt">AbstractCoroutineContextElement</span><span class="op">(</span><span class="va">ContinuationInterceptor</span><span class="op">),</span> <span class="dt">ContinuationInterceptor</span> <span class="op">{</span></span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">interceptContinuation</span><span class="op">(</span><span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">):</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> MyContinuationWrapper<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">.</span>fold<span class="op">(</span>continuation<span class="op">)</span> <span class="op">{</span> cont<span class="op">,</span> element <span class="op">-&gt;</span></span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>element <span class="op">!=</span> this<span class="at">@MyCoroutineContext</span> <span class="op">&amp;&amp;</span> element <span class="kw">is</span> ContinuationInterceptor<span class="op">)</span></span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a>                element<span class="op">.</span>interceptContinuation<span class="op">(</span>continuation<span class="op">)</span></span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> cont</span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>调用</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">val</span> <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;127.0.0.1/img.png&quot;</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    runtask <span class="op">{</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> task <span class="op">{</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="va">byteArray</span> <span class="op">=</span> requestUrl<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>byteArray<span class="op">.</span>size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>                byteArray</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> RuntimeException<span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">)</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>        imageView<span class="op">.</span>setBackground<span class="op">(</span>result<span class="op">)</span><span class="co">//伪代码</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是这里的<code>url</code>是协程执行所需的参数，它在这里是常量，但如果在其他情况下有可能会出现线程安全问题，所以我们应该创建一个携带信息的上下文来存储</p>
<h4 id="step5">step5</h4>
<p>创建携带信息的<code>Context</code></p>
<div class="sourceCode" id="cb130"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UrlCoroutineContext<span class="op">(</span><span class="kw">val</span> <span class="va">url</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">:</span> <span class="dt">AbstractCoroutineContextElement</span><span class="op">(</span><span class="va">Key</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">companion</span> <span class="kw">object</span> Key <span class="op">:</span> <span class="dt">CoroutineContext</span>.<span class="dt">Key</span><span class="op">&lt;</span><span class="dt">UrlCoroutineContext</span><span class="op">&gt;</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>在<code>startCoroutine</code>时通过<code>+</code>添加携带<code>Interceptor</code>的<code>Context</code>和用户指定的<code>Context</code></p>
<div class="sourceCode" id="cb131"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">runtask</span><span class="op">(</span><span class="va">context</span><span class="op">:</span> <span class="dt">CoroutineContext</span> <span class="op">=</span> EmptyCoroutineContext<span class="op">,</span> <span class="va">block</span><span class="op">:</span> <span class="dt">suspend</span> (<span class="op">)</span> -&gt; <span class="fu">T</span>) <span class="op">{</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">//重裁的+，可以添加多个Context</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    block<span class="op">.</span>startCoroutine<span class="op">(</span>MyContinuation<span class="op">(</span>context <span class="op">+</span> MyCoroutineContext<span class="op">()))</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a><span class="co">//拓展Lambda，因为需要在协程中通过上下文获取url数据</span></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>suspend <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">task</span><span class="op">(</span><span class="va">block</span><span class="op">:</span> <span class="dt">CoroutineContext</span>.(<span class="op">)</span> -&gt; <span class="fu">T</span>) <span class="op">=</span> suspendCoroutine <span class="op">{</span> continuation<span class="op">:</span> Continuation<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">-&gt;</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    AsyncTask <span class="op">{</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in suspend block.&quot;</span><span class="op">)</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">//在执行block时，给block指定接收者</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>block<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">))</span></span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>            println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after resume.&quot;</span><span class="op">)</span></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span>e<span class="op">:</span> Exception<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resumeWithException<span class="op">(</span>e<span class="op">)</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}.</span>execute<span class="op">()</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AsyncTask<span class="op">(</span><span class="kw">val</span> <span class="va">block</span><span class="op">:</span> <span class="op">()</span> <span class="op">-&gt;</span> <span class="dt">Unit</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">val</span> <span class="va">executor</span> <span class="kw">by</span> lazy <span class="op">{</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>        Executors<span class="op">.</span>newCachedThreadPool<span class="op">()</span></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fun</span> <span class="fu">execute</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>execute<span class="op">(</span>block<span class="op">)</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>        executor<span class="op">.</span>shutdown<span class="op">()</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuation<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> <span class="dt">CoroutineContext</span> <span class="op">=</span> EmptyCoroutineContext<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{}</span></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyContinuationWrapper<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="kw">val</span> <span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">)</span> <span class="op">:</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">//用户要用到Context来获取url信息，所以创建Wrapper时要使用continuation.context</span></span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">val</span> <span class="va">context</span><span class="op">:</span> CoroutineContext <span class="op">=</span> continuation<span class="op">.</span>context</span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resume</span><span class="op">(</span><span class="va">value</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resume<span class="op">(</span>value<span class="op">)</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="fu">resumeWithException</span><span class="op">(</span><span class="va">exception</span><span class="op">:</span> <span class="dt">Throwable</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>        SwingUtilities<span class="op">.</span>invokeLater <span class="op">{</span></span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>            continuation<span class="op">.</span>resumeWithException<span class="op">(</span>exception<span class="op">)</span></span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyCoroutineContext <span class="op">:</span> <span class="dt">AbstractCoroutineContextElement</span><span class="op">(</span><span class="va">ContinuationInterceptor</span><span class="op">),</span> <span class="dt">ContinuationInterceptor</span> <span class="op">{</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">fun</span> <span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="fu">interceptContinuation</span><span class="op">(</span><span class="va">continuation</span><span class="op">:</span> <span class="dt">Continuation</span>&lt;<span class="va">T</span>&gt;<span class="op">):</span> <span class="dt">Continuation</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> MyContinuationWrapper<span class="op">(</span>continuation<span class="op">.</span>context<span class="op">.</span>fold<span class="op">(</span>continuation<span class="op">)</span> <span class="op">{</span> cont<span class="op">,</span> element <span class="op">-&gt;</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>element <span class="op">!=</span> this<span class="at">@MyCoroutineContext</span> <span class="op">&amp;&amp;</span> element <span class="kw">is</span> ContinuationInterceptor<span class="op">)</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>                element<span class="op">.</span>interceptContinuation<span class="op">(</span>continuation<span class="op">)</span></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> cont</span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>调用</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode kotlin"><code class="sourceCode kotlin"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fun</span> <span class="fu">main</span><span class="op">(</span><span class="va">args</span><span class="op">:</span> <span class="dt">Array</span>&lt;<span class="va">String</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- before coroutine&quot;</span><span class="op">)</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">//指定携带url的CoroutineContext</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    runtask<span class="op">(</span>UrlCoroutineContext<span class="op">(</span><span class="st">&quot;127.0.0.1/img.png&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. Before suspend.&quot;</span><span class="op">)</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">val</span> <span class="va">result</span><span class="op">:</span> ByteArray <span class="op">=</span> task <span class="op">{</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>            <span class="co">//这里this指CoroutineContext，它有两个key，一个是拦截器，一个是UrlCoroutineContext</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">val</span> <span class="va">byteArray</span> <span class="op">=</span> requestUrl<span class="op">(</span><span class="kw">this</span><span class="op">[</span>UrlCoroutineContext<span class="op">]!!.</span>url<span class="op">)</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>byteArray<span class="op">.</span>size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>                byteArray</span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> RuntimeException<span class="op">(</span><span class="st">&quot;error&quot;</span><span class="op">)</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a>        imageView<span class="op">.</span>setBackground<span class="op">(</span>result<span class="op">)</span><span class="co">//伪代码</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>        println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- in coroutine. After suspend. image size = </span><span class="ss">${</span>result<span class="op">.</span>size<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>    println<span class="op">(</span>Thread<span class="op">.</span>currentThread<span class="op">().</span>name <span class="op">+</span> <span class="st">&quot;-- after coroutine&quot;</span><span class="op">)</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>打印</p>
<pre><code>main-- before coroutine
main-- after coroutine
AWT-EventQueue-0-- in coroutine. Before suspend.
pool-1-thread-1-- in suspend block.
pool-1-thread-1-- request url for 127.0.0.1/img.png.
pool-1-thread-1-- after resume.
AWT-EventQueue-0-- setBackground
AWT-EventQueue-0-- in coroutine. After suspend. image size = 1024</code></pre>
<p>任务被挂起，先执行<code>after coroutine</code>，耗时操作在线程池中运行，更新UI在UI线程运行，没有任何问题，而且写起来和普通的代码一样</p>
</body>
</html>
